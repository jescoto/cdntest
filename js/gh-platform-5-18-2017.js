var APP = (function (win) {
    'use strict';

    var selectMenu = function (url) {

        if(url !== undefined){
            var urlStr = null, menuStr = null;
            // Updating to handle query parameters...
            if (url.indexOf('?') !== -1 ) {
               urlStr = url.split("?");
               menuStr = urlStr[0];
               menuStr = menuStr.slice(1);
            } else {
                urlStr = url.split("/");
                menuStr = urlStr[1];
            }

            var menuBtnView = $("#mainMenu-" + menuStr + " > button").data("view");

            if(menuBtnView !== undefined){
                $("#mainMenu li").removeClass("active");//this will remove the active class from
                $("#mainMenu-" + menuStr).addClass("active")
            } else {
                $("#mainMenu li").removeClass("active");//this will remove the active class from
            }

        }
    };


    var isNullOrEmpty = function (value) {
        return typeof value === 'undefined' || value === null || value === '';
    };

    var isKeySet = function (key) {
        var regEx = /^\$[A-Z_]+\$$/;
        return !isNullOrEmpty(key) && !regEx.test(key);
    };


    var emptyGuid = '00000000-0000-0000-0000-000000000000';



    return {
        selectMenu: selectMenu,
        isNulL: isNullOrEmpty,
        isKeySet : isKeySet
    };

}(window));

var FacebookIdentityProvider = function (appId) {
    var that = this;

    this.init = function () {
      FB.init({
          appId: appId,
          status: true,
          xfbml: false,
          version: 'v2.7'
      });
    };



    this.getAccessToken = function (callback) {
        FB.getLoginStatus(function(response) {
            if (response.status === 'connected') {
                callback(response.authResponse.accessToken);
            } else {
                that.login(function (token) {
                    callback(token);
                });
            }
        });
    };

    this.userPhoto = function (id, callback) {
        var endPoint = id+'/picture';
        FB.api(endPoint, {type: 'small'}, function(response) {
            callback(response);
        });
    };

    this.userInfo = function (callback) {
        FB.api('v2.7/me', /*{fields: ['first_name', 'last_name', 'gender', 'age_range', 'email']},*/ function(response) {
            callback(response);
        });
    };

    this.login = function(callback) {
        FB.login(function(response) {
            if (response.authResponse) {
                callback(response.authResponse.accessToken);
            } else {
                callback(false);
            }
        }, {scope: 'public_profile, email',
            return_scopes: true});
    };
};

// Async load facebook sdk
(function (doc) {
        var js, id = 'facebook-jssdk', ref = doc.getElementsByTagName('script')[0];
        if (doc.getElementById(id)) {return;}
        js = doc.createElement('script'); js.id = id; js.async = true;
        js.src = "//connect.facebook.net/en_US/all.js";
        ref.parentNode.insertBefore(js, ref);
}(document));

function getParameterByName(name, url) {
    name = name.replace(/[\[]/, '\\\[').replace(/[\]]/, '\\\]');
    var regexS = name + '=([^&#]*)';

    var regex = new RegExp(regexS);
    var results = regex.exec(url);

    if (results == null) {
        return false;
    } else {
        return decodeURIComponent(results[1].replace(/\+/g, ' '));
    }
}

var IdentityProvider = function (config) {
    var that = this;

    this.getAccessToken = function(callback) {

        // Begin Authorization
        var authorize_url;

        if (config.name == 'ADFS') {
            authorize_url = config.endpoint
                            + '?wa=' + config.wa
                            + '&wreply=' + config.wtrealm + '/adfs/token'
                            + '&wtrealm=' + config.wtrealm;
        } else {
            authorize_url = config.endpoint
                            + '?response_type=' + config.response_type
                            + '&client_id=' + config.client_id
                            + '&redirect_uri=' + config.redirect_uri
                            + '&display=' + config.display
                            + '&access_type=' + config.access_type
                            + '&scope=' + config.scope;
        }

        //CALL IN APP BROWSER WITH THE LINK
        ref = window.open(authorize_url, '_blank', 'location=no');

        var pollTimer = window.setInterval(function() {
            try {
                if (ref.document.URL.indexOf(config.redirect_uri) != -1 || ref.document.URL.indexOf('access_token') != -1) {
                    that.locationChanged(ref.document.URL, callback);
                    window.clearInterval(pollTimer);
                }
            } catch(e) { }
        }, 500);
    };

    this.locationChanged = function(loc, callback) {
        if (loc.indexOf('access_token=') != -1) {
            ref.close();
            var token = getParameterByName('access_token', loc);
            callback(token);
        }
    }
};

/**
 * Created by donbrad on 10/18/16.
 */

'use strict';

var algolia = {

    client: null,
    locationIndex : null,
    productIndex : null,
    brandIndex : null,
    retailerIndex : null,
    _searchKey : 'c11698eaa47391bf10a12c462db521af',
    _appId  : 'QMKSEN0WW0',
    _baseUrl : 'http://res.cloudinary.com/hyjvcxzjt/image/upload/v1475262131/product/',

    init : function () {
        var that = algolia;
        that.client = algoliasearch(that._appId, that._searchKey);

        that.locationIndex = that.client.initIndex('location');
        that.retailerIndex = that.client.initIndex('retail');
        that.productIndex = that.client.initIndex('product');
        that.brandIndex = that.client.initIndex('brand');
        that.blogIndex =  that.client.initIndex('blog');
        that.socialIndex =  that.client.initIndex('social');

    },


    deleteObjectFromIndex : function (index, objectId, callback) {

        var bpurl = '/deleteindexobject?index='+index+"&objectid="+objectId;
        $.ajax({
            url: bpurl,
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            success: function(data) {
                if (data.status === 'OK') {
                    callback(true);
                } else {
                    callback(false)
                }

            }
        });
    }
};
/**
 * Created by donbrad on 1/15/17.
 */


'use strict';

var analyticsModel = {

    analyticsDS : new kendo.data.DataSource(),
    initialized : false,
    _loaded : false,

    init : function () {
        if (analyticsModel.initialized) {
            return;
        }

        analyticsModel.initialized = true;

        analyticsModel.analyticsDS = new kendo.data.DataSource({
            type: 'everlive',
            transport: {
                typeName: 'analytics',
                dataProvider: APP.everlive
            },
            pageSize: 5,
            schema: {
                model: { Id:  Everlive.idField}
            }
        });

        analyticsModel.analyticsDS.bind("change", function (e) {
            var aArray = e.items;
            if (e.action === undefined) {
                if (aArray !== undefined && !analyticsModel._loaded) {
                    analyticsModel._loaded = true;
                   // ux.notify('People Loaded!', 'success');
                }
            }
        });

    },

    sendGAPage : function (url) {
        ga('set', 'page', url);
        ga('send', 'pageview');
    },


    sendGAEvent : function (category, action, label, value) {
        var eventObj = {
            hitType: 'event',
            eventCategory: category,
            eventAction: action,
            eventLabel: label
        };

        if (value !== undefined && value !== null) {
            eventObj.eventValue = parseInt(value);
        }

        ga('send', eventObj);
    },

    sendGALink : function (url) {
        ga('send', 'event', {
            eventCategory: 'Outbound Link',
            eventAction: 'click',
            eventLabel: url,
            transport: 'beacon'
        });
    }


};
/**
 * Created by donbrad on 1/1/17.
 */


'use strict';

var backlogModel = {

    backlogDS : null,
    backlogLoaded : false,
    _cloudClass : 'backlog',

    init : function () {


       backlogModel.backlogDS = new kendo.data.DataSource({
            type: 'everlive',
            transport: {
                typeName: backlogModel._cloudClass,
                dataProvider: APP.everlive
            },
            schema: {
                model: { id:  Everlive.idField}
            },
            requestEnd: function(e) {
                var response = e.response;
                var type = e.type;
                if (e.type === "read" && e.response) {
                    console.log("Backlog: " + response.count);

                }
            }
        });

        backlogModel.backlogDS.bind("change", function (e) {
            var reports = e.items;
            if (e.action === undefined && blogs) {
                if (reports !== undefined && ! backlogModel.backlogLoaded ) {
                    backlogModel.backlogLoaded = true;
                }
            }
        });

        backlogModel.backlogDS.fetch();

    },

    newObj : function () {
       var guid = uuid.v4();
        var obj = {
           Id : guid,
            scope: 'Small',   // Small, Medium, Large
            optEst: 0,  // in days
            pessEst: 0, // in days
            releaseTarget : null,
            targetDate :  null,
            featureArea: null,
            assignedTo:  'Don',
            description : null,
            status: null,
            siteName : null,
            siteSlug : null,
            uxStatus : null,
            devStatus : null,
            designStatus : null,
            reviewStatus: null,
            testStatus : null,
            priority: 0

       };

       return(obj);
    },

    query: function (query) {
        if (query === undefined)
            return(undefined);
        var dataSource =  backlogModel.backlogDS;
        var cacheFilter = dataSource.filter();
        if (cacheFilter === undefined) {
            cacheFilter = {};
        }

        dataSource.filter( query);
        var view = dataSource.view();

        dataSource.filter(cacheFilter);

        return(view);
    },

    findById : function (id) {

        var reports = backlogModel.query({field: "Id", operator: "eq", value: id});

        if (reports.length === 0) {
            return(null);
        }
        return (reports[0]);
    },

    findBySlug : function (slug) {

        var reports = backlogModel.query({field: "slug", operator: "eq", value: slug});

        if (reports.length === 0) {
            return(null);
        }
        return (reports[0]);
    },

    listBySiteSlug  : function (slug) {

        var reports = backlogModel.query({field: "siteSlug", operator: "eq", value: slug});

        if (reports.length === 0) {
            return(null);
        }
        return (reports);
    },


    update : function (feedback) {

        everlive.updateOne(backlogModel._cloudClass, feedback, function (err, data) {
            if (err !== null) {
                ux.notify("Couldn't update Feedback " + JSON.stringify(err), 'error');
            }
        });
    },

    add : function (feedback) {
        everlive.createOne(backlogModel._cloudClass, feedback, function (err, data) {
            if (err !== null) {
                ux.notify("Couldn't update Feedback " + JSON.stringify(err), 'error');
            }
        });
    },

    remove : function (feedback) {
        everlive.deleteOne(backlogModel._cloudClass, feedback, function (err, data) {
            if (err !== null) {
                ux.notify("Couldn't update Feedback " + JSON.stringify(err), 'error');
            }

        });
    }


};

/**
 * Created by donbrad on 10/8/16.
 */

'use strict';

var blogModel = {

    blogLoaded : false,
    blogDS: null,
    blogsByDate : [],

    init : function () {
        var that = blogModel;

        that.blogDS = new kendo.data.DataSource({
            type: 'everlive',
            transport: {
                typeName: 'blog',
                dataProvider: APP.everlive
            },
            schema: {
                model: { id:  Everlive.idField},
                fields: {
                    publishDate: { type: "date" }
                }
            },
           // sort: { field: "publishDate", dir: "desc" },
            requestEnd: function(e) {
                var response = e.response;
                var type = e.type;
                if (e.type === "read" && e.response) {
                    console.log("Blogs: " + response.count);

                }
            }
        });

       blogModel.blogDS.bind("change", function (e) {
            var blogs = e.items;
            if (e.action === undefined && blogs) {
                if (blogs !== undefined && !blogModel.blogLoaded) {
                    blogModel.blogLoaded = true;
                    blogModel.sortBlogsByDate();
                    indexView.updateRecentBlogs();
                }
            }
        });

        that.blogDS.fetch();
        
    },

    queryBlogs: function (query) {
        if (query === undefined)
            return(undefined);
        var dataSource =  blogModel.blogDS;
        var cacheFilter = dataSource.filter();
        if (cacheFilter === undefined) {
            cacheFilter = {};
        }

        dataSource.filter( query);
        var view = dataSource.view();

        dataSource.filter(cacheFilter);

        return(view);
    },

    sortBlogsByDate : function () {

        var count = blogModel.blogDS.total();

        for (var i=0; i<count; i++) {
            var blog = blogModel.blogDS.at(i);
            var sortDate = moment(blog.publishDate);
            blog.sortDate = sortDate;
        }

        blogModel.blogDS.sort( { field: "sortDate", dir: "desc" });

        blogModel.blogsByDate = blogModel.blogDS.view();

    },


    findBlog : function (id) {

        var blogs = blogModel.queryBlogs({field: "Id", operator: "eq", value: id});

        if (blogs.length === 0) {
            return(null);
        }
        return (blogs[0]);
    },

    findBlogByToken : function (token) {

        var blogs = blogModel.queryBlogs({field: "blogToken", operator: "eq", value: token});

        if (blogs.length === 0) {
            return(null);
        }
        return (blogs[0]);
    },

    findBlogBySlug : function (slug) {

        var blogs = blogModel.queryBlogs({field: "slug", operator: "eq", value: slug});

        if (blogs.length === 0) {
            return(null);
        }
        return (blogs[0]);
    },

    getSiteBlogs : function (siteSlug) {

        var blogs = blogModel.queryBlogs({field: "siteSlug", operator: "eq", value: siteSlug});

        if (blogs.length === 0) {
            return([]);
        }
        return (blogs);
    }


};
/**
 * Created by donbrad on 3/18/17.
 */

'use strict';

var campaignModel = {
    initialized : false,
    campaignDS : new kendo.data.DataSource(),
    campaignLoaded : false,
    _cloudClass : 'campaign',

    init: function () {
        if (campaignModel._initialized) {
            return;
        }

        campaignModel._initialized = true;

        campaignModel.campaignDS = new kendo.data.DataSource({
            type: 'everlive',
            transport: {
                typeName: campaignModel._cloudClass,
                dataProvider: APP.everlive
            },
            schema: {
                model: { id:  Everlive.idField}
            },
            requestEnd: function(e) {
                var response = e.response;
                var type = e.type;
                if (e.type === "read" && e.response) {
                    console.log("Campaign: " + response.count);

                }
            }
        });

        campaignModel.campaignDS.bind("change", function (e) {
            var campaigns = e.items;
            if (e.action === undefined && campaigns) {
                if (campaigns !== undefined && !campaignModel.campaignLoaded) {
                    campaignModel.campaignLoaded = true;
                }
            }
        });

        campaignModel.campaignDS.fetch();

    },

    query : function (query) {
        if (query === undefined)
            return(undefined);

        var dataSource =  campaignModel.campaignDS;

        dataSource.filter(query);
        var view = dataSource.view();

        dataSource.filter({});

        return(view);
    },

    findById : function (id) {

        var sites = campaignModel.query({field: "Id", operator: "eq", value: id});

        if (sites.length === 0) {
            return(null);
        }
        return (sites[0]);
    },

    listBySiteSlug : function (slug) {

        var sites = campaignModel.query({field: "siteSlug", operator: "eq", value: slug});

        if (sites.length === 0) {
            return([]);
        }
        return (sites);
    },


    update : function (campaign) {

        everlive.updateOne(campaignModel._cloudClass, campaign, function (err, data) {
            if (err !== null) {
                ux.notify("Couldn't update Campaign " + JSON.stringify(err), 'error');
            }
        });
    },

    add : function (campaign) {
        everlive.createOne(campaignModel._cloudClass, campaign, function (err, data) {
            if (err !== null) {
                ux.notify("Couldn't update Campaign " + JSON.stringify(err), 'error');
            }
        });
    },

    remove : function (campaign) {
        everlive.deleteOne(campaignModel._cloudClass, campaign, function (err, data) {
            if (err !== null) {
                ux.notify("Couldn't update Campaign " + JSON.stringify(err), 'error');
            }

        });
    }

};

/**
 * Created by donbrad on 10/8/16.
 */

'use strict';

var cloudData = {

    blogLoaded : false,
    blogDS: null,
    blogsByDate : [],

    init : function () {
        var that = cloudData;

        that.blogDS = new kendo.data.DataSource({
            type: 'everlive',
            transport: {
                typeName: 'blog',
                dataProvider: APP.everlive
            },
            schema: {
                model: { id:  Everlive.idField},
                fields: {
                    publishDate: { type: "date" }
                }
            },
           // sort: { field: "publishDate", dir: "desc" },
            requestEnd: function(e) {
                var response = e.response;
                var type = e.type;
                if (e.type === "read" && e.response) {
                    console.log("Blogs: " + response.count);

                }
            }
        });

       cloudData.blogDS.bind("change", function (e) {
            var blogs = e.items;
            if (e.action === undefined && blogs) {
                if (blogs !== undefined && !cloudData.blogLoaded) {
                    cloudData.blogLoaded = true;
                    cloudData.sortBlogsByDate();
                    indexView.updateRecentBlogs();
                }
            }
        });

        that.blogDS.fetch();

    },

    queryBlogs: function (query) {
        if (query === undefined)
            return(undefined);
        var dataSource =  cloudData.blogDS;
        var cacheFilter = dataSource.filter();
        if (cacheFilter === undefined) {
            cacheFilter = {};
        }

        dataSource.filter( query);
        var view = dataSource.view();

        dataSource.filter(cacheFilter);

        return(view);
    },

    sortBlogsByDate : function () {

        var count = cloudData.blogDS.total();

        for (var i=0; i<count; i++) {
            var blog = cloudData.blogDS.at(i);
            var sortDate = moment(blog.publishDate);
            blog.sortDate = sortDate;
        }

        cloudData.blogDS.sort( { field: "sortDate", dir: "desc" });

        cloudData.blogsByDate = cloudData.blogDS.view();

    },


    findBlog : function (id) {

        var blogs = cloudData.queryBlogs({field: "Id", operator: "eq", value: id});

        if (blogs.length === 0) {
            return(null);
        }
        return (blogs[0]);
    },

    findBlogByToken : function (token) {

        var blogs = cloudData.queryBlogs({field: "blogToken", operator: "eq", value: token});

        if (blogs.length === 0) {
            return(null);
        }
        return (blogs[0]);
    }


};
/**
 * Created by donbrad on 10/8/16.
 */

'use strict';

var commentModel = {
    _initialized : false,
    _templateLoaded : false,
    commentLoaded : false,
    commentDS: null,
    _cloudClass : 'staffcomment',
    _staffList : [
        {fullname: "Andrew DeCoriolis", alias: "Andrew", email: 'andrewd@farmforward.com'},
        {fullname: "Don Bradford", alias: "Don", email: 'donbrad@gmail.com'},
        {fullname: "Jordon Escoto", alias: "Jordan", email: 'jordanescoto@gmail.com'}
    ],

    init : function () {

        if (commentModel._initialized) {
            return;
        }

        commentModel._initialized = true;

        commentModel.commentDS = new kendo.data.DataSource({
            type: 'everlive',
            transport: {
                typeName: commentModel._cloudClass,
                dataProvider: APP.everlive
            },
            schema: {
                model: { id:  Everlive.idField}
            },
            requestEnd: function(e) {
                var response = e.response;
                var type = e.type;
                if (e.type === "read" && e.response) {
                    console.log("Comments: " + response.count);

                }
            }
        });

        commentModel.commentDS.bind("change", function (e) {
            var sites = e.items;
            if (e.action === undefined && sites) {
                if (sites !== undefined && !commentModel.commentLoaded) {
                    commentModel.commentLoaded = true;
                }
            }
        });

        commentModel.commentDS.fetch();

    },

    read : function () {
        commentModel.commentDS.fetch();
    },

    query: function (query) {
        if (query === undefined)
            return(undefined);

        var dataSource =  commentModel.commentDS;

        dataSource.filter(query);
        var view = dataSource.view();

        dataSource.filter({});

        return(view);
    },


    findById : function (id) {

        var sites = commentModel.query({field: "Id", operator: "eq", value: id});

        if (sites.length === 0) {
            return(null);
        }
        return (sites[0]);
    },

    listByReportSlug : function (slug) {

        var sites = commentModel.query({field: "reportSlug", operator: "eq", value: slug});

        if (sites.length === 0) {
            return([]);
        }
        return (sites);
    },

    listBySenderEmail : function (email) {

        var sites = commentModel.query({field: "senderEmail", operator: "eq", value: email});

        if (sites.length === 0) {
            return(null);
        }
        return (sites);
    },

    update : function (comment) {

        everlive.updateOne(commentModel._cloudClass, comment, function (err, data) {
            if (err !== null) {
                ux.notify("Couldn't update comment " + JSON.stringify(err), 'error');
            }
        });
    },

    add : function (comment) {
        everlive.createOne(commentModel._cloudClass, comment, function (err, data) {
            if (err !== null) {
                ux.notify("Couldn't add comment " + JSON.stringify(err), 'error');
            }
        });
    },

    delete : function (comment) {
        everlive.deleteOne(commentModel._cloudClass, comment, function (err, data) {
            if (err !== null) {
                ux.notify("Couldn't delete comment " + JSON.stringify(err), 'error');
            }

        });
    }


};
/**
 * Created by donbrad on 1/1/17.
 */


'use strict';

var contributorModel = {

    initialized : false,

    contributorDS : null,
    bloggerDS :  new kendo.data.DataSource({sort: { field: "name", dir: "asc" }}),
    ffDS : new kendo.data.DataSource({sort: { field: "name", dir: "asc" }}),
    bpDS : new kendo.data.DataSource({sort: { field: "name", dir: "asc" }}),
    jifaDS : new kendo.data.DataSource({sort: { field: "name", dir: "asc" }}),

    contributorLoaded : false,
    _cloudClass : 'advisor',

    init : function () {

        if (contributorModel.initialized)
            return;

        contributorModel.initialized = true;


       contributorModel.contributorDS = new kendo.data.DataSource({
            type: 'everlive',
            transport: {
                typeName: 'advisor',
                dataProvider: APP.everlive
            },
            schema: {
                model: { id :  Everlive.idField}
            },
            sort: { field: "name", dir: "asc" },
            requestEnd: function(e) {
                var response = e.response;
                var type = e.type;
                if (e.type === "read" && e.response) {
                    console.log("contributor: " + response.count);

                }
            }
        });

        contributorModel.contributorDS.bind("change", function (e) {
            var people = e.items;
            if (e.action === undefined && people) {
                if (people !== undefined && ! contributorModel.contributorLoaded ) {
                    contributorModel.contributorLoaded = true;

                    ghEvent.trigger(ghEvent.peopleLoaded);
                    contributorModel._buildBloggerDS();

                }
            }
        });

        contributorModel.contributorDS.fetch();

    },

    _buildBloggerDS : function () {
        contributorModel.bloggerDS.data([]);
        var list = contributorModel.query({field: "role", operator: "eq", value: "Staff"});
        contributorModel.bloggerDS.data(list);

        contributorModel.bloggerDS.add({alias: 'ffstaff', name: 'Farm Forward Staff', slug:'ffstaff', profileUrl: 'images/icon-logo-brand-dark.png'});
        contributorModel.bloggerDS.add({alias: 'bpstaff', name: 'Buying Poultry Staff', slug:'bpstaff',profileUrl: 'images/icon-logo-brand-dark.png'});
        contributorModel.bloggerDS.add({alias: 'jifastaff', name: 'JIFA Staff', slug:'jifastaff', profileUrl : 'images/icon-logo-brand-dark.png'});
    },

    _buildTeamsDS : function () {
        contributorModel.bpDS.data([]);
        contributorModel.ffDS.data([]);
        contributorModel.jifaDS.data([]);

        var list = contributorModel.query({field: "organization", operator: "eq", value: "Buying Poultry"});
        contributorModel.bpDS.data(list);

        list = contributorModel.query({field: "organization", operator: "eq", value: "Farm Forward"});
        contributorModel.ffDS.data(list);

        list = contributorModel.query({field: "organization", operator: "eq", value: "JIFA"});
        contributorModel.jifaDS.data(list);

    },


    query: function (query) {
        if (query === undefined)
            return(undefined);
        var dataSource =  contributorModel.contributorDS;
        var cacheFilter = dataSource.filter();
        if (cacheFilter === undefined) {
            cacheFilter = {};
        }

        dataSource.filter( query);
        var view = dataSource.view();

        dataSource.filter(cacheFilter);

        return(view);
    },

    findById : function (id) {

        var list = contributorModel.query({field: "Id", operator: "eq", value: id});

        if (list.length === 0) {
            return(null);
        }
        return (list[0]);
    },

    findBySlug : function (slug) {

        var list = contributorModel.query({field: "slug", operator: "eq", value: slug});

        if (list.length === 0) {
            return(null);
        }
        return (list[0]);
    },

    findByAlias : function (alias) {

        var list = contributorModel.query({field: "alias", operator: "eq", value: alias});

        if (list.length === 0) {
            return(null);
        }
        return (list[0]);
    },

    findByName : function (name) {

        var list = contributorModel.query({field: "name", operator: "eq", value: name});

        if (list.length === 0) {
            return(null);
        }
        return (list[0]);
    },

    add : function (contributor) {
        everlive.createOne(contributorModel._cloudClass, contributor, function (err, data) {


        });
    }

};

/**
 * Created by donbrad on 3/18/17.
 */

'use strict';

var donationModel = {
    initialized : false,
    donationDS : new kendo.data.DataSource(),
    donationLoaded : false,
    _cloudClass : 'donation',

    init: function () {
        if (donationModel._initialized) {
            return;
        }

        donationModel._initialized = true;

        donationModel.donationDS = new kendo.data.DataSource({
            type: 'everlive',
            transport: {
                typeName: donationModel._cloudClass,
                dataProvider: APP.everlive
            },
            schema: {
                model: { id:  Everlive.idField}
            },
            requestEnd: function(e) {
                var response = e.response;
                var type = e.type;
                if (e.type === "read" && e.response) {
                    console.log("donation: " + response.count);

                }
            }
        });

        donationModel.donationDS.bind("change", function (e) {
            var donations = e.items;
            if (e.action === undefined && donations) {
                if (donations !== undefined && !donationModel.donationLoaded) {
                    donationModel.donationLoaded = true;
                    ghEvent.trigger(ghEvent.donationLoaded);
                }
            }
        });

        donationModel.donationDS.fetch();

    },

    query : function (query) {
        if (query === undefined)
            return(undefined);

        var dataSource =  donationModel.donationDS;

        dataSource.filter(query);
        var view = dataSource.view();

        dataSource.filter({});

        return(view);
    },

    findById : function (id) {

        var sites = donationModel.query({field: "Id", operator: "eq", value: id});

        if (sites.length === 0) {
            return(null);
        }
        return (sites[0]);
    },

    listBySiteSlug : function (slug) {

        var sites = donationModel.query({field: "siteSlug", operator: "eq", value: slug});

        if (sites.length === 0) {
            return([]);
        }
        return (sites);
    },


    update : function (donation) {

        everlive.updateOne(donationModel._cloudClass, donation, function (err, data) {
            if (err !== null) {
                ux.notify("Couldn't update donation " + JSON.stringify(err), 'error');
            }
        });
    },

    add : function (donation) {
        everlive.createOne(donationModel._cloudClass, donation, function (err, data) {
            if (err !== null) {
                ux.notify("Couldn't update donation " + JSON.stringify(err), 'error');
            }
        });
    },

    remove : function (donation) {
        everlive.deleteOne(donationModel._cloudClass, donation, function (err, data) {
            if (err !== null) {
                ux.notify("Couldn't update donation " + JSON.stringify(err), 'error');
            }

        });
    }

};

/**
 * Created by donbrad on 3/1/16.
 *
 * everlive interface for userManagement
 *
 */
'use strict';

var everlive = {

    _token : null,
    _tokenType: 'bearer',
    _id : null,
    _signedIn : false,
    _isAuthenticated : false,
    _status: null,
    _authenticating: false,
    _user : null,
    _userId : null,
    _lastSync: 0,
    _syncInProgress: false,
    _syncComplete: true,
    _delta : 30,
    _hasLocalStorage: false,
    _initialized: false,
    _triedToken: false,
    _initialView: '/',

    reset : function () {
        everlive._initialized = false;
        everlive._isAuthenticated = false;
        everlive._signedIn = false;
        everlive._syncInProgress = false;
        everlive._syncComplete = false;
        everlive._user = null;
        everlive._id = null;
        everlive._token = null;
        everlive._lastSync = 0;
    },

     isConnected : function () {
         if (navigator.onLine){
             APP.everlive.online();
             return(true);
         } else {
             APP.everlive.offline();
             return(false);
         }
    },

    supportsLocalStorage : function (){
        try {
            return 'localStorage' in window && window['localStorage'] !== null;
        } catch(e) {
            return false;
        }
    },

    init: function () {
        
      /*  var provider = Everlive.Constants.StorageProvider.FileSystem;
        if (window.navigator.simulator === undefined) {
            // Use local storage in the emulator
            var provider = Everlive.Constants.StorageProvider.LocalStorage;
       }*/

        if (everlive._initialized) {
            var online = everlive.isConnected();
            return;
        }

            everlive._hasLocalStorage = everlive.supportsLocalStorage();

            everlive._initialized = true;

            APP.everlive = new Everlive({
                appId: appSettings.everlive.appId,
                scheme: appSettings.everlive.scheme,/*,
                caching: {
                    maxAge: 10, //Global setting for maximum age of cached items in minutes. Default: 60.
                    enabled: true
                },*/
                /*caching: {
                     maxAge: 30, //Global setting for maximum age of cached items in minutes. Default: 60.
                     enabled: true, //Global setting for enabling/disabling cache. Default is FALSE.
                     typeSettings: { //Specify content type-specific settings that override the global settings.
                     "userstatus": {
                         maxAge: 5
                     }
                    }
                 },
*/
               /* offlineStorage: true,*/
               offlineStorage: {
                    storage: {
                        provider: Everlive.Constants.StorageProvider.LocalStorage
                    }/*,
                    encryption: {
                        provider: Everlive.Constants.EncryptionProvider.Default
                    }*/
                },
                authentication: {
                    persist: true,
                    onAuthenticationRequired: function () {
                        //ux.notify('Please log in.');
                       userView.openSignUp();
                    }
                }
            });

            everlive.getTimeStamp();
    
            everlive.getCredentials();
    
            //everlive.updateCredentials();

            // Wire up the everlive sync monitors
           /* APP.everlive.on('syncStart', everlive.syncStart);

            APP.everlive.on('syncEnd', everlive.syncEnd);

            everlive.isUserSignedIn();
*/

    },

    getCredentials : function () {
        if (!everlive._hasLocalStorage) {
            return;
        }
       everlive._id =  localStorage.getItem('bpEverliveUserId');
        if (everlive._id === undefined) {
            everlive._id = null;
        }
        everlive._token =  localStorage.getItem('bpEverliveUserToken');
        if (everlive._token === undefined) {
            everlive._token = null;
        }
    },

    putCredentials : function () {
        if (!everlive._hasLocalStorage) {
            return;
        }
        localStorage.setItem('bpEverliveUserToken',  everlive._token);
        localStorage.setItem('bpEverliveUserId',  everlive._id);
    },

    updateCredentials : function () {
        if (everlive._token !== null && everlive._id !== null) {
            APP.everlive.authentication.setAuthorization(everlive._token, 'bearer', everlive._id)
        }

    },

    updateTimeStamp : function () {
        if (!everlive._hasLocalStorage) {
            return;
        }
        everlive._lastSync = bpTime.currentTime();
        localStorage.setItem('bpEverliveTimeStamp',  everlive._lastSync);
    },

    getTimeStamp : function () {
        if (!everlive._hasLocalStorage) {
            return;
        }
        everlive._lastSync = localStorage.getItem('bpEverliveTimeStamp');

        if (everlive._lastSync === undefined || everlive._lastSync === null) {
            everlive.updateTimeStamp();
            everlive._syncComplete = true;
        }
    },

    goOnline : function () {
        if (APP.everlive !== null)
            APP.everlive.online();
    },

    goOffline : function () {
        if (APP.everlive !== null)
            APP.everlive.offline();
    },


    resendEmailValidation : function (email, callback) {

        var object = {
            "Username": userModel._user.username
        };

        $.ajax({
            type: "POST",
            url: 'http://api.everlive.com/v1/eiautrwppy9qoh5i/Users/verify/resend',
            contentType: "application/json",
            data: JSON.stringify(object),
            success: function(data){
                mobileNotify("Email verification instructtions were sent to " + email);
                if (callback !== undefined && callback !== null) {
                    callback({error: null, wasSent: true, isVerifed: false});
                }
            },
            error: function(error){
                if (error.responseJSON.errorCode === 210) {
                    if (callback !== undefined && callback !== null) {
                        callback({error: null, wasSent: true, isVerified: true});
                    }
                } else {
                    ggError("Email Validation Resend Error : " + JSON.stringify(error));
                    if (callback !== undefined && callback !== null) {
                        callback({error: error, wasSent: false, isVerifed: false});
                    }
                }


            }
        });

        /*APP.everlive.Users.updateSingle(updateObject,
            function (data) {
                var result = data.result;
                mobileNotify("Email verification instructtions were sent to " + email);
            },
            function (error) {
                if (error.code === 107) {
                    mobileNotify("Emall Validation Resend - Deferring User Update...");
                } else {
                    ggError("Emall Validation Resend Error : " + JSON.stringify(error));
                }

            });*/
    },

    updateUser : function () {

    },

    isUserSignedIn : function () {

        APP.everlive.Users.currentUser(
            function (data) {
                if (data.result) {
                    everlive._user = data.result;
                    everlive._authenticating = false;
                    everlive._signedIn = true;
                    everlive._syncComplete = false;

                    everlive.isAuthenticated = true;
                    everlive.triedToken = false;
                    everlive._initialView = '/';

                } else {
                    everlive._signedIn = false;
                    everlive._syncComplete = false;
                    everlive.isAuthenticated = false;
                    everlive._initialView = '/';
                }

            },
            function(error){
                everlive.clearAuthentication();
          //      everlive.logout(function (){
                    if (userModel.hasAccount) {
                        everlive._signedIn = false;
                        everlive._syncComplete = false;
                        everlive.isAuthenticated = false;
                        //userModel.initialView = '#usersignin';
                    } else {
                       // userModel.initialView = '#newuserhome';
                    }
                    //APP.kendo.navigate(userModel.initialView);
  //              });

        });

       /* everlive.checkAuthStatus(function (error, status) {
            if (error === null) {
                if (status === "unauthenticated" || status === "invalidAuthentication" ||
                    status === "expiredAuthentication" ) {
                    everlive._authenticating = false;
                    if (userModel.hasAccount) {
                        everlive._signedIn = false;
                        everlive._syncComplete = false;
                        everlive.isAuthenticated = false;
                        userModel.initialView = '#usersignin';
                    } else {
                        userModel.initialView = '#newuserhome';
                    }
                    APP.kendo.navigate(userModel.initialView);
                } else if (status === "authenticated") {
                    everlive._authenticating = false;
                    everlive._signedIn = true;
                    everlive._syncComplete = false;
                    everlive.checkCurrentUser();
                    everlive.isAuthenticated = true;
                    userModel.initialView = '#home';
                   // APP.kendo.navigate(userModel.initialView);

                }  else if (status === "authenticating") {
                    mobileNotify("Authenticating your account...");
                    if (!everlive._authenticating) {
                        everlive._authenticating = true;
                        setTimeout(function(){
                            everlive.isUserSignedIn();
                        }, 3000);
                    }

                }

            } else {
                if (error !== undefined && error !== null && error !== "") {
                    if (error.code !== undefined) {
                        if (error.code === 1003) {
                            setTimeout(function () {
                                everlive.isUserSignedIn();
                            }, 3000);
                        } else {
                            ggError("Authentication error " + JSON.stringify(error));
                        }
                    }
                }
            }
        });*/

    },

/*    checkAuthStatus : function (callback) {
        APP.everlive.authInfo(
            function (data) {
                if (data.status === "unauthenticated") {
                    everlive._status = data.status;
                    everlive._isAuthenticated = false;
                } else if (data.status === "authenticated"){
                    everlive._status = data.status;
                    everlive._user = data.user;
                    everlive._id = data.user.Id;
                    everlive._isAuthenticated = true;

                } else if (data.status === "authenticating") {
                    everlive._status = data.status;
                    everlive._isAuthenticated = false;
                } else if (data.status === "invalidAuthentication" ){
                    everlive._status = data.status;
                    everlive._isAuthenticated = false;
                }
                callback(null, data.status);
            },
            function (error) {
                callback(error, null);

            });
    },*/


    createAccount: function (username, name, password, callback) {
        var attrs = {
            Email: username,
            accountOwner:  APP.siteName,
            accountOwnerUrl : APP.siteUrl,
            email: username,
            name : name,
            DisplayName: name
        };

        APP.everlive.users.register(username,
            password,
            attrs,
            function(data) {

                everlive._id = data.result.Id;
                everlive._token = data.result.access_token;
                everlive._tokenType = data.result.token_type;
                everlive.putCredentials();
                everlive._userId = data.result.Id;
                callback(null, data);
            },
            function(error) {
                callback(error, null);
            });
    },

    login : function (username, password, callback) {

        APP.everlive.users.login(username, password,
            function (data) {
                everlive._token = data.result.access_token;
                everlive._tokenType = data.result.token_type;
                everlive._id = data.result.principal_id;
                everlive._signedIn = true;
                everlive._isAuthenticated = true;
                everlive.putCredentials();
                callback(null, everlive._id);
            },
            function(error){
                callback(error, null);
            });
    },

    checkCurrentUser : function () {
        everlive.currentUser( function (err, user) {
            if (err!== undefined && err !== null) {
                ggError("Can't access User's Account : " + err.message);
                return;
            }

            everlive.loadUserData(user);

        });
    },

    loadUserData : function (user) {

    },

    logout : function (callback) {

        APP.everlive.users.logout(function (result) {
                everlive._signedIn = false;
                everlive._isAuthenticated = false;
                callback(true);
            }, // success
            function (error) {
                callback(false);
            });
    },

    changePassword : function (newPassword, callback) {

        var username = userModel._user.get('Username');
        var password = userModel._getRecoveryPassword();
        APP.everlive.users.changePassword(username, password, newPassword, true,
            function (data) {
                callback(null, true);
            },
            function (error) {
               callback(error, false);
            }
        );
    },

    recoverPassword : function (email, callback) {
        var attrs = {
            Email: email
        };
        APP.everlive.users.resetPassword(attrs,
            function (data) {
                callback(null, true);
            },
            function (error) {
                callback(error, false);
            }
        );

    },

    currentUser : function (callback) {
       /* if (!everlive.isConnected()) {
            callback("No Connection", null);
        }*/

        if (!everlive._isAuthenticated) {
            callback (null, null);
            return;
        }

        APP.everlive.Users.currentUser(
            function (data) {
                    everlive._user = data.result;
                    callback(null, data.result);
            },
            function(error){
                    callback(error, null);

            });
    },


    getCount : function (dataType, callback) {
        var data = APP.everlive.data(dataType);
        data.count()
            .then(function(data){
                    var count = null;
                    if (data.result !== undefined)
                        count = data.result;
                    callback(null, count)
                },
                function(error){
                    callback(error, null);
                });
    },

    readOne: function (dataType, objectId, callback) {
        var data = APP.everlive.data(dataType);
        data.getById(objectId).then(
            function(data){
                callback(null, data);
            },
            function(error){
                callback(error, null);
            });
    },

    readAll: function (dataType, callback) {
        var data = APP.everlive.data(dataType);
        data.get().then(
            function(data){
                callback(null, data);
            },
            function(error){
                callback(error, null);
            }
        );
    },

    updateOne: function (dataType, dataObject, callback) {
        var data = APP.everlive.data(dataType);
        data.updateSingle(dataObject).then(
            function(data){
                callback(null, data);
            },
            function(error){
                callback(error, null);
            });
    },

    update: function (dataType, dataObject, filterObject, callback) {
        var data = APP.everlive.data(dataType);
        data.update(dataObject, filterObject,
            function(data){
                callback(null, data);
            },
            function(error){
                callback(error, null);
            });
    },

    updateAll : function (dataType, dataList) {
        var data = APP.everlive.data(dataType);
        data.update(dataList, // filter expression
            function(data){
                alert(JSON.stringify(data));
            },
            function(error){
                alert(JSON.stringify(error));
            });
    },


    createOne: function (dataType, dataObject, callback) {
        var data = APP.everlive.data(dataType);
        data.create(dataObject,
            function(data){
                var Id = data.result.Id;  // get the Id from the server object
                dataObject.Id = Id;   // Add the everlive Id so caller can add to local datasource
                callback(null, dataObject);
            },
            function(error){
                callback(error, null);
            });
    },

    createAll : function (dataType, dataList, callback) {
        var data = APP.everlive.data(dataType);
        data.create(dataList, // filter expression
            function(data){
               callback(null, data);
            },
            function(error){
               callback(error, null);
            });
    },

    deleteOne : function (dataType, dataObject, callback) {
        var data = APP.everlive.data(dataType);
        data.destroySingle(dataObject,
            function(data){
                callback(null, data);
            },
            function(error){
                callback(error, null);
            });
    },

    deleteOneById : function (dataType, dataId, callback) {
        var data = APP.everlive.data(dataType);
        data.destroySingle({Id : dataId},
            function(data){
                callback(null, data);
            },
            function(error){
                callback(error, null);
            });
    },


    deleteMatching : function (dataType, query, callback) {
        var data = APP.everlive.data(dataType);
        data.destroy( query, // filter expression
            function(data){
                callback(null, data);
            },
            function(error){
                callback(error, null);
            });
    },

    deleteAll : function (dataType, callback) {
        var data = APP.everlive.data(dataType);
        data.destroy(
            function(data){
                callback(null, data);
            },
            function(error){
                callback(error, null);
            });
    },

    clearAccount : function () {

    },

    clearAuthentication : function () {

        APP.everlive.users.clearAuthorization();
        APP.everlive.authentication.clearPersistedAuthentication();
        //APP.everlive.authentication.logout();
       
    },

    clearLocalStorage : function () {
        APP.everlive.offlineStorage.purgeAll(
            function (data) {
                mobileNotify("Device storage erased");

        }, function (error) {
                if (error !== null) {
                    ggError("Error clearing device storage : " + JSON.stringify(error));
                }
            });
    },
    
    syncStart : function () {

        everlive._syncInProgress = true;
    },

    syncEnd : function (syncInfo)  {
        var err = syncInfo.error !== undefined;
        var failedItems = syncInfo.failedItems, syncedItems = syncInfo.syncedItems;


        everlive._syncInProgress = false;
        if (!everlive._syncComplete) {
            everlive._syncComplete = true;

        }
      
        if (err ) {
            alert('Cloud Sync Error : ' + JSON.stringify(syncInfo.error));
        }


    }

};

var bpTime = {

    _day : 60 * 60 * 24 * 1000,
    _72hours : 60 * 60 * 24 * 3 * 1000,
    _week: 60 * 60 * 24 * 7 * 1000,
    _month: 60 * 60 * 24 * 30 * 1000,

    currentTime: function () {
        return(new Date().getTime());
    },
    currentTimeInSeconds : function () {
        return(new Date().getTime() / 1000);
    },

    currentPubNubTime: function () {
        return(new Date().getTime() * 10000);
    },

    toPubNubTime: function (timeIn) {
        return (timeIn * 10000);
    },

    fromPubNubTime : function (timeIn) {
        return (timeIn / 10000);
    },

    lastDay : function () {
        return(bpTime.currentTime() - bpTime._day);

    },

    last72Hours : function () {
        return(bpTime.currentTime() - bpTime._72hours);

    },

    lastWeek : function () {
        return(bpTime.currentTime() - bpTime._week);
    },

    lastMonth : function () {
        return(bpTime.currentTime() - bpTime._month);
    }
};
/**
 * Created by donbrad on 11/4/16.
 */


'use strict';

var favorites = {

    favoritesLoaded: false,
    initialized : false,

    favoriteDS: null,

    labelCache : [],
    productCache : [],
    brandCache : [],
    storeCache : [],

    labelDS :  new kendo.data.DataSource(),
    productDS :  new kendo.data.DataSource(),
    brandDS :  new kendo.data.DataSource(),
    storeDS :  new kendo.data.DataSource(),

    _version : 1,
    _label : 'Label',
    _brand : 'Brand',
    _product : 'Product',
    _store : 'Store',


    addFavorite : function (category, objectId, objectName, objectImage, objectData) {
        var guid = uuid.v4();
        var fav = {
            uuid: guid,
            Id : guid,
            version : favorites._version,
            category : category,
            objectId : objectId,
            objectName: objectName,
            objectImage: objectImage,
            objectData: JSON.stringify(objectData)

        };

        favorites.favoriteDS.add(fav);
        everlive.createOne('favorite', fav, function(err, data){
            if (err !== null) {
                ux.notify("Couldn't create Favorite " + JSON.stringify(err), 'error');
            }

        });
        favorites.favoriteDS.sync();
        favorites.updateCache(fav, true);
    },

    removeFavorite : function (fav) {

        var Id = fav.Id;
        favorites.updateCache(fav, false);
        favorites.favoriteDS.remove(fav);
        favorites.favoriteDS.sync();
        everlive.deleteOne('favorite', fav, function(err, data){
            if (err !== null) {
                ux.notify("Couldn't delete Favorite " + JSON.stringify(err), 'error');
            }

        });

    },


    init : function () {

        if (favorites.initialized) {
            return;
        }

        favorites.initialized = true;

        favorites.favoriteDS = new kendo.data.DataSource({
            type: 'everlive',
            transport: {
                typeName: 'favorite',
                dataProvider: APP.everlive
            },
            schema: {
                model: { Id:  Everlive.idField}
            },
            autoSync: true
        });

        favorites.favoriteDS.bind("change", function (e) {
            var favoriteArray = e.items;
            if (e.action === undefined) {
                if (favoriteArray !== undefined && !favorites.favoritesLoaded) {
                    favorites.favoritesLoaded = true;
                    favorites.buildCache(favoriteArray);
                }
            }
        });

        favorites.favoriteDS.fetch();
    },

    buildCache : function (array) {
        favorites.labelCache = [];
        favorites.brandCache = [];
        favorites.productCache = [];
        favorites.storeCache = [];
        for (var i=0; i<array.length; i++) {
            var fav = array[i];

            favorites.updateCache(fav, true);
           // favorites.addToDataSource(fav);

        }

    },

    initDataSources : function () {
        favorites.favoriteDS.data([]);
        favorites.labelDS.data([]);
        favorites.productDS.data([]);
        favorites.brandDS.data([]);
        favorites.storeDS.data([]);

        favorites.labelCache = [];
        favorites.productCache = [];
        favorites.storeCache = [];
        favorites.brandCache = [];
    },


    addToDataSource : function (fav) {
        switch (fav.category) {
            case favorites._brand :
                favorites.brandDS.add(fav);
                break;
            case favorites._label :
                favorites.labelDS.add(fav);
                break;
            case favorites._product :
                favorites.productDS.add(fav);
                break;
            case favorites._store :
                favorites.storeDS.add(fav);
                break;
        }
    },

    removeFromDataSource : function (fav) {
        switch (fav.category) {
            case favorites._brand :
                favorites.brandDS.remove(fav);
                break;
            case favorites._label :
                favorites.labelDS.remove(fav);
                break;
            case favorites._product :
                favorites.productDS.remove(fav);
                break;
            case favorites._store :
                favorites.storeDS.remove(fav);
                break;
        }
    },


    updateCache : function (fav, state) {

        if (state) {
            favorites.addToDataSource(fav);
        } else {
            favorites.removeFromDataSource(fav);
        }

        switch (fav.category) {
            case favorites._brand :
                favorites.brandCache[fav.objectId] = state;
                break;
            case favorites._label :
                favorites.labelCache[fav.objectId] = state;
                break;
            case favorites._product :
                favorites.productCache[fav.objectId] = state;
                break;
            case favorites._store :
                favorites.storeCache[fav.objectId] = state;
                break;
        }
    },



    queryFavorites: function (query) {
        if (query === undefined)
            return(undefined);
        var dataSource =  favorites.favoriteDS;
        var cacheFilter = dataSource.filter();
        if (cacheFilter === undefined) {
            cacheFilter = {};
        }

        dataSource.filter( query);
        var view = dataSource.view();

        dataSource.filter(cacheFilter);

        return(view);
    },

    findFavorite: function (id) {

        var favs = favorites.queryFavorites({field: "uuid", operator: "eq", value: id});

        if (favs.length === 0) {
            return(null);
        }
        return (favs[0]);
    },

    findFavoriteByObjectId: function (id) {

        var favs = favorites.queryFavorites({field: "objectId", operator: "eq", value: id});

        if (favs.length === 0) {
            return(null);
        }
        return (favs[0]);
    }


};
/**
 * Created by donbrad on 10/8/16.
 */

'use strict';

var feedbackModel = {
    _initialized : false,
    _templateLoaded : false,
    feedbackLoaded : false,
    feedbackDS: null,
    _cloudClass : "staffreport",

    init : function () {

        if (feedbackModel._initialized) {
            return;
        }

        feedbackModel._initialized = true;

        feedbackModel.feedbackDS = new kendo.data.DataSource({
            type: 'everlive',
            transport: {
                typeName: feedbackModel._cloudClass,
                dataProvider: APP.everlive
            },
            schema: {
                model: { id:  Everlive.idField}
            },
            requestEnd: function(e) {
                var response = e.response;
                var type = e.type;
                if (e.type === "read" && e.response) {
                    console.log("Feedback: " + response.count);

                }
            }
        });

        feedbackModel.feedbackDS.bind("change", function (e) {
            var sites = e.items;
            if (e.action === undefined && sites) {
                if (sites !== undefined && !feedbackModel.feedbackLoaded) {
                    feedbackModel.feedbackLoaded = true;
                }
            }
        });



    },

    fetch : function () {
        feedbackModel.feedbackDS.fetch();
    },

    query: function (query) {
        if (query === undefined)
            return(undefined);

        var dataSource =  feedbackModel.feedbackDS;

        dataSource.filter(query);
        var view = dataSource.view();

        dataSource.filter({});

        return(view);
    },


    findById : function (id) {

        var sites = feedbackModel.query({field: "Id", operator: "eq", value: id});

        if (sites.length === 0) {
            return(null);
        }
        return (sites[0]);
    },

    listBySiteSlug : function (slug) {

        var sites = feedbackModel.query({field: "siteSlug", operator: "eq", value: slug});

        if (sites.length === 0) {
            return([]);
        }
        return (sites);
    },

    listBySenderEmail : function (email) {

        var sites = feedbackModel.query({field: "senderEmail", operator: "eq", value: email});

        if (sites.length === 0) {
            return(null);
        }
        return (sites);
    },

    update : function (feedback) {

        everlive.updateOne(feedbackModel._cloudClass, feedback, function (err, data) {
            if (err !== null) {
                ux.notify("Couldn't update Feedback " + JSON.stringify(err), 'error');
            }
        });
    },

    add : function (feedback) {
        everlive.createOne(feedbackModel._cloudClass, feedback, function (err, data) {
            if (err !== null) {
                ux.notify("Couldn't add Feedback " + JSON.stringify(err), 'error');
            }
        });
    },

    remove : function (feedback) {
        everlive.deleteOne(feedbackModel._cloudClass, feedback, function (err, data) {
            if (err !== null) {
                ux.notify("Couldn't remove Feedback " + JSON.stringify(err), 'error');
            }

        });
    }


};
'use strict';

var ghEvent = {
    authChange: 'ghe_authChange',
    userLoaded:  'ghe_userLoaded',
    peopleLoaded: 'ghe_peopleLoaded',
    donationLoaded: 'ghe_donationLoaded',
    donationPlansLoaded: 'ghe_donationPlansLoaded',
    donationSync: 'ghe_donationSync',
    userdonationLoaded: 'ghe_userdonationLoaded',
    pledgeLoaded: 'ghe_pledgeLoaded',
    userpledgeLoaded: 'ghe_userpledgeLoaded',
    petitionLoaded: 'ghe_petitionLoaded',
    mailchimpLoaded: 'ghe_mailchimpLoaded',
    siteLoaded: 'ghe_siteLoaded',

    trigger: function (trig) {
        $(window).trigger(trig)
    }

};
/**
 * Created by donbrad on 10/8/16.
 */

'use strict';

var glossaryModel = {


    glossaryDS : null,
    glossaryLoaded : false,

    init : function () {
        var that = glossaryModel;

        that.glossaryDS = new kendo.data.DataSource({
            type: 'everlive',
            transport: {
                typeName: 'glossary',
                dataProvider: APP.everlive
            },
            schema: {
                model: { id:  Everlive.idField}
            },
            pageSize : 10,
            sort: { field: "title", dir: "asc" },
            requestEnd: function(e) {
                var response = e.response;
                var type = e.type;
                if (e.type === "read" && e.response) {
                    console.log("Glossary: " + response.count);

                }
            }
        });

        that.glossaryDS.bind("change", function (e) {
            var glossary = e.items;
            if (e.action === undefined && glossary) {
                if (!that.glossaryLoaded) {
                    that.glossaryLoaded = true;
                    //indexView.updateRecentBlogs();
                }
            }
        });

        that.glossaryDS.fetch();
    },

    query: function (query) {
        if (query === undefined)
            return(undefined);
        var dataSource =  glossaryModel.glossaryDS;
        var cacheFilter = dataSource.filter();
        if (cacheFilter === undefined) {
            cacheFilter = {};
        }

        dataSource.filter( query);
        var view = dataSource.view();

        dataSource.filter(cacheFilter);

        return(view);
    },


    find: function (id) {

        var glossaries = glossaryModel.query({field: "Id", operator: "eq", value: id});

        if (glossaries.length === 0) {
            return(null);
        }
        return (glossaries[0]);
    },

    findBySlug : function (slug) {

        var glossaries = glossaryModel.query({field: "slug", operator: "eq", value: slug});

        if (glossaries.length === 0) {
            return(null);
        }
        return (glossaries[0]);
    },

    findByCategory : function (category) {

        var glossaries = glossaryModel.query({field: "category", operator: "eq", value: category});

        if (glossaries.length === 0) {
            return([]);
        }
        return (glossaries);

    }


};
/**
 * Created by donbrad on 9/26/16.
 */

var legacyData = {

    blogLoaded : false,
    brandLoaded : false,
    storeBrandLoaded : false,
    certificationLoaded : false,
    claimLoaded : false,
    productLoaded : false,
    retailerLoaded : false,
    productClaimLoaded : false,
    productCertificationLoaded : false,
    locationLoaded : false,
    contentLoaded : false,
    _isLoaded : false,
    _initialSync : false,
    _initialLocSync : false,
    _productTypes : ['Chicken', 'Turkey', 'Eggs', 'Plant Based'],

    blogDS: new kendo.data.DataSource({
        transport: {
            read: {
                url: "/data/Blog.json", dataType: "json"
            }
        },
        sort: { field: "Id", dir: "asc" },
        requestEnd: function(e) {
            var response = e.response;
            var type = e.type;
            if (e.type === "read" && e.response) {
                console.log("Blogs: " + response.length); // displays "77"

                legacyData.blogLoaded = true;
                legacyData.isLoaded();


            }
        }
    }),

    brandDS: null,

    /*newStoreDS : null,*/

   storeBrandDS: new kendo.data.DataSource({
        transport: {
            read: {
                url: "/data/RetailerModelBrandModel.json", dataType: "json"
            }
        },
        sort: { field: "Id", dir: "asc" },
        requestEnd: function(e) {
            var response = e.response;
            var type = e.type;
            if (e.type === "read" && e.response) {

                console.log("StoreBrands: " + response.length);
 //               legacyData.storeBrandLoaded = true;
 //               legacyData.isLoaded();
            }
        }
    }),


    certificationDS: new kendo.data.DataSource({
        transport: {
            read: {
                url: "/data/Certification.json", dataType: "json"
            }
        },
        sort: { field: "Id", dir: "asc" },
        requestEnd: function(e) {
            var response = e.response;
            var type = e.type;
            if (e.type === "read" && e.response) {

                console.log("Certifications: " + response.length);
                legacyData.certificationLoaded = true;
                legacyData.isLoaded();
            }
        }
    }),


    claimDS: new kendo.data.DataSource({
        transport: {
            read: {
                url: "/data/Claim.json", dataType: "json"
            }
        },
        sort: { field: "Id", dir: "asc" },
        requestEnd: function(e) {
            var response = e.response;
            var type = e.type;
            if (e.type === "read" && e.response) {

                console.log("Claims: " + response.length);
                legacyData.claimLoaded = true;
                legacyData.isLoaded();
            }
        }
    }),

    productDS: new kendo.data.DataSource({
        transport: {
            read: {
                url: "/data/Product.json", dataType: "json"
            }
        },
        sort: { field: "Id", dir: "asc" },
        requestEnd: function(e) {
            var response = e.response;
            var type = e.type;
            if (e.type === "read" && e.response) {

                console.log("Products: " + response.length);
                legacyData.productLoaded = true;
                legacyData.isLoaded();
            }
        }
    }),

    productClaimDS: new kendo.data.DataSource({
        transport: {
            read: {
                url: "/data/ProductClaimsModel.json", dataType: "json"
            }
        },
        sort: { field: "Id", dir: "asc" },
        requestEnd: function(e) {
            var response = e.response;
            var type = e.type;
            if (e.type === "read" && e.response) {

                console.log("Product Claims: " + response.length);
                legacyData.productClaimLoaded = true;
                legacyData.isLoaded();
            }
        }
    }),

    productCertificationDS: new kendo.data.DataSource({
        transport: {
            read: {
                url: "/data/ProductCertificationsModel.json", dataType: "json"
            }
        },
        sort: { field: "Id", dir: "asc" },
        requestEnd: function(e) {
            var response = e.response;
            var type = e.type;
            if (e.type === "read" && e.response) {

                console.log("Product Certifications: " + response.length);
                legacyData.productCertificationLoaded = true;
                legacyData.isLoaded();
            }
        }
    }),

    retailerDS : null,
    locationDS : null,

/*
     locationDS: new kendo.data.DataSource({
        transport: {
            read: {
                url: "/data/Location1.json", dataType: "json"
            }
        },
        requestEnd: function(e) {
            var response = e.response;
            var type = e.type;
            if (e.type === "read" && e.response) {
                console.log("Location: " + response.length);
              //  legacyData.locationLoaded = true;
            }
        }
    }),*/


    contentDS: new kendo.data.DataSource({
        transport: {
            read: {
                url: "/data/Contentitem.json", dataType: "json"
            }
        },
       /* sort: { field: "Id", dir: "asc" },*/
        serverFiltering : false,
        serverSorting : false,
        requestEnd: function(e) {
            var response = e.response;
            var type = e.type;
            if (e.type === "read" && e.response) {
                console.log("Content: " + response.length);
               // legacyData.contentLoaded = true;
                legacyData.isLoaded();
            }
        }
    }),




    init: function () {
        var that = legacyData;

       /* legacyData.productDS.bind("change", function (e) {
            var changedContacts = e.items;
            if (e.action === undefined) {
                if (changedContacts !== undefined && !legacyData._initialSync) {
                    legacyData._initialSync = true;
                    legacyData.isLoaded();
                }

            }
        });*/
/*
        legacyData.contentDS.bind("change", function (e) {
            var changedContent = e.items;
            if (e.action === undefined) {
                if (changedContent !== undefined && !legacyData._initialSync) {
                    legacyData._initialSync = true;
                    legacyData.contentLoaded = true;
                    legacyData.isLoaded();
                }

            }
        });*/

/*
        legacyData.brandDS.bind("change", function (e) {
            var changedStores = e.items;
            if (e.action === undefined) {
                if (changedStores !== undefined && !legacyData.brandLoaded) {
                    legacyData.brandLoaded = true;
                    legacyData.isLoaded();
                }

            }
        });

        legacyData.retailerDS.bind("change", function (e) {
            var changedStores = e.items;
            if (e.action === undefined) {
                if (changedStores !== undefined && !legacyData.retailerLoaded) {
                    legacyData.retailerLoaded = true;
                    legacyData.isLoaded();
                }

            }
        });*/

       legacyData.locationDS = new kendo.data.DataSource({
            type: 'everlive',
            transport: {
                typeName: 'location',
                dataProvider: APP.everlive
            },
            schema: {
                model: { Id:  Everlive.idField}
            }
        });

        legacyData.newStoreDS = new kendo.data.DataSource({
            type: 'everlive',
            transport: {
                typeName: 'location',
                dataProvider: APP.everlive
            },
            schema: {
                model: { Id:  Everlive.idField}
            }
        });

        legacyData.retailerDS = new kendo.data.DataSource({
            type: 'everlive',
            transport: {
                typeName: 'retailer',
                dataProvider: APP.everlive
            },
            schema: {
                model: { Id:  Everlive.idField}
            }
        });
        legacyData.brandDS = new kendo.data.DataSource({
            type: 'everlive',
            transport: {
                typeName: 'brand',
                dataProvider: APP.everlive
            },
            schema: {
                model: { Id:  Everlive.idField}
            }
        });

        // everlive.readAll('brand', function (error, data) {
        //     if (error === null) {
        //         legacyData.brandDS.data(data.result);
        //         legacyData.brandLoaded = true;
        //         legacyData.isLoaded();
        //     }
        // });

       /* everlive.readAll('retailer', function (error, data) {
            if (error === null) {
                legacyData.retailerDS.data(data.result);
                legacyData.retailerLoaded = true;
                legacyData.isLoaded();
            }
        });*/

        legacyData.locationDS.bind("change", function (e) {
            var changedStores = e.items;
            if (e.action === undefined) {
                if (changedStores !== undefined && !legacyData.locationLoaded) {
                    legacyData.locationLoaded = true;
                    legacyData.isLoaded();
                }

            }
        });


        /*legacyData.newStoreDS.bind("change", function (e) {
            var changedStores = e.items;
            if (e.action === undefined) {
                if (changedStores !== undefined ) {
                    console.log("newStored fetched!!!");
                }

            }
        });


        legacyData.brandDS.bind("change", function (e) {
            var changedStores = e.items;
            if (e.action === undefined) {
                if (changedStores !== undefined && !legacyData.brandLoaded) {
                    legacyData.brandLoaded = true;
                    legacyData.isLoaded();
                }

            }
        });

        legacyData.retailerDS.bind("change", function (e) {
            var changedStores = e.items;
            if (e.action === undefined) {
                if (changedStores !== undefined && !legacyData.retailerLoaded) {
                    legacyData.retailerLoaded = true;
                    legacyData.isLoaded();
                }

            }
        });

        legacyData.storeBrandDS.bind("change", function (e) {
            var changedStores = e.items;
            if (e.action === undefined) {
                if (changedStores !== undefined && !legacyData.storeBrandLoaded) {
                    legacyData.storeBrandLoaded = true;
                    legacyData.isLoaded();
                }

            }
        });
*/





       /* that.contentDS.fetch();
        that.blogDS.fetch();
        that.brandDS.fetch();
        that.claimDS.fetch();
        that.productDS.fetch();
        that.productClaimDS.fetch();
        that.productCertificationDS.fetch();*/
      /*  that.brandDS.fetch();

        that.storeBrandDS.fetch();*/
        /*that.newStoreDS.fetch();
        that.retailerDS.fetch();*/
        that.locationDS.fetch();


    },

    isLoaded : function () {
        var that = legacyData;

        if (that.locationLoaded ) {
            that.processLegacyData();
        }

    },


    processLegacyData : function () {
        console.log("* Processing Legacy Data *");

        var index = 0;
        var length = legacyData.locationDS.total();



        function getNext () {

            var locObj = legacyData.locationDS.at(index);

            var address = locObj.address;
            locationView._geoCodeAddress(address, function(result) {

                if (result !== null) {
                    var geoCode = result;
                    var lat = geoCode.geometry.location.lat(), lng = geoCode.geometry.location.lng();
                    var fullAddress = geoCode.formatted_address;

                    fullAddress = fullAddress.replace(', USA', '');
                    fullAddress = fullAddress.replace(', United States', '');

                    var zipcode = geoCode.address_components[geoCode.address_components.length-1].short_name;
                    locObj.zipcode = zipcode;
                    locObj.address = fullAddress;
                    locObj.placeId = geoCode.place_id;
                    locObj._geoLoc.lat = lat;
                    locObj._geoLoc.lng = lng;

                    everlive.updateOne('location', locObj, function (err, content) {
                        if (err !== null) {
                            console.log("location update error", JSON.stringify(err));
                        } else {
                            console.log(locObj.name + "  @ " + locObj.address);
                        }

                    });
                } else {
                    console.log("*** Invalid Address : ", address);
                    everlive.deleteOne('location', locObj, function (err, content) {
                        if (err !== null) {
                            console.log("location delete error", JSON.stringify(err));
                        } else {
                            console.log("-X- " + locObj.name + "  @ " + locObj.address);
                        }

                    });
                }


                if (index++ < length) {
                    return getNext();
                }

            });

        }

        getNext();
    },

   /* processLegacyData : function () {
        console.log("* Processing Legacy Data *");

        var newStoreDS = new kendo.data.DataSource({
            type: 'everlive',
            transport: {
                typeName: 'location',
                dataProvider: APP.everlive
            },
            schema: {
                model: { Id:  Everlive.idField}
            }
        });

        var storeDS = new kendo.data.DataSource();

        var len = legacyData.locationDS.total();

        for (var i=0; i<len; i++) {
            var loc = legacyData.locationDS.at(i);
            var retail = legacyData.queryRetailer({field: 'Id', operator: 'eq',  value: loc.RetailerModel_Id});
            var lat = 0, lng = 0;
            if (loc.Location_Coordinates_Latitude !== undefined && loc.Location_Coordinates_Latitude !== null) {
                lat = loc.Location_Coordinates_Latitude;
            }

            if (loc.Location_Coordinates_Longitude !== undefined && loc.Location_Coordinates_Longitude !== null) {
                lng = loc.Location_Coordinates_Longitude;
            }

            var geoLoc = {lat: lat, lng: lng};
            var store = {
                storeId : loc.Id,
                address : loc.Location_Street.capitalize() + ", " + loc.Location_City.capitalize() + "  " + loc.Location_State,
                city: loc.Location_City.capitalize(),
                retailerId : loc.RetailerModel_Id,
                _geoLoc : geoLoc,
                name : retail.name,
                gradeScore : retail.gradeScore,
                gradeName : retail.gradeName,
                website : retail.website
            };
            var score = parseInt(retail.gradeScore);

            var category = 'Avoid';

            if (score >= 4) {
                category = 'Better';
            }

            if (score >= 8) {
                category = 'Best';
            }

            store.category = category;
            storeDS.add(store);
        }

        storeDS.group({field: 'address'});
        var view = storeDS.view();
        var index = 0, length = view.length;

        function getNext () {

            var locObj = view[index];
            var storeObj = locObj.items[0];
            var guid = uuid.v4();
            storeObj.Id = guid;

            everlive.createOne('location', storeObj, function (err, content) {
                if (err !== null) {
                    console.log("Index error", JSON.stringify(err));
                } else {
                    console.log(storeObj.name + " created @ " + storeObj.address);
                }

                if (index++ < length) {
                    return getNext();
                }

            });

        }

       getNext();
    },*/


    queryBrand : function (query) {
        var ds = legacyData.brandDS;
        if (query === undefined)
            return(undefined);
        ds.filter( query);
        var view = ds.view();
        var content = view[0];
        ds.filter([]);
        return(content);
    },

    queryContent : function (query) {
        var ds = legacyData.contentDS;
        if (query === undefined)
            return(undefined);
        ds.filter( query);
        var view = ds.view();
        var content = view[0];
        ds.filter([]);
        return(content);
    },

    queryLocation : function (query) {
        var ds = legacyData.locationDS;
        if (query === undefined)
            return(undefined);
        ds.filter( query);
        var view = ds.view();
        var content = view[0];
        ds.filter([]);
        return(content);
    },

    queryProduct : function (query) {
        var ds = legacyData.productDS;
        if (query === undefined)
            return(undefined);
        ds.filter( query);
        var view = ds.view();
        var content = view[0];
        ds.filter([]);
        return(content);
    },

    queryRetailer : function (query) {
        var ds = legacyData.retailerDS;
        if (query === undefined)
            return(undefined);
        ds.filter( query);
        var view = ds.view();
        var content = view[0];
        ds.filter([]);
        return(content);
    },

    queryDSList : function (dataSource, query) {
        if (query === undefined)
            return(undefined);
        var cacheFilter = dataSource.filter();
        if (cacheFilter === undefined) {
            cacheFilter = {};
        }
        dataSource.filter( query);
        var view = dataSource.view();
        var data = view[0];

        dataSource.filter(cacheFilter);

        return(view);
    }



};

var processCertifications = {
    len : 0,
    index: 0,

    start : function () {
        processCertifications.len = legacyData.productClaimDS.total();
        processCertifications.index = 0;

        processCertifications.getNext();
    },

    getNext : function () {

        var that = legacyData;

        var claim = that.productCertificationDS.at(processCertifications.index);

        if (claim === undefined || claim === null) {
            processCertifications.index++;
            if (processCertifications.index < processCertifications.len) {
                processCertifications.getNext();
            }
        } else {

            //var product = that.productDS.at(claim.ProductId);
            var content = legacyData.queryContent([{ field: "Id", operator: "eq", value: claim.CertificationId }]);

            var claimName = content.Name;

            var productId  = claim.ProductId.toString();

            everlive.readOne('product', productId, function (error, data) {
                if (error !== null) {
                    console.log("Error fetching certification " + JSON.stringify(error));
                } else {

                    var productObj = data.result;


                    //productObj.certifications = [];

                    productObj.certifications.push(claimName);
                   // productObj.certificationString = "";


                    if ( productObj.certificationString.length > 3) {
                        productObj.certificationString += ", ";
                    }
                    productObj.certificationString += claimName;


                    console.log("Updated : " + productObj.productName + " -> " + productObj.certificationString);
                    everlive.updateOne('product', productObj, function (error, data) {
                        if (error !== null) {
                            console.log(JSON.stringify(error));
                        }
                    });

                }
                processCertifications.index++;
                if (processCertifications.index < processCertifications.len) {
                    processCertifications.getNext();
                }


            });
        }
    }

};

var processClaims = {
    len : 0,
    index: 0,

    start : function () {
        processClaims.len = legacyData.productClaimDS.total();
        processClaims.index = 0;

        processClaims.getNext();
    },

    getNext : function () {

        var that = legacyData;

        var claim = that.productClaimDS.at(processClaims.index);
        //var product = legacyData.queryProduct([{ field: "Id", operator: "eq", value: claim.ProductId }]);
        var content = legacyData.queryContent([{ field: "Id", operator: "eq", value: claim.ClaimId }]);
        var guid = uuid.v4();

        var claimName = content.Name;

        var productId = claim.ProductId.toString();

        everlive.readOne('product', productId, function (error, data) {
            if (error !== null) {
                console.log("Error fetching claim " + JSON.stringify(error));
            } else {

                var productObj = data.result;

               /* if (productObj.productImage === 'http:') {
                    productObj.productImage = null;
                }

                if (productObj.brandImage === 'http:') {
                    productObj.brandImage = null;
                }
*/

                //productObj.claims = [];

               productObj.claims.push(claimName);

                //productObj.claimString = "";


               if (productObj.claimString.length > 3) {
                    productObj.claimString  += ", ";
                }
                productObj.claimString += claimName;



                console.log("Updated : " + productObj.productName + " to " + productObj.claimString);
                everlive.updateOne('product', productObj, function (error, data) {
                    if (error !== null) {
                        console.log(JSON.stringify(error));
                    }
                });

            }
            processClaims.index++;
            if (processClaims.index < processClaims.len) {
                processClaims.getNext();
            }


        });
    }

};


var processProducts = {
    len : 0,
    index: 0,

    start : function () {
        processProducts.len = legacyData.productDS.total();
        processProducts.index = 0;

        processProducts.getNext();
    },

    getNext : function () {

        var that = legacyData;

       var product = that.productDS.at(processProducts.index);
        var guid = uuid.v4();
        var object = {
            Id : JSON.stringify(product.Id),
            productId : product.Id,
            brandId : product.Brand_Id,
            isRecommended : product.Recommended,
            isPlantBased : product.PlantBased,
            gradeScore : product.Grade_Value,
            gradeName : product.Grade_Name,
            productType : product.ProductType,
            overrideGrade : product.OverrideGrade,
            claims: [],
            claimString : null,
            certifications : [],
            certificationString : null
        };

        var score = parseInt(object.gradeScore);
        var category = "Avoid";
        if (score >= 5 && score <= 7) {
            category = "Better";
        } else if (score >= 8 && score <= 13) {
            category = "Best";
        }
        object.category = category;

        var contentObj = legacyData.queryContent( [{ field: "Id", operator: "eq", value: product.Id }]);
        //var brandObj = that.queryDSObject(that.brandDS, { field: "Id", operator: "eq", value: product.brand_Id });
        var parentObj = null;
        if (contentObj !== undefined) {
            var parentId = contentObj.ParentId;
            if (parentId !== 0) {
                parentObj = legacyData.queryContent([{ field: "Id", operator: "eq", value: parentId }]);
                if (parentObj !== undefined) {
                    object.brandName = parentObj.Name;
                    object.brandToken = parentObj.UrlName;
                    object.brandType = parentObj.Type;
                    object.brandUrl = parentObj.Website;
                    object.brandImage = null;
                    if (parentObj.Image !== undefined) {
                        object.brandImage = 'http:' + parentObj.Image;
                    }
                    object.productName = contentObj.Name;
                    object.productToken = contentObj.UrlName;
                    object.productCategory = legacyData._productTypes[object.productType];
                    object.productImage = null;
                    if (contentObj.Image !== undefined) {
                        object.productImage = 'http:' + contentObj.Image;
                    }
                    object.productDescription = null;

                }
            }
            everlive.updateOne('product', object, function (error, data) {
                processProducts.index ++;
                console.log("Added : " + object.productName + " from : " + object.brandName);
                if (processProducts.index < processProducts.len) {
                    processProducts.getNext();
                }
                if (error !== null) {
                    console.log("Error updating product " + JSON.stringify(error));
                }
            });
        }

    }


};

var processBrands = {
    len : 0,
    index: 0,

    start : function () {
        processBrands.len = legacyData.brandDS.total();
        processBrands.index = 0;

        processBrands.getNext();
    },

    getNext : function () {

        var that = legacyData;

        var brand = that.brandDS.at(processBrands.index);
        var guid = uuid.v4();
        var object = {
            Id : JSON.stringify(brand.Id),
            brandId : brand.Id,
            isRecommended : brand.Recommended,
            gradeScore : brand.Grade_Value,
            gradeName : brand.Grade_Name,
            overrideGrade : brand.OverrideGrade
        };

        var contentObj = legacyData.queryContent( [{ field: "Id", operator: "eq", value: brand.Id }]);
        //var brandObj = that.queryDSObject(that.brandDS, { field: "Id", operator: "eq", value: product.brand_Id });
        var parentObj = null;
        if (contentObj !== undefined) {

            object.brandName = contentObj.Name;
            object.brandToken = contentObj.UrlName;
            object.brandUrl = contentObj.Website;
            object.brandImage = null;
            if (contentObj.Image !== undefined) {
                object.brandImage = contentObj.Image;
            }

            everlive.createOne('brand', object, function (error, data) {
                processBrands.index ++;
                console.log("Added : " + object.brandName);
                if (processBrands.index < processBrands.len) {
                    processBrands.getNext();
                }
                if (error !== null) {
                    console.log("Error creating brand " + JSON.stringify(error));
                }
            });
        }

    }


};

var processBlogs = {
    len : 0,
    index: 0,

    start : function () {
        processBlogs.len = legacyData.blogDS.total();
        processBlogs.index = 0;

        processBlogs.getNext();
    },

    getNext : function () {

        var that = legacyData;

        var blog = that.blogDS.at(processBlogs.index);
        var guid = uuid.v4();
        var object = {
            Id : JSON.stringify(blog.Id),
            blogId : blog.Id,
            isPublished : blog.Published,
            publishDate : blog.PublishDate,
            title : blog.PromotionalTitle,
            promoImage : blog.FullsizeImage,
            isDeleted : false,
            isReviewed : false,
            author: null
        };

        var contentObj = legacyData.queryContent( [{ field: "Id", operator: "eq", value: blog.Id }]);

        if (contentObj !== undefined) {

            object.name = contentObj.Name;
            object.image = contentObj.Image;
            object.description = contentObj.Description;


            everlive.createOne('blog', object, function (error, data) {
                processBlogs.index ++;
                console.log("Added : " + object.title);
                if (processBlogs.index < processBlogs.len) {
                    processBlogs.getNext();
                }
                if (error !== null) {
                    console.log("Error creating blog " + JSON.stringify(error));
                }
            });
        }

    }


};

var processRetailers = {
    len : 0,
    index: 0,

    start : function () {
        processRetailers.len = legacyData.retailerDS.total();
        processRetailers.index = 0;

        processRetailers.getNext();
    },

    getNext : function () {

        var that = legacyData;

        var store = that.retailerDS.at(processRetailers.index);
        var guid = uuid.v4();
        var object = {
            Id : JSON.stringify(store.Id),
            gradeScore : store.Grade_Value,
            gradeName : store.Grade_Name,
            email : store.Email
        };

        var contentObj = legacyData.queryContent( [{ field: "Id", operator: "eq", value: store.Id }]);
      //  var locationObj = legacyData.queryLocation( [{ field: "RetailerModel_Id", operator: "eq", value: store.Id }]);

        if (contentObj !== undefined) {

            object.name = contentObj.Name;
            object.website = contentObj.Website;

            /*if (locationObj !== undefined) {
                object.lat = parseFloat(locationObj.Location_Coordinates_Latitude);
                object.lng = parseFloat(locationObj.Location_Coordinates_Longitude);
                object.street = locationObj.Location_Street;
                object.city = locationObj.Location_City;
                object.state = locationObj.Location_State;
                object.zipcode = locationObj.Location_Zip_Zip;
                object.address = object.street + ', ' + object.city + ", ";
            }
*/
            everlive.createOne('retailer', object, function (error, data) {
                processRetailers.index ++;
                console.log("Added : " + object.Name + " at " + object.address);
                if (processRetailers.index < processRetailers.len) {
                    processRetailers.getNext();
                }
                if (error !== null) {
                    console.log("Error creating retailer " + JSON.stringify(error));
                }
            });
        }

    }


};

var processStoreBrands = {
    len: 0,
    index: 0,

    start: function () {
        processStoreBrands.len = legacyData.storeBrandDS.total();
        processStoreBrands.index = 0;

        processStoreBrands.getNext();

    },

    getNext: function () {

        var that = legacyData;

        var storeBrand = that.storeBrandDS.at(processStoreBrands.index);

        var storeId = storeBrand.RetailerModel_Id, brandId = storeBrand.BrandModel_Id;


        var storeObj = legacyData.queryRetailer({field: 'Id', operator: "eq", value: storeId});

        var brandObj = legacyData.queryBrand({field: 'brandId', operator: "eq", value: brandId});


        if (brandObj.retailerList === undefined) {
            brandObj.retailerList = [];
        }

        if (brandObj.retailerIdList === undefined) {
            brandObj.retailerIdList = [];
        }


        var found = false;

        for (var i=0; i<brandObj.retailerIdList.length; i++) {
            if (storeId === brandObj.retailerIdList[i])
                found = true;
        }

        if (!found) {
            brandObj.retailerList.push(storeObj.name);
            brandObj.retailerIdList.push(storeObj.Id);
            console.log("Added " + storeObj.name + " to " +  brandObj.brandName);
        }


        processStoreBrands.index ++;

        if (processStoreBrands.index < processStoreBrands.len) {
            processStoreBrands.getNext();
        } else {
            for (var b=0; b<legacyData.brandDS.total(); b++) {
                var brand = legacyData.brandDS.at(b);
                everlive.updateOne('brand', brand, function (err, data) {
                    if (err !== null) {
                        console.log ("Error : " + JSON.stringify(err));
                    }
                });
            }
        }

    }
};


var processLocations = {
    len : 0,
    index: 0,

    start : function () {
        processLocations.len = legacyData.locationDS.total();
        processLocations.index = 0;

        processLocations.getNext();
    },

    getNext : function () {

        var that = legacyData;

        var location = that.locationDS.at(processLocations.index);
        var guid = uuid.v4();
        var object = {
            Id : JSON.stringify(location.Id)

        };
        object.lat = parseFloat(location.Location_Coordinates_Latitude);
        object.lng = parseFloat(location.Location_Coordinates_Longitude);
        var geoPoint = {
            longitude: object.lng,
            latitude:  object.lat
        };
        object.geoPoint = geoPoint;
        object.street = location.Location_Street;
        object.city = location.Location_City;
        object.state = location.Location_State;
        object.zipcode = location.Location_Zip_Zip;
        object.address = object.street + ', ' + object.city + ", " + object.state;
        var retailerObj = legacyData.queryRetailer( [{ field: "Id", operator: "eq", value: location.RetailerModel_Id }]);
        var contentObj = legacyData.queryContent( [{ field: "Id", operator: "eq", value: retailerObj.Id }]);

        if (retailerObj !== undefined) {

            if (retailerObj !== undefined) {

                object.gradeScore = retailerObj.Grade_Value;
                object.gradeName = retailerObj.Grade_Name;
                object.name = contentObj.Name;
                if (contentObj.email === undefined) {
                    contentObj.email = null;
                }
                object.email = contentObj.Email;
                object.website = contentObj.Website;
             }

            everlive.createOne('location', object, function (error, data) {
                processLocations.index ++;
                console.log("Added : " + object.name + " at " + object.address);
                if (processLocations.index < processLocations.len) {
                    processLocations.getNext();
                }
                if (error !== null) {
                    console.log("Error creating location " + JSON.stringify(error));
                }
            });
        }

    }


};
/**
 * Created by donbrad on 3/12/17.
 */


'use strict';

var linkedinModel = {
    activeObj : new kendo.data.ObservableObject({
        name : null,
        email: null,
        id: null,
        location : null,
        photoUrl : null,
        industry : null
    }),
    connected: false,

    init : function () {
        IN.Event.on(IN, "auth", linkedinModel.getProfile);
    },

    isSignedIn : function () {
        var state = IN.User.isAuthorized();
    },

    signIn : function () {
        IN.User.authorize(linkedinModel.profileSuccess());
    },

    getProfile : function () {
        IN.API.Raw("/people/~:(id,formatted-name,email-address,picture-url,location,industry)")
            .result(linkedinModel.profileSuccess)
            .error(linkedinModel.profileError);

    },

    profileSuccess : function (data) {
        var that = linkedinModel;
        var obj = that.activeObj;

        that.connected  = true;
        var name = data.formattedName;
        var email = data.emailAddress;
        var id = data.id;
        var location = data.location.name;
        var photoUrl = data.pictureUrl;
        var industry = data.industry;

        obj.set('name', name);
        obj.set('email', email);
        obj.set('id', id);
        obj.set('location', location);
        obj.set('photoUrl', photoUrl);
        obj.set('industry', industry);

        $('#linkedin-connected').removeClass('hidden');
      //  ux.notify("Connected to LinkedIn " + name, "success");


    /*    linkedinModel.companySearch('"Farm Forward"');
        linkedinModel.companyInfo("1236019");*/

    },

    profileError : function (error) {

        ux.notify("LinkedIn SignIn error " + JSON.stringify(error), 'error');

    },

    share : function (content) {

        // Build the JSON payload containing the content to be shared
        var payload = {
            "comment": content,
            "visibility": {
                "code": "anyone"
            }
        };

        IN.API.Raw("/people/~/shares?format=json")
            .method("POST")
            .body(JSON.stringify(payload))
            .result(function (data){

            })
            .error(function (error) {
                ux.notify("LinkedIn Share error " + JSON.stringify(error), 'error');
            });
    },


    companySearch : function (query) {
        var url = '/company-search?keywords=' + query;

        IN.API.Raw(url)
            .result(function (data) {
                console.log (JSON.stringify(data));
            })
            .error(function (error) {
                ux.notify("LinkedIn SignIn error " + JSON.stringify(error), 'error');
            });
    }
};
/**
 * Created by donbrad on 3/18/17.
 */

'use strict';

var mailchimpModel = {
    initialized: false,

    _bpMasterId : '11c2709581',
    _ffMasterId : '166cf7ddf5',
    _lcMasterId : '6ea8695300',
    _jifaMasterId : '583dc93d6d',
    _bffMasterId : '2cb3b544a2',

    activeList : null,

    lists : [
        {name : 'Farm Forward', slug: "farm-forward", id: '166cf7ddf5'},
        {name : 'Buying Poultry', slug: "buying-poultry", id: '11c2709581'},
        {name : 'Jewish Initiative For Animals', slug: "jifa", id: '583dc93d6d'},
        {name : 'Leadership Circle', slug: "leadership-circle", id: '6ea8695300'},
        {name : 'Better Food Foundation', slug: "bff", id: '2cb3b544a2'}
    ],



    init : function () {

    },


    addToList : function (listId) {
        var nameArray = userModel.userObj.name.split(' ');
        var  fname = nameArray[0], lname = nameArray[1];
        if (lname === undefined || lname === null) {
            lname = "";
        }
        var email = userModel.userObj.email;
        if (email === null) {
            email = userModel.userObj.Email;
        }
        /*var url = "https://gaiaapi.herokuapp.com/mailchimpuserupdate?email="+email+'&listid='+listId;

        if (userModel.userObj.mcId === null) {*/
           var  url = "https://gaiaapi.herokuapp.com/mailchimpuseradd?email="+email+'&listid='+listId;
      /*  }*/

       var listName = mailchimpModel.getListName(listId);

        url += '&fname='+fname+'&lname='+lname;

        $.ajax(url, {
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                cors: true,
                success: function (data) {
                    if (data.status === 'OK') {
                        userModel.userObj.set('mcId', data.userId);


                    } else {
                        ux.notify("Couldn't add you to " + listName + " newsletter", 'error');
                    }
                }
            }
        );
    },

    removeFromList : function (listId) {
        var nameArray = userModel.userObj.name.split(' ');

        var email = userModel.userObj.email;
        if (email === null) {
            email = userModel.userObj.Email;
        }
        var url = "https://gaiaapi.herokuapp.com/mailchimpuserremove?email="+email+'&listid='+listId;

        url += '&fname='+fname+'&lname'+lname;

        $.ajax(url, {
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                cors: true,
                success: function (data) {
                    if (data.status === 'OK') {
                        userModel.userObj.set('mcId', data.userId);

                    } else {
                        ux.notify("Couldn't add you to " + listName + " newsletter", 'error');
                    }
                }
            }
        );
    },

    updateGroups : function (listId, groups) {

        var email = userModel.userObj.email;
        if (email === null) {
            email = userModel.userObj.Email;
        }

        var groupStr = JSON.stringify(groups);

        var url = "https://gaiaapi.herokuapp.com/mailchimpusergroupupdate?email="+email+'&listid='+listId+"&interests="+groupStr;

        $.ajax(url, {
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                cors: true,
                success: function (data) {
                    if (data.status === 'OK') {

                        var groupArray = userModel.userObj.mcGroups;

                        for (var i=0; i<groups.length; i++) {
                            groupArray.push(groups[i]);
                        }
                        userModel.userObj.set('mcGroups', groupArray);


                    } else {
                        ux.notify("Couldn't add you to " + listName + " groups: " + groupStr, 'error');
                    }
                }
            }
        );

    },


    inList : function (email, listName) {

    },

    getListName : function (listId) {
        for (var i=0; i< mailchimpModel.lists.length; i++) {
            if (mailchimpModel.lists[i].id === listId) {
                return (mailchimpModel.lists[i].name);
            }
        }
        return (null);
    },

    getListSlug : function (listId) {
        for (var i=0; i< mailchimpModel.lists.length; i++) {
            if (mailchimpModel.lists[i].id === listId) {
                return (mailchimpModel.lists[i].slug);
            }
        }
        return (null);
    },

    getListId : function (listName) {
        for (var i=0; i< mailchimpModel.lists.length; i++) {
            if (mailchimpModel.lists[i].name === listName) {
                return (mailchimpModel.lists[i].id);
            }
        }
        return (null);
    },

    getListIdBySlug : function (slug) {
        for (var i=0; i< mailchimpModel.lists.length; i++) {
            if (mailchimpModel.lists[i].slug === slug) {
                return (mailchimpModel.lists[i].id);
            }
        }
        return (null);
    },

    searchUser : function (email) {
        var url = "https://gaiaapi.herokuapp.com/mailchimpsearchall?email="+email;

        $.ajax(url,{
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            cors: true,
            success: function(data) {
                if (data.status === 'OK') {
                    var matches = data.results.exact_matches;
                    var count = matches.total_items;
                    var array = [];
                    var found = false;
                    var groupArray = [];

                    for (var i=0; i<count; i++) {
                        var match = matches.members[i];

                        var id = match.id;
                        var listId = match.list_id;
                        var interests = match.interests;

                        if (interests !== undefined && interests !== null) {
                            var keys =  Object.keys(interests);
                            var values = Object.keys(interests).map(function(key) {
                                return interests[key];
                            });

                            for (var k=0; k<keys.length; k++) {
                                if (values[k] === true) {
                                    groupArray.push(keys[k]);
                                }
                            }
                        }

                        var slug = mailchimpModel.getListSlug(listId);
                        if (slug === APP.siteSlug) {
                            found = true;
                        }
                        array.push (listId);
                    }

                    if (!found) {
                        var newListId = mailchimpModel.getListIdBySlug(APP.siteSlug);
                        array.push(newListId);
                        mailchimpModel.addToList(newListId);
                    }
                    //
                    userModel.userObj.set('mcId', id);
                    userModel.userObj.set('mcLists', array);
                    userModel.userObj.set('mcGroups', groupArray);


                }

            }
        });
    }

};


'use strict';

var mapModel = {
    activeObj : new kendo.data.ObservableObject({
        placeId : null,
        lat : null,
        lng: null,
        address: null,
        county: null,
        zipcode : null,
        ziplong : null,
        state : null,
        statelong : null
    }),

    _number : 0,
    _street : 1,
    _city: 2,
    _county: 3,
    _state : 4,
    _country : 5,
    _zip : 6,
    _zipPlus : 7,

    mapsGeoLocateUrl : "https://www.googleapis.com/geolocation/v1/geolocate?key=AIzaSyAa-0ll5tP3m3CW0DbfZpGNcCn5xbeAZgM",
    mapsGeoCodeUrl : 'https://maps.googleapis.com/maps/api/geocode/json?key=AIzaSyAa-0ll5tP3m3CW0DbfZpGNcCn5xbeAZgM&address=',
    mapsDirUrl : 'https://www.google.com/maps/dir/',
    autocompleteService : null,
    geocoder : null,



    init : function () {
        var that = mapModel;

        that.autcompleteService = new google.maps.places.AutocompleteService();

        that.geocoder = new google.maps.Geocoder;
    },

    processPlace : function (geo) {
        var that = mapModel;
        var addr = geo.address_components;
        var addrLong={}, addrShort = {};
        jQuery.each(addr, function(k,v1) {jQuery.each(v1.types, function(k2, v2){addrLong[v2]=v1.long_name});});
        jQuery.each(addr, function(k,v1) {jQuery.each(v1.types, function(k2, v2){addrShort[v2]=v1.short_name});});
        var address = geo.formatted_address;
        var type = geo.types[0];

        mapModel.activeObj.set('placeId', geo.place_id);
        mapModel.activeObj.set('lat', geo.geometry.location.lat());
        mapModel.activeObj.set('lng', geo.geometry.location.lng());
        mapModel.activeObj.set('address', address);
        mapModel.activeObj.set('zipcode', addrShort.postal_code);
        mapModel.activeObj.set('county', addrLong.administrative_area_level_2);
        mapModel.activeObj.set('country',  addrShort.political);
        mapModel.activeObj.set('state', addrShort.administrative_area_level_1);
        mapModel.activeObj.set('statelong', addrLong.administrative_area_level_1);
        mapModel.activeObj.set('ziplong', addrLong.postal_code);




    },

    reverseGeoCode : function (lat, lng, callback) {
        var that = mapModel;
        var latlng = {lat: parseFloat(lat), lng: parseFloat(lng)};
        mapModel.geocoder.geocode({'location': latlng}, function(results, status) {
            if (status === 'OK') {
                if (results[0]) {
                    var geo = results[0];
                    mapModel.processPlace(geo);
                    callback(mapModel.activeObj);

                } else {
                   // ux.notify('No Address results found');
                    callback(null);
                }
            } else {
                ux.notify('Reverse geocoder failed due to: ' + status);
                callback(null);
            }
        });
    },

    geoCodeAddress : function (address, callback) {
        var that = mapModel;
        that.geocoder.geocode({'address': address}, function(results, status) {
            if (status === 'OK') {
                if (results[0]) {
                    callback(results[0]);
                } else {
                    ux.notify('No Geocode  results found');
                    callback(null);
                }
            } else {
                ux.notify('Geocoder failed due to: ' + status);
                callback(null);
            }
        });
    },

    getUserLocation : function (callback) {
      //  ux.notify ("Finding Your Location...", "success");

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function (position) {
                    var gpsLoc = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    mapModel.reverseGeoCode(gpsLoc.lat, gpsLoc.lng, callback);

                },
                function (error) {
                    ux.notify ("Autolocation disabled.  Using approximate location...", "success");
                    $.ajax({
                        type: "POST",
                        url: that.mapsGeoLocateUrl,
                        success: function ( data, textStatus, jqXHR ) {
                            var accuracy = data.accuracy;
                            var lat = data.location.lat, lng = data.location.lng;
                            mapModel.reverseGeoCode(lat,lng, callback);

                        },
                        dataType: 'json'
                    });

                    // locationView.algoliaHelper.setQueryParameter('aroundLatLngViaIP', true).search();
                }
            );
            //locationView.changeLocation(true))
        }
    }

};
/**
 * Created by donbrad on 3/18/17.
 */

'use strict';

var mcGroupModel = {
    initialized : false,
    groupDS : new kendo.data.DataSource(),
    groupLoaded : false,
    _cloudClass : 'mcGroup',
    groupArray : [],

    init: function () {
        if (mcGroupModel._initialized) {
            return;
        }

        mcGroupModel._initialized = true;

        mcGroupModel.groupDS = new kendo.data.DataSource({
            type: 'everlive',
            transport: {
                typeName: mcGroupModel._cloudClass,
                dataProvider: APP.everlive
            },
            schema: {
                model: { id:  Everlive.idField}
            },
            requestEnd: function(e) {
                var response = e.response;
                var type = e.type;
                if (e.type === "read" && e.response) {
                    console.log("MCGroup: " + response.count);

                }
            }
        });

        mcGroupModel.groupDS.bind("change", function (e) {
            var groups = e.items;
            if (e.action === undefined && groups) {
                if (groups !== undefined && !mcGroupModel.groupLoaded) {
                    mcGroupModel.groupLoaded = true;
                    //mcGroupModel.syncAllGroups();
                    ghEvent.trigger(ghEvent.mailchimpLoaded);
                }
            }
        });

        mcGroupModel.groupDS.fetch();

    },

    syncAllInterests : function () {
        var index = 0;
        var count = mcGroupModel.groupArray.length;
        var group = mcGroupModel.groupArray[index];

        function getNext () {

            if (index < count) {
                group = mcGroupModel.groupArray[index];
                mcGroupModel.getInterests(group, function () {
                    index++;
                    return (getNext());
                })
            }
        }

        getNext();
    },

    syncAllGroups : function () {
        var index = 0;
        var count = mailchimpModel.lists.length;
        var listId = mailchimpModel.lists[index].id;

        mcGroupModel.groupArray = [];
        function getNext () {

            if (index < count) {
                listId = mailchimpModel.lists[index].id;
                mcGroupModel.getGroups(listId, function () {
                    index++;
                    return (getNext());
                })
            } else {
                mcGroupModel.syncAllInterests();
            }
        }

        getNext();
    },


    getGroups : function (listid, callback) {
        var url = "https://gaiaapi.herokuapp.com/mailchimpgroups?listid="+listid;

        $.ajax(url,{
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            cors: true,
            success: function(data) {
                if (data.status === 'OK') {

                    var groups = data.groups.categories;
                    var count = groups.length;


                    for (var i=0; i<count; i++) {
                        var group = groups[i];

                        var listName = mailchimpModel.getListName(group.list_id);
                        var groupObj = {
                            listId: group.list_id,
                            listName: listName,
                            groupName: group.title,
                            groupId: group.id
                        };

                       mcGroupModel.groupArray.push(groupObj);

                    }

                    if (callback !== undefined) {
                        callback ();
                    }

                }

            }
        });
    },

    getInterests : function (group, callback) {

        var listId = group.listId;
        var listName = group.listName;
        var groupId = group.groupId;
        var groupName = group.groupName;
        var url = "https://gaiaapi.herokuapp.com/mailchimpgroupitems?listid="+listId+"&groupid="+groupId;

        $.ajax(url,{
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            cors: true,
            success: function(data) {
                if (data.status === 'OK') {
                    var interests = data.groups.interests;
                    var count = interests.length;

                    for (var i=0; i<count; i++) {
                        var interest = interests[i];

                        var listName = mailchimpModel.getListName(interest.list_id);
                        var interestObj = {
                            listId: listId,
                            listName: listName,
                            groupName: groupName,
                            groupId: groupId,
                            interestId : interest.id,
                            interestName : interest.name
                        };

                        mcGroupModel.addIfNew(interestObj);

                    }

                    if (callback !== undefined) {
                        callback ();
                    }

                }

            }
        });
    },

    query : function (query) {
        if (query === undefined)
            return(undefined);

        var dataSource =  mcGroupModel.groupDS;

        dataSource.filter(query);
        var view = dataSource.view();

        dataSource.filter({});

        return(view);
    },

    findByInterestId : function (interestId) {

        var groups = mcGroupModel.query({field: "interestId", operator: "eq", value: interestId});

        if (groups.length === 0) {
            return(null);
        }
        return (groups[0]);
    },

    findByGroupId : function (groupId) {

        var groups = mcGroupModel.query({field: "groupId", operator: "eq", value: groupId});

        if (groups.length === 0) {
            return([]);
        }
        return (groups);
    },
    

    listByListId : function (listId) {

        var groups = mcGroupModel.query({field: "listId", operator: "eq", value: listId});

        if (groups.length === 0) {
            return([]);
        }
        return (groups);
    },


    update : function (group) {

        everlive.updateOne(mcGroupModel._cloudClass, group, function (err, data) {
            if (err !== null) {
                ux.notify("Couldn't update group " + JSON.stringify(err), 'error');
            }
        });
    },

    addIfNew : function (group) {
        var id = group.interestId;

        if (mcGroupModel.findByInterestId(id) !== null) {
            return;
        }

        everlive.createOne(mcGroupModel._cloudClass, group, function (err, data) {
            if (err !== null) {
                ux.notify("Couldn't update group " + JSON.stringify(err), 'error');
            }
        });
    },
    
    add : function (group) {
        everlive.createOne(mcGroupModel._cloudClass, group, function (err, data) {
            if (err !== null) {
                ux.notify("Couldn't update group " + JSON.stringify(err), 'error');
            }
        });
    },

    remove : function (group) {
        everlive.deleteOne(mcGroupModel._cloudClass, group, function (err, data) {
            if (err !== null) {
                ux.notify("Couldn't update group " + JSON.stringify(err), 'error');
            }

        });
    }

};

/**
 * Created by donbrad on 10/8/16.
 */

'use strict';

var missionModel = {

    missionLoaded : false,
    missionDS: null,

    init : function () {


        missionModel.missionDS = new kendo.data.DataSource({
            type: 'everlive',
            transport: {
                typeName: 'mission',
                dataProvider: APP.everlive
            },
            schema: {
                model: { id:  Everlive.idField}
            },
           // sort: { field: "publishDate", dir: "desc" },
            requestEnd: function(e) {
                var response = e.response;
                var type = e.type;
                if (e.type === "read" && e.response) {
                    console.log("Mission: " + response.count);

                }
            }
        });

        missionModel.missionDS.bind("change", function (e) {
            var pages = e.items;
            if (e.action === undefined && pages) {
                if (pages !== undefined && !missionModel.missionLoaded) {
                    missionModel.missionLoaded = true;

                }
            }
        });

        missionModel.missionDS.fetch();
        
    },

    query: function (query) {
        if (query === undefined)
            return(undefined);
        var dataSource =  missionModel.missionDS;
        var cacheFilter = dataSource.filter();
        if (cacheFilter === undefined) {
            cacheFilter = {};
        }

        dataSource.filter( query);
        var view = dataSource.view();

        dataSource.filter(cacheFilter);

        return(view);
    },


    find : function (id) {

        var missions = missionModel.query({field: "Id", operator: "eq", value: id});

        if (missions.length === 0) {
            return(null);
        }
        return (missions[0]);
    },

    findAll : function (id) {

        var missions = missionModel.query({field: "Id", operator: "eq", value: id});

        if (missions.length === 0) {
            return([]);
        }
        return (missions);
    },


    findBySlug : function (slug) {

        var missions = missionModel.query({field: "slug", operator: "eq", value: slug});

        if (missions.length === 0) {
            return(null);
        }
        return (missions[0]);
    },

    findAllBySiteSlug : function (slug) {

        var missions = missionModel.query({field: "siteslug", operator: "eq", value: slug});

        if (missions.length === 0) {
            return(null);
        }
        return (missions);
    },

    add : function () {

    },

    update : function () {

    },

    delete : function () {

    }


};
/**
 * Created by donbrad on 10/8/16.
 */

'use strict';

var pageModel = {

    pageLoaded : false,
    pageDS: null,
    pagesByDate : [],
    jifaDS : new kendo.data.DataSource(),   // All pages for Jifa site
    bpDS : new kendo.data.DataSource(),  // Site map for  Buying Poultry pages
    ffDS : new kendo.data.DataSource(),

    init : function () {
        var that = pageModel;

        that.pageDS = new kendo.data.DataSource({
            type: 'everlive',
            transport: {
                typeName: 'page',
                dataProvider: APP.everlive
            },
            schema: {
                model: { id:  Everlive.idField}
            },
           // sort: { field: "publishDate", dir: "desc" },
            requestEnd: function(e) {
                var response = e.response;
                var type = e.type;
                if (e.type === "read" && e.response) {
                    console.log("Pages: " + response.count);

                }
            }
        });

       pageModel.pageDS.bind("change", function (e) {
            var pages = e.items;
            if (e.action === undefined && pages) {
                if (pages !== undefined && !pageModel.pageLoaded) {
                    pageModel.pageLoaded = true;

                   /* pageModel.jifaDS.data(jifa);
                    pageModel.buildJIFA();*/
                }
            }
        });

        that.pageDS.fetch();
        
    },

    queryPages: function (query) {
        if (query === undefined)
            return(undefined);
        var dataSource =  pageModel.pageDS;
        dataSource.filter(query);
        var view = dataSource.view();
        dataSource.filter([]);
        return(view);
    },

    buildPageTree : function (slug, name) {
        var pageIn = pageModel.findPagesBySiteSlug(slug);

        var root = {
            Id: 0, slug: slug, title: "Main Menu", inMainMenu: false, isPublished: true,
            modified: moment(), parentName : null, parentSlug: null, pageList: []
        };

        for (var i=0; i<pageIn.length; i++) {
            var page = pageIn[i];

            if (page.parentSlug === null) {
                var pageObj = {
                    Id: page.Id, slug: page.slug, title: page.title, inMainMenu: page.inMainMenu, isPublished: page.isPublished,
                    modified: moment(page.modified), parentName : 'Main Menu', parentSlug: 'menu-root', pageList : []
                };

                if (page.children.length > 0) {
                    for (var j=0; j<page.children.length; j++) {
                        var slugId = page.children[j];
                        var child = pageModel.findPageBySlug(slugId);

                        var childObj = {
                            Id: child.Id, slug: child.slug, title: child.title, inMainMenu: child.inMainMenu, isPublished: child.isPublished,
                            modified: moment(child.modified), parentName : child.parentName, parentSlug: child.parentSlug, pageList: []
                        };
                        pageObj.pageList.push(childObj);
                    }
                }

               // pageModel.jifaSiteDS.add(pageObj);
                root.pageList.push(pageObj);
            }
        }

       return root;
    },

    buildMainMenu : function (slug, name) {
        var jifa = pageModel.findPagesBySiteSlug(slug);

        var pages = [];

        for (var i=0; i<jifa.length; i++) {
            var page = jifa[i];

            if (page.parentSlug === null) {
                var pageObj = {
                    Id: page.Id, slug: page.slug, title: page.title, inMainMenu: page.inMainMenu, isPublished: page.isPublished,
                    modified: moment(page.modified), parentName : page.parentName, parentSlug: page.parentSlug
                };

                if (page.children.length > 0) {
                    for (var j=0; j<page.children.length; j++) {
                        var slugId = page.children[j];
                        var child = pageModel.findPageBySlug(slugId);

                        var childObj = {
                            Id: child.Id, slug: child.slug, title: child.title, inMainMenu: child.inMainMenu, isPublished: child.isPublished,
                            modified: moment(child.modified), parentName : child.parentName, parentSlug: child.parentSlug
                        };
                        pageObj.pageList.push(childObj);
                    }
                }

                // pageModel.jifaSiteDS.add(pageObj);
                pages.push(pageObj);
            }
        }

        return pages;
    },


    findPage : function (id) {

        var pages = pageModel.queryPages({field: "Id", operator: "eq", value: id});

        if (pages.length === 0) {
            return(null);
        }
        return (pages[0]);
    },

    findPageBySlug : function (slug) {

        var pages = pageModel.queryPages({field: "slug", operator: "eq", value: slug});

        if (pages.length === 0) {
            return(null);
        }
        return (pages[0]);
    },

    findPagesBySiteSlug : function (slug) {

        var pages = pageModel.queryPages({field: "siteSlug", operator: "eq", value: slug});

        if (pages.length === 0) {
            return([]);
        }
        return (pages);
    },

    getSitePages : function (slug) {

        var pages = pageModel.queryPages({field: "siteSlug", operator: "eq", value: slug});

        if (pages.length === 0) {
            return([]);
        }

        var pageList = [];
        for (var i=0; i<pages.length; i++) {
            var page = pages[i];

            var pageObj = {
                Id: page.id,
                title: page.title,
                slug: page.slug,
                parentSlug: page.parentSlug,
                inMainMenu : page.inMainMenu,
                status: page.status,
                authorName: page.authorName,
                authorSlug: page.authorSlug,
                content: page.content,
                created : page.date,
                modified : page.modified,
                site : page.site,
                siteSlug : page.siteSlug
            };

            if (page.isPublished === undefined) {
                page.isPublished = true;
            }
            pageObj.isPublished = page.isPublished;

            pageList.push(pageObj);

        }
        return (pageList);
    }


};
/**
 * Created by donbrad on 3/17/17.
 */



'use strict';

var  paymentHistoryModel = {
    initialized : false,
    loaded : false,


    userPaymentsDS : new kendo.data.DataSource( {
        group: { field: "Email" },
        aggregate: [
            { field: "Total", aggregate: "sum" },
            { field: "Total", aggregate: "average" },
            { field: "Total", aggregate: "min" },
            { field: "Total", aggregate: "max" }
        ]

    }),

    userLedgerDS: new kendo.data.DataSource( {
        aggregate: [
            { field: "total", aggregate: "sum" },
            { field: "total", aggregate: "average" },
            { field: "total", aggregate: "min" },
            { field: "total", aggregate: "max" }
        ]

    }),

    userTransactionDS :  new kendo.data.DataSource(),

    paymentsDS : new kendo.data.DataSource({
        transport: {
            read: {
                type: "GET",
                url: "../../data/clickpledge.json",
                dataType: 'json'
            }
        },
        group: { field: "Email" },
        change : function (e) {
            var payments = e.items;
            if (e.action === undefined) {
                if (payments !== undefined && !paymentHistoryModel.loaded) {
                    paymentHistoryModel.loaded = true;
                    paymentHistoryModel.paymentsDS.group({ field: "Email" });
                    console.log("Payments : " + paymentHistoryModel.paymentsDS.view().length);

                  /*paymentHistoryModel.processUserPayments();*/
                  ux.notify('Payment History Loaded!', 'success');
                }
            }
        }
    }),

    init : function () {

        paymentHistoryModel.paymentsDS.fetch();

       /* paymentHistoryModel.paymentsDS.bind("change", function (e) {
            var payments = e.items;
            if (e.action === undefined) {
                if (payments !== undefined && !paymentHistoryModel.loaded) {
                    paymentHistoryModel.loaded = true;
                    paymentHistoryModel.paymentsDS.group({ field: "category" });
                    ux.notify('Payment History Loaded!', 'success');
                }
            }
        });*/
    },

    query: function (query) {
        if (query === undefined)
            return(undefined);
        var dataSource =  paymentHistoryModel.paymentsDS;
        var cacheFilter = dataSource.filter();
        if (cacheFilter === undefined) {
            cacheFilter = {};
        }

        dataSource.filter( query);
        var view = dataSource.view();

        dataSource.filter(cacheFilter);

        return(view);
    },

    findByEmail : function (email) {
        var payments = paymentHistoryModel.query({field: "Email", operator: "eq", value: email});

        if (payments.length === 0) {
            return([]);
        }
        return (payments);

    },


    processUserPayments : function () {
        var that = paymentHistoryModel;

        var map = [];
        var view = that.paymentsDS.view();
        var length = view.length;

        ux.notify("Processing payment history...", 'success');
        for (var i=0; i<length; i++) {

            var payment = view[i];

            for (var j=0; j<payment.items.length; j++) {
                map[payment.items[j].OrderNumber] = payment.items[j];
            }

        }

        for (var key in map) {
            var pay = map[key];
            pay.Name = pay.FirstName + " " + pay.LastName;
            pay.FullAddress = pay.Address1 + ", " + pay.City + ", " + pay.StateProvince + "  " + pay.ZipCode;
            pay.Total = parseFloat(pay.TotalCharged);
            that.userPaymentsDS.add(pay);
        }

        var totals = that.userPaymentsDS.aggregates().Total;


        var upview = that.userPaymentsDS.view();

        for (var i=0; i< upview.length; i++) {
            var user = upview[i];
            var userData = user.items[0];

            var userObj = {
                userId : null,
                name: userData.Name,
                email : userData.Email,
                fullAddress : userData.FullAddress,
                orderNumber: userData.OrderNumber,
                sourceId: 'clickandpledge',
                siteId : 'farm-forward',
                organizationId : 'farm-forward',
                campaignId : 'farm-forward-annual',
                date : userData.TransactionDate,
                state: userData.StateProvince,
                zipcode: userData.ZipCode,
                total: userData.Total
            };

            var transObj = {
                userId : null,
                email : userData.Email,
                date : userData.TransactionDate,
                siteId : 'farm-forward',
                campaignId : 'farm-forward-annual',
                isRecurring: false,
                installment: 1,
                recurringId: null,
                amount: userData.Total
            };

            userObj.installments = 1;
            if (user.items.length === 1) {
                userObj.period = "Single";
                userObj.isRecurring = false;
                userTransaction.add(transObj);

            } else {
                userObj.isRecurring = true;
                transObj.isRecurring = true;
                userTransaction.add(transObj);
                for (var j=1; j<user.items.length; j++) {
                    var item = user.items[j];

                    transObj.installment = parseInt(item.InstallmentNumber);
                    transObj.amount =  item.Total;
                    transObj.date = item.TransactionDate;
                    userObj.period = item.RecurringPeriodicity;
                    userObj.installments++;
                    userObj.total += item.Total;
                    userTransaction.add(transObj);
                }
            }

            that.userLedgerDS.add(userObj);
            userDonation.add(userObj);
        }

        var ledgerTotals = that.userLedgerDS.aggregates().total;

        ux.notify("Payment history processing complete!!!", 'success');
       // that.userPaymentsDS.data(map);
    }

};
/**
 * Created by donbrad on 3/18/17.
 */

'use strict';

var petitionModel = {
    initialized : false,
    petitionDS : new kendo.data.DataSource(),
    petitionLoaded : false,
    _cloudClass : 'petition',

    init: function () {
        if (petitionModel._initialized) {
            return;
        }

        petitionModel._initialized = true;

        petitionModel.petitionDS = new kendo.data.DataSource({
            type: 'everlive',
            transport: {
                typeName: petitionModel._cloudClass,
                dataProvider: APP.everlive
            },
            schema: {
                model: { id:  Everlive.idField}
            },
            requestEnd: function(e) {
                var response = e.response;
                var type = e.type;
                if (e.type === "read" && e.response) {
                    console.log("Petition: " + response.count);

                }
            }
        });

        petitionModel.petitionDS.bind("change", function (e) {
            var petitions = e.items;
            if (e.action === undefined && petitions) {
                if (petitions !== undefined && !petitionModel.petitionLoaded) {
                    petitionModel.petitionLoaded = true;
                }
            }
        });

        petitionModel.petitionDS.fetch();

    },

    query : function (query) {
        if (query === undefined)
            return(undefined);

        var dataSource =  petitionModel.petitionDS;

        dataSource.filter(query);
        var view = dataSource.view();

        dataSource.filter({});

        return(view);
    },

    findById : function (id) {

        var sites = petitionModel.query({field: "Id", operator: "eq", value: id});

        if (sites.length === 0) {
            return(null);
        }
        return (sites[0]);
    },

    listBySiteSlug : function (slug) {

        var sites = petitionModel.query({field: "siteSlug", operator: "eq", value: slug});

        if (sites.length === 0) {
            return([]);
        }
        return (sites);
    },


    listByCampaign : function (campaign) {

        var sites = petitionModel.query({field: "campaignId", operator: "eq", value: campaign});

        if (sites.length === 0) {
            return([]);
        }
        return (sites);
    },


    update : function (petition) {

        everlive.updateOne(petitionModel._cloudClass, petition, function (err, data) {
            if (err !== null) {
                ux.notify("Couldn't update petition " + JSON.stringify(err), 'error');
            }
        });
    },

    add : function (petition) {
        everlive.createOne(petitionModel._cloudClass, petition, function (err, data) {
            if (err !== null) {
                ux.notify("Couldn't update petition " + JSON.stringify(err), 'error');
            }
        });
    },

    remove : function (petition) {
        everlive.deleteOne(petitionModel._cloudClass, petition, function (err, data) {
            if (err !== null) {
                ux.notify("Couldn't update petition " + JSON.stringify(err), 'error');
            }

        });
    }

};

/**
 * Created by donbrad on 3/18/17.
 */

'use strict';

var pledgeModel = {
    initialized : false,
    pledgeDS : new kendo.data.DataSource(),
    pledgeLoaded : false,
    _cloudClass : 'pledge',

    init: function () {
        if (pledgeModel._initialized) {
            return;
        }

        pledgeModel._initialized = true;

        pledgeModel.pledgeDS = new kendo.data.DataSource({
            type: 'everlive',
            transport: {
                typeName: pledgeModel._cloudClass,
                dataProvider: APP.everlive
            },
            schema: {
                model: { id:  Everlive.idField}
            },
            requestEnd: function(e) {
                var response = e.response;
                var type = e.type;
                if (e.type === "read" && e.response) {
                    console.log("Pledge: " + response.count);


                }
            }
        });

        pledgeModel.pledgeDS.bind("change", function (e) {
            var pledges = e.items;
            if (e.action === undefined && pledges) {

                if (pledges && !pledgeModel.pledgeLoaded) {
                    pledgeModel.pledgeLoaded = true;
                    ghEvent.trigger(ghEvent.pledgeLoaded);
                }
            }
        });

        pledgeModel.pledgeDS.fetch();

    },

    query : function (query) {
        if (query === undefined)
            return(undefined);

        var dataSource =  pledgeModel.pledgeDS;

        dataSource.filter(query);
        var view = dataSource.view();

        dataSource.filter({});

        return(view);
    },

    findById : function (id) {

        var sites = pledgeModel.query({field: "Id", operator: "eq", value: id});

        if (sites.length === 0) {
            return(null);
        }
        return (sites[0]);
    },

    findBySlug : function (slug) {

        var sites = pledgeModel.query({field: "slug", operator: "eq", value: slug});

        if (sites.length === 0) {
            return(null);
        }
        return (sites[0]);
    },

    listBySiteSlug : function (slug) {

        var sites = pledgeModel.query({field: "siteSlug", operator: "eq", value: slug});

        if (sites.length === 0) {
            return([]);
        }
        return (sites);
    },

    listByCampaign : function (campaign) {

        var sites = pledgeModel.query({field: "campaignId", operator: "eq", value: campaign});

        if (sites.length === 0) {
            return([]);
        }
        return (sites);
    },


    update : function (pledge) {

        everlive.updateOne(pledgeModel._cloudClass, pledge, function (err, data) {
            if (err !== null) {
                ux.notify("Couldn't update pledge " + JSON.stringify(err), 'error');
            }
        });
    },

    add : function (pledge) {
        everlive.createOne(pledgeModel._cloudClass, pledge, function (err, data) {
            if (err !== null) {
                ux.notify("Couldn't update pledge " + JSON.stringify(err), 'error');
            }
        });
    },

    remove : function (pledge) {
        everlive.deleteOne(pledgeModel._cloudClass, pledge, function (err, data) {
            if (err !== null) {
                ux.notify("Couldn't update pledge " + JSON.stringify(err), 'error');
            }

        });
    }

};

/**
 * Created by donbrad on 10/8/16.
 */

'use strict';

var quizModel = {

    quizLoaded : false,
    quizDS: null,
    questionDS : null,

    init : function () {

        quizModel.quizDS = new kendo.data.DataSource({
            type: 'everlive',
            transport: {
                typeName: 'quiz',
                dataProvider: APP.everlive
            },
            schema: {
                model: { id:  Everlive.idField}
            },
           // sort: { field: "publishDate", dir: "desc" },
            requestEnd: function(e) {
                var response = e.response;
                var type = e.type;
                if (e.type === "read" && e.response) {
                    console.log("Quiz: " + response.count);

                }
            }
        });

        quizModel.quizDS.bind("change", function (e) {
            var quizs = e.items;
            if (e.action === undefined && quizs) {
                if (quizs !== undefined && !quizModel.quizLoaded) {
                    quizModel.quizLoaded = true;

                }
            }
        });

        quizModel.quizDS.fetch();

    },

    query: function (query) {
        if (query === undefined)
            return(undefined);
        var dataSource =  quizModel.quizDS;
        var cacheFilter = dataSource.filter();
        if (cacheFilter === undefined) {
            cacheFilter = {};
        }

        dataSource.filter( query);
        var view = dataSource.view();

        dataSource.filter(cacheFilter);

        return(view);
    },

    find: function (id) {

        var quizes = quizModel.query({field: "Id", operator: "eq", value: id});

        if (quizes.length === 0) {
            return(null);
        }
        return (quizes[0]);
    },

    findBySlug : function (slug) {

        var quizes = quizModel.query({field: "slug", operator: "eq", value: slug});

        if (quizes.length === 0) {
            return(null);
        }
        return (quizes[0]);
    },

    findByTag : function (tag) {

        var quizes = quizModel.query({field: "tags", operator: "eq", value: tag});

        if (quizes.length === 0) {
            return(null);
        }
        return (quizes[0]);
    },

    findByCategory : function (category) {

        var quizes = quizModel.query({field: "categories", operator: "eq", value: category});

        if (quizes.length === 0) {
            return(null);
        }
        return (quizes[0]);
    },

    loadQuiz : function (slug) {

    },

    add : function (quiz) {

        everlive.createOne('quiz', quiz, function(err, data){
            if (err !== null) {
                ux.notify("Couldn't create Quiz " + JSON.stringify(err), 'error');
            }

        });
    },

    save : function (quiz) {
        everlive.updateOne('quiz', quiz, function(err, data){
            if (err !== null) {
                ux.notify("Couldn't update Quiz " + JSON.stringify(err), 'error');
            }

        });
    }


};
/**
 * Created by donbrad on 3/17/17.
 */

'use strict';

var recipeSearchModel = {



};
/**
 * Created by donbrad on 12/20/16.
 */
'use strict';

var shareModel = {
    _postUrl : "https://www.googleapis.com/urlshortener/v1/url?key=AIzaSyAa-0ll5tP3m3CW0DbfZpGNcCn5xbeAZgM",
    _getUrl : "https://www.googleapis.com/urlshortener/v1/url?projection=FULL&shortUrl=",

    _fbUrl : "https://www.facebook.com/sharer/sharer.php?u=",
    _twitterUrl : "https://twitter.com/intent/tweet?text=",
    _emailUrl : "mailto:?subject=",


    activeObj : new kendo.data.ObservableObject ( {
        longUrl: null,
        shortUrl : null,
        title: null,
        content : null,
        valid : false

    }),

    _emailClass : "",
    _facebookClass : "",
    _twitterClass : "",


    init : function () {

    },

    getCurrentUrl : function () {
        var url = window.location.href;

        return url;
    },

    _shortenUrl : function (longUrl, callback) {

        $.ajax({
            url: shareModel._postUrl,
            type: 'POST',
            contentType: 'application/json; charset=utf-8',
            data: '{ longUrl: "' + longUrl +'"}',
            dataType: 'json',
            success: function(data) {
                var respObj = {status: 'OK', longUrl: longUrl, shortUrl: null};
                if (data.id !== undefined && data.id !== null) {
                    respObj.shortUrl = data.id;
                } else {
                    respObj.status = 'ERROR';
                }
                callback(respObj);
            }
        });

    },

    _expandUrl : function (shortUrl, callback) {

        var url = shareModel._getUrl + shortUrl;
        $.ajax({
            url: url,
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            success: function(data) {
                var respObj = {status: 'OK', longUrl: null, shortUrl: shortUrl, analytics: null};
                if (data.status === 'OK') {
                    respObj.longUrl = data.longUrl;
                    respObj.analytics = data.analytics;
                } else {
                    respObj.status = 'ERROR';
                }
                callback(respObj);
            }
        });

    },


    setShare : function (title, content, url) {

        var that = shareModel;

       // $('.rrssb-buttons').addClass('hidden');
        that.activeObj.set('valid', false);
        that.activeObj.set('title', title);
        that.activeObj.set('content', content);
        that.activeObj.set('longUrl', url);
        that._shortenUrl(url, function(result) {
            if (result.status === 'OK') {
                shareModel.activeObj.set('shortUrl', result.shortUrl);
                shareModel.activeObj.set('valid', true);
                shareModel.updateAll();
             //  $('.rrssb-buttons').removeClass('hidden');
            }

        });

    },

    fbClick : function (e) {

        e.preventDefault();
        FB.ui({
            method: 'feed',
            name: shareModel.activeObj.title,
            link: shareModel.activeObj.shortUrl,
            picture: 'http://www.buyfarmforward.com/images/logo.png',
            caption: shareModel.activeObj.title,
            description: shareModel.activeObj.content,
            message: ""
        });

    },

    updateEmail : function () {
        var url = shareModel._emailUrl + shareModel.activeObj.title + "&body= "+ shareModel.activeObj.content + " " + shareModel.activeObj.shortUrl;
        $('.share-email').attr('href',url);
    },

    updateFacebook : function () {
       /* var url = shareModel._fbUrl+ shareModel.activeObj.shortUrl;
        $('.share-facebook').attr('href',url);*/
    },

    updateTwitter : function () {
        var url = shareModel._twitterUrl + shareModel.activeObj.title + " " + shareModel.activeObj.shortUrl;
        $('.share-twitter').attr('href',url);
    },

    updateAll : function () {
        var that = shareModel;

        that.updateEmail();
        that.updateFacebook();
        that.updateTwitter();

    }

};
/**
 * Created by donbrad on 10/8/16.
 */

'use strict';

var siteModel = {

    siteLoaded : false,
    siteDS: null,
    currentSite : null,
   

    init : function () {

        siteModel.siteDS = new kendo.data.DataSource({
            type: 'everlive',
            transport: {
                typeName: 'site',
                dataProvider: APP.everlive
            },
            schema: {
                model: { id:  Everlive.idField}
            },
            requestEnd: function(e) {
                var response = e.response;
                var type = e.type;
                if (e.type === "read" && e.response) {
                    console.log("Site: " + response.count);

                }
            }
        });

       siteModel.siteDS.bind("change", function (e) {
            var sites = e.items;
            if (e.action === undefined && sites) {
                if (sites !== undefined && !siteModel.siteLoaded) {
                    siteModel.siteLoaded = true;
                    siteModel.setSite(APP.siteSlug);
                    ghEvent.trigger(ghEvent.siteLoaded);
                   console.log("Site : " + siteModel.currentSite.name);
                }
            }
        });

        siteModel.siteDS.fetch();

    },

    setSite : function (siteId) {
        siteModel.currentSite = siteModel.findBySlug(siteId);
    },

    query: function (query) {
        if (query === undefined)
            return(undefined);
        var dataSource =  siteModel.siteDS;

        dataSource.filter( query);
        var view = dataSource.view();

        dataSource.filter([]);

        return(view);
    },


    findById: function (id) {

        var sites = siteModel.query({field: "Id", operator: "eq", value: id});

        if (sites.length === 0) {
            return(null);
        }
        return (sites[0]);
    },

    findBySlug : function (slug) {

        var sites = siteModel.query({field: "slug", operator: "eq", value: slug});

        if (sites.length === 0) {
            return(null);
        }
        return (sites[0]);
    },

    update : function (site) {

        everlive.updateOne('site', site, function (err, data) {
            if (err !== null) {
                ux.notify("Couldn't update Site " + JSON.stringify(err), 'error');
            }
        });
    }
    
    


};
/**
 * Created by donbrad on 3/18/17.
 */


'use strict';

var supporterModel = {

    initialized : false,
    supporterDS : new kendo.data.DataSource(),
    activeObj : new kendo.data.ObservableObject({
        tierCount: 0,
        tierTitles: [],
        tierValues: []
    }),

    init: function () {

    },

    query : function (query) {

    },

    find : function(supportId) {

    },

    setTiers : function (tierList) {

    },

    buildTiers : function () {

    }

};
/**
 * Created by donbrad on 1/15/17.
 */


'use strict';

var tagModel = {

    tagDS : new kendo.data.DataSource(),
    categoryDS : new kendo.data.DataSource(),
    initialized : false,
    tagLoaded : false,
    categoryLoaded : false,

    init : function () {
        if (tagModel.initialized) {
            return;
        }

        tagModel.initialized = true;

        tagModel.tagDS = new kendo.data.DataSource({
            type: 'everlive',
            transport: {
                typeName: 'tag',
                dataProvider: APP.everlive
            },
            schema: {
                model: { Id:  Everlive.idField}
            }
        });

        tagModel.tagDS.bind("change", function (e) {
            var tagArray = e.items;
            if (e.action === undefined) {
                if (tagArray !== undefined && !tagModel.tagLoaded) {
                    tagModel.tagLoaded = true;
                   // ux.notify('Tags Loaded!', 'success');
                }
            }
        });

        tagModel.tagDS.fetch();

        tagModel.categoryDS = new kendo.data.DataSource({
            type: 'everlive',
            transport: {
                typeName: 'category',
                dataProvider: APP.everlive
            },
            schema: {
                model: { id:  Everlive.idField}
            },
            pageSize: 12
        });

        tagModel.categoryDS.bind("change", function (e) {
            var catArray = e.items;
            if (e.action === undefined) {
                if (catArray !== undefined && !tagModel.categoryLoaded) {
                    tagModel.categoryLoaded = true;
                }
            }
        });

        tagModel.categoryDS.fetch();
    }



};
/**
 * Created by donbrad on 3/15/17.
 */

'use strict';

var templateLoader = {
    cache : [],

    init : function () {
        templateLoader.cache = [];
    },

    isCached : function (path) {
        if (templateLoader.cache[path] !== undefined) {
            return (true);
        }

        return(false);
    },


    load : function (path, callback) {

        if (templateLoader.isCached(path) === true) {
            callback(true);
        } else {
            var tmplLoader = $.get(path)
                .success(function(result){
                    //On success, Add templates to DOM (assumes file only has template definitions)
                    $("body").append(result);
                   templateLoader.cache[path] = true;
                    callback(true);
                })
                .error(function(error){
                    ux.notify("Error Loading template " + path, error);
                    callback(false);
                });

            tmplLoader.complete(function(){
                //Publish an event that indicates when a template is done loading
                templateLoader.cache[path] = true;
                callback(true);
            });
        }

    },


    loadHtml : function (selector, path, callback) {
        var sel = '#' + selector;
        var $sel = $(sel);


        if ($sel.length > 0) {
            return callback (true);
        }

        $.ajax({
            url: path,
            dataType: "html"})
        .done(function(data) {
                $('#app').append(data);
                callback (true);
            })
        .fail(function( jqXHR, textStatus ) {
            ux.notify( "Request failed: " + textStatus, "error");
            callback(false);
        });

    }

};

/**
 * Created by donbrad on 1/1/17.
 */


'use strict';

var userDonation = {

    initialized : false,
    userDonationDS : null,
    donationDS : null,
    plansDS : null,
    donationsLoaded : false,
    userDonationsLoaded: false,
    plansLoaded : false,
    _cloudClass : 'userDonation',

    init : function () {

        if (userDonation.initialized)
            return;

        userDonation.initialized = true;

        userDonation.planDS =  new kendo.data.DataSource({
            sync : function (e) {
                ghEvent.trigger(ghEvent.donationPlansLoaded);
                userDonation.plansLoaded = true;
            }
        });

       /* userDonation.userDonationDS =  new kendo.data.DataSource({
            sync : function (e) {
                ghEvent.trigger(ghEvent.userdonationLoaded);
                userDonation.userDonationsLoaded = true;
            }
        });*/

       userDonation.donationDS = new kendo.data.DataSource({
            type: 'everlive',
            transport: {
                typeName: 'userDonation',
                dataProvider: APP.everlive
            },
            schema: {
                model: { id:  Everlive.idField}
            }/*
           ,aggregate: [
               { field: "total", aggregate: "sum" },
               { field: "total", aggregate: "average" },
               { field: "total", aggregate: "min" },
               { field: "total", aggregate: "max" }
           ],*/

        });

        userDonation.donationDS.bind("change", function (e) {
            var donations = e.items;
            if (e.action === undefined && donations) {

                if (donations !== undefined && ! userDonation.donationsLoaded ) {
                    userDonation.donationsLoaded = true;
                    console.log("UserDonations: " + donations.length);
                    ghEvent.trigger(ghEvent.userdonationLoaded);
                }
            }
        });

     //   $(window).on(ghEvent.authChange, function() {
            if (userView.isActive())
                userDonation.fetch();
    //    });


        userDonation._loadStripePlans();

    },

    fetch : function () {
        userDonation.donationDS.fetch();
    },

    fetchUser : function () {

        var email = userModel.userObj.email;

        var filter = {
            'email': email
        };

        var donations = APP.everlive.data(userDonation._cloudClass);
        donations.get(filter)
            .then(function(data){
                    console.log("UserDonation: " + data.count);
                    userDonation.userDonationDS.data(data.result);
                },
                function(error){
                    ux.notify("UserDonations : " + JSON.stringify(error), 'error');
                });
    },

    _loadStripePlans: function () {
        var ledger = 'farm-forward';
        if (APP.siteSlug === 'bff') {
            ledger = 'bff';
        }
        var url = 'https://gaiaapi.herokuapp.com/stripeplans?ledger='+ledger;
        $.ajax({
            url: url,
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            success: function(result) {
                if (result.status === 'OK') {
                    console.log("DonationPlans: " + result.plans.data.length);
                    userDonation.planDS.data(result.plans.data);
                }

            },
            error: function (xhr,status,error) {

            }
        });
    },

    _createStripePlan : function (amount) {
        var ledger = 'farm-forward';
        if (APP.siteSlug === 'bff') {
            ledger = 'bff';
        }
        var url = 'https://gaiaapi.herokuapp.com/stripeplancreate?ledger='+ledger+'&amount='+amount;
        $.ajax({
            url: url,
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            success: function(plan) {
                if (plan.status === 'OK') {
                    userDonation.plansDS.add(plan.plan);
                } else {

                }

            },
            error: function (xhr,status,error) {

            }
        });
    },

    _createStripeSubscription : function (user, plan) {
        var ledger = 'farm-forward';
        if (APP.siteSlug === 'bff') {
            ledger = 'bff';
        }
        var url = 'https://gaiaapi.herokuapp.com/stripesubscribe?ledger='+ledger+'&user='+user+'&plan='+plan;
        $.ajax({
            url: url,
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            success: function(plan) {
                if (plan.status === 'OK') {
                    ux.notify("Thank You for your sustaining support!");
                } else {

                }

            },
            error: function (xhr,status,error) {

            }
        });
    },

    query: function (query) {
        if (query === undefined)
            return(undefined);
        var dataSource =  userDonation.donationDS;
        dataSource.filter( query);
        var view = dataSource.view();

        return(view);
    },

    queryPlan: function (query) {
        if (query === undefined)
            return(undefined);
        var dataSource =  userDonation.planDS;
        dataSource.filter( query);
        var view = dataSource.view();

        return(view);
    },

    findPlanByAmount: function (amount) {

        var amount = amount * 100;
        var plans = userDonation.queryPlan({field: "amount", operator: "eq", value: amount});

        if (plans.length === 0) {
            return(null);
        }
        return (plans[0]);
    },

    listByEmail : function (email) {

        var donations = userDonation.query({field: "email", operator: "eq", value: email});

        if (donations.length === 0) {
            return([]);
        }
        return (donations);
    },

    listByOrderNumber : function (ordNum) {

        var donations = userDonation.query({field: "orderNumber", operator: "eq", value: ordNum});

        if (donations.length === 0) {
            return(null);
        }
        return (donations);
    },

    findByUserId: function (id) {

        var donations = userDonation.query({field: "userId", operator: "eq", value: id});

        if (donations.length === 0) {
            return([]);
        }
        return (donations);
    },

    addDonation : function (donIn) {
        var donObj = {
            sourceId : 'stripe',
            userId : userModel.userObj.Id,
            email : userModel.userObj.email,
            state : userModel.userObj.state,
            address : null,
            orderNumber : donIn.transactionId,
            zipcode : donIn.zipcode,
            siteId : APP.siteSlug,
            total : donIn.amount,
            transactionId : donIn.transactionId,
            cardBrand: donIn.cardBrand,
            last4: donIn.last4,
            customer: donIn.customer,
            isRecurring: donIn.isRecurring,
            recurringId : donIn.recurringId,
            date : donIn.date,
            transactionDate : donIn.date

        };
        donObj.organizationId = 'farm-forward';
        if (APP.siteSlug === 'bff') {
            donObj.organizationId = 'bff';
        }

        donObj.campaignId = donObj.organizationId+ '-annual';


        userDonation.add(donObj);
    },

    addSubscription : function (donation) {
        var user = donation.customer, plan = donation.recurringId;

        userDonation._createStripePlan(user, plan);


    },

    add : function (donation) {
        everlive.createOne(userDonation._cloudClass, donation, function (err, data) {
            if (err !== null) {
                ux.notify("Couldn't add Donation " + JSON.stringify(err), 'error');
            } else {
                if (donation.isRecurring) {
                    userDonation.addSubscription(donation);
                }
            }

        });
    },

    update : function (donation) {
        everlive.updateOne(userDonation._cloudClass, donation, function (err, data) {

            if (err !== null) {
                ux.notify("Couldn't update Donation " + JSON.stringify(err), 'error');
            }
        });
    },

    remove : function (donation) {
        everlive.deleteOne(userDonation._cloudClass, donation, function (err, data) {

            if (err !== null) {
                ux.notify("Couldn't remove Donation " + JSON.stringify(err), 'error');
            }
        });
    }
};

/**
 * Created by donbrad on 1/1/17.
 */


'use strict';

var userFeedback = {

    feedbackDS : null,
    feedbackLoaded : false,
    _cloudClass : 'userfeedback',

    init : function () {


       userFeedback.feedbackDS = new kendo.data.DataSource({
            type: 'everlive',
            transport: {
                typeName: 'userfeedback',
                dataProvider: APP.everlive
            },
            schema: {
                model: { id:  Everlive.idField}
            },
            sort: { field: "reportDate", dir: "desc" },
            requestEnd: function(e) {
                var response = e.response;
                var type = e.type;
                if (e.type === "read" && e.response) {
                    console.log("userFeedback: " + response.count);

                }
            }
        });

        userFeedback.feedbackDS.bind("change", function (e) {
            var reports = e.items;
            if (e.action === undefined && blogs) {
                if (reports !== undefined && ! userFeedback.reportsLoaded ) {
                    userFeedback.reportsLoaded = true;
                }
            }
        });

        userFeedback.feedbackDS.fetch();

    },

    queryReports: function (query) {
        if (query === undefined)
            return(undefined);
        var dataSource =  userFeedback.reportDS;
        var cacheFilter = dataSource.filter();
        if (cacheFilter === undefined) {
            cacheFilter = {};
        }

        dataSource.filter( query);
        var view = dataSource.view();

        dataSource.filter(cacheFilter);

        return(view);
    },

    findReport : function (id) {

        var reports = userFeedback.queryReports({field: "Id", operator: "eq", value: id});

        if (reports.length === 0) {
            return(null);
        }
        return (reports[0]);
    },

    add : function (report) {
        everlive.createOne(userFeedback._cloudClass, report, function (err, data) {


        });
    }

};

/**
 * Created by donbrad on 3/3/17.
 */

'use strict';

var userModel = {

    userObj : new kendo.data.ObservableObject({
        Id: null,
        firstName : null,
        lastName : null,
        name : null,
        alias: null,
        gender : null,
        DisplayName: null,
        Identity : null,
        Role : null,
        roleName : null,
        IdentityProvider : null,
        socialId : null,
        Username : null,
        Email: null,
        email: null,
        contactEmail : null,
        responseEmail : null,
        primaryDiet: [],
        dietRestrictions: [],
        avoidFoods: [],
        favoriteFoods: [],
        favoriteCuisines: [],
        diningList: [],
        mcLists : [],
        mcCampaigns : [],
        mcGroups: [],
        zipcode : null,
        address : null,
        state: null,
        phone: null,
        welcomeSent: false,
        mobilephone : null,
        photoUrl : 'images/default-profile.png',
        slug: null,
        stripeId: null,
        twitterId : null,
        facebookId: null,
        skypeId : null,
        hangoutId : null

    }),

    userLoaded : false,
    userRecord : null,
    isTracking : true,
    _staff: '92090850-5222-11e6-b59b-f349346a75ee',
    _blogger : '99781bd0-5222-11e6-ba1a-9b5d7b79288c',
    _team : 'a9da3930-fae3-11e6-bad8-17279fbdb6c0',
    _registered : '26018a50-511f-11e6-8f5c-53009c3df0d7',
    _unknown : 'af5d0cd0-8da5-11e6-9aa3-a1bf81a06d1d',
    _defaultProfilePhoto : 'images/default-profile.png',


    init: function () {
        userModel.userObj.bind("change", function(e) {
            var field = e.field;
            if (userModel.isTracking) {
                var obj = {
                    Id: userModel.userObj.Id
                };
                obj[field] = userModel.userObj[field];
                if (field === 'email') {
                    userModel.processEmail();
                }
                APP.everlive.Users.updateSingle(obj,
                    function(data){
                        //userView.updateUserInfo();
                        // ux.notify("Your profile was updated.", "success");
                        //analyticsModel.sendGAEvent("profile", "update", "PII");
                    },
                    function(error){
                        ux.notify("Error saving your profile: " + JSON.stringify(error) , "error");
                        // analyticsModel.sendGAEvent("user", "error", JSON.stringify(error));
                    });

            }

        });
    },


    isFBSignedIn : function () {
        FB.getLoginStatus(function(response) {
            if (response.status === 'connected') {
                return (true);
            }
            else {
                return (false);
            }
        });
    },

    linkedInSuccess : function (data) {
        var name = data.formattedName;
        var email = data.emailAddress;
        var id = data.id;
        var location = data.location.name;
        var photoUrl = data.pictureUrl;
        var industry = data.industry;

        
    },


    processEmail : function () {

    },


    linkedInError : function (error) {

        ux.notify("Linked In SignIn error " + JSON.stringify(error), 'error');

    },

    enableTracking : function (flag) {
        userModel.isTracking = flag;
    },

    setUser : function (userData) {

        userModel.userRecord  = userData; // Cache a copy of the data fetched from everlive

        if (userData === null) {
            return;
        }

        var user = userModel.userObj;

        userModel.enableTracking(false);  // Turn tracking off while we initialize

        user.set("Id", userData.Id);
        user.set("firstName", ux.validString(userData.firstName));
        user.set("lastName",  ux.validString(userData.lastName));
        if (userData.name === undefined || userData.name === null || userData.name === '' ) {
            userData.name = userData.DisplayName;
        }
        user.set("name",  ux.validString(userData.name));
        user.set("firstName",  ux.validString(userData.firstName));
        user.set("lastName",  ux.validString(userData.lastName));
        user.set("alias",  ux.validString(userData.alias));
        user.set("gender",  ux.validString(userData.gender));
        user.set("DisplayName",  ux.validString(userData.DisplayName));
        user.set("Identity",  ux.validObject(userData.Identity));
        user.set("Role",  ux.validString(userData.Role));
        var roleName = userModel.mapRoleName(userData.Role);
        user.set("roleName",  roleName);
        user.set("IdentityProvider",  ux.validString(userData.IdentityProvider));
        user.set("socialId",  ux.validString(userData.socialId));
        user.set("Username",  ux.validString(userData.Username));
        user.set("Email",  ux.validString(userData.Email));
        user.set("email",  ux.validString(userData.email));
        if (ux.validateEmail(user.Email) && !ux.validateEmail(user.email)){
            user.set("email", user.Email);
        }
        user.set("welcomeSent",  ux.validBoolean(userData.welcomeSent));
        user.set("isGaiaHacker",  ux.validBoolean(userData.isGaiaHacker));
        user.set("contactEmail",  ux.validString(userData.contactEmail));
        user.set("responseEmail",  ux.validString(userData.responseEmail));
        user.set("primaryDiet",  ux.validString(userData.primaryDiet));
        user.set("dietRestrictions",  ux.validArray(userData.dietRestrictions));
        user.set("avoidFoods", ux.validArray(userData.avoidFoods));
        user.set("favoriteFoods", ux.validArray(userData.favoriteFoods));
        user.set("favoriteCuisines", ux.validArray(userData.favoriteCuisines));
        user.set("diningList", ux.validArray(userData.diningList));
        user.set("mcLists", ux.validArray(userData.mcLists));
        user.set("mcGroups", ux.validArray(userData.mcGroups));
        user.set("mcCampaigns", ux.validArray(userData.mcCampaigns));
        user.set("mcId", ux.validString(userData.mcId));
        user.set("proteinList", ux.validArray(userData.proteinList));
        user.set("zipcode", ux.validString(userData.zipcode));
        user.set("address", ux.validString(userData.address));
        user.set("state", ux.validString(userData.state));
        user.set("country", ux.validString(userData.country));
        user.set("county", ux.validString(userData.county));
        user.set("phone", ux.validString(userData.phone));
        user.set("membershipList", ux.validArray(userData.membershipList));
        user.set("campaignList", ux.validArray(userData.campaignList));
        user.set("petitionList", ux.validArray(userData.petitionList));
        user.set("pledgeList", ux.validArray(userData.pledgeList));

        user.set("organizationName", ux.validString(userData.organizationName));
        user.set("organizationType", ux.validString(userData.organizationType));
        user.set("organizationRole", ux.validString(userData.organizationRole));
        user.set("mobilephone", ux.validString(userData.mobilephone));
        user.set("donationTotal",  ux.validNumber(userData.donationTotal));
        user.set("donationSync", ux.validDate(userData.donationSync));
        user.set("lat", ux.validNumber(userData.lat));
        user.set("lng", ux.validNumber(userData.lng));


        if (userData.photoUrl === null) {
            userData.photoUrl = 'images/default-profile.png';
        }
        user.set("photoUrl", userData.photoUrl);
        user.set("slug", ux.validString(userData.slug));
        user.set("stripeId", ux.validString(userData.stripeId));
        if (userData.accountOwner === undefined || userData.accountOwner === null) {
            userData.accountOwner = APP.siteName;
        }
        if (userData.accountOwnerUrl === undefined || userData.accountOwnerUrl === null) {
            userData.accountOwnerUrl = APP.siteUrl;
        }
        user.set("accountOwner", ux.validString(userData.accountOwner));
        user.set("accountOwnerUrl", ux.validString(userData.accountOwnerUrl));
        user.set("twitterId", ux.validString(userData.twitterId));
        user.set("facebookId", ux.validString(userData.facebookId));
        user.set("skypeId", ux.validString(userData.skypeId));
        user.set("hangoutId", ux.validString(userData.hangoutId));
        user.set("linkedinId", ux.validString(userData.linkedinId));

        userModel.enableTracking(true);  // Enable change tracking (and save to cloud)

        userModel.userLoaded = true;
        ghEvent.trigger(ghEvent.userLoaded);
    },

    mapRoleName : function (role) {
        var roleName = "Unknown";
        switch (role) {
            case userModel._unknown:
                roleName = "Unknown";
                break;
            case userModel._registered:
                roleName = "User";
                break;
            case userModel._staff:
                roleName = "Staff";
                break;
            case userModel._blogger:
                roleName = "Blogger";
                break;
            case userModel._team:
                roleName = "FF Team";
                break;
        }

        return (roleName);
    },

    update: function () {

        var user = userModel.userObj;
        /*var current = userView.currentUser;

        var keys = Object.keys(user);

        for (var i=0; i<keys.length; i++) {
            var key = keys[i];

            if (key !== "_events" && key !== "_handlers"  && key !== 'Id' && key !== 'uid' && key !== 'UserName' &&
                key !== "Email" && key !== "IsVerfied" && key !== 'Identity' && key !== 'IdentityProvider') {
                if (user[key] !== current[key]) {
                    current[key] =  user[key];
                }
            }
        }

        // Force everlive Email to current value if not set.
       /!* if (current.Email === null && ux.validateEmail(user.email)) {
            current.Email = user.email;
        }*!/*/

        APP.everlive.Users.updateSingle(user,
            function(data){
                //userView.updateUserInfo();
               // ux.notify("Your profile was updated.", "success");
                //analyticsModel.sendGAEvent("profile", "update", "PII");
            },
            function(error){
                ux.notify("Error saving your profile: " + JSON.stringify(error) , "error");
               // analyticsModel.sendGAEvent("user", "error", JSON.stringify(error));
            });

    }

};
/**
 * Created by donbrad on 1/1/17.
 */

'use strict';

var userNewsletter = {

    newsletterDS : null,
    newslettersLoaded : false,
    _cloudClass : 'userNewsletter',

    init : function () {

       userNewsletter.newsletterDS = new kendo.data.DataSource({
            type: 'everlive',
            transport: {
                typeName: 'userNewsletter',
                dataProvider: APP.everlive
            },
            schema: {
                model: { id:  Everlive.idField}
            },
            requestEnd: function(e) {
                var response = e.response;
                var type = e.type;
                if (e.type === "read" && e.response) {
                    console.log("userNewsletters: " + response.count);
                }
            }
        });

        userNewsletter.newsletterDS.bind("change", function (e) {
            var newsletters = e.items;
            if (e.action === undefined && newsletters) {
                if (newsletters !== undefined && ! userNewsletter.newslettersLoaded ) {
                    userNewsletter.newslettersLoaded = true;
                }
            }
        });

        $(window).on(ghEvent.userLoaded, function () {
           userNewsletter.fetchUser(userModel.userObj.Id);
        });


    },

    fetch : function () {
        userNewsletter.newsletterDS.fetch();
    },

    fetchUser : function (userId) {
        var filter = {
            'userId': userId
        };

        var newsletters = APP.everlive.data(userNewsletter._cloudClass);
        newsletters.get(filter)
            .then(function(data){
                    userNewsletter.newsletterDS.data(data);
                },
                function(error){
                    ux.notify("newsletters : " + JSON.stringify(error), 'error');
                });
    },

    query: function (query) {
        if (query === undefined)
            return(undefined);
        var dataSource =  userNewsletter.newsletterDS;
        dataSource.filter( query);
        var view = dataSource.view();

        return(view);
    },

    listByUserId : function (userId) {

        var newsletters = userNewsletter.query({field: "userId", operator: "eq", value: userId});

        if (newsletters.length === 0) {
            return([]);
        }
        return (newsletters);
    },
    
    listBySiteSlug : function (siteSlug) {

        var newsletters = userNewsletter.query({field: "siteSlug", operator: "eq", value: siteSlug});

        if (newsletters.length === 0) {
            return(null);
        }
        return (newsletters);
    },

    findByNewsletterId: function (id) {

        var newsletters = userNewsletter.query({field: "newsletterId", operator: "eq", value: id});

        if (newsletters.length === 0) {
            return([]);
        }
        return (newsletters);
    },

    findBySlug: function (slug) {

        var newsletters = userNewsletter.query({field: "slug", operator: "eq", value: slug});

        if (newsletters.length === 0) {
            return(null);
        }
        return (null);
    },

    add : function (newsletter) {
        everlive.createOne(userNewsletter._cloudClass, newsletter, function (err, data) {


        });
    },

    update : function (newsletter) {
        everlive.updateOne(userNewsletter._cloudClass, newsletter, function (err, data) {


        });
    },

    remove : function (newsletter) {
        everlive.deleteOne(userNewsletter._cloudClass, newsletter, function (err, data) {


        });
    }
};

/**
 * Created by donbrad on 1/1/17.
 */


'use strict';

var userPledge = {

    initialized : false,
    pledgeDS : null,
    userPledgeDS : null,
    pledgesLoaded : false,
    userPledgesLoaded : false,
    _cloudClass : 'userPledge',

    init : function () {
/*

        userPledge.userPledgeDS =  new kendo.data.DataSource({
            sync : function (e) {
                ghEvent.trigger(ghEvent.userpledgeLoaded);
            }
        });
*/

        if (userPledge.initialized)
            return;

        userPledge.initialized = true;

        userPledge.pledgeDS = new kendo.data.DataSource({
            type: 'everlive',
            transport: {
                typeName: 'userPledge',
                dataProvider: APP.everlive
            },
            schema: {
                model: { id:  Everlive.idField}
            }
        });

        userPledge.pledgeDS.bind("change", function (e) {
            var pledges = e.items;
            if (e.action === undefined && pledges) {

                if (pledges !== undefined && ! userPledge.pledgesLoaded ) {
                    console.log("UserPledges: " + pledges.length);
                    userPledge.pledgesLoaded = true;
                    userPledge.userPledgesLoaded = true;
                    ghEvent.trigger(ghEvent.userpledgeLoaded);
                }

            }
        });



        userPledge.fetch();


    },

    fetch : function () {
        userPledge.pledgeDS.fetch();
    },

    fetchUser : function () {

        var userId = userModel.userObj.Id;

        var filter = {
            'userId': userId
        };

        var pledges = APP.everlive.data(userPledge._cloudClass);
        pledges.get(filter)
            .then(function(data){

                    userPledge.userPledgeDS.data(data.result);
                    var total = userPledge.userPledgeDS.total();
                    console.log("UserPledge: " + total);
                    ghEvent.trigger(ghEvent.userpledgeLoaded);

                },
                function(error){
                    ux.notify("UserPledges : " + JSON.stringify(error), 'error');
                });
    },


    query: function (query) {
        if (query === undefined)
            return(undefined);
        var dataSource =  userPledge.pledgeDS;
        dataSource.filter( query);
        var view = dataSource.view();

        return(view);
    },


    queryUser: function (query) {
        if (query === undefined)
            return(undefined);
        var dataSource =  userPledge.userPledgeDS;
        dataSource.filter( query);
        var view = dataSource.view();

        return(view);
    },

    listByUserId : function (userId) {

        var pledges = userPledge.query({field: "userId", operator: "eq", value: userId});

        if (pledges.length === 0) {
            return([]);
        }
        return (pledges);
    },
    
    listBySiteSlug : function (siteSlug) {

        var pledges = userPledge.query({field: "siteSlug", operator: "eq", value: siteSlug});

        if (pledges.length === 0) {
            return(null);
        }
        return (pledges);
    },

    findByPledgeId: function (id) {

        var pledges = userPledge.query({field: "slug", operator: "eq", value: id});

        if (pledges.length === 0) {
            return([]);
        }
        return (pledges);
    },

    findUserPledgeById: function (id) {

        var pledges = userPledge.queryUser({field: "pledgeId", operator: "eq", value: id});

        if (pledges.length === 0) {
            return([]);
        }
        return (pledges);
    },

    findUserPledgeBySlug: function (slug) {

        var pledges = userPledge.queryUser({field: "slug", operator: "eq", value: slug});

        if (pledges.length === 0) {
            return(null);
        }
        return (pledges[0]);
    },

    findBySlug: function (slug) {

        var pledges = userPledge.query({field: "slug", operator: "eq", value: slug});

        if (pledges.length === 0) {
            return(null);
        }
        return (pledges[0]);
    },

    addPledge : function (pledgeObj) {
        var guid = uuid.v4();
        var pledgeDate = moment().toISOString();
        var userObj = {
            Id : guid,
            userId :  userModel.userObj.Id,
            siteName : APP.siteName,
            siteSlug : APP.siteSlug,
            pledgeTitle : pledgeObj.title,
            pledgeId : pledgeObj.pledgeId,
            slug: pledgeObj.slug,
            pledgeDate : pledgeDate,
            campaignId : ux.validString(pledgeObj.campaignId)
        };

         var groups = pledgeObj.mcGroups;

        userPledge.add(userObj);

    },


    add : function (pledge) {
        everlive.createOne(userPledge._cloudClass, pledge, function (err, data) {

           // ghEvent.trigger(ghEvent.userpledgeLoaded);
            if (err !== null) {
                ux.notify("Couldn't add Pledge " + JSON.stringify(err), 'error');
            }
        });
    },

    update : function (pledge) {
        everlive.updateOne(userPledge._cloudClass, pledge, function (err, data) {

            if (err !== null) {
                ux.notify("Couldn't update Pledge " + JSON.stringify(err), 'error');
            }
        });
    },

    remove : function (pledge) {
        everlive.deleteOne(userPledge._cloudClass, pledge, function (err, data) {
            //ghEvent.trigger(ghEvent.userpledgeLoaded);
            if (err !== null) {
                ux.notify("Couldn't remove Pledge " + JSON.stringify(err), 'error');
            }

        });
    }
};

/**
 * Created by donbrad on 1/1/17.
 */


'use strict';

var userRecurring = {

    userRecurringDS : null,
    donationDS : null,
    donationsLoaded : false,
    _cloudClass : 'userRecurring',

    init : function () {

        userRecurring.userRecurringDS =  new kendo.data.DataSource({
            sync : function (e) {
                ghEvent.trigger(ghEvent.userRecurringLoaded);
            }
        });
       userRecurring.donationDS = new kendo.data.DataSource({
            type: 'everlive',
            transport: {
                typeName: 'userRecurring',
                dataProvider: APP.everlive
            },
            schema: {
                model: { id:  Everlive.idField}
            },/*
           aggregate: [
               { field: "total", aggregate: "sum" },
               { field: "total", aggregate: "average" },
               { field: "total", aggregate: "min" },
               { field: "total", aggregate: "max" }
           ],*/
            requestEnd: function(e) {
                var response = e.response;
                var type = e.type;
                if (e.type === "read" && e.response) {
                    console.log("userRecurrings: " + response.count);
                }
            }
        });

        userRecurring.donationDS.bind("change", function (e) {
            var donations = e.items;
            if (e.action === undefined && donations) {

                if (donations !== undefined && ! userRecurring.donationsLoaded ) {
                    userRecurring.donationsLoaded = true;
                }
            }
        });

       // userRecurring.donationDS.fetch();



    },

    fetch : function () {
        userRecurring.donationDS.fetch();
    },

    fetchUser : function () {

        var email = userModel.userObj.email;

        var filter = {
            'email': email
        };

        var donations = APP.everlive.data(userRecurring._cloudClass);
        donations.get(filter)
            .then(function(data){
                    console.log("userRecurring: " + data.count);
                    userRecurring.userRecurringDS.data(data.result);
                },
                function(error){
                    ux.notify("userRecurrings : " + JSON.stringify(error), 'error');
                });
    },


    query: function (query) {
        if (query === undefined)
            return(undefined);
        var dataSource =  userRecurring.donationDS;
        dataSource.filter( query);
        var view = dataSource.view();

        return(view);
    },

    listByEmail : function (email) {

        var donations = userRecurring.query({field: "email", operator: "eq", value: email});

        if (donations.length === 0) {
            return([]);
        }
        return (donations);
    },

    listByOrderNumber : function (ordNum) {

        var donations = userRecurring.query({field: "orderNumber", operator: "eq", value: ordNum});

        if (donations.length === 0) {
            return(null);
        }
        return (donations);
    },

    findByUserId: function (id) {

        var donations = userRecurring.query({field: "userId", operator: "eq", value: id});

        if (donations.length === 0) {
            return([]);
        }
        return (donations);
    },

    addDonation : function (donIn) {
        var donObj = {
            sourceId : 'stripe',
            userId : userModel.userObj.Id,
            email : userModel.userObj.email,
            state : userModel.userObj.state,
            address : null,
            orderNumber : donIn.transactionId,
            zipcode : donIn.zipcode,
            siteId : APP.siteSlug,
            total : donIn.amount,
            transactionId : donIn.transactionId,
            cardBrand: donIn.cardBrand,
            last4: donIn.last4,
            customer: donIn.customer,
            isRecurring: donIn.isRecurring,
            recurringId : donIn.recurringId,
            date : donIn.date,
            transactionDate : donIn.date

        };
        donObj.organizationId = 'farm-forward';
        if (APP.siteSlug === 'bff') {
            donObj.organizationId = 'bff';
        }

        donObj.campaignId = donObj.organizationId+ '-annual';

        userRecurring.add(donObj);
    },

    add : function (donation) {
        everlive.createOne(userRecurring._cloudClass, donation, function (err, data) {
            if (err !== null) {
                ux.notify("Couldn't add Donation " + JSON.stringify(err), 'error');
            }

        });
    },

    update : function (donation) {
        everlive.updateOne(userRecurring._cloudClass, donation, function (err, data) {

            if (err !== null) {
                ux.notify("Couldn't update Donation " + JSON.stringify(err), 'error');
            }
        });
    },

    remove : function (donation) {
        everlive.deleteOne(userRecurring._cloudClass, donation, function (err, data) {

            if (err !== null) {
                ux.notify("Couldn't remove Donation " + JSON.stringify(err), 'error');
            }
        });
    }
};

/**
 * Created by donbrad on 1/1/17.
 */


'use strict';

var userReport = {

    reportDS : null,
    reportsLoaded : false,
    _cloudClass : 'userreport',

    init : function () {


       userReport.reportDS = new kendo.data.DataSource({
            type: 'everlive',
            transport: {
                typeName: 'userreport',
                dataProvider: APP.everlive
            },
            schema: {
                model: { id:  Everlive.idField}
            },
            sort: { field: "reportDate", dir: "desc" },
            requestEnd: function(e) {
                var response = e.response;
                var type = e.type;
                if (e.type === "read" && e.response) {
                    console.log("userReports: " + response.count);

                }
            }
        });

        userReport.reportDS.bind("change", function (e) {
            var reports = e.items;
            if (e.action === undefined && blogs) {
                if (reports !== undefined && ! userReport.reportsLoaded ) {
                    userReport.reportsLoaded = true;
                }
            }
        });

        userReport.reportDS.fetch();

    },

    queryReports: function (query) {
        if (query === undefined)
            return(undefined);
        var dataSource =  userReport.reportDS;
        var cacheFilter = dataSource.filter();
        if (cacheFilter === undefined) {
            cacheFilter = {};
        }

        dataSource.filter( query);
        var view = dataSource.view();

        dataSource.filter(cacheFilter);

        return(view);
    },

    findReport : function (id) {

        var reports = userReport.queryReports({field: "Id", operator: "eq", value: id});

        if (reports.length === 0) {
            return(null);
        }
        return (reports[0]);
    },

    add : function (report) {
        everlive.createOne(userReport._cloudClass, report, function (err, data) {


        });
    }

};

/**
 * Created by donbrad on 1/1/17.
 */


'use strict';

var userTransaction = {

    transactionDS : null,
    transactionsLoaded : false,
    _cloudClass : 'userTransaction',

    init : function () {

       userTransaction.transactionDS = new kendo.data.DataSource({
            type: 'everlive',
            transport: {
                typeName: userTransaction._cloudClass,
                dataProvider: APP.everlive
            },
            schema: {
                model: { id:  Everlive.idField}
            },
            requestEnd: function(e) {
                var response = e.response;
                var type = e.type;
                if (e.type === "read" && e.response) {
                    console.log("userTransactions: " + response.count);
                }
            }
        });

        userTransaction.transactionDS.bind("change", function (e) {
            var transactions = e.items;
            if (e.action === undefined && transactions) {
                if (transactions !== undefined && ! userTransaction.transactionsLoaded ) {
                    userTransaction.transactionsLoaded = true;
                }
            }
        });

        userTransaction.transactionDS.fetch();

    },

    query: function (query) {
        if (query === undefined)
            return(undefined);
        var dataSource =  userTransaction.transactionDS;
        dataSource.filter( query);
        var view = dataSource.view();

        return(view);
    },

    listByEmail : function (email) {

        var reports = userTransaction.query({field: "email", operator: "eq", value: email});

        if (reports.length === 0) {
            return(null);
        }
        return (reports);
    },

    listByOrderNumber : function (ordNum) {

        var reports = userTransaction.query({field: "orderNumber", operator: "eq", value: ordNum});

        if (reports.length === 0) {
            return(null);
        }
        return (reports);
    },

    findById: function (id) {

        var reports = userTransaction.query({field: "Id", operator: "eq", value: id});

        if (reports.length === 0) {
            return(null);
        }
        return (reports[0]);
    },

    addTransaction : function (transIn) {
        var transObj = {
            userId : userModel.userObj.Id,
            isRecurring : false,
            recurringId : null,
            email : userModel.userObj.email,
            siteId : APP.siteSlug,
            amount : transIn.amount,
            transactionId : transIn.transactionId,
            cardBrand: transIn.cardBrand,
            last4: transIn.last4,
            customer: transIn.customer,
            networkStatus: transIn.networkStatus,
            riskLevel: transIn.riskLevel,
            sellerMessage: transIn.sellerMessage,
            date : transIn.date

        };

        userTransaction.add(transObj);
    },

    add : function (transaction) {
        everlive.createOne(userTransaction._cloudClass, transaction, function (err, data) {
            if (err !== null) {
                ux.notify("Couldn't add Transaction " + JSON.stringify(err), 'error');
            }

        });
    },

    update : function (transaction) {
        everlive.updateOne(userTransaction._cloudClass, transaction, function (err, data) {
            if (err !== null) {
                ux.notify("Couldn't update Transaction " + JSON.stringify(err), 'error');
            }

        });
    },

    remove : function (transation) {
        everlive.deleteOne(userTransaction._cloudClass, transaction, function (err, data) {

            if (err !== null) {
                ux.notify("Couldn't remove Transaction " + JSON.stringify(err), 'error');
            }
        });
    }
};

/**
 * Application Settings
 */

var appSettings = {

    everlive: {
        appId: 'eiautrwppy9qoh5i',
        scheme: 'https'
    },

    facebook: {
        appId: '1769550126625987', // Put your Facebook App ID here
        redirectUri: 'https://www.facebook.com/connect/login_success.html' // Put your Facebook Redirect URI here
    },

    google: {
        clientId: '779328780647-hl7urdpp73svoi7dlf3fs1brk15jm22v.apps.googleusercontent.com', // Put your Google Client ID here
        redirectUri: 'https://bpproto.herokuapp.com/oauth/google/' // Put your Google Redirect URI here
    },

    liveId: {
        clientId: '00000000481CD5A2', // Put your LiveID Client ID here
        redirectUri: 'https://bpproto.herokuapp.com/oauth/liveid/' // Put your LiveID Redirect URI here
    },

    messages: {
        removeActivityConfirm: 'Are you sure you want to delete this Activity?'
    }
};

//     uuid.js
//
//     Copyright (c) 2010-2012 Robert Kieffer
//     MIT License - http://opensource.org/licenses/mit-license.php

(function() {
  var _global = this;

  // Unique ID creation requires a high quality random # generator.  We feature
  // detect to determine the best RNG source, normalizing to a function that
  // returns 128-bits of randomness, since that's what's usually required
  var _rng;

  // Allow for MSIE11 msCrypto
  var _crypto = _global.crypto || _global.msCrypto;

  // Node.js crypto-based RNG - http://nodejs.org/docs/v0.6.2/api/crypto.html
  //
  // Moderately fast, high quality
  if (typeof(_global.require) == 'function') {
    try {
      var _rb = _global.require('crypto').randomBytes;
      _rng = _rb && function() {return _rb(16);};
    } catch(e) {}
  }

  if (!_rng && _crypto && _crypto.getRandomValues) {
    // WHATWG crypto-based RNG - http://wiki.whatwg.org/wiki/Crypto
    //
    // Moderately fast, high quality
    var _rnds8 = new Uint8Array(16);
    _rng = function whatwgRNG() {
      _crypto.getRandomValues(_rnds8);
      return _rnds8;
    };
  }

  if (!_rng) {
    // Math.random()-based (RNG)
    //
    // If all else fails, use Math.random().  It's fast, but is of unspecified
    // quality.
    var  _rnds = new Array(16);
    _rng = function() {
      for (var i = 0, r; i < 16; i++) {
        if ((i & 0x03) === 0) r = Math.random() * 0x100000000;
        _rnds[i] = r >>> ((i & 0x03) << 3) & 0xff;
      }

      return _rnds;
    };
  }

  // Buffer class to use
  var BufferClass = typeof(_global.Buffer) == 'function' ? _global.Buffer : Array;

  // Maps for number <-> hex string conversion
  var _byteToHex = [];
  var _hexToByte = {};
  for (var i = 0; i < 256; i++) {
    _byteToHex[i] = (i + 0x100).toString(16).substr(1);
    _hexToByte[_byteToHex[i]] = i;
  }

  // **`parse()` - Parse a UUID into it's component bytes**
  function parse(s, buf, offset) {
    var i = (buf && offset) || 0, ii = 0;

    buf = buf || [];
    s.toLowerCase().replace(/[0-9a-f]{2}/g, function(oct) {
      if (ii < 16) { // Don't overflow!
        buf[i + ii++] = _hexToByte[oct];
      }
    });

    // Zero out remaining bytes if string was short
    while (ii < 16) {
      buf[i + ii++] = 0;
    }

    return buf;
  }

  // **`unparse()` - Convert UUID byte array (ala parse()) into a string**
  function unparse(buf, offset) {
    var i = offset || 0, bth = _byteToHex;
    return  bth[buf[i++]] + bth[buf[i++]] +
            bth[buf[i++]] + bth[buf[i++]] + '-' +
            bth[buf[i++]] + bth[buf[i++]] + '-' +
            bth[buf[i++]] + bth[buf[i++]] + '-' +
            bth[buf[i++]] + bth[buf[i++]] + '-' +
            bth[buf[i++]] + bth[buf[i++]] +
            bth[buf[i++]] + bth[buf[i++]] +
            bth[buf[i++]] + bth[buf[i++]];
  }

  // **`v1()` - Generate time-based UUID**
  //
  // Inspired by https://github.com/LiosK/UUID.js
  // and http://docs.python.org/library/uuid.html

  // random #'s we need to init node and clockseq
  var _seedBytes = _rng();

  // Per 4.5, create and 48-bit node id, (47 random bits + multicast bit = 1)
  var _nodeId = [
    _seedBytes[0] | 0x01,
    _seedBytes[1], _seedBytes[2], _seedBytes[3], _seedBytes[4], _seedBytes[5]
  ];

  // Per 4.2.2, randomize (14 bit) clockseq
  var _clockseq = (_seedBytes[6] << 8 | _seedBytes[7]) & 0x3fff;

  // Previous uuid creation time
  var _lastMSecs = 0, _lastNSecs = 0;

  // See https://github.com/broofa/node-uuid for API details
  function v1(options, buf, offset) {
    var i = buf && offset || 0;
    var b = buf || [];

    options = options || {};

    var clockseq = options.clockseq != null ? options.clockseq : _clockseq;

    // UUID timestamps are 100 nano-second units since the Gregorian epoch,
    // (1582-10-15 00:00).  JSNumbers aren't precise enough for this, so
    // time is handled internally as 'msecs' (integer milliseconds) and 'nsecs'
    // (100-nanoseconds offset from msecs) since unix epoch, 1970-01-01 00:00.
    var msecs = options.msecs != null ? options.msecs : new Date().getTime();

    // Per 4.2.1.2, use count of uuid's generated during the current clock
    // cycle to simulate higher resolution clock
    var nsecs = options.nsecs != null ? options.nsecs : _lastNSecs + 1;

    // Time since last uuid creation (in msecs)
    var dt = (msecs - _lastMSecs) + (nsecs - _lastNSecs)/10000;

    // Per 4.2.1.2, Bump clockseq on clock regression
    if (dt < 0 && options.clockseq == null) {
      clockseq = clockseq + 1 & 0x3fff;
    }

    // Reset nsecs if clock regresses (new clockseq) or we've moved onto a new
    // time interval
    if ((dt < 0 || msecs > _lastMSecs) && options.nsecs == null) {
      nsecs = 0;
    }

    // Per 4.2.1.2 Throw error if too many uuids are requested
    if (nsecs >= 10000) {
      throw new Error('uuid.v1(): Can\'t create more than 10M uuids/sec');
    }

    _lastMSecs = msecs;
    _lastNSecs = nsecs;
    _clockseq = clockseq;

    // Per 4.1.4 - Convert from unix epoch to Gregorian epoch
    msecs += 12219292800000;

    // `time_low`
    var tl = ((msecs & 0xfffffff) * 10000 + nsecs) % 0x100000000;
    b[i++] = tl >>> 24 & 0xff;
    b[i++] = tl >>> 16 & 0xff;
    b[i++] = tl >>> 8 & 0xff;
    b[i++] = tl & 0xff;

    // `time_mid`
    var tmh = (msecs / 0x100000000 * 10000) & 0xfffffff;
    b[i++] = tmh >>> 8 & 0xff;
    b[i++] = tmh & 0xff;

    // `time_high_and_version`
    b[i++] = tmh >>> 24 & 0xf | 0x10; // include version
    b[i++] = tmh >>> 16 & 0xff;

    // `clock_seq_hi_and_reserved` (Per 4.2.2 - include variant)
    b[i++] = clockseq >>> 8 | 0x80;

    // `clock_seq_low`
    b[i++] = clockseq & 0xff;

    // `node`
    var node = options.node || _nodeId;
    for (var n = 0; n < 6; n++) {
      b[i + n] = node[n];
    }

    return buf ? buf : unparse(b);
  }

  // **`v4()` - Generate random UUID**

  // See https://github.com/broofa/node-uuid for API details
  function v4(options, buf, offset) {
    // Deprecated - 'format' argument, as supported in v1.2
    var i = buf && offset || 0;

    if (typeof(options) == 'string') {
      buf = options == 'binary' ? new BufferClass(16) : null;
      options = null;
    }
    options = options || {};

    var rnds = options.random || (options.rng || _rng)();

    // Per 4.4, set bits for version and `clock_seq_hi_and_reserved`
    rnds[6] = (rnds[6] & 0x0f) | 0x40;
    rnds[8] = (rnds[8] & 0x3f) | 0x80;

    // Copy bytes to buffer, if provided
    if (buf) {
      for (var ii = 0; ii < 16; ii++) {
        buf[i + ii] = rnds[ii];
      }
    }

    return buf || unparse(rnds);
  }

  // Export public API
  var uuid = v4;
  uuid.v1 = v1;
  uuid.v4 = v4;
  uuid.parse = parse;
  uuid.unparse = unparse;
  uuid.BufferClass = BufferClass;

  if (typeof(module) != 'undefined' && module.exports) {
    // Publish as node.js module
    module.exports = uuid;
  } else  if (typeof define === 'function' && define.amd) {
    // Publish as AMD module
    define(function() {return uuid;});
 

  } else {
    // Publish as global (in browsers)
    var _previousRoot = _global.uuid;

    // **`noConflict()` - (browser only) to reset global 'uuid' var**
    uuid.noConflict = function() {
      _global.uuid = _previousRoot;
      return uuid;
    };

    _global.uuid = uuid;
  }
}).call(this);
/* Platform UX Code */

'use strict';

var ux = {
    confirmAction: null,
    currentView: null,
    isLoading: false,
    hasLoaded: false,
    browserInfo: kendo.support,
    devMode: false,
    _init: false,
    init: function(){
        if(!ux._init){
            ux._init = true;

            var windowWidth = window.innerWidth;
            if(windowWidth > 767){
                $.notifyDefaults({
                    type: 'success',
                    allow_dismiss: false,
                    offset: 72,
                    position: "absolute",
                    placement: {
                        from: "top",
                        align: "right"
                    }
                });
            } else {
                $.notifyDefaults({
                    type: 'success',
                    allow_dismiss: false,
                    position: "absolute",
                    offset: {
                        x: 16,
                        y: 87
                    },
                    placement: {
                        from: "top",
                        align: "left"
                    }
                });
            }
            ghBannerBar.init();
            //$("#layout-nav").scrollupbar();
        }

    },



    notify: function(alertString, alertType){
        var alertStyle = '';
        switch(alertType){
            case 'success':
                alertStyle = 'success';
                break;
            case 'delete':
                alertStyle = 'danger';
                break;
            case 'error':
                alertStyle = 'danger';
                break;
            default:
                alertStyle = 'success';

        }
        var modalOpen = $(".modal").hasClass("in"); 
        // if modal is open show on  modal 
        if(modalOpen){ 
            var alertDiv = "<div class='gh-modal-alert alert alert-" + alertStyle + "'><button type='button' class='close' data-dismiss='alert' aria-label='Close'><span aria-hidden='true'>&times;</span></button>" + alertString + "</div>"; 
            var modalId = $('.modal.in').attr('id'); 
            $(".gh-modal-alert").remove(); 
            $(alertDiv).prependTo("#" + modalId + " > .modal-dialog > .modal-content > .modal-body"); 
            $(".gh-modal-alert").velocity("slideDown").velocity("fadeOut", {delay: 5000}); 

            $("#" + modalId).off().on("hide.bs.modal", function(e){ 
                $(".gh-modal-alert").remove();  
            })
         } else { 
            // normal notify 
             $.notify({ 
                     //icon: 'glyphicon glyphicon-star', 
                     //title: "", 
                     message: alertString 
                     },
                 { 
                     type: alertStyle 
                 });
         }

    },

    loadGhPlatformMenu: function(site){
        templateLoader.load('../../../templates/platform-header-tmpl.html', function(status) {
            if(status){
                var platformHeader = kendo.template($("#platformHeader").html());
                $("#gh-platform-header").html(platformHeader);

                // Name of current site
                if(site !== undefined){
                    $("#platform-currentSite").text(site);
                } else {
                    $("#platform-currentSite").text(APP.siteName);
                }


                ux.configGhPlatformMenu();
            }
        });


    },

    showGhPlatformMenu : function (flag) {
        if (flag) {
            ux.loadGhPlatformMenu();
            $('#gh-platform-header, #layout-nav, #gh-banner').removeClass("gh-noStaff");

        } else {
           $('#gh-platform-header, #layout-nav, #gh-banner').addClass("gh-noStaff");
        }
    },

    configGhPlatformMenu : function () {
            if (APP.siteSlug === 'buying-poultry') {
                $('.site-bp').removeClass('hidden');
            } else {
                $('.site-bp').addClass('hidden');
            }
    },

    toggleAndGo: function(e){
        var menuOpen = $("#mainMenu").hasClass("in");

        if(menuOpen){
            $("#mainMenu").collapse('toggle');
        }

        if(e !== undefined){
            var targetView = e.target.dataset.view;
            var targetViewStr = "/" + targetView;
            APP.router.navigate(targetViewStr);
        }

    },

    setFavicon: function (icon) {
        var fav = document.querySelector('#ghFavIcon');

        fav.setAttribute('href', icon);
    },

    formatPhone: function(unformattedPhone){
        if(unformattedPhone !== undefined && unformattedPhone !== null){
            var formatted = unformattedPhone.replace(/(\d{3})(\d{3})(\d{4})/, '($1) $2-$3');
            return formatted;
        } else {
            return unformattedPhone;
        }


    },

    initTooltips: function(viewId){
        $("#" + viewId + " .hasTooltip").tooltip();

    },
    checkEmptyData: function(e, emptyListId){
        if(e.sender.dataSource._total == 0){
            $("#" + emptyListId).removeClass("hidden");
        } else {
            $("#" + emptyListId).addClass("hidden");
        }
    },

    toggleConfirm: function(type, acceptFn, view) {
        if(view !== undefined && view !== null){
            ux.currentView = view;

            var modalView = $("#" + ux.currentView).hasClass("modal");
            if(modalView){
                $("#" + ux.currentView).modal("toggle");
            }
        }

        // can add more type in the future
        if(type === 'delete'){
            $("#confirm-title").text("Are you sure you want to delete?");
        }

        ux.confirmAction = acceptFn;

        $("#index-confirmModal").modal("toggle");
    },

    cancelAction: function(){
        // close confirmation modal
        $("#index-confirmModal").modal("toggle");

        // restore last modal view
        var modalView = $("#" + ux.currentView).hasClass("modal");
        if(modalView){
            $("#" + ux.currentView).modal("toggle");
        }

    },

    closeConfirm: function(){
        $("#index-confirmModal").modal("toggle");
    },

    // can use for views that need to load data
    toggleLoader: function(message, time) {
        var message = message || "";
        var displayMessage = "Loading " + message + "...";
        var time = time || 2000;
        if(!ux.hasLoaded){
            $("#index-loader p").text(displayMessage);
            $("#index-loader").velocity("fadeIn").delay(time).velocity("fadeOut");
            $("#app").velocity("fadeIn");
            ux.hasLoaded = true;
            return
        }

        if (!ux.isLoading) {
            $("#index-loader").velocity("fadeIn").delay(time).velocity("fadeOut");
            $("#index-loader p").text(displayMessage);
            ux.isLoading = true;
        } else {
            $("#index-loader").velocity("fadeOut");
            $("#index-loader p").text('');
            ux.isLoading = false;
        }

    },


    setAnalyticsPath : function (url) {
        ga('set', 'page', url);
        ga('send', 'pageview');

    },


    sendAnalyticsEvent : function (event, category, action, label) {
        ga('send', {
            hitType: event,
            eventCategory: category,
            eventAction: action,
            eventLabel: label
        });
    },

    sendAnalyticsOutboundLink : function (url) {
        ga('send', 'event', {
            eventCategory: 'Outbound Link',
            eventAction: 'click',
            eventLabel: url,
            transport: 'beacon'
        });
    },

    computeRating : function (gradeScore) {

        var retObj = {gradeScore : 0, gradeName : 'F', category: 'Avoid'};

        var nameMap = ['F', 'D-', 'D', 'D+', 'C-', 'C', 'C+', 'B-', 'B', 'B+', 'A-', 'A'];

        var score = parseInt(gradeScore);

        retObj.gradeScore = score;

        var name = nameMap[score];
        retObj.gradeName = name;

        var cat = "Avoid";

        if (score >= 4) {
            cat = "Better";
        }

        if (score > 8) {
            cat = "Best";
        }

        retObj.category = cat;

        return (retObj)
    },

    toggleShare: function(){
        ux.notify("Coming soon");
    },


    createSlug : function (name) {
        if (name === undefined || name === null) {
            return null;
        }
        var slug = name.replace(/\s+/g, '-').toLowerCase();

        slug = slug.replace(/\+/g,'-plus');

        slug = slug.replace(/[\;\:\.\,\@\#]/g, '-');

        return slug;
    },

    urlToId : function (url) {

        var fbId = url;
        if (fbId !== null && fbId.length > 2) {
            if (fbId.indexOf('http:') !== -1 || fbId.indexOf('http:') !== -1 ) {
                var fbArray = fbId.split('/');

                fbId = fbArray[fbArray-1];

               return (fbId);
            }
        }

        return(fbId);

    },

    validString : function (str) {
        if (str === undefined) {
            return (null);
        }
        return (str);
    },

    validArray : function (array) {
        if (array === undefined) {
            return ([]);
        }
        return (array);
    },

    validDate : function (num) {
        if (num === undefined || num === NaN || num === null) {
            return (0);
        }
        return (num);
    },

    validNumber : function (num) {
        if (num === undefined || num === NaN || num === null) {
            return (0);
        }
        return (num);
    },

    validBoolean : function (num) {
        if (num === undefined || num === NaN || num === null) {
            return (false);
        }
        return (num);
    },


    validObject : function (obj) {
        if (obj === undefined) {
            return (null);
        }
        return (obj);
    },


    isTrue : function (flag) {
        if (flag === undefined || flag === null) {
            return (false);
        }
        var value = (flag === true || flag === 'true');

        return (value);
    },

    computeGradeRange: function(dataArray){
        var ratingsArray = [];
        var rawGrades = {};
        var grades = {};

        _.forEach(dataArray, function(item){
            ratingsArray.push(item.gradeScore);
        });

        rawGrades.min = _.min(ratingsArray);
        rawGrades.max = _.max(ratingsArray);

        grades.min = ux.computeRating(rawGrades.min);
        grades.max = ux.computeRating(rawGrades.max);

        return grades;
    },

    blurView: function(viewId){
        $("#" + viewId).addClass("blurView");
    },

    resetView: function(e){
        var otherModal = $(".modal.in:not(#" + e.currentTarget.id + ")")[0].id;
        if(otherModal !== undefined){
            $("#" + otherModal).removeClass("blurView");
        }

        // todo - add more reset types
    },


    windowScrollReset: function() {
        window.scrollTo(0, 0);
    },

    checkPermission: function(typesArray){


    },

    showOmnivore : function () {
        $('.site-omnivore').removeClass('hidden');
    },

    hideOmnivore : function () {
        $('.site-omnivore').addClass('hidden');
    },

    validateStr : function (str) {
        if (str === undefined || str === null) {
            return (false);
        }

        if (str.length === 0)
            return(false);

        return true;
    },

    validateName : function (str) {
        if (str === undefined || str === null) {
            return (false);
        }

        if (str.length === 0)
            return(false);

        var nameArray = str.split(' ');
        if (nameArray.length > 1)
            return true;

        return false;
    },

    validateEmail: function (email) {
        if (email === undefined || email === null) {
            return (false);
        }

        if (email.length === 0)
            return(false);

        var regex = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
        var result = regex.test(email);

        return(result);
    },

    closeMobileMenu: function(menuSelector){
        if(menuSelector !== undefined){
            $(menuSelector).collapse("toggle");
        }
    },

    isBSMobile: function() {
        var windowWidth = $(window).width();
        if(windowWidth <= 767){
            return (true);
        } else {
            return (false);
        }
    },
    goToAnchor: function (anchor, locIn) {
        var loc = document.location.toString().split('#')[0];

        if (locIn !== undefined) {
            loc = locIn;
        }

        document.location = loc + '#' + anchor;
        return false;
    },

    isDevMode: function(){
        return (ux.devMode);
    },

    openLegal: function(){
        var legalUrl = "http://www." + APP.siteUrl + "/#/privacy";
        window.open(legalUrl, "_blank");
    },

    sendUrlChange: function(url){
        //target iframe parent
        window.parent.postMessage({
            url: url,
            isGaia: true
        }, "*");
    }


};


var ghBannerBar = {
    _init: false,
    userName: null,
    activeObj: new kendo.data.ObservableObject({
        message: "Hello there!",
        iconType: "material-icons",
        iconName: "alarm", // material icon name
        iconUrl: null,
        icon: null,
        priority: 1, // 1 (lowest) - 10 (highest)
        view: null, // corresponding view/section
        action: null,
        clickHandler: function () {
            var isFn = _.isFunction(this.action);
            ghBannerBar.onDismiss();
            if (isFn) {
                return this.action();
            }


        }
    }),
    bannerDS: new kendo.data.DataSource(),
    init: function () {
        if (!ghBannerBar._init) {
            ghBannerBar._init = true;

            templateLoader.loadHtml("gh-banner", "../../../templates/widgets/gh-banner.html", function (status) {
                if (status) {
                    kendo.bind("#gh-banner", ghBannerBar.activeObj);
                    if (userView.isStaff() || userView.isBlogger()) {
                        $("#gh-banner").removeClass("gh-noStaff");
                    } else {
                        $("#gh-banner").addClass("gh-noStaff");
                    }
                }
            });
        }
    },

    addNotification: function (data) {
        if (data !== undefined) {
            ghBannerBar.bannerDS.add(data);
        }
    },

    onShow: function () {
        var isOpen = $("#gh-banner").hasClass("gh-banner-open");

        if(APP.siteSlug !== "bff"){
            if(!isOpen){
                // todo - add banner model, quick test below
                var bannerData = ghBannerBar.bannerDS.at(0);
                ghBannerBar.setBanner(bannerData);
                $("#gh-banner").velocity("slideDown", {
                    delay: 2000
                }).addClass("gh-banner-open");
            }
        }

    },

    onDismiss: function () {
        $("#gh-banner").velocity("slideUp", {
            duration: 300
        }).removeClass("gh-banner-open");
    },

    setBanner: function (data) {
        var bannerObj = this.activeObj;
        if (data !== undefined) {
            if (data.icon !== null) {
                var iconHTML = "";
                switch (data.iconType) {
                    case "material-icons":
                        iconHTML = "<i class='material-icons'>" + data.iconName + "</i>";
                        bannerObj.set("icon", iconHTML);
                        break;
                    case "url":
                        // todo: jordan add support for custom icon
                        break;
                }
                bannerObj.set("iconName", data.icon);
            } else {
                bannerObj.set("iconName", null);
            }

            bannerObj.set("message", data.message);
            bannerObj.set('priority', data.priority);
            bannerObj.set("action", data.action);
        } else {
            // clear active obj

        }
    }


};
/**
 * Created by donbrad on 10/8/16.
 **/

'use strict';

var advisorsView = {
    _onInit: false,
    _blogsFetched : false,
    _query : null,
    _hitCount : 0,
    _pageCount : 0,
    _processingTime : 0,
    _mostRecent: [],
    _queryHits : [],
    _tagFacet : null,
    blogsDS : new kendo.data.DataSource(),
    blogIndex : 0,

    activeObject : new kendo.data.ObservableObject({title: null, content: null, name: null, imageUrl: "images/icon-defaultProduct.svg"}),

    init : function () {

        if(!advisorsView._onInit){
            $("#advisorsView-list").kendoListView({
                dataSource:  advisorsView.blogsDS,
                template: kendo.template($("#blogView-list-tmpl").html()),
                selectable: true,
                dataBound: function() {
                    var blogCount = this.dataSource._total;
                    var inputVal = $("#blog-searchbox").val();
                    if(blogCount > 0){
                        $(".empty-blog").addClass("hidden");
                    } else {
                        $(".empty-blog").removeClass("hidden");
                        $(".empty-blog > p > span").text('"' + inputVal + '"');
                    }
                },
                change: function(e){
                    var blog = null;
                    var data = advisorsView.blogsDS,
                        selected = $.map(this.select(), function(item) {
                            var uid = item.attributes['data-uid'].value;
                            blog = data.getByUid(uid);
                            var token = blog.slug;
                            APP.router.navigate("#/blog?blogid=" + token);
                        });
                }
            });


            var options = {
                callback: function (value) {
                    if (value.length === 0) {
                        advisorsView.blogsDS.data(advisorsView._mostRecent);
                    }  else {
                        ux.notify('Searching Blogs for "' + value + '"', 'success' );
                        advisorsView.processQueryHits(value);
                    }

                },
                wait: 750,
                highlight: true,
                allowSubmit: false,
                captureLength: 3
            };

            $("#blog-searchbox").typeWatch( options );


            /*$("#blog-searchbox").on('input', function() {
                var query = this.value;
                advisorsView._query = query;
                if (query.lenght === 0)
                    advisorsView.blogsDS.data(advisorsView._mostRecent);
                }
            });*/

            advisorsView._onInit = true;

            advisorsView.getMostRecent();

        } /*else {
            advisorsView.processQueryHits();
        }*/

        if (userView.isStaff() || userView.isBlogger()) {
            $('.bpstaff').removeClass('hidden');
            tagModel.init();
        } else {
            $('.bpstaff').addClass('hidden');
        }



    },

    openBlog: function(e){
        var blogSlug = e.target.dataset.slug;
        blogView.goToBlog(blogSlug);
    },

    getMostRecent : function () {

        advisorsView._mostRecent = [];

        algolia.blogIndex.search('', {
            hitsPerPage: 5
        }, function (err, content) {
            if (err) {
                console.error(err);
                return;
            }

            advisorsView.blogIndex = 0;
            advisorsView._hitCount = content.nbHits;
            advisorsView._pageCount = content.nbPages;
            advisorsView._currentPage = content.page;
            advisorsView._processingTime = content.processingTimeMS;
            blogView.activeObj.set('index', advisorsView.blogIndex+1);
            blogView.activeObj.set('total',  advisorsView._hitCount);
            blogView.activeObj.set('activeTag',  "Most Recent Blogs");


            for (var h in content.hits) {
                var hit = content.hits[h];
                var blogObj = {objectId: hit.objectID, id : hit.id, slug : hit.slug, author : hit.author, publishDate: hit.publishDate,
                    tags: hit.tags, categories : hit.categories, title: hit.title, content: hit.content,
                    imageUrl : hit.imageUrl };

                advisorsView._mostRecent.push(blogObj);
            }


            advisorsView.blogsDS.data(advisorsView._mostRecent);
        });
    },

    processQueryHits : function (query) {
        var options = {hitsPerPage : 1000};
        advisorsView._queryHits = [];

        if (advisorsView._tagFacet !== null) {
            options.facetFilters = advisorsView._tagFacet;
        }

        advisorsView._query = query;

        algolia.blogIndex.search(query, options, function (err, content) {
            if (err) {
                console.error(err);
                return;
            }
            advisorsView.blogIndex = 0;
            advisorsView._hitCount = content.nbHits;
            advisorsView._pageCount = content.nbPages;
            advisorsView._currentPage = content.page;
            advisorsView._processingTime = content.processingTimeMS;


            blogView.activeObj.set('index', advisorsView.blogIndex+1);
            blogView.activeObj.set('total',  advisorsView._hitCount);

            var queryStats = advisorsView._hitCount + ' results found in ' + advisorsView._processingTime + ' ms.';

            $('#advisorsView-queryStats').text(queryStats);

            for (var h in content.hits) {
                var hit = content.hits[h];
                var blogObj = {objectId: hit.objectID, id : hit.id, slug : hit.slug, author : hit.author, publishDate: hit.publishDate,
                    tags: hit.tags, categories : hit.categories, title: hit.title, content: hit.content,
                    imageUrl : hit.imageUrl };

                advisorsView._queryHits.push(blogObj);
            }

            advisorsView.blogsDS.data(advisorsView._queryHits);
        });

    },

    onShow: function(){


    },

    processTags: function(tagsArray){
        var tagString = "";
        if (tagsArray!== undefined && tagsArray.length > 0) {
            for (var t=0; t<tagsArray.length; t++) {
                var anchor =' <a class="bp-tag" data-tag="'+ tagsArray[t] +'" onclick="advisorsView.tagClick(event)">' + tagsArray[t] + '</a> , ';
                tagString += anchor;

                tagString = tagString.substr(0, tagString.length-2);
            }
        }
        return tagString;
    },

    showTags: function (e) {
        $(e.target.offsetParent.children[2]).removeClass("text-clamp").css("width", "100%");
        $(e.target).addClass("hidden");
    },

    setTagFacet : function (tag) {
        advisorsView._tagFacet = ['tags:'+tag];
        blogView.activeObj.set('tagName', advisorsView._tagFacet);

        var anchor = '<a class="bp-tag" onclick="advisorsView.clearTagFacet()">' +
            '<i class="material-icons">close</i>' +
            tag +
            '</a>';

        var viewanchor = '<a class="bp-tag" >' +
            tag +
            '</a>';

        $('#advisorsView-activeTag').html(anchor);

        blogView.activeObj.set('activeTag', viewanchor);

        advisorsView.processQueryHits(advisorsView._query);
        $(".blogView-tag-active").removeClass("hidden");
    },

    clearTagFacet : function () {
        advisorsView._tagFacet = null;

        blogView.activeObj.set('activeTag', 'All Blogs');
        $('#advisorsView-activeTag').text('');
        advisorsView.processQueryHits(advisorsView._query);
        $(".blogView-tag-active").addClass("hidden");
    },

    tagClick : function (e) {
        var tagName = e.currentTarget.attributes['data-tag'].value;
        ux.notify('Filtering Blogs by ' + tagName, 'success');
        advisorsView.setTagFacet(tagName);
    },

    hideTools : function () {
        $('.bpstaff').addClass('hidden');
        ux.notify("Refresh page to redisplay Staff tools","success");
    },

    editGlossary: function () {
        ux.notify("Coming Soon...", "success");
    },

    editTags: function () {
        ux.notify("Coming Soon...", "success");
    },

    editCategories: function () {
        ux.notify("Coming Soon...", "success");
    },


    editSocialFeed : function () {
        ux.notify("Coming Soon...", "success");
    }



};

var advisorView = {
    _onInit: false,
    _twitterTags : [
        '@farmforward', '@buyingpoultry', '@JIFAnimals', '#farmforward', '#buyingpoultry', '#JIFAnimals'
    ],
    _fbTags : [
        "!farmforward", '!buyingpoultry', '!jewishinitiativeforanimals',  '@farmforward', '@buyingpoultry', '@jewishinitiativeforanimals'
    ],

    activeObj: new kendo.data.ObservableObject({
        id: null,
        title: null,
        author: null,
        slug: null,
        publishDate: null,
        description: null,
        index: 0,
        total : 0,
        activeTag : null,
        imageUrl: "images/icon-defaultProduct.svg"
    }),

    init: function(){
      if(!advisorView._onInit){
          kendo.bind($("#advisorView"), advisorView.activeObj);
          advisorView._onInit = true;

          if (APP.socialFeed) {
              $('.social-feed-container').socialfeed({

                  // FACEBOOK
                  facebook: {
                      accounts: advisorView._fbTags,
                      limit: 50,
                      access_token: '1769550126625987|ASkS_59vC41kbXLLlTIufigeX3M'
                  },
                  // Twitter
                  twitter: {
                      accounts: advisorView._twitterTags,
                      limit: 50,
                      consumer_key: 'uLWcGWmebBDET8C1s5wM90NIp', // make sure to have your app read-only
                      consumer_secret: 'P95UdolvtVnhMG3rfleAm1enrjQU0ZQHb6Hjd8eE580p3ic0j4' // make sure to have your app read-only
                  },

                  // GENERAL SETTINGS
                  show_media: true,
                  length: 300,
                  update_period: 36000,
                  // When all the posts are collected and displayed - this function is evoked
                  callback: function() {
                      ux.notify("Social Feeds Loaded !", "success");
                  }
              });
          }

      }

    },

    openModal : function (blogId) {
        if (userView.isStaff() || userView.isBlogger() ) {
            $('.bpstaff').removeClass('hidden');

        } else {
            $('.bpstaff').addClass('hidden');
        }

        advisorView.updateActiveObj(blogId);

        $('#advisorView-modal').modal('toggle');


    },

    goToBlog: function(slug){
      //  console.log(blogId);
        APP.router.navigate("/blog?blogid=" + slug);
      // kendo.bind($("#advisorView"), advisorView.activeObj);    shouldn't need to rebind...
    },

    goToNextPost: function(){

        advisorsView.blogIndex++;
        if(advisorsView.blogIndex >= advisorsView._hitCount){
            advisorsView.blogIndex = 0;
            nextBlog = blogModel.blogDS.at(0);
        }
        advisorView.activeObj.set('index', advisorsView.blogIndex+1);
        var nextBlog = blogModel.blogDS.at(advisorsView.blogIndex);
        advisorView.updateActiveObj(nextBlog.slug);
    },

    updateActiveObj: function(slug){

        algolia.blogIndex.search(slug, function (err, content) {
            if (err) {
                console.error(err);
                return;
            }

            var blog = content.hits[0];

            if(blog !== null && blog !== undefined){
                var title = _.unescape(blog.title);
                advisorView.activeObj.set("title",title);
                advisorView.activeObj.set("id", blog.id);
                advisorView.activeObj.set("slug", blog.slug);
                if(blog.author !== null && blog.author !== ""){
                    advisorView.activeObj.set("author", blog.author);
                } else {
                    advisorView.activeObj.set("author", "Buying Poultry");
                }

                advisorView.activeObj.set("content", blog.content);

                if(advisorView.imageUrl !== null && advisorView.imageUrl !== ""){
                    advisorView.activeObj.set("imageUrl", blog.imageUrl);
                }
                // set date
                if(advisorView.activeObj.CreatedAt !== null){
                    var date = moment(advisorView.activeObj.publishDate);
                    var formattedDate = moment(blog.publishDate).format('MMM Do, YYYY');
                    advisorView.activeObj.set('publishDate', formattedDate);
                }

                var processedTags = advisorsView.processTags(blog.tags);
                advisorView.activeObj.set("processedTags", processedTags);

                shareModel.setShare("Buying Poultry", blog.title, 'http://www.buyfarmfoward.com/#/blog?blogid='+blog.slug);

            } else {
                ux.notify("Error loading blog post", "error");
                APP.router.navigate("/blog");
            }
        });
    },

    onShow: function(slug){
        if (userView.isStaff()) {
            $('.bpstaff').removeClass('hidden');

        } else {
            $('.bpstaff').addClass('hidden');
        }
        advisorView.updateActiveObj(slug);
    },



    newBlog : function () {
        APP.router.navigate("/blogeditor");
    },

    editBlog : function () {
        APP.router.navigate("/blogeditor?blogid=" + advisorView.activeObj.slug);
    },

    deleteBlog : function () {
        var blogId = advisorView.activeObj.slug;
        ux.toggleConfirm("delete", function(){
            // todo - wire delete blog
            ux.closeConfirm();
            ux.notify("Blog post deleted", "danger");

        }, null)
    }
};


/**
 * Created by donbrad on 3/22/17.
 */
'use strict';

var backlogListView = {
    _initialized: false,
    _reportInitialized : false,
    _siteSlug : null,
    _reportSlug : null,

    backlogDS : new kendo.data.DataSource({
        pageSize: 12,
        schema: {
            model: {
                id: "Id",
                fields: {
                    scope: { nullable: false },
                    priority: { type: "Number", defaultValue: 3,  nullable: false },
                    optEst: { type: "Number", defaultValue: 1,  nullable: false },
                    pessEst: { type: "Number", defaultValue: 3,  nullable: false },
                    status: { nullable: false },
                    siteName:  { nullable: false },
                    siteSlug:  { nullable: false },
                    description:  { nullable: true },
                    title:  { nullable: false },
                    releaseTarget:  { nullable: false },
                    targetDate:  { type: "Date", defaultValue: new Date(),  nullable: true },
                    backlogSlug:  { nullable: true },
                    designStatus:  { nullable: true },
                    devStatus:  { nullable: true },
                    testStatus:  { nullable: true },
                    uxStatus:  { nullable: true }
                }
            }
        },
        transport : {
            create: function (options) {
                options.success();
            },

            destroy : function (options) {
                var model = options.data;
                backlogModel.remove(model);
                options.success();
            },

            read: function (options) {
                var pages = [];
                if (backlogListView._siteSlug !== null) {
                    pages = backlogModel.listBySiteSlug(backlogListView._siteSlug);
                } else {
                    pages = backlogModel.backlogDS.data();
                }
                options.success(pages);
            },

            update : function (options) {
                var model = options.data;
                backlogModel.update(model);
                options.success();
            },

            parameterMap: function(options, operation) {
                if (operation !== "read" && options.models) {
                    return {models: kendo.stringify(options.models)};
                }
            }
        }
    }),

    activeObj : new kendo.data.ObservableObject({siteName: null, siteSlug: null}),
    _pageSize : 12,
    _reportTemplate : null,

    _initReport : function () {
       /* if (backlogListView._reportInitialized) {
            return;
        }

        backlogListView._reportInitialized = true;
*/
        $("#backlistReport-tabstrip").kendoTabStrip({
            animation:  {
                open: {
                    effects: "fadeIn"
                }
            }
        });

        $('#backlistReport-comments').comments({
            profilePictureURL: 'https://viima-app.s3.amazonaws.com/media/user_profiles/user-icon.png',
            currentUserId: userModel.userObj.Id,
            roundProfilePictures: true,
            textareaRows: 3,
            enableAttachments: false,
            enableHashtags: false,
            enablePinging: false,
            getUsers: function(success, error) {
                success(commentModel._staffList);
            },

            getComments: function(success, error) {
                commentModel.read();
                var comments = commentModel.listByReportSlug(backlogListView._reportSlug);
                success(comments);
            },

            postComment: function(data, success, error) {
                var guid = uuid.v4();

                data.Id = guid;
                data.reportSlug = backlogListView._reportSlug;
                data.senderName = userModel.userObj.name;
                data.email =  userModel.userObj.email;
                data.senderEmail = userModel.userObj.email;

                commentModel.add(data);

                success(data);
                /*setTimeout(function() {
                    success(saveComment(data));
                }, 500);*/
            },

            putComment: function(data, success, error) {

                commentModel.update(data);
                success(data);
               /* setTimeout(function() {
                    success(saveComment(data));
                }, 500);*/
            },

            deleteComment: function(data, success, error) {

                commentModel.delete(data);

               /* setTimeout(function() {
                    success();
                }, 500);*/
            },

            upvoteComment: function(data, success, error) {
                setTimeout(function() {
                  //  success(data);
                }, 500);
            },
            uploadAttachments: function(dataArray, success, error) {
                setTimeout(function() {
                   // success(dataArray);
                }, 500);
            }
        });

    },

    init: function(){
        if(!backlogListView._initialized){

            backlogListView._initialized = true;

            templateLoader.load('../../../templates/backlogReport-tmpl.html', function(status) {
                if(status){
                    backlogListView._reportTemplate = kendo.template($("#backlogReport-tmpl").html());
                }
            });

            $("#backlogReport-window").kendoWindow({
                width: "1024px",
                height: "768px",
                visible: false,
                close : function () {
                    window.location.hash='#/backloglist'
                },
                actions: [
                    "Pin",
                    "Minimize",
                    "Maximize",
                    "Close"
                ]
            });

            $("#backlogSite-selector").kendoDropDownList({
                dataTextField: "name",
                dataValueField: "slug",
                dataSource: [
                    {name : 'All', slug: "all"},
                    {name : 'Farm Forward', slug: "farm-forward"},
                    {name : 'JIFA', slug: "jifa"},
                    {name : 'Better Food Foundation', slug: "bff"},
                    {name : 'Leadership-Circle', slug: "leadership-circle"},
                    {name : 'Buying Poultry', slug: "buying-poultry"}
                ],

                change : function (e) {
                    var siteSlug = this.value();

                    if (siteSlug === 'all') {
                        siteSlug = null;
                    }
                    backlogListView._siteSlug = siteSlug;

                    backlogListView.backlogDS.read();
                }
            });

            $('#backlogList-search-input').keyup (function () {
                var val =  $('#backlogList-search-input').val();

                if (val.length > 0) {
                    backlogListView.backlogDS.filter({field: 'title', operator: 'contains', value: val});
                } else {
                    backlogListView.backlogDS.filter({});
                }

            });

            $('#backlogList-search-input').change (function () {
                var val =  $('#backlogList-search-input').val();

                if (val.length > 0) {
                    backlogListView.backlogDS.filter({field: 'title', operator: 'contains', value: val});
                } else {
                    backlogListView.backlogDS.filter({});
                }
            });

            if (userView.isGaiaHacker()) {
                $("#backlogList-grid").kendoGrid({
                    dataSource: backlogListView.backlogDS,
                    pageSize : 12,
                    autoBind: false,
                    pageable: true,
                    resizable: true,
                    sortable: true,
                    reorderable: true,
                    selectable: true,
                    batch: true,
                    toolbar: [{name: "create", text: "Add Entry"},{name: "save", text: "Save Changes "}],
                    editable: "inline",
                    change: function(e) {
                        var selectedRow = this.select();
                        var dataItem = this.dataItem(selectedRow[0]);

                        backlogListView.doReport(dataItem);
                    },

                    height: 580,
                    columns: [
                        { field:"siteName",title:"Site", editor: backlogListView._siteEditor, width: "220px" },
                        { field:"title",title:"Title", width: "80px" },
                        { field:"releaseTarget",title:"Release", width: "80px" },
                        { field:"targetDate",title:"Date", editor: backlogListView._dateEditor , width: "100px"},
                        { field:"priority",title:"Priority", editor: backlogListView._priorityEditor,  width: "80px" },
                        { field:"scope",title:"Scope",  editor: backlogListView._scopeEditor, width: "80px" },
                        { field:"designStatus",title:"Design Status", editor: backlogListView._statusEditor, width: "100px" },
                        { field:"devStatus",title:"Dev Status", editor: backlogListView._statusEditor, width: "100px" },
                        { field:"uxStatus",title:"UX Status", editor: backlogListView._statusEditor, width: "100px" },
                        {  command: [ "edit", "destroy" ], title: "Dev Tools",  width: "120px"}
                    ]
                });
            } else {
                $("#backlogList-grid").kendoGrid({
                    dataSource: backlogListView.backlogDS,
                    pageSize : 12,
                    autoBind: false,
                    pageable: true,
                    resizable: true,
                    sortable: true,
                    reorderable: true,
                    selectable: true,
                    /* toolbar: [{name: "save", text: "Save All Changes..."}],
                     editable: true,*/
                    change: function(e) {
                        var selectedRow = this.select();
                        var dataItem = this.dataItem(selectedRow[0]);

                        backlogListView.doReport(dataItem);
                    },
                    height: 580,
                    columns: [
                        { field:"siteName",title:"Site", width: "220px" },
                        { field:"title",title:"Title", width: "80px" },
                        { field:"releaseTarget",title:"Release", width: "80px" },
                        { field:"targetDate",title:"Date", width: "120px", format:"{MM/dd/YYYY }" },
                        { field:"priority",title:"Priority", width: "80px" },
                        { field:"scope",title:"Scope", width: "80px" },
                        { field:"designStatus",title:"Dev Status", width: "120px" },
                        { field:"devStatus",title:"Dev Status", width: "120px" },
                        { field:"uxStatus",title:"UX Status", width: "120px" }
                    ]
                });
            }

            //  kendo.bind($("#contributorView-modal"), contributorView.activeObj);
        }
    },

    loadBacklogDS : function (siteSlug) {
        var pages = null;

        if (siteSlug === null || siteSlug === 'all') {
            backlogListView._siteSlug = null;
        } else {
            backlogListView._siteSlug = siteSlug;
        }

        backlogListView.backlogDS.read();
    },


    doReport : function (report) {

        var obj = backlogListView.activeObj;
        var formattedDate = moment(report.date).format("ddd, M/D/YY, h:mma");
        obj.set('Id', report.Id);
        obj.set('date', formattedDate);
        obj.set('senderName', report.senderName);
        obj.set('senderEmail', report.senderEmail);
        obj.set('category', report.category);
        obj.set('siteSlug', report.siteSlug);
        obj.set('siteName', report.siteName);
        obj.set('priority', report.priority);
        obj.set('status', report.status);
        obj.set('slug', report.slug);

        backlogListView._reportSlug = report.slug;

        if (report.backlogSlug === undefined || report.backlogSlug === null || report.backlogSlug === null) {
            report.backlogSlug = 'None';
        }
        obj.set('backlogSlug', report.backlogSlug);
        obj.set('content', report.content);

        if (report.assignedTo === undefined || report.assignedTo === null || report.assignedTo === null) {
            report.assignedTo = 'No one yet';
        }


        var title = "Backlog : " + report.siteName +  " (" + report.title + ") [" + report.priority + "]";


        var content = backlogListView._reportTemplate(obj);

        var win= $("#backlogReport-window").data("kendoWindow");

        win.title(title).content(content).center();
        backlogListView._initReport();
        win.open();

        window.location.hash='#/backloglist?reportid='+report.Id;
    },

    doSaveReport : function () {

    },


    doViewReport : function (e) {
        var thisPage = this.dataItem($(e.currentTarget).closest("tr"));
        var pageSlug = thisPage.slug;

        APP.router.navigate("/feedback?feedbackid=" + pageSlug);
        // Invoke pageEditor with pageSlug...
    },

    open: function (siteSlug, reportId) {
        backlogListView.init();
        $('#feedbackList-search-input').val('');
        backlogListView.loadBacklogDS(siteSlug);

        if (reportId !== undefined && reportId !== null) {
            var report = backlogModel.findById(reportId);

            if (report !== null) {
                if (backlogListView._reportTemplate === null) {
                    templateLoader.load('../../../templates/backlogReport-tmpl.html', function(status) {
                        if(status){
                            backlogListView._reportTemplate = kendo.template($("#backlogReport-tmpl").html());

                            backlogListView.doReport(report);
                        }
                    });
                }

            }
        }


    },

    close : function () {

    },

    _readOnly : function (container, options) {
        ux.notify (options.field + " is readonly", 'error');
    },

    _dateEditor : function (container, options) {
        $('<input data-text-field="' + options.field + '" data-value-field="' + options.field + '" data-bind="value:' + options.field + '" data-format="' + options.format + '"/>')
            .appendTo(container)
            .kendoDatePicker({ min: new Date()});
    },
    _categoryEditor : function (container, options) {
        $('<input required name="' + options.field + '"/>')
            .appendTo(container)
            .kendoDropDownList({
                autoBind: false,
                dataSource: ["Bug", "Date", "Feature", "UX"]
            });
    },



    _scopeEditor : function (container, options) {
        $('<input required name="' + options.field + '"/>')
            .appendTo(container)
            .kendoDropDownList({
                autoBind: false,
                dataSource: ["Small", "Medium", "Large", "Huge"]
            });
    },

    _siteEditor : function (container, options) {
        $('<input required name="' + options.field + '"/>')
            .appendTo(container)
            .kendoDropDownList({
                autoBind: false,
                dataTextField: "name",
                dataValueField: "slug",
                dataSource: [
                    {name : 'All', slug: "all"},
                    {name : 'Farm Forward', slug: "farm-forward"},
                    {name : 'JIFA', slug: "jifa"},
                    {name : 'Better Food Foundation', slug: "bff"},
                    {name : 'Leadership-Circle', slug: "leadership-circle"},
                    {name : 'Buying Poultry', slug: "buying-poultry"}
                ]
            });
    },

    _priorityEditor : function (container, options) {
        $('<input required name="' + options.field + '"/>')
            .appendTo(container)
            .kendoDropDownList({
                autoBind: false,
                dataSource: ["High", "Normal", "Low"]
            });
    },

    _statusEditor : function (container, options) {
        $('<input required name="' + options.field + '"/>')
            .appendTo(container)
            .kendoDropDownList({
                autoBind: false,
                dataSource: ["NA", "Submitted", "Under Review", "In Backlog", "Deferred", "Completed"]
            });
    },

    _assignedEditor : function (container, options) {
        $('<input required name="' + options.field + '"/>')
            .appendTo(container)
            .kendoDropDownList({
                autoBind: false,
                dataSource: ["Don", "Jordan"]
            });
    }

};
/**
 * Created by donbrad on 10/8/16.
 **/

'use strict';

var blogEditor = {
    _inited : false,
    _window : null,
    _createMode : false,
    _tagPrefix : 'ghp',
    _blogFragment : '#/blog?blogid=',
    _labelFragment : '#/labelguide?labelid=',
    _glossaryFragment : '',
    _editor : null,
    _anchors : [],
    _blogPhotos : new kendo.data.DataSource(),
    _categoryDS : new kendo.data.DataSource(),
    _tagDS : new kendo.data.DataSource(),

    activeObj: new kendo.data.ObservableObject({
        title: null,
        id: null,
        category: null,
        categoryRating : 3,
        publishDate : new Date(),
        isVerified : false,
        tags : [],
        categories : [],
        content: null,
        tooltip: null,
        imageUrl : null,
        previewUrl : null,
        author : null,
        authorSlug : null,
    }),

    activeLink :  new kendo.data.ObservableObject({
        title: null,
        url: null,
        category: null,   // external, blog, glossary
        objectId : null
    }),

    activePhoto :  new kendo.data.ObservableObject({
        objectId: null,
        url: null,
        isPreview: false
    }),

    init : function () {
        if (!blogEditor._inited) {

            blogEditor._inited = true;

            //cloudinary.setCloudName('hyjvcxzjt');

            kendo.bind($("#blogEditor"), blogEditor.activeObj);
            kendo.bind($("#blogLinkEditor"), blogEditor.activeLink);
            kendo.bind($("#blogPhotoGallery"), blogEditor.activePhoto);

            blogEditor.fetchBlogPhotos();

            $("#blogEdit-author").kendoAutoComplete({
                dataTextField: "name",
                template: kendo.template($("#contributorList-template").html()),
                select: function(e) {
                    var item = e.dataItem;
                    var id = item.slug;
                    blogEditor.activeObj.set('authorSlug', item.slug);
                    blogEditor.activeObj.set('authorName', item.name);
                },
                dataSource: contributorModel.bloggerDS,
                height: 400
            });


            $("#linkEditor-blog").kendoAutoComplete({
                dataTextField: "title",
                dataValueField: "slug",
                filter: "contains",
                suggest: true,
                placeholder: "Enter Blog Title ...",
                select: function(e) {
                    var item = e.dataItem;
                    var id = item.slug;
                    // Use the selected item or its text
                    blogEditor.activeLink.category = "Blog";
                    blogEditor.activeLink.objectId = id;
                    blogEditor.activeLink.set('href', blogEditor._blogFragment+id);
                },
                dataSource: blogModel.blogDS
            });


            $("#linkEditor-contributor").kendoAutoComplete({
                dataTextField: "name",
                dataValueField: "slug",
                filter: "contains",
                suggest: true,
                placeholder: "Enter Persons Name ...",
                select: function(e) {
                    // Use the selected item or its text
                    blogEditor.activeLink.category = "Contributor";
                },
                dataSource: contributorModel.contributorDS
            });

            /* $("#linkEditor-label").kendoAutoComplete({
             dataTextField: "title",
             dataValueField: "id",
             filter: "contains",
             suggest: true,
             placeholder: "Enter Label Title ...",
             select: function(e) {
             var item = e.dataItem;
             var id = item.id;
             // Use the selected item or its text
             blogEditor.activeLink.category = "Label";
             blogEditor.activeLink.objectId = id;
             blogEditor.activeLink.set('href', blogEditor._labelFragment+id);
             },
             dataSource: labelGuideView.labelsDS
             });*/

            $("#blogEdit-tags").kendoMultiSelect({
                dataSource: tagModel.tagDS,
                dataTextField : 'name',
                dataValueField : 'slug',
                clearButton : true
            });

            $("#blogEdit-categories").kendoMultiSelect({
                dataSource: tagModel.categoryDS,
                dataTextField : 'name',
                dataValueField : 'slug',
                clearButton : true
            });

            $("#blogPhotoGallery-pager").kendoPager({
                dataSource: blogEditor._blogPhotos
            });

            $("#blogPhotoGallery-listView").kendoListView({
                dataSource: blogEditor._blogPhotos,
                template: kendo.template($("#galleryPhotoTemplate").html())
            });

            $("#blogEdit-date").kendoDatePicker({
                value: blogEditor.activeObj.publishDate
            });




            /*$('#blogEdit-imageUpload').cloudinary_upload_widget({ cloud_name: 'hyjvcxzjt', upload_preset: 'bpblog', public_id:  blogEditor.activeObj.slug,  button_caption: "Upload New Preview Image", client_allowed_formats : ["png","gif", "jpeg"]  },
             function(error, result) {
             if (error === null && result.length > 0) {
             var photo = result[0];
             blogEditor.activeObj.set("imageUrl", photo.secure_url);
             blogEditor.activeObj.set("dirty", true);
             var blogObj = blogEditor.activeObj;

             everlive.updateOne('blog', blogObj, function (err, data) {
             blogEditor._updateIndex( function (status) {
             if (status) {
             ux.notify("Updated brand photo ", 'success');
             $('#blogPhotoEditor-imageDiv').removeClass('hidden');
             }
             });
             // Call the index update function...
             });

             }
             });*/


            $('#blogPhotoEditor-imageUpload').cloudinary_upload_widget({ cloud_name: 'hyjvcxzjt', upload_preset: 'bpblog',button_caption: "Upload New Image" , client_allowed_formats : ["png","gif", "jpeg"] },
                function(error, result) {
                    if (error === null && result.length > 0) {
                        var photo = result[0];
                    }
                });

            $("#blogEdit-editor").kendoEditor({
                stylesheets: [
                    "../../css/editorStyles.css"
                ],
                resizable: {
                    content: false,
                    toolbar: true
                },
                pasteCleanup: {
                    css: true,
                    msAllFormatting: true,
                    msConvertLists: false
                },
                select: function(e) {
                    var editor = $("#blogEdit-editor").data("kendoEditor");
                    var selection = editor.getSelection();

                    if (selection.focusNode.parentNode.tagName === 'A') {
                        var title = selection.focusNode.parentNode.text;
                        var href =  selection.focusNode.parentNode.href;
                        var targetText = selection.focusNode.parentNode.outerHTML;
                        blogEditor.editLink(selection, title, href, targetText);


                    } else if (selection.focusNode.parentNode.tagName === 'SPAN' &&
                        selection.focusNode.parentNode.children.length === 2 &&
                        selection.focusNode.parentNode.children[0].className  === "easy-footnote-margin-adjust") {

                        var noteNumber = selection.focusNode.parentNode.children[1].innerText;
                        var url = selection.focusNode.parentNode.children[1].children[0].href;
                        var host = selection.focusNode.parentNode.children[1].children[0].host;
                        var hash = selection.focusNode.parentNode.children[1].children[0].hash;
                        var html = selection.focusNode.parentNode.children[1].outerHTML;

                        var regex = new RegExp(/\\s*title=\\s*\\“(.*?)target=/);
                        html = decodeURI(html);
                        var footnote = regex.exec(html);


                    } else if (selection.anchorNode.tagName === 'TEXT') {
                        var noteNumber = selection.anchorNode.data;

                    } else if (selection.focusNode.tagName === 'IMG') {

                    }  else if (selection.focusNode.tagName === 'DIV' && selection.focusNode.className === 'blog-image') {
                        // Process legacy images in legacy blogs...
                        var image = selection.focusNode.children[0];
                        var imageSrc = image.src;


                        blogEditor.editImage(selection, null, imageSrc);

                    }

                },
                paste : function (e) {

                },
                tools: [
                    "bold", "italic", "underline", "subscript", "superscript", "justifyLeft", "justifyCenter", "justifyRight", "insertUnorderedList", "insertOrderedList",
                    "indent", "outdent","viewHtml","formatting",
                    {
                        name: "Link",
                        tooltip: "Add or Edit Hyperlink",
                        template: '<button class="k-button" onclick="blogEditor.addLink()"><span class="k-font-icon k-i-anchor"></span></button>'
                    },
                    {
                        name: "Glossary",
                        tooltip: "Add or Edit Glossary",
                        template: '<button class="k-button" onclick="blogEditor.addGlossary()"><span class="k-font-icon k-i-dictionary-add"></span></button>'
                    },
                    {
                        name: "Reference",
                        tooltip: "Add or Edit Reference or Citation",
                        template: '<button class="k-button" onclick="blogEditor.addReference()"><span class="k-font-icon k-i-sup-script"></span></button>'
                    },
                    {
                        name: "Image",
                        tooltip: "Add or Edit Inline Image",
                        template: '<button class="k-button" onclick="blogEditor.addImage()"><span class="k-font-icon k-i-image"></span></button>'
                    },
                    {
                        name: "Gallery",
                        tooltip: "Add Inline Image from Gallery",
                        template: '<button class="k-button" onclick="blogEditor.addGallery()"><span class="k-font-icon k-i-borders-all"></span></button>'
                    }
                ]
            });

            blogEditor._editor = $("#blogEdit-editor").data("kendoEditor");
        }
    },

    loadBlog : function (slug) {

    },

    open : function (slug) {

        blogEditor.init();

        var blogObj = blogModel.findBlogBySlug(slug);

        if (blogObj !== null) {
            blogEditor._createMode = false;

            if (blogObj.tagString === undefined) {
                blogObj.tagString = '';
            }

            if (blogObj.Id === undefined) {
                blogObj.Id = blogObj.objectID;
            }
            blogEditor.activeObj.set("Id", blogObj.Id);
            blogEditor.activeObj.set("objectID", blogObj.objectID);
            blogEditor.activeObj.set("slug", blogObj.slug);
            var title = decodeURI(blogObj.title);
            blogEditor.activeObj.set("title", title);
            blogEditor.activeObj.set("content", blogObj.content);
            blogEditor.activeObj.set("tooltip", blogObj.tooltip);
            blogEditor.activeObj.set("authorName", blogObj.authorName);
            if (blogObj.authorSlug === undefined) {
                blogObj.authorSlug = null;
            }
            blogEditor.activeObj.set("authorSlug", blogObj.authorSlug);
            blogEditor.activeObj.set("tags", blogObj.tags);
            blogEditor.activeObj.set("categories", blogObj.categories);
            blogEditor.activeObj.set("imageUrl", blogObj.imageUrl);
            if (blogObj.previewUrl === undefined) {
                blogObj.previewUrl = null;
            }
            blogEditor.activeObj.set("previewUrl", blogObj.previewUrl);
            var date = new Date(blogObj.publishDate);
            blogEditor.activeObj.set("publishDate", date);



        } else {
            ux.notify("Creating New Blog!", "success");
            blogEditor._createMode = true;
            var blogId = uuid.v4();
            blogEditor.activeObj.set("Id", blogId);
            blogEditor.activeObj.set("objectId", blogId);
            blogEditor.activeObj.set("title", null);
            blogEditor.activeObj.set("slug", null);
            blogEditor.activeObj.set("content", null);
            blogEditor.activeObj.set("tooltip", null);
            blogEditor.activeObj.set("imageUrl", null);
            blogEditor.activeObj.set("authorName", null);
            blogEditor.activeObj.set("authorSlug", null);
            blogEditor.activeObj.set("tags", []);
            blogEditor.activeObj.set("imageUrl", null);
            blogEditor.activeObj.set("previewUrl", null);
            blogEditor.activeObj.set("categories", []);
            blogEditor.activeObj.set("publishDate", new Date());


        }

        var editor = $("#blogEdit-editor").data("kendoEditor");
        editor.value(blogEditor.activeObj.content);
        editor.update();
        blogEditor.findLinks();

    },

    findLinks : function () {
        blogEditor._anchors = [];

        var content = blogEditor.activeObj.content;
        var regex = new RegExp(/<a[\s]+([^>]+)>((?:.(?!\<\/a\>))*.)<\/a>/g);
        var matches = regex.exec(content);

       var links = content.match(regex);

       for (var i=0; i<links.length; i++) {
           var link = links[i];

           var href = link.match(/href="([^"]*")/);
           var title = link.match(/title="([^"]*")/);
           var text = link.match(/>([^<]+)<\/a>/);


           var linkObj = {href: null, title: null, text: null};

           if (href !== null && href.length >  1) {
               linkObj.href = href[1];
           }

           if (text !== null && text.length >  1) {
               linkObj.text = text[1];
           }

           blogEditor._anchors.push(linkObj);
       }
       /* var doc = $('.bp-body td .k-editable-area .k-content html body');

        $('.bp-body td .k-editable-area .k-content html body a').each(function() {
            var link = {title: this.title, href : this.href};
            blogEditor._anchors.push(link);
        });*/
        ux.notify("Found " + blogEditor._anchors.length + " links...");
    },

    replaceImage : function () {

        cloudinary.openUploadWidget({ cloud_name: 'hyjvcxzjt', upload_preset: 'bpblog', public_id:  blogEditor.activeObj.slug, client_allowed_formats : ["png","gif", "jpeg"]  },
            function(error, result) {
                if (error === null && result.length > 0) {
                    var photo = result[0];
                    blogEditor.activeObj.set("imageUrl", photo.secure_url);
                    blogEditor.activeObj.set("dirty", true);
                    var blogObj = blogEditor.activeObj;

                    everlive.updateOne('blog', blogObj, function (err, data) {
                       if (err === null) {
                           blogEditor._updateIndex( function (status) {
                               if (status) {
                                   ux.notify("Updated Blog Preview photo ", 'success');
                               }
                           });
                       } else if (err.code === 801 ) {// Blog not found -- need to create it
                            everlive.createOne('blog', blogObj, function (err1, data1) {
                                if (err1 === null) {
                                    blogEditor._updateIndex( function (status) {
                                        if (status) {
                                            ux.notify("Updated Blog Preview photo ", 'success');
                                        }
                                    });
                                }
                            });

                        } else {
                           ux.notify("Error updating Blog Preview Photo " + JSON.stringify(err), 'error');
                        }

                    });

                }
            });

    },

    _updateIndex : function ( callback) {

        var bpurl = 'http://gaiaapi.herokuapp.com/updateblog?slug='+blogEditor.activeObj.slug;
        $.ajax({
            url: bpurl,
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            success: function(data) {
                if (data.status === 'OK') {
                    callback(true);
                } else {
                    callback(false)
                }

            }
        });
    },

    fetchBlogPhotos : function () {
        var fetchUrl = "/photolist?folder=blog";
        $.getJSON( fetchUrl, {
            format: "json"
        }).done(function( resObj ) {

            blogEditor._blogPhotos.data(resObj.photos);
            if (resObj.status === "OK")
                ux.notify ("Fetched blog " + resObj.photoCount+ " photos", "success");
            else
                ux.notify ("Error fetching blog photos " + JSON.stringify(resObj.error), "error");


        });
    },

    checkAnchors : function () {

        blogEditor._anchors = [];
        var target = $("#blogEdit-editor").siblings('iframe');

        var links = target[0].contentDocument.links;

        for (var i=0; i<links.length; i++) {
            var anchor = links[i];
            var linkObj = {
                href : anchor.href,
                targetText : anchor.outerHTML,
                title : anchor.text,
                hash: anchor.hash
            };

            blogEditor._anchors.push(linkObj);
            //Do your work
        }


    },

    addBlog : function () {
        ux.notify("Coming Soon...", 'success');
    },


    deleteBlog : function () {
        ux.notify("Coming Soon...", 'success');
    },


    addImage : function () {
        $("#blogPhotoEditor").modal("toggle");
    },

    addLink : function () {
        $("#blogLinkEditor").modal("toggle");
    },

    editImage : function (selection, objectId, url) {

        var editor = $("#blogEdit-editor").data("kendoEditor");
        var selection = editor.getSelection();


        $('#blogEditorPhoto-img').attr('src', url);
        $('#blogPhotoEditor-url').text(url);
        $('#blogPhotoEditor-error').addClass('hidden');

        if (url.indexOf('buyingpoultry.blob.core.windows.net') !== -1) {
            $('#blogPhotoEditor-error').removeClass('hidden');
            $('#blogPhotoEditor-errorMsg').html("This image is hosted on Azure!.   Migrating...");

            if (objectId === null) {
                objectId = uuid.v4();

            }

            blogEditor.uploadBlogPhoto(objectId, url, function (result) {
                var image = selection.focusNode.children[0];
                if (result.status === 'OK') {
                    image.src = result.photoUrl;
                    //image.currentSrc = result.photoUrl;
                    var replace = '<img src="'+result.photoUrl+'" >';
                    image.outerHTML = replace;
                    editor.update();
                    $('#blogPhotoEditor-url').text(result.photoUrl);
                    $('#blogEditorPhoto-img').attr('src', result.photoUrl);
                    $('#blogPhotoEditor-errorMsg').html("Image migrated to BP Cloud...");
                }

            });
        }
        
        $("#blogPhotoEditor").modal("toggle");
    },

    addGallery : function () {
        $("#blogPhotoGallery").modal("toggle");
    },

    updateGlossaryLink : function (link) {
        var html = '<a onclick="glossaryModal.onClick(event)" class="ff-link ff-glossary"  data-linktype="glossary" data-slug="'+link.slug+'" data-category="'+link.category+
            '"> '+ link.title +'</a>';

        var editor = $("#blogEdit-editor").data("kendoEditor");
        editor.paste(html);
    },

    addGlossary : function () {
        glossaryLinkEditor.open(null, function(link) {
            if (link !== null) {
                glossaryEditor.updateLink( glossaryEditor._selection, link);
            }
        });
    },

    addReference : function () {
        $("#blogReferenceModal").modal("toggle");
    },

    editGallery : function (selection, objectId, url) {

        $("#blogPhotoGallery").modal("toggle");
    },

    verifyLink : function () {
       var href =  blogEditor.activeLink.get('href');
        ux.notify("Verifying " + href + "...", "success");
        $('#linkEditor-linkStatus').html("Please review link (in new Tab) ");

        window.open(href, '_verify');

       /* $.get(
            href,
            function(data, textStatus, qXHR ){
                $('#linkEditor-linkStatus').html('<strong> Unreachable - please correct </strong>');
            }
        );*/
    },

    editLink : function (selection, title, href, target) {
        blogEditor.activeLink.set('title', title);
        blogEditor.activeLink.set('href', href);
        blogEditor.activeLink.set('target', target);
        blogEditor.activeLink.selection = selection;
        $('#linkEditor-linkStatus').html('');
        $("#blogLinkEditor").modal("toggle");
    },

    updateLink : function (selection, title, href, category) {

    },

    uploadBlogPhoto : function (objectid, url, callback) {
        var encodeUrl = encodeURIComponent(url);
        var bpurl = 'http://gaiaapi.herokuapp.com/uploadphoto?folder=blog&objectid='+objectid+'&url='+encodeUrl;
        $.ajax({
            url: bpurl,
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            success: function(data) {
                var respObj = {status: 'OK', publicId: null, photoId: null, photoUrl: null};
                if (data.status === 'OK') {
                    respObj.publicId = data.publicId;
                    respObj.photoId = data.photoId;
                    respObj.photoUrl = data.photoUrl;
                } else {
                    respObj.status = 'ERROR';
                }
                callback(respObj);
            }
        });
    },

    linkEditorUpdate : function () {

        var editor = $("#blogEdit-editor").data("kendoEditor");
        var selection = editor.getSelection();

        //var selection = blogEditor.activeObj.selection;
        var title =  blogEditor.activeLink.title;
        var href =  blogEditor.activeLink.href;
        var category =  blogEditor.activeLink.category;
        var target = blogEditor.activeLink.target;

        if (category === null) {
            category = 'Link'
        }
        selection.focusNode.parentNode.text = title;
        selection.focusNode.parentNode.href = href;

        var replace = '<a class="ghp_'+category+'" href="'+href+'" />' + title + '</a>';

        selection.focusNode.parentNode.outerHTML = replace;

        editor.update();

    },


    photoEditorUpdate : function () {

    },

    saveBlog : function () {
        var blogObj = blogEditor.activeObj;

        blogObj = JSON.parse(JSON.stringify(blogObj));
        var editor = $("#blogEdit-editor").data("kendoEditor");

        var content = editor.value();

        blogObj.content = content;

       everlive.updateOne('blog', blogObj, function (err, data) {

           if (err === null) {
               blogEditor._updateIndex( function (status) {
                   if (status) {
                       if (status)
                           ux.notify('"' + blogObj.title + '"' + " updated !" , 'success');
                       else
                           ux.notify('"' + blogObj.title + '"' + " was not updated" , 'error');
                   }
               });
           } else if (err.code === 801 ) {// Blog not found -- need to create it

               ux.notify('Adding "' + blogObj.title + '"' + " to Database..." , 'success');
               everlive.createOne('blog', blogObj, function (err1, data1) {
                   if (err1 === null) {
                       blogEditor._updateIndex( function (status) {
                           if (status) {
                               if (status)
                                   ux.notify('"' + blogObj.title + '"' + " updated !" , 'success');
                               else
                                   ux.notify('"' + blogObj.title + '"' + " was not updated" , 'error');
                           }
                       });
                   }

               });

           } else {
               ux.notify('"' + blogObj.title + '"' + " Error: " + JSON.stringify(err) , 'error');
           }

        });
    },

    close : function () {

        APP.router.navigate('#/blogList');
    }


};
/**
 * Created by donbrad on 3/22/17.
 */
'use strict';

var blogListView = {
    _initialized: false,

    blogsDS : new kendo.data.DataSource({pageSize: 8}),
    activeObj : new kendo.data.ObservableObject({siteName: null, siteSlug: null}),
    _pageSize : 128,

    init: function(){
        if(!blogListView._initialized){

            blogListView._initialized = true;

            $("#blogListsite-selector").kendoDropDownList({
                dataTextField: "name",
                dataValueField: "slug",
                dataSource: [
                    {name : 'All', slug: "all"},
                    {name : 'Farm Forward', slug: "farm-forward"},
                    {name : 'JIFA', slug: "jifa"},
                    {name : 'Better Food Foundation', slug: "bff"},
                    {name : 'Leadership-Circle', slug: "leadership-circle"},
                    {name : 'Buying Poultry', slug: "buying-poultry"}
                ],  // Todo : don fetch these from the sites collection
                change : function (e) {
                    var siteSlug = this.value();

                    blogListView.loadBlogsDS(siteSlug);
                }
            });

            $('#blogList-search-input').keyup (function () {
                var val =  $('#blogList-search-input').val();

                if (val.length > 0) {
                    blogListView.blogsDS.filter({field: 'title', operator: 'contains', value: val});
                } else {
                    blogListView.blogsDS.filter({});
                }

            });

            $('#blogList-search-input').change (function () {
                var val =  $('#blogList-search-input').val();

                if (val.length > 0) {
                    blogListView.blogsDS.filter({field: 'title', operator: 'contains', value: val});
                } else {
                    blogListView.blogsDS.filter({});
                }
            });

            $("#blogList-grid").kendoGrid({
                dataSource: blogListView.blogsDS,
                pageSize : 12,
                autoBind: false,
                pageable: true,
                resizable: true,
                sortable: true,
                reorderable: true,
                toolbar: [{name: "save", text: "Save All Changes..."}],
                editable: true,
                edit : function (e) {
                    var page = e.model;
                    /*var addItemFlag = e.model.isNew();

                     if (person.Id === undefined) {
                     person.Id = uuid.v4()
                     }

                     if (person.name !== undefined && person.name !== null) {
                     person.name = person.name.capitalize();
                     person.slug = ux.createSlug(person.name);
                     }

                     if (person.title !== undefined && person.title !== null) {
                     person.title = person.title.capitalize();
                     }*/

                },
                height: 760,
                columns: [
                    { field:"siteName",title:"Site", width: 120 },
                    { field:"title",title:"Title", width: 120 },
                    { field:"slug",title:"Slug", width: 80 },
                    { field:"publishDate",title:"Publish Date", width: 120},
                    { field:"authorName",title:"Author", width: 80 },
                    { title: "Edit", command: [ { text: "Edit Blog", click: blogListView.doEditBlog }, "destroy" ], width: 160,
                        attributes: {
                            style: "text-align: center;"
                        }
                    }
                ]
            });
            //  kendo.bind($("#contributorView-modal"), contributorView.activeObj);
        }
    },

    loadBlogsDS : function (siteSlug) {
        var blogs = null;
        if (siteSlug === null || siteSlug === 'all') {
            blogs = blogModel.blogDS.data();
        } else {
            blogs = blogModel.getSiteBlogs(siteSlug);
        }

        blogListView.blogsDS.data(blogs);
    },

    doEditBlog : function (e) {
        var thisBlog = this.dataItem($(e.currentTarget).closest("tr"));
        var blogSlug = thisBlog.slug;

        APP.router.navigate("/blogeditor?blogid=" + blogSlug);
        // Invoke pageEditor with pageSlug...
    },

    open: function (siteSlug) {
        blogListView.init();
        $('#blogList-search-input').val('');
        blogListView.loadBlogsDS(siteSlug);

    },

    close : function () {

    }

};
/**
 * Created by donbrad on 10/8/16.
 **/

'use strict';

var blogsView = {
    _onInit: false,
    _blogsFetched : false,
    _query : null,
    _hitCount : 0,
    _pageCount : 0,
    _processingTime : 0,
    _mostRecent: [],
    _queryHits : [],
    _tagFacet : null,
    blogsDS : new kendo.data.DataSource(),
    blogIndex : 0,

    activeObject : new kendo.data.ObservableObject({title: null, content: null, name: null, imageUrl: "images/icon-defaultProduct.svg"}),

    init : function () {
        if(!blogsView._onInit){
            $("#blogsView-list").kendoListView({
                dataSource:  blogsView.blogsDS,
                template: kendo.template($("#blogView-list-tmpl").html()),
                selectable: true,
                dataBound: function() {
                    var blogCount = this.dataSource._total;
                    var inputVal = $("#blog-searchbox").val();

                    if(blogCount >= 0){
                        $(".empty-blog").addClass("hidden");
                    } else {
                        $(".empty-blog").removeClass("hidden");
                        $(".empty-blog > p > span").text('"' + inputVal + '"');
                    }
                },
                change: function(e){
                    var blog = null;
                    var data = blogsView.blogsDS,
                        selected = $.map(this.select(), function(item) {
                            var uid = item.attributes['data-uid'].value;
                            blog = data.getByUid(uid);
                            var token = blog.slug;
                            APP.router.navigate("#/blog?blogid=" + token);
                        });
                }
            });


            var options = {
                callback: function (value) {
                    if (value.length === 0) {
                        blogsView.blogsDS.data(blogsView._mostRecent);
                    }  else {
                        ux.notify('Searching Blogs for "' + value + '"', 'success' );
                        blogsView.processQueryHits(value);
                    }

                },
                wait: 750,
                highlight: true,
                allowSubmit: false,
                captureLength: 3
            };

            $("#blog-searchbox").typeWatch( options );


            /*$("#blog-searchbox").on('input', function() {
                var query = this.value;
                blogsView._query = query;
                if (query.lenght === 0)
                    blogsView.blogsDS.data(blogsView._mostRecent);
                }
            });*/
            if (APP.socialFeed) {

                $('.social-feed-container').socialfeed({

                    // FACEBOOK
                    facebook: {
                        accounts: blogView._fbTags,
                        limit: 50,
                        access_token: '1769550126625987|ASkS_59vC41kbXLLlTIufigeX3M'
                    },
                    // Twitter
                    twitter: {
                        accounts: blogView._twitterTags,
                        limit: 50,
                        consumer_key: 'uLWcGWmebBDET8C1s5wM90NIp', // make sure to have your app read-only
                        consumer_secret: 'P95UdolvtVnhMG3rfleAm1enrjQU0ZQHb6Hjd8eE580p3ic0j4' // make sure to have your app read-only
                    },

                    // GENERAL SETTINGS
                    show_media: true,
                    length: 300,
                    update_period: 36000,
                    // When all the posts are collected and displayed - this function is evoked
                    callback: function() {
                        ux.notify("Social Feeds Loaded !", "success");
                    }
                });
            }

            blogsView._onInit = true;

            blogsView.getMostRecent();

        } /*else {
            blogsView.processQueryHits();
        }*/

        if (userView.isStaff() || userView.isBlogger()) {
            $('.bpstaff').removeClass('hidden');
            tagModel.init();
        } else {
            $('.bpstaff').addClass('hidden');
        }



    },

    openBlog: function(e){
        var blogSlug = e.target.dataset.slug;
        blogView.goToBlog(blogSlug);
    },

    getMostRecent : function () {

        blogsView._mostRecent = [];

        algolia.blogIndex.search('', {
            hitsPerPage: 5
        }, function (err, content) {
            if (err) {
                console.error(err);
                return;
            }

            blogsView.blogIndex = 0;
            blogsView._hitCount = content.nbHits;
            blogsView._pageCount = content.nbPages;
            blogsView._currentPage = content.page;
            blogsView._processingTime = content.processingTimeMS;
            blogView.activeObj.set('index', blogsView.blogIndex+1);

            blogView.activeObj.set('activeTag',  "Most Recent Blogs");

            for (var h in content.hits) {
                var hit = content.hits[h];
                var blogObj = {objectId: hit.objectID, id : hit.id, slug : hit.slug, author : hit.author, publishDate: hit.publishDate,
                    tags: hit.tags, categories : hit.categories, title: hit.title, content: hit.content,
                    imageUrl : hit.imageUrl };

                blogsView._mostRecent.push(blogObj);
            }

            blogsView.blogsDS.data(blogsView._mostRecent);
            blogView.activeObj.set('total',   blogsView.blogsDS.total());
        });
    },

    processQueryHits : function (query) {
        var options = {hitsPerPage : 1024};
        blogsView._queryHits = [];

        if (blogsView._tagFacet !== null) {
            options.facetFilters = blogsView._tagFacet;
        }

        blogsView._query = query;

        algolia.blogIndex.search(query, options, function (err, content) {
            if (err) {
                console.error(err);
                return;
            }
            blogsView.blogIndex = 0;
            blogsView._hitCount = content.nbHits;
            blogsView._pageCount = content.nbPages;
            blogsView._currentPage = content.page;
            blogsView._processingTime = content.processingTimeMS;


            blogView.activeObj.set('index', blogsView.blogIndex+1);


            var queryStats = blogsView._hitCount + ' results found in ' + blogsView._processingTime + ' ms.';

            $('#blogsView-queryStats').text(queryStats);

            for (var h in content.hits) {
                var hit = content.hits[h];
                var blogObj = {objectId: hit.objectID, id : hit.id, slug : hit.slug, author : hit.author, publishDate: hit.publishDate,
                    tags: hit.tags, categories : hit.categories, title: hit.title, content: hit.content,
                    imageUrl : hit.imageUrl };

                blogsView._queryHits.push(blogObj);
            }

            blogsView.blogsDS.data(blogsView._queryHits);
            var total =  blogsView.blogsDS.total();
            blogView.activeObj.set('total', total );
        });

    },

    onShow: function(){


    },

    processTags: function(tagsArray){
        var tagString = "";
        if (tagsArray!== undefined && tagsArray.length > 0) {
            for (var t=0; t<tagsArray.length; t++) {
                var anchor =' <a class="bp-tag gh-tag" data-tag="'+ tagsArray[t] +'" onclick="blogsView.tagClick(event)">' + tagsArray[t] + '</a> , ';
                tagString += anchor;

                tagString = tagString.substr(0, tagString.length-2);
            }
        }
        return tagString;
    },

    showTags: function (e) {
        $(e.target.offsetParent.children[2]).removeClass("text-clamp").css("width", "100%");
        $(e.target).addClass("hidden");
    },

    setTagFacet : function (tag) {
        blogsView._tagFacet = ['tags:'+tag];
        blogView.activeObj.set('tagName', blogsView._tagFacet);

        var anchor = '<a class="bp-tag" onclick="blogsView.clearTagFacet()">' +
            '<i class="material-icons">close</i>' +
            tag +
            '</a>';

        var viewanchor = '<a class="bp-tag" >' +
            tag +
            '</a>';

        $('#blogsView-activeTag').html(anchor);

        blogView.activeObj.set('activeTag', viewanchor);

        blogsView.processQueryHits(blogsView._query);
        $(".blogView-tag-active").removeClass("hidden");
    },

    clearTagFacet : function () {
        blogsView._tagFacet = null;

        blogView.activeObj.set('activeTag', 'All Blogs');
        $('#blogsView-activeTag').text('');
        blogsView.processQueryHits(blogsView._query);
        $(".blogView-tag-active").addClass("hidden");
    },

    tagClick : function (e) {
        var tagName = e.currentTarget.attributes['data-tag'].value;
        ux.notify('Filtering Blogs by ' + tagName, 'success');
        blogsView.setTagFacet(tagName);
    },

    hideTools : function () {
        $('.bpstaff').addClass('hidden');
        ux.notify("Refresh page to redisplay Staff tools","success");
    },

    editGlossary: function () {
        ux.notify("Coming Soon...", "success");
    },

    editTags: function () {
        ux.notify("Coming Soon...", "success");
    },

    editCategories: function () {
        ux.notify("Coming Soon...", "success");
    },


    editSocialFeed : function () {
        ux.notify("Coming Soon...", "success");
    }



};

var blogView = {
    _onInit: false,
    _twitterTags : [
        '@farmforward', '@buyingpoultry', '@JIFAnimals', '#farmforward', '#buyingpoultry', '#JIFAnimals'
    ],
    _fbTags : [
        "!farmforward", '!buyingpoultry', '!jewishinitiativeforanimals',  '@farmforward', '@buyingpoultry', '@jewishinitiativeforanimals'
    ],

    activeObj: new kendo.data.ObservableObject({
        id: null,
        title: null,
        author: null,
        authorSlug: null,
        authorTitle: null,
        slug: null,
        publishDate: null,
        description: null,
        index: 0,
        total : 0,
        activeTag : null,
        imageUrl: "images/icon-defaultProduct.svg",
        ux_nextBlogTitle: null
    }),

    init: function(){
      if(!blogView._onInit){
          kendo.bind($("#blogView"), blogView.activeObj);
          blogView._onInit = true;
      }

    },

    openModal : function (blogId) {
        if (userView.isStaff() || userView.isBlogger() ) {
            $('.bpstaff').removeClass('hidden');

        } else {
            $('.bpstaff').addClass('hidden');
        }

        blogView.updateActiveObj(blogId);

        $('#blogView-modal').modal('toggle');


    },

    goToBlog: function(slug){
        APP.router.navigate("/blog?blogid=" + slug);
    },

    showContribCard : function () {

        var slug = blogView.activeObj.authorSlug;
        contributorModal.open(slug);
    },

    goToNextPost: function(){
        var nextBlog = null;
        var total = blogsView.blogsDS.total();
        // get next post index
        blogsView.blogIndex++;

        if(blogsView.blogIndex >= total){
            blogsView.blogIndex = 0;
        }

        nextBlog = blogsView.blogsDS.at(blogsView.blogIndex);

        blogView.updateActiveObj(nextBlog.slug);
        blogView.activeObj.set('index', blogsView.blogIndex+1);
        ux.windowScrollReset();
        // update url
        var updatedUrl = "#/blog?blogid=" + nextBlog.slug;
        history.pushState({}, null, updatedUrl);
    },

    goToPrevPost: function(){

        var nextBlog = null;
        var total =  blogModel.blogDS.total();
        blogsView.blogIndex--;
        if(blogsView.blogIndex < 0){
            blogsView.blogIndex = total-1;
        }
        blogView.activeObj.set('index', blogsView.blogIndex+1);
        nextBlog = blogsView.blogsDS.at(blogsView.blogIndex);
        blogView.updateActiveObj(nextBlog.slug);
    },

    lookupNextBlog: function(){


        var nextBlogIndex = blogsView.blogIndex + 1;
        var total =  blogsView.blogsDS.total();
        if(nextBlogIndex >= total ){
            nextBlogIndex = 0;

        }

        var nextBlog = blogsView.blogsDS.at(nextBlogIndex);

        if(nextBlog !== undefined){
            blogView.activeObj.set("ux_nextBlogTitle", nextBlog.title);
        }

    },

    updateActiveObj: function(slug){

        var blog = blogModel.findBlogBySlug(slug);

        if(blog !== null && blog !== undefined){
            var title = _.unescape(blog.title);
            analyticsModel.sendGAEvent("blog", "read", title);

            blogView.activeObj.set("title", title);
            blogView.activeObj.set("id", blog.id);
            blogView.activeObj.set("slug", blog.slug);
            if (blog.author === undefined || blog.author === null) {
                blog.author = "Buying Poultry";
            }
            blogView.activeObj.set("author", blog.author);
            blogView.activeObj.set("profileUrl", 'images/icon-logo-brand-dark.png');


            var obj = contributorModel.findBySlug(blog.authorSlug);

            if (obj !== null) {
                blogView.activeObj.set("authorName", obj.name);
                blogView.activeObj.set("profileUrl", obj.profileUrl);
                blogView.activeObj.set("authorTitle", obj.title);
                blogView.activeObj.set("authorSlug", obj.slug);
            } else {
                var pObj = contributorModel.findByAlias(blog.author);

                if (pObj === null) {
                    pObj = contributorModel.findByName(blog.author);
                }

                if (pObj !== null) {
                    blogView.activeObj.set("authorName", pObj.name);
                    blogView.activeObj.set("profileUrl", pObj.profileUrl);
                    blogView.activeObj.set("authorTitle", pObj.title);
                    blogView.activeObj.set("authorSlug", pObj.slug);
                } else {
                    blogView.activeObj.set("authorName", blog.author);
                    blogView.activeObj.set("authorTitle", "Staff");
                    blogView.activeObj.set("authorSlug", blog.authorSlug);
                }
            }

            if (blog.authorSlug === undefined || blog.authorSlug === null) {
                blog.authorSlug = ux.createSlug(blog.author);
            }



            blogView.activeObj.set("content", blog.content);

            if(blogView.imageUrl !== null && blogView.imageUrl !== ""){
                blogView.activeObj.set("imageUrl", blog.imageUrl);
            }
            // set date
            if(blogView.activeObj.CreatedAt !== null){
                var date = moment(blogView.activeObj.publishDate);
                var formattedDate = moment(blog.publishDate).format('MMM Do, YYYY');
                blogView.activeObj.set('publishDate', formattedDate);
            }

            var processedTags = blogsView.processTags(blog.tags);
            blogView.activeObj.set("processedTags", processedTags);

            shareModel.setShare("Buying Poultry", blog.title, 'http://www.buyingpoultry.tech/#/blog?blogid='+blog.slug);


        } else {
            ux.bpAlert("Error loading blog post", "error");
            APP.router.navigate("/blog");
        }
        blogView.lookupNextBlog();

    },

    onShow: function(slug){
        if (userView.isStaff()) {
            $('.bpstaff').removeClass('hidden');

        } else {
            $('.bpstaff').addClass('hidden');
        }
        blogView.updateActiveObj(slug);
    },



    newBlog : function () {
        APP.router.navigate("/blogedit");
    },

    editBlog : function () {
        APP.router.navigate("/blogedit?blogid=" + blogView.activeObj.slug);
    },

    deleteBlog : function () {
        var blogId = blogView.activeObj.slug;
        ux.toggleConfirm("delete", function(){
            // todo - wire delete blog
            ux.closeConfirm();
            ux.notify("Blog post deleted", "danger");

        }, null)
    }
};

'use strict';

var brandEditor = {

    activeObj: new kendo.data.ObservableObject({
        brandName: null,
        category : 'Avoid',
        gradeName : null,
        gradeScore : null,
        productCount: 0,
        retailerCount : 0,
        highScore: 0,
        lowScore : 0,
        productCategories : ['Chicken'],
        brandType : "National",
        brandId : null,
        facebookId : null,
        twitterId : null,
        regionStatesList : [],
        address: null,
        objectID : null,
        brandUrl : null,
        brandImageUrl : null

    }),
    _uploadWidget : null,

    _cloudinary : { cloud_name: 'hyjvcxzjt', upload_preset: 'bpbrand', client_allowed_formats : ["png","gif", "jpeg"]  },
    productDS : null,
    _highestProductRating: 0,
    _lowestProductRating: 0,
    retailerDS : null,

    retailerHash : [],
    missingRetailerList : [],

    _defaultBrandImageUrl : 'http://res.cloudinary.com/hyjvcxzjt/image/upload/v1483036299/product/icon-defaultProduct.png',
    isInit: false,
    initialized : false,
    _productSyncRequired : false,

    init : function () {

        if (brandEditor.initialized) {
            return;
        }

        brandEditor.initialized = true;


        brandEditor.activeObj.bind("change", function(e) {
            if (e.field === 'name') {
                var url = "http://www.google.com/#q=" + brandEditor.activeObj.brandName;
                brandEditor.activeObj.set('searchUrl', url);
                var name = brandEditor.activeObj.brandName;
                var slug = ux.createSlug(name);
                brandEditor.activeObj.set('slug', slug);
                brandEditor.findName(name);
            }

        });

        $('#brandEdit-gradeScore').change( function () {
                var score = $('#brandEdit-gradeScore').val();

                var rating = ux.computeRating(score);

                brandEditor.activeObj.set('gradeName', rating.gradeName);
                brandEditor.activeObj.set('category', rating.category);


                var categoryStr = rating.category.toLowerCase();
                switch(categoryStr){
                    case "best":
                        $("#brandEditor-brand .bp-rating").removeClass("bp-best bp-better bp-avoid").addClass("bp-best");
                        break;
                    case "better":
                        $("#brandEditor-brand .bp-rating").removeClass("bp-best bp-better bp-avoid").addClass("bp-better");
                        break;
                    case "avoid":
                        $("#brandEditor-brand .bp-rating").removeClass("bp-best bp-better bp-avoid").addClass("bp-avoid");
                        break;
                }
            }
        );


        $("#brandEditor-productCategories").kendoMultiSelect({
            value: brandEditor.activeObj.productCategories
        });

        $("#brandEditor-brandType").kendoDropDownList({
            dataSource : ["National", "Regional", "Local"],
            change: function(e) {
                var value = this.value();
                brandEditor.updateUX(value);
            }
        });

        $("#brandEditor-regionStates").kendoMultiSelect({
            dataSource : new kendo.data.DataSource({
                transport: {
                    read: {
                        url: "data/usstates.json",
                        dataType: "json"
                    }
                }
            }),
            dataTextField: "name",
            dataValueField: "name"

        });

        brandEditor.retailerDS = new kendo.data.DataSource({pageSize: 10});

        brandEditor.productDS = new kendo.data.DataSource({
            pageSize: 6,
            schema: {
                model: {
                    id: "Id",
                    fields: {
                        objectID: { editable: true, nullable: false },
                        productImage : { editable: true, nullable: true },
                        productName: { validation: { required: true } },
                        gradeName: { validation: { required: true } },
                        gradeScore: { validation: { required: true } },
                        category: {  validation: { required: true } },
                        claims: {   },
                        certifications: { },
                        productCategory: {  validation: { required: true } }
                    }
                }
            }
        });

        $("#brandEditor-productGrid").kendoGrid({
            dataSource: brandEditor.productDS,
            pageable: true,
            pageSize: 6,
            resizable: true,
            reorderable: true,
            editable: true,
            edit : function (e) {
                var product = e.model;
                var addProduct = e.model.isNew();
                if (addProduct ) {


                    // Set Default values for new product...
                    var guid = uuid.v4();
                    product.set('Id', guid);
                    product.set('productId', guid);
                    product.set('objectID', guid);
                    product.set('brandId', brandEditor.activeObj.brandId);
                    product.set('brandName', brandEditor.activeObj.brandName);
                    product.set('brandUrl', brandEditor.activeObj.brandUrl);
                    product.set('brandImage', brandEditor.activeObj.brandImageUrl);
                    product.set('productName', brandEditor.activeObj.brandName);
                    product.set('productImage', brandEditor.activeObj.brandImageUrl);
                    product.set('category', 'Avoid');
                    product.set('productCategory', 'Chicken');
                    product.set('claims', []);
                    product.set('claimString', null);
                    product.set('certifications', []);
                    product.set('certificationString', null);
                    product.set('gradeScore', '1');
                    product.set('gradeName', 'F');

                    if (brandEditor.productDS.total() > 0) {
                        // if there's an existing product for the brand, use those defaults to save some time
                        var len =  brandEditor.productDS.total();
                        var templateProd = brandEditor.productDS.at(len-1);

                        product.set('category', templateProd.category);
                        product.set('productCategory', templateProd.productCategory);
                        product.set('claims', templateProd.claims);
                        product.set('claimString',  templateProd.claimString);
                        product.set('certifications', templateProd.certifications);
                        product.set('certificationString', templateProd.certificationString);
                        product.set('gradeScore', templateProd.gradeScore);
                        product.set('gradeName',  templateProd.gradeName);
                    }

                    this.saveChanges();

                    brandEditor.addProduct(product);


                } else {
                    // update product
                    brandEditor.updateProduct(product);
                }
            },
            remove : function (e) {
                var product = e.model;
                if (confirm("Do you want to delete " + product.productName + " ?")) {
                    brandEditor.deleteProduct(product);
                }
            },

            save : function (e) {
                var product = e.model;
                brandEditor.updateProduct(product);
            },

            height: 760,
            toolbar: [{name: "create", text: "Add Product"}, {name: "save", text: "Save All Products"}],
            columns: [
                { field:"productImage", title:"Image", template: brandEditor._imageTemplate, width: 96, editor: brandEditor._imageEditor },
                { field:"productName",title:"Name", width: 160 },
                { field:"category",title:"Rating", editor: brandEditor._readOnly, width: 60},
                { field:"gradeName",title:"Grade" , editor: brandEditor._readOnly, width: 60},
                { field:"gradeScore",title:"Score", editor: brandEditor._gradeScoreEditor, width: 60 },
                { field:"certifications", title:"Certifications", width: 240, template: function(dataItem) {
                    var html = [];

                    for (var i = 0; i < dataItem.certifications.length; i++) {
                        html.push( dataItem.certifications[i]);
                    }

                    var certString = html.join(', ');
                    dataItem.certificationsString = certString;
                    return certString;
                }, editor : brandEditor._certificationEditor
                },
                { field:"claims",title:"Claims",  width: 240, template: function(dataItem) {
                    var html = [];

                    for (var i = 0; i < dataItem.claims.length; i++) {
                        html.push( dataItem.claims[i]);
                    }

                    var claimString = html.join(', ');
                    dataItem.claimString = claimString;

                    return claimString;
                }, editor : brandEditor._claimEditor
                },
                { field:"productCategory",title:"Type" , editor: brandEditor._typeEditor, width: 100},
                { command: [{name: "destroy", text: "Delete"}, {text: "Search", click: brandEditor.doProductSearch }],  width: 120 }
            ]
        });

        $('#brand-search-input').addClear({top: 13, right: 36});
        $('#brand-search-input').autocomplete(
            {hint: false}, [
                {
                    source: $.fn.autocomplete.sources.hits(algolia.retailerIndex, {hitsPerPage: 10 }),
                    displayKey: 'name',
                    templates: {
                        //'suggestion' templating function used to render a single suggestion
                        suggestion: function(suggestion) {

                            var itemHtml = null;
                            var objectId = suggestion.retailerId.toString();

                            if (brandEditor.retailerHash[objectId] === undefined) {
                                // Only display results that aren't aleady in the list...
                               itemHtml = '<div onclick="brandEditor.addRetailer(event)" data-retailerId="' + suggestion.retailerId +
                                    '" data-retailerName="' + suggestion.name +'"><span>' + '<i class="material-icons">add</i>  ' +
                                    suggestion._highlightResult.name.value + '</span><span style="float: right;">' +
                                    suggestion.category + '</span></div> <div style="clear:both;"></div>';

                            } else {
                                itemHtml = '<div data-retailerId="' + suggestion.retailerId +
                                    '" data-retailerName="' + suggestion.name +'"><span>' + '<i class="material-icons">done</i>  ' +
                                    suggestion._highlightResult.name.value + '</span><span style="float: right;">' +
                                    suggestion.category + '</span></div> <div style="clear:both;"></div>';

                            }

                            return itemHtml;

                        }
                    }
                }
            ]);

        $('#brand-search-input').keyup(function () {
            var val =  $('#brand-search-input').val();

            if (val.length > 0) {
                brandEditor.retailerDS.filter({field: 'name', operator: 'contains', value: val});
            } else {
                brandEditor.retailerDS.filter({});
            }

        });

        $("#brandEditor-retailerGrid").kendoGrid({
            dataSource: brandEditor.retailerDS,
            pageSize: 10,
            pageable: true,
            resizable: true,
            sortable: true,
            reorderable: true,
            editable: { //disables the deletion functionality
                update: false,
                destroy: true
            },
            remove : function (e) {
                var retailer = e.model;
                if (confirm("Do you want to delete " + retailer.name + " ?")) {
                   brandEditor.deleteRetailer(retailer);
                }
            },
            //toolbar: kendo.template($("#BrandRetailer-gridSearchtemplate").html()),
            height: 560,
            columns: [
                { field:"name",title:"Name", width: 240 },
                { field:"retailerId",title:"Id", width: 60 },
                { field:"category", title:"Rating", width: 60},
                { field:"gradeName",title:"Grade" ,  width: 60},
                { field:"gradeScore",title:"Score",  width: 60 },
                { command: [{name: "destroy", text: "Delete", click: brandEditor.doDeleteRetailer}, {text: "Search", click: brandEditor.doRetailerSearch }],  width: 120 }
            ]
        });
    },

    _imageTemplate : function (dataItem) {
        var url = dataItem.productImage;

        if (url === undefined || url === null || url.indexOf('cloudinary') === -1) {
            url = 'images/icon-defaultProduct.png';
        }

        var htmlCode = '<div class="grid-image-container"> <img class="grid-image-img" onerror="brandEditor.imgError(event)"src="' + url + '"/> </div>';

        return(htmlCode);
    },

    imgError : function (e) {

    },

    doDeleteRetailer : function (e) {

    },


    updateUX : function (retailType) {

        switch (retailType) {

            case "National":
                $("#brandEditor-regionStates-li").addClass('hidden');
                $("#brandEditor-address-li").addClass('hidden');
                break;

            case "Regional":
                $("#brandEditor-regionStates-li").removeClass('hidden');
                $("#brandEditor-address-li").addClass('hidden');
                break;

            case "Local":
                $("#brandEditor-regionStates-li").addClass('hidden');
                $("#brandEditor-address-li").removeClass('hidden');
                break;

        }

    },

    doProductSearch : function (e) {
        e.preventDefault();

        var dataItem = this.dataItem($(e.currentTarget).closest("tr"));

        var url = "https://www.google.com/#q=" + dataItem.productName;

        window.open(url, "_blank");
    },

    doRetailerSearch : function (e) {
        e.preventDefault();

        var dataItem = this.dataItem($(e.currentTarget).closest("tr"));

        var url = "https://www.google.com/#q=" + dataItem.name;

        window.open(url, "_blank");
    },

    addProduct : function (product) {
        everlive.createOne('product', product, function (err, data) {
            if (err !== null) {
                ux.notify("Couldn't create Product " + JSON.stringify(err), 'error');
            }
            brandEditor._updateProductIndex(product.productId, function() {
                if (status) {
                    ux.notify(product.productName + " added to Product Index ", 'success');
                }
            })
        })

    },

    updateProduct : function (product) {
        everlive.updateOne('product', product, function (err, data) {
            if (err !== null) {
                ux.notify("Couldn't create Product " + JSON.stringify(err), 'error');
            }
            brandEditor._updateProductIndex(product.productId, function() {
                if (status) {
                    ux.notify(product.productName + " added to Product Index ", 'success');
                }
            })
        });

    },

    deleteProduct : function (product) {
        var productId = product.Id;
        var productName = product.productName;

        ux.notify("Removing " + productName + " ...");
        everlive.deleteOne('product', product, function(err, data) {
            if (err !== null) {
                ux.notify("Error removing " + productName + " from Database " + JSON.stringify(err), 'error');
            }
        });

        algolia.deleteObjectFromIndex('product', productId, function (status) {
            if (!status) {
                ux.notify("Error removing " + productName + " from Index", 'error');
            }
        });

        brandEditor.productDS.remove(product);

    },


    deleteProducts : function () {

        var index = 0, count = brandEditor.productDS.total();

        function getNext () {
            var product = brandEditor.productDS.at(index);

            var productId = product.Id;
            var productName = product.productName;

            ux.notify("Removing " + productName + " ...");
            everlive.deleteOne('product', product, function(err, data) {
                if (err !== null) {
                    ux.notify("Error removing " + productName + " from Database " + JSON.stringify(err), 'error');
                }

                algolia.deleteObjectFromIndex('product', productId, function (status) {
                    if (!status) {
                        ux.notify("Error removing " + productName + " from Index", 'error');
                    }
                    index++;
                    if (index < count) {
                        return getNext();
                    }
                });
            });

            brandEditor.productDS.remove(product);
        }

        if (count === 0) {
            return;
        }

        getNext();
    },


    deleteBrand : function () {
        ux.toggleConfirm('delete', brandEditor._deleteBrand, 'brandEditor');
    },

    _deleteBrand : function () {

        ux.closeConfirm();

        var productCount = brandEditor.productDS.total();
        var retailerCount = brandEditor.retailerDS.total();

        var brandId = brandEditor.activeObj.Id;
        var brandName = brandEditor.activeObj.brandName;

        ux.notify("Deleting " + productCount + " products...");

        brandEditor.deleteProducts();

        ux.notify("Removing " + brandEditor.activeObj.brandName + " from  " + retailerCount + " retailers...");

        brandEditor.deleteRetailers();

        ux.notify("Deleting " + brandName + " ...");

        everlive.deleteOne('brand', brand, function(err, data) {
            if (err !== null) {
                ux.notify("Error removing " + brandName + " from Database " + JSON.stringify(err), 'error');
            }
        });

        algolia.deleteObjectFromIndex('brand', brandId, function (status) {
            if (!status) {
                ux.notify("Error removing " + brandId + " from Index", 'error');
            }
        });



    },


    syncRetailer : function (retailerId, addMode) {

        everlive.readOne('retailer', retailerId, function (err, data) {
            if (err !== null) {
                ux.notify("Error fetching Retailer" + JSON.stringify(err), 'error');
            }

            var retailer = data.result;
            var brandId = brandEditor.activeObj.brandId.toString();
            var brandName = brandEditor.activeObj.brandName;
            var brandIndex = 0;
            var found = false;
            for (var i=0; i<retailer.brandIdList.length; i++) {
                if (brandId === retailer.brandIdList[i].toString())
                    found = true;
                    brandIndex = i;
            }

            if (!found) {
                // Brand is NOT in this retallers list
                if (addMode) {
                    // Add it
                    retailer.brandIdList.push(brandId);
                    retailer.brandList.push(brandName);
                }

            } else {
                //Brand is this retailers list
                if (!addMode) {
                    //addMode == false is Delete so delete it
                    retailer.brandIdList.splice(index,1);
                    retailer.brandList.splice(index,1);
                }


            }
            everlive.updateOne('retailer', retailer, function (err1, data1) {

                if (err1 !== null) {
                    ux.notify("Error updating Retailer Database " + JSON.stringify(err), 'error');
                }

                retailEditor._updateIndex(retailer.retailerId, function (status) {
                    if (!status) {
                        ux.notify("Error updating Retailer Index ", 'error');
                    }

                });
            });

        });

    },

    deleteRetailers : function () {
        var index = 0;
        var count = brandEditor.activeObj.retailerIdList.length;

        if (count === 0) {
            return;
        }

        function getNext () {
            var retailerId =  brandEditor.activeObj.retailerIdList[index];

            everlive.readOne('retailer', retailerId, function (err, data) {
                if (err !== null) {
                    ux.notify("Error fetching Retailer" + JSON.stringify(err), 'error');
                }

                var retailer = data.result;
                var brandId = brandEditor.activeObj.brandId.toString();
                var brandName = brandEditor.activeObj.brandName;
                var brandIndex = 0;
                var found = false;
                for (var i=0; i<retailer.brandIdList.length; i++) {
                    if (brandId === retailer.brandIdList[i].toString())
                        found = true;
                    brandIndex = i;
                }

                if (found) {

                    retailer.brandIdList.splice(index, 1);
                    retailer.brandList.splice(index, 1);


                    everlive.updateOne('retailer', retailer, function (err1, data1) {

                        if (err1 !== null) {
                            ux.notify("Error updating Retailer Database " + JSON.stringify(err), 'error');
                        }

                        retailEditor._updateIndex(retailer.retailerId, function (status) {
                            if (!status) {
                                ux.notify("Error updating Retailer Index ", 'error');
                            }
                            index++;
                            if (index < count) {
                                return getNext();
                            }
                        });
                    });
                } else {
                    index++;
                    if (index < count) {
                        return getNext();
                    }
                }

            });
        }

        getNext();

    },


    deleteRetailer : function (retailer) {

        var retailerId = retailer.Id;
        retailerId = retailerId.toString();
        brandEditor.retailerHash[retailerId] = undefined;

        var found = false;
        var retailerIndex = 0
        for (var i=0; i<brandEditor.activeObj.retailerIdList.length; i++) {
            if (retailerId === brandEditor.activeObj.retailerIdList[i].toString())
                found = true;
            retailerIndex = i;
        }

        if (found) {
            brandEditor.activeObj.retailerIdList.splice(retailerIndex, 1);
            brandEditor.activeObj.retailerList.splice(retailerIndex, 1);
            brandEditor.syncRetailer(retailerId, false);
        }


    },


    addRetailer : function (e) {
        var retailerId = e.currentTarget.attributes['data-retailerId'].value;
        var retailerName = e.currentTarget.attributes['data-retailerName'].value;

        brandEditor.retailerHash[retailerId] = retailerName;
        brandEditor.activeObj.retailerList.push(retailerName);
        brandEditor.activeObj.retailerIdList.push(retailerId);

        brandEditor.updateBrand();

        algolia.retailerIndex.getObject(retailerId, function (err, content) {
            if (err) {
                ux.notify("Error fetching " + data.brandName + "'s products : " + JSON.stringify(err), 'error');
                return;
            }

            var retail = content;

            brandEditor.retailerDS.add(retail);
            brandEditor.syncRetailer(retail.retailerId, true);

        });
    },

    openModalByObjectId : function (objectId) {
        algolia.brandIndex.getObject(objectId, function (err, content) {
            if (err === null) {
                ux.notify("Loading " + content.brandName);
                brandEditor.open(content);
            } else {
                ux.notify("Sorry,  Couldn't locate this brand!");
            }

        });
    },

    openModalByBrandToken : function (token) {

        algolia.brandIndex.search(token, function (err, content) {
            if (err === null) {
                var brand = content.hits[0];
                ux.notify("Loading " + brand.brandName);
                brandEditor.open(brand);
            } else {
                ux.notify("Sorry,  Couldn't locate this brand!");
            }

        });
    },

    openModalByBrandId : function (brandId) {

        algolia.brandIndex.search('', {facetFilters : ['brandId:'+brandId] },function (err, content) {
            if (err === null) {
                if (content.hits !== null) {
                    var brand = content.hits[0];
                    if (brand !== null) {
                        brandEditor.open(brand);
                    } else {
                        ux.notify("Sorry,  Couldn't locate this brand!", 'error');
                    }
                } else {
                    ux.notify("Sorry,  Couldn't locate this brand!", 'error');
                }

            } else {
                ux.notify("Sorry,  Couldn't locate this brand!", 'error');
            }

        });
    },

    addBrand : function () {
        var data = {
            mode: 'add',
            brandName: null,
            category : 'Avoid',
            gradeName : 'F',
            gradeScore : 0,
            highScore: 0,
            lowScore : 0,
            productCount: 0,
            retailerCount : 0,
            productCategories : ["Chicken"],
            brandType : "National",
            brandId : null,
            objectID : null,
            Id : null,
            retailerList : [],
            retailerIdList : [],
            regionStatesList : [],
            address : null,
            facebookId : null,
            twitterId : null,
            brandUrl : null,
            brandStoreUrl : null,
            brandImageUrl : null

        };

        var guid = uuid.v4();
        // All new brands have a uuid rather than a simple integer
        data.Id = guid;
        data.objectID = guid;
        data.brandId = guid;

        // Need to create brand as host for any products added
        everlive.createOne('brand', data, function (err, data) {
            if (err !== null) {
                ux.notify("Error creating brand " + JSON.stringify(err), 'error');
                return;
            }
            brandEditor._updateBrandIndex(data.brandId, function (status) {
                if (!status) {
                    ux.notify("Error creating brand in Index", 'error');
                } else {
                    APP.router.navigate('#/brandeditor?brandid='+ data.brandId);
                }
            });
        });
    },

    _updateBrandUrl : function (brandId) {
        var newUrl = '#/brandeditor?brandid='+brandId;
        history.pushState({}, null, newUrl);
    },

    checkImageStore : function () {
        var url = brandEditor.activeObj.brandImageUrl;

        if (url === undefined || url === null) {
            brandEditor.activeObj.set('brandImageUrl', brandEditor._defaultBrandImageUrl);
            return;
        }

        if (url.indexOf('blob.core') !== -1) {
            ux.notify('Migrating Azure Image to BP Cloud', 'success');
        }
    },


    replaceImage : function () {
        var publicId = brandEditor.activeObj.brandId;

        ux.notify("Deleting current Brand image from cloud ...", 'success');

        brandEditor.activeObj.set('brandImageUrl', brandEditor._defaultBrandImageUrl);

        brandEditor._deleteBrandPhoto(publicId, function (status) {

            if (!status) {
                ux.notify("Error deleting current image from cloud ...", 'error');
                return;
            }

            brandEditor._productSyncRequired = true;

            cloudinary.openUploadWidget({ cloud_name: 'hyjvcxzjt', upload_preset: 'bpbrand', public_id: publicId , client_allowed_formats : ["png","gif", "jpeg"]  },
                function(error, result) {

                    if (error === null && result.length > 0) {
                        var photo = result[0];
                        brandEditor.activeObj.set('brandImageUrl', photo.secure_url);

                        var brandObj = brandEditor.activeObj;
                        brandObj.dirty = true;
                        everlive.updateOne('brand', brandObj, function (err, data) {
                            brandEditor._updateBrandIndex(brandObj.brandId, function (status) {
                                if (status) {
                                    ux.notify("Updated brand photo ", 'success');
                                }
                            });
                            // Call the index update function...
                        });
                    }
                });
        });

    },

    findName : function (name) {

        algolia.brandIndex.search(name, function (err, content) {
            if (err === null) {
                if (content.hits !== null || content.hits.length > 0) {
                    var names = [];
                    for (var i=0; i< content.hits.length; i++) {
                        names.push(content.hits[i].name);
                    }

                    var nameStr = names.join(', ');

                    ux.notify("Name matches existing Brands :  " + nameStr, 'error');
                } else {
                    ux.notify("Unique Name - no Brands match : " + name, 'success');
                }

            } else {
                ux.notify("Error Searching Brand names " + JSON.stringify(err), 'error');
            }

        });
    },


    // Find Retailers that reference this brand
    findRetailers : function () {

        var brandId = brandEditor.activeObj.brandId;

        algolia.retailerIndex.search('', {
            hitsPerPage: 2048,
            attributesToRetrieve : ['objectID', 'name'],
            facetFilters : ['brandIdList:'+ brandId] },function (err, content) {
            if (err === null) {

                var indexTotal = content.nbHits;
                var total = brandEditor.activeObj.retailerIdList.length;
                if (indexTotal !==  total) {
                    ux.notify("Retailer Index out of sync - " + total + " (database) : " + indexTotal + " (index)", 'error');
                    ux.notify("Please wait - resyncing retailers... ", 'success');
                    var hits = content.hits, len = content.nbHits;

                    brandEditor.activeObj.retailerIdList = [];
                    brandEditor.activeObj.retailerList = [];
                    for (var i=0; i< len; i++) {
                        var hit = hits[i];
                        brandEditor.activeObj.retailerIdList.push(hit.objectID);
                        brandEditor.activeObj.retailerList.push(hit.name);
                    }

                    brandEditor._fetchRetailers(brandEditor.activeObj.retailerIdList);

                } else {
                    ux.notify("Retailer Index in sync", 'success');
                }

            } else {
                ux.notify("Error searching retailers : " + JSON.stringify(err), 'error');
            }

        });

    },

    // Find Products that reference this brand
    findProducts : function () {

        var brandId = brandEditor.activeObj.brandId;

        algolia.productIndex.search('', {facetFilters : ['brandId:'+ brandId] },function (err, content) {
            if (err === null) {
                brandEditor.productDS.data(content.hits);
                var total = brandEditor.productDS.total();
                brandEditor.activeObj.set("productCount", total);
              //  $('#brandEditor-productCount').text(total);
                $('#brandEditor-productGrid').data('kendoGrid').refresh();
                brandEditor.calculateBrandRating();
            } else {
                ux.notify("Error searching products : " + JSON.stringify(err), 'error');
            }

        });

    },


    open: function(data){

        if(!brandEditor.isInit){
            brandEditor.isInit = true;
            $('[data-toggle="tooltip"]').tooltip();
        }

        brandEditor.init();

        brandEditor._productSyncRequired = false;

        if (userView.isStaff()) {
            $('.bpstaff').removeClass('hidden');

        } else {
            $('.bpstaff').addClass('hidden');
        }

        if (brandEditor.retailerDS !== null)
            brandEditor.retailerDS.data([]);
        if (brandEditor.productDS !== null)
            brandEditor.productDS.data([]);

        brandEditor.retailerHash = [];


        if (data.mode !== undefined ) {
            if ( data.mode === 'add') {
                brandEditor._editMode = false;
                delete data.mode;
            }
            brandEditor._editMode = true;
        } else {
            brandEditor._editMode = true;
        }


        if (data.brandStoreUrl === undefined) {
            data.brandStoreUrl = null;
        }

        brandEditor.activeObj.set('Id', data.Id);
        brandEditor.activeObj.set('objectID', data.objectID);
        brandEditor.activeObj.set("brandId", data.brandId);
        brandEditor.activeObj.set("brandName", data.brandName);
        var rating = ux.computeRating(data.gradeScore);
        brandEditor.activeObj.set("category", rating.category);
        brandEditor.activeObj.set("gradeScore", rating.gradeScore);
        brandEditor.activeObj.set("gradeName", rating.gradeName);
        brandEditor.activeObj.set("brandUrl", data.brandUrl);
        brandEditor.activeObj.set("brandStoreUrl", data.brandStoreUrl);
        brandEditor.activeObj.set("isRecommended", data.isRecommended);
        brandEditor.activeObj.set("overrideGrade", data.overrideGrade);

        if (data.productCount === undefined || data.productCount === null) {
            data.productCount = 0;
        }


        if (data.retailerCount === undefined || data.retailerCount === null) {
            data.retailerCount = 0;
        }

        // category
        var categoryStr = data.category.toLowerCase();
        switch(categoryStr){
            case "best":
                $("#brandEditor-brand .bp-rating").removeClass("bp-best bp-better bp-avoid").addClass("bp-best");
                break;
            case "better":
                $("#brandEditor-brand .bp-rating").removeClass("bp-best bp-better bp-avoid").addClass("bp-better");
                break;
            case "avoid":
                $("#brandEditor-brand .bp-rating").removeClass("bp-best bp-better bp-avoid").addClass("bp-avoid");
                break;
        }

        brandEditor.activeObj.set("searchUrl", 'https://www.google.com/#q='+data.brandName);


        if (data.brandType !== undefined && data.brandType !== null) {
            brandEditor.activeObj.set("brandType", data.brandType);
        } else {
            brandEditor.activeObj.set("brandType",'National');
        }

        brandEditor.updateUX(brandEditor.activeObj.brandType);

        if (data.productCategories !== undefined) {
            if (data.productCategories !== null && data.productCategories.length > 0 && data.productCategories[0] === null) {
                data.productCategories = [];
            }
            brandEditor.activeObj.set("productCategories", data.productCategories);
        } else {
            brandEditor.activeObj.set("productCategories",["Chicken"]);
        }

        if(data.brandImageUrl !== null){

            brandEditor.activeObj.set("brandImageUrl", data.brandImageUrl);

            brandEditor.checkImageStore();
        } else {
            brandEditor.activeObj.set("brandImageUrl", brandEditor._defaultBrandImageUrl);
        }

        if (data.regionStatesList === undefined || data.regionStatesList === null) {
            data.regionStatesList = [];
        }


        var regionStatArray = [];

        if (data.regionStatesList.length > 0 && data.regionStatesList[0].name !== undefined) {
            // Flatten the state object to corrent kendo multiselect value bug...
            for (var j=0; j<data.regionStatesList.length; j++) {
                regionStatArray.push (data.regionStatesList[j].name);
            }
            data.regionStatesList = regionStatArray;
        }

        brandEditor.activeObj.set("regionStatesList", data.regionStatesList);


        if (data.address === undefined || data.address === null) {
            data.address = null;
        }
        brandEditor.activeObj.set("address", data.address);

        if (data.retailerList === undefined || data.retailerList === null) {
            data.retailerList = [];
        }
        brandEditor.activeObj.set("retailerList", data.retailerList);

        if (data.retailerIdList === undefined || data.retailerIdList === null) {
            data.retailerIdList = [];
        }
        brandEditor.activeObj.set("retailerIdList", data.retailerIdList);

        if (brandEditor._editMode) {
            algolia.productIndex.search('', {facetFilters: ["brandId:" + data.brandId] }, function (err, content) {
                if (err) {
                    ux.notify("Error fetching " + data.brandName + "'s products : " + JSON.stringify(err), 'error');
                    return;
                }
                brandEditor.productDS.data(content.hits);
                var total = brandEditor.productDS.total();
                brandEditor.activeObj.set("productCount", total);
                $('#brandEditor-productCount').text(total);
                $('#brandEditor-productGrid').data('kendoGrid').refresh();
                brandEditor.calculateBrandRating();
            });


            if (brandEditor.activeObj.retailerIdList !== null && brandEditor.activeObj.retailerIdList.length > 0) {
                var objectList = [];
                // Create a vanilla list of strings...
                for (var i=0; i< brandEditor.activeObj.retailerIdList.length; i++ ) {
                    objectList.push(brandEditor.activeObj.retailerIdList[i]);
                }

                brandEditor._fetchRetailers(objectList);
            }

            brandEditor.findRetailers();
        }

    },

    calculateBrandRating : function () {
        var ratingHigh = 0, ratingLow = 11;
        var count = brandEditor.productDS.total();

        if (count === 0) {

            brandEditor.activeObj.set('category', "Unrated");
            brandEditor.activeObj.set('gradeScore',0);
            brandEditor.activeObj.set('gradeName',"?");
            return;
        }


        for (var i=0; i<count; i++) {
            var product = brandEditor.productDS.at(i);

            var score = parseInt(product.gradeScore);
            if (score > ratingHigh) {
                ratingHigh = score;
            }

            if (score < ratingLow) {
                ratingLow = score;
            }
        }

        var ratingObj = ux.computeRating(ratingHigh);

        brandEditor.activeObj.set('category', ratingObj.category);
        brandEditor.activeObj.set('gradeName', ratingObj.gradeName);
        brandEditor.activeObj.set('gradeScore', ratingObj.gradeScore);
        brandEditor.activeObj.set('highScore', ratingHigh);
        brandEditor.activeObj.set('lowScore', ratingLow);


        ux.notify("Computed Brand Rating: " + ratingObj.category + " : " + ratingObj.gradeName);
        brandEditor._highestProductRating = ratingHigh;
        brandEditor._lowestProductRating = ratingLow;

    },

    _fetchRetailers : function (objectList) {
        algolia.retailerIndex.getObjects(objectList, function (err, content) {

            if (err) {
                ux.notify("Error fetching " + data.brandName + "'s products : " + JSON.stringify(err), 'error');
                return;
            }

            brandEditor.retailerHash = [];
            var retailList = [], missingRetailList = [];
            for (var j=0; j<content.results.length; j++) {
                var retail = content.results[j];
                if (retail === null) {
                    // Brand has deleted / missing retailer in list.
                    var missingRetailId = brandEditor.activeObj.retailerIdList[j];
                    missingRetailList.push(missingRetailId);
                    brandEditor.activeObj.retailerIdList.splice(j,1);
                    brandEditor.activeObj.retailerList.splice(j,1);

                } else {
                    brandEditor.retailerHash[retail.retailerId] = retail.name;
                    retailList.push(retail);
                }

            }

            brandEditor.missingRetailerList = missingRetailList;
            brandEditor.retailerDS.data(retailList);
            var total = brandEditor.retailerDS.total();
            brandEditor.activeObj.set("retailerCount", total);
          //  $('#brandEditor-retailerCount').text(total);
            brandEditor.retailerDS.sort({field: "name", dir: "asc"});
            $('#brandEditor-retailerGrid').data('kendoGrid').refresh();

        });
    },

    _updateBrandIndex : function (brandId, callback) {

        var bpurl = 'http://gaiaapi.herokuapp.com/updatebrand?brandid='+brandId;
        $.ajax({
            url: bpurl,
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            success: function(data) {
                if (data.status === 'OK') {
                     callback(true);
                } else {
                    callback(false)
                }

            }
        });
    },

    _deleteBrandPhoto : function (brandId, callback) {

        var bpurl = 'http://gaiaapi.herokuapp.com/deletePhoto?folder=brand&publicid='+brandId;
        $.ajax({
            url: bpurl,
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            success: function(data) {
                if (data.status === 'OK') {
                    callback(true);
                } else {
                    callback(false)
                }

            }
        });
    },

    _updateProductIndex : function (productId, callback) {

        var bpurl = 'http://gaiaapi.herokuapp.com/updateproduct?productid='+productId;
        $.ajax({
            url: bpurl,
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            success: function(data) {
                if (data.status === 'OK') {
                    callback(true);
                } else {
                    callback(false)
                }

            }
        });
    },


    _deleteProductPhoto : function (productId, callback) {

        var bpurl = 'http://gaiaapi.herokuapp.com/deletePhoto?folder=product&publicid='+productId;
        $.ajax({
            url: bpurl,
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            success: function(data) {
                if (data.status === 'OK') {
                    callback(true);
                } else {
                    callback(false)
                }

            }
        });
    },

    updateBrand : function () {
        var brandObj = brandEditor.activeObj;

        everlive.updateOne('brand', brandObj, function (err, data) {
            ux.notify(brandObj.brandName + ' Database updated...');
            // Call the index update function...
            brandEditor._updateBrandIndex(brandObj.brandId, function (status) {
                if (status)
                    ux.notify(brandObj.brandName + ' Index updated...', 'success');
                else
                    ux.notify(brandObj.brandName + ' index not updated', 'error');
            });

        });
    },

    updateRetailers : function () {

    },


    updateProducts : function () {

        var productCount = brandEditor.productDS.total();
        var index = 0;
        var brandImage = brandEditor.activeObj.brandImageUrl;
        var brandUrl = brandEditor.activeObj.brandUrl;

        function getNext () {
            var product =  brandEditor.productDS.at(index);

            product.brandImage = brandImage;
            product.brandUrl = brandUrl;

            delete product.CreatedBy;
            delete product.ModifiedBy;
            delete product.Owner;
            delete product.Meta;

            everlive.updateOne('product', product, function (err, data) {
                if (err !== null) {
                    ux.notify("Couldn't Update Product In Database " + JSON.stringify(err), 'error');
                }
                brandEditor._updateProductIndex(product.Id, function() {
                    if (!status) {
                        ux.notify(product.productName + " Not updated in Product Index ", 'success');
                    }
                    index++;
                    if (index < productCount) {
                        return getNext();
                    }
                })
            });

        }

        getNext();

        brandEditor._productSyncRequired = false;

        ux.notify(productCount + " products updated...", 'success');

    },

    doSaveBrand : function () {

        var brandObj = brandEditor.activeObj;

        brandObj.dirty = true;

        delete brandObj.mode;

        var prodCatArray = [], regionStatArray = [];

        for (var i=0; i<brandObj.productCategories.length; i++) {
            var cat = null;
            if (brandObj.productCategories[i].text !== undefined) {
                cat = brandObj.productCategories[i].text;
            } else {
                cat = brandObj.productCategories[i];
            }
            prodCatArray.push (cat);
        }

        brandObj.productCategories = prodCatArray;

        for (var j=0; j<brandObj.regionStatesList.length; j++) {
            var reg = null;
            if (brandObj.regionStatesList[j].name !== undefined) {
                reg = brandObj.regionStatesList[j].name;
            } else {
                reg = brandObj.regionStatesList[j];
            }
            regionStatArray.push (reg);
        }

        brandObj.regionStatesList = regionStatArray;

        brandObj.retailerCount = brandEditor.retailerDS.total();
        brandObj.productCount = brandEditor.productDS.total();

        if (brandEditor._productSyncRequired) {
            ux.notify("Syncing Brand changes to products...", 'success');
            brandEditor.updateProducts();
        }


        everlive.updateOne('brand', brandObj, function (err, data) {
            ux.notify(brandObj.brandName + ' Database updated...');
            // Call the index update function...
            brandEditor._updateBrandIndex(brandObj.brandId, function (status) {
                if (status)
                    ux.notify(brandObj.brandName + ' Index updated...', 'success');
                else
                    ux.notify(brandObj.brandName + ' index not updated', 'error');
            });

        });


    },

    _imageEditor : function (container, options) {

        var productObj = options.model;
        var publicId = productObj.productId;

        brandEditor._deleteProductPhoto(publicId, function (status) {

            productObj.set('productImage', brandEditor._defaultBrandImageUrl);
            if (!status) {
                ux.notify("Error deleting current image from cloud ...", 'error');
                return;
            } else {
                ux.notify(productObj.productName + " photo deleted from cloud  -- Please upload replacement", 'success');
            }

            cloudinary.openUploadWidget({ cloud_name: 'hyjvcxzjt', upload_preset: 'bpproduct', public_id: publicId , client_allowed_formats : ["png","gif", "jpeg"]  },
                function(error, result) {

                    if (error === null && result.length > 0) {
                        var photo = result[0];
                       productObj.set('productImage',photo.secure_url);

                        productObj.dirty = true;
                        everlive.updateOne('product', productObj, function (err, data) {
                            brandEditor._updateProductIndex(productObj.productId, function (status) {
                                if (status) {
                                    ux.notify("Updated Product photo ", 'success');
                                }
                            });
                            // Call the index update function...
                        });
                    }
                });
        });
    },

    _certificationEditor : function (container, options) {

        $('<select multiple="multiple" name="certifications" />')
            .appendTo(container).kendoMultiSelect({
            dataSource: labelGuideView._certificationNames,
            value: options.model.certifications
        });
    },

    _claimEditor : function (container, options) {

        $('<select multiple="multiple" name="claims" />')
            .appendTo(container).kendoMultiSelect({
            dataSource: labelGuideView._claimNames,
            value: options.model.claims
        });
    },

    _categoryEditor : function (container, options) {
        $('<input required name="' + options.field + '"/>')
            .appendTo(container)
            .kendoDropDownList({
                autoBind: false,
                dataSource: ["Best", "Better", "Avoid"]
            });
    },

    _readOnly : function (container, options) {
        ux.notify (options.field + " is computed from <strong> Score </strong>", 'error');
    },

    _typeEditor : function (container, options) {
        $('<input required name="' + options.field + '"/>')
            .appendTo(container)
            .kendoDropDownList({
                autoBind: false,
                dataSource: ["Chicken", "Eggs", "Turkey", "Plant-based"]
            });
    },

    _gradeNameEditor : function (container, options) {
        $('<input required name="' + options.field + '"/>')
            .appendTo(container)
            .kendoDropDownList({
                autoBind: false,
                dataSource: ["A", "A-", "+B", "B", "B-", "+C", "C", "-C", "+D", "D", "D-", "F"]
            });
    },

    _gradeScoreEditor : function (container, options) {
        $('<input required name="' + options.field + '"/>')
            .appendTo(container)
            .kendoDropDownList({
                autoBind: false,
                dataSource: [ "12","11", "10", "9", "8", "7", "6", "5", "4", "3", "2", "1", "0"],
                select: function (e) {
                    if (e.item) {
                        var gradeScore = this.dataItem(e.item);
                        var rating = ux.computeRating(gradeScore);

                        var product = this._focused.context.kendoBindingTarget.source;

                        product.set('category', rating.category);
                        product.set('gradeName', rating.gradeName);
                    }

                }
            });
    }


};
'use strict';

var brandView = {
    search: null,
    _onInit: false,
    resultsData : [],
    _defaultBrandImageUrl : 'http://res.cloudinary.com/hyjvcxzjt/image/upload/v1483036299/product/icon-defaultProduct.png',

    init: function(){
        if(!brandView._onInit){
            /// Product search widget
            brandView.search = instantsearch({
                appId: algolia._appId,
                apiKey: algolia._searchKey,
                indexName: "brand",
                urlSync: false
            });

            /// Search box widget
            brandView.search.addWidget(
                instantsearch.widgets.searchBox({
                    container: "#brandSearch-container",
                    placeholder: "Search for brands...",
                    cssClasses: {
                        input: "productList-search"
                    }
                })
            );

            /// Hits/results widget
            brandView.search.addWidget(
                instantsearch.widgets.hits({
                    container: "#brandSearch-results",
                    cssClasses: {
                      item: "brandSearch-item"
                    },
                    templates: {
                        item: function(data){

                            var categoryClass = null;
                            if (data.category === undefined) {
                                var cat = "Avoid";
                                var score = parseInt(data.gradeScore);

                                if (score >= 8) {
                                    cat = "Best";
                                }

                                if (score >= 4) {
                                    cat = "Better";
                                }


                                data.category = cat;
                            }
                            var categoryStr = data.category.toLowerCase();
                            var productFavorite = "";
                            var productImg = "";

                            var name;
                            brandView.resultsData[data.objectID] = data;
                            switch(categoryStr){
                                case "best":
                                    categoryClass = "productList-best";
                                    break;
                                case "better":
                                    categoryClass = "productList-better";
                                    break;
                                case "avoid":
                                    categoryClass = "productList-avoid";
                                    break;
                            }

                            var imageUrl = "";

                            if(data.brandImageUrl !== undefined && data.brandImageUrl !== null){
                                imageUrl = data.brandImageUrl;
                                productImg = '<span class=productList-img><img onerror="brandView.imgError(event)" src="' + imageUrl + '" /></span>';
                            } else {
                                //imageUrl = 'images/';
                                productImg = '<span class=productList-img><img onerror="brandView.imgError(event)" src='+ brandView._defaultBrandImageUrl + ' /></span>';
                            }


                            if(data.brandName !== null){
                                // todo - escape content
                                name = data.brandName;
                            }

                           var categoryString = "Another Choice";

                            if (data.category === 'Best') {
                                categoryString = "Best Choice";
                            } else if (data.category === "Better") {
                                categoryString = "Better Choice";
                            }

                            var retailerString = '';
                            if (data.retailerList.length > 0) {
                                retailerString = data.retailerList.join(', ');
                            }

                            var toRender = "<div class=productList-item id="+ data.objectID + ">" +
                            "<span class='productList-category " + categoryClass + "'>" + categoryString + "</span>" +
                            productFavorite + productImg +
                            "<span class=productList-infoBox>" +
                            "<h4>" + name + "</h4>" +
                            "<p class=subInfo> Grade: <strong>"  + data.gradeName + "</strong> </p>" +
                            "<p class=subInfo> Score: <strong>" + data.gradeScore + "</strong> </p>" +
                                '<p class=subInfo> Url:  <a target="_blank" href="' + data.brandUrl + '" >' + data.brandUrl + '</a> </p>' +
                                '<p class="subInfo text-clamp"> Sold @ : '+ retailerString + ' </p>' +
                            "</span></div>";

                            return toRender;

                        },
                        empty: function(data){
                            var template = kendo.template($("#noProductsTemplate").html());

                            //Create some dummy data
                            var data = {query : data.query };

                            var result = template(data); //Execute the template
                            return result;
                        }
                    },
                    hitsPerPage: 50
                })
            );

            /// menu widget - category
            brandView.search.addWidget(
                instantsearch.widgets.menu({
                   container: "#brandSearch-category",
                    attributeName: "category",
                    sortBy: ["count: asc"],
                    cssClasses: {
                       item: "productList-filterItems",
                       active: "activeFilter"
                    },
                    templates: {
                       header: "Filter by rating",
                        item: function(data){
                            var categoryStr = data.name.toLowerCase();
                            return "<span class='productList-filter product-" + categoryStr + "'>" + data.name + "</span>"+
                                "<span class=productList-filter-count> (" + data.count + ")</span>";
                        }
                    }
                })
            );

            brandView.search.addWidget(
                instantsearch.widgets.pagination({
                    container: "#brandSearch-pagination",
                    cssClasses: {
                        active: "pagination-active"
                    }
                })
            );

          /*  /// menu widget - productCategory
            brandView.search.addWidget(
                instantsearch.widgets.menu({
                    container: "#brandSearch-productCategory",
                    attributeName: "category",
                    sortBy: ["name: asc"],
                    cssClasses: {
                        item: "productList-filterItems",
                        active: "activeCategory"
                    },
                    templates: {
                        header: "Filter by category",
                        item: function(data){
                            var categoryStr = data.name.toLowerCase();
                            return "<span class=productList-filter><span class=productList-filterDelete>&times;</span>" + data.name + "</span>"+
                                "<span class=productList-filter-count> (" + data.count + ")</span>";
                        }
                    }
                })
            );*/

            /// Stats widget
            brandView.search.addWidget(
                instantsearch.widgets.stats({
                    container: "#brandSearch-stats"
                })
            );

            brandView.search.on('render', function(){
                $(".icon-favorite").tooltip();

                $(".productList-item").unbind().on("click", function(e){
                    var currentId = $(e.currentTarget).attr("id");
                    var dataObj = brandView.resultsData[currentId];
                    if(dataObj !== undefined){

                        APP.router.navigate('#/brandeditor?brandid=' + dataObj.brandId);
                        //brandEditor.openModal(dataObj);
                    }
                });

            });

            brandView.search.start();


            //kendo.bind($("#brandEditor"), brandEditor.activeObj);

            $("#mobile-productFilters").on("show.bs.collapse", function(e){
                $("#toggle-mobileProductFilters-txt").text("Hide filters");
            });

            $("#mobile-productFilters").on("hide.bs.collapse", function(e){
                $("#toggle-mobileProductFilters-txt").text("Show filters");
            });

            $(window).resize(function(){
                var screenWidth = $(window).width();

                if(screenWidth < 767){
                    $("#mobile-productFilters").removeClass("in");
                } else {
                    $("#mobile-productFilters").addClass("in");
                }
            });

            brandView._onInit = true;
        }

        if (userView.isStaff() || userView.isBlogger()) {
            $('.bpstaff').removeClass('hidden');

        } else {
            $('.bpstaff').addClass('hidden');
        }
    },


    onShow: function(){


    },

    imgError : function (e) {

    },

    lookupResult : function(array, prop, value) {
        for (var i = 0, len = array.length; i < len; i++)
            if (array[i] && array[i][prop] === value) return array[i];
    },

    toggleFavorite: function(e){
        e.stopPropagation();
        if(userView.currentUser.Id !== null){
            var targetId = "";
            var targetClass = e.target.classList;

            if(targetClass[0] === "material-icons" || targetClass[0] === "favorite"){
                targetId = "#" + e.target.parentElement.id;
            } else {
                targetId = "#" + e.target.id;
            }
            // todo - wire favorite
            if(e.target.id !== undefined){
                var targetFav = $(targetId).data("favorite");

                var objectId = targetId.replace('#product-', '');
                var results = this.resultsData;

                var product = brandView.lookupResult(results, 'objectID', objectId);
                var productName = "Opps - No Product...";

                if (product.productName !== undefined && product.productName !== null) {
                    productName = product.productName;
                }

                var url = "/favorite?state="+targetFav+'&category=product&title='+productName;
                ga('set', 'page', url);
                ga('send', 'pageview');

                if(targetFav){
                    $(targetId).data("favorite", false).velocity("fadeIn");
                    $(targetId + " > i.material-icons").text("favorite_border").removeClass("favorite");
                    ux.notify(productName + " removed from favorites", "success");
                } else {
                    $(targetId).data("favorite", true).velocity("fadeIn");
                    $(targetId + " > i.material-icons").text("favorite").addClass("favorite");
                    ux.notify(productName + " added to favorites", "success");
                }
            }
        } else {
            userView.openSignUp();
        }

    }
};


/**
 * Created by donbrad on 3/22/17.
 */
'use strict';

var campaignListView = {
    _initialized: false,
    _reportInitialized : false,
    _siteSlug : null,
    _campaignSlug : null,

    campaignDS : new kendo.data.DataSource({
        pageSize: 12,
        schema: {
            model: {
                id: "Id",
                fields: {
                    siteName:  { nullable: false },
                    siteSlug:  { nullable: false },
                    description:  { nullable: true },
                    title:  { nullable: false },
                    slug:  { nullable: false },
                    campaignId : { nullable: false },
                    mcCampaignId:  { nullable: false },
                    mcListId:  { nullable: false },
                    content:  { nullable: false },
                    startDate:  { type: "Date", defaultValue: new Date(),  nullable: true },
                    endDate:  { type: "Date", defaultValue: new Date(),  nullable: true }
                }
            }
        },
        transport : {
            create: function (options) {
                var model = options.data;
                model.Id = uuid.v4();
                campaignModel.add(model);
                options.success();
            },

            destroy : function (options) {
                var model = options.data;
                campaignModel.remove(model);
                options.success();
            },

            read: function (options) {
                var pages = [];
                if (campaignListView._siteSlug !== null) {
                    pages = campaignModel.listBySiteSlug(campaignListView._siteSlug);
                } else {
                    pages = campaignModel.campaignDS.data();
                }
                options.success(pages);
            },

            update : function (options) {
                var model = options.data;
                campaignModel.update(model);
                options.success();
            },

            parameterMap: function(options, operation) {
                if (operation !== "read" && options.models) {
                    return {models: kendo.stringify(options.models)};
                }
            }
        }
    }),

    activeObj : new kendo.data.ObservableObject({siteName: null, siteSlug: null}),
    _pageSize : 12,
    _reportTemplate : null,


    init: function(){
        if(!campaignListView._initialized){

            campaignListView._initialized = true;

      /*      templateLoader.load('../../../templates/campaignList.html', function(status) {
                if(status){
                    campaignListView._reportTemplate = kendo.template($("#backlogReport-tmpl").html());
                }
            });

            $("#campaignReport-window").kendoWindow({
                width: "1024px",
                height: "768px",
                visible: false,
                close : function () {
                    window.location.hash='#/backloglist'
                },
                actions: [
                    "Pin",
                    "Minimize",
                    "Maximize",
                    "Close"
                ]
            });

            $("#backlogSite-selector").kendoDropDownList({
                dataTextField: "name",
                dataValueField: "slug",
                dataSource: [
                    {name : 'All', slug: "all"},
                    {name : 'Farm Forward', slug: "farm-forward"},
                    {name : 'JIFA', slug: "jifa"},
                    {name : 'Better Food Foundation', slug: "bff"},
                    {name : 'Leadership-Circle', slug: "leadership-circle"},
                    {name : 'Buying Poultry', slug: "buying-poultry"}
                ],

                change : function (e) {
                    var siteSlug = this.value();

                    if (siteSlug === 'all') {
                        siteSlug = null;
                    }
                    campaignListView._siteSlug = siteSlug;

                    campaignListView.campaignDS.read();
                }
            });
       */
            $('#campaignList-search-input').keyup (function () {
                var val =  $('#campaignList-search-input').val();

                if (val.length > 0) {
                    campaignListView.campaignDS.filter({field: 'title', operator: 'contains', value: val});
                } else {
                    campaignListView.campaignDS.filter({});
                }

            });

            $('#campaignList-search-input').change (function () {
                var val =  $('#campaignList-search-input').val();

                if (val.length > 0) {
                    campaignListView.campaignDS.filter({field: 'title', operator: 'contains', value: val});
                } else {
                    campaignListView.campaignDS.filter({});
                }
            });


          $("#campaignList-grid").kendoGrid({
            dataSource: campaignListView.campaignDS,
            pageSize : 12,
            autoBind: false,
            pageable: true,
            resizable: true,
            sortable: true,
            reorderable: true,
            selectable: true,
            batch: true,
            toolbar: [{name: "create", text: "Add Entry"},{name: "save", text: "Save Changes "}],
            editable: "inline",
            /*change: function(e) {
                var selectedRow = this.select();
                var dataItem = this.dataItem(selectedRow[0]);

                campaignListView.doReport(dataItem);
            },
*/
            height: 580,
            columns: [
                { field:"siteName",title:"Site", editor: campaignListView._siteEditor, width: "220px" },
                { field:"title",title:"Title", width: "180px" },
                { field:"mcListId",title:"MC List", editor: campaignListView._mclistEditor, width: "120px" },
                { field:"mcCampaignId",title:"MC Campaign", editor: campaignListView._mcCampaignEditor, width: "120px" },
                { field:"startDate",title:"Start", editor: campaignListView._dateEditor, format:"{0:MM-dd-yyyy}", width: "140px"},
                { field:"endDate",title:"End", editor: campaignListView._dateEditor, format:"{0:MM-dd-yyyy}", width: "140px"},
                {  command: [ "edit", "destroy" ], title: "Dev Tools",  width: "120px"}
            ]
        });
               //  kendo.bind($("#contributorView-modal"), contributorView.activeObj);
        }
    },

    loadCampaignDS : function (siteSlug) {
        var pages = null;

        if (siteSlug === null || siteSlug === 'all') {
            campaignListView._siteSlug = null;
        } else {
            campaignListView._siteSlug = siteSlug;
        }

        campaignListView.campaignDS.read();
    },


    open: function (siteSlug, reportId) {
        campaignListView.init();
        $('#campaignList-search-input').val('');
        campaignListView.loadCampaignDS(siteSlug);

        if (reportId !== undefined && reportId !== null) {
            var report = campaignModel.findById(reportId);

            if (report !== null) {
                if (campaignListView._reportTemplate === null) {
                    templateLoader.load('../../../templates/campaignReport-tmpl.html', function(status) {
                        if(status){
                            campaignListView._reportTemplate = kendo.template($("#campaignReport-tmpl").html());

                            campaignListView.doReport(report);
                        }
                    });
                }

            }
        }


    },

    close : function () {

    },

    _readOnly : function (container, options) {
        ux.notify (options.field + " is readonly", 'error');
    },

    _dateEditor : function (container, options) {
        $('<input data-text-field="' + options.field + '" data-value-field="' + options.field + '" data-bind="value:' + options.field + '" data-format="' + options.format + '"/>')
            .appendTo(container)
            .kendoDatePicker({ min: new Date()});
    },



    _booleanEditor : function (container, options) {
        $('<input required name="' + options.field + '"/>')
            .appendTo(container)
            .kendoDropDownList({
                autoBind: false,
                dataTextField: 'Text',
                dataValueField: 'Text',
                dataSource:  [{ Value: "true", Text: "Yes" }, { Value: "false", Text: "No" }]
            });
    },

    _currencyEditor : function (container, options) {
        $('<input required name="' + options.field + '"/>')
            .appendTo(container)
            .kendoNumericTextBox({
                decimals: 2,
                format: "n"
            });
    },


    _siteEditor : function (container, options) {
        $('<input required name="' + options.field + '"/>')
            .appendTo(container)
            .kendoDropDownList({
                autoBind: false,
                dataTextField: "name",
                dataValueField: "slug",
                dataSource: [
                    {name : 'All', slug: "all"},
                    {name : 'Farm Forward', slug: "farm-forward"},
                    {name : 'JIFA', slug: "jifa"},
                    {name : 'Better Food Foundation', slug: "bff"},
                    {name : 'Leadership-Circle', slug: "leadership-circle"},
                    {name : 'Buying Poultry', slug: "buying-poultry"}
                ]
            });
    },

    _mclistEditor : function (container, options) {
        $('<input required name="' + options.field + '"/>')
            .appendTo(container)
            .kendoDropDownList({
                autoBind: false,
                dataTextField: "name",
                dataValueField: "listid",
                dataSource: [
                    {name : 'Farm Forward', listid: "166cf7ddf5"},
                    {name : 'JIFA', listid: "583dc93d6d"},
                    {name : 'Better Food Foundation', listid: "2cb3b544a2"},
                    {name : 'Leadership-Circle', listid: "6ea8695300"},
                    {name : 'Buying Poultry', listid: "11c2709581"}
                ]
            });
    },

    _mcCampaignEditor : function (container, options) {
        $('<input required name="' + options.field + '"/>')
            .appendTo(container)
            .kendoDropDownList({
                autoBind: false,
                dataTextField: "name",
                dataValueField: "slug",
                dataSource: [
                    {name : 'Farm Forward', slug: "ff-periodic" },
                    {name : 'JIFA', slug: "jifa-periodic"},
                    {name : 'Better Food Foundation', slug: "bff-periodic"},
                    {name : 'Milk Free Mornings', slug: "bff-milk-free-mornings"},
                    {name : 'BFF Coupons', slug: "bff-coupons"},
                    {name : 'Leadership-Circle', slug: "lc-periodic"},
                    {name : 'Buying Poultry', slug: "bp-periodic"}
                ]
            });
    }


};
'use strict';

var contributorEditor = {
    search: null,
    _initialized: false,
    _editor : false,
    thisItem : null,
    activeObj : new kendo.data.ObservableObject({category: 'term', title: null, tag: null, tooltip: null, bioContent: null}),
    activeLink :  new kendo.data.ObservableObject({
        title: null,
        url: null,
        category: null,   // external, blog, glossary
        objectId : null
    }),

    init: function(){
        if(!contributorEditor._initialized){

            contributorModel.init();
            contributorEditor._initialized = true;

            $("#contributorEditor-contributorGrid").kendoGrid({
                dataSource: contributorModel.contributorDS,
                pageSize : 5,
                pageable: true,
                resizable: true,
                sortable: true,
                reorderable: true,
                toolbar: [{name: "create", text: "Add Person"},  {name: "save", text: "Save All Changes..."}],
                editable: true,
                edit : function (e) {
                    var person = e.model;
                    var addItemFlag = e.model.isNew();

                    if (person.Id === undefined) {
                        person.Id = uuid.v4()
                    }

                    if (person.name !== undefined && person.name !== null) {
                        person.name = person.name.capitalize();
                        person.slug = ux.createSlug(person.name);
                    }

                    if (person.title !== undefined && person.title !== null) {
                        person.title = person.title.capitalize();
                    }

                },
                height: 760,
                columns: [
                    { field:"profileUrl", title:"Profile", width: 130, template: contributorEditor._profileTemplate,  editor: contributorEditor._profileEditor},
                    { field:"name",title:"Name", width: 120 },
                    { field:"alias",title:"Alias", width: 90 },
                    { field:"title",title:"Title", width: 120 },
                    { field:"role",title:"Role", width: 80, editor: contributorEditor._roleEditor},
                    { field:"organization",title:"Organization", width: 80, editor: contributorEditor._organizationEditor },
                    { field:"slug",title:"Slug", width: 80 , editor: contributorEditor._slugEditor},
                    { field:"bioUrl", title:"Bio Link",  width: 80},
                    { field:"contactEmail", title:"Contact Email",  width: 80},
                    { field:"bioContent",title:"Content (click to edit)",  width: 100, template: '# var trunc = null; if (data.bioContent !== undefined && data.bioContent !== null) trunc = jQuery.truncate(data.bioContent, { length: 80, stripTags: true}); # #= trunc #', editor: contributorEditor._contentEditor},
                    { command: [{name: "destroy", text: "Delete"}],  width: 80}
                ]
            });

            $('#contributor-search-input').keyup (function () {
                var val =  $('#contributor-search-input').val();

                if (val.length > 0) {
                    contributorModel.contributorDS.filter({field: 'name', operator: 'contains', value: val});
                } else {
                    contributorModel.contributorDS.filter({});
                }

            });

            $('#contributor-search-input').change (function () {
                var val =  $('#contributor-search-input').val();

                if (val.length > 0) {
                    contributorModel.contributorDS.filter({field: 'name', operator: 'contains', value: val});
                } else {
                    contributorModel.contributorDS.filter({});
                }
            });

            $("#contributorContent-editor").kendoEditor({
                resizable: {
                    content: false,
                    toolbar: true
                },
                select: function(e) {
                    var editor = $("#contributorContent-editor").data("kendoEditor");
                    var selection = editor.getSelection();

                    if (selection.focusNode.parentNode.tagName === 'A') {
                        var title = selection.focusNode.parentNode.text;
                        var href =  selection.focusNode.parentNode.href;
                        var targetText = selection.focusNode.parentNode.outerHTML;

                        window.open(href, "_blank");

                       //contributorEditor.editLink(selection, title, href, targetText);


                    } /*else if (selection.focusNode.tagName === 'IMG') {

                    }  else if (selection.focusNode.tagName === 'DIV' && selection.focusNode.className === 'blog-image') {
                        // Process legacy images in legacy blogs...
                        var image = selection.focusNode.children[0];
                        var imageSrc = image.src;

                        blogEditor.editImage(selection, null, imageSrc);

                    }*/

                },
                pasteCleanup: {
                    css: true,
                    msAllFormatting: true,
                    msConvertLists: false
                },
                tools: [
                    "bold", "italic", "underline", "subscript", "superscript", "justifyLeft", "justifyCenter", "justifyRight", "insertUnorderedList", "insertOrderedList",
                    "indent", "outdent","viewHtml","formatting"

                ]
            });

           contributorEditor._editor = $("#contributorContent-editor").data("kendoEditor");
           kendo.bind($("contributorContent-modal"), contributorEditor.activeObj);

        }


    },

    onShow: function() {
        if (userView.isStaff() || userView.isBlogger()) {
            $('.bpstaff').removeClass('hidden');

        } else {
            $('.bpstaff').addClass('hidden');
        }

    },

    doSearch : function (e) {
        e.preventDefault();

        var dataItem = this.dataItem($(e.currentTarget).closest("tr"));

        var url = "https://www.google.com/#q=" + dataItem.name;

        window.open(url, "_blank");
    },

    _slugEditor : function (container, options) {
        var labelObj = options.model;

        var slug = ux.createSlug(options.model.name);


        labelObj.set('slug',slug);
    },



    _roleEditor : function (container, options) {
        $('<input required name="' + options.field + '"/>')
            .appendTo(container)
            .kendoDropDownList({
                autoBind: false,
                dataSource:  ["Advisor",  "Board",  "Consultant",  "Staff", "Volunteer" ]
            });
    },

    _organizationEditor : function (container, options) {
        $('<input required name="' + options.field + '"/>')
            .appendTo(container)
            .kendoDropDownList({
                autoBind: false,
                dataSource:  ["Better Food Foundation", "Buying Poultry", "Eating Animals",  "Farm Forward",  "JIFA", "Leadership Circle" ]
            });
    },

    _deletePhoto : function (slug, callback) {

        var bpurl = 'http://gaiaapi.herokuapp.com/deletePhoto?folder=advisor&publicid='+slug;
        $.ajax({
            url: bpurl,
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            success: function(data) {
                if (data.status === 'OK') {
                    callback(true);
                } else {
                    callback(false)
                }

            }
        });
    },

    _profileTemplate : function (dataItem) {
        var url = dataItem.profileUrl;

        if (url === undefined || url === null ) {
            url = 'images/icon-defaultProduct.png';
        }

        var htmlCode = '<div class="grid-label-container"> <img class="grid-label-img" src="' + url + '"/> </div>';

        return(htmlCode);
    },

    _profileEditor : function (container, options) {

        var peopleObj = options.model;

        if (peopleObj.name === undefined || peopleObj.name === null) {
            ux.notify("Please enter name...");
            return;
        }

        if (peopleObj.slug === undefined) {
            peopleObj.slug = ux.createSlug(peopleObj.name);
        }
        var publicId = "profile_" + peopleObj.slug;

        contributorEditor._deletePhoto(publicId, function (status) {

            if (!status) {
                ux.notify("Error deleting current image from cloud ...", 'error');
                return;
            }

            cloudinary.openUploadWidget({ cloud_name: 'hyjvcxzjt', upload_preset: 'bpadvisor', public_id: publicId , client_allowed_formats : ["png","gif", "jpeg"]  },
                function(error, result) {

                    if (error === null && result.length > 0) {
                        var photo = result[0];
                        peopleObj.set('profileUrl',photo.secure_url);

                        peopleObj.dirty = true;
                        everlive.updateOne('advisor', peopleObj, function (err, data) {
                            contributorEditor._updateIndex(peopleObj.slug, function (status) {
                                if (status) {
                                    ux.notify("Updated People photo ", 'success');
                                }
                            });
                            // Call the index update function...
                        });
                    }
                });
        });
    },

    _imageTemplate : function (dataItem) {
        var url = dataItem.photoUrl;

        if (url === undefined || url === null ) {
            url = 'images/icon-defaultProduct.png';
        }

        var htmlCode = '<div class="grid-label-container"> <img class="grid-label-img" src="' + url + '"/> </div>';

        return(htmlCode);
    },

    _photoEditor : function (container, options) {

        var peopleObj = options.model;
        var publicId = "photo_" + peopleObj.slug;

        contributorEditor._deletePhoto(publicId, function (status) {

            if (!status) {
                ux.notify("Error deleting current image from cloud ...", 'error');
                return;
            }

            cloudinary.openUploadWidget({ cloud_name: 'hyjvcxzjt', upload_preset: 'bpadvisor', public_id: publicId , client_allowed_formats : ["png","gif", "jpeg"]  },
                function(error, result) {

                    if (error === null && result.length > 0) {
                        var photo = result[0];
                        peopleObj.set('photoUrl',photo.secure_url);

                        peopleObj.dirty = true;
                        everlive.updateOne('advisor', peopleObj, function (err, data) {
                            contributorEditor._updateIndex(peopleObj.slug, function (status) {
                                if (status) {
                                    ux.notify("Updated People photo ", 'success');
                                }
                            });
                            // Call the index update function...
                        });
                    }
                });
        });
    },

    _contentEditor : function (container, options) {
        var peopleObj = options.model;


        contributorEditor.activeObj.set('name', peopleObj.name);

        var content = peopleObj.bioContent;

        if (content !== undefined && content !== null) {
            content = content.replace(/<!--[\s\S]*?-->/g,"");
            content = content.replace(/<style[\s\S]*?\/style>/g,"");
            content = content.replace(/\n?/,"");

            if (peopleObj.tooltip === undefined || peopleObj.tooltip === null || peopleObj.tooltip === "") {
                peopleObj.tooltip = jQuery.truncate(content, { length: 120, words: true, stripTags: true});
            }

            contributorEditor.activeObj.set('tooltip', peopleObj.tooltip);
        } else {
            content = '';
        }



        contributorEditor.activeObj.set('bioContent', content);

        peopleObj.set('bioContent', content);
        contributorEditor.thisItem = options.model;

        $("#contributorContent-modal").modal("toggle");


    },

    onSaveContent: function () {


        var content = contributorEditor._editor.value();

        if (content !== null) {
            content = content.replace(/<!--[\s\S]*?-->/g,"");
            content = content.replace(/<style[\s\S]*?\/style>/g,"");
            content = content.replace(/\n?/,"");

            if (contributorEditor.activeObj.tooltip === undefined || contributorEditor.activeObj.tooltip === null || contributorEditor.activeObj.tooltip === "") {
                contributorEditor.activeObj.tooltip = jQuery.truncate(content, { length: 120, words: true, stripTags: true});
            }
        }


        contributorEditor.activeObj.set('bioContent', content);
        contributorEditor.thisItem.set('bioContent', content);

        contributorModel.contributorDS.sync();
        // Persist content to cloud...

        $("#contributorContent-modal").modal("toggle");
    },


    editLink : function (selection, title, href, target) {
        contributorEditor.activeLink.set('title', title);
        contributorEditor.activeLink.set('href', href);
        contributorEditor.activeLink.set('target', target);
        contributorEditor.activeLink.selection = selection;
        $('#linkEditor-linkStatus').html('');
        $("#blogLinkEditor").modal("toggle");
    },

    updateLink : function (selection, title, href, category) {

    },

    _updateIndex : function (slud, callback) {

       /* var bpurl = '/updatelabel?slug='+slug;
        $.ajax({
            url: bpurl,
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            success: function(data) {
                if (data.status === 'OK') {
                    callback(true);
                } else {
                    callback(false)
                }

            }
        });*/
    }
};

/**
 * Created by donbrad on 10/8/16.
 **/

'use strict';

var contributorView = {
    _initialized: false,
    activeObj : new kendo.data.ObservableObject({category: 'Tag', title: null, tag: null, slug: null, tooltip: null, content: null}),
    _pageSize : 128,

    init: function(){
        if(!contributorView._initialized){

            contributorView._initialized = true;

            $('#contributorView-search-input').keyup (function () {
                var val =  $('#contributorView-search-input').val();

                if (val.length > 0) {
                    contributorModel.contributorDS.filter({
                        logic: 'or',
                        filters: [
                            {field: 'name', operator: 'contains', value: val},
                            {field: 'organization', operator: 'contains', value: val}
                        ]
                    });
                } else {
                    contributorModel.contributorDS.filter({});
                }

            });

            $('#contributorView-search-input').change (function () {
                var val =  $('#contributorView-search-input').val();

                if (val.length > 0) {
                    contributorModel.contributorDS.filter({
                        logic: 'or',
                        filters: [
                            {field: 'name', operator: 'contains', value: val},
                            {field: 'organization', operator: 'contains', value: val}
                        ]
                    });
                } else {
                    contributorModel.contributorDS.filter({});
                }
            });

            $("#contributorView-listView").kendoListView({
                dataSource: contributorModel.contributorDS,
                selectable : 'single',
                template: kendo.template($("#contributorView-template").html())
            }) ;



            //  kendo.bind($("#contributorView-modal"), contributorView.activeObj);

        }


    },

    onShow: function () {
        contributorModel.contributorDS.sort({field: 'name', dir: "asc" });
    },




    openModal : function (glossaryId) {

    },


    doSearch : function (e) {
        e.preventDefault();

        var dataItem = this.dataItem($(e.currentTarget).closest("tr"));

        var url = "https://www.google.com/#q=" + dataItem.name;

        window.open(url, "_blank");
    }
};

var contributorModal = {
    _initialized: false,


    activeObj: new kendo.data.ObservableObject({
        id: null,
        title: null,
        name: null,
        alias: null,
        responseEmail : null,
        twitterId : null,
        facebookId : null,
        slug: null,
        profileUrl: "images/icon-defaultProduct.svg",
        photoUrl : "images/icon-defaultProduct.svg"
    }),

    init: function(){
      if(!contributorModal._initialized){
          contributorModal._initialized = true;

          kendo.bind($("#contributorModal"), contributorModal.activeObj);

         /* if (APP.socialFeed) {
              $('.social-feed-container').socialfeed({

                  // FACEBOOK
                  facebook: {
                      accounts: advisorView._fbTags,
                      limit: 50,
                      access_token: '1769550126625987|ASkS_59vC41kbXLLlTIufigeX3M'
                  },
                  // Twitter
                  twitter: {
                      accounts: advisorView._twitterTags,
                      limit: 50,
                      consumer_key: 'uLWcGWmebBDET8C1s5wM90NIp', // make sure to have your app read-only
                      consumer_secret: 'P95UdolvtVnhMG3rfleAm1enrjQU0ZQHb6Hjd8eE580p3ic0j4' // make sure to have your app read-only
                  },

                  // GENERAL SETTINGS
                  show_media: true,
                  length: 300,
                  update_period: 36000,
                  // When all the posts are collected and displayed - this function is evoked
                  callback: function() {
                      ux.notify("Social Feeds Loaded !", "success");
                  }
              });
          }*/

      }

    },

    onClick : function (e) {
        var slug = e.currentTarget.attributes['data-slug'].value;
        if (slug!== undefined && slug !== null) {
            contributorModal.open(slug);
        }
    },


    open : function (slug) {

        contributorModal.init();

        var peopleObj = contributorModel.findBySlug(slug);
        if (peopleObj !== null) {
            contributorModal.updateActiveObj(peopleObj);
            $('#contributorModal').modal('toggle');
        } else {
            ux.notify("Error loading info.", "error");
        }


    },

    close : function () {
        $('#contributorModal').modal('toggle');
    },


    updateActiveObj: function(slug){

        var obj = contributorModal.activeObj;

        obj.set('name', slug.name);
        obj.set('title', slug.title);
        var imageUrl = 'images/icon-defaultProduct.png';

        if (slug.photoUrl !== undefined && slug.photoUrl !== null) {
            imageUrl = slug.photoUrl;
        }
        if (slug.profileUrl !== undefined && slug.profileUrl !== null) {
            imageUrl = slug.profileUrl;
        }

        if (slug.twitterId === undefined || slug.twitterId === null) {
            slug.twitterId = "@farmforward"
        }

        if (slug.facebookId === undefined || slug.facebookId === null) {
            slug.facebookId = "@farmforward"
        }

        if (slug.contactEmail === undefined || slug.contactEmail === null) {
            slug.contactEmail = "info@farmforward.com"
        }



        obj.set('imageUrl', imageUrl);
        obj.set('contactEmail', slug.contactEmail);
        obj.set('twitterId', slug.twitterId);
        obj.set('facebookId', slug.facebookId);
        obj.set('organization', slug.organization);
        obj.set('bioContent',slug.bioContent);

    },

    onShow: function(slug){

    }
};


'use strict';

var donateView = {
    _initialized: false,

    init : function () {

    },

    open : function () {

    },

    donate : function () {

    }
};
/**
 * Created by donbrad on 5/2/17.
 */
'use strict';

var donationEditor = {

    _initialized: false,

    activeObj : new kendo.data.ObservableObject({
        category: 'term', title: null, tag: null, tooltip: null, bioContent: null
    }),

    init: function () {

    },

    open : function () {

    },

    close : function () {

    }
};
/**
 * Created by donbrad on 3/22/17.
 */
'use strict';

var donationListView = {
    _initialized: false,
    _reportInitialized : false,
    _siteSlug : null,
    _campaignSlug : null,

    donationDS : new kendo.data.DataSource({
        pageSize: 12,
        schema: {
            model: {
                id: "Id",
                fields: {

                    donationCount: { type: "Number", defaultValue: 0,  nullable: false },
                    donationTotal: { type: "Number", defaultValue: 0,  nullable: false },
                    donationTarget: { type: "Number", defaultValue: 0,  nullable: true },
                    status:  { nullable: false },
                    siteName:  { nullable: false },
                    siteSlug:  { nullable: false },
                    fboName: { nullable: false },
                    fboSlug: { nullable: false },
                    donationAccount: { nullable: false },
                    description:  { nullable: true },
                    title:  { nullable: false },
                    campaignId:  { nullable: true },
                    donationId:  { nullable: false },
                    content:  { nullable: false },
                    startDate:  { type: "Date", defaultValue: new Date(),  nullable: true },
                    endDate:  { type: "Date", defaultValue: new Date(),  nullable: true }
                }
            }
        },
        transport : {
            create: function (options) {
                var model = options.data;
                model.Id = uuid.v4();
                donationModel.add(model);
                options.success();
            },

            destroy : function (options) {
                var model = options.data;
                donationModel.remove(model);
                options.success();
            },

            read: function (options) {
                var pages = [];
                if (donationListView._siteSlug !== null) {
                    pages = donationModel.listBySiteSlug(donationListView._siteSlug);
                } else {
                    pages = donationModel.donationDS.data();
                }
                options.success(pages);
            },

            update : function (options) {
                var model = options.data;
                donationModel.update(model);
                options.success();
            },

            parameterMap: function(options, operation) {
                if (operation !== "read" && options.models) {
                    return {models: kendo.stringify(options.models)};
                }
            }
        }
    }),

    activeObj : new kendo.data.ObservableObject({siteName: null, siteSlug: null}),
    _pageSize : 12,
    _reportTemplate : null,


    init: function(){
        if(!donationListView._initialized){

            donationListView._initialized = true;

      /*      templateLoader.load('../../../templates/donationList.html', function(status) {
                if(status){
                    donationListView._reportTemplate = kendo.template($("#backlogReport-tmpl").html());
                }
            });

            $("#campaignReport-window").kendoWindow({
                width: "1024px",
                height: "768px",
                visible: false,
                close : function () {
                    window.location.hash='#/backloglist'
                },
                actions: [
                    "Pin",
                    "Minimize",
                    "Maximize",
                    "Close"
                ]
            });

            $("#backlogSite-selector").kendoDropDownList({
                dataTextField: "name",
                dataValueField: "slug",
                dataSource: [
                    {name : 'All', slug: "all"},
                    {name : 'Farm Forward', slug: "farm-forward"},
                    {name : 'JIFA', slug: "jifa"},
                    {name : 'Better Food Foundation', slug: "bff"},
                    {name : 'Leadership-Circle', slug: "leadership-circle"},
                    {name : 'Buying Poultry', slug: "buying-poultry"}
                ],

                change : function (e) {
                    var siteSlug = this.value();

                    if (siteSlug === 'all') {
                        siteSlug = null;
                    }
                    donationListView._siteSlug = siteSlug;

                    donationListView.donationDS.read();
                }
            });
       */
            $('#donationList-search-input').keyup (function () {
                var val =  $('#donationList-search-input').val();

                if (val.length > 0) {
                    donationListView.donationDS.filter({field: 'title', operator: 'contains', value: val});
                } else {
                    donationListView.donationDS.filter({});
                }

            });

            $('#donationList-search-input').change (function () {
                var val =  $('#donationList-search-input').val();

                if (val.length > 0) {
                    donationListView.donationDS.filter({field: 'title', operator: 'contains', value: val});
                } else {
                    donationListView.donationDS.filter({});
                }
            });


          $("#donationList-grid").kendoGrid({
            dataSource: donationListView.donationDS,
            pageSize : 12,
            autoBind: false,
            pageable: true,
            resizable: true,
            sortable: true,
            reorderable: true,
            selectable: true,
            batch: true,
            toolbar: [{name: "create", text: "Add Entry"},{name: "save", text: "Save Changes "}],
            editable: "inline",
            /*change: function(e) {
                var selectedRow = this.select();
                var dataItem = this.dataItem(selectedRow[0]);

                donationListView.doReport(dataItem);
            },
*/
            height: 580,
            columns: [
                { field:"siteName",title:"Site", editor: donationListView._siteEditor, width: "180px" },
                { field:"fboName",title:"For Benefit Of", editor: donationListView._fboEditor, width: "180px" },
                { field:"donationAccount",title:"Account", editor: donationListView._accountEditor, width: "180px" },
                { field:"title",title:"Title", width: "100px" },
                { field:"campaignId",title:"Campaign", editor: donationListView._campaignEditor, width: "100px" },
                { field:"startDate",title:"Start", editor: donationListView._dateEditor, format:"{0:MM-dd-yyyy}", width: "140px"},
                {  command: [ "edit", "destroy" ], title: "Dev Tools",  width: "120px"}
            ]
        });
               //  kendo.bind($("#contributorView-modal"), contributorView.activeObj);
        }
    },

    loadDonationDS : function (siteSlug) {
        var pages = null;

        if (siteSlug === null || siteSlug === 'all') {
            donationListView._siteSlug = null;
        } else {
            donationListView._siteSlug = siteSlug;
        }

        donationListView.donationDS.read();
    },


    open: function (siteSlug, reportId) {
        donationListView.init();
        $('#donationList-search-input').val('');
        donationListView.loadDonationDS(siteSlug);

        if (reportId !== undefined && reportId !== null) {
            var report = donationModel.findById(reportId);

            if (report !== null) {
                if (donationListView._reportTemplate === null) {
                    templateLoader.load('../../../templates/donationReport-tmpl.html', function(status) {
                        if(status){
                            donationListView._reportTemplate = kendo.template($("#donationReport-tmpl").html());

                            donationListView.doReport(report);
                        }
                    });
                }

            }
        }


    },

    close : function () {

    },

    _readOnly : function (container, options) {
        ux.notify (options.field + " is readonly", 'error');
    },

    _dateEditor : function (container, options) {
        $('<input data-text-field="' + options.field + '" data-value-field="' + options.field + '" data-bind="value:' + options.field + '" data-format="' + options.format + '"/>')
            .appendTo(container)
            .kendoDatePicker({ min: new Date()});
    },



    _booleanEditor : function (container, options) {
        $('<input required name="' + options.field + '"/>')
            .appendTo(container)
            .kendoDropDownList({
                autoBind: false,
                dataTextField: 'Text',
                dataValueField: 'Text',
                dataSource:  [{ Value: "true", Text: "Yes" }, { Value: "false", Text: "No" }]
            });
    },

    _currencyEditor : function (container, options) {
        $('<input required name="' + options.field + '"/>')
            .appendTo(container)
            .kendoNumericTextBox({
                decimals: 2,
                format: "n"
            });
    },

    _accountEditor : function (container, options) {
        $('<input required name="' + options.field + '"/>')
            .appendTo(container)
            .kendoDropDownList({
                autoBind: false,
                dataTextField: "name",
                dataValueField: "slug",
                dataSource: [
                    {name : 'Farm Forward', slug: "farm-forward"},
                    {name : 'Better Food Foundation', slug: "bff"}
                ]

            });
    },

    _fboEditor : function (container, options) {
        $('<input required name="' + options.field + '"/>')
            .appendTo(container)
            .kendoDropDownList({
                autoBind: false,
                dataTextField: "name",
                dataValueField: "slug",
                dataSource: [
                    {name : 'Farm Forward', slug: "farm-forward"},
                    {name : 'JIFA', slug: "jifa"},
                    {name : 'Better Food Foundation', slug: "bff"},
                    {name : 'Leadership-Circle', slug: "leadership-circle"},
                    {name : 'Buying Poultry', slug: "buying-poultry"}
                ]
            });
    },

    _campaignEditor : function (container, options) {
        $('<input required name="' + options.field + '"/>')
            .appendTo(container)
            .kendoDropDownList({
                autoBind: false,
                dataTextField: "name",
                dataValueField: "listid",
                dataSource: [
                    {name : 'Farm Forward', listid: "166cf7ddf5"},
                    {name : 'JIFA', listid: "583dc93d6d"},
                    {name : 'Better Food Foundation', listid: "2cb3b544a2"},
                    {name : 'Leadership-Circle', listid: "6ea8695300"},
                    {name : 'Buying Poultry', listid: "11c2709581"}
                ]
            });
    },

    _mclistEditor : function (container, options) {
        $('<input required name="' + options.field + '"/>')
            .appendTo(container)
            .kendoDropDownList({
                autoBind: false,
                dataTextField: "name",
                dataValueField: "listid",
                dataSource: [
                    {name : 'Farm Forward', listid: "166cf7ddf5"},
                    {name : 'JIFA', listid: "583dc93d6d"},
                    {name : 'Better Food Foundation', listid: "2cb3b544a2"},
                    {name : 'Leadership-Circle', listid: "6ea8695300"},
                    {name : 'Buying Poultry', listid: "11c2709581"}
                ]
            });
    }


};
'use strict';

var donationModal = {

    _initialized: false,

    activeObj : new kendo.data.ObservableObject({
        siteName: 'Farm Forward',
        siteId: 'farm-forward',
        donationInfo: 'Your donation will go to work instantly to improve upon the best available resource to finding alternatives to factory farming.',
        donationInfoMore: 'Farm Forward implements innovative strategies to promote conscientious food choices, reduce farmed animal suffering, and advance sustainable agriculture. Learn more at <a class="btn-link" target="_blank" href="https://farmforward.com/">farmforward.com</a>.',
        userId: null,
        lastAmount: 0,
        lastDate: null,
        name: null,
        phone: null,
        email: null,
        stripeId: null,
        donationId: null,
        amount: 10.00,
        isMonthly: false,
        amountFormat: '$10.00',
        ux_isMonthly: false,
        ux_chargeDate: null
    }),
        ux_amountUI: [],
        stripeCard : null,

    init : function () {
        if (!donationModal._initialized) {
            donationModal._initialized = true;

            if (APP.stripe === null) {

                APP.stripe = Stripe(APP.stripeKey);

                APP.stripeElements = APP.stripe.elements();
            }

            if (APP.donationInfo !== undefined) {
                donationModal.activeObj.set('donationInfo', APP.donationInfo);
                donationModal.activeObj.set('donationInfoMore', APP.donationInfoMore);
            }

            templateLoader.loadHtml("donationModal", '../../../templates/donationModal.html', function(status) {
                if (status) {
                    kendo.bind($("#donationModal"), donationModal.activeObj);
                    $("#donationModal-amount").kendoNumericTextBox({
                        format: "n",
                        decimal: "0",
                        factor: 100,
                        min: 2,
                        max: 10000,
                        step: 5,
                        change : function () {
                            var value = this.value();
                            var numerictextbox = $("#donationModal-amount").data("kendoNumericTextBox");
                            var x = parseFloat(value);

                           donationModal.activeObj.set('amountFormat', '$'+x.toFixed(2));
                            numerictextbox.step(10);
                            if (x < 25) {
                                numerictextbox.step(5);
                            } else if (x < 100) {
                                numerictextbox.step(10);
                            }
                        }
                    });

                    donationModal.stripeCard = APP.stripeElements.create('card', {
                        style: {
                            base: {
                                iconColor: '#666EE8',
                                color: '#4a4a4a',
                                lineHeight: '40px',
                                fontWeight: 400,
                                fontFamily: '"Helvetica Neue", Helvetica, sans-serif',
                                fontSize: '16px',
                                '::placeholder': {
                                    color: '#CFD7E0'
                                }
                            }
                        }
                    });
                    donationModal.stripeCard.mount('#donationModal-card');

                $('#donationModal-form').on('submit', function(e) {
                    e.preventDefault();
                    $("#donateModal-submit").attr("disabled", true).text("Processing...");
                    var name = donationModal.activeObj.name;
                    var phone = donationModal.activeObj.phone;
                    var email = donationModal.activeObj.email;
                    var extraDetails = {
                        name: name,
                        phone: phone,
                        email: email
                    };
                    APP.stripe.createToken(donationModal.stripeCard, extraDetails).then(function (result) {
                        if (result.error) {

                            $(".stripe-error").removeClass("hidden").text(result.error.message);
                            $("#donate-summary").addClass("hidden");

                        } else {
                            $(".stripe-error").addClass("hidden").text("");
                            $("#donate-summary").removeClass("hidden");
                            var token = result.token.id;
                            donationModal.activeObj.set('token', token);
                            donationModal._processDonation();

                            //$("#donationModal").modal("toggle");
                           // ux.notify("Please wait.  Processing your donation...");
                        }
                        $("#donateModal-submit").attr("disabled", false).text("Donate $" + donationModal.activeObj.amount);

                    });
                });

                    $("#donateModal-amount-group").on("change", function(e){
                        var selectedAmount = e.target.dataset.amount;
                        if(selectedAmount !== undefined && selectedAmount !== "custom"){
                            donationModal.activeObj.set("amount", selectedAmount);
                            var x = parseFloat(selectedAmount);
                            donationModal.activeObj.set('amountFormat', '$'+x.toFixed(2));

                            if(!$("#donateModal-amount-custom").hasClass("hidden")){
                                $("#donateModal-amount-custom").addClass("hidden");
                            }
                        } else {
                            $("#donateModal-amount-custom").removeClass("hidden");

                        }

                    });
                    $("#donateModal-time-monthly").on("change", function(e){
                        var isMonthly = (e.target.dataset.monthly == 'true');

                        if(isMonthly){
                            var chargeDate = moment().format("Do");
                            donationModal.activeObj.set("ux_isMonthly", true);
                            donationModal.activeObj.set("ux_chargeDate", chargeDate);
                            $("#donateModal-freq").text("monthly");
                        } else {
                            donationModal.activeObj.set("ux_isMonthly", false);
                            donationModal.activeObj.set("ux_chargeDate", null);
                            $("#donateModal-freq").text("one time");
                        }
                    });

                    $('#donation-info-more').on('show.bs.collapse', function () {
                        $(".donation-info-expand").text("Hide info");
                    })

                    $('#donation-info-more').on('hide.bs.collapse', function () {
                        $(".donation-info-expand").text("More info");
                    })

                    $("#donationModal").on("hide.bs.modal", function(){
                        donationModal.stripeCard.clear();
                    });

                    donationModal._processUXAmount();
                }
            });

            donationModal.activeObj.bind("change", function(e){
                var field = e.field;
                var value = donationModal.activeObj.get(field);
                switch (field){
                    case "amount":
                        $("#donateModal-submit").text("Donate $" + value);
                        break;
                }
            });


        }

    },

    _hideError : function () {
        $('#donationModal-error').addClass('hidden');
        $('#donationModal-error').html("");
    },

    _processDonation: function () {
        //var url = "http://localhost:5555/stripecharge";
        var url = "https://gaiaapi.herokuapp.com/stripecharge/"+APP.siteSlug;

       donationModal._hideError();

        var data = JSON.stringify(donationModal.activeObj);
        $.ajax(url,{
            data: data,
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            cors: true,
            method: 'post',
            processData: false,
            success: function(data) {
                if (data.status === 'OK') {
                    var receipt = data.receipt;

                    if (receipt.paid && receipt.status === 'succeeded') {
                        $("#donationModal").modal("toggle");
                        ux.notify("Thank You for your donation!", 'success');
                        userModel.userObj.set('stripeId', receipt.customer);
                        var donationId = donationModal.activeObj.donationId;

                        var transIn = {
                            amount : receipt.amount / 100,
                            date : moment().toISOString(),
                            transactionId : receipt.id,
                            cardBrand : receipt.source.brand,
                            customer: receipt.source.customer,
                            last4 : receipt.source.last4,
                            status : receipt.status,
                            networkStatus : receipt.outcome.network_status,
                            riskLevel : receipt.outcome.risk_level,
                            bankDeclineCode : receipt.outcome.reason,
                            sellerMessage : receipt.outcome.seller_message
                        };


                        userTransaction.addTransaction(transIn);

                        if (receipt.customer !== undefined && receipt.customer !== null) {

                            var recurring =  donationModal.activeObj.ux_isMonthly;
                            var recurringId = null;
                            var amount = receipt.amount / 100;
                            if (recurring) {
                                recurringId = 'monthly'+amount;
                                donationModal.checkPlan(amount);
                            }
                            var donateIn = {
                                amount : amount,
                                date : moment().toISOString(),
                                transactionId : receipt.id,
                                customer: receipt.customer,
                                isRecurring : recurring,
                                recurringId : recurringId,
                                zipcode: receipt.source.address_zip,
                                cardBrand : receipt.source.brand,
                                last4 : receipt.source.last4

                            };
                            userDonation.addDonation(donateIn);
                            if (recurring) {
                                analyticsModel.sendGAEvent('donation', 'stripe', donationId, 'monthly'+amount);
                            } else {
                                analyticsModel.sendGAEvent('donation', 'stripe', donationId, 'single'+amount);
                            }

                        }
                    }

                } else {
                    $('#donationModal-error').removeClass('hidden');
                    $('#donationModal-error').html(data.error.message);

                    analyticsModel.sendGAEvent('donation', 'stripe', donationId, 'error');

                }

            }
        });
    },

    checkPlan : function (amount) {
        var plan = userDonation.findPlanByAmount(amount);

        if (plan === null) {
            userDonation._createStripePlan(amount);
        }
    },

    checkUserOpen : function () {
        if (userView.userActive) {
            donationModal.open();
        } else {
            userView.openSignUp(donationModal.open, APP.siteSlug + '-annual');
        }
    },

    open : function (donationId) {
        var activeObj = donationModal.activeObj;
        donationModal.init();

        if (donationId === undefined || donationId === null) {
            donationId = APP.siteSlug + '-annual';
        }

        var amount = 10.00;
        if(userView.isActive()){
            if (userView.donationHistory !== null && userView.donationHistory.length > 0) {
                amount = userView.donationHistory[0].amount;
                $("#donateModal-amount-group > label").removeClass("active");
                donationModal._matchUXAmount(amount);
            }
        } else {
            donationModal._matchUXAmount(amount);
        }

        if(APP.siteName !== null && APP.siteName !== undefined){
            activeObj.set("siteName", APP.siteName);

        }

        activeObj.set('siteName', APP.siteName);
        activeObj.set('siteId', APP.siteSlug);

        activeObj.set('userId', userModel.userObj.Id);

        activeObj.set('name', userModel.userObj.name);
        activeObj.set('email', userModel.userObj.email);
        activeObj.set('phone', userModel.userObj.phone);
        activeObj.set('stripeId', userModel.userObj.stripeId);

        activeObj.set('amount', amount);

        activeObj.set('amountFormat', '$'+amount.toFixed(2));

        donationModal._hideError();

        analyticsModel.sendGAEvent('donation', 'modal', donationId, 'open');

        $('#donationModal').modal('show');
    },

    _processUXAmount: function(){
        var amount = $("#donateModal-amount-group").children();
        _.forEach(amount, function(value, key){
            var inputAmount = $("#donateModal-amount-group > label:eq(" + key + ") > input").data("amount");
            if(inputAmount !== "custom"){
                donationModal.ux_amountUI.push(inputAmount);
            }
        });
    },

    _matchUXAmount: function(previousAmount){
        var isDefualt = _.contains(donationModal.ux_amountUI, previousAmount);
        if(isDefualt){
            $("#amount-" + previousAmount).parent().addClass("active");
        } else {
            $("#amount-custom").parent().addClass("active");
            $("#donateModal-amount-custom").removeClass("hidden");
        }
    },

    close : function () {

        $('#donationModal').modal('toggle');

    }
};
/**
 * Created by donbrad on 3/22/17.
 */
'use strict';

var donorListView = {
    _initialized: false,

    donorDS : new kendo.data.DataSource({
            pageSize: 12,
        aggregate: [
            { field: "total", aggregate: "sum" },
            { field: "total", aggregate: "average" },
            { field: "total", aggregate: "min" },
            { field: "total", aggregate: "max" }
         ]
    }),
    activeObj : new kendo.data.ObservableObject({siteName: null, siteSlug: null}),
    _pageSize : 12,

    init: function(){
        if(!donorListView._initialized){

            donorListView._initialized = true;

            /*$("#donorListsite-selector").kendoDropDownList({
                dataTextField: "name",
                dataValueField: "slug",
                dataSource: [
                    {name : 'All', slug: "all"},
                    {name : 'Farm Forward', slug: "farm-forward"},
                    {name : 'JIFA', slug: "jifa"},
                    {name : 'Better Food Foundation', slug: "bff"},
                    {name : 'Leadership-Circle', slug: "leadership-circle"},
                    {name : 'Buying Poultry', slug: "buying-poultry"}
                ],  // Todo : don fetch these from the sites collection
                change : function (e) {
                    var siteSlug = this.value();

                    donorListView.loadPagesDS(siteSlug);
                }
            });*/

            $('#donorList-search-input').keyup (function () {
                var val =  $('#donorList-search-input').val();

                if (val.length > 0) {
                    donorListView.donorDS.filter({field: 'name', operator: 'contains', value: val});
                } else {
                    donorListView.donorDS.filter({});
                }

            });

            $('#donorList-search-input').change (function () {
                var val =  $('#donorList-search-input').val();

                if (val.length > 0) {
                    donorListView.donorDS.filter({field: 'name', operator: 'contains', value: val});
                } else {
                    donorListView.donorDS.filter({});
                }
            });

            $("#donorList-grid").kendoGrid({
                dataSource: donorListView.donorDS,
                pageSize : 12,
                autoBind: false,
                pageable: true,
                resizable: true,
                sortable: true,
                reorderable: true,
                filterable: true,
                columnMenu: true,
               /* editable: true,
                edit : function (e) {
                    var page = e.model;
                    /!*var addItemFlag = e.model.isNew();

                     if (person.Id === undefined) {
                     person.Id = uuid.v4()
                     }

                     if (person.name !== undefined && person.name !== null) {
                     person.name = person.name.capitalize();
                     person.slug = ux.createSlug(person.name);
                     }

                     if (person.title !== undefined && person.title !== null) {
                     person.title = person.title.capitalize();
                     }*!/

                },*/
                height: 760,
                columns: [
                    { field:"siteId",title:"SiteId", width: 120 },
                    { field:"sourceId",title:"Source", width: 80 },
                    { field:"name",title:"Name", width: 120 },
                    { field:"email",title:"Email", width: 120 },
                    { field:"total",title:"Amount", width: 80, format:"{0:c2}",  attributes:{style:"text-align:right;"}},
                    { field:"date",title:"Date", width: "80px", template: "#var formatDate = moment(data.date).format('M/D/YY');# #=formatDate#"},
                    { field:"state",title:"State", width: 80},
                    { field:"zipcode",title:"Zipcode", width: 80 }/*,
                    { title: "Edit", command: [ { text: "Edit Page", click: donorListView.doEditPage }, "destroy" ], width: 160,
                        attributes: {
                            style: "text-align: center;"
                        }
                    }*/
                ]
            });
            //  kendo.bind($("#contributorView-modal"), contributorView.activeObj);
        }
    },

    fetch : function () {
        var donors = userDonation.donationDS.data();
        donorListView.donorDS.data(donors);
    },

    open: function () {
        donorListView.init();

        donorListView.fetch();

        $('#donorList-search-input').val('');


    },

    close : function () {

    }

};
/**
 * Created by donbrad on 12/15/16.
 */

var favoritesView = {
    _initialized: false,
    templateLoaded : false,
    _template : 'templates/profile.html',

    activeObj : new kendo.data.ObservableObject({
        title: null,
        name: null,
        alias: null,
        roleTitle : 'User',
        email: null,
        contactEmail: null,
        twitterId: null,
        facebookId: null,
        state: null,
        phone: null,
        address : null,
        zipcode : null,
        photoUrl : "images/icon-defaultProduct.png"
    }),

    autocompleteEnabled : false,
    placesDS : new kendo.data.DataSource(),

    mapData: function (file) {
        var dir = location.origin + '/' + file;
        return(dir);
    },

    init : function () {

        if (!favoritesView._initialized) {
            favoritesView._initialized = true;

            $("#profileLabels-listview").kendoListView({
                dataSource: favorites.labelDS,
                template: kendo.template($("#labelList-template").html()),

                selectable: false,
                change: function (e) {
                    var loc = null;
                    var data = favorites.labelDS.view(),
                        selected = $.map(this.select(), function (item) {
                            loc = data[$(item).index()];

                        });
                },
                dataBound: function (e) {
                    ux.checkEmptyData(e, "profileLabels-listview-empty");

                }

            });

            $("#profileBrands-listview").kendoListView({
                dataSource: favorites.brandDS,
                template: kendo.template($("#brandList-template").html()),
                selectable: false,
                change: function (e) {
                    var loc = null;
                    var data = favorites.brandDS.view(),
                        selected = $.map(this.select(), function (item) {
                            loc = data[$(item).index()];

                        });
                },
                dataBound: function (e) {
                    ux.checkEmptyData(e, "profileBrands-listview-empty");
                }
            });

            $("#profileProducts-listview").kendoListView({
                dataSource: favorites.productDS,
                template: kendo.template($("#productList-template").html()),
                selectable: false,
                change: function (e) {
                    var loc = null;
                    var data = favorites.productDS.view(),
                        selected = $.map(this.select(), function (item) {
                            loc = data[$(item).index()];

                        });
                },
                dataBound: function (e) {
                    ux.checkEmptyData(e, "profileProducts-listview-empty");
                }
            });

            $("#profileStores-listview").kendoListView({
                dataSource: favorites.storeDS,
                template: kendo.template($("#storeList-template").html()),
                selectable: false,
                change: function (e) {
                    var loc = null;
                    var data = favorites.storeDS.view(),
                        selected = $.map(this.select(), function (item) {
                            loc = data[$(item).index()];

                        });
                },
                dataBound: function (e) {
                    ux.checkEmptyData(e, "profileStores-listview-empty");
                }
            });

            $('.profile-list >li > a[data-toggle="tab"]').on('shown.bs.tab', function (e) {

                var activeTab = $(e.target);
                var href =  activeTab[0].attributes['href'].value;
                var tabName = href.replace('#profile-', '').capitalize();
                analyticsModel.sendGAEvent("profile", tabName, "PII");

            });

        }
    },

    open : function () {
        analyticsModel.sendGAEvent("favorites", "open", "PII");

        favoritesView.init();


         // Display the users social profile image if we have one
         if (userView.source !== 'Buying Poultry' && userView.photoUrl !== null) {
             $('#profile-image > img').attr("src", userView.photoUrl);
         } else {
             $('#profile-image > img').attr("src", "images/icon-defaultProduct.png");
         }

         var sourceStr = '<i class="fa fa-star"></i> Farm Forward';

         switch (userView.source) {
             case userView._google:
                 sourceStr = '<i class="fa fa-google-plus"></i> Google';
                 break;

             case userView._facebook:
                 sourceStr = '<i class="fa fa-facebook-f"></i> Facebook';
                 break;

             case userView._twitter:
                 sourceStr = ' <i class="fa fa-twitter"></i> Twitter';
                 break;

             case userView._liveid:
                 sourceStr = ' <i class="fa fa-windows"></i> Live Id';
                 break;
         }


         $('#favorites-profile-socialId').html(sourceStr);

    },



    doSave : function () {
        var user = userModel.userObj;

       /* var name = $('#profile-name').val();
        var email = $('#profile-email').val();
        var zipcode = $('#profile-zipcode').val();
        var address = $('#profile-address').val();
        user.name = name;
        user.email = email;
        user.zipcode = zipcode;
        user.address = address;*/


        APP.everlive.Users.updateSingle(user,
            function(data){
                //console.log(JSON.stringify(data));
                userView.updateUserInfo();
                //favoritesView.closeProfile();
               // $("#modal-profile").modal("toggle");
                ux.notify("Your profile was updated.", "success");
                analyticsModel.sendGAEvent("profile", "update", "PII");
            },
            function(error){
                ux.notify("Error saving your profile: " + JSON.stringify(error) , "error");
                analyticsModel.sendGAEvent("profile", "error", JSON.stringify(error));
            });

    },


    deleteFavorite : function (e) {
        var objectId = e.target.dataset.objectid;
        var fav = favorites.findFavoriteByObjectId(objectId);


        if (fav !== undefined && fav !== null) {
            ux.notify (fav.objectName + " removed from Favorites", "success");
            analyticsModel.sendGAEvent("favorite", "delete", fav.objectName);
            favorites.removeFavorite(fav);

        }

    },

    showFavorites: function(e){
        var section = e.target.dataset.section;
        $("#profile-favorites-menu > li > button").removeClass("active");
        $(e.target).addClass("active");
        $(".profile-favorites").addClass("hidden");
        $(".profile-favorites-" + section).removeClass("hidden");

    }
};
/**
 * Created by donbrad on 3/22/17.
 */
'use strict';

var feedbackListView = {
    _initialized: false,
    _reportInitialized : false,
    _siteSlug : null,
    _reportSlug : null,

    feedbackDS : new kendo.data.DataSource({
        pageSize: 8,
        schema: {
            model: {
                id: "Id",
                fields: {
                    category: { nullable: false },
                    priority: { nullable: false },
                    status: { nullable: false },
                    siteName:  { nullable: false },
                    senderName:  { nullable: false },
                    assignedTo:  { nullable: true },
                    content:  { nullable: false },
                    date: {nullable: false},
                    backlogSlug:  { nullable: true }
                }
            }
        },
        transport : {
            create: function (options) {
                options.success();
            },

            destroy : function (options) {
                var model = options.data;
                feedbackModel.remove(model);
                options.success();
            },

            read: function (options) {
                var pages = [];
                if (feedbackListView._siteSlug !== null) {
                    pages = feedbackModel.listBySiteSlug(feedbackListView._siteSlug);
                } else {
                    pages = feedbackModel.feedbackDS.data();
                }
                options.success(pages);
            },

            update : function (options) {
                var model = options.data;
                feedbackModel.update(model);
                options.success();
            },

            parameterMap: function(options, operation) {
                if (operation !== "read" && options.models) {
                    return {models: kendo.stringify(options.models)};
                }
            }
        }
    }),

    activeObj : new kendo.data.ObservableObject({siteName: null, siteSlug: null}),
    _pageSize : 8,
    _reportTemplate : null,

    _initReport : function () {
       /* if (feedbackListView._reportInitialized) {
            return;
        }

        feedbackListView._reportInitialized = true;
*/
        $("#feedbackReport-tabstrip").kendoTabStrip({
            animation:  {
                open: {
                    effects: "fadeIn"
                }
            }
        });

        $('#feedbackReport-comments').comments({
            profilePictureURL: 'https://viima-app.s3.amazonaws.com/media/user_profiles/user-icon.png',
            currentUserId: userModel.userObj.Id,
            roundProfilePictures: true,
            textareaRows: 3,
            enableAttachments: false,
            enableHashtags: false,
            enablePinging: false,
            getUsers: function(success, error) {
                success(commentModel._staffList);
            },

            getComments: function(success, error) {
                commentModel.read();
                var comments = commentModel.listByReportSlug(feedbackListView._reportSlug);
                success(comments);
            },

            postComment: function(data, success, error) {
                var guid = uuid.v4();

                data.Id = guid;
                data.reportSlug = feedbackListView._reportSlug;
                data.senderName = userModel.userObj.name;
                data.email =  userModel.userObj.email;
                data.senderEmail = userModel.userObj.email;

                commentModel.add(data);

                success(data);
                /*setTimeout(function() {
                    success(saveComment(data));
                }, 500);*/
            },

            putComment: function(data, success, error) {

                commentModel.update(data);
                success(data);
               /* setTimeout(function() {
                    success(saveComment(data));
                }, 500);*/
            },

            deleteComment: function(data, success, error) {

                commentModel.delete(data);

               /* setTimeout(function() {
                    success();
                }, 500);*/
            },

            upvoteComment: function(data, success, error) {
                setTimeout(function() {
                  //  success(data);
                }, 500);
            },
            uploadAttachments: function(dataArray, success, error) {
                setTimeout(function() {
                   // success(dataArray);
                }, 500);
            }
        });

    },

    init: function(){
        if(!feedbackListView._initialized){

            feedbackListView._initialized = true;

            templateLoader.load('../../../templates/feedbackReport-tmpl.html', function(status) {
                if(status){
                    feedbackListView._reportTemplate = kendo.template($("#feedbackReport-tmpl").html());
                }
            });

            $("#feedbackReport-window").kendoWindow({
                width: "1024px",
                height: "768px",
                visible: false,
                close : function () {
                    window.location.hash='#/feedbacklist'
                },
                actions: [
                    "Pin",
                    "Minimize",
                    "Maximize",
                    "Close"
                ]
            });

            $("#feedbackSite-selector").kendoDropDownList({
                dataTextField: "name",
                dataValueField: "slug",
                dataSource: [
                    {name : 'All', slug: "all"},
                    {name : 'Farm Forward', slug: "farm-forward"},
                    {name : 'JIFA', slug: "jifa"},
                    {name : 'Better Food Foundation', slug: "bff"},
                    {name : 'Leadership-Circle', slug: "leadership-circle"},
                    {name : 'Buying Poultry', slug: "buying-poultry"}
                ],

                change : function (e) {
                    var siteSlug = this.value();

                    if (siteSlug === 'all') {
                        siteSlug = null;
                    }
                    feedbackListView._siteSlug = siteSlug;

                    feedbackListView.feedbackDS.read();
                }
            });

            $('#feedbackList-search-input').keyup (function () {
                var val =  $('#feedbackList-search-input').val();

                if (val.length > 0) {
                    feedbackListView.feedbackDS.filter({field: 'title', operator: 'contains', value: val});
                } else {
                    feedbackListView.feedbackDS.filter({});
                }

            });

            $('#feedbackList-search-input').change (function () {
                var val =  $('#feedbackList-search-input').val();

                if (val.length > 0) {
                    feedbackListView.feedbackDS.filter({field: 'title', operator: 'contains', value: val});
                } else {
                    feedbackListView.feedbackDS.filter({});
                }
            });

            if (userView.isGaiaHacker()) {
                $("#feedbackList-grid").kendoGrid({
                    dataSource: feedbackListView.feedbackDS,
                    pageSize : 8,
                    autoBind: false,
                    pageable: true,
                    resizable: true,
                    sortable: true,
                    reorderable: true,
                    filterable: true,
                    columnMenu: true,
                    //selectable: true,
                    batch: true,
                //    toolbar: [{name: "save", text: "Save All Changes..."}],
                    editable: "inline",
                    /*change: function(e) {
                        var selectedRow = this.select();
                        var dataItem = this.dataItem(selectedRow[0]);

                        feedbackListView.doReport(dataItem);
                    },*/
                    /*edit : function (e) {
                     var page = e.model;
                     /!*var addItemFlag = e.model.isNew();

                     if (person.Id === undefined) {
                     person.Id = uuid.v4()
                     }

                     if (person.name !== undefined && person.name !== null) {
                     person.name = person.name.capitalize();
                     person.slug = ux.createSlug(person.name);
                     }

                     if (person.title !== undefined && person.title !== null) {
                     person.title = person.title.capitalize();
                     }*!/

                     },*/
                    height: 680,
                    columns: [
                        { field:"siteName",title:"Site",  width: "120px" },
                        { field:"category",title:"Category", editor: feedbackListView._categoryEditor, width: "80px"},
                        { field:"date",title:"Date", width: "80px", template: "#var formatDate = moment(data.date).format('M/D/YY');# #=formatDate#"},
                        { field:"priority",title:"Priority", editor: feedbackListView._priorityEditor, width: "80px" },
                        { field:"status",title:"Status", editor: feedbackListView._statusEditor, width: "120px" },
                        { field:"senderName",title:"Sender", width: "100px"},
                        { field:"content",title:"Content", width: "220px",  template: "#var con = data.content.smartTruncate(60, true);# #=con# " },
                        { field:"assignedTo",title:"Assigned", editor: feedbackListView._assignedEditor, width: "100px" },
                        { field:"backlogSlug",title:"Backlog", width: "100px" },
                        {  command: [  { text: "Details", click: feedbackListView.showDetails }, "edit", "destroy"], title: "Dev Tools",  width: "120px"}
                    ]
                });
            } else {
                $("#feedbackList-grid").kendoGrid({
                    dataSource: feedbackListView.feedbackDS,
                    pageSize : 8,
                    autoBind: false,
                    pageable: true,
                    resizable: true,
                    sortable: true,
                    filterable: true,
                    columnMenu: true,
                    reorderable: true,
                    selectable: true,
                    change: function(e) {
                        var selectedRow = this.select();
                        var dataItem = this.dataItem(selectedRow[0]);

                        feedbackListView.doReport(dataItem);
                    },
                    height: 680,
                    columns: [
                        { field:"siteName",title:"Site", width: "120px" },
                        { field:"category",title:"Category", width: "80px" },
                        { field:"date",title:"Date", width: "80px", template: "#var formatDate = moment(data.date).format('M/D/YY');# #=formatDate#" },
                        { field:"priority",title:"Priority", width: "80px" },
                        { field:"status",title:"Status", width: "120px" },
                        { field:"senderName",title:"Sender", width: "120px" },
                        { field:"content",title:"Content", width: "220px", template: "#var con = data.content.smartTruncate(80, true);# #=con# " },
                        { field:"assignedTo",title:"Assigned", width: "100px" },
                        { field:"backlogSlug",title:"Backlog", width: "100px" }
                    ]
                });
            }

            //  kendo.bind($("#contributorView-modal"), contributorView.activeObj);
        }
    },

    loadFeedbackDS : function (siteSlug) {
        var pages = null;

        if (siteSlug === null || siteSlug === 'all') {
            feedbackListView._siteSlug = null;
        } else {
            feedbackListView._siteSlug = siteSlug;
        }

        feedbackListView.feedbackDS.read();
    },

    showDetails : function (e) {
        e.preventDefault();

        var dataItem = this.dataItem($(e.currentTarget).closest("tr"));

        feedbackListView.doReport(dataItem);
    },

    doReport : function (report) {

        var obj = feedbackListView.activeObj;
        var formattedDate = moment(report.date).format("ddd, M/D/YY, h:mma");
        obj.set('Id', report.Id);
        obj.set('date', formattedDate);
        obj.set('senderName', report.senderName);
        obj.set('senderEmail', report.senderEmail);
        obj.set('category', report.category);
        obj.set('siteSlug', report.siteSlug);
        obj.set('siteName', report.siteName);

        obj.set('priority', report.priority);
        obj.set('status', report.status);
        obj.set('slug', report.slug);

        feedbackListView._reportSlug = report.slug;

        if (report.backlogSlug === undefined || report.backlogSlug === null || report.backlogSlug === null) {
            report.backlogSlug = 'None';
        }
        obj.set('backlogSlug', report.backlogSlug);
        obj.set('content', report.content);

        if (report.assignedTo === undefined || report.assignedTo === null || report.assignedTo === null) {
            report.assignedTo = 'No one yet';
        }
        obj.set('assignedTo', report.assignedTo);
        obj.set('img', report.img);
        obj.set('url', report.url);
        obj.set('userAgent', report.browserInfo.userAgent);


        var title = "FeedBack Report : " + report.siteName +  " (" + report.category + ") [" + report.priority + "]";


        var content = feedbackListView._reportTemplate(obj);

        var win= $("#feedbackReport-window").data("kendoWindow");

        win.title(title).content(content).center();
        feedbackListView._initReport();
        win.open();

        window.location.hash='#/feedbacklist?reportid='+report.Id;
    },

    doSaveReport : function () {

    },


    doViewReport : function (e) {
        var thisPage = this.dataItem($(e.currentTarget).closest("tr"));
        var pageSlug = thisPage.slug;

        APP.router.navigate("/feedback?feedbackid=" + pageSlug);
        // Invoke pageEditor with pageSlug...
    },

    open: function (siteSlug, reportId) {
        feedbackListView.init();
        $('#feedbackList-search-input').val('');
        feedbackListView.loadFeedbackDS(siteSlug);

        if (reportId !== null) {
            var report = feedbackModel.findById(reportId);

            if (report !== null) {
                if (feedbackListView._reportTemplate === null) {
                    templateLoader.load('../../../templates/feedbackReport-tmpl.html', function(status) {
                        if(status){
                            feedbackListView._reportTemplate = kendo.template($("#feedbackReport-tmpl").html());

                            feedbackListView.doReport(report);
                        }
                    });
                }

            }
        }


    },

    close : function () {

    },

    _readOnly : function (container, options) {
        ux.notify (options.field + " is readonly", 'error');
    },

    _categoryEditor : function (container, options) {
        $('<input required name="' + options.field + '"/>')
            .appendTo(container)
            .kendoDropDownList({
                autoBind: false,
                dataSource: ["Bug", "Content", "Data", "Feature", "Legal", "UX"]
            });
    },

    _priorityEditor : function (container, options) {
        $('<input required name="' + options.field + '"/>')
            .appendTo(container)
            .kendoDropDownList({
                autoBind: false,
                dataSource: ["High", "Normal", "Low"]
            });
    },

    _statusEditor : function (container, options) {
        $('<input required name="' + options.field + '"/>')
            .appendTo(container)
            .kendoDropDownList({
                autoBind: false,
                dataSource: ["Submitted", "Under Review", "In Backlog", "Deferred", "Resolved"]
            });
    },

    _assignedEditor : function (container, options) {
        $('<input required name="' + options.field + '"/>')
            .appendTo(container)
            .kendoDropDownList({
                autoBind: false,
                dataSource: ["Aaron", "Andrew", "Ben", "Claire", "Don", "Erin", "Heather", "John", "Jordan", "Michael", "Sarah"]
            });
    }

};
/**
 * Created by donbrad on 3/29/17.
 */

'use strict';

var feedbackView = {

    _initialized: false,
    _templateLoaded : true,
    _canSnapShot : true,
    _url :  '../../templates/feedback.html',
    _tag: 'feedback-modal',

    activeObj : new kendo.data.ObservableObject({
        siteName : null,
        siteSlug : null,
        senderName : null,
        senderEmail : null,
        category : null,
        content : null,
        url : null,
        img : null,
        priority : 'low',  // urgent, normal, low
        emailCopy: false,
        notify : false,
        status : null,
        backlogSlug : null,
        assignedTo : null

    }),


    init: function () {
        if (feedbackView._initialized) {
            return;
        }

        // Kick this off in init so the actual call may complete immediately
        templateLoader.loadHtml(feedbackView._tag, feedbackView._url, function(status) {
            feedbackView._templateLoaded = true;
            if(status){
                kendo.bind($("#feedback-modal"), feedbackView.activeObj);
                $('.feedback-button').addClass('hidden');

                $('#feedback-textarea').on('change keyup paste', function() {

                    var value = $(this).val();

                    if (value.length > 0){
                        $(".feedback-button").removeClass('hidden');
                    } else {
                        $(".feedback-button").addClass('hidden');
                    }
                });
            }
        });

        if (ux.browserInfo.browser.safari !== undefined) {
            // Disable snapshot of page -- jump to submit dialog
            feedbackView._canSnapShot = false;
            // disable canvas
            //$("canvas#feedback-canvas").css("display", "none");
        }

        feedbackView._initialized = true;
    },

    open : function () {
        feedbackView.init();
        if(!feedbackView._canSnapShot){
            // disable canvas
            $("canvas#feedback-canvas").css("display", "none");
        }
        $('#feedback-modal').modal('toggle');

    },

    close : function () {
        $('#feedback-modal').modal('toggle');
    },

    set : function (field, value) {
        feedbackView.activeObj.set(field, value);
    },

    initReport: function () {
        var that = feedbackView.activeObj;
        var guid = uuid.v4();
        that.set('Id', guid);
        that.set('slug', guid);
        that.set('siteName', APP.siteName);
        that.set('siteSlug', APP.siteSlug);
        that.set('senderEmail', userModel.userObj.email);
        that.set('senderName', userModel.userObj.name);
        that.set('content', null);
        that.set('img', null);
        that.set('url', 'http://buyingpoutry.tech/#/feedbacklist?reportid='+guid);
        that.set('status', 'submitted');   // submitted, open, closed, inBacklog,
        that.set('backlogSlug', null);
        that.set('category', 'Bug');  // bug, feature, ux
        that.set('priority', 'Normal');  // high, normal, low
        var localMoment = moment();
        var date = localMoment.format();
        that.set('date', date);

    },

    get : function (field) {
        return (feedbackView.activeObj.get(field));
    },

    emailCopy : function () {
        var mailto = 'mailto:' + feedbackView.activeObj.senderEmail + "?subject="+"Feedback on " + feedbackView.activeObj.siteName + "&body=";

        var body = feedbackView.activeObj.content + '%0D%0A' +
            '%0D%0ALink = ' + feedbackView.activeObj.url +
        '%0D%0AFeedback Id = ' + feedbackView.activeObj.slug;


        mailto += body;

        window.open(mailto, '_blank');

    },

    addReportComment : function () {
        var guid = uuid.v4();

        var commentObj = {
            Id: guid,
            commentId: 'c1',
            parentId: null,
            pings: [],
            reportSlug : feedbackView.activeObj.reportSlug,
            content :  feedbackView.activeObj.content,
            senderName : feedbackView.activeObj.senderName,
            fullname :  feedbackView.activeObj.senderName,
            email: feedbackView.activeObj.senderEmail,
            senderEmail : feedbackView.activeObj.senderEmail,
            profilePhotoUrl : 'https://viima-app.s3.amazonaws.com/media/user_profiles/user-icon.png',
            createdByMe : true,
            upvote_count: 0,
            user_has_upvoted: false,
            modified: new Date().getTime(),
            created:  new Date().getTime()

        };

        commentModel.add(comment);
    },


    sendReport : function () {
        var report = JSON.stringify(feedbackView.activeObj);

        if (report.notify) {
            feedbackView.notifyDev();
        }

        if (report.emailCopy) {
            feedbackView.emailCopy();
        }

        var reportObj = JSON.parse(report);

        feedbackModel.add(reportObj, function (err) {
            if (err === null) {
                ux.notify("Your feedback was received!", 'success');
                feedbackListView.feedbackDS.add(reportObj);
            }
        });

        feedbackView.close();
    },




    notifyDev : function () {
        var mailto = "mailto:donbrad@gmail.com?subject=Urgent Feedback on " + feedbackView.activeObj.siteName + "&body=";


        var body = feedbackView.activeObj.content + '%0D%0A' +
            '%0D%0ALink = ' + feedbackView.activeObj.url +
        '%0D%0AFeedback Id = ' + feedbackView.activeObj.slug;


        mailto += body;

        window.open(mailto, '_blank');
    }

};
'use strict';

var glossaryEditor = {
    search: null,
    _initialized: false,
    _editor : false,
    thisItem : null,
    activeObj : new kendo.data.ObservableObject({category: 'term, title: null, tag: null, tooltip: null, content: null'}),
    activeLink :  new kendo.data.ObservableObject({
        title: null,
        url: null,
        category: null,   // external, blog, glossary
        objectId : null
    }),

    init: function(){
        if(!glossaryEditor._initialized){

            glossaryEditor._initialized = true;

            $("#glossaryEditor-glossaryGrid").kendoGrid({
                dataSource: glossaryModel.glossaryDS,
                pageSize : 10,
                pageable: true,
                resizable: true,
                sortable: true,
                reorderable: true,
                toolbar: [{name: "create", text: "Add Glossary Entry"},  {name: "save", text: "Save All Changes..."}],
                editable: true,

                edit : function (e) {
                    var item = e.model;
                    var addItemFlag = e.model.isNew();

                    var title = item.title;
                    var slug = ux.createSlug(title);
                    if (item.slug !== slug) {
                        item.set('slug', slug);
                    }

                    var content = item.content;
                    if (content !== undefined && content !== null) {
                        content = content.replace(/<!--[\s\S]*?-->/g,"");
                        content = content.replace(/<style[\s\S]*?\/style>/g,"");

                        item.set('content', content);
                    }
                },

                save : function (e) {
                    if (e.values.name !== "") {
                        var item = e.model;
                        // the user changed the name field
                        if (e.values.title !== undefined && e.values.title !== item.title) {
                            var title = e.values.title;

                            var slug = ux.createSlug(title);

                            if (item.slug !== slug)
                                item.set('slug', slug);
                        }

                        if (e.values.content !== undefined && e.values.content !== item.content) {

                            var content = e.values.content;
                            content = content.replace(/<!--[\s\S]*?-->/g,"");
                            content = content.replace(/<style[\s\S]*?\/style>/g,"");

                            item.set('content', content);
                        }
                    }
                },

                height: 760,
                columns: [
                    { field:"category", title:"Category", width: 60, editor: glossaryEditor._categoryEditor},
                    { field:"title",title:"Title", width: 80 },
                    { field:"tag",title:"Tag",  width: 80/*, editor: glossaryEditor._tagEditor*/},
                    { field:"slug",title:"Slug",  width: 80/*, editor: glossaryEditor._slugEditor*/},
                    { field:"tooltip", title:"Tool Tip",  width: 200},
                    { field:"content",title:"Content",  width: 240, template: '# var trunc = null; if (data.content !== undefined && data.content !== null) trunc = jQuery.truncate(data.content, { length: 120, stripTags: true}); # #= trunc #', editor: glossaryEditor._contentEditor},

                    { command: [{name: "destroy", text: "Delete"}],  width: 60 }
                ]
            });

            $('#glossary-search-input').keyup (function () {
                var val =  $('#glossary-search-input').val();

                if (val.length > 0) {
                    glossaryModel.glossaryDS.filter({field: 'title', operator: 'contains', value: val});
                } else {
                    glossaryModel.glossaryDS.filter([]);
                }

            });

            $('#glossary-search-input').change (function () {
                var val =  $('#glossary-search-input').val();

                if (val.length > 0) {
                    glossaryModel.glossaryDS.filter({field: 'title', operator: 'contains', value: val});
                } else {
                    glossaryModel.glossaryDS.filter([]);
                }
            });

            $("#glossaryContent-editor").kendoEditor({
                resizable: {
                    content: false,
                    toolbar: true
                },
                pasteCleanup: {
                    css: true,
                    msAllFormatting: true,
                    msConvertLists: false
                },
                select: function(e) {
                    var editor = $("#glossaryContent-editor").data("kendoEditor");
                    var selection = editor.getSelection();

                    if (selection.focusNode.parentNode.tagName === 'A') {
                        var title = selection.focusNode.parentNode.text;
                        var slug =  selection.focusNode.parentNode.attributes['data-slug'].value;
                        var category =  selection.focusNode.parentNode.attributes['data-category'].value;
                        var linkType =  selection.focusNode.parentNode.attributes['data-linktype'].value;

                        //var targetText = selection.focusNode.parentNode.outerHTML;

                        if (linkType === 'glossary') {
                            glossaryLinkEditor.open(slug, function(link) {
                                if (link !== null) {
                                    glossaryEditor.updateLink( glossaryEditor._selection, link);
                                }
                            });
                        }



                    }

                },
                paste : function (e) {

                },
                tools: [
                    "bold", "italic", "underline", "subscript", "superscript", "justifyLeft", "justifyCenter", "justifyRight", "insertUnorderedList", "insertOrderedList",
                    "indent", "outdent","viewHtml","formatting",
                    {
                        name: "Glossary",
                        tooltip: "Add or Edit Glossary",
                        template: '<button class="k-button" onclick="glossaryEditor.addGlossary()"><span class="k-font-icon k-i-dictionary-add"></span></button>'
                    }
                ]
            });

           glossaryEditor._editor = $("#glossaryContent-editor").data("kendoEditor");

            kendo.bind($("#glossaryContent-modal"), glossaryEditor.activeObj);

        }


    },

   onShow: function() {
        if (userView.isStaff() || userView.isBlogger()) {
            $('.bpstaff').removeClass('hidden');

        } else {
            $('.bpstaff').addClass('hidden');
        }

    },

    doSearch : function (e) {
        e.preventDefault();

        var dataItem = this.dataItem($(e.currentTarget).closest("tr"));

        var url = "https://www.google.com/#q=" + dataItem.name;

        window.open(url, "_blank");
    },

    _categoryEditor : function (container, options) {
        $('<input required name="' + options.field + '"/>')
            .appendTo(container)
            .kendoDropDownList({
                autoBind: false,
                dataSource:  ["term",  "grade", "person", "reference" ]
            });
    },

    _contentEditor : function (container, options) {
        var glossaryObj = options.model;

        glossaryEditor.activeObj.set('category', glossaryObj.category);
        glossaryEditor.activeObj.set('title', glossaryObj.title);


        var content = glossaryObj.content;
        if (content !== undefined && content !== null) {
            content = content.replace(/<!--[\s\S]*?-->/g,"");
            content = content.replace(/<style[\s\S]*?\/style>/g,"");
        }


        if (glossaryObj.tooltip === undefined || glossaryObj.tooltip === null || glossaryObj.tooltip === "") {
            glossaryObj.tooltip = jQuery.truncate(content, { length: 100, words: true, stripTags: true});
        }
        glossaryEditor.activeObj.set('tooltip', glossaryObj.tooltip);

        glossaryEditor.activeObj.set('content', content);

        glossaryEditor.thisItem = options.model;

        $("#glossaryContent-modal").modal("toggle");


    },


    _slugEditor : function (container, options) {
        var glossaryObj = options.model;

        if (glossaryObj.slug === undefined || glossaryObj.slug === null) {
            var slug = options.model.title.replace(/ /g, '-');

            slug = slug.replace(/[\.\,\;\:]/g,'-');

            glossaryObj.set('slug',slug);
        }

    },


    _tagEditor : function (container, options) {
        var glossaryObj = options.model;

        var tag = options.model.title.toLowerCase();

        tag = tag.replace(/[\.\,\#\@\;\:]/g,'-');
        tag = tag.replace(/\+/g, 'plus');

        glossaryObj.set('tag',tag);
    },


    onCloseContent: function () {

        glossaryModel.glossaryDS.sync();
        // Persist content to cloud...

        $("#glossaryContent-modal").modal("toggle");
    },


    onSaveContent: function () {
        glossaryEditor.thisItem.set('content', glossaryEditor.activeObj.content);
        glossaryEditor.thisItem.set('tooltip', glossaryEditor.activeObj.tooltip);

        glossaryModel.glossaryDS.sync();


        $("#glossaryContent-modal").modal("toggle");
    },

    addGlossary : function () {
        glossaryEditor._selection = glossaryEditor._editor.getSelection();
        glossaryLinkEditor.open(null, function(link) {
            if (link !== null) {
                glossaryEditor.updateLink( glossaryEditor._selection, link);
            }
        });
    },


    editLink : function (selection, title, href, target) {
        glossaryEditor.activeLink.set('title', title);
        glossaryEditor.activeLink.set('href', href);
        glossaryEditor.activeLink.set('target', target);
        glossaryEditor.activeLink.selection = selection;
      //  $('#linkEditor-linkStatus').html('');
        $("#glossaryLink-modal").modal("toggle");
    },

    updateLink : function (selection, link) {
        var html = '<a onclick="glossaryModal.onClick(event)" class="ff-link ff-glossary"  data-linktype="glossary" data-slug="'+link.slug+'" data-category="'+link.category+
                '"> '+ link.title +'</a>';

        glossaryEditor._editor.paste(html);

    }
};


var glossaryLinkEditor = {
    _initialized: false,
    _class : 'ff-glossary',
    _callback : null,
    activeObj : new kendo.data.ObservableObject({category: 'Tag', title: null, tag: null, slug: null, tooltip: null, content: null}),
    _buttonIndex: 0,
    _typeFilter: [],

    init : function () {

        if (!glossaryLinkEditor._initialized){
            glossaryLinkEditor._initialized = true;

            $("#glossaryLink-buttonGroup").kendoMobileButtonGroup({
                select: function(e) {
                    glossaryLinkEditor._buttonIndex = e.index;
                },
                index: glossaryLinkEditor._buttonIndex
            });

            $("#glossaryLink-modal").on("show.bs.modal", function(e){
                glossaryLinkEditor.checkForOpenModal(e);
            });

            $("#glossaryLink-modal").on("hide.bs.modal", function(e) {
                ux.resetView(e)
            });
        }

        $("#glossaryLink-glossary").kendoAutoComplete({
            dataTextField: "title",
            dataValueField: "slug",
            filter: "contains",
            template: '<div><span>#: data.title #</span> <span class="pull-right"> #: data.category#</span></div>',
            suggest: true,
            placeholder: "Enter Glossary Title ...",
            select: function(e) {
                // Use the selected item or its text
                var dataItem = this.dataItem(e.item.index());
                var obj = glossaryLinkEditor.activeObj;
                obj.set('category', dataItem.category);
                obj.set('slug', dataItem.slug);
                obj.set('tag', dataItem.tag);
                obj.set('title', dataItem.title);
                obj.set('tooltip', dataItem.tooltip);
                obj.set('content', dataItem.content);

                $('#glossaryLinkEditor-insertBtn').removeClass('hidden');
            },
            dataSource: glossaryModel.glossaryDS
        });

        kendo.bind($("#glossaryLink-modal"), glossaryLinkEditor.activeObj);
    },

    _init : function () {
        var obj = glossaryLinkEditor.activeObj;
        obj.set('title', null);
        obj.set('tooltip', null);
        obj.set('content', null);
        obj.set('slug', null);
        obj.set('tag', null);
    },

    insert : function () {
        var obj = glossaryLinkEditor.activeObj;
        if (glossaryLinkEditor._callback !== null) {
            glossaryLinkEditor._callback (obj);
        }
        glossaryLinkEditor.close();
    },

    open : function (slug, callback) {
       glossaryLinkEditor._buttonIndex = 0;
        glossaryLinkEditor.init();

        glossaryLinkEditor._init();

        $('#glossaryLinkEditor-insertBtn').addClass('hidden');


        if (callback !== undefined && callback !== null) {
            glossaryLinkEditor._callback = callback;
        }
        if (slug === undefined || slug === null) {
            //creating a link
        } else {
            var dataItem = glossaryModel.findBySlug(slug);
            if (dataItem !== null) {
                var obj = glossaryLinkEditor.activeObj;
                obj.set('category', dataItem.category);
                obj.set('slug', dataItem.slug);
                obj.set('tag', dataItem.tag);
                obj.set('title', dataItem.title);
                obj.set('tooltip', dataItem.tooltip);
                obj.set('content', dataItem.content);

                $('#glossaryLink-glossary').val(dataItem.title);
            }
        }

        $("#glossaryLink-modal").modal("toggle");
    },

    close : function () {
        glossaryLinkEditor._init();
        $('#glossaryLink-glossary').val('');
        glossaryModel.glossaryDS.filter([]);
        $('#glossaryLinkEditor-insertBtn').addClass('hidden');
        $("#glossaryLink-modal").modal("toggle");

    },

    checkForOpenModal: function(e){
        // is primary modal open
        var otherModal = $(".modal.in:not(#" + e.currentTarget.id + ")")[0].id;
        
        if(otherModal !== undefined){
            ux.blurView(otherModal);
            $("#" + e.currentTarget.id + " > .modal-dialog").addClass("raiseView");
        }
    }
};
'use strict';

var glossaryView = {
    _initialized: false,
    _popoverInit: false,
    activeObj : new kendo.data.ObservableObject({
        category: 'Tag',
        title: null,
        tag: null,
        slug: null,
        tooltip: null,
        content: null,
        query: ""
    }),
    _pageSize : 10,
    popoverConfig: {
        type:'async',
        url:'../templates/glossary-tmpl.html',
        cache: true,
        multi: false,
        trigger: 'manual',
        backdrop: false,
        dismissible: true,
        closeable: true,
        async: {
            success: function(that, data) {
                glossaryView.initPopover();
            }
        },
        onShow: function($element) {

        },
        onHide: function($element){
            kendo.unbind($("#glossary-tmpl-container"));
        }
    },

    init: function(){
        if(!glossaryView._initialized){

            glossaryView._initialized = true;

            $('#glossaryView-search-input1').keyup (function () {
                var val =  $('#glossaryView-search-input1').val();

                if (val.length > 0) {
                    glossaryModel.glossaryDS.filter({
                        logic: 'or',
                        filters: [
                            {field: 'title', operator: 'contains', value: val},
                            {field: 'content', operator: 'contains', value: val}
                            ]
                    });
                } else {
                    glossaryModel.glossaryDS.filter({});
                }

            });


            $("#glossaryView-listView").kendoListView({
                dataSource: glossaryModel.glossaryDS,
                selectable : 'single',
                pageable: true,
                pageSize : glossaryView._pageSize,
                template: kendo.template($("#glossaryView-template").html())
            });

            $("#glossaryView-pager").kendoPager({
                dataSource: glossaryModel.glossaryDS
            });

            //WebuiPopovers.create(".ff-glossary", glossaryView.popoverConfig);
        }


    },

    initPopover: function(){
        kendo.bind($(".webui-popover-content"), glossaryView.activeObj);

        $("#ff-glossary-list").kendoMobileListView({
            dataSource: glossaryModel.glossaryDS,
            template: $("#ff-glossary-list-temp").html(),
            click: function(e){

            },
            dataBound: function(e) {

            }
        });


        $('#glossary-search-input').on("input", function () {

            var val =  $('#glossaryView-search-input').val();

            if (val.length > 0) {
                glossaryModel.glossaryDS.filter({
                    logic: 'or',
                    filters: [
                        {field: 'title', operator: 'contains', value: val},
                        {field: 'content', operator: 'contains', value: val}
                    ]
                });
            } else {
                glossaryModel.glossaryDS.filter({});
            }
        });

        glossaryView._popoverInit = true;
    },

    filterList: function(e){
        var category = e.target.dataset.filter;

        if($(e.target).hasClass("active")){
            $("#glossaryView-list-filters > li > button").removeClass("active");
            glossaryModel.glossaryDS.filter([]);
        } else {
            $("#glossaryView-list-filters > li > button").removeClass("active");
            $(e.target).addClass("active");
            glossaryModel.glossaryDS.filter({field: "category", operator: "eq", value: category});
        }




    },

    onShow: function () {
        glossaryModel.glossaryDS.pageSize(glossaryView._pageSize);
    },

    openPopover: function(e) {
        e.stopPropagation();

        $('.ff-glossary').webuiPopover('destroy');

        var glossarySlug = e.target.dataset.slug;
        var glossaryObj = glossaryModel.findBySlug(glossarySlug);

        glossaryView.updatePopover(glossaryObj);

        var currentEl = "#" + e.target.id;
        WebuiPopovers.show(".ff-glossary" + currentEl, glossaryView.popoverConfig);
    },

    updatePopover: function(glossaryObj){

        if(glossaryObj !== undefined){
            glossaryView.activeObj.set("title", glossaryObj.title);
            glossaryView.activeObj.set("content", glossaryObj.content);
            glossaryView.activeObj.set("category", glossaryObj.category);

        } else {
            glossaryView.activeObj.set("title", "");
            glossaryView.activeObj.set("content", "");
            glossaryView.activeObj.set("category", "");
        }

    },

    showGlossaryList: function(){
        $("#ff-glossary-current").addClass("hidden");
        $("#ff-glossary-list-container").removeClass("hidden");

    },


    openModal : function (glossaryId) {

    },


    doSearch : function (e) {
        e.preventDefault();

        var dataItem = this.dataItem($(e.currentTarget).closest("tr"));

        var url = "https://www.google.com/#q=" + dataItem.name;

        window.open(url, "_blank");
    }
};

var glossaryModal = {

    _initialized: false,
    activeObj : new kendo.data.ObservableObject({category: 'Tag', title: null, tag: null, slug: null, tooltip: null, content: null}),
    modalStack : [],
    currentIndex : 0,

    init : function () {
        if (!glossaryModal._initialized) {
            glossaryModal._initialized = true;
            kendo.bind($("#glossaryView-modal"), glossaryModal.activeObj);
        }

    },

    onClick : function (e) {
        var slug = e.currentTarget.attributes['data-slug'].value;
        //var uid = e.currentTarget.attributes['data-uid'].value;
        var category =  e.currentTarget.attributes['data-category'].value;

        glossaryModal.open(slug);

    },

    open : function (glossaryId) {
        glossaryModal.init();

        var glossaryObj = glossaryModel.findBySlug(glossaryId);

        if (glossaryObj !== null) {

            var obj = glossaryModal.activeObj;

            obj.set('category', glossaryObj.category);
            obj.set('title', glossaryObj.title);
            obj.set('tag', glossaryObj.tag);
            obj.set('slug', glossaryObj.slug);
            obj.set('tooltip', glossaryObj.tooltip);
            obj.set('content', glossaryObj.content);

            if (glossaryModal.modalStack.length === 0)
                $('#glossaryView-modal').modal('toggle');

            glossaryModal.modalStack.push(glossaryObj);

            if (glossaryModal.modalStack.length > 1) {
                $('#glossaryModal-backBtn').removeClass('hidden');
            }
        }

    },

    back : function () {
        var last = glossaryModal.modalStack.pop();
        if (glossaryModal.modalStack.length > 0) {
            var glossaryObj = glossaryModal.modalStack[glossaryModal.modalStack.length-1];

            if (glossaryObj !== null) {

                var obj = glossaryModal.activeObj;

                obj.set('category', glossaryObj.category);
                obj.set('title', glossaryObj.title);
                obj.set('tag', glossaryObj.tag);
                obj.set('slug', glossaryObj.slug);
                obj.set('tooltip', glossaryObj.tooltip);
                obj.set('content', glossaryObj.content);

            }
        }
        if (glossaryModal.modalStack.length === 1 ) {
            $('#glossaryModal-backBtn').addClass('hidden');
        }
    },

    close : function () {
        $('#glossaryModal-backBtn').addClass('hidden');
        glossaryModal.modalStack = [];
        $('#glossaryView-modal').modal('toggle');

    }
};


'use strict';

var labelEditor = {
    search: null,
    _initialized: false,
    _pageSize : 5,
    _editor : false,
    thisItem : null,
    activeObj : new kendo.data.ObservableObject({category: 'term, title: null, tag: null, tooltip: null, content: null'}),
    activeLink :  new kendo.data.ObservableObject({
        title: null,
        url: null,
        category: null,   // external, blog, glossary
        objectId : null
    }),

    init: function(){
        if(!labelEditor._initialized){

            labelEditor._initialized = true;

            $("#labelEditor-labelGrid").kendoGrid({
                dataSource: labelGuideView.labelsDS,
                pageSize : labelEditor._pageSize,
                pageable: true,
                resizable: true,
                sortable: true,
                reorderable: true,
                toolbar: [{name: "create", text: "Add Label"},  {name: "save", text: "Save All Changes..."}],
                editable: true,
                edit : function (e) {
                    var label = e.model;
                    var addItemFlag = e.model.isNew();

                    if (label.isAnimalWelfare === undefined) {
                        label.isAnimalWelfare = false;
                    }
                    if (label.isVerified === undefined) {
                        label.isVerified = false;
                    }

                    if (label.title !== undefined && label.title !== null) {
                        label.slug = ux.createSlug(label.title);

                        labelEditor._saveLabel(e.model);
                    }

                },
                save : function (e) {
                    var label = e.model;
                    label.isAnimalWelfare =  ux.isTrue(label.isAnimalWelfare);
                    label.isVerified =   ux.isTrue(label.isVerified);
                    if (label.title !== undefined && label.title !== null) {
                        label.slug = ux.createSlug(label.title);
                    }

                    labelEditor._saveLabel(e.model);
                },
                saveChanges : function (e) {
                    var label = e.model;
                },
                height: 760,
                columns: [
                    { field:"imageUrl", title:"Image", width: 130, template: labelEditor._imageTemplate,  editor: labelEditor._imageEditor},
                    { field:"category", title:"Category", width: 60, editor: labelEditor._categoryEditor},
                    { field:"title",title:"Title", width: 80 },
                    { field:"alias",title:"Alias", width: 80 },
                    { field:"slug",title:"slug", width: 80 , editor: labelEditor._slugEditor},
                    { field:"tooltip", title:"Tool Tip", template: '# var trunc = null; if (data.tooltip !== undefined && data.tooltip !== null) trunc = jQuery.truncate(data.tooltip, { length: 60, stripTags: true}); # #= trunc #', width: 100},
                    { field:"isVerified", title:"Certification",  width: 80, editor: labelEditor._isVerifiedEditor},
                    { field:"isAnimalWelfare", title:"Welfare",  width: 80, editor: labelEditor._isAnimalWelfareEditor},
                    { field:"categoryRank", title:"Rank",  width: 60, editor: labelEditor._categoryRankEditor},
                    { field:"content",title:"Content",  width: 100, template: '# var trunc = null; if (data.content !== undefined && data.content !== null) trunc = jQuery.truncate(data.content, { length: 60, stripTags: true}); # #= trunc #', editor: labelEditor._contentEditor},
                    { command: [{name: "destroy", text: "Delete"}],  width: 60 }
                ]
            });

            $('#label-search-input').keyup (function () {
                var val =  $('#label-search-input').val();

                if (val.length > 0) {
                    labelGuideView.labelsDS.filter({field: 'title', operator: 'contains', value: val});
                } else {
                    labelGuideView.labelsDS.filter({});
                }

            });

            $('#label-search-input').change (function () {
                var val =  $('#label-search-input').val();

                if (val.length > 0) {
                    labelGuideView.labelsDS.filter({field: 'title', operator: 'contains', value: val});
                } else {
                    labelGuideView.labelsDS.filter({});
                }
            });

            $("#labelEditor-editor").kendoEditor({
                resizable: {
                    content: false,
                    toolbar: true
                },
                select: function(e) {
                    var editor = $("#labelEditor-editor").data("kendoEditor");
                    var selection = editor.getSelection();

                    if (selection.focusNode.parentNode.tagName === 'A') {
                        var title = selection.focusNode.parentNode.text;
                        var href =  selection.focusNode.parentNode.href;
                        var targetText = selection.focusNode.parentNode.outerHTML;

                        window.open(href, "_blank");

                       //labelEditor.editLink(selection, title, href, targetText);


                    } /*else if (selection.focusNode.tagName === 'IMG') {

                    }  else if (selection.focusNode.tagName === 'DIV' && selection.focusNode.className === 'blog-image') {
                        // Process legacy images in legacy blogs...
                        var image = selection.focusNode.children[0];
                        var imageSrc = image.src;

                        blogEditor.editImage(selection, null, imageSrc);

                    }*/

                },
                paste : function (e) {

                },
                tools: [
                    "bold", "italic", "underline", "subscript", "superscript", "justifyLeft", "justifyCenter", "justifyRight", "insertUnorderedList", "insertOrderedList",
                    "indent", "outdent","viewHtml","formatting"
                ]
            });

           labelEditor._editor = $("#labelEditor-editor").data("kendoEditor");

            kendo.bind($("labelContent-modal"), labelEditor.activeObj);

        }


    },

    onShow: function() {
        if (userView.isStaff() || userView.isBlogger()) {
            $('.bpstaff').removeClass('hidden');

        } else {
            $('.bpstaff').addClass('hidden');
        }

        labelGuideView.labelsDS.pageSize(labelEditor._pageSize);

        $("#labelEditor-labelGrid").data("kendoGrid").refresh();

    },

    doSearch : function (e) {
        e.preventDefault();

        var dataItem = this.dataItem($(e.currentTarget).closest("tr"));

        var url = "https://www.google.com/#q=" + dataItem.name;

        window.open(url, "_blank");
    },

    _slugEditor : function (container, options) {
        var labelObj = options.model;

        var slug = options.model.title.replace(/ /g, '-');

        slug = slug.replace('+', 'plus');

        labelObj.set('slug',slug);
    },



    _categoryEditor : function (container, options) {
        $('<input required name="' + options.field + '"/>')
            .appendTo(container)
            .kendoDropDownList({
                autoBind: false,
                dataSource:  ["Best",  "Better", "Avoid" ]
            });
    },

    _categoryRankEditor : function (container, options) {
        $('<input required name="' + options.field + '"/>')
            .appendTo(container)
            .kendoDropDownList({
                autoBind: false,
                dataSource:  [1,  2, 3, 4, 5 ]
            });
    },

    _isVerifiedEditor : function (container, options) {
        $('<input required name="' + options.field + '"/>')
            .appendTo(container)
            .kendoDropDownList({
                autoBind: false,
                select: function (e) {
                    if (e.item) {
                        var field = this.dataItem(e.item);

                        var label = this._focused.context.kendoBindingTarget.source;

                        var flag = field === 'true';

                        label.set('isVerified', flag);
                    }

                },
                dataSource:  ["true", "false"]
            });
    },

    _isAnimalWelfareEditor : function (container, options) {
        $('<input required name="' + options.field + '"/>')
            .appendTo(container)
            .kendoDropDownList({
                autoBind: false,
                select: function (e) {
                    if (e.item) {
                        var field = this.dataItem(e.item);

                        var label = this._focused.context.kendoBindingTarget.source;

                        var flag = field === 'true';

                        label.set('isAnimalWelfare', flag);
                    }

                },
                dataSource:  ["true", "false"]
            });
    },


    _deletePhoto : function (labelId, callback) {

        var bpurl = 'http://gaiaapi.herokuapp.com/deletePhoto?folder=label&publicid='+labelId;
        $.ajax({
            url: bpurl,
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            success: function(data) {
                if (data.status === 'OK') {
                    callback(true);
                } else {
                    callback(false)
                }

            }
        });
    },

    _imageTemplate : function (dataItem) {
        var url = dataItem.imageUrl;

        if (url === undefined || url === null ) {
            url = 'images/icon-defaultProduct.png';
        }

        var htmlCode = '<div class="grid-label-container"> <img class="grid-label-img" src="' + url + '"/> </div>';

        return(htmlCode);
    },

    _imageEditor : function (container, options) {

        var labelObj = options.model;
        var publicId = labelObj.slug;

        labelEditor._deletePhoto(publicId, function (status) {

            if (!status) {
                ux.notify("Error deleting current image from cloud ...", 'error');
                return;
            }

            cloudinary.openUploadWidget({ cloud_name: 'hyjvcxzjt', upload_preset: 'bplabel', public_id: publicId , client_allowed_formats : ["png","gif", "jpeg"]  },
                function(error, result) {

                    if (error === null && result.length > 0) {
                        var photo = result[0];
                        labelObj.set('imageUrl',photo.secure_url);

                        labelObj.dirty = true;
                        everlive.updateOne('label', labelObj, function (err, data) {
                            labelEditor._updateIndex(labelObj.slug, function (status) {
                                if (status) {
                                    ux.notify("Updated Product photo ", 'success');
                                }
                            });
                            // Call the index update function...
                        });
                    }
                });
        });
    },

    _contentEditor : function (container, options) {
        var labelObj = options.model;

        labelEditor.activeObj.set('category', labelObj.category);
        labelEditor.activeObj.set('title', labelObj.title);
        if (labelObj.tooltip === undefined || labelObj.tooltip === null) {
            labelObj.tooltip = jQuery.truncate(labelObj.content, { length: 60, words: true, stripTags: true});
        }
        labelEditor.activeObj.set('tooltip', labelObj.tooltip);
        labelEditor.activeObj.set('content', labelObj.content);

        labelEditor.thisItem = options.model;

        $("#labelContent-modal").modal("toggle");


    },

    onSaveContent: function () {
        labelEditor.thisItem.set('content', labelEditor.activeObj.content);
        labelEditor.thisItem.set('tooltip', labelEditor.activeObj.tooltip);

        labelGuideView.labelsDS.sync();
        // Persist content to cloud...

        $("#labelContent-modal").modal("toggle");
    },


    editLink : function (selection, title, href, target) {
        labelEditor.activeLink.set('title', title);
        labelEditor.activeLink.set('href', href);
        labelEditor.activeLink.set('target', target);
        labelEditor.activeLink.selection = selection;
        $('#linkEditor-linkStatus').html('');
        $("#blogLinkEditor").modal("toggle");
    },

    updateLink : function (selection, title, href, category) {

    },

    _saveLabel : function (labelObj) {

        everlive.updateOne('label', labelObj, function (err, data) {
            if (err !== null) {
                ux.notify("Label save error " + JSON.stringify(err), 'error');
            } else {
                if (labelObj.slug !== undefined || labelObj.slug !== null) {
                    labelEditor._updateIndex(labelObj.slug, function (status) {
                        if (!status) {
                            ux.notify("Label Index Update error ", 'error');
                        }

                    });
                }
            }
        });
    },


    _updateIndex : function (slug, callback) {


        var bpurl = 'http://gaiaapi.herokuapp.com/updatelabel?slug='+slug;
        $.ajax({
            url: bpurl,
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            success: function(data) {
                if (data.status === 'OK') {
                    callback(true);
                } else {
                    callback(false)
                }

            }
        });
    },
};

/**
 * Created by donbrad on 4/14/17.
 */

'use strict';

var labelEditView = {
    _inited : false,
    _window : null,
    _createMode : false,

    activeObj: new kendo.data.ObservableObject({
        title: null,
        id: null,
        category: null,
        categoryRating : 3,
        isVerified : false,
        content: null,
        tooltip: null,
        imgUrl: "images/icon-defaultProduct.svg",
        iconUrl: "images/icon-favorite.svg"
    }),

    openModal : function (id) {

        if (!labelEditView._inited) {
            //kendo.bind($("#labelEdit-modal"), labelEditView.activeObj);

            labelEditView._inited = true;


            $("#labelEdit-editor").kendoEditor({
                resizable: {
                    content: false,
                    toolbar: true
                },
                select: function(e) {
                    var editor = $("#labelEdit-editor").data("kendoEditor");
                    var selection = editor.getSelection();

                    if (selection.focusNode.parentNode.tagName === 'A') {
                        var title = selection.focusNode.parentNode.text;
                        var href =  selection.focusNode.parentNode.href;

                    }

                },
                paste : function (e) {

                },
                tools: [
                    "bold", "italic", "underline", "subscript", "superscript", "justifyLeft", "justifyCenter", "justifyRight", "insertUnorderedList", "insertOrderedList",
                    "indent", "outdent", "createLink", "unlink", "insertImage","viewHtml","formatting", "cleanFormatting"
                ]
            });
        }

        var labelObj = labelGuideView.getLabelObj(id);


        if (labelObj !== null) {
            labelEditView._createMode = false;
            labelEditView.activeObj.set("id", id);
            labelEditView.activeObj.set("title", labelObj.title);
            labelEditView.activeObj.set("content", labelObj.content);
            labelEditView.activeObj.set("tooltip", labelObj.tooltip);
            labelEditView.activeObj.set("imgUrl", labelObj.imageUrl);
            labelEditView.activeObj.set("category", labelObj.category);
            labelEditView.activeObj.set("categoryRating", labelObj.categoryRating);
            labelEditView.activeObj.set("isVerified", labelObj.isVerified);

            //$('#labelEdit-modal').modal('toggle');

        } else {
            labelEditView._createMode = false;
            labelEditView.activeObj.set("id", null);
            labelEditView.activeObj.set("title", null);
            labelEditView.activeObj.set("content", null);
            labelEditView.activeObj.set("tooltip", null);
            labelEditView.activeObj.set("imgUrl", null);
            labelEditView.activeObj.set("category", 'Avoid');
            labelEditView.activeObj.set("categoryRating", 0);
            labelEditView.activeObj.set("isVerified", false);
        }

    },

    editImage : function () {

    },

    save : function () {

    },

    close : function () {
        //   $('#labelEdit-modal').modal('toggle');

        APP.router.navigate('#/labelguide');
    }


};
'use strict';

var labelGuideView = {
    _initialized : false,
    _labelsLoaded : false,
    _bpCloudType : 'label',
    _currentLabel : null,
    _editorShown : false,
    _claimsDS: new kendo.data.DataSource(),
    _certificationsDS : new kendo.data.DataSource(),
    _certificationNames : [],
    _claimNames : [],

    _offImage : "images/icon-favorite.svg",
    _onImage : "images/icon-favorite-active.svg",

    labelsDS : new kendo.data.DataSource({
        schema: {
            model: {
                id: "id",
                fields: {
                    categoryRank: { type: "number", validation: { required: true, min: 1} }
                }
            }
        },
        sort: [
            // sort by "categoryRating" in descending order and then by "name" in ascending order
            {field: "categoryRank", dir: "asc"},
            {field: "title", dir: "asc"}
        ]
    }),

    modalActiveObject: new kendo.data.ObservableObject({
        title: null,
        id: null,
        slug : null,
        category: null,
        categoryRating : 3,
        isVerified : false,
        isFavorite : false,
        isAnimalWelfare : false,
        content: null,
        tooltip: null,
        imgUrl: "images/icon-defaultProduct.svg",
        iconUrl: "images/icon-favorite.svg",
        ux_noAnimalWelfare: false
    }),

    categoryIndex : 0,
    _modalTemplate : "#labelTemplate",

    fetchLabels : function () {
        if (labelGuideView._labelsLoaded) {
            return;
        }

        everlive.readAll(labelGuideView._bpCloudType, function (error, data) {
            if (error !== null) {

            } else {
                console.log('Fetched ' + data.count + ' labels...');
                labelGuideView.labelsDS.data(data.result);

                labelGuideView._certificationsDS.data(labelGuideView.queryLabels({field:'isVerified', operator: 'eq', value: true}));
                labelGuideView._claimsDS.data(labelGuideView.queryLabels({field:'isVerified', operator: 'eq', value: false}));

                labelGuideView._certificationNames = [];
                for (var i=0; i<labelGuideView._certificationsDS.total(); i++) {
                    var cert = labelGuideView._certificationsDS.at(i);
                    labelGuideView._certificationNames.push(cert.alias);
                }

                labelGuideView._claimNames = [];
                for ( i=0; i<labelGuideView._claimsDS.total(); i++) {
                    var claim = labelGuideView._claimsDS.at(i);
                    labelGuideView._claimNames.push(claim.alias);
                }

                labelGuideView._labelsLoaded = true;
            }

        });
    },

    queryLabel: function (query) {
        if (query === undefined)
            return(undefined);
        var dataSource = labelGuideView.labelsDS;
        var cacheFilter = dataSource.filter();
        if (cacheFilter === undefined) {
            cacheFilter = {};
        }
        dataSource.filter( query);
        var view = dataSource.view();
        var label = view[0];

        dataSource.filter(cacheFilter);

        return(label);
    },

    queryLabels: function (query) {
        if (query === undefined)
            return(undefined);
        var dataSource = labelGuideView.labelsDS;
        var cacheFilter = dataSource.filter();
        if (cacheFilter === undefined) {
            cacheFilter = {};
        }
        dataSource.filter( query);
        var labels = dataSource.view();

        dataSource.filter(cacheFilter);

        return(labels);
    },

    findLabelByTitle : function (title) {
        return(labelGuideView.queryLabel({ field: "title", operator: "eq", value: title }));
    },

    findLabelByAlias : function (alias) {
        return(labelGuideView.queryLabel({ field: "alias", operator: "eq", value: alias }));
    },

    onShow : function () {
        labelGuideView.labelsDS.pageSize(100);
    },

    init : function () {
        var that = labelGuideView;

        if (that._initialized) {
            return;
        }

        that._initialized = true;

       // that.labelsDS.data(that._labelArray);

        that.searchTemplate = $("#labelListTemplate").html();

        that.listTemplate = $("#labelBrowserTemplate").html();

        $("#labelInput").kendoAutoComplete({
            dataSource : that.labelsDS,
          /*  dataSource: {
                data: that._labelArray,
                group: { field: "categoryRating" }
            },*/
            fixedGroupTemplate: "<div style='text-align: center;'><strong> #:data# </strong></div>",
            template: that.searchTemplate,
            height: 520,
            filter: "contains",
            dataTextField: "title",
            select : function (e) {
                var dataItem = this.dataItem(e.item.index());
                labelGuideView.openLabelModal(dataItem.id)
            },
            placeholder: "Find labels and terms..."
        });

        $("#labelCategories").kendoMobileButtonGroup({
            select: function(e) {
                var that = labelGuideView;
                that.categoryIndex = e.index;
                switch (e.index) {
                    case 0:
                        that.filterAll();
                        break;
                    case 1:
                        that.filterBest();
                        break;
                    case 2:
                        that.filterClaims();
                        break;
                }
            },
            index: 0
        });


        $("#label-listview").kendoListView({
            dataSource: that.labelsDS,
            template: that.listTemplate,
            selectable: false,
            autoBind: false,
            change : function (e) {
                var data = labelGuideView.labelsDS.view(),
                    selected = $.map(this.select(), function(item) {
                        var id =  data[$(item).index()].id;
                        labelGuideView.openLabelModal(id);
                    });
            }
        });

        kendo.bind($("#labelView-modal"), labelGuideView.modalActiveObject);

        ux.initTooltips("labelView-modal");
    },





    favoriteToggle: function(e){
        e.stopPropagation();
        if(userView.currentUser.Id !== null){
            var labelId = $(e.target.parentElement).data("id");

            var labelObj = labelGuideView.getLabelObj(labelId);




            var isFav = labelGuideView.isFavorite(labelId);

        /*    var url = "/favorite?state="+isFav+'&category=label&title='+labelObj.title;
           ux.setAnalyticsPath(url);*/


            if (isFav) {
                /* currently a favorite, remove */
                $("#label-" + labelId + " > i").text("favorite_border").removeClass("favorite");
                ux.notify(labelObj.title + " removed from favorites", "success");
                var fav = favorites.findFavoriteByObjectId(labelId);
                analyticsModel.sendGAEvent("unfavorite", "label", labelObj.title);
                if (fav !== undefined && fav !== null) {
                    favorites.removeFavorite(fav);
                }

            } else {
                /* not a favorite, add it */
                $("#label-" + labelId + " > i").text("favorite").addClass("favorite");
                ux.notify(labelObj.title + " added to favorites", "success");
                analyticsModel.sendGAEvent("favorite", "label", labelObj.title);
                favorites.addFavorite(favorites._label, labelId, labelObj.title, labelObj.imageUrl, labelObj);


            }
        } else {
            userView.openSignUp();
        }


    },

    modalFavoriteToggle: function(e){
        if(userView.currentUser.Id !== null){
            var thisLabel = labelGuideView.modalActiveObject;
            var labelId = thisLabel.id;

            var isFav = labelGuideView.modalActiveObject.isFavorite;
/*
            var url = "/favorite?state="+isFav+'&category=label&title='+thisLabel.title;
            ux.setAnalyticsPath(url);*/

            if (isFav) {
                $('#labelGuideView-favorite').html('<i class="material-icons favorite">favorite</i>');
                /*$("#labelCard-favoriteIcon > img").attr("src", labelGuideView._onImage);
                $("#labelCard-favoriteIcon > span").text("Unfavorite");*/
                favorites.addFavorite(favorites._label, labelId, thisLabel.title, thisLabel);
                analyticsModel.sendGAEvent("favorite", "label", thisLabel.title);
            } else {
                $('#labelGuideView-favorite').html('<i class="material-icons">favorite_border</i>');
              /*  $("#labelCard-favoriteIcon > img").attr("src", labelGuideView._offImage);
                $("#labelCard-favoriteIcon > span").text("Favorite");*/

                var fav = favorites.findFavoriteByObjectId(labelId);
                analyticsModel.sendGAEvent("unfavorite", "label", thisLabel.title);
                if (fav !== undefined && fav !== null) {
                    favorites.removeFavorite(fav);
                }
                // Nope -- favorites ain't labels.  _currentLabel is active label, setting to null breaks a ton of stuff
                //favorites.removeFavorite(labelGuideView._currentLabel);
                //labelGuideView._currentLabel = null;
            }
        } else {
            userView.openSignUp();
        }

    },

    filterAll : function () {
        var that = labelGuideView;
        that.labelsDS.filter([]);

    },

    filterBest : function () {
        var that = labelGuideView;
        that.labelsDS.filter( { field: "category", operator: "eq", value: 'Best' });
    },

    filterClaims : function () {
        var that = labelGuideView;
        that.labelsDS.filter( { logic: 'or',
            filters : [
                {field: "category", operator: "eq", value: 'Best'},
                {field: "category", operator: "eq", value: 'Better'} ]
        });
    },

    getLabelObj : function (id) {
        var that = labelGuideView;
        var label = null;

        label = that.labelsDS.get(id);

        if (label === undefined) {
            label = null;
        }

        return(label);
    },

    isFavorite : function (id) {
        var state = favorites.labelCache[id];
        if (state !== undefined && state)
            return(true);

        return(false);
    },

    openLabelModal : function (id) {
        var that = labelGuideView;

        var labelObj = that.getLabelObj(id);

        var isFav = labelGuideView.isFavorite(id);

        var iconUrl = labelGuideView._offImage;

        if (isFav) {
            iconUrl = labelGuideView._onImage;
        }

        if (userView.isStaff()) {
            $('.bpstaff').removeClass('hidden');

        } else {
            $('.bpstaff').addClass('hidden');
        }

        that._currentLabel = labelObj;

        if (labelObj !== null) {
            labelGuideView.modalActiveObject.set("id", id);
            labelGuideView.modalActiveObject.set("title", labelObj.title);
            labelGuideView.modalActiveObject.set("content", labelObj.content);
            labelGuideView.modalActiveObject.set("imgUrl", labelObj.imageUrl);
            labelGuideView.modalActiveObject.set("category", labelObj.category);
            labelGuideView.modalActiveObject.set("categoryRating", labelObj.categoryRating);
            labelGuideView.modalActiveObject.set("isVerified", labelObj.isVerified);

            if (labelObj.isAnimalWelfare === undefined) {
                labelObj.isAnimalWelfare = false;
            }

            if(!labelObj.isAnimalWelfare){
                labelGuideView.modalActiveObject.set("ux_noAnimalWelfare", true);
            } else {
                labelGuideView.modalActiveObject.set("ux_noAnimalWelfare", false);
            }

            labelGuideView.modalActiveObject.set("isAnimalWelfare", labelObj.isAnimalWelfare);
            labelGuideView.modalActiveObject.set("isFavorite", isFav);


            labelGuideView.modalActiveObject.set("iconUrl", iconUrl);

            switch(labelObj.category){
                case "Best":
                    $("#labelView-modal-category").addClass("rating-best").removeClass("label-claim rating-better");
                    break;
                case "Better":
                    $("#labelView-modal-category").addClass("rating-better").removeClass("rating-best label-claim");
                    break;
                case "Claim":
                    $("#labelView-modal-category").addClass("label-claim").removeClass("rating-best rating-better");
                    break;
            }

            $('#labelView-modal').modal('toggle');

            if (isFav) {
               $('#labelGuideView-favorite').html('<i class="material-icons favorite">favorite</i>');
            } else {
                $('#labelGuideView-favorite').html('<i class="material-icons">favorite_border</i>');
            }

            shareModel.setShare("Buying Poultry", "Check out " + labelObj.title, 'http://www.buyfarmfoward.com/#/labelguide?labelid=' + labelObj.id);
            var newUrl = '#/labelguide?labelid='+labelObj.id;
            history.pushState({}, null, newUrl);
        }

    },

    toggleLabelModal:function(e){
        var cardId = "";
        if(e.target.tagName !== 'IMG'){
            cardId = e.target.dataset.id;
        } else {
            cardId = e.target.parentNode.dataset.id;
        }
        labelGuideView.openLabelModal(cardId);

    },

    closeLabelModal : function () {
        $('#labelView-modal').modal('toggle');
        history.pushState({}, null, '#/labelguide');
    },


    labelModalRedirect : function (e) {
        var target = null, blog = null, external = null;

        if (e.currentTarget.attributes['data-target'] !== undefined) {
            target = e.currentTarget.attributes['data-target'].value;
            $('#labelView-modal').modal('toggle');
            APP.router.navigate(target);
        }


        if ( e.currentTarget.attributes['data-blog'] !== undefined) {
            blog = e.currentTarget.attributes['data-blog'].value;
            $('#labelView-modal').modal('toggle');
           blogView.goToBlog(blog);
        }

        if (  e.currentTarget.attributes['data-external'] !== undefined) {
            external = e.currentTarget.attributes['data-external'].value;
            $('#labelView-modal').modal('toggle');
            window.open(external, "_blank");
        }



    },

    editLabel : function () {
        var labelId = labelGuideView.modalActiveObject.id;
        $('#labelView-modal').modal('toggle');
        APP.router.navigate('#/labeleditor?labelid='+labelId);
    },

    deleteLabel : function () {
        var labelId = labelGuideView.modalActiveObject.id;
        var labelObj = labelGuideView.getLabelObj(labelId);


        $('#labelView-modal').modal('toggle');
        //labelEditView.close();
        ux.notify("Deleted Label " + labelObj.title, "delete");

        labelGuideView.labelsDS.remove(labelObj);

        everlive.deleteMatching('label', {'id': labelId}, function (error, data) {
            if (error !== null) {
                ux.notify("Error deleting Label : " + JSON.stringify(error), 'error');
            }
        });

    }



};


/**
 * Created by donbrad on 10/31/16.
 */


'use strict';

var locationView = {

    onInit : false,
    map : null,
    autocompleteService : null,
    geocoder : null,
    markers : [],
    centerMarker : null,
    yelpResults : [],
    algoliaResults : [],
    haveYelp: false,
    haveAlgolia : false,
    _modalZoomLevel : 13,
    mapsGeoLocateUrl : "https://www.googleapis.com/geolocation/v1/geolocate?key=AIzaSyAa-0ll5tP3m3CW0DbfZpGNcCn5xbeAZgM",
    mapsGeoCodeUrl : 'https://maps.googleapis.com/maps/api/geocode/json?key=AIzaSyAa-0ll5tP3m3CW0DbfZpGNcCn5xbeAZgM&address=',
    mapsDirUrl : 'https://www.google.com/maps/dir/',
    fitToMap : false,
    locations : new kendo.data.DataSource({sort: { field: "distance", dir: "asc" }}),
    filterDS : new kendo.data.DataSource(),
    geoCodeDS : new kendo.data.DataSource(),
    placesDS : new kendo.data.DataSource(),
    lastPosition : {lat: 0, lng: 0},
    lastAddress : null,
    markerLat : 0,
    markerLng : 0,
    markerTitle : 'Current Location',

    activeObj: new kendo.data.ObservableObject({
        name: null,
        address: null,
        category: null,
        website: null,
        ux_category: true
    }),

    enableCrawl : false,

    yelpTerms : [
        'farmers',
        'food',
        'grocery',
        'meat'
    ],

    rejectTerms : [
        '7-eleven',
        'circle k',
        'liquor'
    ],
    acceptStores : [
        "trader joe's",
        "whole foods",
        "raley's",
        "knob hill",
        "kroger",
        "albertson's",
        "wegmans",
        "publix",
        "market basket",
        "spout's",
        "the fresh market",
        "stater bros",
        "walmart",
        "winco",
        "hy-vee",
        "fareway"
    ],

    init : function () {

        if (userView.isStaff()) {
            locationView.enableCrawl = true;
        }

        if (locationView.onInit) {
            return;
        }

      //  ux.notify ("Building Map...", "success");
        locationView.onInit = true;

        locationView.algoliaHelper = algoliasearchHelper(algolia.client, "location", {hitsPerPage: 15});

        locationView.algoliaHelper.setQueryParameter('getRankingInfo', true);


        locationView.map = new google.maps.Map(document.querySelector('#location-map'), { streetViewControl: true, mapTypeControl: false, zoom: 8, minZoom: 6, maxZoom: 16 });

        locationView.autcompleteService = new google.maps.places.AutocompleteService();

        locationView.geocoder = new google.maps.Geocoder;

        locationView.setSearchHandler();

        locationView.map.addListener('center_changed', function() {
            var center = locationView.map.getCenter();
            var gpsLoc = {
                lat: center.lat(),
                lng: center.lng()
            };

            if (locationView.isNewLocation(gpsLoc)) {
                var locStr = gpsLoc.lat.toString() + ', ' + gpsLoc.lng.toString();
                locationView.haveAlgolia = false;
                locationView.haveYelp = false;
                locationView.algoliaHelper.setQueryParameter('aroundLatLng',locStr).search();
                locationView.lastPosition.lat = gpsLoc.lat;
                locationView.lastPosition.lng = gpsLoc.lng;

                if (locationView.enableCrawl) {
                    locationView.searchYelp();
                } else {
                    locationView.haveYelp = true;
                    locationView.processHits();
                }


            }
        });

        $("#location-items").kendoListView({
            dataSource: locationView.locations,
            template: kendo.template($("#locationTemplate").html()),
            selectable: true,
            change: function(e) {
                var loc = null;
                var data = locationView.locations.view(),
                    selected = $.map(this.select(), function(item) {
                        loc = data[$(item).index()];
                        locationView.locationModal(loc);
                    });
            }
        });

        $("#location-searchbox").on('input', function() {
            var query = this.value;
            if (query.length > 0) {
                locationView.locations.filter( {"logic":"or",
                    "filters":[
                        {
                            "field":"name",
                            "operator":"contains",
                            "value":query},
                        {
                            "field":"address",
                            "operator":"contains",
                            "value":query},
                        {
                            "field":"category",
                            "operator":"contains",
                            "value":query}
                    ]});
            } else {
                locationView.locations.filter([]);
            }
        });
        var tab = $("#mobile-map-listview");
        $(".mobile-map-menu").kendoTabStrip({
            select: function(e){

                var selectedId = e.item.id.toString();
                if(selectedId === "mobile-map"){
                    $(".mapBox").removeClass("hidden");
                    $(".location-listBox").addClass("hidden");
                } else {
                    $(".location-listBox").removeClass("hidden");
                    $(".mapBox").addClass("hidden");
                }


            }
        }).data("kendoTabStrip");

        kendo.bind($("#location-modal"), locationView.activeObj);

        ux.initTooltips("location-modal");


        $("#geoCode-listView").kendoListView({
            dataSource: locationView.geoCodeDS,
            template: kendo.template($("#geoCodeTemplate").html()),
            selectable: true,
            change: function(e) {
                var loc = null;
                var data = locationView.geoCodeDS.view(),
                    selected = $.map(this.select(), function(item) {
                        loc = data[$(item).index()];
                        if (loc.placeId !== undefined && loc.placeId !== null) {
                            var placeId = loc.placeId;
                            locationView._geoCodePlaceId(placeId, function (result) {
                                var geoCode = result;
                                var lat = geoCode.geometry.location.lat(), lng = geoCode.geometry.location.lng();
                                var fullAddress = geoCode.formatted_address;

                                fullAddress = fullAddress.replace(', USA', '');

                                ux.notify ("Setting location to : " + fullAddress, "success");
                                locationView.lastAddress = fullAddress;

                                locationView.geoCodeDS.data([]);
                                $('#geoCode-search').val("");
                                $("#changeLocationModal").modal("toggle");

                                locationView.haveAlgolia = false;
                                locationView.haveYelp = false;
                                locationView.fitToMap = true;
                                locationView.setCenterMarker(lat, lng, fullAddress);
                                locationView.map.setCenter({lat: lat, lng: lng});
                                var locStr = lat.toString() + ', ' + lng.toString();
                                locationView.algoliaHelper.setQueryParameter('aroundLatLng', locStr).search();
                                locationView.lastPosition.lat = lat;
                                locationView.lastPosition.lng = lng;
                                if (locationView.enableCrawl) {
                                    locationView.searchYelp();
                                } else {
                                    locationView.haveYelp = true;
                                    locationView.processHits();
                                }
                            });

                        } else {
                            var address = loc.address;
                            locationView._geoCodeAddress(address, function (result) {
                                var geoCode = result;
                                var lat = geoCode.geometry.location.lat(), lng = geoCode.geometry.location.lng();
                                var fullAddress = geoCode.formatted_address;

                                fullAddress = fullAddress.replace(', USA', '');

                                ux.notify ("Setting location to : " + fullAddress, "success");
                                locationView.lastAddress = fullAddress;

                                locationView.geoCodeDS.data([]);
                                $('#geoCode-search').val("");
                                $("#changeLocationModal").modal("toggle");

                                locationView.haveAlgolia = false;
                                locationView.haveYelp = false;
                                locationView.fitToMap = true;
                                locationView.setCenterMarker(lat, lng, fullAddress);
                                locationView.map.setCenter({lat: lat, lng: lng});
                                var locStr = lat.toString() + ', ' + lng.toString();
                                locationView.algoliaHelper.setQueryParameter('aroundLatLng', locStr).search();
                                locationView.lastPosition.lat = lat;
                                locationView.lastPosition.lng = lng;
                                if (locationView.enableCrawl) {
                                    locationView.searchYelp();
                                } else {
                                    locationView.haveYelp = true;
                                    locationView.processHits();
                                }
                            });
                        }
             /*           var address = loc.address;
                        locationView._geoCodeAddress(address, function (result) {
                            var geoCode = result;
                            var lat = geoCode.geometry.location.lat(), lng = geoCode.geometry.location.lng();
                            var fullAddress = geoCode.formatted_address;

                            fullAddress = fullAddress.replace(', USA', '');

                            ux.notify ("Setting location to : " + fullAddress, "success");
                            locationView.lastAddress = fullAddress;

                            locationView.geoCodeDS.data([]);
                            $('#geoCode-search').val("");
                            $("#changeLocationModal").modal("toggle");

                            locationView.haveAlgolia = false;
                            locationView.haveYelp = false;
                            locationView.fitToMap = true;
                            locationView.map.setCenter({lat: lat, lng: lng});
                            var locStr = lat.toString() + ', ' + lng.toString();
                            locationView.algoliaHelper.setQueryParameter('aroundLatLng', locStr).search();
                            locationView.lastPosition.lat = lat;
                            locationView.lastPosition.lng = lng;
                            if (locationView.enableCrawl) {
                                locationView.searchYelp();
                            } else {
                                locationView.haveYelp = true;
                                locationView.processHits();
                            }
                        });*/
                        /*var url = locationView.mapsGeoCodeUrl+address;
                        $.ajax({
                            type: "GET",
                            url: url,
                            success: function ( result, textStatus, jqXHR ) {

                                if (result.status === 'OK') {
                                    var geoCode = result.results[0];
                                    var lat = geoCode.geometry.location.lat, lng = geoCode.geometry.location.lng;
                                    var fullAddress = geoCode.formatted_address;

                                    fullAddress = fullAddress.replace(', USA', '');

                                    ux.notify ("Setting location to : " + fullAddress, "success");
                                    locationView.lastAddress = fullAddress;

                                    locationView.geoCodeDS.data([]);
                                    $('#geoCode-search').val("");
                                    $("#changeLocationModal").modal("toggle");

                                    locationView.haveAlgolia = false;
                                    locationView.haveYelp = false;
                                    locationView.fitToMap = true;
                                    locationView.map.setCenter({lat: lat, lng: lng});
                                    var locStr = lat.toString() + ', ' + lng.toString();
                                    locationView.algoliaHelper.setQueryParameter('aroundLatLng', locStr).search();
                                    locationView.lastPosition.lat = lat;
                                    locationView.lastPosition.lng = lng;
                                    if (locationView.enableCrawl) {
                                        locationView.searchYelp();
                                    } else {
                                        locationView.haveYelp = true;
                                        locationView.processHits();
                                    }
                                }
                            },
                            dataType: 'json'
                        });*/

                    });
            }
        });

        $("#geoCode-search").on('input', function() {
            var query = this.value;
            if (query.length > 2) {
                locationView._processGeoCodeQuery(query);
                $("#geoCode-helper").removeClass("hidden");
            } else {
                locationView.geoCodeDS.data([]);
                $("#geoCode-helper").addClass("hidden");
            }
        });


        $("#findNearest-search").on('input', function() {
            var query = this.value;
            if (query.length > 2) {
                locationView._processFindNearestQuery(query);
            } else {
                locationView.placesDS.data([]);
            }
        });

        $("#findNearest-listView").kendoListView({
            dataSource: locationView.placesDS,
            template: kendo.template($("#findNearestTemplate").html()),
            selectable: true,
            change: function(e) {
                var loc = null;
                var data = locationView.placesDS.view(),
                    selected = $.map(this.select(), function(item) {
                        loc = data[$(item).index()];

                        if (loc.placeId !== undefined && loc.placeId !== null) {
                            var placeId = loc.placeId;
                            locationView._geoCodePlaceId(placeId, function (result) {
                                var geoCode = result;
                                var lat = geoCode.geometry.location.lat(), lng = geoCode.geometry.location.lng();
                                var fullAddress = geoCode.formatted_address;

                                fullAddress = fullAddress.replace(', USA', '');

                                ux.notify ("Setting location to : " + fullAddress, "success");
                                locationView.lastAddress = fullAddress;

                                locationView.geoCodeDS.data([]);
                                $('#findNearest-search').val("");
                                $("#findNearestModal").modal("toggle");

                                locationView.haveAlgolia = false;
                                locationView.haveYelp = false;
                                locationView.fitToMap = true;
                                locationView.map.setCenter({lat: lat, lng: lng});
                                locationView.setCenterMarker(lat, lng, fullAddress);
                                var locStr = lat.toString() + ', ' + lng.toString();
                                locationView.algoliaHelper.setQueryParameter('aroundLatLng', locStr).search();
                                locationView.lastPosition.lat = lat;
                                locationView.lastPosition.lng = lng;
                                if (locationView.enableCrawl) {
                                    locationView.searchYelp();
                                } else {
                                    locationView.haveYelp = true;
                                    locationView.processHits();
                                }
                            });

                        } else {
                            var address = loc.address;
                            locationView._geoCodeAddress(address, function (result) {
                                var geoCode = result;
                                var lat = geoCode.geometry.location.lat(), lng = geoCode.geometry.location.lng();
                                var fullAddress = geoCode.formatted_address;

                                fullAddress = fullAddress.replace(', USA', '');

                                ux.notify ("Setting location to : " + fullAddress, "success");
                                locationView.lastAddress = fullAddress;

                                locationView.geoCodeDS.data([]);
                                $('#findNearest-search').val("");
                                $("#findNearestModal").modal("toggle");

                                locationView.haveAlgolia = false;
                                locationView.haveYelp = false;
                                locationView.fitToMap = true;
                                locationView.map.setCenter({lat: lat, lng: lng});
                                locationView.setCenterMarker(lat, lng, fullAddress);
                                var locStr = lat.toString() + ', ' + lng.toString();
                                locationView.algoliaHelper.setQueryParameter('aroundLatLng', locStr).search();
                                locationView.lastPosition.lat = lat;
                                locationView.lastPosition.lng = lng;
                                if (locationView.enableCrawl) {
                                    locationView.searchYelp();
                                } else {
                                    locationView.haveYelp = true;
                                    locationView.processHits();
                                }
                            });
                        }

                        /*var url = locationView.mapsGeoCodeUrl+address;
                        $.ajax({
                            type: "GET",
                            url: url,
                            success: function ( result, textStatus, jqXHR ) {

                                if (result.status === 'OK') {
                                    var geoCode = result.results[0];
                                    var lat = geoCode.geometry.location.lat, lng = geoCode.geometry.location.lng;
                                    var fullAddress = geoCode.formatted_address;

                                    fullAddress = fullAddress.replace(', USA', '');

                                    ux.notify ("Setting location to : " + fullAddress, "success");
                                    locationView.lastAddress = fullAddress;

                                    locationView.geoCodeDS.data([]);
                                    $('#geoCode-search').val("");
                                    $("#changeLocationModal").modal("toggle");

                                    locationView.haveAlgolia = false;
                                    locationView.haveYelp = false;
                                    locationView.fitToMap = true;
                                    locationView.map.setCenter({lat: lat, lng: lng});
                                    var locStr = lat.toString() + ', ' + lng.toString();
                                    locationView.algoliaHelper.setQueryParameter('aroundLatLng', locStr).search();
                                    locationView.lastPosition.lat = lat;
                                    locationView.lastPosition.lng = lng;
                                    if (locationView.enableCrawl) {
                                        locationView.searchYelp();
                                    } else {
                                        locationView.haveYelp = true;
                                        locationView.processHits();
                                    }
                                }
                            },
                            dataType: 'json'
                        });
*/
                    });
            }
        });
    },


    findNearest : function () {
        // Display Find Nearest Modal
        $("#findNearestModal").modal("toggle");
    },


    findAddress : function () {
        var address = $('#geoCode-search').val();
        locationView._geoCodeAddress(address, function (result) {

            $("#changeLocationModal").modal("toggle");

            var newAddress = result.formatted_address;

            newAddress = newAddress.replace(', USA', "");

            var lat = result.geometry.location.lat(),
                lng = result.geometry.location.lng();

            ux.notify("Setting your location to " + newAddress, 'Success');
            locationView.lastPosition.lat = lat;
            locationView.lastPosition.lng = lng;
            locationView.lastAddress = newAddress;
            $('#geoCode-search').val("");
            locationView.geoCodeDS.data([]);
            locationView.haveAlgolia = false;
            locationView.haveYelp = false;
            locationView.fitToMap = true;
            locationView._processLocation(lat, lng);
        });
    },

    showStore : function (objectId, fromUrl) {
        ux.notify("Searching for store...");
        algolia.locationIndex.getObject(objectId, function (err, content) {
            if (err === null) {
                ux.notify("Loading " + content.name + " at " + content.address);
                locationView._processLocation(content._geoloc.lat, content._geoloc.lng);
                locationView.locationModal(content);
            } else {
                if (fromUrl !== undefined && fromUrl) {
                    locationView.getUserLocation();
                }
            }

        });
    },


    showLocation : function (address, lat, lng) {
        ux.notify("Looking up " + address);
        locationView._processLocation(lat, lng);
    },

    _updateAddressUrl : function (address, lat, lng) {
        var newUrl = '#/location?address='+address+'&lat='+lat+'&lng='+lng;
        history.pushState({}, null, newUrl);
    },


    _updatePlaceUrl : function (objectId) {
        var newUrl = '#/location?objectid='+objectId;
        history.pushState({}, null, newUrl);
    },


    _reverseGeoCode : function (lat, lng) {
        var latlng = {lat: parseFloat(lat), lng: parseFloat(lng)};
        locationView.geocoder.geocode({'location': latlng}, function(results, status) {
            if (status === 'OK') {
                if (results[0]) {
                    var address = results[0].formatted_address;
                    locationView.lastAddress = address;
                    locationView.lastPlaceId = results[0].place_id;
                    ux.notify("Located you at " + address);
                    locationView._updateAddressUrl(address,lat, lng);

                } else {
                    ux.notify('No Address results found');
                }
            } else {
                ux.notify('Reverse geocoder failed due to: ' + status);
            }
        });
    },

    _geoCodeAddress : function (address, callback) {
        locationView.geocoder.geocode({'address': address}, function(results, status) {
            if (status === 'OK') {
                if (results[0]) {
                    callback(results[0]);
                } else {
                    ux.notify('No Geocode  results found');
                    callback(null);
                }
            } else {
                ux.notify('Geocoder failed due to: ' + status);
                callback(null);
            }
        });
    },

    _geoCodePlaceId : function (placeid, callback) {
        locationView.geocoder.geocode({'placeId': placeid}, function(results, status) {
            if (status === 'OK') {
                if (results[0]) {
                    callback(results[0]);
                } else {
                    ux.notify('No Geocode  results found');
                    callback(null);
                }
            } else {
                ux.notify('Geocoder failed due to: ' + status);
                callback(null);
            }
        });
    },

    _processGeoCodeQuery : function (query) {

        //locationView.autcompleteService.getPlacePredictions({ input: query/*, options: {types: ['address']}*/ }, function(predictions, status) {
        locationView.autcompleteService.getQueryPredictions({ input: query, options: {types: ['geocode']} }, function(predictions, status) {
            if (status === "ZERO_RESULTS") {
                locationView.geoCodeDS.data([]);
            }
            if (status == google.maps.places.PlacesServiceStatus.OK) {
                var ds = locationView.geoCodeDS;
                ds.data([]);
                predictions.forEach( function (prediction) {
                    var desObj = {category:"Area", description: prediction.description, placeId: prediction.place_id};
                    switch (prediction.types[0]) {
                        case 'geocode':
                        case 'locality':
                        case 'political':
                        case  'street_address':

                            desObj.type = prediction.types[0];
                            if (prediction.terms.length == 3) {
                                desObj.title = "City";
                                desObj.address = prediction.terms[0].value + ",  " + prediction.terms[1].value;
                            } else if (prediction.terms.length == 4) {
                                desObj.title = "Area";
                                desObj.address = prediction.terms[0].value + " " + prediction.terms[1].value + ", " + prediction.terms[2].value;
                            } else if (prediction.terms.length == 5) {
                                desObj.title = "Address";
                                desObj.address = prediction.terms[0].value + " " + prediction.terms[1].value + ", " + prediction.terms[2].value + ", " + prediction.terms[3].value;
                            } else {
                                desObj.address = prediction.description;
                            }
                            ds.add(desObj);
                            break;
                    }
                });
            }

        });

    },


    _processFindNearestQuery : function (query) {

        locationView.autcompleteService.getPlacePredictions({ input: query, options: {types: ['establishment']} }, function(predictions, status) {
            if (status === "ZERO_RESULTS") {
                locationView.placesDS.data([]);
            }
            if (status == google.maps.places.PlacesServiceStatus.OK) {
                var ds = locationView.placesDS;
                ds.data([]);
                predictions.forEach( function (prediction) {
                    var desObj = {category:"Area", name: null, title: null, description: prediction.description, placeId: prediction.place_id};
                    switch (prediction.types[0]) {
                        case 'geocode':
                        case 'locality':
                        case 'political':
                        case  'street_address':

                            desObj.type = prediction.types[0];
                            if (prediction.terms.length == 3) {
                                desObj.title = "City";
                                desObj.name = prediction.structured_formatting.main_text;
                                desObj.address =  prediction.structured_formatting.secondary_text;
                            } else if (prediction.terms.length == 4) {
                                desObj.title = "Area";
                                desObj.name = prediction.structured_formatting.main_text;
                                desObj.address =  prediction.structured_formatting.secondary_text;
                            } else if (prediction.terms.length == 5) {
                                desObj.title = "Address";
                                desObj.name = prediction.structured_formatting.main_text;
                                desObj.address =  prediction.structured_formatting.secondary_text;
                            } else {
                                desObj.address = prediction.description;
                            }
                            ds.add(desObj);
                            break;
                        case 'establishment' :
                            desObj.title = "Place";
                            desObj.type = prediction.types[0];
                            desObj.placeId = prediction.place_id;
                            desObj.name = prediction.structured_formatting.main_text;
                            desObj.address = prediction.structured_formatting.secondary_text;
                            ds.add(desObj);
                            break;
                    }
                });
            }

        });

    },
    queryLocations: function (query) {
        if (query === undefined)
            return(undefined);
        var dataSource =  locationView.locations;
        var cacheFilter = dataSource.filter();
        if (cacheFilter === undefined) {
            cacheFilter = {};
        }

        dataSource.filter( query);
        var view = dataSource.view();

        dataSource.filter(cacheFilter);

        return(view);
    },

    findLocation : function (markerId) {

        var groups = locationView.queryLocations({field: "markerId", operator: "eq", value: markerId});

        if (groups.length === 0) {
            return(null);
        }
        return (groups[0]);
    },

    findLocationByObjectId : function (objectId) {
        var groups = locationView.queryLocations({field: "ObjectID", operator: "eq", value: objectId});

        if (groups.length === 0) {
            return(null);
        }
        return (groups[0]);
    },

    changeLocation: function(isError){
      // todo - wire location change
        if(isError){
            $("#changeLocationModal").addClass("location-error").modal("toggle");
            $("#changeLocationTitle").html('<i class="fa fa-exclamation-triangle" aria-hidden="true"></i> Error retrieving your location');
        } else {
            $("#changeLocationModal").removeClass("location-error").modal("toggle");
            $("#changeLocationTitle").html("Set Location");
        }
    },


    markerClick : function (e) {

        var marker = this;
        var markerId = marker.markerId;

        var loc = locationView.findLocation(markerId);

        locationView.locationModal(loc);

    },

    clearMarkers : function () {
        var that = locationView;
        for(var i=0; i < that.markers.length; i++){
            that.markers[i].setMap(null);
        }
        that.markers = new Array();
    },

    searchYelp : function () {
        var yelpAPI = "/yelp?lat="+locationView.lastPosition.lat+"&lng="+locationView.lastPosition.lng;
        $.getJSON( yelpAPI, {
            format: "json"
        }).done(function( data ) {
                var places = data.businesses;
                var count = data.total;
                 locationView.yelpResults = [];
                for (var i=0; i<places.length; i++) {

                    var place = places[i];
                    // Check the name -- exclude liquour and convenience stores
                    if (!locationView.isReject(place.name)) {
                        var hit = {category : "Unknown", gradeName: "C", gradeScore: 7, source: "yelp"};
                        hit.name = place.name;
                        hit.address = place.location.display_address[0] + ", " + place.location.display_address[1];
                        hit._rankingInfo = {geoDistance : place.distance};
                        hit._geoloc = {lat : place.location.coordinate.latitude, lng : place.location.coordinate.longitude};
                        hit.phone = place.phone;
                        hit.website = place.url;
                        hit.yelpId = place.id;
                        hit.rating = place.rating;
                        hit.city = place.location.city;
                        hit.state = place.location.state_code;
                        hit.zipcode = place.location.postal_code;


                        locationView.yelpResults.push(hit);
                    }

                }

                locationView.haveYelp = true;

                locationView.processHits();
            });
    },


    getYelpInfo : function (lat, lng, name, callback) {
        var yelpAPI = "/yelp?lat="+lat+"&lng="+lng+"&q="+name;
        $.getJSON( yelpAPI, {
            format: "json"
        }).done(function( data ) {
            var places = data.businesses;
            var count = data.total;

            if (count > 0) {
                callback(places);
            } else {
                callback ([]);
            }

        });
    },




    // In future, will fetch google places details such as hours open, parking...
    searchPlaces : function () {
        var pnt = new google.maps.LatLng(locationView.lastPosition.lat,locationView.lastPosition.lng);

    },

    getPlaceDetails : function () {

    },


    filterHits : function (array) {
        var that = locationView;

        var finalDS = new kendo.data.DataSource();

        that.filterDS.data([]);

        that.filterDS.data(array);

        that.filterDS.group({field : 'address'});

        var filtered = that.filterDS._view;

        for (var i=0; i<filtered.length; i++) {

            var loc = filtered[i].items[0];

            var dist = locationView.getDistance(loc._geoloc.lat,loc._geoloc.lng);

            loc.distance = dist;

            finalDS.add(loc);
        }
        finalDS.sort({ field: "distance", dir: "asc" });
        var results = finalDS.view();
        return(results);
    },

    removeCenterMarker : function () {
        if (locationView.centerMarker !== null) {
            locationView.centerMarker.setMap(null);
            locationView.centerMarker = null;
        }
    },


    setCenterMarker : function (lat, lng, title) {
        locationView.markerLat = lat;
        locationView.markerLng = lng;
        locationView.markerTitle = title;
    },


    displayCenterMarker : function () {

        locationView.removeCenterMarker();

        var image = {
            url: "/images/mapIcon-current.png",
            scaledSize: new google.maps.Size(16,36)
        };

        locationView.centerMarker = new google.maps.Marker({
            markerId : 9999,
            position: {lat:  locationView.markerLat, lng: locationView.markerLng},
            map: locationView.map,
            icon: image,
            zIndex: 1,
            title:  locationView.markerTitle
        });
    },


    processHits : function () {
        var that = locationView;

        if (!that.haveYelp || !that.haveAlgolia) {
            return;
        }

        locationView.locations.data([]);
        locationView.removeCenterMarker();
        locationView.clearMarkers();
        locationView.displayCenterMarker();

        var array = [];

        for (var a=0; a<that.algoliaResults.length; a++) {
            that.algoliaResults[a].source = "index";
            array.push(that.algoliaResults[a]);
        }

        if (locationView.enableCrawl) {
            for (var y=0; y<that.yelpResults.length; y++) {

                var yelp = that.yelpResults[y];
                if (!locationView.isIndexStore(yelp.name, yelp.address)) {
                    yelp.objectID = 0;
                    yelp.source = 'yelp';

                    array.push(yelp);
                }

            }
        }


        array = that.filterHits(array);

        // Add the markers to the map
        for (var i = 0; i < array.length; ++i) {
            var hit = array[i];

            var iconBase = 'images/';
            var icon = 'mapIcon-default.svg';
            //todo : don - not sure why some index entries are missing a category
            if (hit.category === undefined || hit.category === null) {
                hit.category = "unknown";
            }


            if (hit.isRecommended === undefined) {
                hit.isRecommended = false;
            }

            if (hit.isRecommended) {
                icon = 'mapIcon-best.svg';
            }

          /*  var categoryStr = hit.category.toLowerCase();
            switch(categoryStr) {
                case "best":
                    icon = 'mapIcon-best.svg';
                    break;
                case "better":
                    icon = 'mapIcon-better.svg';
                    break;
                case "unknown":
                case "avoid":
                    icon = 'mapIcon-default.svg';
                    break;
            }*/

            var imageObj = {
                url: iconBase + icon,
                scaledSize: new google.maps.Size(36,36),
                labelOrigin: new google.maps.Point(18,18),
                anchor: new google.maps.Point(18,36)
            };
            var indexText = i + 1;
            var labelText = indexText.toString();
            var labelObj = {
                color: "#fff",
                fontWeight: "600",
                fontSize: "1.5em",
                text: labelText
            };

            var marker = new google.maps.Marker({
                markerId : i,
                position: {lat: hit._geoloc.lat, lng: hit._geoloc.lng},
                label: labelObj,
                icon: imageObj,
                title : hit.name,
                map: locationView.map
            });

            marker.addListener('click', locationView.markerClick);

            locationView.markers.push(marker);


            var loc = {
                markerId: i,
                objectID : hit.objectID,
                lat : hit._geoloc.lat,
                lng: hit._geoloc.lng,
                name : hit.name,
                address : hit.address,
                distance : hit.distance,
                city : hit.city ? hit.city : null,
                state : hit.state ? hit.state : null,
                zipcode : hit.zipcode ? hit.zipcode : null,
                phone : hit.phone ? hit.phone : null,
                website : hit.website ? hit.website : null,
                isRecommended : hit.isRecommended ? hit.isRecommended : false,
                category: hit.category,
                gradeName: hit.gradeName,
                source : hit.source,
                gradeScore: hit.gradeScore,
                label: labelText
            };

            locationView.locations.add(loc);
        }

        // Automatically fit the map zoom and position to see the markers
        if (locationView.fitToMap) {
            var mapBounds = new google.maps.LatLngBounds();
            for (i = 0; i < locationView.markers.length; i++) {
                mapBounds.extend(locationView.markers[i].getPosition());
            }
            locationView.map.fitBounds(mapBounds);

            locationView.fitToMap = false;
        }
    },


    setSearchHandler : function () {

        locationView.algoliaHelper.on('result', function(content, state) {
            var i;

            var that = locationView;

            that.algoliaResults = content.hits;

            that.haveAlgolia = true;

            that.processHits();


        });
    },

    isNewLocation : function (loc) {

        if (locationView.lastPosition.lat === 0 ||
            locationView.lastPosition.lng === 0) {
            return(true);
        }
        var dist = locationView.distance(loc.lat,loc.lng, locationView.lastPosition.lat, locationView.lastPosition.lng);
        if (dist > 5.0) {
            return (true);
        }

        return(false);
    },

    distance : function (lat1, lon1, lat2, lon2, unit) {
        var radlat1 = Math.PI * lat1/180;
        var radlat2 = Math.PI * lat2/180;
        var radlon1 = Math.PI * lon1/180;
        var radlon2 = Math.PI * lon2/180;
        var theta = lon1-lon2;
        var radtheta = Math.PI * theta/180;
        var dist = Math.sin(radlat1) * Math.sin(radlat2) + Math.cos(radlat1) * Math.cos(radlat2) * Math.cos(radtheta);
        dist = Math.acos(dist);
        dist = dist * 180/Math.PI;
        dist = dist * 60 * 1.1515;

        if (unit=="K") {
            dist = dist * 1.609344
        }
        if (unit=="N") {
            dist = dist * 0.8684
        }
        return dist
    },

    getDistance : function (lat, lng) {
        var dist = locationView.distance(lat, lng, locationView.lastPosition.lat, locationView.lastPosition.lng);

        return(dist);
    },

    _processLocation : function (lat, lng) {
        lat = parseFloat(lat);
        lng = parseFloat(lng);
        locationView.map.setCenter({lat:lat, lng:lng});
        locationView.lastPosition.lat = lat;
        locationView.lastPosition.lng = lng;
        locationView._reverseGeoCode(lat, lng);
        var locStr = lat.toString() + ', ' + lng.toString();
        locationView.algoliaHelper.setQueryParameter('aroundLatLng',locStr).search();

        if (locationView.enableCrawl) {
            locationView.searchYelp();
        } else {
            locationView.haveYelp = true;
            locationView.processHits();
        }


    },


    getUserLocation : function () {

        ux.notify ("Finding Your Location...", "success");

       if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function (position) {
                    var gpsLoc = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    locationView.haveAlgolia = false;
                    locationView.haveYelp = false;
                    locationView.fitToMap = true;

                    locationView.setCenterMarker(gpsLoc.lat, gpsLoc.lng, "Your Autolocate Location");
                    locationView._processLocation(gpsLoc.lat, gpsLoc.lng);

                },
                function (error) {
                    ux.notify ("Autolocation disabled.  Using approximate location...", "success");
                    $.ajax({
                        type: "POST",
                        url: locationView.mapsGeoLocateUrl,
                        success: function ( data, textStatus, jqXHR ) {
                            var accuracy = data.accuracy;
                            var lat = data.location.lat, lng = data.location.lng;
                            locationView.lastPosition.lat = lat;
                            locationView.lastPosition.lng = lng;
                            locationView.setCenterMarker(lat, lng, "Your Approximate Location");
                            locationView._reverseGeoCode(lat, lng);
                            locationView.haveAlgolia = false;
                            locationView.haveYelp = false;
                            locationView.fitToMap = true;
                            locationView._processLocation(lat, lng);

                        },
                        dataType: 'json'
                    });

                   // locationView.algoliaHelper.setQueryParameter('aroundLatLngViaIP', true).search();
                }
            );
                //locationView.changeLocation(true))
        } else {


            // Fall back to IP geolocation...
            locationView.algoliaHelper.setQueryParameter('aroundLatLngViaIP', true).search();



        }
    },

    getMarkerData : function (hit, index, hits) {
        var labelStr = hit.name + " (" + hit.category + ") [" + hit.gradeScore + "]";
        return {
            label: labelStr,
            title: hit.address
        }
    },


    isFavorite : function (objectId) {
       var result = false;

        if (favorites.storeCache[objectId] !== undefined && favorites.storeCache[objectId] !== false)
            result = true;

        return (result);
    },

    toggleFavorite : function () {
        if(userView.currentUser.Id !== null){
            var objectId = locationView.activeObj.objectID;
            var name = locationView.activeObj.name;

            var isFavorite = locationView.isFavorite(objectId);
            if (isFavorite) {
                var fav = favorites.findFavoriteByObjectId(objectId);

                if (fav !== undefined && fav !== null) {
                    favorites.removeFavorite(fav);
                    $('#locationModal-favorite > i').text("favorite_border").removeClass("favorite");
                    ux.notify (name + "removed from Favorites", "success");
                }
            } else {
                var name = locationView.activeObj.name;
                var favObj = {
                    address: locationView.activeObj.address,
                    lat : locationView.activeObj.lat,
                    lng : locationView.activeObj.lng
                };

                var url = "/favorite?state="+isFavorite+'&category=store&title='+name;
                ux.setAnalyticsPath(url);


                favorites.addFavorite(favorites._store, objectId, name, null, favObj);
                ux.notify (name + "added to Favorites", "success");
                $('#locationModal-favorite > i').text("favorite").addClass("favorite");
            }
        } else {
            $("#location-modal").modal("toggle");
            userView.openSignUp();
        }


    },

    doDirections : function () {
        var sourceAddr = null, destAddr = null;
       var url = "https://maps.google.com?";

       if (locationView.lastAddress !== null) {
           url +=  "saddr="+locationView.lastAddress + '&';
       }

        url += "daddr=" + locationView.activeObj.address;

       window.open(url, '_blank');

    },

    isReject : function (name) {
        var reject = false;

        for (var i=0; i<locationView.rejectTerms.length; i ++){
            if (name.indexOf(locationView.rejectTerms[i]) !== -1) {
                return(true);
            }
        }

        return(false);
    },


    isIndexStore : function (name, address) {

   //     var maxLen = name.length + address.length, patternLen = maxLen - 8;

        if (address.indexOf(', USA') === -1) {
            address += ', USA';
        }
        var maxLen = address.length, patternLen = maxLen - 4;
        var options = {
            include: ["score","matches"],
            shouldSort: true,
            threshold: 0.1,
            tokenize: true,
            location: 0,
            distance: 2,
            maxPatternLength: patternLen,
            minMatchCharLength: 3,
            keys: [
              //  "name",
                "address"
            ]
        };

        var array = locationView.algoliaResults;

        var fuse = new Fuse(array, options);
     //   var result = fuse.search(name + " " + address);
        var result = fuse.search(address);

        if (result.length === 0) {
            return false;
        }  else {
            if (result[0].score <= 0.7) {  // todo: don - need to add this to class after ff test run...
                return true;
            } else {
                return false;
            }
        }
    },

    addStore : function () {
        var name = locationView.activeObj.name,
            address = locationView.activeObj.address,
            yelpId = locationView.activeObj.yelpId,
            city = locationView.activeObj.city,
            state = locationView.activeObj.state,
            zipcode = locationView.activeObj.zipcode,
            website = locationView.activeObj.website,
            phone = locationView.activeObj.phone;

        var storeUrl = "/addstore?name="+name+"&address="+address+'&yelpid='+yelpId+
            '&city='+city+ "&state="+state+"&zipcode="+zipcode+"&website="+encodeURI(website)+"&phone="+phone;
        $.getJSON( storeUrl, {
            format: "json"
        }).done(function( resObj ) {

            if (resObj.status === "OK")
                ux.notify ("Added " + name + " at " + address, "success");
            else
                ux.notify ("Error updating Store " + JSON.stringify(resObj.error), "error");

            $("#location-modal").modal("toggle");


        });
    },


    deleteStore : function () {
        var objectId = locationView.activeObj.objectID;

        if (objectId === undefined) {
            ux.notify ("Delete store: undefined objectID", "error");
            return;
        }

        if (objectId === 0) {
            ux.notify ("Store is Yelp Result", "error");
        } else {
            if (objectId !== undefined && objectId !== 0) {
                var storeUrl = "/deletestore?objectid="+objectId;
                $.getJSON( storeUrl, {
                    format: "json"
                }).done(function( resObj ) {
                    if (resObj.status === "OK")
                        ux.notify ("Deleted Store", "success");
                    else
                        ux.notify ("Error Deleting Store " + JSON.stringify(resObj.error), "error");

                    var loc = locationView.findLocationByObjectId(objectId);
                    if (loc !== undefined && loc !== null) {
                        locationView.locations.remove(loc);
                    }

                    $("#location-modal").modal("toggle");

                });
            }
        }
    },

    updateStore : function () {
        var objectId = locationView.activeObj.objectID, address = locationView.activeObj.address, name = locationView.activeObj.name;

        if (objectId !== undefined && objectId !== 0) {
            var storeUrl = "/updatestore?objectid="+objectId+"&address="+address+"&name="+name;
            $.getJSON( storeUrl, {
                format: "json"
            }).done(function( resObj ) {

                if (resObj.status === "OK")
                    ux.notify ("Updated Store Geo Info", "success");
                else
                    ux.notify ("Error updating Store " + JSON.stringify(resObj.error), "error");

                $("#location-modal").modal("toggle");

                var loc = locationView.findLocationByObjectId(objectId);
                if (loc !== undefined && loc !== null) {
                   loc.set('address',resObj.address);
                }
            });
        }

    },

    saveRatings : function () {
        var objectId = locationView.activeObj.objectID, isRecommended = locationView.activeObj.isRecommended,
            gradeName = locationView.activeObj.gradeName, gradeScore = locationView.activeObj.gradeScore;

        if (objectId !== undefined && objectId !== 0) {
            var storeUrl = "/ratestore?objectid="+objectId+"&isrecommended="+isRecommended+"&gradename="+gradeName+"&gradescore="+gradeScore;
            $.getJSON( storeUrl, {
                format: "json"
            }).done(function( resObj ) {

                if (resObj.status === "OK")
                    ux.notify ("Updated Store Ratings", "success");
                else
                    ux.notify ("Error rating Store " + JSON.stringify(resObj.error), "error");

                $("#location-modal").modal("toggle");

            });
        }
    },


    locationModal : function (data) {
        // data is model from the datasource will full index information about the location...

        if (userView.isStaff()) {
            $('.bpstaff').removeClass('hidden');
            locationView.enableCrawl = true;
            if (data.source === 'index') {
                $('#locationModal-addStore').addClass('hidden');
            } else {
                $('#locationModal-addStore').removeClass('hidden');
            }
        } else {
            $('.bpstaff').addClass('hidden');
            locationView.enableCrawl = true;
        }

        if(data !== undefined){
            if(data.category !== null && data.category !== ""){
                var category = data.category.toLowerCase();
                locationView.activeObj.set("category", category);
            }
            var searchQuery = 'http://www.google.com/search?q="' + data.name +'"';
            locationView.activeObj.set("objectID", data.objectID);
            locationView.activeObj.set("name", data.name);
            locationView.activeObj.set("address", data.address);
            locationView.activeObj.set("searchQuery", searchQuery);
            locationView.activeObj.set("website", data.website ? data.website : null);
            locationView.activeObj.set("source", data.source);
            locationView.activeObj.set("category", data.category);
            locationView.activeObj.set("lat", data.lat);
            locationView.activeObj.set("lng", data.lng);
            locationView.activeObj.set("gradeScore", data.gradeScore);
            locationView.activeObj.set("gradeName", data.gradeName);
            locationView.activeObj.set("yelpId", data.yelpId ? data.yelpId : null);
            locationView.activeObj.set("isRecommended", data.isRecommended ? data.isRecommended : false);
            locationView.activeObj.set("city", data.city ? data.city : null);
            locationView.activeObj.set("phone", data.phone ? ux.formatPhone(data.phone) : null);

            locationView.activeObj.set("rating", data.rating ? data.rating : null);
            locationView.activeObj.set("mobileWebsite", data.mobileWebsite ? data.mobileWebsite : null);
            locationView.activeObj.set("zipcode", data.zipcode ? data.zipcode : null);
            locationView.activeObj.set("imageUrl", data.imageUrl ? data.imageUrl : null);


            // Only set the url if the store is in the index...
            if (data.objectID !== null && data.objectID !== 0) {
                locationView._updatePlaceUrl(data.objectID);
            }


            var url = shareModel.getCurrentUrl();

            var title = data.name;

            var content = "Check out " + data.name + " at " + data.address;

            shareModel.setShare(title, content, url);



            //locationView.activeObj.set("ux_category", true);

            var isFavorite = locationView.isFavorite(data.objectID);

            if (isFavorite) {
                $('#locationModal-favorite > i').text('favorite').addClass('favorite');
            } else {
                $('#locationModal-favorite > i').text('favorite_border').removeClass('favorite');
            }

            if(data.isRecommended){
                $("#locationCategory").removeClass("rating-default").addClass("rating-best");
                locationView.activeObj.set("ux_type", "Recommended");
            } else {
                $("#locationCategory").removeClass("rating-best").addClass("rating-default");
                locationView.activeObj.set("ux_type", "Unrated");
            }
            /*switch(locationView.activeObj.category){
                case "best":
                    $("#locationCategory").removeClass("rating-better rating-default").addClass("rating-best");
                    break;
                case "better":
                    $("#locationCategory").removeClass("rating-best rating-default").addClass("rating-better");
                    break;
                case "avoid":
                    locationView.activeObj.set("ux_category", false);
                    $("#locationCategory").removeClass("rating-best rating-better").addClass("rating-default");
                    break;
            }

            if (data.source === 'index') {
                $("#locationCategory").removeClass("rating-best rating-better rating-default");
            }
            */

            locationView.getYelpInfo(data.lat, data.lng, data.name, function (places ) {
                if (places.length > 0) {
                    var place = places[0];
                    locationView.activeObj.set("website", place.url ? place.url : null);
                    locationView.activeObj.set("city", place.city ? place.city : null);
                    locationView.activeObj.set("phone", place.phone ? ux.formatPhone(data.phone) : null);
                    locationView.activeObj.set("yelpId", place.id ? place.id : null);
                    locationView.activeObj.set("state", place.state_code ? place.state_code : null);
                    locationView.activeObj.set("mobileWebsite", place.mobile_url ? place.mobile_url : null);

                }
            });


        }



        // User has clicked on a location, increase zoom if the user hasn't zoomed tighter
        if (locationView.map.getZoom() < locationView._modalZoomLevel)
            locationView.map.setZoom(locationView._modalZoomLevel);

        //Center the map on the current location
        // locationView.map.setCenter({lat: data.lat, lng: data.lng});

        //alert ("coming soon - " + data.markerId + " : " + data.name + " at " + data.address);

        $("#location-modal").modal("toggle");
    },


    addLocation : function () {

    },

    addRetailer : function () {

    },

    editRetailers : function () {

    }

};
/**
 * Created by donbrad on 3/22/17.
 */
'use strict';

var menuEditor = {
    _initialized: false,
    _currentSite : 'farm-forward',
    _currentSiteName : 'Farm Forward',
    _siteObj : null,
    _pageWindow : null,

    mainMenu : [{
        text: "Main Menu",
        expanded: true,
        items : [],
        slug: null
    }],

    pagesDS: new kendo.data.DataSource({pageSize: 16,  sort: { field: "title", dir: "asc" }}),

    mainMenuPreviewDS : new kendo.data.DataSource(),

    mainMenuDS : new kendo.data.HierarchicalDataSource({
        transport : {
            create: function (e) {
                e.success();
            },
            destroy : function (e) {
                e.success();
            },
            read: function (options) {
                options.success(menuEditor.mainMenu);
            },
            update : function (options) {
                options.success();
            }
        },
         schema: {
             model: {
                 id: "slug",
                 hasChildren: "items"
             }
         }
        /*schema: {
            model: {
                id: "slug",
                parentId : "parentSlug",
                fields: {
                    slug : {type: "string", nullable: false},
                    parentSlug: {field: "parentSlug", nullable: true},
                    inMainMenu : {type: "boolean"},
                    isPublished : {type: "boolean"}
                }
            }
        } */


    }),

    activeObj : new kendo.data.ObservableObject({siteName: null, siteSlug: null}),
    _pageSize : 128,

    init: function(){
        if(!menuEditor._initialized){

            menuEditor._initialized = true;

            $("#menuEditorSite-selector").kendoDropDownList({
                dataTextField: "name",
                dataValueField: "slug",
                dataSource: [
                    {name : 'All', slug: "all"},
                    {name : 'Farm Forward', slug: "farm-forward"},
                    {name : 'JIFA', slug: "jifa"},
                    {name : 'Better Food Foundation', slug: "bff"},
                    {name : 'Leadership-Circle', slug: "leadership-circle"},
                    {name : 'Buying Poultry', slug: "buying-poultry"}
                ],  // Todo : don fetch these from the sites collection
                change : function (e) {
                    var siteSlug = this.value();

                    menuEditor._currentSite = siteSlug;
                    menuEditor.loadData();
                }
            });

            $("#menuEditor-treeView").kendoTreeView({
                dataSource: [],
                template: kendo.template($("#menuEditor-menuTemplate").html()),
                dragAndDrop : true,
                dataBound : function (e) {
                    menuEditor.buildMainMenu();
                },
                drop : function (e) {
                    var valid = e.valid, destination = e.destinationNode, source = e.sourceNode, dropPosition = e.dropPosition;
                    menuEditor.buildMainMenu();
                }
            });


            $("#menuEditor-grid").kendoGrid({
                dataSource: menuEditor.pagesDS,
                autoBind: false,
                pageSize : 16,
                pageable: true,
                height: 740,
                resizable: true,
                selectable: "row",
                sortable : true,
                change: function(e) {
                    var selectedRow = this.select();
                    var dataItem = this.dataItem(selectedRow[0]);

                    var slug = dataItem.slug;

                    var title = dataItem.title, content= dataItem.content;

                    var window =$("#menuEditor-pageWindow").data("kendoWindow");

                    window.title(title).content(content).center().open();
                },
                columns: [
                    {field: "title", title: "Title", width: 120},
                    {field: "authorName", title: "Author", width: 100}
                ]
            });

            $("#menuEditor-grid").kendoDraggable({
                filter: "tr",

                hint: function (element) {

                    var uid = element[0].attributes['data-uid'].value;

                    var page = menuEditor.pagesDS.getByUid(uid);

                    var hintElement = $("<div id='hint'><span class='k-icon k-i-html5'></span><span> " + page.title + "</span></div>");
                    hintElement.css({
                        "width": "196px",
                        "height": "36px",
                        "font-size" : "1.2em",
                        "font-color" : "#6f6f6f"
                    });

                    return hintElement;

                   /* var grid = $("#menuEditor-grid").data("kendoGrid");
​                   return grid.select().clone();*/
                }
            });

            $("#menuEditor-dropTarget").kendoDropTarget({
                drop: function (e) {
                    var drop = e.dropTarget;
                    var source = e.target;

                    // Handlers is called for all drops: grid to treeview and inter-tree view
                    // Grid elements will have a uid attribute -- tree view elements will not
                    if (e.draggable.currentTarget[0].attributes['data-uid'] !== undefined) {

                        var uid = e.draggable.currentTarget[0].attributes['data-uid'].value;
                        var pageObj = menuEditor.pagesDS.getByUid(uid);
                        var menuObj = {
                            text : pageObj.title,
                            slug: pageObj.slug,
                            expanded: false
                        };

                        var treeview = $("#menuEditor-treeView").data("kendoTreeView");

                        var selected = treeview.select();

                        menuEditor.pagesDS.remove(pageObj);
                        treeview.append(menuObj);

                        menuEditor.buildMainMenu();
                    }


                }
            });

            $('#menuEditor-search-input').keyup (function () {
                var val =  $('#menuEditor-search-input').val();

                if (val.length > 0) {
                    menuEditor.pagesDS.filter({field: 'title', operator: 'contains', value: val});
                } else {
                    menuEditor.pagesDS.filter([]);
                }

            });

            $('#menuEditor-search-input').change (function () {
                var val =  $('#menuEditor-search-input').val();

                if (val.length > 0) {
                    menuEditor.pagesDS.filter({field: 'title', operator: 'contains', value: val});
                } else {
                    menuEditor.pagesDS.filter([]);
                }
            });

           $("#menuEditor-pageWindow").kendoWindow({width: "960px", height: "768px", visible: false});
            //  kendo.bind($("#contributorView-modal"), contributorView.activeObj);
        }
    },

    newMenu : function (title, url, items) {
        var menuObj = {
            text: title,
            encoded : false,
            url: url
        };

        if (items !== undefined && items !== null){
            menuObj.items = items;
        }

        return (menuObj);
    },

    buildMainMenuTree : function () {
        var slug = menuEditor._currentSite;

        if (slug === null) {
            return ([]);
        }

        var items = pageModel.getSitePages(slug);

        var pages = [{
            text: "Main Menu",
            expanded: true,
            items : [],
            parentSlug: null,
            Id: null,
            slug: null
        }];

        for (var i=0; i<items.length; i++) {
            var page = items[i];

            if (page.parentSlug === null) {
                var pageObj = {
                    Id: page.Id, slug: page.slug, text: page.title, parentSlug: page.parentSlug
                };

                if (page.children.length > 0) {

                    pageObj.items = [];
                    pageObj.expanded = true;
                    for (var j=0; j<page.children.length; j++) {
                        var slugId = page.children[j];
                        var child = pageModel.findPageBySlug(slugId);

                        var childObj = {
                            Id: child.Id, slug: child.slug, text: child.title, parentSlug: child.parentSlug
                        };
                        pageObj.items.push(childObj);
                    }
                }

                // pageModel.jifaSiteDS.add(pageObj);
                pages[0].items.push(pageObj);
            }
        }

       return (pages);
    },

    buildMainMenu : function () {

        var treeview = $("#menuEditor-treeView").data("kendoTreeView");

        var menu = treeview.dataSource.data();

        if ( menu === undefined || menu.length === 0) {
            return;
        }

        var mainMenu = [];

        for (var i=0; i<menu.length; i++) {
            var menuItem = menu[i];

            var menuObj = {
                slug: menuItem.slug, text: menuItem.text
            };

            if (menuItem.items !== undefined && menuItem.items.length > 0) {
                menuObj.items = [];
                for (var j=0; j<menuItem.items.length; j++) {
                    var child = menuItem.items[j];
                    var childObj = {
                        slug: child.slug, text: child.text
                    };
                    menuObj.items.push(childObj);
                }
            }
            mainMenu.push(menuObj);
        }


        $("#menuEditor-sampleMenu").kendoMenu({dataSource: mainMenu});
    },

    loadPagesDS : function () {
        var siteSlug = menuEditor._currentSite;
        if (siteSlug === null) {
            return;
        }
        var pages = pageModel.getSitePages(siteSlug);
        menuEditor.pagesDS.data(pages);
    },

    loadMainMenu : function () {
        var menuIn = menuEditor._siteObj.mainMenu;
        var menuObj = [];
        if (menuIn !== undefined && menuIn !== null) {
            menuObj = JSON.parse(menuIn);
        }

        var treeview = $("#menuEditor-treeView").data("kendoTreeView");
        treeview.setDataSource(new kendo.data.HierarchicalDataSource({
            data: menuObj
        }));
    },

    loadData : function () {
        menuEditor.mainMenuDS.read();

    },

    deleteMenu : function (e) {
        var item = $(this).closest(".k-item");
    },

    editMenu : function (e) {
        var item = $(this).closest(".k-item");
    },


    open: function (siteSlug) {
        menuEditor.init();
        if (siteSlug === null) {
            return;
        }

        var dropdownlist = $("#menuEditorSite-selector").data("kendoDropDownList");
        dropdownlist.value(siteSlug);

        var site = siteModel.findBySlug(siteSlug);

        menuEditor._siteObj = site;
        menuEditor._currentSite = siteSlug;
        menuEditor._currentSiteName = site.name;
        menuEditor.loadMainMenu();
        menuEditor.loadPagesDS();
    },

    saveMenu : function () {
        var treeview = $("#menuEditor-treeView").data("kendoTreeView");

        var menu = treeview.dataSource.data();

        var menuStr = JSON.stringify(menu);

        menuEditor._siteObj.set('mainMenu', menuStr);

        siteModel.update(menuEditor._siteObj);

    },

    close : function () {

    }

};
/**
 * Created by donbrad on 3/1/17.
 */
var myvoteView = {
    initialized: false,
    activeObj: new kendo.data.ObservableObject({address: null, zipcode: null, state: null, lat: null, lng: null}),
    repObj :  new kendo.data.ObservableObject({
        candidateId: null, photo: null, name: null, education: null, title: null, party: null, state: null, district: null,
        profession: null, political : null, religion: null, congMembership: null, orgMembership: null
    }),
    repDetails : null,
    billObj :  new kendo.data.ObservableObject({address: null, zipcode: null, state: null, lat: null, lng: null}),
    billDetails : null,

    legislatorDS : new kendo.data.DataSource(),
    legislationDS : new kendo.data.DataSource(),

    init: function () {

        if (!myvoteView.initialized) {
            myvoteView.initialized = true;

            $("#myvote-representativeGrid").kendoGrid({
                dataSource: myvoteView.legislatorDS,
                resizable: true,
                sortable: true,
                selectable: true,
                height: 760,
                change: function(e) {
                    var selectedRows = this.select();
                    var dataItem = this.dataItem(selectedRows[0]);

                    var repId = dataItem.candidateId;

                    repModal.open(repId);


                    // selectedDataItems contains all selected data items
                },
                columns: [
                    {field: "title", title: "Title", width: 120},
                    {field: "firstName", title: "First Name", width: 80},
                    {field: "lastName", title: "Last Name", width: 80},
                    {field: "officeDistrictName", title: "District", width: 80},
                    {field: "officeParties", title: "Party", width: 80}
                ]
            });

            $("#myvote-legislationGrid").kendoGrid({
                dataSource: myvoteView.legislationDS,
                resizable: true,
                sortable: true,
                selectable: true,
                height: 760,
                change: function(e) {
                    var selectedRows = this.select();
                    var dataItem = this.dataItem(selectedRows[0]);

                    var billId = dataItem.id;

                   billModal.open(billId);

                    // selectedDataItems contains all selected data items
                },
                columns: [
                    {field: "state", title: "State", width: 60, template: '# var st = data.state.toUpperCase() # #: st #'},
                    {field: "title", title: "Title", width: 240, template: '# var titl = data.title.capitalize() # #= titl #'},
                    {field: "bill_id", title: "Bill", width: 100},
                    {field: "chamber", title: "Chamber", width: 80}/*,
                    {field: "type", title: "Type", width: 120, template: '# var typeStr = data.type.join(", "); #  #= typeStr #' }*/
                ]
            });

            $("#myvote-tabstrip").kendoTabStrip({
                animation: {
                    open: {
                        effects: "fadeIn"
                    }
                }
            });


            $("#myvote-state").kendoMultiSelect({
                dataSource : new kendo.data.DataSource({
                    transport: {
                        read: {
                            url: "../../data/usstates.json",
                            dataType: "json"
                        }
                    }
                }),
                change : function (e) {
                    var state = e.sender.element[0].value;

                    if (state !== null) {
                        myvoteView.lookupLegislation('animal', state);
                    }
                },
                value : myvoteView.activeObj.state,
                dataTextField: "name",
                dataValueField: "abbreviation"

            });
            $("#myvote-zipcode").change(function() {
                var zip = $("#myvote-zipcode").val();

                if (zip.length === 5) {
                    myvoteView.activeObj.set('zipcode', zip);
                    myvoteView.lookupLegislators();

                } else {
                    ux.notify("Please enter a 5 digit zipcode", 'error');
                }
            });
        }
    },

    open : function () {

        myvoteView.init();

        myvoteView.activeObj.set('zipcode', null);
        if (userView.currentUser.Id !== null && userView.currentUser.zipcode !== null) {
            myvoteView.activeObj.set('zipcode', userView.currentUser.zipcode);
            $("#myvote-zipcode").val(userView.currentUser.zipcode);
        }
        if (myvoteView.activeObj.zipcode !== null) {

            myvoteView.lookupLegislators();
           // $('#myvote-zipcodeDiv').addClass('hidden');
        } else {
          //  $('#myvote-zipcodeDiv').removeClass('hidden');
        }


    },

    lookupLegislators : function () {
        if (myvoteView.activeObj.zipcode !== null) {

            var url = 'http://gaiaapi.herokuapp.com/repByZip?zipcode='+myvoteView.activeObj.zipcode;
            $.ajax(url)
                .done (function (data) {
                    var locals = data.legislators;
                    myvoteView.legislatorDS.data(locals);
                })
                .fail (function (err) {

                });

        } else {
            ux.notify("Please update your zipcode...");
        }
    },

    legislatorDetail : function (repId) {
        var url = 'http://gaiaapi.herokuapp.com/repDetails?repid='+ repId;
        $.ajax(url)
            .done (function (data) {
                var obj = myvoteView.repObj;
                var info = data;

                obj.set('candidateId', info.candidateId);
                obj.set('photo', info.photo);
                var name = info.firstName;
                if (info.middleName !== '') {
                    name += " " + info.middleName;
                }
                name += info.lastName;

                if (info.suffix !== '') {
                    name += info.suffix;
                }
                obj.set('name', name);

            })
            .fail (function (err) {

            });
    },


    lookupLocal : function () {

    },

    lookupLegislation : function (query, state) {
        var url = 'https://openstates.org/api/v1/bills/?state='+state+'&q=' + query;
        $.ajax(url)
            .done (function (data) {
                var bills = data;

                myvoteView.legislationDS.data(bills);
            })
            .fail (function (err) {
                ux.notify("Error looking up legistation " + JSON.stringify(err), 'error');
            });
    }

};


var repModal = {
    activeObj : new kendo.data.ObservableObject({title: null, longTitle: null, web: null, email: null, twitter: null, facebook: null}),
    initialized : false,

    init : function () {
        if (!repModal.initialized) {
            repModal.initialized = true;
            kendo.bind($("#rep-modal"), repModal.activeObj);
        }

        var obj = repModal.activeObj;
        obj.set('email', null);
        obj.set('web', null);
        obj.set('twitter', null);
        obj.set('null', null);
    },

    _convertNL : function (string) {

        if (string === undefined || string === null) {
            return null
        }
        var str = string.replace(/\\n/g, '<br>');
        return (str);
    },

    _getDetails : function (repId) {
        var url = 'http://gaiaapi.herokuapp.com/repDetails?repid='+ repId;
        $.ajax(url)
            .done (function (data) {
                var obj = repModal.activeObj;
                var info = data.details.candidate;
                var office = data.details.office;

                obj.set('candidateId', info.candidateId);
                obj.set('crpId', info.crpId);
                obj.set('photoUrl', info.photo);
                var name = info.firstName;
                if (info.nickName !== undefined && info.nickName !== null && info.nickName !== "") {
                    name += ' "' + info.nickName + '" ';
                }

                if (info.middleName !== '') {
                    name += " " + info.middleName;
                }
                name += " " + info.lastName;

                if (info.suffix !== '') {
                    name += " " + info.suffix;
                }

                obj.set('name', name);
                obj.set('birthDate',info.birthDate);
                obj.set('birthPlace',info.birthPlace);
                obj.set('homeCity',info.homeCity);
                obj.set('homeState', info.homeState);
                obj.set('education', repModal._convertNL(info.education));
                obj.set('profession', repModal._convertNL(info.profession));
                obj.set('political', repModal._convertNL(info.political));
                obj.set('religion', info.religion);
                obj.set('congMembership', repModal._convertNL(info.congMembership));
                obj.set('orgMembership', repModal._convertNL(info.orgMembership));

                var longTitle = office.title + " From " + office.stateId + " " + office.district;
                obj.set('longTitle', longTitle);

                obj.set('title', office.title);
                obj.set('type', office.type);
                obj.set('parties', office.parties);
                obj.set('district', office.district);
                obj.set('districtId', office.districtId);
                obj.set('stateId', office.stateId);
                obj.set('firstElect', office.firstElect);
                obj.set('lastElect', office.lastElect);
                obj.set('committees', office.committee);

                repModal._getContactInfo(repId);
                repModal._getOfficeInfo(repId);
                $('#rep-modal').modal('toggle');
            })
            .fail (function (err) {
                ux.notify("Error fetching Representative " + JSON.stringify(err), 'error');
            });


    },

    _getContactInfo : function (repId) {
        var url = 'http://gaiaapi.herokuapp.com/repContact?repid='+ repId;
        $.ajax(url)
            .done (function (data) {
                var obj = repModal.activeObj;
                var address = data.details.address;

                var web = null, email = null,  facebook = null, twitter = null;
                for (var i=0; i< address.length; i++) {
                    var addr = address[i];

                    switch (addr.webAddressType) {
                        case "Website":
                            web = addr.webAddress;
                            break;

                        case "Website - Facebook":
                            facebook = addr.webAddress;
                            break;

                        case "Website - Twitter":
                            twitter = addr.webAddress;
                            break;

                        case "Webmail":
                            email = addr.webAddress;
                            break;
                    }
                }

                obj.set('email', email);
                obj.set('web', web);
                obj.set('facebook', facebook);
                obj.set('twitter', twitter);

            })
            .fail (function (err) {
                ux.notify("Error fetching Representative Contact Info " + JSON.stringify(err), 'error');
            });
    },

    _getOfficeInfo : function (repId) {
        var url = 'http://gaiaapi.herokuapp.com/repOffice?repid='+ repId;
        $.ajax(url)
            .done (function (data) {
                var obj = repModal.activeObj;
             })
            .fail (function (err) {
                ux.notify("Error fetching Representative Office Info " + JSON.stringify(err), 'error');
            });
    },

    open : function (repId) {

        repModal.init();

        repModal._getDetails(repId);


   },

    close : function () {
        $('#rep-modal').modal('toggle');
    }
};

var billModal = {
    activeObj : new kendo.data.ObservableObject(),
    initialized : false,

    init : function () {
        if (!billModal.initialized) {
            billModal.initialized = true;
            kendo.bind($("#bill-modal"), billModal.activeObj);
        }
    },

    open : function (billId) {

        billModal.init();

        var url = 'https://openstates.org/api/v1/bills/'+billId+'/';
        $.ajax(url)
            .done (function (data) {
                var bill = data;
                var obj = billModal.activeObj;
                obj.set('id', bill.id);
                obj.set('billId', bill.billId);
                obj.set('shortTitle', bill['+short_title']);
                obj.set('title', bill.title);
                var billUrl = bill.sources[0].url;
                obj.set('billUrl', billUrl);
                $('#bill-modal').modal('toggle');

            })
            .fail (function (err) {
                ux.notify("Error looking up legistation " + JSON.stringify(err), 'error');
            });
    },

    close : function () {
        $('#bill-modal').modal('toggle');
    }
};
/**
 * Created by donbrad on 10/8/16.
 **/

'use strict';

var pageEditor = {
    _inited : false,
    _window : null,
    _createMode : false,
    _blogFragment : '#/blog?blogid=',
    _labelFragment : '#/labelguide?labelid=',
    _glossaryFragment : '',
    _editor : null,
    _anchors : [],
    _blogPhotos : new kendo.data.DataSource(),
    _categoryDS : new kendo.data.DataSource(),
    _tagDS : new kendo.data.DataSource(),

    activeObj: new kendo.data.ObservableObject({
        title: null,
        id: null,
        category: null,
        categoryRating : 3,
        publishDate : new Date(),
        isVerified : false,
        tags : [],
        categories : [],
        content: null,
        tooltip: null,
        imageUrl : null,
        previewUrl : null,
        author : null,
        authorSlug : null,
    }),

    activeLink :  new kendo.data.ObservableObject({
        title: null,
        url: null,
        category: null,   // external, blog, glossary
        objectId : null
    }),

    activePhoto :  new kendo.data.ObservableObject({
        objectId: null,
        url: null,
        isPreview: false
    }),

    open : function (id) {

        if (!pageEditor._inited) {

            //cloudinary.setCloudName('hyjvcxzjt');


            kendo.bind($("#pageEditor"), pageEditor.activeObj);
            kendo.bind($("#blogLinkEditor"), pageEditor.activeLink);
            kendo.bind($("#blogPhotoGallery"), pageEditor.activePhoto);

            pageEditor._inited = true;

            pageEditor.fetchBlogPhotos();

            $("#pageEdit-author").kendoAutoComplete({
                dataTextField: "name",
                template: kendo.template($("#contributorList-template").html()),
                select: function(e) {
                    var item = e.dataItem;
                    var id = item.slug;
                    pageEditor.activeObj.set('authorSlug', item.slug);
                    pageEditor.activeObj.set('author', item.name);
                    pageEditor.activeObj.set('authorAlias', item.alias);
                },
                dataSource: contributorModel.bloggerDS,
                height: 400
            });


            $("#linkEditor-blog").kendoAutoComplete({
                dataTextField: "title",
                dataValueField: "slug",
                filter: "contains",
                suggest: true,
                placeholder: "Enter Blog Title ...",
                select: function(e) {
                    var item = e.dataItem;
                    var id = item.slug;
                    // Use the selected item or its text
                    pageEditor.activeLink.category = "Blog";
                    pageEditor.activeLink.objectId = id;
                    pageEditor.activeLink.set('href', pageEditor._blogFragment+id);
                },
                dataSource: blogModel.blogDS
            });


            $("#linkEditor-contributor").kendoAutoComplete({
                dataTextField: "name",
                dataValueField: "slug",
                filter: "contains",
                suggest: true,
                placeholder: "Enter Persons Name ...",
                select: function(e) {
                    // Use the selected item or its text
                    pageEditor.activeLink.category = "Contributor";
                },
                dataSource: contributorModel.contributorDS
            });

           /* $("#linkEditor-label").kendoAutoComplete({
                dataTextField: "title",
                dataValueField: "id",
                filter: "contains",
                suggest: true,
                placeholder: "Enter Label Title ...",
                select: function(e) {
                    var item = e.dataItem;
                    var id = item.id;
                    // Use the selected item or its text
                    pageEditor.activeLink.category = "Label";
                    pageEditor.activeLink.objectId = id;
                    pageEditor.activeLink.set('href', pageEditor._labelFragment+id);
                },
                dataSource: labelGuideView.labelsDS
            });*/

            $("#pageEdit-tags").kendoMultiSelect({
                dataSource: tagModel.tagDS,
                dataTextField : 'name',
                dataValueField : 'slug',
                clearButton : true
            });

            $("#pageEdit-categories").kendoMultiSelect({
                dataSource: tagModel.categoryDS,
                dataTextField : 'name',
                dataValueField : 'slug',
                clearButton : true
            });

            $("#pagePhotoGallery-pager").kendoPager({
                dataSource: pageEditor._pagePhotos
            });

            $("#pagePhotoGallery-listView").kendoListView({
                dataSource: pageEditor._pagePhotos,
                template: kendo.template($("#galleryPhotoTemplate").html())
            });

            $("#pageEdit-date").kendoDatePicker({
                value: pageEditor.activeObj.publishDate
            });




            /*$('#pageEdit-imageUpload').cloudinary_upload_widget({ cloud_name: 'hyjvcxzjt', upload_preset: 'bppage', public_id:  pageEditor.activeObj.slug,  button_caption: "Upload New Preview Image", client_allowed_formats : ["png","gif", "jpeg"]  },
                function(error, result) {
                    if (error === null && result.length > 0) {
                        var photo = result[0];
                        pageEditor.activeObj.set("imageUrl", photo.secure_url);
                        pageEditor.activeObj.set("dirty", true);
                        var blogObj = pageEditor.activeObj;

                        everlive.updateOne('blog', blogObj, function (err, data) {
                            pageEditor._updateIndex( function (status) {
                                if (status) {
                                    ux.notify("Updated brand photo ", 'success');
                                    $('#blogPhotoEditor-imageDiv').removeClass('hidden');
                                }
                            });
                            // Call the index update function...
                        });

                    }
                });*/


            $('#pagePhotoEditor-imageUpload').cloudinary_upload_widget({ cloud_name: 'hyjvcxzjt', upload_preset: 'bppage',button_caption: "Upload New Image" , client_allowed_formats : ["png","gif", "jpeg"] },
                function(error, result) {
                    if (error === null && result.length > 0) {
                        var photo = result[0];
                    }
                });

           $("#pageEdit-editor").kendoEditor({
               stylesheets: [
                   "../../css/editorStyles.css"
               ],
                resizable: {
                    content: false,
                    toolbar: true
                },
               pasteCleanup: {
                   css: true,
                   msAllFormatting: true,
                   msConvertLists: false
               },
                select: function(e) {
                    var editor = $("#pageEdit-editor").data("kendoEditor");
                    var selection = editor.getSelection();

                    if (selection.focusNode.parentNode.tagName === 'A') {
                        var title = selection.focusNode.parentNode.text;
                        var href =  selection.focusNode.parentNode.href;
                        var targetText = selection.focusNode.parentNode.outerHTML;
                        pageEditor.editLink(selection, title, href, targetText);


                    } else if (selection.focusNode.parentNode.tagName === 'SPAN' &&
                        selection.focusNode.parentNode.children.length === 2 &&
                        selection.focusNode.parentNode.children[0].className  === "easy-footnote-margin-adjust") {

                        var noteNumber = selection.focusNode.parentNode.children[1].innerText;
                        var url = selection.focusNode.parentNode.children[1].children[0].href;
                        var host = selection.focusNode.parentNode.children[1].children[0].host;
                        var hash = selection.focusNode.parentNode.children[1].children[0].hash;
                        var html = selection.focusNode.parentNode.children[1].outerHTML;

                        var regex = new RegExp(/\\s*title=\\s*\\“(.*?)target=/);
                        html = decodeURI(html);
                        var footnote = regex.exec(html);


                    } else if (selection.anchorNode.tagName === 'TEXT') {
                        var noteNumber = selection.anchorNode.data;

                    } else if (selection.focusNode.tagName === 'IMG') {

                    }  else if (selection.focusNode.tagName === 'DIV' && selection.focusNode.className === 'page-image') {
                        // Process legacy images in legacy pages...
                        var image = selection.focusNode.children[0];
                        var imageSrc = image.src;


                        pageEditor.editImage(selection, null, imageSrc);

                    }

                },
                paste : function (e) {

                },
                tools: [
                    "bold", "italic", "underline", "subscript", "superscript", "justifyLeft", "justifyCenter", "justifyRight", "insertUnorderedList", "insertOrderedList",
                    "indent", "outdent","viewHtml","formatting",
                    {
                        name: "Link",
                        tooltip: "Add or Edit Hyperlink",
                        template: '<button class="k-button" onclick="pageEditor.addLink()"><span class="k-font-icon k-i-anchor"></span></button>'
                    },
                    {
                        name: "Glossary",
                        tooltip: "Add or Edit Glossary",
                        template: '<button class="k-button" onclick="pageEditor.addGlossary()"><span class="k-font-icon k-i-dictionary-add"></span></button>'
                    },
                    {
                        name: "Reference",
                        tooltip: "Add or Edit Reference or Citation",
                        template: '<button class="k-button" onclick="pageEditor.addReference()"><span class="k-font-icon k-i-sup-script"></span></button>'
                    },
                    {
                        name: "Image",
                        tooltip: "Add or Edit Inline Image",
                        template: '<button class="k-button" onclick="pageEditor.addImage()"><span class="k-font-icon k-i-image"></span></button>'
                    },
                    {
                        name: "Gallery",
                        tooltip: "Add Inline Image from Gallery",
                        template: '<button class="k-button" onclick="pageEditor.addGallery()"><span class="k-font-icon k-i-borders-all"></span></button>'
                    }
                ]
            });

            pageEditor._editor = $("#pageEdit-editor").data("kendoEditor");
        }

        algolia.pageIndex.search("", {facetFilters: ['slug:' +id]}, function searchDone(err, content) {
            if (err) {
                ux.notify("page Editor Error: " +JSON.stringify(err), 'error');
                return;
            }

            var pageObj = content.hits[0];

            if (pageObj !== null) {
                pageEditor._createMode = false;

                if (pageObj.tagString === undefined) {
                    pageObj.tagString = '';
                }

                if (pageObj.Id === undefined) {
                    pageObj.Id = pageObj.objectID;
                }
                pageEditor.activeObj.set("Id", pageObj.Id);
                pageEditor.activeObj.set("objectID", pageObj.objectID);
                pageEditor.activeObj.set("slug", pageObj.slug);
                var title = decodeURI(pageObj.title);
                pageEditor.activeObj.set("title", title);
                pageEditor.activeObj.set("content", pageObj.content);
                pageEditor.activeObj.set("tooltip", pageObj.tooltip);
                pageEditor.activeObj.set("author", pageObj.author);
                if (pageObj.authorSlug === undefined) {
                    pageObj.authorSlug = null;
                }
                pageEditor.activeObj.set("authorSlug", pageObj.authorSlug);
                pageEditor.activeObj.set("tags", pageObj.tags);
                pageEditor.activeObj.set("categories", pageObj.categories);
                pageEditor.activeObj.set("imageUrl", pageObj.imageUrl);
                if (pageObj.previewUrl === undefined) {
                    pageObj.previewUrl = null;
                }
                pageEditor.activeObj.set("previewUrl", pageObj.previewUrl);
                var date = new Date(pageObj.publishDate);
                pageEditor.activeObj.set("publishDate", date);



            } else {
                ux.notify("Creating New page!", "success");
                pageEditor._createMode = true;
                var pageId = uuid.v4();
                pageEditor.activeObj.set("id", pageId);
                pageEditor.activeObj.set("objectId", pageId);
                pageEditor.activeObj.set("title", null);
                pageEditor.activeObj.set("slug", null);
                pageEditor.activeObj.set("content", null);
                pageEditor.activeObj.set("tooltip", null);
                pageEditor.activeObj.set("imageUrl", null);
                pageEditor.activeObj.set("author", null);
                pageEditor.activeObj.set("authorSlug", null);
                pageEditor.activeObj.set("tags", []);
                pageEditor.activeObj.set("imageUrl", null);
                pageEditor.activeObj.set("previewUrl", null);
                pageEditor.activeObj.set("categories", []);
                pageEditor.activeObj.set("publishDate", new Date());


            }

            var editor = $("#pageEdit-editor").data("kendoEditor");
            editor.value(pageEditor.activeObj.content);
            editor.update();
            pageEditor.findLinks();
        });
    },

    findLinks : function () {
        pageEditor._anchors = [];

        var content = pageEditor.activeObj.content;
        var regex = new RegExp(/<a[\s]+([^>]+)>((?:.(?!\<\/a\>))*.)<\/a>/g);
        var matches = regex.exec(content);

       var links = content.match(/<a[\s]+([^>]+)>((?:.(?!\<\/a\>))*.)<\/a>/g);

       for (var i=0; i<links.length; i++) {
           var link = links[i];

           var href = link.match(/href="([^"]*")/);
           var title = link.match(/title="([^"]*")/);
           var text = link.match(/>([^<]+)<\/a>/);


           var linkObj = {href: null, title: null, text: null};

           if (href !== null && href.length >  1) {
               linkObj.href = href[1];
           }

           if (text !== null && text.length >  1) {
               linkObj.text = text[1];
           }

           pageEditor._anchors.push(linkObj);
       }
       /* var doc = $('.bp-body td .k-editable-area .k-content html body');

        $('.bp-body td .k-editable-area .k-content html body a').each(function() {
            var link = {title: this.title, href : this.href};
            pageEditor._anchors.push(link);
        });*/
        ux.notify("Found " + pageEditor._anchors.length + " links...");
    },

    replaceImage : function () {

        cloudinary.openUploadWidget({ cloud_name: 'hyjvcxzjt', upload_preset: 'bppage', public_id:  pageEditor.activeObj.slug, client_allowed_formats : ["png","gif", "jpeg"]  },
            function(error, result) {
                if (error === null && result.length > 0) {
                    var photo = result[0];
                    pageEditor.activeObj.set("imageUrl", photo.secure_url);
                    pageEditor.activeObj.set("dirty", true);
                    var pageObj = pageEditor.activeObj;

                    everlive.updateOne('page', pageObj, function (err, data) {
                       if (err === null) {
                           pageEditor._updateIndex( function (status) {
                               if (status) {
                                   ux.notify("Updated page Preview photo ", 'success');
                               }
                           });
                       } else if (err.code === 801 ) {// page not found -- need to create it
                            everlive.createOne('page', pageObj, function (err1, data1) {
                                if (err1 === null) {
                                    pageEditor._updateIndex( function (status) {
                                        if (status) {
                                            ux.notify("Updated page Preview photo ", 'success');
                                        }
                                    });
                                }
                            });

                        } else {
                           ux.notify("Error updating page Preview Photo " + JSON.stringify(err), 'error');
                        }

                    });

                }
            });

    },

    _updateIndex : function ( callback) {

        var bpurl = 'http://gaiaapi.herokuapp.com/updatepage?slug='+pageEditor.activeObj.slug;
        $.ajax({
            url: bpurl,
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            success: function(data) {
                if (data.status === 'OK') {
                    callback(true);
                } else {
                    callback(false)
                }

            }
        });
    },

    fetchpagePhotos : function () {
        var fetchUrl = "http://gaiaapi.herokuapp.com/photolist?folder=page";
        $.getJSON( fetchUrl, {
            format: "json"
        }).done(function( resObj ) {

            pageEditor._pagePhotos.data(resObj.photos);
            if (resObj.status === "OK")
                ux.notify ("Fetched page " + resObj.photoCount+ " photos", "success");
            else
                ux.notify ("Error fetching page photos " + JSON.stringify(resObj.error), "error");


        });
    },

    checkAnchors : function () {

        pageEditor._anchors = [];
        var target = $("#pageEdit-editor").siblings('iframe');

        var links = target[0].contentDocument.links;

        for (var i=0; i<links.length; i++) {
            var anchor = links[i];
            var linkObj = {
                href : anchor.href,
                targetText : anchor.outerHTML,
                title : anchor.text,
                hash: anchor.hash
            };

            pageEditor._anchors.push(linkObj);
            //Do your work
        }


    },

    addpage : function () {
        ux.notify("Coming Soon...", 'success');
    },


    deletepage : function () {
        ux.notify("Coming Soon...", 'success');
    },


    addImage : function () {
        $("#pagePhotoEditor").modal("toggle");
    },

    addLink : function () {
        $("#pageLinkEditor").modal("toggle");
    },

    editImage : function (selection, objectId, url) {

        var editor = $("#pageEdit-editor").data("kendoEditor");
        var selection = editor.getSelection();


        $('#pageEditorPhoto-img').attr('src', url);
        $('#pagePhotoEditor-url').text(url);
        $('#pagePhotoEditor-error').addClass('hidden');

        if (url.indexOf('buyingpoultry.blob.core.windows.net') !== -1) {
            $('#pagePhotoEditor-error').removeClass('hidden');
            $('#pagePhotoEditor-errorMsg').html("This image is hosted on Azure!.   Migrating...");

            if (objectId === null) {
                objectId = uuid.v4();

            }

            pageEditor.uploadpagePhoto(objectId, url, function (result) {
                var image = selection.focusNode.children[0];
                if (result.status === 'OK') {
                    image.src = result.photoUrl;
                    //image.currentSrc = result.photoUrl;
                    var replace = '<img src="'+result.photoUrl+'" >';
                    image.outerHTML = replace;
                    editor.update();
                    $('#pagePhotoEditor-url').text(result.photoUrl);
                    $('#pageEditorPhoto-img').attr('src', result.photoUrl);
                    $('#pagePhotoEditor-errorMsg').html("Image migrated to BP Cloud...");
                }

            });
        }
        
        $("#pagePhotoEditor").modal("toggle");
    },

    addGallery : function () {
        $("#pagePhotoGallery").modal("toggle");
    },

    updateGlossaryLink : function (link) {
        var html = '<a onclick="glossaryModal.onClick(event)" class="ff-link ff-glossary"  data-linktype="glossary" data-slug="'+link.slug+'" data-category="'+link.category+
            '"> '+ link.title +'</a>';

        var editor = $("#pageEdit-editor").data("kendoEditor");
        editor.paste(html);
    },

    addGlossary : function () {
        glossaryLinkEditor.open(null, function(link) {
            if (link !== null) {
                glossaryEditor.updateLink( glossaryEditor._selection, link);
            }
        });
    },

    addReference : function () {
        $("#pageReferenceModal").modal("toggle");
    },

    editGallery : function (selection, objectId, url) {

        $("#pagePhotoGallery").modal("toggle");
    },

    verifyLink : function () {
       var href =  pageEditor.activeLink.get('href');
        ux.notify("Verifying " + href + "...", "success");
        $('#linkEditor-linkStatus').html("Please review link (in new Tab) ");

        window.open(href, '_verify');

       /* $.get(
            href,
            function(data, textStatus, qXHR ){
                $('#linkEditor-linkStatus').html('<strong> Unreachable - please correct </strong>');
            }
        );*/
    },

    editLink : function (selection, title, href, target) {
        pageEditor.activeLink.set('title', title);
        pageEditor.activeLink.set('href', href);
        pageEditor.activeLink.set('target', target);
        pageEditor.activeLink.selection = selection;
        $('#linkEditor-linkStatus').html('');
        $("#pageLinkEditor").modal("toggle");
    },

    updateLink : function (selection, title, href, category) {

    },

    uploadpagePhoto : function (objectid, url, callback) {
        var encodeUrl = encodeURIComponent(url);
        var bpurl = 'http://gaiaapi.herokuapp.com/uploadphoto?folder=page&objectid='+objectid+'&url='+encodeUrl;
        $.ajax({
            url: bpurl,
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            success: function(data) {
                var respObj = {status: 'OK', publicId: null, photoId: null, photoUrl: null};
                if (data.status === 'OK') {
                    respObj.publicId = data.publicId;
                    respObj.photoId = data.photoId;
                    respObj.photoUrl = data.photoUrl;
                } else {
                    respObj.status = 'ERROR';
                }
                callback(respObj);
            }
        });
    },

    linkEditorUpdate : function () {

        var editor = $("#pageEdit-editor").data("kendoEditor");
        var selection = editor.getSelection();

        //var selection = pageEditor.activeObj.selection;
        var title =  pageEditor.activeLink.title;
        var href =  pageEditor.activeLink.href;
        var category =  pageEditor.activeLink.category;
        var target = pageEditor.activeLink.target;

        if (category === null) {
            category = 'Link'
        }
        selection.focusNode.parentNode.text = title;
        selection.focusNode.parentNode.href = href;

        var replace = '<a class="bp_'+category+'" href="'+href+'" />' + title + '</a>';

        selection.focusNode.parentNode.outerHTML = replace;

        editor.update();

    },


    photoEditorUpdate : function () {

    },

    savepage : function () {
        var pageObj = pageEditor.activeObj;

        pageObj = JSON.parse(JSON.stringify(pageObj));
        var editor = $("#pageEdit-editor").data("kendoEditor");

        var content = editor.value();

        pageObj.content = content;

       everlive.updateOne('page', pageObj, function (err, data) {

           if (err === null) {
               pageEditor._updateIndex( function (status) {
                   if (status) {
                       if (status)
                           ux.notify('"' + pageObj.title + '"' + " updated !" , 'success');
                       else
                           ux.notify('"' + pageObj.title + '"' + " was not updated" , 'error');
                   }
               });
           } else if (err.code === 801 ) {// page not found -- need to create it

               ux.notify('Adding "' + pageObj.title + '"' + " to Database..." , 'success');
               everlive.createOne('page', pageObj, function (err1, data1) {
                   if (err1 === null) {
                       pageEditor._updateIndex( function (status) {
                           if (status) {
                               if (status)
                                   ux.notify('"' + pageObj.title + '"' + " updated !" , 'success');
                               else
                                   ux.notify('"' + pageObj.title + '"' + " was not updated" , 'error');
                           }
                       });
                   }

               });

           } else {
               ux.notify('"' + pageObj.title + '"' + " Error: " + JSON.stringify(err) , 'error');
           }

        });
    },

    close : function () {

        APP.router.navigate('#/pageList');
    }


};
/**
 * Created by donbrad on 3/22/17.
 */
'use strict';

var pageListView = {
    _initialized: false,

    pagesDS : new kendo.data.DataSource({pageSize: 8}),
    activeObj : new kendo.data.ObservableObject({siteName: null, siteSlug: null}),
    _pageSize : 128,

    init: function(){
        if(!pageListView._initialized){

            pageListView._initialized = true;

            $("#site-selector").kendoDropDownList({
                dataTextField: "name",
                dataValueField: "slug",
                dataSource: [
                    {name : 'All', slug: "all"},
                    {name : 'Farm Forward', slug: "farm-forward"},
                    {name : 'JIFA', slug: "jifa"},
                    {name : 'Better Food Foundation', slug: "bff"},
                    {name : 'Leadership-Circle', slug: "leadership-circle"},
                    {name : 'Buying Poultry', slug: "buying-poultry"}
                ],  // Todo : don fetch these from the sites collection
                change : function (e) {
                    var siteSlug = this.value();

                    pageListView.loadPagesDS(siteSlug);
                }
            });

            $('#pageList-search-input').keyup (function () {
                var val =  $('#pageList-search-input').val();

                if (val.length > 0) {
                    pageListView.pagesDS.filter({field: 'title', operator: 'contains', value: val});
                } else {
                    pageListView.pagesDS.filter({});
                }

            });

            $('#pageList-search-input').change (function () {
                var val =  $('#pageList-search-input').val();

                if (val.length > 0) {
                    pageListView.pagesDS.filter({field: 'title', operator: 'contains', value: val});
                } else {
                    pageListView.pagesDS.filter({});
                }
            });

            $("#pageList-grid").kendoGrid({
                dataSource: pageListView.pagesDS,
                pageSize : 12,
                autoBind: false,
                pageable: true,
                resizable: true,
                sortable: true,
                reorderable: true,
                toolbar: [{name: "save", text: "Save All Changes..."}],
                editable: true,
                edit : function (e) {
                    var page = e.model;
                    /*var addItemFlag = e.model.isNew();

                     if (person.Id === undefined) {
                     person.Id = uuid.v4()
                     }

                     if (person.name !== undefined && person.name !== null) {
                     person.name = person.name.capitalize();
                     person.slug = ux.createSlug(person.name);
                     }

                     if (person.title !== undefined && person.title !== null) {
                     person.title = person.title.capitalize();
                     }*/

                },
                height: 760,
                columns: [
                    { field:"site",title:"Site", width: 120 },
                    { field:"title",title:"Title", width: 120 },
                    { field:"slug",title:"Slug", width: 80 },
                    { field:"isPublished",title:"Published", width: 80},
                    { field:"modified",title:"Modified", width: 120},
                    { field:"authorName",title:"Author", width: 80 },
                    { title: "Edit", command: [ { text: "Edit Page", click: pageListView.doEditPage }, "destroy" ], width: 160,
                        attributes: {
                            style: "text-align: center;"
                        }
                    }
                ]
            });
            //  kendo.bind($("#contributorView-modal"), contributorView.activeObj);
        }
    },

    loadPagesDS : function (siteSlug) {
        var pages = null;
        if (siteSlug === null || siteSlug === 'all') {
            pages = pageModel.pageDS.data();
        } else {
            pages = pageModel.getSitePages(siteSlug);
        }

        pageListView.pagesDS.data(pages);
    },

    doEditPage : function (e) {
        var thisPage = this.dataItem($(e.currentTarget).closest("tr"));
        var pageSlug = thisPage.slug;

        APP.router.navigate("/pageeditor?pageid=" + pageSlug);
        // Invoke pageEditor with pageSlug...
    },

    open: function (siteSlug) {
        pageListView.init();
        $('#pageList-search-input').val('');
        pageListView.loadPagesDS(siteSlug);

    },

    close : function () {

    }

};
/**
 * Created by donbrad on 5/2/17.
 */
'use strict';

var petitionEditor = {

    _initialized: false,

    activeObj : new kendo.data.ObservableObject({
        campaignId: null,
        petitionId: null,
        title: null,
        description: null,
        content: null
    }),

    init: function () {

    },

    open : function () {

    },

    close : function () {

    }
};
'use strict';

var petitionModal = {

    _initialized: false,

    activeObj : new kendo.data.ObservableObject({siteName: 'Farm Forward', siteId: 'farm-forward', petitionId: null, campaignId: null, userId: null, name: null}),


    init : function () {
        if (!petitionModal._initialized) {
            petitionModal._initialized = true;

            templateLoader.loadHtml("petitionModal", '../../../templates/petitionModal.html', function(status) {
                if (status) {

                    kendo.bind($("#petitionModal"), petitionModal.activeObj);
                }
            });

        }
    },


    open : function (pledgeId) {
        var activeObj = petitionModal.activeObj;
        petitionModal.init();
        
        if(APP.siteName !== null && APP.siteName !== undefined){
            activeObj.set("siteName", APP.siteName);
        }

        activeObj.set('siteName', APP.siteName);
        activeObj.set('siteId', APP.siteSlug);

        activeObj.set('userId', userModel.userObj.Id);

        activeObj.set('name', userModel.userObj.name);




        $('#petitionModal').modal('show');
    },



    close : function () {

        $('#petitionModal').modal('toggle');

    }
};
/**
 * Created by donbrad on 5/2/17.
 */
'use strict';

var pledgeEditor = {

    _initialized: false,

    activeObj : new kendo.data.ObservableObject({
        campaignId : null,
        pledgeId: null,
        siteName : null,
        siteId : null,
        title: null,
        description: null,
        action: null,
        hasComments: false,
        updateFrequency: null, // "OnDemand", "Daily", "Weekly",  "Monthly"
        type: null // "Single", "Recurring"
    }),

    init: function () {

    },

    open : function () {

    },

    close : function () {

    }
};
'use strict';

var pledgeInfoModal = {

    _initialized: false,

    activeObj : new kendo.data.ObservableObject({
        title: "Milk Free Mornings",
        message: "This pledge includes a newletter and coupons for your mailbox!",
        email : null,
        emailValid : false,
        address: null,
        addressValid: false,
        needEmail: true,
        needAddress: true
    }),


    init : function () {
        if (!pledgeInfoModal._initialized) {
            pledgeInfoModal._initialized = true;

            templateLoader.loadHtml("pledgeInfoModal", '../../../templates/pledgeInfoModal.html', function(status) {
                if (status) {

                    kendo.bind($("#pledgeInfoModal"), pledgeInfoModal.activeObj);
                    var el = document.getElementById('pledgeInfo-address');
                    pledgeInfoModal.autocomplete = new google.maps.places.Autocomplete(el);

                    pledgeInfoModal.autocomplete.addListener('place_changed', function() {

                        var place = pledgeInfoModal.autocomplete.getPlace();
                        mapModel.processPlace(place);
                        var user = userModel.userObj;
                        var geoData = mapModel.activeObj;
                        user.set('lat', geoData.lat);
                        user.set('lng', geoData.lng);
                        user.set('address', geoData.address);
                        user.set('zipcode', geoData.ziplong);
                        user.set('county', geoData.county);
                        user.set('state', geoData.state);
                        user.set('country', geoData.country);

                        pledgeInfoModal.activeObj.set('addressValid', true);
                        if (!place.geometry) {
                            // User entered the name of a Place that was not suggested and
                            // pressed the Enter key, or the Place Details request failed.
                            ux.notify("No details available for input: '" + place.name + "'", 'error');

                        }
                    });

                    $("#pledgeInfo-email").on("blur", function(e){
                        var email = $('#pledgeInfo-email').val();
                        var emailValidation = pledgeInfoModal.verifyEmailUI(email);
                        if(!emailValidation){
                            profileView.verifyOnKeyUp();
                        }
                    });
                }
                $("#pledgeInfoModal").on("hide.bs.modal", function(){
                    pledgeInfoModal.clearFields();
                });
            });

            pledgeInfoModal.activeObj.bind("change", function (e) {
                var field = e.field;

                if (field === 'addressValid') {
                    var address =  pledgeInfoModal.activeObj.address;
                    $(".pledgeInfo-section-address").removeClass('has-error').addClass("has-success has-feedback");
                    if (ux.validateStr(address) && address.length > 12) {
                        pledgeInfoModal.activeObj.set('addressValid', true);
                        pledgeInfoModal.checkComplete();
                    }

                }

                if (field === 'email'){
                    var email = pledgeInfoModal.activeObj.email;

                    if (ux.validateEmail(email)) {
                        pledgeInfoModal.activeObj.set('emailValid', true);
                        userModel.userObj.set('email', email);
                        pledgeInfoModal.checkComplete();

                    } else {
                        pledgeInfoModal.activeObj.set('emailValid', false);
                    }
                }
            });


        }
    },

    checkComplete : function () {
        var obj = pledgeInfoModal.activeObj;
        var valid = true;
        if (obj.needAddress && !obj.addressValid) {
            valid = false;
        }

        if (obj.needEmail && !obj.emailValid) {
            valid = false;
        }
        if (valid)
         $("#pledgeInfo-save").attr("disabled", false);
    },


    test : function () {
        pledgeInfoModal.open(true, true, "A Sample Pledge", "This pledge includes an email newsletter and valuable coupons mailed to your home!");
    },

    open : function (needEmail, needAddress, title, message, callback) {
        pledgeInfoModal.init();

        if (callback !== undefined && callback !== null) {
            pledgeInfoModal.callback = callback;
        } else {
            pledgeInfoModal.callback = null;
        }

        var obj = pledgeInfoModal.activeObj;

        obj.set('email', userModel.userObj.email);
        obj.set('address', userModel.userObj.address);
        obj.set('title', title);
        obj.set('message', message);

        $("#pledgeInfo-save").attr("disabled", true);

        if (needEmail) {
            $('.pledgeInfo-section-email').removeClass('hidden');
        } else {
            $('.pledgeInfo-section-email').addClass('hidden');
        }

        if (needAddress) {
            $('.pledgeInfo-section-address').removeClass('hidden');
        } else {
            $('.pledgeInfo-section-address').addClass('hidden');
        }


        $('#pledgeInfoModal').modal('show');
    },

    locateMe : function () {
        mapModel.getUserLocation(function (geoData) {
            if (geoData !== null) {
                var user = userModel.userObj;
                pledgeInfoModal.activeObj.set('address', geoData.address);

                user.set('lat', geoData.lat);
                user.set('lng', geoData.lng);
                user.set('address', geoData.address);
                user.set('zipcode', geoData.zipcode);
                user.set('county', geoData.county);
                user.set('state', geoData.state);
                user.set('country', geoData.country);
                pledgeInfoModal.activeObj.set('addressValid', true);

            }
        });
    },
    verifyOnKeyUp: function() {
        $("#pledgeInfo-email").off().on("keyup", function(){
            var email = $('#pledgeInfo-email').val();
            pledgeInfoModal.verifyEmailUI(email);
        });
    },

    verifyEmailUI: function(email){
        var result = ux.validateEmail(email);
        if (result) {
            $(".pledgeInfo-section-email").removeClass('has-error').addClass("has-success has-feedback");
            $(".pledgeInfo-section-email > .help-block").text("");
            //$(".profile-section-email > .form-control-feedback i").text("check");
            $("#pledgeInfo-save").attr("disabled", false);
            return (true);
        } else {
            $(".pledgeInfo-section-email").addClass('has-error').removeClass("has-success");
            //$(".profile-section-email > .form-control-feedback i").text("close");
            $(".pledgeInfo-section-email > .help-block").text("Invalid email address");
            $("#pledgeInfo-save").attr("disabled", true);
            return (false);
        }
    },

    doSave : function () {
        $('#pledgeInfoModal').modal('toggle');
        if (pledgeInfoModal.callback !== null) {
            pledgeInfoModal.callback(true) ;
        }
    },

    close : function () {
        // clearing fields from hide event
        $('#pledgeInfoModal').modal('toggle');

        if (pledgeInfoModal.callback !== null) {
            pledgeInfoModal.callback(false) ;
        }

    },

    clearFields: function() {
        var obj = pledgeInfoModal.activeObj;
        $("#pledgeInfo-email, #pledgeInfo-address").val("");
        $(".pledgeInfo-section-email").removeClass("has-success has-error");
        $(".pledgeInfo-section-address").removeClass("has-success has-error");
        $("#pledgeInfoModal .help-block").text("");
    }
};
/**
 * Created by donbrad on 3/22/17.
 */
'use strict';

var pledgeListView = {
    _initialized: false,
    _reportInitialized : false,
    _siteSlug : null,
    _campaignSlug : null,
    _currentPledge: null,
    activeObj : new kendo.data.ObservableObject({siteName: "Farm Forward", siteSlug: 'farm-forward', listId: '166cf7ddf5', listName: "Farm Forward Master List" }),
    mcGroupDS :  new kendo.data.DataSource(),
    pledgeDS : new kendo.data.DataSource({
        pageSize: 12,
        schema: {
            model: {
                id: "Id",
                fields: {
                    siteName:  { nullable: false},
                    siteSlug:  { nullable: false},
                    listId: { nullable: false},
                    listName: {nullable: false},
                    title:  { nullable: false, validation: {required : true} },
                    pledgeId : {nullable: false},
                    startDate:  { type: "Date", defaultValue: new Date(),  nullable: true },
                    endDate:  { type: "Date", defaultValue: new Date(),  nullable: true }
                }
            }
        },
        transport : {
            create: function (options) {
                var obj = pledgeListView.activeObj;
                var model = options.data;
                model.Id = uuid.v4();
                model.pledgeId = model.Id;
                model.listId = obj.listId;
                model.listName = obj.listName;
                model.siteName = obj.siteName;
                model.siteSlug = obj.siteSlug;

                pledgeModel.add(model);
                options.success();
            },

            destroy : function (options) {
                var model = options.data;
                pledgeModel.remove(model);
                options.success();
            },

            read: function (options) {
                var pages = [];
                if (pledgeListView.activeObj.siteSlug !== null) {
                    pages = pledgeModel.listBySiteSlug(pledgeListView.activeObj.siteSlug);
                }
                options.success(pages);
            },

            update : function (options) {
                var model = options.data;
                if (model.title !== null) {
                    var slug = model.siteSlug + "-" + ux.createSlug(model.title);
                    model.slug = slug;
                }

                pledgeModel.update(model);
                options.success();
            },

            parameterMap: function(options, operation) {
                if (operation !== "read" && options.models) {
                    return {models: kendo.stringify(options.models)};
                }
            }
        }
    }),

    _pageSize : 12,
    _reportTemplate : null,


    init: function(){
        if(!pledgeListView._initialized){

            pledgeListView._initialized = true;

            $('#pledgeList-search-input').keyup (function () {
                var val =  $('#pledgeList-search-input').val();

                if (val.length > 0) {
                    pledgeListView.pledgeDS.filter({field: 'title', operator: 'contains', value: val});
                } else {
                    pledgeListView.pledgeDS.filter({});
                }

            });

            $('#pledgeList-search-input').change (function () {
                var val =  $('#pledgeList-search-input').val();

                if (val.length > 0) {
                    pledgeListView.pledgeDS.filter({field: 'title', operator: 'contains', value: val});
                } else {
                    pledgeListView.pledgeDS.filter({});
                }
            });

            $("#pledgeListSite-selector").kendoDropDownList({
                dataTextField: "name",
                dataValueField: "slug",
                dataSource: mailchimpModel.lists,  // Todo : don fetch these from the sites collection
                change : function (e) {
                    var site = this.dataItem(this.selectedIndex);

                    var obj = pledgeListView.activeObj;

                    obj.set('siteName', site.name);
                    obj.set('siteSlug', site.slug);
                    obj.set('listId', site.id);

                    var listName = mailchimpModel.getListName(list.id);
                    obj.set('listName', listName);
                    pledgeListView.loadDataSources(site.id, site.slug);

                }
            });

          $("#pledgeList-grid").kendoGrid({
            dataSource: pledgeListView.pledgeDS,
            pageSize : 12,
            autoBind: false,
            pageable: true,
            resizable: true,
            sortable: true,
            reorderable: true,
            selectable: true,
            batch: true,
            toolbar: [{name: "create", text: "Add Entry"},{name: "save", text: "Save Changes "}],
            editable: "inline",
            edit: function (e) {
                var model = e.model;
                if (model.title!== null) {
                    var slug = model.siteSlug+"-"+ux.createSlug(model.title);
                    model.set('slug', slug);
                }
                pledgeListView._currentPledge = model;

            },
            change: function(e) {
                var selectedRow = this.select();
                var dataItem = this.dataItem(selectedRow[0]);

                if (dataItem.title!== null) {
                    var slug = dataItem.siteSlug+"-"+ux.createSlug(dataItem.title);
                    dataItem.set('slug', slug);
                }

            },

            height: 580,
            columns: [
                { field:"mcGroups",title:"MC Groups",editor:  pledgeListView._mcGroupEditor, width: "320px" },
                { field:"title",title:"Title", width: "320px" },
                { field:"slug",title:"Slug", width: "320px" },
                {  command: [ "edit", "destroy" ], title: "Dev Tools",  width: "120px"}
            ]
        });
               //  kendo.bind($("#contributorView-modal"), contributorView.activeObj);
        }
    },

    loadDataSources : function (listId, siteSlug) {
        var groups = mcGroupModel.listByListId(listId);

        pledgeListView.mcGroupDS.data(groups);

        var pledges = pledgeModel.listBySiteSlug(siteSlug);

        pledgeListView.pledgeDS.data(pledges);

    },



      open: function (siteSlug, reportId) {
        pledgeListView.init();
        $('#pledgeList-search-input').val('');

        var obj = pledgeListView.activeObj;

        obj.set('siteSlug', APP.siteSlug);
        obj.set('siteName', APP.siteName);
        var listId = mailchimpModel.getListIdBySlug(APP.siteSlug);
        var listName = mailchimpModel.getListName(listId);
        obj.set('listId', listId);
        obj.set('listName', listName);

        $("#pledgeListSite-selector").data('kendoDropDownList').value(APP.siteSlug);

       pledgeListView.loadDataSources(listId, APP.siteSlug);

        if (reportId !== undefined && reportId !== null) {
            var report = pledgeModel.findById(reportId);

            if (report !== null) {
                if (pledgeListView._reportTemplate === null) {
                    templateLoader.load('../../../templates/pledgeReport-tmpl.html', function(status) {
                        if(status){
                            pledgeListView._reportTemplate = kendo.template($("#pledgeReport-tmpl").html());

                            pledgeListView.doReport(report);
                        }
                    });
                }

            }
        }


    },

    close : function () {

    },

    _readOnly : function (container, options) {
        ux.notify (options.field + " is readonly", 'error');
    },

    _dateEditor : function (container, options) {
        $('<input data-text-field="' + options.field + '" data-value-field="' + options.field + '" data-bind="value:' + options.field + '" data-format="' + options.format + '"/>')
            .appendTo(container)
            .kendoDatePicker({ min: new Date()});
    },



    _booleanEditor : function (container, options) {
        $('<input required name="' + options.field + '"/>')
            .appendTo(container)
            .kendoDropDownList({
                autoBind: false,
                dataTextField: 'Text',
                dataValueField: 'Text',
                dataSource:  [{ Value: "true", Text: "Yes" }, { Value: "false", Text: "No" }]
            });
    },

    _currencyEditor : function (container, options) {
        $('<input required name="' + options.field + '"/>')
            .appendTo(container)
            .kendoNumericTextBox({
                decimals: 2,
                format: "n"
            });
    },


    _siteEditor : function (container, options) {
        $('<input required name="' + options.field + '"/>')
            .appendTo(container)
            .kendoDropDownList({
                autoBind: false,
                dataTextField: "name",
                dataValueField: "slug",

                dataSource: [
                    {name : 'All', slug: "all"},
                    {name : 'Farm Forward', slug: "farm-forward"},
                    {name : 'JIFA', slug: "jifa"},
                    {name : 'Better Food Foundation', slug: "bff"},
                    {name : 'Leadership-Circle', slug: "leadership-circle"},
                    {name : 'Buying Poultry', slug: "buying-poultry"}
                ]
            });
    },

    _listEditor : function (container, options) {
        $('<input required name="' + options.field + '"/>')
            .appendTo(container)
            .kendoDropDownList({
                autoBind: false,
                dataTextField: "name",
                dataValueField: "id",
                change : function (e) {
                    var list = this.dataItem(this.selectedIndex);

                    pledgeListView._currentPledge.set('listId',list.id);
                    pledgeListView._currentPledge.set('listName',list.name);
                    pledgeListView._currentPledge.set('siteSlug',list.slug);

                    var groups = mcGroupModel.listByListId(list.id);
                    pledgeListView.mcGroupDS.data(groups);


                },
                dataSource: mailchimpModel.lists
            });
    },

    _pledgeTypeEditor : function (container, options) {
        $('<input required name="' + options.field + '"/>')
            .appendTo(container)
            .kendoDropDownList({
                autoBind: false,
                dataTextField: "name",
                dataValueField: "slug",
                dataSource: [
                    {name : 'Single', slug: "single"},
                    {name : 'Recurring', slug: "recurring"}
                ]
            });
    },

    _mcGroupEditor : function (container, options) {
        $('<input  name="' + options.field + '"/>')
            .appendTo(container)
            .kendoMultiSelect({
                autoBind: false,
                dataTextField: "interestName",
                dataValueField: "interestId",
                dataSource: pledgeListView.mcGroupDS
            });
    },


    _pledgeActionEditor : function (container, options) {
        $('<input required name="' + options.field + '"/>')
            .appendTo(container)
            .kendoMultiSelect({
                autoBind: false,
                dataTextField: "name",
                dataValueField: "slug",
                dataSource: [
                    {name : 'Personal', slug: "personal"},
                    {name : 'Share', slug: "share"},
                    {name : 'Daily Action', slug: "daily"},
                    {name : 'Weekly Action', slug: "weekly"},
                    {name : 'Monthly Action', slug: "monthly"}


                ]
            });
    }


};
'use strict';

var pledgeModal = {

    _initialized: false,

    activeObj : new kendo.data.ObservableObject({
        siteName: 'Farm Forward',
        siteId: 'farm-forward',
        pledgeId: null,
        campaignId: null,
        userId: null,
        name: null
    }),


    init : function () {
        if (!pledgeModal._initialized) {
            pledgeModal._initialized = true;

            templateLoader.loadHtml("pledgeModal", '../../../templates/pledgeModal.html', function(status) {
                if (status) {

                    kendo.bind($("#pledgeModal"), pledgeModal.activeObj);
                }
            });

        }
    },


    open : function (pledgeId) {
        pledgeModal.init();
        var activeObj = pledgeModal.activeObj;

        if(APP.siteName !== null && APP.siteName !== undefined){
            activeObj.set("siteName", APP.siteName);
            activeObj.set('siteId', APP.siteSlug);
        }

        activeObj.set('userId', userModel.userObj.Id);
        activeObj.set('name', userModel.userObj.name);




        $('#pledgeModal').modal('show');
    },



    close : function () {

        $('#pledgeModal').modal('toggle');

    }
};
'use strict';

var productView = {
    search: null,
    _onInit: false,
    resultsData : [],
    _initialQuery: false,
    _noResultQuery : null,
    _noResultSent : false,
    _processQuery : null,
    _lastQuery : null,

    _userReport : new kendo.data.ObservableObject({
        query : null,
        product: null,
        brand : null,
        category : 'Chicken',
        store: null,
        address : null,
        comment : null
    }),

    _defaultProductImageUrl : 'http://res.cloudinary.com/hyjvcxzjt/image/upload/v1483036299/product/icon-defaultProduct.png',

    init: function() {
        if(!productView._onInit){
            /// Product search widget

            productView.search = instantsearch({
                appId: algolia._appId,
                apiKey: algolia._searchKey,
                indexName: "product",
                /*searchFunction: function(helper) {

                    if (helper.state.hierarchicalFacetsRefinements.category !== undefined &&
                        helper.state.hierarchicalFacetsRefinements.category.length > 0) {
                        // Active category - best, better...
                        helper.search();
                    } else if (helper.state.hierarchicalFacetsRefinements.productCategory !== undefined &&
                        helper.state.hierarchicalFacetsRefinements.productCategory.length > 0) {
                        // Active Product - chicken, eggs...
                        helper.search();
                    } else if (helper.state.query.length  > 1) {
                        helper.search();
                    }

                },*/
                urlSync: false
            });

            /// Search box widget
            productView.search.addWidget(
                instantsearch.widgets.searchBox({
                    container: "#productSearch-container",
                    queryHook: function (query, search) {
                      if (query.length === 0) {
                          productView._noResultQuery = null;
                          productView._noResultSent = false;
                      }
                      productView._lastQuery = query;
                      search(query);
                    },
                    placeholder: "Search by product name or brand....",
                    cssClasses: {
                        input: "productList-search"
                    }
                })
            );

            /// Hits/results widget
            productView.search.addWidget(
                instantsearch.widgets.hits({
                    container: "#productSearch-results",
                    cssClasses: {
                      item: "productSearch-item"
                    },
                    templates: {
                        item: function(data){

                            var categoryClass = null;
                            var categoryStr = data.category.toLowerCase();
                            var productFavorite = "";
                            var productImg = "";

                            var name, brandName, brandNameStr, descStr = "";
                            productView.resultsData[data.objectID] = data;
                            switch(categoryStr){
                                case "best":
                                    categoryClass = "productList-best";
                                    break;
                                case "better":
                                    categoryClass = "productList-better";
                                    break;
                                case "avoid":
                                    categoryClass = "productList-avoid";
                                    break;
                            }

                            var imageUrl = "";


                            if(data.productImage !== null){
                                imageUrl = data.productImage;
                                productImg = '<span class=productList-img><img src="' + imageUrl + '" /></span>';
                            } else if (data.brandImage !== null) {
                                imageUrl = data.brandImage;
                                productImg = '<span class=productList-img><img src="' + imageUrl + '" /></span>';
                            } else {
                                //imageUrl = 'images/';
                                productImg = "<span class=productList-img><img src="+ productView._defaultProductImageUrl + " /></span>";
                            }

                            //var isFavorite = favorites.findFavoriteByObjectId(data.objectID);

                            if(categoryStr !== "avoid"){
                                var isFavorite = false;
                                // if user is authenticated check for favs
                                if(userView.userActive){
                                    isFavorite = favorites.findFavoriteByObjectId(data.objectID);
                                }
                                var favStr = '<i class="material-icons">favorite_border</i></a>';
                                if (isFavorite) {
                                    favStr = '<i class="material-icons favorite">favorite</i></a>';
                                }
                                productFavorite = "<span class='productList-favorite'>" +
                                    "<a class='icon-favorite' onclick='productView.toggleFavorite(event)'" + "data-toggle=tooltip data-placement=left title=Favorite data-favorite=false id='product-" + data.objectID + "'>" +
                                      favStr   +
                                    "</span>";

                            }

                            if(data.productName !== null){
                                // todo - escape content
                                name = data.productName;
                            }


                            if(data.brandName !== null){
                                // todo - escape content
                                brandName = data.brandName.toString();
                                brandNameStr = brandName.replace(/["|']/g, "&#39;");
                            }

                           /* if(data.description !== null){
                                descStr = data.description;
                            }*/

                            var certString = "", claimString = "";


                            if (data.certifications !== null && data.certifications.length > 0 ) {

                                var cert = data.certifications.join(', ');
                                certString = "<span class=list-certified><img src='images/icon-certified.svg'/>" +
                                    cert + "</span>";

                            }

                            if (data.claims !== null && data.claims.length > 0 ) {
                                var claim = data.claims.join(', ');
                                claimString = "<span class=list-certified><img src='images/icon-claim.svg'/>" + claim + "</span>";
                            }

                           var categoryString = "Avoid";

                            if (data.category === 'Best') {
                                categoryString = "Best Choice";
                            } else if (data.category === "Better") {
                                categoryString = "Better Choice";
                            }
                            var plantUrl = "";
                            if (data.productCategory === 'Plant Based') {
                                plantUrl = '<span class="icon-plant"></span>';
                            }

                                var toRender = "<div class=\"productList-item\" id="+ data.objectID + ">" +
                                "<span class='productList-category " + categoryClass + "'>" + categoryString + "</span>" +
                                productFavorite + productImg +
                                "<span class=productList-infoBox>" +
                                "<h4> " + name +  plantUrl + "</h4>" +
                                "<a class='brandInfo hidden-xs' onclick=\"brandModal.onClick(event)\" data-brandid='" + data.brandId+  "'>" + brandNameStr + "</a>" +
                                "<p class=subInfo>" + certString + "</p>" +
                                "<p class=subInfo>" + claimString + "</p>" +
                                "</span></div>";

                            return toRender;

                        },
                        empty: function(data){
                            var template = kendo.template($("#noProductsTemplate").html());

                            if (productView._noResultQuery === null) {
                                productView._noResultQuery = data.query;
                            } else if (data.query.length > productView._noResultQuery.length) {
                                // User is adding to query -- just accumulate
                                productView._noResultQuery = data.query;

                            } else if (data.query.length < productView._noResultQuery.length){
                                // User is deleteing from query -- send no result
                                if (!productView._noResultSent) {
                                    analyticsModel.sendGAEvent('noresult', 'query', productView._noResultQuery.length);
                                    productView._noResultSent = true;
                                }

                            }
                            
                            var result = template(productView._userReport); //Execute the template
                            return result;




                        }
                    },
                    hitsPerPage: 50
                })
            );

            /// menu widget - category
            productView.search.addWidget(
                instantsearch.widgets.menu({
                   container: "#productSearch-category",
                    attributeName: "category",
                    sortBy: ["count: asc"],
                    cssClasses: {
                       item: "productList-filterItems",
                       active: "activeFilter"
                    },
                    templates: {
                       header: "Filter by rating",
                        item: function(data){
                            var categoryStr = data.name.toLowerCase();
                            return "<span class='productList-filter product-" + categoryStr + "'>" + data.name + "</span>"+
                                "<span class=productList-filter-count> (" + data.count + ")</span>";
                        }
                    }
                })
            );

            productView.search.addWidget(
                instantsearch.widgets.pagination({
                    container: "#productSearch-pagination",
                    cssClasses: {
                        active: "pagination-active"
                    }
                })
            );

            /// menu widget - productCategory
            productView.search.addWidget(
                instantsearch.widgets.menu({
                    container: "#productSearch-productCategory",
                    attributeName: "productCategory",
                    sortBy: ["name: asc"],
                    cssClasses: {
                        item: "productList-filterItems",
                        active: "activeCategory"
                    },
                    templates: {
                        header: "Filter by category",
                        item: function(data){
                            return "<span class=productList-filter><span class=productList-filterDelete>&times;</span>" + data.name + "</span>"+
                                "<span class=productList-filter-count> (" + data.count + ")</span>";
                        }
                    }
                })
            );

            /// menu widget - productCategory
            productView.search.addWidget(
                instantsearch.widgets.menu({
                    container: "#productSearch-brandName",
                    attributeName: "brandName",
                    sortBy: ["name: asc"],
                    cssClasses: {
                        item: "productList-filterItems",
                        active: "activeCategory"
                    },
                    templates: {
                        header: "Filter by Brand",
                        item: function(data){
                            return "<span class=productList-filter><span class=productList-filterDelete>&times;</span>" + data.name + "</span>"+
                                "<span class=productList-filter-count> (" + data.count + ")</span>";
                        }
                    }
                })
            );

            /// Stats widget
            productView.search.addWidget(
                instantsearch.widgets.stats({
                    container: "#productSearch-stats"
                })
            );

            productView.search.on('render', function(){
                $(".icon-favorite").tooltip();

                $(".productList-item").unbind().on("click", function(e){
                    e.stopPropagation();
                    if(e.target.tagName === 'A'){
                        var targetHref = e.target.getAttribute("href");
                        if (targetHref !== undefined && targetHref !== null) {
                            APP.router.navigate(targetHref);
                        }
                    } else {
                        var currentId = $(e.currentTarget).attr("id");
                        var dataObj = productView.resultsData[currentId];

                        if(dataObj !== undefined){
                            productModal.openModal(dataObj);
                        }
                    }

                });

            });

            productView.search.start();

            kendo.bind($("#productModal"), productModal.activeObj);
            kendo.bind($("#brandModal"), brandModal.activeObj);
            kendo.bind($("#productReport-modal"), productView._userReport);

            $("#noProduct-form").validator();

            $("#mobile-productFilters").on("show.bs.collapse", function(e){
                $("#toggle-mobileProductFilters-txt").text("Hide filters");
            });

            $("#mobile-productFilters").on("hide.bs.collapse", function(e){
                $("#toggle-mobileProductFilters-txt").text("Show filters");
            });

            $(window).resize(function(){
                var screenWidth = $(window).width();

                if(screenWidth < 767){
                    $("#mobile-productFilters").removeClass("in");
                } else {
                    $("#mobile-productFilters").addClass("in");
                }
            });

            productView._onInit = true;
        }

        if (userView.isStaff() || userView.isBlogger()) {
            $('.bpstaff').removeClass('hidden');

        } else {
            $('.bpstaff').addClass('hidden');
        }
    },

    _initUserReport : function () {
        productView._userReport.set('query', null);
        productView._userReport.set('product', null);
        productView._userReport.set('brand', null);
        productView._userReport.set('category', 'Chicken');
        productView._userReport.set('store', null);
        productView._userReport.set('address', null);
        productView._userReport.set('comment', null);

        $(".noProduct-locationInfo").addClass("hidden");
    },

    openUserReport : function () {
        productView._initUserReport();

        productView._userReport.set('query', productView._lastQuery);
        productView._userReport.set('product', productView._lastQuery);

        $('#productReport-modal').modal('toggle');
    },

    closeUserReport : function () {

        $('#productReport-modal').modal('toggle');
    },

    doSendReport : function () {
        var reportObj = productView._userReport;

        analyticsModel.sendGAEvent('noresult', 'userreport', JSON.stringify(reportObj));

        userReport.add(reportObj);

        productView._initUserReport();
        productView.closeUserReport();

    },

    addLocation : function () {
        $('.noProduct-locationInfo').removeClass('hidden');
    },

    onShow: function(){


    },


    editBrands : function () {
        APP.router.navigate('#/brand');
    },


    lookupResult : function(array, prop, value) {
        for (var i = 0, len = array.length; i < len; i++)
            if (array[i] && array[i][prop] === value) return array[i];
    },

    toggleFavorite: function(e){
        e.stopPropagation();
        if(userView.currentUser.Id !== null){
            var targetId = "";
            var targetClass = e.target.classList;

            if(targetClass[0] === "material-icons" || targetClass[0] === "favorite"){
                targetId = "#" + e.target.parentElement.id;
            } else {
                targetId = "#" + e.target.id;
            }
            // todo - wire favorite
            if(e.target.id !== undefined){
                var targetFav = $(targetId).data("favorite");

                targetFav = !targetFav;   // Toggle it!

                var objectId = targetId.replace('#product-', '');
                var results = this.resultsData;


                //var product = productView.lookupResult(results, 'objectID', objectId);
                var product = productView.resultsData[objectId];   // Use the hash for direct access

                if (product === undefined || product === null) {

                } else {
                    var productName = "Opps - No Product...";

                    if (product.productName !== undefined && product.productName !== null) {
                        productName = product.productName;
                    }

                  /*  var url = "/favorite?state="+targetFav+'&category=product&title='+productName;
                    ga('set', 'page', url);
                    ga('send', 'pageview');
*/
                    if(targetFav){
                        $(targetId).data("favorite", true).velocity("fadeIn");
                        $(targetId + " > i.material-icons").text("favorite").addClass("favorite");
                        var fObj = JSON.stringify(product);
                        fObj = JSON.parse(fObj);

                        var imageUrl = product.productImage;

                        if (imageUrl === null)
                            imageUrl = product.brandImage;
                        favorites.addFavorite(favorites._product, product.productId, product.productName, imageUrl,  fObj );
                        analyticsModel.sendGAEvent("favorite", "product", product.productName);
                        ux.notify(productName + " added to favorites", "success");
                    } else {
                        $(targetId).data("favorite", false).velocity("fadeIn");
                        $(targetId + " > i.material-icons").text("favorite_border").removeClass("favorite");
                        var favObj = favorites.findFavoriteByObjectId(product.productId);
                        analyticsModel.sendGAEvent("unfavorite", "product", product.productName);
                        if (favObj !== undefined && favObj !== null) {
                            favorites.removeFavorite(favObj);
                        }
                        ux.notify(productName + " removed from favorites", "success");
                    }
                }

            }
        } else {
            userView.openSignUp();
        }

    }
};

var productModal = {
    activeObj: new kendo.data.ObservableObject({
        productName: null,
        description: null,
        brandName : null,
        productId : null,
        brandId : null,
        claimString: null,
        claims: [],
        certString : null,
        certs : [],
        category : null,
        productCategory : null,
        searchUrl : null,
        website: null,
        gradeName : null,
        infoCategory: null,
        infoTitle : null,
        infoContent: null,
        infoImageUrl : null,
        infoId: null,
        isPlantBased: null,
    }),

    defaultImg: "./images/icon-logo-brand-dark.png",
    isInit: false,

    buildClaimString : function (claims) {
        var str = '<div>';

        for (var i=0; i< claims.length; i++) {
            var claim = claims[i];
            var buttonStr = '<a onclick="productModal.displayClaim(event)" class="label label-claim productModal-infoTag">' + claim + '</a> ';
            str += buttonStr;

        }
        str += "</div>";
        return(str);
    },

    buildCertString : function (certs) {
        var str = '<div>';

        for (var i=0; i< certs.length; i++) {
            var cert = certs[i];
            var buttonStr = '<a class="label label-cert productModal-infoTag" onclick="productModal.displayCertification(event)" title="Click for more info" data-tag="' + cert + '"> ' + cert + ' </a> ';
            str += buttonStr;

        }
        str += "</div>";
        return(str);
    },

    displayClaim : function (event) {
        var title = event.toElement.innerText;

        $(".productModal-infoTag").removeClass("active");
        $(event.target).addClass("active");

        if (title.indexOf('/') !== -1)  {
            var titleArray = title.split('/');
            title = titleArray[0];
        }

        var label = labelGuideView.findLabelByAlias(title);

        if(label !== undefined && label !== null){
            productModal.activeObj.set('infoCategory', "Claim");
            productModal.activeObj.set('infoContent', label.tooltip);
            productModal.activeObj.set('infoImageUrl', label.imageUrl);
            productModal.activeObj.set('infoTitle', title);
            productModal.activeObj.set('infoId', label.id);
        } else {
            productModal.activeObj.set('infoTitle', "No additional info available.");
            productModal.activeObj.set('infoImageUrl', productModal.defaultImg);
            productModal.activeObj.set('infoContent', null);
            productModal.activeObj.set('infoCategory', null);
            productModal.activeObj.set('infoId', null);
        }


    },


    displayCertification : function (event) {

        $(".productModal-infoTag").removeClass("active");
        $(event.target).addClass("active");
        var title = event.toElement.innerText;
        var label = labelGuideView.findLabelByAlias(title);

        productModal.activeObj.set('infoTitle', title);
        if(label !== undefined && label !== null){
            productModal.activeObj.set('infoId', label.id);
            productModal.activeObj.set('infoContent', label.tooltip);
            productModal.activeObj.set('infoImageUrl', label.imageUrl);
            productModal.activeObj.set('infoCategory', label.category);

        } else {
            productModal.activeObj.set('infoTitle', "No additional info available.");
            productModal.activeObj.set('infoImageUrl', productModal.defaultImg);
            productModal.activeObj.set('infoContent', null);
            productModal.activeObj.set('infoCategory', null);
            productModal.activeObj.set('infoId', null);
        }
    },

    displayGradeName : function (event) {
        var grade = event.toElement.innerText.toLowerCase();

        $(".productModal-infoTag").removeClass("active");
        if(event.target.tagName !== "SPAN"){
            $(event.target).addClass("active");
        } else {
            $(event.target.parentNode).addClass("active");
        }


        var gradeStr = grade;
        if(grade.indexOf("+") > -1){
            grade = grade.split("+");
            gradeStr = grade[0] + "-plus";
        }
        var gradeSlug = 'grade-'+gradeStr;

        var gradeObj = glossaryModel.findBySlug(gradeSlug);
        if (gradeObj !== null) {
            productModal.activeObj.set('infoTitle', gradeObj.title);
            productModal.activeObj.set('infoContent', gradeObj.content);
            productModal.activeObj.set('infoImageUrl', productModal.defaultImg);
            productModal.activeObj.set('infoCategory', "Product Rating");
            productModal.activeObj.set('infoId', gradeObj.id);
        } else {
            ux.notify("Sorry we are having an issue finding it", "error");
        }
    },

    goToLabelGuide: function(){
        var labelId = productModal.activeObj.infoId;
        $("#productModal").modal("toggle");

        APP.router.navigate("/labelguide?labelid=" + labelId);
    },

    openModalByObjectId : function (objectId) {
        algolia.productIndex.getObject(objectId, function (err, content) {
            if (err === null) {
                ux.notify("Loading " + content.productName);
               productModal.openModal(content);
            } else {
                ux.notify("Sorry,  Couldn't locate this product!");
            }

        });
    },

    _updateProductUrl : function (objectId) {
        var newUrl = '#/product?objectid='+objectId;
        history.pushState({}, null, newUrl);
    },

    closeModal : function () {
        $("#productModal").modal("toggle");
        history.pushState({}, null, '#/product');
    },

    openModal: function(data){

        if(!productModal.isInit){
            $('[data-toggle="tooltip"]').tooltip();
            productModal.isInit = true;
        }
        if (userView.isStaff() || userView.isBlogger()) {
            $('.bpstaff').removeClass('hidden');

        } else {
            $('.bpstaff').addClass('hidden');
        }

        var categoryString = "Avoid";

        if (data.category === 'Best') {
            categoryString = "Best Choice";
        } else if (data.category === "Better") {
            categoryString = "Better Choice";
        }

        var claimStr = productModal.buildClaimString(data.claims);
        var certStr = productModal.buildCertString(data.certifications);
        productModal.activeObj.set('objectId', data.objectID);
        productModal.activeObj.set("productName", data.productName);
        productModal.activeObj.set("productId", data.productId);
        productModal.activeObj.set("brandName", data.brandName);
        productModal.activeObj.set("brandId", data.brandId);
        productModal.activeObj.set("claimString", claimStr);
        productModal.activeObj.set("claims", data.claims);
        productModal.activeObj.set("certString", certStr);
        productModal.activeObj.set("certs", data.certifications);
        productModal.activeObj.set("category", data.category);
        productModal.activeObj.set("productCategory", data.productCategory);
        if (data.productCategory === 'Plant Based') {
            productModal.activeObj.set('isPlantBased', true);
        } else {
            productModal.activeObj.set('isPlantBased', false);
        }
        productModal.activeObj.set("categoryString", categoryString);
        productModal.activeObj.set("gradeName", data.gradeName);
        productModal.activeObj.set("searchUrl", 'https://www.google.com/#q='+data.productName);
        productModal.activeObj.set('infoCategory', null);
        productModal.activeObj.set('infoTitle', null);
        productModal.activeObj.set('infoContent', null);
        productModal.activeObj.set('infoImageUrl', null);

        var isFavorite = favorites.productCache[data.objectID] !== undefined;

        if(isFavorite){
            $("#productModal-actions > .fav > i").text("favorite").addClass("favorite");
            $("#productModal-actions > .fav").data("favorite", true);
        } else {

            $("#productModal-actions > .fav > i").text("favorite_border").removeClass("favorite");
            $("#productModal-actions > .fav").data("favorite", false);
        }

        analyticsModel.sendGAEvent('product','view', data.productName);


        if(data.productImage !== null){
            productModal.activeObj.set("imageUrl", data.productImage);
        } else if(data.brandImage !== null){
            productModal.activeObj.set("imageUrl", data.brandImage);
        } else {
            productModal.activeObj.set("imageUrl", null);
        }

        productModal._updateProductUrl(data.objectID);
        shareModel.setShare("Buying Poultry", "Check out " + data.productName, 'http://www.buyfarmfoward.com/#/product?objectid=' + data.objectID);

        // category
        var categoryStr = data.category.toLowerCase();
        switch(categoryStr){
            case "best":
                 $("#productModal .bp-rating").removeClass("productList-best, productList-better, productList-avoid").addClass("productList-best");
                productModal.activeObj.set("ux_allowFav", true);
                break;
            case "better":
                $("#productModal .bp-rating").removeClass("productList-best, productList-better, productList-avoid").addClass("productList-better");
                productModal.activeObj.set("ux_allowFav", true);
                break;
            case "avoid":
                $("#productModal .bp-rating").removeClass("productList-best, productList-better, productList-avoid").addClass("productList-avoid");
                productModal.activeObj.set("ux_allowFav", false);
                break;
        }

        // website url
        productModal.activeObj.set("brandUrl", data.brandUrl);

        //productModal.activeObj.set("description", data.description);
            //$("#productModal-title").text(data.name);
            //$("#productModal-desc").html(data.description);
        $(".productModal-infoTag").removeClass("active");

        $("#productModal").modal("toggle");
    },

    editProduct : function () {
        $("#productModal").modal("toggle");
        APP.router.navigate('#/brandeditor?brandid='+productModal.activeObj.brandId);
    },

    toggleFav: function(e){
        if(userView.currentUser.Id !== null){
            var objectId = productModal.activeObj.objectId;

            var item = $("#productModal-actions > .fav");
            var fav = $("#productModal-actions > .fav").data("favorite");


            if(fav){
                $("#productModal-actions > .fav > i").text("favorite_border").removeClass("favorite");
                $("#productModal-actions > .fav").data("favorite", false);
                var favObj = favorites.findFavoriteByObjectId(productModal.activeObj.productId);
                if (favObj !== undefined && favObj !== null) {
                    favorites.removeFavorite(favObj);
                }
                productModal.activeObj.set('isFavorite', false);
                analyticsModel.sendGAEvent('product','unfavorite', productModal.activeObj.productName);
            } else {
                $("#productModal-actions > .fav > i").text("favorite").addClass("favorite");
                $("#productModal-actions > .fav").data("favorite", true);

                productModal.activeObj.set('isFavorite', true);
                var fObj = JSON.stringify(productModal.activeObj);
                fObj = JSON.parse(fObj);

                analyticsModel.sendGAEvent('product','favorite', productModal.activeObj.productName);
                favorites.addFavorite(favorites._product, productModal.activeObj.productId, productModal.activeObj.productName,  productModal.activeObj.imageUrl,  fObj );

            }

        } else {
            userView.openSignUp();
        }

    },

    hideInfo: function(){
        productModal.activeObj.set('infoTitle', "No additional info available.");
        productModal.activeObj.set('infoImageUrl', productModal.defaultImg);
        productModal.activeObj.set('infoContent', null);
        productModal.activeObj.set('infoCategory', null);
        productModal.activeObj.set('infoSlug', null);

        $(".productModal-infoTag").removeClass("active");
    }


};

var brandModal = {

    activeObj: new kendo.data.ObservableObject({
        brandName: null,
        category : null,
        gradeName : null,
        gradeScore : null,
        brandId : null,
        objectID : null,
        brandUrl : null,
        imageUrl : null,
        productCount: null,
        maxCategory: null,
        minCategory: null
    }),
    gradeRanges: false,
    defaultImg: "./images/icon-logo-brand-dark.png",
    isInit: false,


    closeModal : function () {
        $("#brandModal").modal("toggle");
        history.pushState({}, null, '#/product');
    },



    onClick : function (e) {
        var brandId = e.currentTarget.attributes['data-brandid'].value;

        brandModal.openModalByBrandId(brandId);
    },


    openModalByObjectId : function (objectId) {
        algolia.brandIndex.getObject(objectId, function (err, content) {
            if (err === null) {
                ux.notify("Loading " + content.name);
                brandModal.openModal(content);
            } else {
                ux.notify("Sorry,  Couldn't locate this brand!");
            }

        });
    },

    openModalByBrandToken : function (token) {

        algolia.brandIndex.search(token, function (err, content) {
            if (err === null) {
                var brand = content.hits[0];
                ux.notify("Loading " + brand.name);
                brandModal.openModal(brand);
            } else {
                ux.notify("Sorry,  Couldn't locate this brand!");
            }

        });
    },

    openModalByBrandId : function (brandId) {

        algolia.brandIndex.search('', {facetFilters : ['brandId:'+brandId]},function (err, content) {
            if (err === null) {
                var brand = content.hits[0];
                ux.notify("Loading " + brand.brandName);
                brandModal.openModal(brand);
            } else {
                ux.notify("Sorry,  Couldn't locate this brand!");
            }

        });
    },

    _findProductsByBrandId: function(brandId){
        algolia.productIndex.search('', {
            facetFilters: ["brandId:" + brandId],
            hitsPerPage: 100
        }, function (err, content) {
            if (err) {
                ux.notify("Error fetching brand products", "error");
                return;
            }
            var productCount = content.nbHits;
            var productList = content.hits;
            var productCountStr = productCount === 1 ? " Product" : " Products";
            brandModal.activeObj.set("productCount", productCount + productCountStr);
            brandModal.updateProductGradeInfo(productList);
            // todo: optimize query

        });
    },

    updateProductGradeInfo: function(productArray) {
        var grades = ux.computeGradeRange(productArray);
        // gradeScore are the same, show the category
        if(grades.max.category === grades.min.category){
            brandModal.gradeRanges = false;
            brandModal.activeObj.set("maxCategory", grades.max.category);
            brandModal.activeObj.set("minCategory", null);

            var categoryStr = grades.max.category;
            brandModal.updateCategory(grades.max.category, "bp-rating-max");

        } else {
            // grade have a range, display the range
            brandModal.gradeRanges = true;
            brandModal.activeObj.set("maxCategory", grades.max.category);
            brandModal.activeObj.set("minCategory", grades.min.category);

            brandModal.updateCategory(grades.max.category, "bp-rating-max");
            brandModal.updateCategory(grades.min.category, "bp-rating-min");
        }

    },

    _updateBrandUrl : function (brandId) {
        var newUrl = '#/product?brandid='+brandId;
        history.pushState({}, null, newUrl);
    },

    updateCategory: function(category, className){
        var categoryStr = category.toLowerCase();

        switch(categoryStr){
            case "best":
                $("." + className + " > .bp-rating").removeClass("bp-best bp-better bp-avoid").addClass("bp-best");
                //brandModal.activeObj.set("ux_allowFav", true);
                break;
            case "better":
                $("." + className + " > .bp-rating").removeClass("bp-best bp-better bp-avoid").addClass("bp-better");
                //brandModal.activeObj.set("ux_allowFav", true);
                break;
            case "avoid":
                $("." + className + " > .bp-rating").removeClass("bp-best bp-better bp-avoid").addClass("bp-avoid");
                //brandModal.activeObj.set("ux_allowFav", false);
                break;
        }
    },

    openModal: function(data){
        if(!brandModal.isInit){
            $('#brandModal-actions > a[data-toggle="tooltip"]').tooltip();
            brandModal.isInit = true;
        }

        if (userView.isStaff() || userView.isBlogger()) {
            $('.bpstaff').removeClass('hidden');

        } else {
            $('.bpstaff').addClass('hidden');
        }

        var categoryString = "Avoid";

        if (data.category === 'Best') {
            categoryString = "Best Choice";
        } else if (data.category === "Better") {
            categoryString = "Better Choice";
        }

        brandModal.activeObj.set('objectId', data.objectID);
        brandModal.activeObj.set("brandId", data.brandId);
        brandModal.activeObj.set("brandName", data.brandName);
        brandModal.activeObj.set("category", data.category);
        brandModal.activeObj.set("gradeScore", data.gradeScore);
        brandModal.activeObj.set("gradeName", data.gradeName);
        brandModal.activeObj.set("brandUrl", data.brandUrl);
        brandModal.activeObj.set("searchUrl", 'https://www.google.com/#q='+data.brandName);

        var isFavorite = favorites.brandCache[data.objectID] !== undefined;

        analyticsModel.sendGAEvent('brand','open', brandModal.activeObj.brandName);

        if(isFavorite){
            $("#brandModal-actions > .fav > i").text("favorite").addClass("favorite");
            $("#brandModal-actions > .fav").data("favorite", true);
        } else {

            $("#brandModal-actions > .fav > i").text("favorite_border").removeClass("favorite");
            $("#brandModal-actions > .fav").data("favorite", false);
        }

        if(data.brandImageUrl !== null){
            brandModal.activeObj.set("brandImageUrl", data.brandImageUrl);
        } else {
            brandModal.activeObj.set("brandImageUrl", null);
        }

        brandModal._updateBrandUrl(data.brandId);
        shareModel.setShare("Buying Poultry", "Check out " + data.name, 'http://www.buyfarmfoward.com/#/product?brandid=' + data.brandId);


        brandModal._findProductsByBrandId(data.brandId);

        $("#brandModal").modal("toggle");
    },

    toggleFav: function(e){
        if(userView.currentUser.Id !== null){

            var fav = $("#brandModal-actions > .fav").data("favorite");

            if(fav){
                $("#brandModal-actions > .fav > i").text("favorite_border").removeClass("favorite");
                $("#brandModal-actions > .fav").data("favorite", false);
                var favObj = favorites.findFavoriteByObjectId(brandModal.activeObj.objectId);
                if (favObj !== undefined && favObj !== null) {
                    favorites.removeFavorite(favObj);
                }
                brandModal.activeObj.set('isFavorite', false);
                analyticsModel.sendGAEvent('brand','unfavorite', brandModal.activeObj.brandName);
            } else {
                $("#brandModal-actions > .fav > i").text("favorite").addClass("favorite");
                $("#brandModal-actions > .fav").data("favorite", true);
                brandModal.activeObj.set('isFavorite', true);
                var fObj = JSON.stringify(brandModal.activeObj);
                fObj = JSON.parse(fObj);
                delete fObj.isFavorite;
                delete fObj.ux_allowFav;

                analyticsModel.sendGAEvent('brand','favorite', brandModal.activeObj.brandName);
                favorites.addFavorite(favorites._brand, brandModal.activeObj.objectId, brandModal.activeObj.brandName,  brandModal.activeObj.brandImageUrl,  fObj );
            }

        } else {
            userView.openSignUp();
        }

    },

    editBrand : function () {
        $("#brandModal").modal("toggle");

        APP.router.navigate('#/brandeditor?brandid=' + brandModal.activeObj.brandId);
    },

    doSendReport : function () {
        ux.notify("Coming Soon", "success");

    }
};

/*

var productEditor = {
    _initialized : false,
    activeObj : new kendo.data.ObservableObject({name: "", imageUrl: "./images/icon-logo-brand-dark.png", brandUrl: null, searchUrl: null}),
    productsDS : null,
    productArray : [],

    init : function () {
        if (!productEditor._initialized) {
            productEditor._initialized = true;

            productEditor.productsDS = new kendo.data.DataSource({
                pageSize: 20,
                schema: {
                    model: {
                        id: "objectID",
                        fields: {
                            objectID: { editable: false, nullable: false },
                            productImage : { editable: true, nullable: true },
                            productName: { validation: { required: true } },
                            gradeName: { validation: { required: true } },
                            gradeScore: { validation: { required: true } },
                            category: {  validation: { required: true } },
                            claims: {   },
                            certifications: { },
                            productCategory: {  validation: { required: true } }
                        }
                    }
                }
            });

            $("#productEditor-grid").kendoGrid({
                dataSource: productEditor.productsDS,
                pageable: true,
                resizable: true,
                reorderable: true,
                height: 560,
                toolbar: ["create"],
                columns: [
                    { field:"productImage", title:"Image", template: '<img class="product-grid-photo" src="#=productImage#" />' },
                    { field:"productName",title:"Name", width: "160px" },
                    { field:"category",title:"Rating", editor: productEditor._categoryEditor},
                    { field:"gradeName",title:"Grade" , editor: productEditor._gradeNameEditor},
                    { field:"gradeScore",title:"Score", editor: productEditor._gradeScoreEditor },
                    { field:"certifications", title:"Certifications", width: "160px", template: function(dataItem) {
                        var html = [];

                        for (var i = 0; i < dataItem.certifications.length; i++) {
                            html.push( dataItem.certifications[i]);
                        }

                        return html.join(', ');
                    }, editor : productEditor._certificationEditor
                    },
                    { field:"claims",title:"Claims",  width: "160px", template: function(dataItem) {
                        var html = [];

                        for (var i = 0; i < dataItem.claims.length; i++) {
                            html.push( dataItem.claims[i]);
                        }

                        return html.join(', ');
                    }, editor : productEditor._claimEditor
                    },
                    { field:"productCategory",title:"Type" , editor: productEditor._typeEditor},
                    { command: "destroy", title: "Actions" }],
                editable: true
            });

        }
    },

    _imageEditor : function (container, options) {

    },

    _certificationEditor : function (container, options) {

        $('<select multiple="multiple" name="certifications" />')
            .appendTo(container).kendoMultiSelect({
                dataSource: labelGuideView._certificationNames,
                value: options.model.certifications
            });
    },

    _claimEditor : function (container, options) {

        $('<select multiple="multiple" name="claims" />')
            .appendTo(container).kendoMultiSelect({
            dataSource: labelGuideView._claimNames,
            value: options.model.claims
        });
    },

    _categoryEditor : function (container, options) {
            $('<input required name="' + options.field + '"/>')
                .appendTo(container)
                .kendoDropDownList({
                    autoBind: false,
                    dataSource: ["Best", "Better", "Avoid"]
                });
    },

    _typeEditor : function (container, options) {
        $('<input required name="' + options.field + '"/>')
            .appendTo(container)
            .kendoDropDownList({
                autoBind: false,
                dataSource: ["Chicken", "Eggs", "Turkey", "Plant-based"]
            });
    },

    _gradeNameEditor : function (container, options) {
        $('<input required name="' + options.field + '"/>')
            .appendTo(container)
            .kendoDropDownList({
                autoBind: false,
                dataSource: ["A", "A-", "+B", "B", "B-", "+C", "C", "-C", "+D", "D", "D-", "F"]
            });
    },

    _gradeScoreEditor : function (container, options) {
        $('<input required name="' + options.field + '"/>')
            .appendTo(container)
            .kendoDropDownList({
                autoBind: false,
                dataSource: ["12", "11", "10", "9", "8", "7", "6", "5", "4", "3", "2", "1"]
            });
    },

    editBrand : function () {
        APP.router.navigate('#/brandeditor?brandid=' + brandModal.activeObj.brandId);
    },

    open : function (brandId) {

        algolia.brandIndex.search('', {facetFilters : ['brandId:'+brandId]}, function (err, content) {
            if (err === null) {
                var brand = content.hits[0];
                ux.notify("Loading " + brand.brandName);
                productEditor.activeObj.set('brandName', brand.brandName);
                productEditor.activeObj.set('brandUrl', brand.brandUrl);
                productEditor.activeObj.set('brandId', brand.brandId);
                if (brand.category === undefined || brand.category === null) {
                    var score = parseInt(brand.gradeScore);
                    var cat = 'Avoid';

                    if (score >= 4){
                        cat = 'Better';
                    }

                    if (score >= 8 ){
                        cat = 'Best';
                    }

                    brand.category = cat;
                }
                productEditor.activeObj.set('category', brand.category);
                productEditor.activeObj.set('gradeScore', brand.gradeScore);
                productEditor.activeObj.set('gradeName', brand.gradeName);
                productEditor.activeObj.set('objectID', brand.objectID);
                productEditor.activeObj.set("searchUrl", 'https://www.google.com/#q='+brand.brandName);
                if (brand.brandImageUrl !== undefined) {
                    productEditor.activeObj.set("brandImageUrl", brand.brandImageUrl);

                } else {
                    productEditor.activeObj.set("brandImageUrl", brandEditor._defaultBrandImageUrl);
                }

            } else {
                ux.notify("Sorry,  Couldn't locate this brand!");
            }

        });

        ux.notify("Looking up products...");
        algolia.productIndex.search('', {facetFilters: ["brandId:" + brandId] }, function searchDone(err, content) {
            if (err) {
               ux.notify("Error fetching products : " + JSON.stringify(err));
                return;
            }

           productEditor.productsDS.data(content.hits);

        });
    }
};*/

/**
 * Created by donbrad on 12/15/16.
 */

var profileView = {
    inited: false,
    templateLoaded : false,
    _template : 'templates/profile.html',

    autocompleteEnabled : false,
    placesDS : new kendo.data.DataSource(),
    newslettersDS : new kendo.data.DataSource(),
  /*  userObj: null,
    donationDS : null,
    pledgeDS: null,*/

    mapData: function (file) {
        var dir = location.origin + '/' + file;
        return(dir);
    },

    init : function () {

        if (!profileView.inited) {
            profileView.inited = true;

         /*   profileView.userObj = userModel.userObj;
            profileView.pledgeDS = pledgeModel.pledgeDS;
            profileView.donationDS = pledgeModel.donationDS;*/

            $('.profile-list >li > a[data-toggle="tab"]').on('shown.bs.tab', function (e) {

                var activeTab = $(e.target);
                var href =  activeTab[0].attributes['href'].value;
                var tabName = href.replace('#profile-', '').capitalize();
                analyticsModel.sendGAEvent("profile", tabName, "PII");

            });

            $("#profile-organizationType").kendoDropDownList({
                clearButton : true,
                dataTextField: "name",
                dataValueField: "slug",
                change : function (e) {
                    var value = this.value();
                    userModel.userObj.set('organizationType', value);
                },
                dataSource: [
                    {name : 'Education', slug: "edu"},
                    {name : 'Government', slug: "gov"},
                    {name : 'Commercial', slug: "com"},
                    {name : 'Non Profit', slug: "np"}
                ]
            });

            $("#profile-organizationRole").kendoDropDownList({
                clearButton : true,
                dataTextField: "name",
                dataValueField: "slug",
                change : function (e) {
                    var value = this.value();
                    userModel.userObj.set('organizationRole', value);
                },

                dataSource: [
                    {name : 'Employee / Staff', slug: "staff"},
                    {name : 'Customer / Student', slug: "student"},
                    {name : 'Professor / Teacher', slug: "teacher"},
                    {name : 'Executive / Management', slug: "management"}
                ]
            });

            $("#profile-phone").kendoMaskedTextBox({
                mask: "(999) 000-0000"
            });


            $("#profile-primaryDiet").kendoDropDownList({
                dataSource : profileView._dietArray,
                dataTextField: "shortDescription",
                dataValueField: "shortDescription",
                clearButton : true
            });

            $("#profile-diningList").kendoMultiSelect({
                clearButton : true,
                tagMode : 'multiple'
            });

            $("#profile-proteinList").kendoMultiSelect({
                clearButton : true,
                tagMode : 'multiple'
            });

            $("#profile-dietRestrictions").kendoMultiSelect({
                clearButton : true,
                dataSource : profileView._allergyArray,
                dataTextField: "shortDescription",
                dataValueField: "shortDescription",
                tagMode : 'multiple'
            });

            $("#profile-favoriteCuisines").kendoMultiSelect({
                dataSource : profileView._cuisineArray,
                dataTextField: "name",
                dataValueField: "name",
                tagMode : 'multiple'
            });

            $("#profile-favoriteFoods").kendoMultiSelect({
                dataSource : profileView._vegetableArray,
                clearButton: true,
                dataTextField: "name",
                dataValueField: "name",
                tagMode : 'multiple'
            });

            $("#profile-avoidFoods").kendoMultiSelect({
                dataSource : profileView._vegetableArray,
                clearButton: true,
                dataTextField: "name",
                dataValueField: "name",
                tagMode : 'multiple'
            });

            var el = document.getElementById('profile-address');
            profileView.autocomplete = new google.maps.places.Autocomplete(el);

            profileView.autocomplete.addListener('place_changed', function() {

                var place = profileView.autocomplete.getPlace();
                mapModel.processPlace(place);
                var user = userModel.userObj;
                var geoData = mapModel.activeObj;
                user.set('lat', geoData.lat);
                user.set('lng', geoData.lng);
                user.set('address', geoData.address);
                user.set('zipcode', geoData.ziplong);
                user.set('county', geoData.county);
                user.set('state', geoData.state);
                user.set('country', geoData.country);

                if (!place.geometry) {
                    // User entered the name of a Place that was not suggested and
                    // pressed the Enter key, or the Place Details request failed.
                    ux.notify("No details available for input: '" + place.name + "'", 'error');

                }
            });

            $("#profile-email").on("blur", function(e){
                var email = $('#profile-email').val();
                var emailValidation = profileView.verifyEmailUI(email);
                if(!emailValidation){
                    profileView.verifyOnKeyUp();
                }
            });
/*
            $("#profile-newsletter-grid").kendoGrid({
                dataSource: profileView.newslettersDS,
                pageSize : 12,
                autoBind: false,
                pageable: true,
                resizable: true,
                sortable: true,
                reorderable: true,
                selectable: true,
                batch: true,
                height: 580,
                columns: [
                    { field:"groupName",title:"Group", width: "220px" },
                    { field:"interestName",title:"Interest", width: "220px" }
                ]
            });*/

            $("#profile-donation-table").kendoListView({
                dataSource: userDonation.donationDS,
              //  autoBind: false,
                template: kendo.template($("#profile-donation-tmpl").html())
            });

            $("#profile-pledge-table").kendoListView({
                dataSource: userPledge.pledgeDS,
          //      autoBind: false,
                template: kendo.template($("#profile-pledge-tmpl").html())
            });

            $("#profile-newsletter-table").kendoListView({
                dataSource: profileView.newslettersDS,
                autoBind: false,
                template: kendo.template($("#profile-newsletter-tmpl").html())
            });


            var tab1 = $(".profile-impact-donation");

            $(".profile-impact-tabs").kendoTabStrip({
                animation: false
            }).data("kendoTabStrip").activateTab(tab1);



          /*  $(window).on(ghEvent.mailchimpLoaded, function () {
                profileView.updateNewslettersDS();
            });
*/

            $(window).on(ghEvent.userdonationLoaded , function () {
                profileView.updateDonation();
            });

            $(window).on(ghEvent.userpledgeLoaded , function () {
                profileView.updatePledge();
            });


            /*kendo.bind($("#profile-donation-row"), userDonation.donationDS);
            kendo.bind($("#profile-pledge-row"), userPledge.pledgeDS);*/
        }
    },

    updateNewslettersDS : function () {

        profileView.newslettersDS.data([]);

        var newsletters = userModel.userObj.mcGroups;

        if(newsletters !== undefined){
            var count = newsletters.length;

            if (!count)
                return;

            for (var i=0; i<count; i++) {
                var interestId = newsletters[i];

                var newsletter = mcGroupModel.findByInterestId(interestId);

                if (newsletter !== null) {
                    profileView.newslettersDS.add(newsletter);
                }

            }
        }


    },

    verifyOnKeyUp: function() {
      $("#profile-email").off().on("keyup", function(){
          var email = $('#profile-email').val();
          profileView.verifyEmailUI(email);
      });
    },

    verifyEmailUI: function(email){
        var result = ux.validateEmail(email);
        if (result) {
            $(".profile-section-email").removeClass('has-error').addClass("has-success has-feedback");
            $(".profile-section-email > .help-block").text("");
            //$(".profile-section-email > .form-control-feedback i").text("check");
            $("#profileView-save").attr("disabled", false);
            return (true);
        } else {
            $(".profile-section-email").addClass('has-error').removeClass("has-success");
            //$(".profile-section-email > .form-control-feedback i").text("close");
            $(".profile-section-email > .help-block").text("Invalid email address");
            $("#profileView-save").attr("disabled", true);
            return (false);
        }
    },

    initProfile : function () {
        $('.ghp-name').addClass('hidden');
        $('.ghp-email').addClass('hidden');
        $('.ghp-address').addClass('hidden');
        $('.ghp-phone').addClass('hidden');
        $('.ghp-diet').addClass('hidden');
        $('.ghp-organization').addClass('hidden');
        $('.ghp-experiments').addClass('hidden');
        $('.ghp-newletters').addClass('hidden');
        $('.ghp-impact').addClass('hidden');
    },

    setupSiteProfile : function () {

        profileView.initProfile();

        var profileList = APP.profileFields;

        if (siteModel.currentSite !== null && siteModel.currentSite.profileFields.length > 0) {
            profileList = siteModel.currentSite.profileFields;
        }

        for (var i=0; i< profileList.length; i++) {
            var selector = '.ghp-' + profileList[i];

            $(selector).removeClass('hidden');
        }
    },


    updateDonation : function () {
        if (userDonation.donationDS.total()) {
            $('#profile-donations-list').removeClass('hidden');
            $('#profile-donations-empty').addClass('hidden');
            //userDonation.donationDS.read();
         //   $("#profile-donation-table").data("kendoListView").refresh();
        } else {
            $('#profile-donations-list').addClass('hidden');
            $('#profile-donations-empty').removeClass('hidden');
        }

    },

    updatePledge : function () {
        if (userPledge.pledgeDS.total()) {
            $('#profile-pledges-list').removeClass('hidden');
            $('#profile-pledges-empty').addClass('hidden');
          //  userPledge.pledgeDS.read();
         //   $("#profile-pledge-table").data("kendoListView").refresh();
        } else {
            $('#profile-pledges-list').addClass('hidden');
            $('#profile-pledges-empty').removeClass('hidden');
        }

    },

    readData : function () {
       profileView.updateNewslettersDS();
    },


    openProfile : function () {
        analyticsModel.sendGAEvent("profile", "open", "PII");

        profileView.init();

        profileView.setupSiteProfile();

        profileView.readData();

        if (userDonation.userDonationsLoaded) {
            profileView.updateDonation();
        } else {
            $(window).on(ghEvent.userdonationLoaded, function () {
                profileView.updateDonation();
            });
        }

        if (userPledge.userPledgesLoaded) {
            profileView.updatePledge();
        } else {
            $(window).on(ghEvent.userpledgeLoaded, function () {
                profileView.updatePledge();
            });
        }

        $('.profile-list a[href="#profile-account"]').tab('show');

        if (linkedinModel.connected) {
            $('#linkedin-connected').removeClass('hidden');
        }

        if (userModel.isFBSignedIn()) {
            $('#facebook-connected').removeClass('hidden');
            $('#facebook-connected-btn').addClass('hidden');
        }

         // Display the users social profile image if we have one
       // if (userView.source !== 'Buying Poultry' && userView.photoUrl !== null) {
         if (userView.photoUrl !== undefined && userView.photoUrl !== null) {
             $('#profile-image > img').attr("src", userView.photoUrl);
         } else {
             $('#profile-image > img').attr("src", "images/icon-defaultProduct.png");
         }

         var sourceStr = "<span>" + userModel.userObj.email + "</span>";

         switch (userView.source) {
             case userView._google:
                 sourceStr = '<i class="fa fa-google-plus"></i> Google';
                 break;

             case userView._facebook:
                 sourceStr = '<i class="fa fa-facebook-f"></i> Facebook';
                 break;

             case userView._twitter:
                 sourceStr = ' <i class="fa fa-twitter"></i> Twitter';
                 break;

             case userView._liveid:
                 sourceStr = ' <i class="fa fa-windows"></i> Live Id';
                 break;
         }


        userModel.userObj.set("socialId", sourceStr);

    },

    closeProfile : function(){
   //     $("#modal-profile").modal("toggle");
    },

    locateMe : function () {
        mapModel.getUserLocation(function (geoData) {

            if (geoData !== null) {
                var user = userModel.userObj;

                user.set('lat', geoData.lat);
                user.set('lng', geoData.lng);
                user.set('address', geoData.address);
                user.set('zipcode', geoData.zipcode);
                user.set('county', geoData.county);
                user.set('state', geoData.state);
                user.set('country', geoData.country);

            }
        });
    },

    doSignOut : function () {
        userView.signOut();
        APP.router.navigate("#/");
    },

    gotoProfile : function () {
        if(ux.isBSMobile()){
            ux.closeMobileMenu("#mainMenu")
        }
        APP.router.navigate("#/profile");
        analyticsModel.sendGAEvent("profile", "open", "PII");
    },

    gotoFavorites : function () {
        APP.router.navigate("#/favorites");
        analyticsModel.sendGAEvent("favorites", "open", "PII");
      //  ux.notify("Coming Soon !", 'success');
    },

    doDietQuiz : function () {
        ux.notify("Coming Soon !", 'success');
    },

    linkToFacebook : function () {
        FB.login(function (response) {
            analyticsModel.sendGAEvent("authentication", "connectViaFacebook", "PII");
            if (response.authResponse) {
                FB.api('/me', function(meData) {

                });
            }
        });
    },

    linkToTwitter : function () {
        ux.notify("Coming Soon !", 'success');
    },

    linkToLinkdedIn: function () {
        linkedinModel.signIn();
    },


    uploadProfilePhoto : function () {
        ux.notify("Coming Soon !", 'success');
    },

    updateBio : function () {
        ux.notify("Coming Soon !", 'success');
    },

    doStaffProfile : function () {
        ux.notify("Coming Soon !", 'success');
    },

    doSave : function () {
        var user = userModel.userObj;

       /* var name = $('#profile-name').val();
        var email = $('#profile-email').val();
        var zipcode = $('#profile-zipcode').val();
        var address = $('#profile-address').val();
        user.name = name;
        user.email = email;
        user.zipcode = zipcode;
        user.address = address;*/

        userView.updateUserInfo();


       /* APP.everlive.Users.updateSingle(user,
            function(data){
                //console.log(JSON.stringify(data));
                userView.updateUserInfo();
                //profileView.closeProfile();
               // $("#modal-profile").modal("toggle");
                ux.notify("Your profile was updated.", "success");
                analyticsModel.sendGAEvent("profile", "update", "PII");
            },
            function(error){
                ux.notify("Error saving your profile: " + JSON.stringify(error) , "error");
                analyticsModel.sendGAEvent("profile", "error", JSON.stringify(error));
            });
*/
    },

/*
    deleteFavorite : function (e) {
        var objectId = e.target.dataset.objectid;
        var fav = favorites.findFavoriteByObjectId(objectId);


        if (fav !== undefined && fav !== null) {
            ux.notify (fav.objectName + " removed from Favorites", "success");
            analyticsModel.sendGAEvent("favorite", "delete", fav.objectName);
            favorites.removeFavorite(fav);

        }

    },

    showFavorites: function(e){
        var section = e.target.dataset.section;
        $("#profile-favorites-menu > li > button").removeClass("active");
        $(e.target).addClass("active");
        $(".profile-favorites").addClass("hidden");
        $(".profile-favorites-" + section).removeClass("hidden");

    },*/

    _dietArray : [
        {
            "id": "0",
            "shortDescription": "Omnivore",
            "longDescription": "Omnivore",
            "searchValue": "0^Omnivore",
            "type": "diet",
            "localesAvailableIn": [
                "en-US"
            ]
        },
        {
            "id": "388",
            "shortDescription": "Lacto vegetarian",
            "longDescription": "Lacto vegetarian",
            "searchValue": "388^Lacto vegetarian",
            "type": "diet",
            "localesAvailableIn": [
                "en-US"
            ]
        },
        {
            "id": "389",
            "shortDescription": "Ovo vegetarian",
            "longDescription": "Ovo vegetarian",
            "searchValue": "389^Ovo vegetarian",
            "type": "diet",
            "localesAvailableIn": [
                "en-US"
            ]
        },
        {
            "id": "390",
            "shortDescription": "Pescetarian",
            "longDescription": "Pescetarian",
            "searchValue": "390^Pescetarian",
            "type": "diet",
            "localesAvailableIn": [
                "en-US"
            ]
        },
        {
            "id": "386",
            "shortDescription": "Vegan",
            "longDescription": "Vegan",
            "searchValue": "386^Vegan",
            "type": "diet",
            "localesAvailableIn": [
                "en-US"
            ]
        },
        {
            "id": "387",
            "shortDescription": "Vegetarian",
            "longDescription": "Lacto-ovoVegetarian",
            "searchValue": "387^Lacto-ovo vegetarian",
            "type": "diet",
            "localesAvailableIn": [
                "en-US"
            ]
        },
        {
            "id": "403",
            "shortDescription": "Paleo",
            "longDescription": "Paleo",
            "searchValue": "403^Paleo",
            "type": "diet",
            "localesAvailableIn": [
                "en-US"
            ]
        }
    ],
    _cuisineArray : [
        {
            "id": "cuisine-american",
            "name": "American",
            "type": "cuisine",
            "description": "American",
            "searchValue": "cuisine^cuisine-american",
            "localesAvailableIn": [
                "en-US"
            ]
        },
        {
            "id": "cuisine-kid-friendly",
            "name": "Kid-Friendly",
            "type": "cuisine",
            "description": "Kid-Friendly",
            "searchValue": "cuisine^cuisine-kid-friendly",
            "localesAvailableIn": [
                "en-US"
            ]
        },
        {
            "id": "cuisine-italian",
            "name": "Italian",
            "type": "cuisine",
            "description": "Italian",
            "searchValue": "cuisine^cuisine-italian",
            "localesAvailableIn": [
                "en-US"
            ]
        },
        {
            "id": "cuisine-asian",
            "name": "Asian",
            "type": "cuisine",
            "description": "Asian",
            "searchValue": "cuisine^cuisine-asian",
            "localesAvailableIn": [
                "en-US"
            ]
        },
        {
            "id": "cuisine-mexican",
            "name": "Mexican",
            "type": "cuisine",
            "description": "Mexican",
            "searchValue": "cuisine^cuisine-mexican",
            "localesAvailableIn": [
                "en-US"
            ]
        },
        {
            "id": "cuisine-southern",
            "name": "Southern & Soul Food",
            "type": "cuisine",
            "description": "Southern & Soul Food",
            "searchValue": "cuisine^cuisine-southern",
            "localesAvailableIn": [
                "en-US"
            ]
        },
        {
            "id": "cuisine-french",
            "name": "French",
            "type": "cuisine",
            "description": "French",
            "searchValue": "cuisine^cuisine-french",
            "localesAvailableIn": [
                "en-US"
            ]
        },
        {
            "id": "cuisine-southwestern",
            "name": "Southwestern",
            "type": "cuisine",
            "description": "Southwestern",
            "searchValue": "cuisine^cuisine-southwestern",
            "localesAvailableIn": [
                "en-US"
            ]
        },
        {
            "id": "cuisine-barbecue-bbq",
            "name": "Barbecue",
            "type": "cuisine",
            "description": "Barbecue",
            "searchValue": "cuisine^cuisine-barbecue-bbq",
            "localesAvailableIn": [
                "en-US"
            ]
        },
        {
            "id": "cuisine-indian",
            "name": "Indian",
            "type": "cuisine",
            "description": "Indian",
            "searchValue": "cuisine^cuisine-indian",
            "localesAvailableIn": [
                "en-US"
            ]
        },
        {
            "id": "cuisine-chinese",
            "name": "Chinese",
            "type": "cuisine",
            "description": "Chinese",
            "searchValue": "cuisine^cuisine-chinese",
            "localesAvailableIn": [
                "en-US"
            ]
        },
        {
            "id": "cuisine-cajun",
            "name": "Cajun & Creole",
            "type": "cuisine",
            "description": "Cajun & Creole",
            "searchValue": "cuisine^cuisine-cajun",
            "localesAvailableIn": [
                "en-US"
            ]
        },
        {
            "id": "cuisine-mediterranean",
            "name": "Mediterranean",
            "type": "cuisine",
            "description": "Mediterranean",
            "searchValue": "cuisine^cuisine-mediterranean",
            "localesAvailableIn": [
                "en-US"
            ]
        },
        {
            "id": "cuisine-greek",
            "name": "Greek",
            "type": "cuisine",
            "description": "Greek",
            "searchValue": "cuisine^cuisine-greek",
            "localesAvailableIn": [
                "en-US"
            ]
        },
        {
            "id": "cuisine-english",
            "name": "English",
            "type": "cuisine",
            "description": "English",
            "searchValue": "cuisine^cuisine-english",
            "localesAvailableIn": [
                "en-US"
            ]
        },
        {
            "id": "cuisine-spanish",
            "name": "Spanish",
            "type": "cuisine",
            "description": "Spanish",
            "searchValue": "cuisine^cuisine-spanish",
            "localesAvailableIn": [
                "en-US"
            ]
        },
        {
            "id": "cuisine-thai",
            "name": "Thai",
            "type": "cuisine",
            "description": "Thai",
            "searchValue": "cuisine^cuisine-thai",
            "localesAvailableIn": [
                "en-US"
            ]
        },
        {
            "id": "cuisine-german",
            "name": "German",
            "type": "cuisine",
            "description": "German",
            "searchValue": "cuisine^cuisine-german",
            "localesAvailableIn": [
                "en-US"
            ]
        },
        {
            "id": "cuisine-moroccan",
            "name": "Moroccan",
            "type": "cuisine",
            "description": "Moroccan",
            "searchValue": "cuisine^cuisine-moroccan",
            "localesAvailableIn": [
                "en-US"
            ]
        },
        {
            "id": "cuisine-irish",
            "name": "Irish",
            "type": "cuisine",
            "description": "Irish",
            "searchValue": "cuisine^cuisine-irish",
            "localesAvailableIn": [
                "en-US"
            ]
        },
        {
            "id": "cuisine-japanese",
            "name": "Japanese",
            "type": "cuisine",
            "description": "Japanese",
            "searchValue": "cuisine^cuisine-japanese",
            "localesAvailableIn": [
                "en-US"
            ]
        },
        {
            "id": "cuisine-cuban",
            "name": "Cuban",
            "type": "cuisine",
            "description": "Cuban",
            "searchValue": "cuisine^cuisine-cuban",
            "localesAvailableIn": [
                "en-US"
            ]
        },
        {
            "id": "cuisine-hawaiian",
            "name": "Hawaiian",
            "type": "cuisine",
            "description": "Hawaiian",
            "searchValue": "cuisine^cuisine-hawaiian",
            "localesAvailableIn": [
                "en-US"
            ]
        },
        {
            "id": "cuisine-swedish",
            "name": "Swedish",
            "type": "cuisine",
            "description": "Swedish",
            "searchValue": "cuisine^cuisine-swedish",
            "localesAvailableIn": [
                "en-US"
            ]
        },
        {
            "id": "cuisine-portuguese",
            "name": "Portuguese",
            "type": "cuisine",
            "description": "Portuguese",
            "searchValue": "cuisine^cuisine-portuguese",
            "localesAvailableIn": [
                "en-US"
            ]
        },
        {
            "id": "cuisine-hungarian",
            "name": "Hungarian",
            "type": "cuisine",
            "description": "Hungarian",
            "searchValue": "cuisine^cuisine-hungarian",
            "localesAvailableIn": [
                "en-US"
            ]
        }
    ],

    _allergyArray : [
        {
            "id": "393",
            "shortDescription": "Gluten-Free",
            "longDescription": "Gluten-Free",
            "searchValue": "393^Gluten-Free",
            "type": "allergy",
            "localesAvailableIn": [
                "en-US"
            ]
        },
        {
            "id": "394",
            "shortDescription": "Peanut-Free",
            "longDescription": "Peanut-Free",
            "searchValue": "394^Peanut-Free",
            "type": "allergy",
            "localesAvailableIn": [
                "en-US"
            ]
        },
        {
            "id": "398",
            "shortDescription": "Seafood-Free",
            "longDescription": "Seafood-Free",
            "searchValue": "398^Seafood-Free",
            "type": "allergy",
            "localesAvailableIn": [
                "en-US"
            ]
        },
        {
            "id": "399",
            "shortDescription": "Sesame-Free",
            "longDescription": "Sesame-Free",
            "searchValue": "399^Sesame-Free",
            "type": "allergy",
            "localesAvailableIn": [
                "en-US"
            ]
        },
        {
            "id": "400",
            "shortDescription": "Soy-Free",
            "longDescription": "Soy-Free",
            "searchValue": "400^Soy-Free",
            "type": "allergy",
            "localesAvailableIn": [
                "en-US"
            ]
        },
        {
            "id": "396",
            "shortDescription": "Dairy-Free",
            "longDescription": "Dairy-Free",
            "searchValue": "396^Dairy-Free",
            "type": "allergy",
            "localesAvailableIn": [
                "en-US"
            ]
        },
        {
            "id": "397",
            "shortDescription": "Egg-Free",
            "longDescription": "Egg-Free",
            "searchValue": "397^Egg-Free",
            "type": "allergy",
            "localesAvailableIn": [
                "en-US"
            ]
        },
        {
            "id": "401",
            "shortDescription": "Sulfite-Free",
            "longDescription": "Sulfite-Free",
            "searchValue": "401^Sulfite-Free",
            "type": "allergy",
            "localesAvailableIn": [
                "en-US"
            ]
        },
        {
            "id": "395",
            "shortDescription": "Tree Nut-Free",
            "longDescription": "Tree Nut-Free",
            "searchValue": "395^Tree Nut-Free",
            "type": "allergy",
            "localesAvailableIn": [
                "en-US"
            ]
        },
        {
            "id": "392",
            "shortDescription": "Wheat-Free",
            "longDescription": "Wheat-Free",
            "searchValue": "392^Wheat-Free",
            "type": "allergy",
            "localesAvailableIn": [
                "en-US"
            ]
        }
    ],

    _vegetableArray : [
        {"name" : "acorn squash"},
        {"name" : "alfalfa sprout"},
        {"name" : "amaranth"},
        {"name" : "anise"},
        {"name" : "artichoke"},
        {"name" : "arugula"},
        {"name" : "asparagus"},
        {"name" : "aubergine"},
        {"name" : "azuki bean"},
        {"name" : "banana squash"},
        {"name" : "basil"},
        {"name" : "bean sprout"},
        {"name" : "beet"},
        {"name" : "black bean"},
        {"name" : "black-eyed pea"},
        {"name" : "bok choy"},
        {"name" : "borlotti bean"},
        {"name" : "broad beans"},
        {"name" : "broccoflower"},
        {"name" : "broccoli"},
        {"name" : "brussels sprout"},
        {"name" : "butternut squash"},
        {"name" : "cabbage"},
        {"name" : "calabrese"},
        {"name" : "caraway"},
        {"name" : "carrot"},
        {"name" : "cauliflower"},
        {"name" : "cayenne pepper"},
        {"name" : "celeriac"},
        {"name" : "celery"},
        {"name" : "chamomile"},
        {"name" : "chard"},
        {"name" : "chayote"},
        {"name" : "chickpea"},
        {"name" : "chives"},
        {"name" : "cilantro"},
        {"name" : "collard green"},
        {"name" : "corn"},
        {"name" : "corn salad"},
        {"name" : "courgette"},
        {"name" : "cucumber"},
        {"name" : "daikon"},
        {"name" : "delicata"},
        {"name" : "dill"},
        {"name" : "eggplant"},
        {"name" : "endive"},
        {"name" : "fennel"},
        {"name" : "fiddlehead"},
        {"name" : "frisee"},
        {"name" : "garlic"},
        {"name" : "gem squash"},
        {"name" : "ginger"},
        {"name" : "green bean"},
        {"name" : "green pepper"},
        {"name" : "habanero"},
        {"name" : "herbs and spice"},
        {"name" : "horseradish"},
        {"name" : "hubbard squash"},
        {"name" : "jalapeno"},
        {"name" : "jerusalem artichoke"},
        {"name" : "jicama"},
        {"name" : "kale"},
        {"name" : "kidney bean"},
        {"name" : "kohlrabi"},
        {"name" : "lavender"},
        {"name" : "leek "},
        {"name" : "legume"},
        {"name" : "lemon grass"},
        {"name" : "lentils"},
        {"name" : "lettuce"},
        {"name" : "lima bean"},
        {"name" : "mamey"},
        {"name" : "mangetout"},
        {"name" : "marjoram"},
        {"name" : "mung bean"},
        {"name" : "mushroom"},
        {"name" : "mustard green"},
        {"name" : "navy bean"},
        {"name" : "new zealand spinach"},
        {"name" : "nopale"},
        {"name" : "okra"},
        {"name" : "onion"},
        {"name" : "oregano"},
        {"name" : "paprika"},
        {"name" : "parsley"},
        {"name" : "parsnip"},
        {"name" : "patty pan"},
        {"name" : "pea"},
        {"name" : "pinto bean"},
        {"name" : "potato"},
        {"name" : "pumpkin"},
        {"name" : "radicchio"},
        {"name" : "radish"},
        {"name" : "rhubarb"},
        {"name" : "rosemary"},
        {"name" : "runner bean"},
        {"name" : "rutabaga"},
        {"name" : "sage"},
        {"name" : "scallion"},
        {"name" : "shallot"},
        {"name" : "skirret"},
        {"name" : "snap pea"},
        {"name" : "soy bean"},
        {"name" : "spaghetti squash"},
        {"name" : "spinach"},
        {"name" : "squash "},
        {"name" : "sweet potato"},
        {"name" : "tabasco pepper"},
        {"name" : "taro"},
        {"name" : "tat soi"},
        {"name" : "thyme"},
        {"name" : "tomato"},
        {"name" : "topinambur"},
        {"name" : "tubers"},
        {"name" : "turnip"},
        {"name" : "wasabi"},
        {"name" : "water chestnut"},
        {"name" : "watercress"},
        {"name" : "white radish"},
        {"name" : "yam"},
        {"name" : "zucchini"}
    ]

};
'use strict';

var retailEditor = {

    activeObj: new kendo.data.ObservableObject({
        name: null,
        category : 'Avoid',
        gradeName : null,
        gradeScore : null,
        productCategories : [],
        retailerType : "National",
        brandList: [],
        brandIdList : [],
        objectID : null,
        website : null,
        searchUrl : null,
        storeFinderUrl : null,
        weeklyAdUrl : null,
        imageUrl : null

    }),

    initialized : false,

    _everliveClass : 'retailer',

    brandsDS : new kendo.data.DataSource({pageSize : 10}),

    brandRefDS : new kendo.data.DataSource(),

    brandsHash : [],

    editMode : false,

    _uploadWidget : null,

    _cloudinary : { cloud_name: 'hyjvcxzjt', upload_preset: 'bpretail', client_allowed_formats : ["png","gif", "jpeg"]  },

    _defaultImageUrl : 'http://res.cloudinary.com/hyjvcxzjt/image/upload/v1483036299/product/icon-defaultProduct.png',

    isInit: false,


    init : function () {
        if (!retailEditor.initialized) {
            retailEditor.initialized = true;

            retailEditor.activeObj.bind("change", function(e) {
                if (e.field === 'name') {
                    var url = "http://www.google.com/#q=" + retailEditor.activeObj.name;
                    retailEditor.activeObj.set('searchUrl', url);
                    var name = retailEditor.activeObj.name;
                    var slug = ux.createSlug(name);
                    retailEditor.activeObj.set('slug', slug);
                    retailEditor.findName(name);
                }
            });


            $("#retailEditor-retailerType").kendoDropDownList({
                dataSource : ["National", "Regional", "Local"],
                change: function(e) {
                    var value = this.value();
                    retailEditor.updateUX(value);
                }
            });

            $("#retailEditor-regionStates").kendoMultiSelect({
                dataSource : new kendo.data.DataSource({
                    transport: {
                        read: {
                            url: "data/usstates.json",
                            dataType: "json"
                        }
                    }
                }),
                value : retailEditor.activeObj.regionStatesList,
                dataTextField: "name",
                dataValueField: "name"

            });

            $("#retailEditor-storeBrands").kendoMultiSelect({
                dataTextField: "brandName",
                dataValueField: "brandId",
                itemTemplate: '<span class="k-state-default" style="background-image: url(\'#=data.brandImageUrl#\')"></span>' +
                '<span class="k-state-default"><h3>#: data.brandName #</h3><p><strong> #: data.category #   #: data.gradeName #</strong></p></span>',
                tagTemplate:  '<span class="selected-value" style="background-image: url(\'#=data.brandImageUrl#\')"></span><span>#:data.brandName#</span>',
                dataSource: retailEditor.brandsDS,
                value : retailEditor.activeObj.brandList,
                height: 400
            });

            $('#retailEditor-facebookId').change( function () {
                var url = $('#retailEditor-facebookId').val();

                var validId = ux.urlToId(url);

                $('#retailEditor-facebookId').val(url);

            });


            $('#retailEditor-gradeScore').change( function () {
                var score = $('#retailEditor-gradeScore').val();

                var rating = ux.computeRating(score);

                retailEditor.activeObj.set('gradeName', rating.gradeName);
                retailEditor.activeObj.set('category', rating.category);

                var categoryStr = rating.category.toLowerCase();
                switch(categoryStr){
                    case "best":
                        $("#retailEditor-retailer .bp-rating").removeClass("bp-best bp-better bp-avoid").addClass("bp-best");
                        break;
                    case "better":
                        $("#retailEditor-retailer .bp-rating").removeClass("bp-best bp-better bp-avoid").addClass("bp-better");
                        break;
                    case "avoid":
                        $("#retailEditor-retailer .bp-rating").removeClass("bp-best bp-better bp-avoid").addClass("bp-avoid");
                        break;
                }
            });


            $('#retail-search-input').autocomplete(
                {hint: false}, [
                    {
                        source: $.fn.autocomplete.sources.hits(algolia.brandIndex, {hitsPerPage: 12 }),
                        displayKey: 'brandName',
                        templates: {
                            //'suggestion' templating function used to render a single suggestion
                            suggestion: function(suggestion) {

                                var itemHtml = null;
                                var objectId = JSON.stringify(suggestion.brandId);

                                if (retailEditor.brandsHash[objectId] === undefined) {
                                    // Only display results that aren't aleady in the list...
                                    itemHtml = '<div onclick="retailEditor.addBrand(event)" data-brandId="' + objectId +
                                        '" data-brandName="' + suggestion.brandName +'"><span>' + '<i class="material-icons">add</i>  ' +
                                        suggestion._highlightResult.brandName.value + '</span><span style="float: right;">' +
                                        suggestion.category+ '</span></div> <div style="clear:both;"></div>';

                                } else {
                                    itemHtml = '<div data-brandId="' + objectId +
                                        '" data.brandName="' + suggestion.brandName +'"><span>' + '<i class="material-icons">done</i>  ' +
                                        suggestion._highlightResult.brandName.value + '</span><span style="float: right;">' +
                                        suggestion.category + '</span></div> <div style="clear:both;"></div>';

                                }

                                return itemHtml;

                            }
                        }
                    }
                ]);

           /* $('#retail-search-input').addClear({
                top: 13, right: 36,
                onClear : function () {
                    retailEditor.brandsDS.filter({});
                }
            });*/

            $('#retail-search-input').keyup(function () {
                var val =  $('#retail-search-input').val();

                if (val.length > 0) {
                    retailEditor.brandsDS.filter({field: 'brandName', operator: 'contains', value: val});
                } else {
                    retailEditor.brandsDS.filter({});
                }

            });

            $('[data-toggle="tooltip"]').tooltip();


            $("#retailEditor-brandGrid").kendoGrid({
                pageSize: 10,
                dataSource: retailEditor.brandsDS,
                pageable: true,
                resizable: true,
                sortable: true,
                reorderable: true,
                editable: { //disables the deletion functionality
                    update: false,
                    destroy: true
                },
                edit : function (e) {
                    var item = e.model;
                    var addItemFlag = e.model.isNew();

                    if (addItemFlag) {
                        retailEditor.clearSearch();
                    }
                },
                remove: function(e) {
                    var item = e.model;
                    var id = item.Id;
                    var retailObj = retailEditor.activeObj;
                    for (var i=0; i<retailObj.brandIdList.length; i++) {
                        if (id === retailObj.brandIdList[i]) {
                            retailObj.brandIdList.splice(i,1);
                            retailObj.brandList.splice(i,1);
                        }
                    }
                },
                height: 560,
                columns: [
 /*                   { field:"brandImageUrl", title:"Image", template: '<div class="grid-image-container"> <img class="grid-image-img" src="#=brandImageUrl#" /> </div>', width: 96},
 */                 { field:"brandName",title:"Name", width: 240 },
                    { field:"brandId",title:"Id", width: 60 },
                    { field:"category", title:"Rating", width: 60},
                    { field:"gradeName",title:"Grade" ,  width: 60},
                    { field:"gradeScore",title:"Score",  width: 60 },
                    { field:"productCategory",title:"Type",  width: 60 },
                    { command: [{name: "destroy", text: "Delete"}, {text: "Search", click: retailEditor.doBrandSearch }],  width: 120 }
                ]
            });

        }

    },

    clearSearch : function () {
        $('#retail-search-input').val('');
        retailEditor.brandsDS.filter({});
    },


    doBrandSearch : function () {
        e.preventDefault();

        var dataItem = this.dataItem($(e.currentTarget).closest("tr"));

        var url = "https://www.google.com/#q=" + dataItem.brandName;

        window.open(url, "_blank");
    },

    openModalByObjectId : function (objectId) {
        algolia.retailerIndex.getObject(objectId, function (err, content) {
            if (err === null) {
                ux.notify("Loading " + content.name);
                retailEditor.openModal(content);
            } else {
                ux.notify("Sorry,  Couldn't locate this brand!");
            }

        });
    },

    openModalByRetailerId : function (retailerId) {

        algolia.retailerIndex.getObject(retailerId, function (err, content) {
            if (err === null) {
                var retailer = content;
                ux.notify("Loading " + retailer.name);
                retailEditor.openModal(retailer);
            } else {
                ux.notify("Sorry,  Couldn't locate this retailer!");
            }

        });
    },

    openModalAdd : function () {
        var data = {
            mode: 'add',
            name: null,
            slug : null,
            category : 'Avoid',
            gradeName : 'F',
            gradeScore : 0,
            retailerType : "National",
            retailerId : null,
            brandList : [],
            brandIdList : [],
            objectID : null,
            Id : null,
            website : null,
            facebookId : null,
            weeklyAdUrl : null,
            storeLocatorUrl : null,
            address : null,
            regionStatesList : [],
            imageUrl : null

        };

        var guid = uuid.v4();
        // All new brands have a uuid rather than a simple integer
        data.Id = guid;
        data.objectID = guid;
        data.retailerId = guid;

        retailEditor.brandsHash  = []
        retailEditor.brandsDS.data([]);

        everlive.createOne('retailer', data, function (err, data) {
            if (err !== null) {
                ux.notify("Error creating retailer : " + JSON.stringify(err),'error');
                console.err('*** Retailer create error *** ' + JSON.stringify(err));
            } else {
                ux.notify("New retailer created...",'success');
                retailEditor.openModal(data);
            }
        });
    },

    _updateRetailUrl : function (retailerId) {
        var newUrl = '#/retaileditor?retailerid='+retailerId;
        history.pushState({}, null, newUrl);
    },

    checkImageStore : function () {
        var url = retailEditor.activeObj.imageUrl;

        if (url === undefined || url === null) {
            retailEditor.activeObj.set('imageUrl', retailEditor._defaultImageUrl);
            return;
        }

        if (url.indexOf('blob.core') !== -1) {
            ux.notify('Migrating Azure Image to BP Cloud', 'success');
        }
    },


    replaceImage : function () {
        var publicId = retailEditor.activeObj.retailerId;

        ux.notify("Deleting current image from cloud ...", 'success');

        retailEditor._deletePhoto(publicId, function (status) {

            if (!status) {
                ux.notify("Error deleting current image from cloud ...", 'error');
                return;
            }

            cloudinary.openUploadWidget({ cloud_name: 'hyjvcxzjt', upload_preset: 'bpretailer', public_id: publicId , client_allowed_formats : ["png","gif", "jpeg"]  },
                function(error, result) {

                    if (error === null && result.length > 0) {
                        var photo = result[0];
                        retailEditor.activeObj.set('imageUrl', photo.secure_url);

                        var retailObj = retailEditor.activeObj;
                        retailObj.dirty = true;
                        everlive.updateOne('retailer', retailObj, function (err, data) {
                            retailEditor._updateIndex(retailObj.retailerId, function (status) {
                                if (status) {
                                    ux.notify("Updated retailer photo ", 'success');
                                }
                            });
                            // Call the index update function...
                        });
                    }
                });
        });

    },

    updateUX : function (retailType) {

        switch (retailType) {

            case "National":
                $("#retailEditor-regionStates-li").addClass('hidden');
                $("#retailEditor-address-li").addClass('hidden');
                break;

            case "Regional":
                $("#retailEditor-regionStates-li").removeClass('hidden');
                $("#retailEditor-address-li").addClass('hidden');
                break;

            case "Local":
                $("#retailEditor-regionStates-li").addClass('hidden');
                $("#retailEditor-address-li").removeClass('hidden');
                break;

        }

    },


    openModal: function(data){

        retailEditor.init();

        if (userView.isStaff() || userView.isBlogger()) {
            $('.bpstaff').removeClass('hidden');

        } else {
            $('.bpstaff').addClass('hidden');
        }

        if (data.mode === undefined) {
            retailEditor._editMode = true;
        } else {
            retailEditor._editMode = false;
            delete data.mode;
        }

        retailEditor.activeObj.set('Id', data.Id);
        retailEditor.activeObj.set('objectID', data.objectID);
        if (data.retailerId === undefined || data.retailerId === null) {
            data.retailerId = data.Id;
        }
        retailEditor.activeObj.set("retailerId", data.retailerId);


        if (data.retailerType === undefined || data.retailerType === null) {
            data.retailerType = 'National';
        }
        retailEditor.activeObj.set("retailerType", data.retailerType);

        retailEditor.updateUX(data.retailerType);

        retailEditor.activeObj.set("name", data.name);

        var slug = ux.createSlug(data.name);
        retailEditor.activeObj.set('slug', slug);


        var rating = ux.computeRating(data.gradeScore);
        retailEditor.activeObj.set("category", rating.category);
        retailEditor.activeObj.set("gradeName", rating.gradeName);

        retailEditor.activeObj.set("gradeScore", data.gradeScore);

        retailEditor.activeObj.set("website", data.website);

        if (data.facebookId === undefined)
            data.facebookId = null;

        if (data.facebookId !== null) {
            data.facebookId = ux.urlToId( data.facebookId);
        }

        retailEditor.activeObj.set("facebookId", data.facebookId);


        if (data.weeklyAdUrl === undefined)
            data.weeklyAdUrl = null;
        retailEditor.activeObj.set("weeklyAdUrl", data.weeklyAdUrl);


        if (data.storeFinderUrl === undefined)
            data.storeFinderUrl = null;
        retailEditor.activeObj.set("storeFinderUrl", data.storeFinderUrl);

        if (data.regionStatesList === undefined)
            data.regionStatesList = [];

        if(data.regionStateList !== undefined && data.regionStateList.length > 0) {
            data.regionStatesList = data.regionStateList;
            delete data.regionStateList;
        }
        var regionStatArray = [];

        if (data.regionStatesList.length > 0 && data.regionStatesList[0].name !== undefined) {
            // Flatten the state object to corrent kendo multiselect value bug...
            for (var j=0; j<data.regionStatesList.length; j++) {
                var state = data.regionStatesList[j];
                if (state.name !== undefined) {
                    state = state.name;
                }
                regionStatArray.push (name);
            }
            data.regionStatesList = regionStatArray;
        }


        retailEditor.activeObj.set("regionStatesList", data.regionStatesList);

        if (data.address === undefined)
            data.address= null;

        retailEditor.activeObj.set("address", data.address);

        if (data.fullname === undefined)
            data.fullname= data.name;
        retailEditor.activeObj.set("fullname", data.fullname);

        if (data.email === undefined)
            data.email = null;
        retailEditor.activeObj.set("email", data.email);

        retailEditor.activeObj.set("searchUrl", 'https://www.google.com/#q='+data.name);


        if (data.retailerType !== undefined && data.retailerType !== null) {
            retailEditor.activeObj.set("retailerType", data.retailerType);
        } else {
            retailEditor.activeObj.set("retailerType",'National');
        }

        retailEditor.updateUX(retailEditor.activeObj.retailerType);

        if(data.imageUrl !== null){
            retailEditor.activeObj.set("imageUrl", data.imageUrl);
        } else {
            retailEditor.activeObj.set("imageUrl", retailEditor._defaultBrandImageUrl);
        }

        if (data.brandList === undefined || data.brandList === null) {
            data.brandList = [];
        }

        retailEditor.activeObj.set("brandList", data.brandList);

        if (data.brandIdList === undefined || data.brandIdList === null) {
            data.brandIdList = [];
        }

        retailEditor.activeObj.set("brandIdList", data.brandIdList);

        if (retailEditor.activeObj.brandIdList !== null && retailEditor.activeObj.brandIdList.length > 0) {
            var objectList = [];
            // Create a vanilla list of strings...
            for (var i=0; i< retailEditor.activeObj.brandIdList.length; i++ ) {
                var thisBrandId = retailEditor.activeObj.brandIdList[i];
                thisBrandId = thisBrandId.toString();
                retailEditor.activeObj.brandIdList[i] = thisBrandId;  // Ensure all brandId's are strings...
                objectList.push(thisBrandId);
            }

            algolia.brandIndex.getObjects(objectList, function (err, content) {
                if (err) {
                    ux.notify("Error fetching " + retailEditor.activeObj.name + "'s brands : " + JSON.stringify(err), 'error');
                    return;
                }

                retailEditor.brandHash = [];
                for (var i=0; i<content.results.length; i++) {
                    var brand = content.results[i];
                    /*if (brand.brandImageUrl === undefined  || brand.brandImageUrl)  {
                        brand.brandImageUrl = "images/icon-defaultProduct.png";
                    }*/
                    retailEditor.brandHash[JSON.stringify(brand.brandId)] = brand.brandName;
                }
                retailEditor.brandsDS.data(content.results);
                retailEditor.brandsDS.sort({ field: "brandName", dir: "asc" })
                $('#retailEditor-brandGrid').data('kendoGrid').refresh();

                // Have brand list from retailer -- now find brands that reference retailer
                retailEditor.findBrands();

            });
        }

        // category

        var categoryStr = retailEditor.activeObj.category.toLowerCase();
        switch(categoryStr){
            case "best":
                $("#retailEditor-retailer .bp-rating").removeClass("bp-best bp-better bp-avoid").addClass("bp-best");
                break;
            case "better":
                $("#retailEditor-retailer .bp-rating").removeClass("bp-best bp-better bp-avoid").addClass("bp-better");
                break;
            case "avoid":
                $("#retailEditor-retailer .bp-rating").removeClass("bp-best bp-better bp-avoid").addClass("bp-avoid");
                break;
        }
      //  $("#retailEditor").modal("toggle");
    },

    _updateIndex : function (retailerId, callback) {

        var bpurl = 'http://gaiaapi.herokuapp.com/updateretailer?retailerid='+retailerId;
        $.ajax({
            url: bpurl,
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            success: function(data) {
                if (data.status === 'OK') {
                     callback(true);
                } else {
                    callback(false)
                }

            }
        });
    },

    _deletePhoto : function (retailerId, callback) {

        var bpurl = 'http://gaiaapi.herokuapp.com/deletePhoto?folder=retailer&publicid='+retailerId;
        $.ajax({
            url: bpurl,
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            success: function(data) {
                if (data.status === 'OK') {
                    callback(true);
                } else {
                    callback(false);
                }

            }
        });
    },

    findName : function (name) {


        algolia.retailerIndex.search(name, function (err, content) {
            if (err === null) {
                if (content.hits !== null || content.hits.length > 0) {
                    var names = [];
                    for (var i=0; i< content.hits.length; i++) {
                        names.push(content.hits[i].name);
                    }

                    var nameStr = names.join(', ');

                    ux.notify("Name matches existing Retailers :  " + nameStr, 'error');
                } else {
                    ux.notify("Unique Name - no Retailers match : " + name, 'success');
                }

            } else {
                ux.notify("Error Searching Retailer names " + JSON.stringify(err), 'error');
            }

        });
    },

    addBrand : function (e) {
        var brandId = e.currentTarget.attributes['data-brandid'].value;
        var brandName = e.currentTarget.attributes['data-brandname'].value;

        ux.notify("Adding " + brandName, 'success');
        algolia.brandIndex.getObject(brandId, function (err, content) {
            if (err === null) {
                ux.notify("Loading " + content.brandName);
                retailEditor.brandsDS.add(content);
                retailEditor.activeObj.brandIdList.push(brandId);
                retailEditor.activeObj.brandList.push(brandName);

                $('#retail-search-input').val('');

            } else {
                ux.notify("Sorry,  Couldn't locate this brand!");
            }

        });

    },

    // Find Brands the reference this retailer
    findBrands : function () {

        var retailerId = retailEditor.activeObj.retailerId;

        algolia.brandIndex.search('', {facetFilters : ['retailerIdList:'+ retailerId] },function (err, content) {
            if (err === null) {

                retailEditor.brandRefDS.data(content.hits);

                if (retailEditor.brandRefDS.total() !== retailEditor.brandsDS.total()) {
                    ux.notify("Retailer and Brand Indexes out of sync!", 'error');
                } else {
                    ux.notify("Retailer and Brand Indexes are in sync", 'success');
                }

            } else {
                ux.notify("Error searching brands : " + JSON.stringify(err), 'error');
            }

        });

    },

    _deleteRetailer : function (retailerId, retailerName) {

        everlive.deleteOneById('brand', retailerId, function (err, data) {
            if (err !== null) {
                ux.notify("Error Deleting  " + retailerName + " from Database ->" + JSON.stringify (err), 'error');
            } else {
                ux.notify("Deleted " + retailerName + " from Database", 'success');
            }
        });

        algolia.retailerIndex.deleteObject(retailerId, function (err1) {
            if (err1 !== null) {
                ux.notify("Error Deleting " + retailerName + " from Index ->" + JSON.stringify (err1), 'error');
            } else {
                ux.notify("Deleted  " + retailerName + " from Index", 'success');
            }
        });
    },

    deleteRetailer : function () {
        var index = 0;
        var retailerId = retailEditor.activeObj.retailerId;
        var retailerName = retailEditor.activeObj.name;
        var brandRefCount = retailEditor.brandRefDS.total();

        function getNext () {
            var brand = retailEditor.brandRefDS.at(index);

            for (var j=0; j<brand.retailerIdList.length; j++) {
                if (brand.retailerIdList[j] === retailerId) {
                    brand.retailerIdList.splice(j, 1);
                    brand.retailerList.splice(j, 1);
                }
            }

            everlive.updateOne('brand', brand, function (err, data) {
                brandEditor._updateBrandIndex(brand.brandId, function (status) {
                    if (status) {
                        ux.notify("Updated : " + brand.brandName, 'success');
                    }
                    index++;
                    if (index < brandRefCount) {
                        return getNext();
                    }
                });
            });
        }


        if (brandRefCount > 0) {
            ux.notify("Removing " + retailEditor.activeObj.name + " from " + brandRefCount + " brands", 'success');
            getNext();
        }

        retailEditor._deleteRetailer(retailerId, retailerName)

    },


    doSave : function () {

        var retailObj = retailEditor.activeObj;
        retailObj.dirty = true;

        delete retailObj.mode;

        var regionStatArray = [];

        for (var j=0; j<retailObj.regionStatesList.length; j++) {
            var state = retailObj.regionStatesList[j];

            if (state.name !== undefined) {
                state = state.name;
            }
            regionStatArray.push (state);
        }
        retailObj.regionStatesList = regionStatArray;


        everlive.updateOne('retailer', retailObj, function (err, data) {
            if (err !== null) {
                ux.notify(retailObj.name + ' Database update error : ' + JSON.stringify(err), 'error');
                console.err( ' Database update error : ' + JSON.stringify(err) );
                return;
            }

            ux.notify(retailObj.name + ' Database updated...', 'success');
            // Call the index update function...
            retailEditor._updateIndex(retailObj.objectID, function (status) {
                if (status)
                    ux.notify(retailObj.name + ' Index updated...', 'success');
                else
                    ux.notify(retailObj.name + ' index not updated', 'error');
            });

        });
    },

    editProducts : function () {

        APP.router.navigate('#/producteditor?brandid='+retailEditor.activeObj.brandId);
    }
};
'use strict';

var retailView = {
    search: null,
    _onInit: false,
    resultsData : [],
    _defaultBrandImageUrl : 'http://res.cloudinary.com/hyjvcxzjt/image/upload/v1483036299/product/icon-defaultProduct.png',

    init: function(){
        if(!retailView._onInit){
            /// Retailers search widget
            retailView.search = instantsearch({
                appId: algolia._appId,
                apiKey: algolia._searchKey,
                indexName: "retail",
                urlSync: false
            });

            /// Search box widget
            retailView.search.addWidget(
                instantsearch.widgets.searchBox({
                    container: "#retailSearch-container",
                    placeholder: "Search for retailers...",
                    cssClasses: {
                        input: "productList-search"
                    }
                })
            );

            /// Hits/results widget
            retailView.search.addWidget(
                instantsearch.widgets.hits({
                    container: "#retailSearch-results",
                    cssClasses: {
                      item: "productSearch-item"
                    },
                    templates: {
                        item: function(data){

                            var categoryClass = null;
                            if (data.category === undefined) {
                                var cat = "Avoid";
                                var score = parseInt(data.gradeScore);

                                if (score >= 8) {
                                    cat = "Best";
                                }

                                if (score >= 4) {
                                    cat = "Better";
                                }


                                data.category = cat;
                            }
                            var categoryStr = data.category.toLowerCase();
                            var productFavorite = "";
                            var productImg = "";

                            var name;
                            retailView.resultsData[data.objectID] = data;

                            switch(categoryStr){
                                case "best":
                                    categoryClass = "productList-best";
                                    break;
                                case "better":
                                    categoryClass = "productList-better";
                                    break;
                                case "avoid":
                                    categoryClass = "productList-avoid";
                                    break;
                            }

                            var imageUrl = "";

                            if(data.imageUrl !== undefined && data.imageUrl !== null ){
                                imageUrl = data.imageUrl;
                                productImg = '<span class=productList-img><img src="' + imageUrl + '" /></span>';
                            } else {
                                //imageUrl = 'images/';
                                productImg = "<span class=productList-img><img src="+ retailView. _defaultBrandImageUrl + " /></span>";
                            }


                            if(data.name !== null) {
                                // todo - escape content
                                name = data.name;
                            }

                           var categoryString = "Avoid";

                            if (data.category === 'Best') {
                                categoryString = "Best Choice";
                            } else if (data.category === "Better") {
                                categoryString = "Better Choice";
                            }

                            var brandString = '';
                            if (data.brandList.length > 0) {
                                brandString = data.brandList.join(', ');
                            }

                            var toRender = "<div class=productList-item id="+ data.objectID + ">" +
                            "<span class='productList-category " + categoryClass + "'>" + categoryString + "</span>" +
                            productFavorite + productImg +
                            "<span class=productList-infoBox>" +
                            "<h4>" + name + "</h4>" +
                                  '<p class="subInfo"><a target="_blank" href="' + data.website + '" ><i class="material-icons">link</i>  Website</a> </p>' +
                                '<p class="subInfo text-clamp"> Offers : '+ brandString + ' </p>' +
                            "</span></div>";

                            return toRender;

                        },
                        empty: function(data){
                            var template = kendo.template($("#noRetailersTemplate").html());

                            //Create some dummy data
                            var data = {query : data.query };

                            var result = template(data); //Execute the template

                            return result;
                        }
                    },
                    hitsPerPage: 50
                })
            );

            /// menu widget - category
            retailView.search.addWidget(
                instantsearch.widgets.menu({
                   container: "#retailSearch-category",
                    attributeName: "category",
                    sortBy: ["count: asc"],
                    cssClasses: {
                       item: "productList-filterItems",
                       active: "activeFilter"
                    },
                    templates: {
                       header: "Filter by rating",
                        item: function(data){
                            var categoryStr = data.name.toLowerCase();
                            return "<span class='productList-filter product-" + categoryStr + "'>" + data.name + "</span>"+
                                "<span class=productList-filter-count> (" + data.count + ")</span>";
                        }
                    }
                })
            );


            retailView.search.addWidget(
                instantsearch.widgets.menu({
                    container: "#retailSearch-type",
                    attributeName: "retailerType",
                    sortBy: ["count: asc"],
                    cssClasses: {
                        item: "productList-filterItems",
                        active: "activeFilter"
                    },
                    templates: {
                        header: "Filter by Type",
                        item: function(data){
                            return "<span class=productList-filter><span class=productList-filterDelete>&times;</span>" + data.name + "</span>"+
                                "<span class=productList-filter-count> (" + data.count + ")</span>";
                        }
                    }
                })
            );

            retailView.search.addWidget(
                instantsearch.widgets.menu({
                    container: "#retailSearch-brand",
                    attributeName: "brandList",
                    sortBy: ["count: asc"],
                    cssClasses: {
                        item: "productList-filterItems",
                        active: "activeFilter"
                    },
                    templates: {
                        header: "Filter by brand",
                        item: function(data){
                                return "<span class=productList-filter><span class=productList-filterDelete>&times;</span>" + data.name + "</span>"+
                                    "<span class=productList-filter-count> (" + data.count + ")</span>";
                        }
                    }
                })
            );

            retailView.search.addWidget(
                instantsearch.widgets.pagination({
                    container: "#retailSearch-pagination",
                    cssClasses: {
                        active: "pagination-active"
                    }
                })
            );


            /// Stats widget
            retailView.search.addWidget(
                instantsearch.widgets.stats({
                    container: "#retailSearch-stats"
                })
            );

            retailView.search.on('render', function(){
                $(".icon-favorite").tooltip();

                $(".productList-item").unbind().on("click", function(e){
                    var currentId = $(e.currentTarget).attr("id");
                    var dataObj = retailView.resultsData[currentId];
                    if(dataObj !== undefined){

                        retailView.editRetailer(dataObj.retailerId);
                    }
                });

            });

            retailView.search.start();


            kendo.bind($("#retailEditor"), retailEditor.activeObj);

            $("#mobile-retailfilters").on("show.bs.collapse", function(e){
                $("#toggle-mobileRetailFilters-txt").text("Hide filters");
            });

            $("#mobile-retailFilters").on("hide.bs.collapse", function(e){
                $("#toggle-mobileRetailFilters-txt").text("Show filters");
            });

            $(window).resize(function(){
                var screenWidth = $(window).width();

                if(screenWidth < 767){
                    $("#mobile-retailFilters").removeClass("in");
                } else {
                    $("#mobile-retailFilters").addClass("in");
                }
            });

            retailView._onInit = true;
        }

        if (userView.isStaff() || userView.isBlogger()) {
            $('.bpstaff').removeClass('hidden');

        } else {
            $('.bpstaff').addClass('hidden');
        }
    },


    editRetailer : function (retailerId) {
        APP.router.navigate("#/retaileditor?retailerid=" + retailerId);
    },

    addRetailer : function () {
        APP.router.navigate("#/retaileditor?addretailer=true");
    },


    onShow: function(){


    },

    lookupResult : function(array, prop, value) {
        for (var i = 0, len = array.length; i < len; i++)
            if (array[i] && array[i][prop] === value) return array[i];
    },

    toggleFavorite: function(e){
        e.stopPropagation();
        if(userView.currentUser.Id !== null){
            var targetId = "";
            var targetClass = e.target.classList;

            if(targetClass[0] === "material-icons" || targetClass[0] === "favorite"){
                targetId = "#" + e.target.parentElement.id;
            } else {
                targetId = "#" + e.target.id;
            }

            // todo - wire favorite
            if(e.target.id !== undefined){
                var targetFav = $(targetId).data("favorite");

                var objectId = targetId.replace('#product-', '');
                var results = this.resultsData;

                var product = retailView.lookupResult(results, 'objectID', objectId);
                var productName = "Opps - No Product...";

                if (product.productName !== undefined && product.productName !== null) {
                    productName = product.productName;
                }

                if(targetFav){
                    $(targetId).data("favorite", false).velocity("fadeIn");
                    $(targetId + " > i.material-icons").text("favorite_border").removeClass("favorite");
                    ux.notify(productName + " removed from favorites", "success");
                } else {
                    $(targetId).data("favorite", true).velocity("fadeIn");
                    $(targetId + " > i.material-icons").text("favorite").addClass("favorite");
                    ux.notify(productName + " added to favorites", "success");
                }
            }
        } else {
            userView.openSignUp();
        }

    }
};


/**
 * Created by donbrad on 4/12/17.
 */

'use strict';
var signupWizardModal = {
    activeObj : new kendo.data.ObservableObject({
        name: null,
        organizationName : null,
        organizationType : null,
        organizationRole : null,
        email: null,
        phone: null,
        primaryDiet: null,
        diningList: [],
        dietRestrictions : [],
        favoriteCuisines : [],
        address: null,
        city: null,
        state: null,
        zipcode: null,
        lat: null,
        lng: null
    }),
    _required : [],
    _valid: [],
    _hidden: [],
    _active: [],
    _allFields: [],
    templateLoaded : false,
    initialized : false,
    _template: '../../templates/signupWizard-modal.html',
    _tag: 'signupWizard-modal',
    _index : 0,


    init : function () {

        if (!signupWizardModal.initialized) {
            signupWizardModal.initialized = true;


            $("#signup-organizationType").kendoDropDownList({
                clearButton : true,
                dataTextField: "name",
                dataValueField: "slug",
                dataSource: [
                    {name : 'Education', slug: "edu"},
                    {name : 'Government', slug: "gov"},
                    {name : 'Commercial', slug: "com"},
                    {name : 'Non Profit', slug: "np"}
                ]
            });

            $("#signup-organizationRole").kendoDropDownList({
                clearButton : true,
                dataTextField: "name",
                dataValueField: "slug",
                dataSource: [
                    {name : 'Employee / Staff', slug: "staff"},
                    {name : 'Customer / Student', slug: "student"},
                    {name : 'Professor / Teacher', slug: "teacher"},
                    {name : 'Executive / Management', slug: "management"}
                ]
            });

            $("#signup-diet-primaryDiet").kendoDropDownList({
                dataSource : profileView._dietArray,
                dataTextField: "shortDescription",
                dataValueField: "shortDescription",
                clearButton : true
            });

            $("#signup-diet-diningList").kendoMultiSelect({
                clearButton : true,
                tagMode : 'multiple'
            });

            $("#signup-diet-dietRestrictions").kendoMultiSelect({
                clearButton : true,
                dataSource : profileView._allergyArray,
                dataTextField: "shortDescription",
                dataValueField: "shortDescription",
                tagMode : 'multiple'
            });

            $("#signup-diet-favoriteCuisines").kendoMultiSelect({
                dataSource : profileView._cuisineArray,
                dataTextField: "name",
                dataValueField: "name",
                tagMode : 'multiple'
            });

            $("#signup-phoneInput").kendoMaskedTextBox({
                mask: "(999) 000-0000"
            });

            var input = document.getElementById('signup-addressInput');

            signupWizardModal.autocomplete = new google.maps.places.Autocomplete(input);

            signupWizardModal.autocomplete.addListener('place_changed', function() {
                var place = signupWizardModal.autocomplete.getPlace();
                mapModel.processPlace(place);
                var user = userModel.userObj;
                var geoData = mapModel.activeObj;
                user.set('lat', geoData.lat);
                user.set('lng', geoData.lng);
                user.set('address', geoData.address);
                user.set('zipcode', geoData.ziplong);
                user.set('county', geoData.county);
                user.set('state', geoData.state);
                user.set('country', geoData.country);

                if (!place.geometry) {
                    // User entered the name of a Place that was not suggested and
                    // pressed the Enter key, or the Place Details request failed.
                    ux.notify("No details available for input: '" + place.name + "'", 'error');

                }
            });

            signupWizardModal.activeObj.bind("change", function(e) {
                var field = e.field;

                if (field === 'email') {
                    var email = signupWizardModal.activeObj.get(field);
                    var result = ux.validateEmail(email);
                    if (result) {
                        $('#signup-emailInvalid').addClass('hidden');

                        signupWizardModal.setErrorMessage('email', "Looking up email....", true);
                        userView._checkUserEmail(email, function (data) {

                            if (data.status === "OK") {
                                var users = data.users;
                                var user = data.users.result[0];

                                if (users.count > 0) {
                                    signupWizardModal.setErrorMessage('email', user.DisplayName + " from " + user.accountOwner + " is using this Email Address", true);
                                } else {
                                    signupWizardModal.setValid('email', true);
                                    signupWizardModal.setErrorMessage('email',"Thank you!" , true);
                                }

                            } else {
                                signupWizardModal.setErrorMessage('email',"Unable to check email : " + JSON.stringify(error), true);
                            }

                        });


                    } else {
                        signupWizardModal.setErrorMessage('email',"This doesn't look like a valid Email Address...", true);
                        signupWizardModal.setValid('email', false);
                    }
                } else if (field === 'organizationName') {
                    var orgName = signupWizardModal.activeObj.get(field);


                    if (orgName.length < 3) {
                        signupWizardModal.setErrorMessage(field,"This doesn't look like a valid Organization Name...", true);
                        signupWizardModal.setValid('organization', false);
                    } else {
                        signupWizardModal.setErrorMessage(field,"Thank You!", true);
                        signupWizardModal.setValid('organization', true);
                    }


                }
            });
        }
    },

    locateMe : function () {

        mapModel.getUserLocation(function (geoData) {

            if (geoData !== null) {
                var user = userModel.userObj;

                user.set('lat', geoData.lat);
                user.set('lng', geoData.lng);
                user.set('address', geoData.address);
                user.set('zipcode', geoData.ziplong);
                user.set('county', geoData.county);
                user.set('state', geoData.state);
                user.set('country', geoData.country);

            }
        });
    },

    isValid : function (field) {
        var that = signupWizardModal;
        return (that._valid[field]);
    },

    isRequired : function (field) {
        var that = signupWizardModal;
        return (that._required[field]);
    },

    setValid : function (field, value) {
        var that = signupWizardModal;
        that._valid[field] = value;
        if(value){
            $(".ghp-" + field + " > div.form-group").removeClass("has-error").addClass("has-success");
        } else {
            $(".ghp-" + field + " > div.form-group").addClass("has-error").removeClass("has-success");
        }

    },

    setRequired : function (field, value) {
        var that = signupWizardModal;
        that._required[field] = value;
    },

    setErrorMessage : function (field, message, show) {
        var msgtag = '#signup-'+field+'Error';

        if (!show) {
            $(msgtag).html();
        } else {
            $(msgtag).html(message);
            //$(msgtag).addClass("hidden");
        }


    },


    initProfile : function () {

        $('.ghp-name').addClass('hidden');
        $('.ghp-email').addClass('hidden');
        $('.ghp-address').addClass('hidden');
        $('.ghp-phone').addClass('hidden');
        $('.ghp-diet').addClass('hidden');
        $('.ghp-organization').addClass('hidden');

        $('.setup-validation').addClass('hidden');

    },

    setupProfile : function () {

        var profileList = userView.actionList;
        //signupWizardModal.initProfile();
        var that = signupWizardModal;

        that._valid = [];
        that._required = [];


        _.forEach(that._allFields, function(value, key){
            var profileListIndex = _.indexOf(profileList, value);
            /// get jquery index of li
            var tabIndex = $("#signup-smartwizard > div > .ghp-" + value).index();

            if(profileListIndex === -1){
                // not required, add to hidden tabs
                that._hidden.push(tabIndex);

            } else {
                // show tab, add to active tabs
                that._active.push(tabIndex);
            }

        });
        // show first active tab
        signupWizardModal._index =  _.min(that._active);


        /*if (profileList === null || profileList.length === 0) {
            return;
        }

       // window.location.hash = '#ghp-'+profileList[0];

        for (var i=0; i< profileList.length; i++) {
            var selector = '.ghp-' + profileList[i];

            that.setValid(profileList[i], false);
            that.setRequired(profileList[i], true);

            //$(selector).removeClass('hidden');
        }*/


       //

    },

    _buildSignUpTabs: function(){
        var tabList = $("#signup-smartwizard > ul").children();

        _.forEach(tabList, function(value){
           var tabName = value.dataset.tab;
            signupWizardModal._allFields.push(tabName);
        });
    },

    _initWizard : function () {

        $('#signup-smartwizard').smartWizard({
            selected: signupWizardModal._index,
            autoAdjustHeight: false,
            useURLhash: false,
            showStepURLhash : false,
            keyNavigation: true, // Enable/Disable keyboard navigation(left and right keys are used if enabled)
            anchorSettings: {
                anchorClickable: true, // Enable/Disable anchor navigation
                enableAllAnchors: false, // Activates all anchors clickable all times
                markDoneStep: true, // add done css
                enableAnchorOnDoneStep: true
            },
            hiddenSteps: signupWizardModal._hidden
        });

        $("#signup-smartwizard").on("leaveStep", function(e, anchorObject, stepNumber, stepDirection) {
            var valid = true;
            if (anchorObject[0].hash === '#signup-email' && !signupWizardModal.isValid('email')) {

                if (signupWizardModal.isRequired('email')) {
                    valid = false;
                } else {
                    valid = true;
                }

            }

            if (anchorObject[0].hash === '#signup-organization' && !signupWizardModal.isValid('organization')) {

                if (signupWizardModal.isRequired('organization')) {
                    valid = false;
                } else {
                    valid = true;
                }
            }

            return (valid);
        });

        $("#signup-smartwizard").on("showStep", function(e, anchorObject, stepNumber, stepDirection){
            var lastTab = _.max(signupWizardModal._active);

            if(lastTab === stepNumber){
                signupWizardModal.toggleFinished(true);
            } else {
                signupWizardModal.toggleFinished(false);
            }
        });

        kendo.bind($("#signupWizard-modal"), signupWizardModal.activeObj);

        signupWizardModal.init();

    },

    toggleFinished: function(flag){
        if(flag){
            $("#signupWizard-modal .modal-footer").removeClass("hidden");
            $("#signup-smartwizard > nav").addClass("hidden");
        } else {
            $("#signupWizard-modal .modal-footer").addClass("hidden");
            $("#signup-smartwizard > nav").removeClass("hidden");
        }
    },


    setTabIndex : function () {
        var tabList =  $('.signup-li');

        for (var i=0; i<tabList.length; i++) {
            var tab = tabList[i];

            if (tab.className.indexOf('hidden') === -1) {

                window.location.hash = tab.classList[0];

               /* $('.'+tab.classList[0]).addClass('active');
                $('.'+tab.classList[0]).removeClass('hidden');*/
                return (i);
            }
        }
    },

    checkSingleAction: function(){
        var actionLength = signupWizardModal._active.length;
        if(actionLength === 1){
            signupWizardModal.toggleFinished(true);
        } else {
            signupWizardModal.toggleFinished(false);
        }
    },

    open : function () {

        if (signupWizardModal.templateLoaded) {
            $('#signupWizard-modal').modal('toggle');
        } else {
            templateLoader.loadHtml(signupWizardModal._tag, signupWizardModal._template, function(status) {
                if(status){
                    signupWizardModal.templateLoaded = true;
                    signupWizardModal._buildSignUpTabs();
                    signupWizardModal.setupProfile();
                    signupWizardModal._initWizard();
                    signupWizardModal.checkSingleAction();
                    $('#signupWizard-modal').modal('toggle');
                }
            });
        }
    },

    save : function () {
        var that = signupWizardModal ;

        if (that.isRequired('email') && that.isValid('email')) {
            var email = that.activeObj.email;
            userModel.userObj.set('email', email);

        }

        if (that.isRequired('organization') && that.isValid('organization')) {
            var activeObj = that.activeObj;

            userModel.userObj.set('organizationName', activeObj.organizationName);
            userModel.userObj.set('organizationRole', ux.validString(activeObj.organizationRole));
            userModel.userObj.set('organizationType', ux.validString(activeObj.organizationType));
            userModel.update();
        }

    },

    close : function () {

        window.location.hash='';

        signupWizardModal.save();
        // Need to save information here
        $('#signupWizard-modal').modal('toggle');
    }
};
/**
 * Created by donbrad on 3/19/17.
 */

'use strict';

var siteEditor = {
    search: null,
    activeObj: new kendo.data.ObservableObject({
        name: null,
        slug: null,
        mainmenuObj: {},
        relatedTwitterList : [],
        relatedFacebookList : [],
        pinterestId: null,
        youtubeId : null,
        twitterId : null,
        facebookId : null,
        dietList: [],
        proteinList: [],
        crossPostList : [],
        profileFields: [],
        sponsorTitle: null,
        sponsorDescription: null

    }),
    _initialized: false,

    init: function() {

        if (!siteEditor._initialized) {
            siteEditor._initialized = true;

            $("#siteeditor-tabstrip").kendoTabStrip({
                animation:  {
                    open: {
                        effects: "fadeIn"
                    }
                }
            });

            $("#site-crossPostList").kendoMultiSelect({
                dataTextField: "name",
                dataValueField: "slug",
                clearButton : true,
                dataSource: [
                    {name : 'Farm Forward', slug: "farm-forward"},
                    {name : 'JIFA', slug: "jifa"},
                    {name : 'Better Food Foundation', slug: "better-food-foundation"},
                    {name : 'Leadership-Circle', slug: "leadership-circle"},
                    {name : 'Buying Poultry', slug: "buying-poultry"}
                ]  // Todo : don fetch these from the sites collection

            });

            $("#site-profileFields").kendoMultiSelect({
                dataTextField: "name",
                dataValueField: "slug",
                clearButton : true,
                dataSource: [
                    {name : 'Name', slug: "name"},
                    {name : 'Diet', slug: "diet"},
                    {name : 'Email', slug: "email"},
                    {name : 'Address', slug: "address"},
                    {name : 'Phone', slug: "phone"},
                    {name : 'Organization', slug: "organization"}
                ]  // Todo : don fetch these from the sites collection

            });
        }
    },

    loadSite : function (siteIn) {

        var siteObj = siteEditor.activeObj;

        siteObj.set('Id', siteIn.Id);
        siteObj.set('slug', siteIn.slug);
        siteObj.set('name', siteIn.name);
        siteObj.set('facebookId', siteIn.facebookId);
        siteObj.set('twitterId', siteIn.twitterId);
        siteObj.set('youtubeId', siteIn.youtubeId);
        siteObj.set('pinterestId', siteIn.pinterestId);
        if (siteIn.mainMenu === undefined) {
            siteObj.set('mainMenu', []);
        }
        siteObj.set('infoEmail', siteIn.infoEmail);
        siteObj.set('inFFFamily', siteIn.inFFFamily);
        siteObj.set('relatedTwitterList', siteIn.relatedTwitterList);
        siteObj.set('relatedFacebookList', siteIn.relatedFacebookList);
        siteObj.set('dietList', siteIn.dietList);
        siteObj.set('crossPostList', siteIn.crossPostList);
        siteObj.set('profileFields', siteIn.profileFields);
        siteObj.set('hasDonations', siteIn.hasDonations);
        siteObj.set('hasVolunteers', siteIn.hasVolunteers);
        siteObj.set('hasSmile', siteIn.hasSmile);
        siteObj.set('sponsorTitle', siteIn.sponsorTitle);
        siteObj.set('sponsorDescription', siteIn.sponsorDescription);
    },


    saveSite : function () {

    },

    open : function () {

        siteEditor.init();

        siteEditor._currentSite = APP.siteSlug;
        var siteObj = siteModel.findBySlug(siteEditor._currentSite);

        if (siteObj !== null) {
            siteEditor.loadSite(siteObj);
        }

    },

    close : function () {

    }

};
'use strict';

var tagView = {
    search: null,
    _initialized: false,
    _pageSize : 10,
    resultsData : [],

    init: function(){
        if(!tagView._initialized){

            tagView._initialized = true;

            $("#tagEditor-tagGrid").kendoGrid({
                dataSource: tagModel.tagDS,
                resizable: true,
                sortable: true,
                reorderable: true,
                pageSize : tagView._pageSize,
                pageable: true,
                toolbar: [{name: "create", text: "Add Tag"},  {name: "save", text: "Save All Changes..."}],
                editable: true,
                edit : function (e) {
                    var item = e.model;
                    var addItemFlag = e.model.isNew();

                    var title = item.name;

                    var slug = ux.createSlug(title);

                    if (item.slug !== slug) {
                        item.set('slug', slug);
                    }

                    if (item.content === undefined) {
                        item.content = null;
                    }

                    if (item.content !== null && item.content.length > 0) {
                        var content = item.content;
                        content = content.replace(/<!--[\s\S]*?-->/g,"");
                        content = content.replace(/<style[\s\S]*?\/style>/g,"");
                    }
                    item.set('content', content);

                    if (item.tooltip === undefined) {
                        item.tooltip = null;
                    }

                    if (item.tooltip !== null && item.tooltip.length > 0) {
                        var tooltip = item.tooltip;
                        tooltip = tooltip.replace(/<!--[\s\S]*?-->/g,"");
                        tooltip = tooltip.replace(/<style[\s\S]*?\/style>/g,"");
                    }
                    item.set('tooltip', tooltip);

                },
                height: 560,
                columns: [
                    { field:"category", title:"Category", width: 120, editor: tagView._categoryEditor},
                    { field:"name",title:"Name", width: 120 },
                    { field:"alias",title:"Alias", width: 60 },
                    { field:"slug",title:"Slug", width: 120 },
                    { field:"internalUri", title:"Internal URI",  width: 80},
                    { field:"url",title:"External URL",  width: 120},
                    { field:"twitterId",title:"Twitter",  width: 80},
                    { field:"facebookId",title:"Facebook",  width: 80},
                    { field:"tooltip", title:"Tool Tip", width: 160},
                    { field:"content", title:"Content", width: 160},

                    { command: [{name: "destroy", text: "Delete"}, {text: "Search", click: tagView.doSearch }],  width: 160 }
                ]
            });



            $('#tag-search-input').keyup (function () {
                var val =  $('#tag-search-input').val();

                if (val.length > 0) {
                    tagModel.tagDS.filter({logic: 'or', filters: [
                        {field: 'name', operator: 'contains', value: val},
                        {field: 'tooltip', operator: 'contains', value: val}
                     ]});
                } else {
                    tagModel.tagDS.filter({});
                }

            });

            $('#tag-search-input').change (function () {
                var val =  $('#tag-search-input').val();

                if (val.length > 0) {
                    tagModel.tagDS.filter({logic: 'or', filters: [
                        {field: 'name', operator: 'contains', value: val},
                        {field: 'tooltip', operator: 'contains', value: val}
                    ]});
                } else {
                    tagModel.tagDS.filter({});
                }
            });
        }


    },

    onShow: function() {
        if (userView.isStaff() || userView.isBlogger()) {
            $('.bpstaff').removeClass('hidden');

        } else {
            $('.bpstaff').addClass('hidden');
        }

        tagModel.tagDS.sort({ field: "name", dir: "asc" });
        tagModel.tagDS.pageSize(tagView._pageSize);
    },

    doSearch : function (e) {
        e.preventDefault();

        var dataItem = this.dataItem($(e.currentTarget).closest("tr"));

        var url = "https://www.google.com/#q=" + dataItem.name;

        window.open(url, "_blank");
    },

    _categoryEditor : function (container, options) {
        $('<input required name="' + options.field + '"/>')
            .appendTo(container)
            .kendoDropDownList({
                autoBind: false,
                select: function (e) {
                    var item = e.item;
                },
                dataSource:  [ "Brand", "Contributor", "Label", "Person", "Retailer", "Organization", "Reference", "Skill", "Tag" ]
            });
    }

};


var tagModal = {

    _initialized: false,
    activeObj : new kendo.data.ObservableObject({category: 'Tag', title: null, tag: null, slug: null, tooltip: null, content: null}),


    init : function () {
        if (!tagModal._initialized) {
            tagModal._initialized = true;
            kendo.bind($("#tagView-modal"), tagModal.activeObj);
        }

    },

    onClick : function (e) {
        var slug = e.currentTarget.attributes['data-slug'].value;
        //var uid = e.currentTarget.attributes['data-uid'].value;
        var category =  e.currentTarget.attributes['data-category'].value;

        tagModal.open(slug);

    },

    open : function (tagId) {
        tagModal.init();

        var tagObj = glossaryModel.findBySlug(tagId);

        if (tagObj !== null) {

            var obj = tagModal.activeObj;

            obj.set('category', tagObj.category);
            obj.set('title', tagObj.title);
            obj.set('tag', tagObj.tag);
            obj.set('slug', tagObj.slug);
            obj.set('tooltip', tagObj.tooltip);
            obj.set('content', tagObj.content);

        }

    },


    close : function () {

        $('#tagView-modal').modal('toggle');

    }
};
'use strict';

var userView = {
    userId : null,
    fbToken : null,
    fbId: null,
    fbPhoto: null,
    fbData  : {},
    twitterToken : null,
    twitterData : null,
    googleData : null,
    _googleToken : null,
    liveidData : null,
    _liveidToken : null,
    displayWizard : false,
    _wizardTemplateLoaded : false,
    actionList : [],
    name: null,
    email: null,
    donationHistory: null,
    currentUser : new kendo.data.ObservableObject({Id: null}),
    activeUser : null,
    userActive : false,
    firstName : null,
    photoUrl : null,
    screenName : null,
    source : 'Buying Poultry',
    _twitter : 'twitter',
    _facebook : 'facebook',
    _google : 'google',
    _liveid : 'liveid',
    _direct: 'bp',
    _staff: '92090850-5222-11e6-b59b-f349346a75ee',
    _blogger : '99781bd0-5222-11e6-ba1a-9b5d7b79288c',
    _team : 'a9da3930-fae3-11e6-bad8-17279fbdb6c0',
    _registered : '26018a50-511f-11e6-8f5c-53009c3df0d7',
    _unknown : 'af5d0cd0-8da5-11e6-9aa3-a1bf81a06d1d',
    _signUp : {
      nameValid: false,
        emailValid: false,
        passwordValid: false
    },
    _isInit: false,
    _forgotPassActive: false,

    _authSuccessCallback : null,


    identity: null,  // can be 'bp' - direct user signup, 'facebook', 'twitter', null,

    initAuthCallback : function () {
        userView._authSuccessCallback = null;
    },

    setAuthCallback : function (callback) {

        if (callback !== null) {
            userView._authSuccessCallback = callback;
        }

    },

    initSignUp: function () {
        userView._signUp.nameValid = false;
        userView._signUp.emailValid = false;
        userView._signUp.passwordValid = false;
    },

    validSignUp : function () {
        var that = userView._signUp;
        return(that.nameValid && that.emailValid && that.passwordValid);
    },


    init: function () {
        if(!userView._isInit){
            userView._isInit = true;
            /* Load user auth dialog */
            templateLoader.loadHtml("gh-user-auth", '../../../templates/userAuth.html', function(status){
                if(status){
                    var tab = $("#gh-auth-tab-join");
                    $("#gh-auth-tabs").kendoTabStrip({
                        animation: false
                    }).data("kendoTabStrip").activateTab(tab);

                    $('#signIn-form').on('submit', function (e) {
                        //e.preventDefault();
                        if (e.isDefaultPrevented()) {
                            // handle the invalid form...
                            
                        } else {
                            e.preventDefault();
                            // everything looks good!
                            userView.doSignIn();
                        }
                    });

                    $('#signUp-form').on('submit', function (e) {
                        if (e.isDefaultPrevented()) {
                            // handle the invalid form...

                        } else {
                            e.preventDefault();
                            // everything looks good!
                            if (userView.validSignUp()) {
                                userView.doSignUp();
                            }

                        }
                    });

                    $('#signUp-fullname').on('blur', function (e) {
                        var name = $('#signUp-fullname').val();
                        if (name.length > 0) {
                            userView._signUp.nameValid = true;
                        } else {
                            userView._signUp.nameValid = false;
                        }
                    });

                    $('#signUp-password').on('blur', function (e) {
                        var pw = $('#signUp-password').val();
                        if (pw.length > 3) {
                            userView._signUp.passwordValid = true;
                        } else {
                            userView._signUp.passwordValid = false;
                        }
                    });

                    $('#signUp-username').on('blur', function (e) {
                        var email = $('#signUp-username').val();
                        var result = ux.validateEmail(email);
                        if (result) {
                            userView._checkUserEmail(email, function (data) {
                                if (data.status === "OK") {
                                    var users = data.users;
                                    var user = data.users.result[0];

                                    if (users.count > 0) {
                                        $("#signUp-form-error").removeClass("hidden").text(user.DisplayName + " from " + user.accountOwner + " is using this Email Address");
                                        userView._signUp.emailValid = false;
                                    } else {
                                        userView._signUp.emailValid = true;
                                        $("#signUp-form-error").addClass("hidden").text("");
                                    }

                                } else {
                                    ux.notify( "Unable to check email : " + JSON.stringify(error), 'error');
                                }

                            });
                        }
                    });

                }
            });

          /*  /!* Load user onboard wizard *!/
            templateLoader.loadHtml(signupWizardModal._tag, signupWizardModal._template, function(status) {
                if(status){
                    userView._wizardTemplateLoaded = true;

                }

            });*/



          /*  userView.facebook = new FacebookIdentityProvider(appSettings.facebook.appId);
            userView.facebook.init();*/
        }

    },


    initStaffModels : function  () {
        //paymentHistoryModel.init();
        pageModel.init();
        siteModel.init();
        feedbackModel.init();
        campaignModel.init();
        petitionModel.init();
        commentModel.init();
        backlogModel.init();

    },

   initPublicModels: function () {
        siteModel.init();
        contributorModel.init();
        pledgeModel.init();
        petitionModel.init();
        mcGroupModel.init();
        mapModel.init();
       glossaryModel.init();
       quizModel.init();
       tagModel.init();
       if (APP.siteSlug !== 'bff') {
           blogModel.init();
       }
    },

    initMemberModels : function () {
        if (APP.siteSlug === 'buying-poultry') {
            favorites.init();
        }
        userDonation.init();
        userPledge.init();
    },

    isActive : function () {
      return (userView.userActive)
    },

    isGaiaHacker : function () {
        if (userView.currentUser.Id !== null && userView.currentUser.isGaiaHacker !== undefined && userView.currentUser.isGaiaHacker) {
            return(true);
        }
        return(false);
    },

    isStaff : function () {
        if (userView.currentUser.Id !== null && userView.currentUser.Role === userView._staff) {
            return(true);
        }
        return(false);
    },

    isBlogger : function () {
        if (userView.currentUser.Id !== null && userView.currentUser.Role === userView._blogger) {
            return(true);
        }
        return(false);
    },


    isTeam : function () {
        if (userView.currentUser.Id !== null && userView.currentUser.Role === userView._team) {
            return(true);
        }
        return(false);
    },

    enableStaffUX : function () {

        if (userView.isStaff() || userView.isBlogger() || userView.isTeam()) {
            return (true);
        } else {
            return (false);
        }
    },

    signOut : function () {
        everlive.logout(function () {
            analyticsModel.sendGAEvent("authentication", "SignOut", "PII");
            userView.currentUser = new kendo.data.ObservableObject({Id: null});
            userView.setNoUserUX();
            if (APP.siteSlug === 'buying-poultry') {
                favorites.initDataSources();
            }
            profileView.closeProfile();
            userModel.isTracking = false;
            userView.userActive = false;
            userView.clearUser();
            userView.donationHistory = null;
            ghEvent.trigger(ghEvent.authChange);
            APP.router.navigate("#/");
        });

        if(ux.isBSMobile()){
            ux.closeMobileMenu("#mainMenu");
        }
    },

    openSignUp : function (callback, context) {
        var mobileMenu = $("#mainMenu").hasClass("in");
        if(mobileMenu){
            $("#mainMenu").collapse('toggle');
        }

        userView.initSignUp();

        $("#gh-user-auth").modal("show");

        if (callback !== undefined) {
            userView._authSuccessCallback = callback;
            userView._authSuccessContext = context;

        }

    },

    closeSignUp : function () {
        // clear sign in
        $("#signIn-username, #signIn-password").val("");
        //clear sign up
        $("#signUp-fullname, #signUp-username, #signUp-password").val("");

        $("#signIn-form-error, #signUp-form-error").addClass("hidden").text("");

        $("#gh-user-auth").modal("hide");

    },

    openSignUpWizard: function () {
        userView.closeSignUp();
        signupWizardModal.open();
    },

    doSignUp : function () {
        var fullname = $('#signUp-fullname').val(),username = $('#signUp-username').val(), password = $('#signUp-password').val();
        userView.clearUser();
        analyticsModel.sendGAEvent("authentication", "FFSignUpAttempt", "PII");
        userView.createAccount(username, password, fullname);
    },

    doSignIn : function () {

        var username = $('#signIn-username').val(), password = $('#signIn-password').val();
        userView.clearUser();
        everlive.login(username, password , function (error, data) {
            if (error !== null) {
                analyticsModel.sendGAEvent("authentication", "FFSignInError", "PII");
                $("#signIn-form-error").removeClass('hidden').text(error.message);
                return;

            }
            $("#signIn-form-error").addClass('hidden').text("");
            var url = "/signin";
            analyticsModel.sendGAEvent("authentication", "FFSignInSuccess", "PII");
            userModel.isTracking = true;
            userView.closeSignUp();
            userView.username = username;
            userView.getCurrentUser();
        });
    },

    createAccount : function (username, password, name) {
        analyticsModel.sendGAEvent("authentication", "createAccount", "PII");
        everlive.createAccount(username, name, password, function (error, data) {
            if (error !== null) {

                if (error.code === 201) {
                    analyticsModel.sendGAEvent("authentication", "createAccountExisting", "PII");
                    $("#signUp-form-error").removeClass("hidden").text(username + " is an existing account.  Please Sign In.");
                    return;
                }
                analyticsModel.sendGAEvent("authentication", "createAccountError", "PII");
                $("#signUp-form-error").removeClass("hidden").text("Error creating account : " + error.message);
                return;
            }
            $("#signUp-form-error").addClass("hidden").text("");
            var url = "/signup";
            ux.setAnalyticsPath(url);
            userView.closeSignUp();
            everlive.currentUser(function (err1, data1) {
                if (err1 !== null) {
                    userView.createAccount(username, password, name);
                    analyticsModel.sendGAEvent("authentication", "createAccountSuccess", "PII");
                } else {
                    everlive.login(username, password, function (err2, data2) {
                        if (err2 !== null ){
                            $("#signUp-form-error").removeClass("hidden").text("Create Account Login error " + err2.message);
                            return;
                        }
                        userView.getCurrentUser();
                        analyticsModel.sendGAEvent("authentication", "createAccountSuccess", "PII");
                    });
                }

            });
        });
    },

    openProfile : function ()  {

    },


    setUserUX : function () {
        $(".menu-signup").addClass('hidden');
        $(".menu-member").removeClass('hidden');
        $(".menu-user").removeClass('hidden');
        userView.updateUserInfo();
    },

    setNoUserUX : function () {
        $(".menu-member").addClass('hidden');
        $(".menu-signup").removeClass('hidden');
        $(".menu-user, .bpstaff").addClass('hidden');
        userView.photoUrl = null;
        userView.clearUser();
        userView.source = "Buying Poultry";
        ux.showGhPlatformMenu(false);
        userView.currentUser = new kendo.data.ObservableObject();
    },

    updateUserProfile : function () {
        var activeObj = userView.currentUser;

        var name = activeObj.name;
        if (name === undefined) {
            name = activeObj.DisplayName;
        }
        var email = activeObj.email;
        if (email === undefined) {
            email = activeObj.Email;
        }

        /*$('#profile-title').text(name);
        $('#profile-name').val(name);
        $('#profile-email').val(email);
*/
       /* if (activeObj.photoUrl !== undefined && activeObj.photoUrl !== null) {
            userView.photoUrl = activeObj.photoUrl;
        }
        if (userView.photoUrl !== null) {
            $('#profile-photo').attr('src', userView.photoUrl);
        } else {
            $('#profile-photo').attr('src',"images/icon-defaultProduct.png");
        }
        if (activeObj.zipcode === undefined) {
            activeObj.zipcode = null;
        }
        $('#profile-zipcode').val(activeObj.zipcode);

        if (activeObj.address === undefined) {
            activeObj.address = null;
        }
        $('#profile-address').val(activeObj.address);
*/
        $('#profile-role').addClass('hidden');
        if (userView.isStaff() ) {
            $('#profile-role').removeClass('hidden');
            $('#profile-roleTitle').text('Staff');
        }

        if (userView.isBlogger () ) {
            $('#profile-role').removeClass('hidden');
            $('#profile-roleTitle').text('Blogger');
        }

        // set profile preferences
       /* $("#profile-isVegan").prop("checked", activeObj.isVegan);
        $("#profile-isVegetarian").prop("checked", activeObj.isVegetarian);
*/
        if (userView.isStaff() || userView.isBlogger()) {
            $('.bpstaff').removeClass('hidden');

        } else {
            $('.bpstaff').addClass('hidden');

        }

    },

    updateUserInfo : function () {
       var activeObj = userView.currentUser;

        var name = activeObj.name;
        if (name === undefined) {
            name = activeObj.DisplayName;
        }
        var email = activeObj.email;
        if (email === undefined) {
            email = activeObj.Email;
        }

        $('.menu-user-title').text(name);

        $('#profile-title').text(name);
/*
        if (activeObj.zipcode === undefined) {
            activeObj.zipcode = null;
        }

        if (activeObj.address === undefined) {
            activeObj.address = null;
        }*/

        $('#profile-role').addClass('hidden');

        if (userView.isStaff() ) {
            $('#profile-role').removeClass('hidden');

        }

        if (userView.isBlogger () ) {
            $('#profile-role').removeClass('hidden');

        }

        if (userView.enableStaffUX()) {
            $('.bpstaff').removeClass('hidden');
        } else {
            $('.bpstaff').addClass('hidden');
        }
    },

    clearUser : function () {
        userView.email = null;
        userView.name = null;
        userView.photoUrl = null;
        userView.firstName = null;
        userView.lastName = null;
    },

    getCurrentUser : function () {
        APP.everlive.Users.currentUser()
            .then(function (data) {

                    if (data.result !== null) {
                        userView.currentUser = data.result;
                        userModel.setUser(data.result);
                        userModel.init();
                        userView._processUser();
                        //console.log(JSON.stringify(userView.currentUser));
                        userView.userActive = true;
                        indexView.onShow();
                        userView.setUserUX();
                        userView.initPublicModels();
                        userView.initMemberModels();
                        ghEvent.trigger(ghEvent.authChange);
                        if (userModel.userObj.accountOwner === undefined || userModel.userObj.accountOwner === null) {
                            userModel.userObj.set('accountOwner', 'Buying Poultry');
                            userModel.userObj.set('accountOwnerUrl', 'https://buyingpoultry.tech');
                        }

                        // if staff, show platform bar
                        if(userView.isStaff() || userView.isBlogger()){
                            ux.showGhPlatformMenu(true);
                        } else {
                            ux.showGhPlatformMenu(false);
                        }

                        if (userView.displayWizard) {
                            userView.triggerSignUpWizard();
                        }

                    } else {
                        userView.currentUser = new kendo.data.ObservableObject({Id: null});
                        userModel.setUser(null);
                        userView.userActive = false;
                        ghEvent.trigger(ghEvent.authChange);
                        userView.setNoUserUX();
                        ux.showGhPlatformMenu(false);
                    }
                },
                function(error){
                    userView.currentUser = new kendo.data.ObservableObject({Id: null});
                    userView.userActive = false;
                    indexView.refreshSignInBlock();
                    userView.setNoUserUX();
                    if (error.code === 301) {
                        // Cached credentials are invalid...
                        everlive._id = null;
                        everlive._token = null;
                        everlive.putCredentials();
                        ux.showGhPlatformMenu(false);
                    }
                    //console.log(JSON.stringify(error));
                });
    },

    _userSocialUpdate: function () {
        if (ux.validateEmail(userView.email)){
            userModel.userObj.set('email', userView.email);
            userModel.userObj.set('Email', userView.email);
        }

        if (ux.validateStr(userView.name)) {
            userModel.userObj.set('name', userView.name);
            userModel.userObj.set('DisplayName', userView.name);
        }

        if (ux.validateStr(userView.firstName)) {
            userModel.userObj.set('firstName', userView.firstName);
        }

        if (ux.validateStr(userView.photoUrl)) {
            userModel.userObj.set('photoUrl', userView.photoUrl);
        }
    },

    _processUser : function () {
        var user = userModel.userObj;

        userModel.userObj.set('photoUrl', userModel._defaultProfilePhoto);

        if (userView.enableStaffUX()) {
            userView.initStaffModels ();
        }

        if (ux.validateEmail(userModel.userObj.email)) {
            userView.donationHistory = [];
            userView.donationTotal = 0;

            userView._checkUserDonations(userModel.userObj.email, function (data) {
                if (data.status === 'OK') {

                    if (data.donations.count > 0) {
                        var donatObj = {};
                         var latestDate = null, latestDonation = 0;

                        for (var i=0; i<data.donations.result.length; i++) {

                            var donation = data.donations.result[i];

                            donatObj.amount = donation.total;
                            donatObj.date = donation.date;
                            if (latestDate == null) {
                                latestDate = donation.date;
                                latestDonation = donation.total;
                            } else if (moment(donation.date).isAfter(latestDate) ) {
                                latestDate = donation.date;
                                latestDonation = donation.total;
                            }

                            userView.donationTotal += donation.total;
                            userView.donationHistory.push(donatObj);

                            var syncDate = moment.utc().valueOf();

                        }
                        userModel.userObj.set('lastDonation', latestDonation);
                        userModel.userObj.set('lastDonationDate', latestDate);
                        userModel.userObj.set('donationTotal', userView.donationTotal);
                        userModel.userObj.set('donationSync', syncDate);

                        ux.notify('Your donation of  $' + latestDonation.toFixed(2) + " on " + moment(latestDate).format('MMM Do, YYYY') + " is appreciated!");

                        ghEvent.trigger(ghEvent.donationSync);
                    }

                }
            });

            mailchimpModel.searchUser(userModel.userObj.email);

            $(window).on(ghEvent.donationLoaded, function () {
                userDonation.fetch();
            });

            $(window).on(ghEvent.pledgeLoaded, function () {
                userPledge.fetch();
            });

            if (userView._authSuccessCallback !== null) {
                userView._authSuccessCallback(userView._authSuccessContext);
            }
        }



        if (user === null || user.IdentityProvider === undefined) {
            return;
        }

        if (user.IdentityProvider === 'Twitter') {
            var twitterUser = user.Identity.Twitter;

            userView.source = userView._twitter;
            userView.socialId = twitterUser.id;

            userView.photoUrl = twitterUser.profile_image_url_https;

            userView.screenName = twitterUser.screen_name;
            userModel.userObj.set('twitterId', twitterUser.screen_name);
            userModel.userObj.set('alias', twitterUser.screen_name);


            userModel.userObj.set('photoUrl', userView.photoUrl);
            //user.set('twitterId', userView.socialId);


        } else if (user.IdentityProvider === 'Facebook') {
            var facebookUser = user.Identity.Facebook;
            userView.source = userView._facebook;
            userView.socialId = facebookUser.id;
            if (facebookUser.picture !== undefined && facebookUser.picture.data !== undefined) {
                userView.photoUrl = facebookUser.picture.data.url;
                user.photoUrl = userView.photoUrl;
                userModel.userObj.set('photoUrl', userView.photoUrl);
                //user.set('facebookId', userView.socialId);


            }
            userView.screenName = facebookUser.name;

        } else if (user.IdentityProvider === 'Google') {
            var googleUser = user.Identity.Google;
            userView.source = userView._google;
            if (googleUser.picture !== undefined && googleUser.picture !== null) {
                userView.photoUrl = googleUser.picture;
                user.photoUrl = userView.photoUrl;
                userModel.userObj.set('photoUrl', userView.photoUrl);
                userModel.userObj.set('email', googleUser.email);
                userModel.userObj.set('firstName', googleUser.given_name);
                userModel.userObj.set('lastName', googleUser.family_name);


            }
            userView.screenName = googleUser.name;
        } else if (user.IdentityProvider === 'LiveID') {
            var liveUser = user.Identity.LiveID;
            userView.source = userView._liveid;
            if (liveUser.id !== undefined && liveUser.id !== null) {
                userView.photoUrl = 'https://apis.live.net/v5.0/'+ liveUser.id +'/picture';
                user.photoUrl = userView.photoUrl;
                userModel.userObj.set('photoUrl', userView.photoUrl);
                userModel.userObj.set('email', liveUser.emails.account);
                userModel.userObj.set('firstName', liveUser.first_name);
                userModel.userObj.set('lastName', liveUser.last_name);

            }
            userView.screenName = liveUser.name;
        }

        userView.processUserVisit();

        userView._userSocialUpdate();  // Merge in any updates from connected social account
    },


    processUserVisit : function () {
        // Is this user a member of this site?
        var confirmed = userView._confirmMembership();

        // What information does this user have in their profile
        var profileMap = userView._validateProfile();

        // What information does this site require in their profile
       // var siteProfile = siteModel.currentSite.profileFields;
        //Todo:  site profile can still be loading while user auth check runs...

      //  if (siteProfile === undefined || siteProfile === null) {
            var siteProfile = APP.profileFields;
    //    }

        // Build an action list based on what the user has and what the site requires
        var actionList = [];

        if (siteProfile === undefined || siteProfile === null || siteProfile.length === 0 ) {
            siteProfile = ['name', 'email'];
        }

        for (var i=0; i<siteProfile.length; i++ ) {
            var site = siteProfile[i];

            if (profileMap[site] !== undefined) {
                actionList.push(site);
            }
        }

       userView.actionList = actionList;

        userView.displayWizard = false;
        if (actionList.length > 0) {
            userView.displayWizard = true;
        }

    },

    triggerSignUpWizard : function () {

        var actionList = userView.actionList;

        if (actionList.length > 0) {
            // Adding a test banner notification
            var msg = {
                message: "Please complete your profile.",
                icon: null,
                priority: 10,
                action: signupWizardModal.open
            };
            ghBannerBar.addNotification(msg);
            //signupWizardModal.open();
            ghBannerBar.onShow();

        }

    },


    _confirmMembership : function () {
        var user = userModel.userObj;
        var found = false;

        if (user.accountOwner === undefined || user.accountOwner == null) {
            user.accountOwner = APP.siteName;
            user.accountOwnerUrl = APP.siteUrl;

        }

        if (user.membershipList === undefined || user.membershipList === null) {
            user.membershipList = [];
            user.membershipList.push(APP.siteSlug);
            userView.siteWelcome();
            userView.needSiteIntro = true;
        } else {
            for (var i=0; i<user.membershipList.length; i++ ) {
                if (APP.siteSlug === user.membershipList[i]) {
                    found = true;
                }
            }

            if (!found) {
                user.membershipList.push(APP.siteSlug);
                userView.siteWelcome();
            }
        }

        return (found);
    },

    _validateProfile : function () {
        var userObj = userModel.userObj;

        var profileMap = [];

        if (!ux.validateName(userObj.name)) {
            profileMap['name'] = true;
        }

        if (!ux.validateEmail(userObj.email)) {
           profileMap['email'] = true;
        }

        if (!ux.validateStr(userObj.address)) {
            profileMap['address'] = true;
        }

        if (!ux.validateStr(userObj.zipcode)) {
            profileMap['address'] = true;
        }

        if (!ux.validateStr(userObj.state))  {
            profileMap['address'] = true;
        }

        if (!ux.validateStr(userObj.phone)) {
            profileMap['phone'] = true;
        }

        if (!ux.validateStr(userObj.organizationName)) {
            profileMap['organization'] = true;
        }

        if (!ux.validateStr(userObj.primaryDiet)) {
            profileMap['diet'] = true;
        }


        return(profileMap)
    },


    loginViaTwitter : function () {

        //userView._getTwitterTokens();
        OAuth.popup('twitter').done( function( success){


            APP.everlive.authentication.loginWithTwitter(success.oauth_token, success.oauth_token_secret,
                function (data) {
                    success.me().done(function(me) {
                        userView.twitterData = me;
                        userView.identity = me;
                        var email = me.email;

                        if (ux.validateEmail(email)){
                            userView.email = email;
                        }

                        var name = me.name;
                        if (ux.validateStr(name)){
                            var parsed = NameParse.parse(name);

                            userView.name = name;
                            userView.firstName = parsed.firstName;
                            userView.lastName = parsed.lastName;

                        }

                        var photo = me.avatar;
                        if (ux.validateStr(photo)){
                            userView.photoUrl = photo;
                        }

                        $(window).on(ghEvent.userLoaded, function () {
                            userView._userSocialUpdate();
                        });
                    });

                    analyticsModel.sendGAEvent("authentication", "loginViaTwitter", "PII");
                    userView.getCurrentUser();
                    userView.closeSignUp();


                },
                function(error){
                    ux.notify("Twitter Error  : " + JSON.stringify(error), 'error');
                });


        }).fail(function(err){
            var error = err;
        });

    },

    loginViaFacebook : function () {
        OAuth.popup('facebook').done( function( success){

            var token = success.access_token;
            APP.everlive.Users.loginWithFacebook(token)
                .then(function () {
                    userView.fbToken = token;
                    analyticsModel.sendGAEvent("authentication", "loginViaFacebook", "PII");

                    success.me().done(function(me) {
                        userView.fbData = me;
                        userView.identity = me;
                        var email = me.email;

                        if (ux.validateEmail(email)){
                            userView.email = email;
                        }

                        var photo = me.avatar;
                        if (ux.validateStr(photo)){
                            userView.photoUrl = photo;
                        }

                        var name = me.name;
                        if (ux.validateStr(name)){
                            var parsed = NameParse.parse(name);

                            userView.name = name;
                            userView.firstName = parsed.firstName;
                            userView.lastName = parsed.lastName;

                        }
                        $(window).on(ghEvent.userLoaded, function () {
                            userView._userSocialUpdate();
                        });
                    });

                    userView.getCurrentUser();
                    userView.closeSignUp();
                    /*facebook.userInfo(function (data){
                        userView.fbData = data;
                        userView.fbId = data.id;
                        analyticsModel.sendGAEvent("authentication", "loginViaFacebook", "PII");
                        userView.name = data.name;
                        if (data.first_name !== undefined && data.first_name !== null)
                            userView.firstName = data.first_name;
                        else
                            userView.firstName = data.name;
                        userView.email = data.email;
                        userView.identity = userView._facebook;
                        facebook.userPhoto(userView.fbId, function(photo){
                            userView.fbPhoto = photo.url;
                            userView.photoUrl = photo.url;
                            userView.currentUser.photoUrl = photo.url;
                        });
                        userView.getCurrentUser();
                        userView.closeSignUp();
                    });*/


                })
                .then(null, function (err) {
                    ux.notify("Facebook Signin : " + err.message, 'error');
                });

        }).fail(function(err){
            var error = err;
        });

    },


    loginViaGoogle : function () {

        var redirect =  encodeURIComponent(window.location.origin+ '/oauth/google/');
        var googleConfig = {
            name: 'Google',
            loginMethodName: 'loginWithGoogle',
            endpoint: 'https://accounts.google.com/o/oauth2/auth',
            response_type: 'token',
            client_id: appSettings.google.clientId,
            redirect_uri: redirect,
            //redirect_uri: appSettings.google.redirectUri,
            scope: 'https://www.googleapis.com/auth/plus.login https://www.googleapis.com/auth/plus.me https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email',
            access_type: 'online',
            display: 'touch'
        };
        var google = new IdentityProvider(googleConfig);

        google.getAccessToken(function(token) {
            userView._googleToken = token;

            APP.everlive.Users.loginWithGoogle(token)
                .then(function (data) {
                    var googleData = { id: data.result.principal_id, token : data.result.access_token};
                    analyticsModel.sendGAEvent("authentication", "loginViaGoogle", "PII");
                    userView.googleData = googleData;
                    userView.identity = userView._google;
                    userView.getCurrentUser();
                    userView.closeSignUp();
                }, function (err) {

                    if (err.code == 214) {
                        ux.notify('Google Plus is not enabled in the backend portal.', 'error');
                    } else {
                        ux.notify("Google Plus Signin : " + err.message, 'error');

                    }
                    userView.closeSignUp();
                    userView.getCurrentUser();
                });
        });
    },


    loginViaLiveId : function () {
        var redirect =  encodeURIComponent(window.location.origin+ '/oauth/liveid/');
        var liveIdConfig = {
            name: 'LiveID',
            loginMethodName: 'loginWithLiveID',
            endpoint: 'https://login.live.com/oauth20_authorize.srf',
            response_type: 'token',
            client_id: appSettings.liveId.clientId,
            redirect_uri: redirect,
          //  redirect_uri: appSettings.liveId.redirectUri,
            scope: 'wl.basic wl.emails',
            access_type: 'online',
            display: 'touch'
        };
        var liveId = new IdentityProvider(liveIdConfig);


        liveId.getAccessToken(function(token) {
            APP.everlive.Users.loginWithLiveID(token)
                .then(function (data) {
                    var liveidData = { id: data.result.principal_id, token : data.result.access_token};
                    analyticsModel.sendGAEvent("authentication", "loginViaGoogle", "PII");
                    userView.liveidData = liveidData;
                    userView.identity = userView._liveid;
                    userView.getCurrentUser();
                    userView.closeSignUp();
                })
                .then(null, function (err) {

                    if (err.code == 214) {
                        ux.notify('Windows LiveId is not enabled in the backend portal.', 'error');
                    } else {
                        ux.notify("Live Id Sign In : " + err.message, 'error');
                    }
                    userView.closeSignUp();
                    userView.getCurrentUser();
                });
        });
    },


    toggleForgotPassword: function(e){
        // todo - wire forgot password
        if(!userView._forgotPassActive){
            $("#signIn-form-password, #signIn-form-actions").addClass("hidden");
            $("#signIn-reset-action").removeClass("hidden");
            userView._forgotPassActive = true;
        } else {
            $("#signIn-form-password, #signIn-form-actions").removeClass("hidden");
            $("#signIn-reset-action").addClass("hidden");
            $("#signIn-form-error").addClass("hidden").text("");
            userView._forgotPassActive = false;
        }

    },

    sendPasswordReset: function(){
        var email = $("#signIn-username").val();
        analyticsModel.sendGAEvent("authentication", "resetPassword", userView.currentUser.Id);
        everlive.recoverPassword(email, function(err, resp){
            if(err !== null){
                $("#signIn-form-error").removeClass("hidden").text(err.message);
                return
            }
            
            userView.toggleForgotPassword();
        })
    },

    _checkUserEmail: function (email, callback) {
        var url = 'https://gaiaapi.herokuapp.com/finduserbyemail?email='+email;
        $.ajax({
            url: url,
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            success: function(data) {
                callback(data);
            },
            error: function (xhr,status,error) {

            }
        });
    },

    _checkUserDonations: function (email, callback) {
        var url = 'https://gaiaapi.herokuapp.com/donationsbyemail?email='+email;
        $.ajax({
            url: url,
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            success: function(data) {
                callback(data);
            },
            error: function (xhr,status,error) {

            }
        });
    },

    checkWelcome : function () {

        if (!ux.validateEmail(userModel.userObj.email)) {
            // No valid email yet
            return;
        }


        if (userModel.userObj.welcomeSent === undefined || !userModel.userObj.welcomeSent ) {
           userView._sendWelcome (function (data) {
               if (data.status === 'OK') {
                   userModel.userObj.set('welcomeSent', true);

               }
           });
        }
    },

    siteWelcome : function () {
        if (ux.validateEmail(userModel.userObj.email)) {
           /* userView._sendWelcome (function (data) {
                if (data.status === 'OK') {

                }
            });*/
        }
    },

    _checkMCGroups : function (mcGroups) {
        if (mcGroups === undefined || mcGroups === null || mcGroups.length === 0) {
            return;
        }

        var userGroups = userModel.userObj.mcGroups;

        if (userGroups === null || userGroups.length === 0) {

        }
    },


    checkEmail : function () {

        if (ux.validateEmail(userModel.userObj.email) && !userModel.userObj.isVerified) {
            userView._sendEmailVerify(function (data) {

            });
        }

    },

    _sendWelcome : function (callback) {

        /*var userId = userModel.userObj.Id;
        var url = 'http://gaiaapi.herokuapp.com/sendWelcome?userid='+userId+"&templateid="+APP.emailTemplates.welcome+'&trackerid='+window.gaTrackerId;
        $.ajax({
            url: url,
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            success: function(data) {
                if (callback !== undefined && callback !== null) {
                    callback(data);
                }
            }
        });
*/
    },

    _sendEmailVerify : function (callback) {

        var userId = userModel.userObj.Id;

        var url = 'https://gaiaapi.herokuapp.com/sendVerifyEmail?userid='+userId+"&templateid="+APP.emailTemplates.verifyEmail+"&replyid="+APP.emailTemplates.emailVerified+'&trackerid='+window.gaTrackerId;
        $.ajax({
            url: url,
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            success: function(data) {
                callback(data);
            }
        });

    }

};



/**
 * Created by donbrad on 4/3/17.
 *
 * Blog Roll Widget
 *
 */


(function($) {
    // shorten references to variables. this is better for uglification
    var kendo = window.kendo,
        ui = kendo.ui,
        Widget = ui.Widget;

    var BlogRoll = Widget.extend({
        // initialization code goes here
        init: function(element, options) {
            var that = this;
            // base call to initialize widget
            Widget.fn.init.call(this, element, options);


            templateLoader.load('../../../templates/widgets/BlogRoll.html', function (status) {

                that.template = kendo.template($("#BlogRoll-tmpl").html());

                that._dataSource();

                that.refresh();
            });

        },

        options: {
            // the name is what it will appear as off the kendo namespace(i.e. kendo.ui.MyWidget).
            // The jQuery plugin would be jQuery.fn.kendoMyWidget.
            name: "BlogRoll",

            autoBind: true,

            title: "",

            list : [],

            // other options go here
            template: ""

        },

        _dataSource: function() {
            var that = this;
            // returns the datasource OR creates one if using an array or a configuration
            that.dataSource = kendo.data.DataSource.create(that.options.dataSource);

            // bind to the change event to refresh the widget
            that.dataSource.bind('change', function() {
                that.refresh();
            });

            // trigger a read on the dataSource if one hasn't happened yet
            if (that.options.autoBind) {
                that.dataSource.fetch();
            }
        },

        refresh: function() {
            var that = this,
                view = that.dataSource.view(),
                html = kendo.render(that.template, view);

            that.element.html(html);
        },

        edit : function () {

        }

    });

    ui.plugin(BlogRoll);

})(jQuery);
/**
 * Created by donbrad on 4/3/17.
 *
 * DonateBlock Widget
 *
 */


(function($) {
    // shorten references to variables. this is better for uglification
    var kendo = window.kendo,
        ui = kendo.ui,
        widget = ui.Widget;

    var DonateBlock = widget.extend({
        // initialization code goes here
        init: function(element, options) {
            var that = this;
            // base call to initialize widget

            templateLoader.load('../../../templates/widgets/DonateBlock.html', function(status) {
                if(status) {
                    widget.fn.init.call(that, element, options);
                    that.template = kendo.template($("#DonateBlock-tmpl").html());

                    that.refresh();

                    var selector = 'btn-' + that.options.donationId;
                    var button = document.getElementById(selector);
                    $(document).on("click", "#" + selector, $.proxy(that._buttonclick, that));

                   /* $(window).on(ghEvent.donationLoaded + " " + ghEvent.authChange, function () {
                        that.refresh();
                    });*/

                    $(window).on(ghEvent.authChange, function() {
                        that.refresh();
                    });

                    $(window).on(ghEvent.userdonationLoaded, function() {
                        that.refresh();
                    });

                    $(window).on(ghEvent.donationSync, function() {
                        that.refresh();
                    });
                }

            });

        },

        options: {
            // the name is what it will appear as off the kendo namespace(i.e. kendo.ui.MyWidget).
            // The jQuery plugin would be jQuery.fn.kendoMyWidget.
            name: "DonateBlock",

            buttonText : "Donate",

            signUpText : "Join to Donate",

            isSignedIn : false,

            title : "You can help right now",

            thankyou : "Thank you!  You've contributed  $",

            message : "",

            donationId: null,

            campaignId : null,

            backgroundImg: null,

            img: null,

            showThankYou: false,

            imgPlacement: 'none',

            template: '<div class="ghp-donateblock" style="text-align: center;"> <h3> #:title#</h3> <div> <button class="btn btn-default" data-campaignid="#:campaignId#" onclick="#:buttonClick#">#:buttonText#</button> </div> </div>'

        },

        refresh: function() {
            var that = this;

            var data = {buttonText: that.options.buttonText, buttonClick: that.options.buttonClick, title : that.options.title, thankyou: that.options.thankyou, message: that.options.message, campaignId : that.options.campaignId, donationId: that.options.donationId };
            if (userView.isActive()) {
                that.options.isSignedIn = true;
                if (userView.donationTotal > 0) {
                    data.thankyou = that.options.thankyou  +  userView.donationTotal.toFixed(2);
                    data.showThankYou = true;
                }
                if (that.options.donateText !== undefined) {
                data.buttonText = that.options.donateText;
                }
            } else {

                that.options.isSignedIn = false;

                if (that.options.donateText === undefined)
                    that.options.donateText = that.options.buttonText;

                data.buttonText = that.options.signUpText;

            }

            var html = that.template(data);
         //   var html = kendo.render(that.template, view);

            that.element.html(html);
        },

        edit : function () {
            var that = this;
        },

        _buttonclick : function (e) {
            var element = e;
            var that = this;

            if (userView.isActive()) {
                analyticsModel.sendGAEvent('donation', 'offer', that.options.donationId, 'open');
                donationModal.open(that.options.donationId);
            } else {
                analyticsModel.sendGAEvent('donation', 'signup', that.options.donationId, 'open');
                userView.openSignUp(donationModal.open, that.options.donationId);
            }

        }

    });

    ui.plugin(DonateBlock);

})(jQuery);
/**
 * Created by donbrad on 4/3/17.
 *
 * DonateThermometer Widget
 *
 */


(function($) {
    // shorten references to variables. this is better for uglification
    var kendo = window.kendo,
        ui = kendo.ui,
        widget = ui.Widget;

    var DonateThermometer = widget.extend({
        // initialization code goes here
        init: function(element, options) {
            var that = this;
            // base call to initialize widget

            widget.fn.init.call(this, element, options);
            templateLoader.load('../../../templates/widgets/DonateBlock.html', function(status) {

                that.template = kendo.template($("#DonateBlock-tmpl").html());

                that.refresh();
            });

        },

        options: {
            // the name is what it will appear as off the kendo namespace(i.e. kendo.ui.MyWidget).
            // The jQuery plugin would be jQuery.fn.kendoMyWidget.
            name: "DonateThermometer",

            buttonText : "Donate",

            buttonClick : "donateView.donate()",

            title : "You can help right now",

            thankyou : "Thank you for your support",

            message : "",

            goalAmount: 10000.00,

            currentAmount: 6000.00,

            campaignId : 'farm-forward',

            template: '<div class="ghp-donatethermometer" style="text-align: center;"> <h3> #:title#</h3> <div> <button class="btn btn-default" data-campaignid="#:campaignId#" onclick="#:buttonClick#">#:buttonText#</button> </div> </div>'

        },

        refresh: function() {
            var that = this;

            var data = {buttonText: that.options.buttonText, buttonClick: that.options.buttonClick, title : that.options.title, thankyou: null, campaignId : that.options.campaignId };
            if (userView.isActive()) {
                data.thankyou = that.options.thankyou  + userModel.userObj.name;
            }

            var html = that.template(data);
         //   var html = kendo.render(that.template, view);

            that.element.html(html);
        }

    });

    ui.plugin(DonateThermometer);

})(jQuery);
/**
 * Created by donbrad on 4/3/17.
 *
 * Page Roll  Widget
 *
 */


(function($) {
    // shorten references to variables. this is better for uglification
    var kendo = window.kendo,
        ui = kendo.ui,
        Widget = ui.Widget;

    var PageRoll = Widget.extend({
        // initialization code goes here
        init: function(element, options) {
            var that = this;
            // base call to initialize widget
            Widget.fn.init.call(this, element, options);

            that._dataSource();
        },

        options: {
            // the name is what it will appear as off the kendo namespace(i.e. kendo.ui.MyWidget).
            // The jQuery plugin would be jQuery.fn.kendoMyWidget.
            name: "PageRoll",
            autoBind: true,

            // other options go here
            template: ""

        },

        _dataSource: function() {
            var that = this;
            // returns the datasource OR creates one if using an array or a configuration
            that.dataSource = kendo.data.DataSource.create(that.options.dataSource);

            // bind to the change event to refresh the widget
            that.dataSource.bind('change', function() {
                that.refresh();
            });

            // trigger a read on the dataSource if one hasn't happened yet
            if (that.options.autoBind) {
                that.dataSource.fetch();
            }
        },

        refresh: function() {
            var that = this,
                view = that.dataSource.view(),
                html = kendo.render(that.template, view);

            that.element.html(html);
        }

    });

    ui.plugin(PageRoll);

})(jQuery);
/**
 * Created by donbrad on 4/3/17.
 *
 * PeopleBlock Widget
 *
 */


(function($) {
    // shorten references to variables. this is better for uglification
    var kendo = window.kendo,
        ui = kendo.ui,
        Widget = ui.Widget;

    var PeopleBlock = Widget.extend({
        // initialization code goes here
        init: function(element, options) {
            var that = this;


            Widget.fn.init.call(this, element, options);

            if (that.options.peopleList !== undefined && that.options.peopleList.length > 0) {
                that._loadPeopleList();
            } else {
                that._dataSource();
            }

            templateLoader.load('../../../templates/widgets/PeopleBlock.html', function(status) {

                if (status) {

                    if (that.templateLoaded !== undefined) {
                        return;
                    }

                    that.templateLoaded = true;

                    that.template = kendo.template($("#peopleBlock-tmpl").html());


                    var html = that.template(that.options);

                    that.element.html(html);

                    $("#peopleblock-list").kendoListView({
                        dataSource: that.dataSource,
                        template: kendo.template($("#people-item-tmpl").html())
                    });

                }
            });



        },

        options: {
            // the name is what it will appear as off the kendo namespace(i.e. kendo.ui.MyWidget).
            // The jQuery plugin would be jQuery.fn.kendoMyWidget.
            name: "PeopleBlock",

            autoBind: true,

            title: "About Us",

            description: "We're the people as passionate as you are...",

            dataSource : [],

            peopleList: [],
            // other options go here

            template: ""

        },

        _loadPeopleList : function () {
            var that = this;
            var peopleArray = [];

            var peopleList = that.options.peopleList;
            for (var i=0; i<peopleList.length; i++) {
                var peopleSlug = peopleList[i];

                var peopleObj = contributorModel.findBySlug(peopleSlug);

                peopleArray.push(peopleObj);
            }

            that.options.dataSource = peopleArray;

            that._dataSource();
        },


        _dataSource: function() {
            var that = this;
            // returns the datasource OR creates one if using an array or a configuration
            that.dataSource = kendo.data.DataSource.create(that.options.dataSource);

            /*// bind to the change event to refresh the widget
            that.dataSource.bind('change', function() {
                that.refresh();
            });*/

            // trigger a read on the dataSource if one hasn't happened yet
            if (that.options.autoBind) {
                that.dataSource.fetch();
            }
        },

        refresh: function() {
           /* var that = this;

            var html = kendo.render(that.template, that.options);

            that.element.html(html);*/
        }

    });

    ui.plugin(PeopleBlock);

})(jQuery);
/**
 * Created by donbrad on 4/3/17.
 *
 * PetitionBlock Widget
 *
 */


(function($) {
    // shorten references to variables. this is better for uglification
    var kendo = window.kendo,
        ui = kendo.ui,
        widget = ui.Widget;

    var PetitionBlock = widget.extend({
        // initialization code goes here
        init: function(element, options) {
            var that = this;
            // base call to initialize widget

            widget.fn.init.call(this, element, options);
            templateLoader.load('../../../templates/widgets/PetitionBlock.html', function(status) {

                that.template = kendo.template($("#PetitionBlock-tmpl").html());

                that.refresh();
            });

        },

        options: {
            // the name is what it will appear as off the kendo namespace(i.e. kendo.ui.MyWidget).
            // The jQuery plugin would be jQuery.fn.kendoMyWidget.
            name: "PetitionBlock",

            buttonText : "Sign Petition",

            buttonClick : "petitionModal.open()",

            title : "You can help right now",

            thankyou : "Thank you for your support ",

            message : "",

            campaignId : 'farm-forward',

            pledgeId : null,

            img: null,

            imgPlacement: 'none',

            template: '<div class="ghp-petitionBlock" style="text-align: center;"> <h3> #:title#</h3> <div> <button class="btn btn-default" data-campaignid="#:campaignId#" data-petitionid="#:petitionId#" onclick="#:buttonClick#">#:buttonText#</button> </div> </div>'

        },


        refresh: function() {
            var that = this;

            var data = {buttonText: that.options.buttonText, buttonClick: that.options.buttonClick, title : that.options.title, thankyou: that.options.thankyou, message: that.options.message, campaignId : that.options.campaignId };
            if (userView.isActive()) {
                if (userView.donationTotal > 0) {
                    data.thankyou = that.options.thankyou  + userModel.userObj.name;
                }
            }

            var html = that.template(data);
         //   var html = kendo.render(that.template, view);

            that.element.html(html);
        }

    });

    ui.plugin(PetitionBlock);

})(jQuery);
/**
 * Created by donbrad on 4/3/17.
 *
 * PledgeBlock Widget
 *
 */


(function($) {
    // shorten references to variables. this is better for uglification
    var kendo = window.kendo,
        ui = kendo.ui,
        widget = ui.Widget;

    var PledgeBlock = widget.extend({


        // initialization code goes here
        init: function(element, options) {
            var that = this;
            // base call to initialize widget

            widget.fn.init.call(this, element, options);



            templateLoader.load('../../../templates/widgets/PledgeBlock.html', function(status) {
                if (status) {

                    if (that.templateLoaded !== undefined) {
                        return;
                    }

                    that.templateLoaded = true;

                    that.template = kendo.template($("#pledgeBlock-tmpl").html());

                    var html = that.template(that.options);

                    that.element.html(html);

                    var selector = 'btn-' + that.options.pledgeId;
                    var button = document.getElementById(selector);
                    if (that.options.isSignedIn) {
                        button.disabled = that.options.isTaken;
                    } else {
                        button.disabled = false;
                    }

                    $(document).on("click", "#" + selector, $.proxy(that._buttonclick, that));

                    $(window).on(ghEvent.authChange, function() {
                        that.refresh();
                    });


                    if (userModel.userLoaded) {
                        if (userPledge.userPledgesLoaded) {
                            that.refresh();
                        } else {
                            $(window).on(ghEvent.userpledgeLoaded, function() {
                                that.refresh();
                            });
                        }
                    } else {
                        $(window).on(ghEvent.userLoaded, function() {
                            if (userPledge.userPledgesLoaded) {
                                that.refresh();
                            } else {
                                $(window).on(ghEvent.userpledgeLoaded, function() {
                                    that.refresh();
                                });
                            }
                        });
                    }
                }
            });
        },

        options: {
            // the name is what it will appear as off the kendo namespace(i.e. kendo.ui.MyWidget).
            // The jQuery plugin would be jQuery.fn.kendoMyWidget.
            name: "PledgeBlock",

            buttonText : " I Pledge",

            signUpText : "Join to Pledge",

            requireEmail : false,

            requireAddress : false,

            title : "You can help right now",

            thankyouTitle: "You Pledged To...",

            thankyou : "Thank you for your Pledge! ",

            pledgeAction : "I pledge to...",

            description : "",

            content : '',

            pledgeId : '',

            isTaken : false,

            dateTaken : null,

            backgroundImg: null,

            img: null,

            message: "Almost there...",

            imgPlacement: 'none',

            template: '<div class="ghp-pledgeBlock" style="text-align: center;"> <h3> #:title#</h3> <div> <button class="btn btn-default"  data-pledgeid="#:pledgeId#"  >#:buttonText#</button> </div> </div>'

        },

        _refresh : function () {
            var that = this;
            var html = that.template(that.options);

            that.element.html(html);
        },

        refresh: function() {
            var that = this;

            if (!userView.userActive) {
                that.options.isSignedIn = false;
                that.options.isTaken = false;
                that.options.dateTaken = null;
                if (that.options.pledgeText === undefined)
                    that.options.pledgeText = that.options.buttonText;
                that.options.buttonText = that.options.signUpText;
            } else {
                that.options.isSignedIn = true;
                if (that.options.pledgeText !== undefined) {
                    that.options.buttonText = that.options.pledgeText;
                }
                that._togglePledgeState();
            }

           that._refresh();

        },

        taken : function (state) {
            var that = this;

            if (state === undefined) {
                return that.options.isTaken;
            } else {
                if (state === true) {
                    that.options.isTaken = true;
                    // assign pledge date
                    var pledgeDate = new Date();
                    that.dateTaken(pledgeDate);
                } else {
                    that.options.isTaken = false;
                }
            }
        },

        dateTaken : function (date) {
            var that = this;

            if (date === undefined) {
                return that.options.dateTaken;
            } else {
                that.options.dateTaken = date;
            }
        },

        _validateAddress : function () {
            var user = userModel.userObj;
            return (ux.validateStr(user.address) && ux.validateStr(user.zipcode));
        },

        _checkRequirements : function () {
            var that = this;
            var needEmail = false, needAddress = false;

            if (that.options.requireEmail) {
                if (!ux.validateEmail(userModel.userObj.email)) {
                    needEmail = true;
                }
            }

            if (that.options.requireAddress) {
                if (!that._validateAddress()) {
                    needAddress = true;
                }
            }

            if (needAddress || needEmail) {
                pledgeInfoModal.open(needEmail, needAddress, that.options.title, that.options.message, function (result) {
                    userView.initAuthCallback();
                    if (result) {
                        analyticsModel.sendGAEvent('pledge', 'verify', that.options.pledgeId, 'success');
                        that._processPledge();
                    } else {
                        ux.notify("You've cancelled your pledge...")
                    }
                });
            } else {
                that._processPledge()
            }
        },


        _togglePledgeState : function () {
            var that = this;
            if (that.options.pledgeId !== undefined && that.options.pledgeId !== null) {


                var pledgeObj = pledgeModel.findBySlug(that.options.pledgeId);

                that.options.pledgeObj = pledgeObj;
                if (userPledge.userPledgesLoaded) {
                    var pledge = userPledge.findBySlug(that.options.pledgeId);
                    if (pledge === null) {
                        that.options.isTaken = false;
                        that.options.dateTaken = null;

                    } else {

                        that.options.isTaken = true;
                        that.options.dateTaken = pledge.pledgeDate;
                    }
                } else {
                    $(window).on(ghEvent.userpledgeLoaded, function (){
                        that.refresh();
                    })
                }

            }
        },


        _processPledge : function () {
            var that = this;

            var pledge = that.options.pledgeObj;

            if (pledge === undefined || pledge === null) {

                pledge = pledgeModel.findBySlug(that.options.pledgeId);
                that.options.pledgeObj = pledge;

            }

            var groups = pledge.mcGroups;

            if (groups.length > 0) {
                var groupArray = [];
                for (var i=0; i<groups.length; i++)  {
                    groupArray.push(groups[i].interestId.toString());
                }

                mailchimpModel.updateGroups(pledge.listId, groupArray);
            }

            userPledge.addPledge(pledge);
            that.options.isTaken = true;
            that.options.dateTaken = new Date();
            that._refresh();
            analyticsModel.sendGAEvent('pledge', 'signup', that.options.pledgeId, '');
        },

        _authCallback: function (context) {

            var that = context;

            that._checkRequirements();

        },


        _buttonclick : function (e) {
            var element = e;
            var that = this;

            analyticsModel.sendGAEvent('pledge', 'click', that.options.pledgeId, 'button');
            if (userView.userActive) {
                analyticsModel.sendGAEvent('pledge', 'verify', that.options.pledgeId, 'open');

                that._checkRequirements();
            } else {
                userView.openSignUp(that._authCallback, that);
            }

        }

    });

    ui.plugin(PledgeBlock);

})(jQuery);
/**
 * Created by donbrad on 4/3/17.
 *
 * SignInBlock Widget
 *
 */


(function($) {
    // shorten references to variables. this is better for uglification
    var kendo = window.kendo,
        ui = kendo.ui,
        widget = ui.Widget;

    var SignInBlock = widget.extend({
        // initialization code goes here
        init: function(element, options) {
            var that = this;
            // base call to initialize widget

            widget.fn.init.call(this, element, options);

            templateLoader.load('../../../templates/widgets/SignInBlock.html', function(status) {
                if(status){
                    that.template = kendo.template($("#SignInBlock-tmpl").html());

                    var html = that.template(that.options);
                    that.element.html(html);


                    $(window).on(ghEvent.authChange, function(){
                        that.refresh();
                    })
                }

            });
        },

        options: {
            // the name is what it will appear as off the kendo namespace(i.e. kendo.ui.MyWidget).
            // The jQuery plugin would be jQuery.fn.kendoMyWidget.
            name: "SignInBlock",

            buttonText : "SignIn/Up",

            buttonTitle : "Please connect with Farm Forward",

            buttonClick : "userView.openSignUp()",

            description : "",

            isActive : false,

            hideOnActive : false,

            activeText : "Profile",

            activeTitle : "Check out Your Profile",

            activeClick : "profileView.gotoProfile()",

            backgroundImg: null,

            // other options go here
            template: '<div class="ghp-signinblock" style="text-align: center;"> <h3> #:buttonTitle#</h3> <div> <button class="btn btn-default" onclick="#:buttonClick#">#:buttonText#</button> </div> </div>'

        },

        refresh: function() {
            var that = this;

            var data = {
                description: that.options.description,
                buttonText: that.options.buttonText,
                buttonTitle : that.options.buttonTitle,
                buttonClick: that.options.buttonClick
            };


            if (userView.isActive()) {
                data.isActive = true;
                data.buttonTitle = "Welcome " + userModel.userObj.name + "!";
                data.buttonText =  that.options.activeText;
                data.buttonClick = that.options.activeClick;
                var el = that.element[0];
                $(el).addClass("active");

                if(this.options.hideOnActive){
                    that.element[0].style.display = "none";
                } else {
                    that.element[0].style.display = "block";
                }
            } else {
                $(el).removeClass("active");
                data.isActive = false;
                that.element[0].style.display = "block";
            }

            var html = that.template(data);
            //   var html = kendo.render(that.template, view);

            that.element.html(html);
        },


        edit : function () {

        }

    });




    ui.plugin(SignInBlock);

})(jQuery);
/**
 * Created by donbrad on 4/3/17.
 *
 * Social Feed Widget
 *
 */


(function($) {
    // shorten references to variables. this is better for uglification
    var kendo = window.kendo,
        ui = kendo.ui,
        Widget = ui.Widget;

    var SocialFeed = Widget.extend({
        // initialization code goes here
        init: function(element, options) {
            var that = this;
            // base call to initialize widget
            Widget.fn.init.call(this, element, options);

            that._dataSource();
        },

        options: {
            // the name is what it will appear as off the kendo namespace(i.e. kendo.ui.MyWidget).
            // The jQuery plugin would be jQuery.fn.kendoMyWidget.
            name: "SocialFeed",
            autoBind: true,

            // other options go here
            template: ""

        },

        _dataSource: function() {
            var that = this;
            // returns the datasource OR creates one if using an array or a configuration
            that.dataSource = kendo.data.DataSource.create(that.options.dataSource);

            // bind to the change event to refresh the widget
            that.dataSource.bind('change', function() {
                that.refresh();
            });

            // trigger a read on the dataSource if one hasn't happened yet
            if (that.options.autoBind) {
                that.dataSource.fetch();
            }
        },

        refresh: function() {
            var that = this,
                view = that.dataSource.view(),
                html = kendo.render(that.template, view);

            that.element.html(html);
        }

    });

    ui.plugin(SocialFeed);

})(jQuery);
/**
 * Created by donbrad on 4/3/17.
 *
 * SponsorBlock Widget
 *
 */


(function($) {
    // shorten references to variables. this is better for uglification
    var kendo = window.kendo,
        ui = kendo.ui,
        widget = ui.Widget;

    var SponsorBlock = widget.extend({
        // initialization code goes here
        init: function(element, options) {
            var that = this;
            // base call to initialize widget

            widget.fn.init.call(this, element, options);

            templateLoader.load('../../../templates/widgets/SponsorBlock.html', function(status) {

                that.template = kendo.template($("#SponsorBlock-tmpl").html());

                that.refresh();
            });
        },

        options: {
            // the name is what it will appear as off the kendo namespace(i.e. kendo.ui.MyWidget).
            // The jQuery plugin would be jQuery.fn.kendoMyWidget.
            name: "SponsorBlock",

            title: "Brought to you by",

            description : "Farm Foward...",

            // other options go here
            template: '<div class="ghp-sponsorblock" style="text-align: center;"> <h3> #:title#</h3> <div> #=description# </div> </div>'

        },


        refresh: function() {
            var that = this;

            var data = {title: that.options.title, description : that.options.description};

            var html = that.template(data);
            //   var html = kendo.render(that.template, view);

            that.element.html(html);
        }

    });

    ui.plugin(SponsorBlock);

})(jQuery);
/**
 * Created by donbrad on 4/3/17.
 *
 * Supporter List Widget
 *
 */


(function($) {
    // shorten references to variables. this is better for uglification
    var kendo = window.kendo,
        ui = kendo.ui,
        Widget = ui.Widget;

    var SupporterList = Widget.extend({
        // initialization code goes here
        init: function(element, options) {
            var that = this;
            // base call to initialize widget
            Widget.fn.init.call(this, element, options);
            templateLoader.load('../../../templates/widgets/SupporterList.html', function (status) {

                that.template = kendo.template($("#SupporterList-tmpl").html());

                that._dataSource();

                that.refresh();
            });

        },

        options: {
            // the name is what it will appear as off the kendo namespace(i.e. kendo.ui.MyWidget).
            // The jQuery plugin would be jQuery.fn.kendoMyWidget.
            name: "SupporterList",
            autoBind: true,

            // other options go here
            template: ""

        },

        _dataSource: function() {
            var that = this;
            // returns the datasource OR creates one if using an array or a configuration
            that.dataSource = kendo.data.DataSource.create(that.options.dataSource);

            // bind to the change event to refresh the widget
            that.dataSource.bind('change', function() {
                that.refresh();
            });

            // trigger a read on the dataSource if one hasn't happened yet
            if (that.options.autoBind) {
                that.dataSource.fetch();
            }
        },

        refresh: function() {
            var that = this,
                view = that.dataSource.view(),
                html = kendo.render(that.template, view);

            that.element.html(html);
        }

    });

    ui.plugin(SupporterList);

})(jQuery);
/* Debounce Resize */
(function(a){var d=a.event,b,c;b=d.special.debouncedresize={setup:function(){a(this).on("resize",b.handler)},teardown:function(){a(this).off("resize",b.handler)},handler:function(a,f){var g=this,h=arguments,e=function(){a.type="debouncedresize";d.dispatch.apply(g,h)};c&&clearTimeout(c);f?e():c=setTimeout(e,b.threshold)},threshold:150}})(jQuery);

// Sticky Plugin v1.0.0 for jQuery
// =============
// Author: Anthony Garand
// Improvements by German M. Bravo (Kronuz) and Ruud Kamphuis (ruudk)
// Improvements by Leonardo C. Daronco (daronco)
// Created: 2/14/2011
// Date: 2/12/2012
// Website: http://labs.anthonygarand.com/sticky
// Description: Makes an element on the page stick on the screen as you scroll
//       It will only set the 'top' and 'position' of your element, you
//       might need to adjust the width in some cases.

(function($) {
  var defaults = {
      topSpacing: 0,
      bottomSpacing: 0,
      className: 'is-sticky',
      wrapperClassName: 'sticky-wrapper',
      center: false,
      getWidthFrom: ''
    },
    $window = $(window),
    $document = $(document),
    sticked = [],
    windowHeight = $window.height(),
    scroller = function() {
      var scrollTop = $window.scrollTop(),
        documentHeight = $document.height(),
        dwh = documentHeight - windowHeight,
        extra = (scrollTop > dwh) ? dwh - scrollTop : 0;

      for (var i = 0; i < sticked.length; i++) {
        var s = sticked[i],
          elementTop = s.stickyWrapper.offset().top,
          etse = elementTop - s.topSpacing - extra;

        if (scrollTop <= etse) {
          if (s.currentTop !== null) {
            s.stickyElement
              .css('position', '')
              .css('top', '');
            s.stickyElement.parent().removeClass(s.className);
            s.currentTop = null;
          }
        }
        else {
          var newTop = documentHeight - s.stickyElement.outerHeight()
            - s.topSpacing - s.bottomSpacing - scrollTop - extra;
          if (newTop < 0) {
            newTop = newTop + s.topSpacing;
          } else {
            newTop = s.topSpacing;
          }
          if (s.currentTop != newTop) {
            s.stickyElement
              .css('position', 'fixed')
              .css('top', newTop);

            if (typeof s.getWidthFrom !== 'undefined') {
              s.stickyElement.css('width', $(s.getWidthFrom).width());
            }

            s.stickyElement.parent().addClass(s.className);
            s.currentTop = newTop;
          }
        }
      }
    },
    resizer = function() {
      windowHeight = $window.height();
    },
    methods = {
      init: function(options) {
        var o = $.extend(defaults, options);
        return this.each(function() {
          var stickyElement = $(this);

          var stickyId = stickyElement.attr('id');
          var wrapper = $('<div></div>')
            .attr('id', stickyId + '-sticky-wrapper')
            .addClass(o.wrapperClassName);
          stickyElement.wrapAll(wrapper);

          if (o.center) {
            stickyElement.parent().css({width:stickyElement.outerWidth(),marginLeft:"auto",marginRight:"auto"});
          }

          if (stickyElement.css("float") == "right") {
            stickyElement.css({"float":"none"}).parent().css({"float":"right"});
          }

          var stickyWrapper = stickyElement.parent();
          stickyWrapper.css('height', stickyElement.outerHeight());
          sticked.push({
            topSpacing: o.topSpacing,
            bottomSpacing: o.bottomSpacing,
            stickyElement: stickyElement,
            currentTop: null,
            stickyWrapper: stickyWrapper,
            className: o.className,
            getWidthFrom: o.getWidthFrom
          });
        });
      },
      update: scroller
    };

  // should be more efficient than using $window.scroll(scroller) and $window.resize(resizer):
  if (window.addEventListener) {
    window.addEventListener('scroll', scroller, false);
    window.addEventListener('resize', resizer, false);
  } else if (window.attachEvent) {
    window.attachEvent('onscroll', scroller);
    window.attachEvent('onresize', resizer);
  }

  $.fn.sticky = function(method) {
    if (methods[method]) {
      return methods[method].apply(this, Array.prototype.slice.call(arguments, 1));
    } else if (typeof method === 'object' || !method ) {
      return methods.init.apply( this, arguments );
    } else {
      $.error('Method ' + method + ' does not exist on jQuery.sticky');
    }
  };
  $(function() {
    setTimeout(scroller, 0);
  });
})(jQuery);

/**
 * Isotope v1.5.25
 * An exquisite jQuery plugin for magical layouts
 * http://isotope.metafizzy.co
 *
 * Commercial use requires one-time license fee
 * http://metafizzy.co/#licenses
 *
 * Copyright 2012 David DeSandro / Metafizzy
 */
(function(a,b,c){"use strict";var d=a.document,e=a.Modernizr,f=function(a){return a.charAt(0).toUpperCase()+a.slice(1)},g="Moz Webkit O Ms".split(" "),h=function(a){var b=d.documentElement.style,c;if(typeof b[a]=="string")return a;a=f(a);for(var e=0,h=g.length;e<h;e++){c=g[e]+a;if(typeof b[c]=="string")return c}},i=h("transform"),j=h("transitionProperty"),k={csstransforms:function(){return!!i},csstransforms3d:function(){var a=!!h("perspective");if(a){var c=" -o- -moz- -ms- -webkit- -khtml- ".split(" "),d="@media ("+c.join("transform-3d),(")+"modernizr)",e=b("<style>"+d+"{#modernizr{height:3px}}"+"</style>").appendTo("head"),f=b('<div id="modernizr" />').appendTo("html");a=f.height()===3,f.remove(),e.remove()}return a},csstransitions:function(){return!!j}},l;if(e)for(l in k)e.hasOwnProperty(l)||e.addTest(l,k[l]);else{e=a.Modernizr={_version:"1.6ish: miniModernizr for Isotope"};var m=" ",n;for(l in k)n=k[l](),e[l]=n,m+=" "+(n?"":"no-")+l;b("html").addClass(m)}if(e.csstransforms){var o=e.csstransforms3d?{translate:function(a){return"translate3d("+a[0]+"px, "+a[1]+"px, 0) "},scale:function(a){return"scale3d("+a+", "+a+", 1) "}}:{translate:function(a){return"translate("+a[0]+"px, "+a[1]+"px) "},scale:function(a){return"scale("+a+") "}},p=function(a,c,d){var e=b.data(a,"isoTransform")||{},f={},g,h={},j;f[c]=d,b.extend(e,f);for(g in e)j=e[g],h[g]=o[g](j);var k=h.translate||"",l=h.scale||"",m=k+l;b.data(a,"isoTransform",e),a.style[i]=m};b.cssNumber.scale=!0,b.cssHooks.scale={set:function(a,b){p(a,"scale",b)},get:function(a,c){var d=b.data(a,"isoTransform");return d&&d.scale?d.scale:1}},b.fx.step.scale=function(a){b.cssHooks.scale.set(a.elem,a.now+a.unit)},b.cssNumber.translate=!0,b.cssHooks.translate={set:function(a,b){p(a,"translate",b)},get:function(a,c){var d=b.data(a,"isoTransform");return d&&d.translate?d.translate:[0,0]}}}var q,r;e.csstransitions&&(q={WebkitTransitionProperty:"webkitTransitionEnd",MozTransitionProperty:"transitionend",OTransitionProperty:"oTransitionEnd otransitionend",transitionProperty:"transitionend"}[j],r=h("transitionDuration"));var s=b.event,t=b.event.handle?"handle":"dispatch",u;s.special.smartresize={setup:function(){b(this).bind("resize",s.special.smartresize.handler)},teardown:function(){b(this).unbind("resize",s.special.smartresize.handler)},handler:function(a,b){var c=this,d=arguments;a.type="smartresize",u&&clearTimeout(u),u=setTimeout(function(){s[t].apply(c,d)},b==="execAsap"?0:100)}},b.fn.smartresize=function(a){return a?this.bind("smartresize",a):this.trigger("smartresize",["execAsap"])},b.Isotope=function(a,c,d){this.element=b(c),this._create(a),this._init(d)};var v=["width","height"],w=b(a);b.Isotope.settings={resizable:!0,layoutMode:"masonry",containerClass:"isotope",itemClass:"isotope-item",hiddenClass:"isotope-hidden",hiddenStyle:{opacity:0,scale:.001},visibleStyle:{opacity:1,scale:1},containerStyle:{position:"relative",overflow:"hidden"},animationEngine:"best-available",animationOptions:{queue:!1,duration:800},sortBy:"original-order",sortAscending:!0,resizesContainer:!0,transformsEnabled:!0,itemPositionDataEnabled:!1},b.Isotope.prototype={_create:function(a){this.options=b.extend({},b.Isotope.settings,a),this.styleQueue=[],this.elemCount=0;var c=this.element[0].style;this.originalStyle={};var d=v.slice(0);for(var e in this.options.containerStyle)d.push(e);for(var f=0,g=d.length;f<g;f++)e=d[f],this.originalStyle[e]=c[e]||"";this.element.css(this.options.containerStyle),this._updateAnimationEngine(),this._updateUsingTransforms();var h={"original-order":function(a,b){return b.elemCount++,b.elemCount},random:function(){return Math.random()}};this.options.getSortData=b.extend(this.options.getSortData,h),this.reloadItems(),this.offset={left:parseInt(this.element.css("padding-left")||0,10),top:parseInt(this.element.css("padding-top")||0,10)};var i=this;setTimeout(function(){i.element.addClass(i.options.containerClass)},0),this.options.resizable&&w.bind("smartresize.isotope",function(){i.resize()}),this.element.delegate("."+this.options.hiddenClass,"click",function(){return!1})},_getAtoms:function(a){var b=this.options.itemSelector,c=b?a.filter(b).add(a.find(b)):a,d={position:"absolute"};return c=c.filter(function(a,b){return b.nodeType===1}),this.usingTransforms&&(d.left=0,d.top=0),c.css(d).addClass(this.options.itemClass),this.updateSortData(c,!0),c},_init:function(a){this.$filteredAtoms=this._filter(this.$allAtoms),this._sort(),this.reLayout(a)},option:function(a){if(b.isPlainObject(a)){this.options=b.extend(!0,this.options,a);var c;for(var d in a)c="_update"+f(d),this[c]&&this[c]()}},_updateAnimationEngine:function(){var a=this.options.animationEngine.toLowerCase().replace(/[ _\-]/g,""),b;switch(a){case"css":case"none":b=!1;break;case"jquery":b=!0;break;default:b=!e.csstransitions}this.isUsingJQueryAnimation=b,this._updateUsingTransforms()},_updateTransformsEnabled:function(){this._updateUsingTransforms()},_updateUsingTransforms:function(){var a=this.usingTransforms=this.options.transformsEnabled&&e.csstransforms&&e.csstransitions&&!this.isUsingJQueryAnimation;a||(delete this.options.hiddenStyle.scale,delete this.options.visibleStyle.scale),this.getPositionStyles=a?this._translate:this._positionAbs},_filter:function(a){var b=this.options.filter===""?"*":this.options.filter;if(!b)return a;var c=this.options.hiddenClass,d="."+c,e=a.filter(d),f=e;if(b!=="*"){f=e.filter(b);var g=a.not(d).not(b).addClass(c);this.styleQueue.push({$el:g,style:this.options.hiddenStyle})}return this.styleQueue.push({$el:f,style:this.options.visibleStyle}),f.removeClass(c),a.filter(b)},updateSortData:function(a,c){var d=this,e=this.options.getSortData,f,g;a.each(function(){f=b(this),g={};for(var a in e)!c&&a==="original-order"?g[a]=b.data(this,"isotope-sort-data")[a]:g[a]=e[a](f,d);b.data(this,"isotope-sort-data",g)})},_sort:function(){var a=this.options.sortBy,b=this._getSorter,c=this.options.sortAscending?1:-1,d=function(d,e){var f=b(d,a),g=b(e,a);return f===g&&a!=="original-order"&&(f=b(d,"original-order"),g=b(e,"original-order")),(f>g?1:f<g?-1:0)*c};this.$filteredAtoms.sort(d)},_getSorter:function(a,c){return b.data(a,"isotope-sort-data")[c]},_translate:function(a,b){return{translate:[a,b]}},_positionAbs:function(a,b){return{left:a,top:b}},_pushPosition:function(a,b,c){b=Math.round(b+this.offset.left),c=Math.round(c+this.offset.top);var d=this.getPositionStyles(b,c);this.styleQueue.push({$el:a,style:d}),this.options.itemPositionDataEnabled&&a.data("isotope-item-position",{x:b,y:c})},layout:function(a,b){var c=this.options.layoutMode;this["_"+c+"Layout"](a);if(this.options.resizesContainer){var d=this["_"+c+"GetContainerSize"]();this.styleQueue.push({$el:this.element,style:d})}this._processStyleQueue(a,b),this.isLaidOut=!0},_processStyleQueue:function(a,c){var d=this.isLaidOut?this.isUsingJQueryAnimation?"animate":"css":"css",f=this.options.animationOptions,g=this.options.onLayout,h,i,j,k;i=function(a,b){b.$el[d](b.style,f)};if(this._isInserting&&this.isUsingJQueryAnimation)i=function(a,b){h=b.$el.hasClass("no-transition")?"css":d,b.$el[h](b.style,f)};else if(c||g||f.complete){var l=!1,m=[c,g,f.complete],n=this;j=!0,k=function(){if(l)return;var b;for(var c=0,d=m.length;c<d;c++)b=m[c],typeof b=="function"&&b.call(n.element,a,n);l=!0};if(this.isUsingJQueryAnimation&&d==="animate")f.complete=k,j=!1;else if(e.csstransitions){var o=0,p=this.styleQueue[0],s=p&&p.$el,t;while(!s||!s.length){t=this.styleQueue[o++];if(!t)return;s=t.$el}var u=parseFloat(getComputedStyle(s[0])[r]);u>0&&(i=function(a,b){b.$el[d](b.style,f).one(q,k)},j=!1)}}b.each(this.styleQueue,i),j&&k(),this.styleQueue=[]},resize:function(){this["_"+this.options.layoutMode+"ResizeChanged"]()&&this.reLayout()},reLayout:function(a){this["_"+this.options.layoutMode+"Reset"](),this.layout(this.$filteredAtoms,a)},addItems:function(a,b){var c=this._getAtoms(a);this.$allAtoms=this.$allAtoms.add(c),b&&b(c)},insert:function(a,b){this.element.append(a);var c=this;this.addItems(a,function(a){var d=c._filter(a);c._addHideAppended(d),c._sort(),c.reLayout(),c._revealAppended(d,b)})},appended:function(a,b){var c=this;this.addItems(a,function(a){c._addHideAppended(a),c.layout(a),c._revealAppended(a,b)})},_addHideAppended:function(a){this.$filteredAtoms=this.$filteredAtoms.add(a),a.addClass("no-transition"),this._isInserting=!0,this.styleQueue.push({$el:a,style:this.options.hiddenStyle})},_revealAppended:function(a,b){var c=this;setTimeout(function(){a.removeClass("no-transition"),c.styleQueue.push({$el:a,style:c.options.visibleStyle}),c._isInserting=!1,c._processStyleQueue(a,b)},10)},reloadItems:function(){this.$allAtoms=this._getAtoms(this.element.children())},remove:function(a,b){this.$allAtoms=this.$allAtoms.not(a),this.$filteredAtoms=this.$filteredAtoms.not(a);var c=this,d=function(){a.remove(),b&&b.call(c.element)};a.filter(":not(."+this.options.hiddenClass+")").length?(this.styleQueue.push({$el:a,style:this.options.hiddenStyle}),this._sort(),this.reLayout(d)):d()},shuffle:function(a){this.updateSortData(this.$allAtoms),this.options.sortBy="random",this._sort(),this.reLayout(a)},destroy:function(){var a=this.usingTransforms,b=this.options;this.$allAtoms.removeClass(b.hiddenClass+" "+b.itemClass).each(function(){var b=this.style;b.position="",b.top="",b.left="",b.opacity="",a&&(b[i]="")});var c=this.element[0].style;for(var d in this.originalStyle)c[d]=this.originalStyle[d];this.element.unbind(".isotope").undelegate("."+b.hiddenClass,"click").removeClass(b.containerClass).removeData("isotope"),w.unbind(".isotope")},_getSegments:function(a){var b=this.options.layoutMode,c=a?"rowHeight":"columnWidth",d=a?"height":"width",e=a?"rows":"cols",g=this.element[d](),h,i=this.options[b]&&this.options[b][c]||this.$filteredAtoms["outer"+f(d)](!0)||g;h=Math.floor(g/i),h=Math.max(h,1),this[b][e]=h,this[b][c]=i},_checkIfSegmentsChanged:function(a){var b=this.options.layoutMode,c=a?"rows":"cols",d=this[b][c];return this._getSegments(a),this[b][c]!==d},_masonryReset:function(){this.masonry={},this._getSegments();var a=this.masonry.cols;this.masonry.colYs=[];while(a--)this.masonry.colYs.push(0)},_masonryLayout:function(a){var c=this,d=c.masonry;a.each(function(){var a=b(this),e=Math.ceil(a.outerWidth(!0)/d.columnWidth);e=Math.min(e,d.cols);if(e===1)c._masonryPlaceBrick(a,d.colYs);else{var f=d.cols+1-e,g=[],h,i;for(i=0;i<f;i++)h=d.colYs.slice(i,i+e),g[i]=Math.max.apply(Math,h);c._masonryPlaceBrick(a,g)}})},_masonryPlaceBrick:function(a,b){var c=Math.min.apply(Math,b),d=0;for(var e=0,f=b.length;e<f;e++)if(b[e]===c){d=e;break}var g=this.masonry.columnWidth*d,h=c;this._pushPosition(a,g,h);var i=c+a.outerHeight(!0),j=this.masonry.cols+1-f;for(e=0;e<j;e++)this.masonry.colYs[d+e]=i},_masonryGetContainerSize:function(){var a=Math.max.apply(Math,this.masonry.colYs);return{height:a}},_masonryResizeChanged:function(){return this._checkIfSegmentsChanged()},_fitRowsReset:function(){this.fitRows={x:0,y:0,height:0}},_fitRowsLayout:function(a){var c=this,d=this.element.width(),e=this.fitRows;a.each(function(){var a=b(this),f=a.outerWidth(!0),g=a.outerHeight(!0);e.x!==0&&f+e.x>d&&(e.x=0,e.y=e.height),c._pushPosition(a,e.x,e.y),e.height=Math.max(e.y+g,e.height),e.x+=f})},_fitRowsGetContainerSize:function(){return{height:this.fitRows.height}},_fitRowsResizeChanged:function(){return!0},_cellsByRowReset:function(){this.cellsByRow={index:0},this._getSegments(),this._getSegments(!0)},_cellsByRowLayout:function(a){var c=this,d=this.cellsByRow;a.each(function(){var a=b(this),e=d.index%d.cols,f=Math.floor(d.index/d.cols),g=(e+.5)*d.columnWidth-a.outerWidth(!0)/2,h=(f+.5)*d.rowHeight-a.outerHeight(!0)/2;c._pushPosition(a,g,h),d.index++})},_cellsByRowGetContainerSize:function(){return{height:Math.ceil(this.$filteredAtoms.length/this.cellsByRow.cols)*this.cellsByRow.rowHeight+this.offset.top}},_cellsByRowResizeChanged:function(){return this._checkIfSegmentsChanged()},_straightDownReset:function(){this.straightDown={y:0}},_straightDownLayout:function(a){var c=this;a.each(function(a){var d=b(this);c._pushPosition(d,0,c.straightDown.y),c.straightDown.y+=d.outerHeight(!0)})},_straightDownGetContainerSize:function(){return{height:this.straightDown.y}},_straightDownResizeChanged:function(){return!0},_masonryHorizontalReset:function(){this.masonryHorizontal={},this._getSegments(!0);var a=this.masonryHorizontal.rows;this.masonryHorizontal.rowXs=[];while(a--)this.masonryHorizontal.rowXs.push(0)},_masonryHorizontalLayout:function(a){var c=this,d=c.masonryHorizontal;a.each(function(){var a=b(this),e=Math.ceil(a.outerHeight(!0)/d.rowHeight);e=Math.min(e,d.rows);if(e===1)c._masonryHorizontalPlaceBrick(a,d.rowXs);else{var f=d.rows+1-e,g=[],h,i;for(i=0;i<f;i++)h=d.rowXs.slice(i,i+e),g[i]=Math.max.apply(Math,h);c._masonryHorizontalPlaceBrick(a,g)}})},_masonryHorizontalPlaceBrick:function(a,b){var c=Math.min.apply(Math,b),d=0;for(var e=0,f=b.length;e<f;e++)if(b[e]===c){d=e;break}var g=c,h=this.masonryHorizontal.rowHeight*d;this._pushPosition(a,g,h);var i=c+a.outerWidth(!0),j=this.masonryHorizontal.rows+1-f;for(e=0;e<j;e++)this.masonryHorizontal.rowXs[d+e]=i},_masonryHorizontalGetContainerSize:function(){var a=Math.max.apply(Math,this.masonryHorizontal.rowXs);return{width:a}},_masonryHorizontalResizeChanged:function(){return this._checkIfSegmentsChanged(!0)},_fitColumnsReset:function(){this.fitColumns={x:0,y:0,width:0}},_fitColumnsLayout:function(a){var c=this,d=this.element.height(),e=this.fitColumns;a.each(function(){var a=b(this),f=a.outerWidth(!0),g=a.outerHeight(!0);e.y!==0&&g+e.y>d&&(e.x=e.width,e.y=0),c._pushPosition(a,e.x,e.y),e.width=Math.max(e.x+f,e.width),e.y+=g})},_fitColumnsGetContainerSize:function(){return{width:this.fitColumns.width}},_fitColumnsResizeChanged:function(){return!0},_cellsByColumnReset:function(){this.cellsByColumn={index:0},this._getSegments(),this._getSegments(!0)},_cellsByColumnLayout:function(a){var c=this,d=this.cellsByColumn;a.each(function(){var a=b(this),e=Math.floor(d.index/d.rows),f=d.index%d.rows,g=(e+.5)*d.columnWidth-a.outerWidth(!0)/2,h=(f+.5)*d.rowHeight-a.outerHeight(!0)/2;c._pushPosition(a,g,h),d.index++})},_cellsByColumnGetContainerSize:function(){return{width:Math.ceil(this.$filteredAtoms.length/this.cellsByColumn.rows)*this.cellsByColumn.columnWidth}},_cellsByColumnResizeChanged:function(){return this._checkIfSegmentsChanged(!0)},_straightAcrossReset:function(){this.straightAcross={x:0}},_straightAcrossLayout:function(a){var c=this;a.each(function(a){var d=b(this);c._pushPosition(d,c.straightAcross.x,0),c.straightAcross.x+=d.outerWidth(!0)})},_straightAcrossGetContainerSize:function(){return{width:this.straightAcross.x}},_straightAcrossResizeChanged:function(){return!0}},b.fn.imagesLoaded=function(a){function h(){a.call(c,d)}function i(a){var c=a.target;c.src!==f&&b.inArray(c,g)===-1&&(g.push(c),--e<=0&&(setTimeout(h),d.unbind(".imagesLoaded",i)))}var c=this,d=c.find("img").add(c.filter("img")),e=d.length,f="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==",g=[];return e||h(),d.bind("load.imagesLoaded error.imagesLoaded",i).each(function(){var a=this.src;this.src=f,this.src=a}),c};var x=function(b){a.console&&a.console.error(b)};b.fn.isotope=function(a,c){if(typeof a=="string"){var d=Array.prototype.slice.call(arguments,1);this.each(function(){var c=b.data(this,"isotope");if(!c){x("cannot call methods on isotope prior to initialization; attempted to call method '"+a+"'");return}if(!b.isFunction(c[a])||a.charAt(0)==="_"){x("no such method '"+a+"' for isotope instance");return}c[a].apply(c,d)})}else this.each(function(){var d=b.data(this,"isotope");d?(d.option(a),d._init(c)):b.data(this,"isotope",new b.Isotope(a,this,c))});return this}})(window,jQuery);

/*
 * Isotope custom layout mode that extends masonry in order to work with percentage-sized columns
 */

(function(window, $) {
	$.extend($.Isotope.prototype, {
		_sloppyMasonryReset : function() {
			// layout-specific props
			var containerSize = this.element.width(),
				segmentSize = this.options.sloppyMasonry && this.options.sloppyMasonry.columnWidth ||
				// or use the size of the first item, i.e. outerWidth
				this.$filteredAtoms.outerWidth(true) ||
				// if there's no items, use size of container
				containerSize;
			this.sloppyMasonry = {
				cols : Math.round(containerSize / segmentSize),
				columnWidth : segmentSize
			};
			var i = this.sloppyMasonry.cols;
			this.sloppyMasonry.colYs = [];
			while (i--) {
				this.sloppyMasonry.colYs.push(0);
			}
		},
		_sloppyMasonryLayout : function($elems) {
			var instance = this, props = instance.sloppyMasonry;
			$elems.each(function() {
				var $this = $(this),
				// how many columns does this brick span
				colSpan = Math.round($this.outerWidth(true) / props.columnWidth);
				colSpan = Math.min(colSpan, props.cols);
				if (colSpan === 1) {
					// if brick spans only one column,
					// just like singleMode
					instance._sloppyMasonryPlaceBrick($this, props.colYs);
				} else {
					// brick spans more than one column
					// how many different places could
					// this brick fit horizontally
					var groupCount = props.cols + 1 - colSpan, groupY = [], groupColY, i;

					// for each group potential
					// horizontal position
					for (i = 0; i < groupCount; i++) {
						// make an array of colY values
						// for that one group
						groupColY = props.colYs.slice(i, i + colSpan);
						// and get the max value of the
						// array
						groupY[i] = Math.max.apply(Math, groupColY);
					}

					instance._sloppyMasonryPlaceBrick($this, groupY);
				}
			});
		},
		_sloppyMasonryPlaceBrick : function($brick, setY) {
			// get the minimum Y value from the columns
			var minimumY = Math.min.apply(Math, setY), shortCol = 0;

			// Find index of short column, the first from the left
			for ( var i = 0, len = setY.length; i < len; i++) {
				if (setY[i] === minimumY) {
					shortCol = i;
					break;
				}
			}

			// position the brick
			var x = this.sloppyMasonry.columnWidth * shortCol, y = minimumY;
			this._pushPosition($brick, x, y);

			// apply setHeight to necessary columns
			var setHeight = minimumY + $brick.outerHeight(true), setSpan = this.sloppyMasonry.cols + 1 - len;
			for (i = 0; i < setSpan; i++) {
				this.sloppyMasonry.colYs[shortCol + i] = setHeight;
			}

		},
		_sloppyMasonryGetContainerSize : function() {
			var containerHeight = Math.max.apply(Math, this.sloppyMasonry.colYs);
			return {
				height : containerHeight
			};
		},
		_sloppyMasonryResizeChanged : function() {
			return true;
		}
	});
})(this, this.jQuery);



/*
* touchSwipe - jQuery Plugin
* https://github.com/mattbryson/TouchSwipe-Jquery-Plugin
* http://labs.skinkers.com/touchSwipe/
* http://plugins.jquery.com/project/touchSwipe
*
* Copyright (c) 2010 Matt Bryson (www.skinkers.com)
* Dual licensed under the MIT or GPL Version 2 licenses.
*
* $version: 1.3.3
*/

(function(g){function P(c){if(c&&void 0===c.allowPageScroll&&(void 0!==c.swipe||void 0!==c.swipeStatus))c.allowPageScroll=G;c||(c={});c=g.extend({},g.fn.swipe.defaults,c);return this.each(function(){var b=g(this),f=b.data(w);f||(f=new W(this,c),b.data(w,f))})}function W(c,b){var f,p,r,s;function H(a){var a=a.originalEvent,c,Q=n?a.touches[0]:a;d=R;n?h=a.touches.length:a.preventDefault();i=0;j=null;k=0;!n||h===b.fingers||b.fingers===x?(r=f=Q.pageX,s=p=Q.pageY,y=(new Date).getTime(),b.swipeStatus&&(c= l(a,d))):t(a);if(!1===c)return d=m,l(a,d),c;e.bind(I,J);e.bind(K,L)}function J(a){a=a.originalEvent;if(!(d===q||d===m)){var c,e=n?a.touches[0]:a;f=e.pageX;p=e.pageY;u=(new Date).getTime();j=S();n&&(h=a.touches.length);d=z;var e=a,g=j;if(b.allowPageScroll===G)e.preventDefault();else{var o=b.allowPageScroll===T;switch(g){case v:(b.swipeLeft&&o||!o&&b.allowPageScroll!=M)&&e.preventDefault();break;case A:(b.swipeRight&&o||!o&&b.allowPageScroll!=M)&&e.preventDefault();break;case B:(b.swipeUp&&o||!o&&b.allowPageScroll!= N)&&e.preventDefault();break;case C:(b.swipeDown&&o||!o&&b.allowPageScroll!=N)&&e.preventDefault()}}h===b.fingers||b.fingers===x||!n?(i=U(),k=u-y,b.swipeStatus&&(c=l(a,d,j,i,k)),b.triggerOnTouchEnd||(e=!(b.maxTimeThreshold?!(k>=b.maxTimeThreshold):1),!0===D()?(d=q,c=l(a,d)):e&&(d=m,l(a,d)))):(d=m,l(a,d));!1===c&&(d=m,l(a,d))}}function L(a){a=a.originalEvent;a.preventDefault();u=(new Date).getTime();i=U();j=S();k=u-y;if(b.triggerOnTouchEnd||!1===b.triggerOnTouchEnd&&d===z)if(d=q,(h===b.fingers||b.fingers=== x||!n)&&0!==f){var c=!(b.maxTimeThreshold?!(k>=b.maxTimeThreshold):1);if((!0===D()||null===D())&&!c)l(a,d);else if(c||!1===D())d=m,l(a,d)}else d=m,l(a,d);else d===z&&(d=m,l(a,d));e.unbind(I,J,!1);e.unbind(K,L,!1)}function t(){y=u=p=f=s=r=h=0}function l(a,c){var d=void 0;b.swipeStatus&&(d=b.swipeStatus.call(e,a,c,j||null,i||0,k||0,h));if(c===m&&b.click&&(1===h||!n)&&(isNaN(i)||0===i))d=b.click.call(e,a,a.target);if(c==q)switch(b.swipe&&(d=b.swipe.call(e,a,j,i,k,h)),j){case v:b.swipeLeft&&(d=b.swipeLeft.call(e, a,j,i,k,h));break;case A:b.swipeRight&&(d=b.swipeRight.call(e,a,j,i,k,h));break;case B:b.swipeUp&&(d=b.swipeUp.call(e,a,j,i,k,h));break;case C:b.swipeDown&&(d=b.swipeDown.call(e,a,j,i,k,h))}(c===m||c===q)&&t(a);return d}function D(){return null!==b.threshold?i>=b.threshold:null}function U(){return Math.round(Math.sqrt(Math.pow(f-r,2)+Math.pow(p-s,2)))}function S(){var a;a=Math.atan2(p-s,r-f);a=Math.round(180*a/Math.PI);0>a&&(a=360-Math.abs(a));return 45>=a&&0<=a?v:360>=a&&315<=a?v:135<=a&&225>=a? A:45<a&&135>a?C:B}function V(){e.unbind(E,H);e.unbind(F,t);e.unbind(I,J);e.unbind(K,L)}var O=n||!b.fallbackToMouseEvents,E=O?"touchstart":"mousedown",I=O?"touchmove":"mousemove",K=O?"touchend":"mouseup",F="touchcancel",i=0,j=null,k=0,e=g(c),d="start",h=0,y=p=f=s=r=0,u=0;try{e.bind(E,H),e.bind(F,t)}catch(P){g.error("events not supported "+E+","+F+" on jQuery.swipe")}this.enable=function(){e.bind(E,H);e.bind(F,t);return e};this.disable=function(){V();return e};this.destroy=function(){V();e.data(w,null); return e}}var v="left",A="right",B="up",C="down",G="none",T="auto",M="horizontal",N="vertical",x="all",R="start",z="move",q="end",m="cancel",n="ontouchstart"in window,w="TouchSwipe";g.fn.swipe=function(c){var b=g(this),f=b.data(w);if(f&&"string"===typeof c){if(f[c])return f[c].apply(this,Array.prototype.slice.call(arguments,1));g.error("Method "+c+" does not exist on jQuery.swipe")}else if(!f&&("object"===typeof c||!c))return P.apply(this,arguments);return b};g.fn.swipe.defaults={fingers:1,threshold:75, maxTimeThreshold:null,swipe:null,swipeLeft:null,swipeRight:null,swipeUp:null,swipeDown:null,swipeStatus:null,click:null,triggerOnTouchEnd:!0,allowPageScroll:"auto",fallbackToMouseEvents:!0};g.fn.swipe.phases={PHASE_START:R,PHASE_MOVE:z,PHASE_END:q,PHASE_CANCEL:m};g.fn.swipe.directions={LEFT:v,RIGHT:A,UP:B,DOWN:C};g.fn.swipe.pageScroll={NONE:G,HORIZONTAL:M,VERTICAL:N,AUTO:T};g.fn.swipe.fingers={ONE:1,TWO:2,THREE:3,ALL:x}})(jQuery);

/*
 * jQuery throttle / debounce - v1.1 - 3/7/2010
 * http://benalman.com/projects/jquery-throttle-debounce-plugin/
 * 
 * Copyright (c) 2010 "Cowboy" Ben Alman
 * Dual licensed under the MIT and GPL licenses.
 * http://benalman.com/about/license/
 */
(function(b,c){var $=b.jQuery||b.Cowboy||(b.Cowboy={}),a;$.throttle=a=function(e,f,j,i){var h,d=0;if(typeof f!=="boolean"){i=j;j=f;f=c}function g(){var o=this,m=+new Date()-d,n=arguments;function l(){d=+new Date();j.apply(o,n)}function k(){h=c}if(i&&!h){l()}h&&clearTimeout(h);if(i===c&&m>e){l()}else{if(f!==true){h=setTimeout(i?k:l,i===c?e-m:e)}}}if($.guid){g.guid=j.guid=j.guid||$.guid++}return g};$.debounce=function(d,e,f){return f===c?a(d,e,false):a(d,f,e!==false)}})(this);

/**
 * jQuery.LocalScroll - Animated scrolling navigation, using anchors.
 * Copyright (c) 2007-2009 Ariel Flesler - aflesler(at)gmail(dot)com | http://flesler.blogspot.com
 * Dual licensed under MIT and GPL.
 * Date: 3/11/2009
 * @author Ariel Flesler
 * @version 1.2.7
 **/
;(function($){var l=location.href.replace(/#.*/,'');var g=$.localScroll=function(a){$('body').localScroll(a)};g.defaults={duration:1e3,axis:'y',event:'click',stop:true,target:window,reset:true};g.hash=function(a){if(location.hash){a=$.extend({},g.defaults,a);a.hash=false;if(a.reset){var e=a.duration;delete a.duration;$(a.target).scrollTo(0,a);a.duration=e}i(0,location,a)}};$.fn.localScroll=function(b){b=$.extend({},g.defaults,b);return b.lazy?this.bind(b.event,function(a){var e=$([a.target,a.target.parentNode]).filter(d)[0];if(e)i(a,e,b)}):this.find('a,area').filter(d).bind(b.event,function(a){i(a,this,b)}).end().end();function d(){return!!this.href&&!!this.hash&&this.href.replace(this.hash,'')==l&&(!b.filter||$(this).is(b.filter))}};function i(a,e,b){var d=e.hash.slice(1),f=document.getElementById(d)||document.getElementsByName(d)[0];if(!f)return;if(a)a.preventDefault();var h=$(b.target);if(b.lock&&h.is(':animated')||b.onBefore&&b.onBefore.call(b,a,f,h)===false)return;if(b.stop)h.stop(true);if(b.hash){var j=f.id==d?'id':'name',k=$('<a> </a>').attr(j,d).css({position:'absolute',top:$(window).scrollTop(),left:$(window).scrollLeft()});f[j]='';$('body').prepend(k);location=e.hash;k.remove();f[j]=d}h.scrollTo(f,b).trigger('notify.serialScroll',[f])}})(jQuery);

/*!
 * jQuery imagesLoaded plugin v2.1.1
 * http://github.com/desandro/imagesloaded
 * MIT License. by Paul Irish et al.
 */
(function(a,b){var c="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";a.fn.imagesLoaded=function(l){var i=this,n=a.isFunction(a.Deferred)?a.Deferred():0,m=a.isFunction(n.notify),f=i.find("img").add(i.filter("img")),g=[],k=[],h=[];if(a.isPlainObject(l)){a.each(l,function(o,p){if(o==="callback"){l=p}else{if(n){n[o](p)}}})}function j(){var o=a(k),p=a(h);
if(n){if(h.length){n.reject(f,o,p)}else{n.resolve(f)}}if(a.isFunction(l)){l.call(i,f,o,p)}}function e(o){d(o.target,o.type==="error")}function d(o,p){if(o.src===c||a.inArray(o,g)!==-1){return}g.push(o);if(p){h.push(o)}else{k.push(o)}a.data(o,"imagesLoaded",{isBroken:p,src:o.src});if(m){n.notifyWith(a(o),[p,f,a(k),a(h)])}if(f.length===g.length){setTimeout(j);f.unbind(".imagesLoaded",e)}}if(!f.length){j()}else{f.bind("load.imagesLoaded error.imagesLoaded",e).each(function(o,q){var r=q.src;var p=a.data(q,"imagesLoaded");
if(p&&p.src===r){d(q,p.isBroken);return}if(q.complete&&q.naturalWidth!==b){d(q,q.naturalWidth===0||q.naturalHeight===0);return}if(q.readyState||q.complete){q.src=c;q.src=r}})}return n?n.promise(i):i}})(jQuery);


/*
 * jQuery Easing v1.3 - http://gsgd.co.uk/sandbox/jquery/easing/
 
*/

// t: current time, b: begInnIng value, c: change In value, d: duration
jQuery.easing['jswing'] = jQuery.easing['swing'];

jQuery.extend( jQuery.easing,
{
	def: 'easeOutQuad',
	swing: function (x, t, b, c, d) {
		//alert(jQuery.easing.default);
		return jQuery.easing[jQuery.easing.def](x, t, b, c, d);
	},
	easeInQuad: function (x, t, b, c, d) {
		return c*(t/=d)*t + b;
	},
	easeOutQuad: function (x, t, b, c, d) {
		return -c *(t/=d)*(t-2) + b;
	},
	easeInOutQuad: function (x, t, b, c, d) {
		if ((t/=d/2) < 1) return c/2*t*t + b;
		return -c/2 * ((--t)*(t-2) - 1) + b;
	},
	easeInCubic: function (x, t, b, c, d) {
		return c*(t/=d)*t*t + b;
	},
	easeOutCubic: function (x, t, b, c, d) {
		return c*((t=t/d-1)*t*t + 1) + b;
	},
	easeInOutCubic: function (x, t, b, c, d) {
		if ((t/=d/2) < 1) return c/2*t*t*t + b;
		return c/2*((t-=2)*t*t + 2) + b;
	},
	easeInQuart: function (x, t, b, c, d) {
		return c*(t/=d)*t*t*t + b;
	},
	easeOutQuart: function (x, t, b, c, d) {
		return -c * ((t=t/d-1)*t*t*t - 1) + b;
	},
	easeInOutQuart: function (x, t, b, c, d) {
		if ((t/=d/2) < 1) return c/2*t*t*t*t + b;
		return -c/2 * ((t-=2)*t*t*t - 2) + b;
	},
	easeInQuint: function (x, t, b, c, d) {
		return c*(t/=d)*t*t*t*t + b;
	},
	easeOutQuint: function (x, t, b, c, d) {
		return c*((t=t/d-1)*t*t*t*t + 1) + b;
	},
	easeInOutQuint: function (x, t, b, c, d) {
		if ((t/=d/2) < 1) return c/2*t*t*t*t*t + b;
		return c/2*((t-=2)*t*t*t*t + 2) + b;
	},
	easeInSine: function (x, t, b, c, d) {
		return -c * Math.cos(t/d * (Math.PI/2)) + c + b;
	},
	easeOutSine: function (x, t, b, c, d) {
		return c * Math.sin(t/d * (Math.PI/2)) + b;
	},
	easeInOutSine: function (x, t, b, c, d) {
		return -c/2 * (Math.cos(Math.PI*t/d) - 1) + b;
	},
	easeInExpo: function (x, t, b, c, d) {
		return (t==0) ? b : c * Math.pow(2, 10 * (t/d - 1)) + b;
	},
	easeOutExpo: function (x, t, b, c, d) {
		return (t==d) ? b+c : c * (-Math.pow(2, -10 * t/d) + 1) + b;
	},
	easeInOutExpo: function (x, t, b, c, d) {
		if (t==0) return b;
		if (t==d) return b+c;
		if ((t/=d/2) < 1) return c/2 * Math.pow(2, 10 * (t - 1)) + b;
		return c/2 * (-Math.pow(2, -10 * --t) + 2) + b;
	},
	easeInCirc: function (x, t, b, c, d) {
		return -c * (Math.sqrt(1 - (t/=d)*t) - 1) + b;
	},
	easeOutCirc: function (x, t, b, c, d) {
		return c * Math.sqrt(1 - (t=t/d-1)*t) + b;
	},
	easeInOutCirc: function (x, t, b, c, d) {
		if ((t/=d/2) < 1) return -c/2 * (Math.sqrt(1 - t*t) - 1) + b;
		return c/2 * (Math.sqrt(1 - (t-=2)*t) + 1) + b;
	},
	easeInElastic: function (x, t, b, c, d) {
		var s=1.70158;var p=0;var a=c;
		if (t==0) return b;  if ((t/=d)==1) return b+c;  if (!p) p=d*.3;
		if (a < Math.abs(c)) { a=c; var s=p/4; }
		else var s = p/(2*Math.PI) * Math.asin (c/a);
		return -(a*Math.pow(2,10*(t-=1)) * Math.sin( (t*d-s)*(2*Math.PI)/p )) + b;
	},
	easeOutElastic: function (x, t, b, c, d) {
		var s=1.70158;var p=0;var a=c;
		if (t==0) return b;  if ((t/=d)==1) return b+c;  if (!p) p=d*.3;
		if (a < Math.abs(c)) { a=c; var s=p/4; }
		else var s = p/(2*Math.PI) * Math.asin (c/a);
		return a*Math.pow(2,-10*t) * Math.sin( (t*d-s)*(2*Math.PI)/p ) + c + b;
	},
	easeInOutElastic: function (x, t, b, c, d) {
		var s=1.70158;var p=0;var a=c;
		if (t==0) return b;  if ((t/=d/2)==2) return b+c;  if (!p) p=d*(.3*1.5);
		if (a < Math.abs(c)) { a=c; var s=p/4; }
		else var s = p/(2*Math.PI) * Math.asin (c/a);
		if (t < 1) return -.5*(a*Math.pow(2,10*(t-=1)) * Math.sin( (t*d-s)*(2*Math.PI)/p )) + b;
		return a*Math.pow(2,-10*(t-=1)) * Math.sin( (t*d-s)*(2*Math.PI)/p )*.5 + c + b;
	},
	easeInBack: function (x, t, b, c, d, s) {
		if (s == undefined) s = 1.70158;
		return c*(t/=d)*t*((s+1)*t - s) + b;
	},
	easeOutBack: function (x, t, b, c, d, s) {
		if (s == undefined) s = 1.70158;
		return c*((t=t/d-1)*t*((s+1)*t + s) + 1) + b;
	},
	easeInOutBack: function (x, t, b, c, d, s) {
		if (s == undefined) s = 1.70158; 
		if ((t/=d/2) < 1) return c/2*(t*t*(((s*=(1.525))+1)*t - s)) + b;
		return c/2*((t-=2)*t*(((s*=(1.525))+1)*t + s) + 2) + b;
	},
	easeInBounce: function (x, t, b, c, d) {
		return c - jQuery.easing.easeOutBounce (x, d-t, 0, c, d) + b;
	},
	easeOutBounce: function (x, t, b, c, d) {
		if ((t/=d) < (1/2.75)) {
			return c*(7.5625*t*t) + b;
		} else if (t < (2/2.75)) {
			return c*(7.5625*(t-=(1.5/2.75))*t + .75) + b;
		} else if (t < (2.5/2.75)) {
			return c*(7.5625*(t-=(2.25/2.75))*t + .9375) + b;
		} else {
			return c*(7.5625*(t-=(2.625/2.75))*t + .984375) + b;
		}
	},
	easeInOutBounce: function (x, t, b, c, d) {
		if (t < d/2) return jQuery.easing.easeInBounce (x, t*2, 0, c, d) * .5 + b;
		return jQuery.easing.easeOutBounce (x, t*2-d, 0, c, d) * .5 + c*.5 + b;
	}
});

/**
 * jQuery.browser.mobile (http://detectmobilebrowser.com/)
 *
 * jQuery.browser.mobile will be true if the browser is a mobile device
 *
 **/
(function(a){(jQuery.browser=jQuery.browser||{}).mobile=/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4))})(navigator.userAgent||navigator.vendor||window.opera);


/*
 * jQuery throttle / debounce - v1.1 - 3/7/2010
 * http://benalman.com/projects/jquery-throttle-debounce-plugin/
 * Copyright (c) 2010 "Cowboy" Ben Alman
 * Dual licensed under the MIT and GPL licenses.
 * http://benalman.com/about/license/
 */
(function(b,c){var $=b.jQuery||b.Cowboy||(b.Cowboy={}),a;$.throttle=a=function(e,f,j,i){var h,d=0;if(typeof f!=="boolean"){i=j;j=f;f=c}function g(){var o=this,m=+new Date()-d,n=arguments;function l(){d=+new Date();j.apply(o,n)}function k(){h=c}if(i&&!h){l()}h&&clearTimeout(h);if(i===c&&m>e){l()}else{if(f!==true){h=setTimeout(i?k:l,i===c?e-m:e)}}}if($.guid){g.guid=j.guid=j.guid||$.guid++}return g};$.debounce=function(d,e,f){return f===c?a(d,e,false):a(d,f,e!==false)}})(this);

/*
 * hoverIntent r7 // 2013.03.11 // jQuery 1.9.1+
 * http://cherne.net/brian/resources/jquery.hoverIntent.html
 */
(function(a){a.fn.hoverIntent=function(m,d,h){var j={interval:100,sensitivity:7,timeout:0};if(typeof m==="object"){j=a.extend(j,m)}else{if(a.isFunction(d)){j=a.extend(j,{over:m,out:d,selector:h})}else{j=a.extend(j,{over:m,out:m,selector:d})}}var l,k,g,f;var e=function(n){l=n.pageX;k=n.pageY};var c=function(o,n){n.hoverIntent_t=clearTimeout(n.hoverIntent_t);if((Math.abs(g-l)+Math.abs(f-k))<j.sensitivity){a(n).off("mousemove.hoverIntent",e);n.hoverIntent_s=1;return j.over.apply(n,[o])}else{g=l;f=k;
n.hoverIntent_t=setTimeout(function(){c(o,n)},j.interval)}};var i=function(o,n){n.hoverIntent_t=clearTimeout(n.hoverIntent_t);n.hoverIntent_s=0;return j.out.apply(n,[o])};var b=function(p){var o=jQuery.extend({},p);var n=this;if(n.hoverIntent_t){n.hoverIntent_t=clearTimeout(n.hoverIntent_t)}if(p.type=="mouseenter"){g=o.pageX;f=o.pageY;a(n).on("mousemove.hoverIntent",e);if(n.hoverIntent_s!=1){n.hoverIntent_t=setTimeout(function(){c(o,n)},j.interval)}}else{a(n).off("mousemove.hoverIntent",e);if(n.hoverIntent_s==1){n.hoverIntent_t=setTimeout(function(){i(o,n)
},j.timeout)}}};return this.on({"mouseenter.hoverIntent":b,"mouseleave.hoverIntent":b},j.selector)}})(jQuery);

/**
 * Copyright (c) 2007-2012 Ariel Flesler - aflesler(at)gmail(dot)com | http://flesler.blogspot.com
 * Dual licensed under MIT and GPL.
 * @author Ariel Flesler
 * @version 1.4.3.1
 */
;(function($){var h=$.scrollTo=function(a,b,c){$(window).scrollTo(a,b,c)};h.defaults={axis:'xy',duration:parseFloat($.fn.jquery)>=1.3?0:1,limit:true};h.window=function(a){return $(window)._scrollable()};$.fn._scrollable=function(){return this.map(function(){var a=this,isWin=!a.nodeName||$.inArray(a.nodeName.toLowerCase(),['iframe','#document','html','body'])!=-1;if(!isWin)return a;var b=(a.contentWindow||a).document||a.ownerDocument||a;return/webkit/i.test(navigator.userAgent)||b.compatMode=='BackCompat'?b.body:b.documentElement})};$.fn.scrollTo=function(e,f,g){if(typeof f=='object'){g=f;f=0}if(typeof g=='function')g={onAfter:g};if(e=='max')e=9e9;g=$.extend({},h.defaults,g);f=f||g.duration;g.queue=g.queue&&g.axis.length>1;if(g.queue)f/=2;g.offset=both(g.offset);g.over=both(g.over);return this._scrollable().each(function(){if(e==null)return;var d=this,$elem=$(d),targ=e,toff,attr={},win=$elem.is('html,body');switch(typeof targ){case'number':case'string':if(/^([+-]=)?\d+(\.\d+)?(px|%)?$/.test(targ)){targ=both(targ);break}targ=$(targ,this);if(!targ.length)return;case'object':if(targ.is||targ.style)toff=(targ=$(targ)).offset()}$.each(g.axis.split(''),function(i,a){var b=a=='x'?'Left':'Top',pos=b.toLowerCase(),key='scroll'+b,old=d[key],max=h.max(d,a);if(toff){attr[key]=toff[pos]+(win?0:old-$elem.offset()[pos]);if(g.margin){attr[key]-=parseInt(targ.css('margin'+b))||0;attr[key]-=parseInt(targ.css('border'+b+'Width'))||0}attr[key]+=g.offset[pos]||0;if(g.over[pos])attr[key]+=targ[a=='x'?'width':'height']()*g.over[pos]}else{var c=targ[pos];attr[key]=c.slice&&c.slice(-1)=='%'?parseFloat(c)/100*max:c}if(g.limit&&/^\d+$/.test(attr[key]))attr[key]=attr[key]<=0?0:Math.min(attr[key],max);if(!i&&g.queue){if(old!=attr[key])animate(g.onAfterFirst);delete attr[key]}});animate(g.onAfter);function animate(a){$elem.animate(attr,f,g.easing,a&&function(){a.call(this,e,g)})}}).end()};h.max=function(a,b){var c=b=='x'?'Width':'Height',scroll='scroll'+c;if(!$(a).is('html,body'))return a[scroll]-$(a)[c.toLowerCase()]();var d='client'+c,html=a.ownerDocument.documentElement,body=a.ownerDocument.body;return Math.max(html[scroll],body[scroll])-Math.min(html[d],body[d])};function both(a){return typeof a=='object'?a:{top:a,left:a}}})(jQuery);


/*!
 * jQuery Cookie Plugin v1.3.1
 * https://github.com/carhartl/jquery-cookie
 *
 * Copyright 2013 Klaus Hartl
 * Released under the MIT license
 */
(function (factory) {
	if (typeof define === 'function' && define.amd && define.amd.jQuery) {
		// AMD. Register as anonymous module.
		define(['jquery'], factory);
	} else {
		// Browser globals.
		factory(jQuery);
	}
}(function ($) {

	var pluses = /\+/g;

	function raw(s) {
		return s;
	}

	function decoded(s) {
		return decodeURIComponent(s.replace(pluses, ' '));
	}

	function converted(s) {
		if (s.indexOf('"') === 0) {
			// This is a quoted cookie as according to RFC2068, unescape
			s = s.slice(1, -1).replace(/\\"/g, '"').replace(/\\\\/g, '\\');
		}
		try {
			return config.json ? JSON.parse(s) : s;
		} catch(er) {}
	}

	var config = $.cookie = function (key, value, options) {

		// write
		if (value !== undefined) {
			options = $.extend({}, config.defaults, options);

			if (typeof options.expires === 'number') {
				var days = options.expires, t = options.expires = new Date();
				t.setDate(t.getDate() + days);
			}

			value = config.json ? JSON.stringify(value) : String(value);

			return (document.cookie = [
				encodeURIComponent(key), '=', config.raw ? value : encodeURIComponent(value),
				options.expires ? '; expires=' + options.expires.toUTCString() : '', // use expires attribute, max-age is not supported by IE
				options.path    ? '; path=' + options.path : '',
				options.domain  ? '; domain=' + options.domain : '',
				options.secure  ? '; secure' : ''
			].join(''));
		}

		// read
		var decode = config.raw ? raw : decoded;
		var cookies = document.cookie.split('; ');
		var result = key ? undefined : {};
		for (var i = 0, l = cookies.length; i < l; i++) {
			var parts = cookies[i].split('=');
			var name = decode(parts.shift());
			var cookie = decode(parts.join('='));

			if (key && key === name) {
				result = converted(cookie);
				break;
			}

			if (!key) {
				result[name] = converted(cookie);
			}
		}

		return result;
	};

	config.defaults = {};

	$.removeCookie = function (key, options) {
		if ($.cookie(key) !== undefined) {
			$.cookie(key, '', $.extend(options, { expires: -1 }));
			return true;
		}
		return false;
	};

}));

/*
 * Swipe 2.0
 * Brad Birdsall
 * Copyright 2013, MIT License
 *
*/
function Swipe(k,e){var f=function(){};var s=function(A){setTimeout(A||f,0)};var z={addEventListener:!!window.addEventListener,touch:("ontouchstart" in window)||window.DocumentTouch&&document instanceof DocumentTouch,transitions:(function(A){var C=["transitionProperty","WebkitTransition","MozTransition","OTransition","msTransition"];for(var B in C){if(A.style[C[B]]!==undefined){return true}}return false})(document.createElement("swipe"))};if(!k){return}var c=k.children[0];var q,d,p;e=e||{};var i=parseInt(e.startSlide,10)||0;
var t=e.speed||300;e.continuous=e.continuous!==undefined?e.continuous:true;function l(){q=c.children;d=new Array(q.length);p=k.getBoundingClientRect().width||k.offsetWidth;c.style.width=(q.length*p)+"px";var B=q.length;while(B--){var A=q[B];A.style.width=p+"px";A.setAttribute("data-index",B);if(z.transitions){A.style.left=(B*-p)+"px";o(B,i>B?-p:(i<B?p:0),0)}}if(!z.transitions){c.style.left=(i*-p)+"px"}k.style.visibility="visible"}function m(){if(i){a(i-1)}else{if(e.continuous){a(q.length-1)}}}function n(){if(i<q.length-1){a(i+1)
}else{if(e.continuous){a(0)}}}function a(D,A){if(i==D){return}if(z.transitions){var C=Math.abs(i-D)-1;var B=Math.abs(i-D)/(i-D);while(C--){o((D>i?D:i)-C-1,p*B,0)}o(i,p*B,A||t);o(D,0,A||t)}else{h(i*-p,D*-p,A||t)}i=D;s(e.callback&&e.callback(i,q[i]))}function o(A,C,B){j(A,C,B);d[A]=C}function j(B,E,D){var A=q[B];var C=A&&A.style;if(!C){return}C.webkitTransitionDuration=C.MozTransitionDuration=C.msTransitionDuration=C.OTransitionDuration=C.transitionDuration=D+"ms";C.webkitTransform="translate("+E+"px,0)translateZ(0)";
C.msTransform=C.MozTransform=C.OTransform="translateX("+E+"px)"}function h(E,D,A){if(!A){c.style.left=D+"px";return}var C=+new Date;var B=setInterval(function(){var F=+new Date-C;if(F>A){c.style.left=D+"px";if(y){v()}e.transitionEnd&&e.transitionEnd.call(event,i,q[i]);clearInterval(B);return}c.style.left=(((D-E)*(Math.floor((F/A)*100)/100))+E)+"px"},4)}var y=e.auto||0;var u;function v(){u=setTimeout(n,y)}function r(){y=0;clearTimeout(u)}var g={};var w={};var x;var b={handleEvent:function(A){switch(A.type){case"touchstart":this.start(A);
break;case"touchmove":this.move(A);break;case"touchend":s(this.end(A));break;case"webkitTransitionEnd":case"msTransitionEnd":case"oTransitionEnd":case"otransitionend":case"transitionend":s(this.transitionEnd(A));break;case"resize":s(l.call());break}if(e.stopPropagation){A.stopPropagation()}},start:function(A){var B=A.touches[0];g={x:B.pageX,y:B.pageY,time:+new Date};x=undefined;w={};c.addEventListener("touchmove",this,false);c.addEventListener("touchend",this,false)},move:function(A){if(A.touches.length>1||A.scale&&A.scale!==1){return
}if(e.disableScroll){A.preventDefault()}var B=A.touches[0];w={x:B.pageX-g.x,y:B.pageY-g.y};if(typeof x=="undefined"){x=!!(x||Math.abs(w.x)<Math.abs(w.y))}if(!x){A.preventDefault();r();w.x=w.x/((!i&&w.x>0||i==q.length-1&&w.x<0)?(Math.abs(w.x)/p+1):1);j(i-1,w.x+d[i-1],0);j(i,w.x+d[i],0);j(i+1,w.x+d[i+1],0)}},end:function(C){var E=+new Date-g.time;var B=Number(E)<250&&Math.abs(w.x)>20||Math.abs(w.x)>p/2;var A=!i&&w.x>0||i==q.length-1&&w.x<0;var D=w.x<0;if(!x){if(B&&!A){if(D){o(i-1,-p,0);o(i,d[i]-p,t);
o(i+1,d[i+1]-p,t);i+=1}else{o(i+1,p,0);o(i,d[i]+p,t);o(i-1,d[i-1]+p,t);i+=-1}e.callback&&e.callback(i,q[i])}else{o(i-1,-p,t);o(i,0,t);o(i+1,p,t)}}c.removeEventListener("touchmove",b,false);c.removeEventListener("touchend",b,false)},transitionEnd:function(A){if(parseInt(A.target.getAttribute("data-index"),10)==i){if(y){v()}e.transitionEnd&&e.transitionEnd.call(A,i,q[i])}}};l();if(y){v()}if(z.addEventListener){if(z.touch){c.addEventListener("touchstart",b,false)}if(z.transitions){c.addEventListener("webkitTransitionEnd",b,false);
c.addEventListener("msTransitionEnd",b,false);c.addEventListener("oTransitionEnd",b,false);c.addEventListener("otransitionend",b,false);c.addEventListener("transitionend",b,false)}window.addEventListener("resize",b,false)}else{window.onresize=function(){l()}}return{setup:function(){l()},slide:function(B,A){r();a(B,A)},prev:function(){r();m()},next:function(){r();n()},getPos:function(){return i},getNumSlides:function(){return q.length},kill:function(){r();c.style.width="auto";c.style.left=0;var B=q.length;
while(B--){var A=q[B];A.style.width="100%";A.style.left=0;if(z.transitions){j(B,0,0)}}if(z.addEventListener){c.removeEventListener("touchstart",b,false);c.removeEventListener("webkitTransitionEnd",b,false);c.removeEventListener("msTransitionEnd",b,false);c.removeEventListener("oTransitionEnd",b,false);c.removeEventListener("otransitionend",b,false);c.removeEventListener("transitionend",b,false);window.removeEventListener("resize",b,false)}else{window.onresize=null}}}}if(window.jQuery||window.Zepto){(function(a){a.fn.Swipe=function(b){return this.each(function(){a(this).data("Swipe",new Swipe(a(this)[0],b))
})}})(window.jQuery||window.Zepto)};

/**
 * Tweetie: A simple Twitter feed plugin
 * Author: Sonny T. <hi@sonnyt.com>, sonnyt.com
 */
/*(function($){$.fn.twittie=function(options){var settings=$.extend({'count':10,'hideReplies':false,'dateFormat':'%b/%d/%Y','template':'{{date}} - {{tweet}}'},options);var linking=function(tweet){var parts=tweet.split(' ');var twit='';for(var i=0,len=parts.length;i<len;i++){var text=parts[i];var link="https://twitter.com/#!/";if(text.indexOf('#')!==-1){text='<a href="'+link+'search/'+text.replace('#','%23').replace(/[^A-Za-z0-9]/,'')+'" target="_blank">'+text+'</a>'}if(text.indexOf('@')!==-1){text='<a href="'+link+text.replace('@','').replace(/[^A-Za-z0-9]/,'')+'" target="_blank">'+text+'</a>'}if(text.indexOf('http://')!==-1){text='<a href="'+text+'" target="_blank">'+text+'</a>'}twit+=text+' '}return twit};var dating=function(twt_date){var time=twt_date.split(' ');twt_date=new Date(Date.parse(time[1]+' '+time[2]+', '+time[5]+' '+time[3]+' UTC'));var months=['January','February','March','April','May','June','July','August','September','October','November','December'];var _date={'%d':twt_date.getDate(),'%m':twt_date.getMonth()+1,'%b':months[twt_date.getMonth()].substr(0,3),'%B':months[twt_date.getMonth()],'%y':String(twt_date.getFullYear()).slice(-2),'%Y':twt_date.getFullYear()};var date=settings.dateFormat;var format=settings.dateFormat.match(/%[dmbByY]/g);for(var i=0,len=format.length;i<len;i++){date=date.replace(format[i],_date[format[i]])}return date};var templating=function(data){var temp=settings.template;var temp_variables=['date','tweet','avatar'];for(var i=0,len=temp_variables.length;i<len;i++){temp=temp.replace(new RegExp('{{'+temp_variables[i]+'}}','gi'),data[temp_variables[i]])}return temp};this.html('<span>Loading...</span>');var that=this;$.getJSON('api/tweet.php',{count:settings.count,exclude_replies:settings.hideReplies},function(twt){that.find('span').fadeOut('fast',function(){that.html('<ul></ul>');for(var i=0;i<settings.count;i++){if(twt[i]){var temp_data={date:dating(twt[i].created_at),tweet:linking(twt[i].text),avatar:'<img src="'+twt[i].user.profile_image_url+'" />'};that.find('ul').append('<li>'+templating(temp_data)+'</li>')}else{break}}})})}})(jQuery);*/

/*
 * jQuery.appear
 * https://github.com/bas2k/jquery.appear/
 * http://code.google.com/p/jquery-appear/
 *
 * Copyright (c) 2009 Michael Hixson
 * Copyright (c) 2012 Alexander Brovikov
 * Licensed under the MIT license (http://www.opensource.org/licenses/mit-license.php)
 */
(function($) {
	$.fn.appear = function(fn, options) {

		var settings = $.extend({

			//arbitrary data to pass to fn
			data: undefined,

			//call fn only on the first appear?
			one: true,

			// X & Y accuracy
			accX: 0,
			accY: 0

		}, options);

		return this.each(function() {

			var t = $(this);

			//whether the element is currently visible
			t.appeared = false;

			if (!fn) {

				//trigger the custom event
				t.trigger('appear', settings.data);
				return;
			}

			var w = $(window);

			//fires the appear event when appropriate
			var check = function() {

				//is the element hidden?
				if (!t.is(':visible')) {

					//it became hidden
					t.appeared = false;
					return;
				}

				//is the element inside the visible window?
				var a = w.scrollLeft();
				var b = w.scrollTop();
				var o = t.offset();
				var x = o.left;
				var y = o.top;

				var ax = settings.accX;
				var ay = settings.accY;
				var th = t.height();
				var wh = w.height();
				var tw = t.width();
				var ww = w.width();

				if (y + th + ay >= b &&
					y <= b + wh + ay &&
					x + tw + ax >= a &&
					x <= a + ww + ax) {

					//trigger the custom event
					if (!t.appeared) t.trigger('appear', settings.data);

				} else {

					//it scrolled out of view
					t.appeared = false;
				}
			};

			//create a modified fn with some additional logic
			var modifiedFn = function() {

				//mark the element as visible
				t.appeared = true;

				//is this supposed to happen only once?
				if (settings.one) {

					//remove the check
					w.unbind('scroll', check);
					var i = $.inArray(check, $.fn.appear.checks);
					if (i >= 0) $.fn.appear.checks.splice(i, 1);
				}

				//trigger the original fn
				fn.apply(this, arguments);
			};

			//bind the modified fn to the element
			if (settings.one) t.one('appear', settings.data, modifiedFn);
			else t.bind('appear', settings.data, modifiedFn);

			//check whenever the window scrolls
			w.scroll(check);

			//check whenever the dom changes
			$.fn.appear.checks.push(check);

			//check now
			(check)();
		});
	};

	//keep a queue of appearance checks
	$.extend($.fn.appear, {

		checks: [],
		timeout: null,

		//process the queue
		checkAll: function() {
			var length = $.fn.appear.checks.length;
			if (length > 0) while (length--) ($.fn.appear.checks[length])();
		},

		//check the queue asynchronously
		run: function() {
			if ($.fn.appear.timeout) clearTimeout($.fn.appear.timeout);
			$.fn.appear.timeout = setTimeout($.fn.appear.checkAll, 20);
		}
	});

	//run checks when these methods are called
	$.each(['append', 'prepend', 'after', 'before', 'attr',
		'removeAttr', 'addClass', 'removeClass', 'toggleClass',
		'remove', 'css', 'show', 'hide'], function(i, n) {
		var old = $.fn[n];
		if (old) {
			$.fn[n] = function() {
				var r = old.apply(this, arguments);
				$.fn.appear.run();
				return r;
			}
		}
	});

})(jQuery);


/*
Plugin: jQuery Parallax
Version 1.1.3
Author: Ian Lunn
Twitter: @IanLunn
Author URL: http://www.ianlunn.co.uk/
Plugin URL: http://www.ianlunn.co.uk/plugins/jquery-parallax/

Dual licensed under the MIT and GPL licenses:
http://www.opensource.org/licenses/mit-license.php
http://www.gnu.org/licenses/gpl.html
*/

(function( $ ){
	var $window = $(window);
	var windowHeight = $window.height();

	$window.resize(function () {
		windowHeight = $window.height();
	});

	$.fn.parallax = function(xpos, speedFactor, outerHeight) {
		var $this = $(this);
		var getHeight;
		var firstTop;
		var paddingTop = 0;
		
		//get the starting position of each element to have parallax applied to it	
		function update (){
			
			$this.each(function(){
								
				firstTop = $this.offset().top;
			});
	
			if (outerHeight) {
				getHeight = function(jqo) {
					return jqo.outerHeight(true);
				};
			} else {
				getHeight = function(jqo) {
					return jqo.height();
				};
			}
				
			// setup defaults if arguments aren't specified
			if (arguments.length < 1 || xpos === null) xpos = "50%";
			if (arguments.length < 2 || speedFactor === null) speedFactor = 0.5;
			if (arguments.length < 3 || outerHeight === null) outerHeight = true;
			
			// function to be called whenever the window is scrolled or resized
			
				var pos = $window.scrollTop();				
	
				$this.each(function(){
					var $element = $(this);
					var top = $element.offset().top;
					var height = getHeight($element);
	
					// Check if totally above or totally below viewport
					if (top + height < pos || top > pos + windowHeight) {
						return;
					}
					
					$this.css('backgroundPosition', xpos + " " + Math.round((firstTop - pos) * speedFactor) + "px");
					
				});
		}		

		$window.bind('scroll', update).resize(update);
		update();
	};
})(jQuery);


/*!
 * jQuery Transit - CSS3 transitions and transformations
 * (c) 2011-2012 Rico Sta. Cruz <rico@ricostacruz.com>
 * MIT Licensed.
 *
 * http://ricostacruz.com/jquery.transit
 * http://github.com/rstacruz/jquery.transit
 */
(function(d){function m(a){if(a in j.style)return a;var b=["Moz","Webkit","O","ms"],c=a.charAt(0).toUpperCase()+a.substr(1);if(a in j.style)return a;for(a=0;a<b.length;++a){var d=b[a]+c;if(d in j.style)return d}}function l(a){"string"===typeof a&&this.parse(a);return this}function q(a,b,c,e){var h=[];d.each(a,function(a){a=d.camelCase(a);a=d.transit.propertyMap[a]||d.cssProps[a]||a;a=a.replace(/([A-Z])/g,function(a){return"-"+a.toLowerCase()});-1===d.inArray(a,h)&&h.push(a)});d.cssEase[c]&&(c=d.cssEase[c]);
var f=""+n(b)+" "+c;0<parseInt(e,10)&&(f+=" "+n(e));var g=[];d.each(h,function(a,b){g.push(b+" "+f)});return g.join(", ")}function f(a,b){b||(d.cssNumber[a]=!0);d.transit.propertyMap[a]=e.transform;d.cssHooks[a]={get:function(b){return d(b).css("transit:transform").get(a)},set:function(b,e){var h=d(b).css("transit:transform");h.setFromString(a,e);d(b).css({"transit:transform":h})}}}function g(a,b){return"string"===typeof a&&!a.match(/^[\-0-9\.]+$/)?a:""+a+b}function n(a){d.fx.speeds[a]&&(a=d.fx.speeds[a]);
return g(a,"ms")}d.transit={version:"0.9.9",propertyMap:{marginLeft:"margin",marginRight:"margin",marginBottom:"margin",marginTop:"margin",paddingLeft:"padding",paddingRight:"padding",paddingBottom:"padding",paddingTop:"padding"},enabled:!0,useTransitionEnd:!1};var j=document.createElement("div"),e={},r=-1<navigator.userAgent.toLowerCase().indexOf("chrome");e.transition=m("transition");e.transitionDelay=m("transitionDelay");e.transform=m("transform");e.transformOrigin=m("transformOrigin");j.style[e.transform]=
"";j.style[e.transform]="rotateY(90deg)";e.transform3d=""!==j.style[e.transform];var p=e.transitionEnd={transition:"transitionEnd",MozTransition:"transitionend",OTransition:"oTransitionEnd",WebkitTransition:"webkitTransitionEnd",msTransition:"MSTransitionEnd"}[e.transition]||null,k;for(k in e)e.hasOwnProperty(k)&&"undefined"===typeof d.support[k]&&(d.support[k]=e[k]);j=null;d.cssEase={_default:"ease","in":"ease-in",out:"ease-out","in-out":"ease-in-out",snap:"cubic-bezier(0,1,.5,1)",easeOutCubic:"cubic-bezier(.215,.61,.355,1)",
easeInOutCubic:"cubic-bezier(.645,.045,.355,1)",easeInCirc:"cubic-bezier(.6,.04,.98,.335)",easeOutCirc:"cubic-bezier(.075,.82,.165,1)",easeInOutCirc:"cubic-bezier(.785,.135,.15,.86)",easeInExpo:"cubic-bezier(.95,.05,.795,.035)",easeOutExpo:"cubic-bezier(.19,1,.22,1)",easeInOutExpo:"cubic-bezier(1,0,0,1)",easeInQuad:"cubic-bezier(.55,.085,.68,.53)",easeOutQuad:"cubic-bezier(.25,.46,.45,.94)",easeInOutQuad:"cubic-bezier(.455,.03,.515,.955)",easeInQuart:"cubic-bezier(.895,.03,.685,.22)",easeOutQuart:"cubic-bezier(.165,.84,.44,1)",
easeInOutQuart:"cubic-bezier(.77,0,.175,1)",easeInQuint:"cubic-bezier(.755,.05,.855,.06)",easeOutQuint:"cubic-bezier(.23,1,.32,1)",easeInOutQuint:"cubic-bezier(.86,0,.07,1)",easeInSine:"cubic-bezier(.47,0,.745,.715)",easeOutSine:"cubic-bezier(.39,.575,.565,1)",easeInOutSine:"cubic-bezier(.445,.05,.55,.95)",easeInBack:"cubic-bezier(.6,-.28,.735,.045)",easeOutBack:"cubic-bezier(.175, .885,.32,1.275)",easeInOutBack:"cubic-bezier(.68,-.55,.265,1.55)"};d.cssHooks["transit:transform"]={get:function(a){return d(a).data("transform")||
new l},set:function(a,b){var c=b;c instanceof l||(c=new l(c));a.style[e.transform]="WebkitTransform"===e.transform&&!r?c.toString(!0):c.toString();d(a).data("transform",c)}};d.cssHooks.transform={set:d.cssHooks["transit:transform"].set};"1.8">d.fn.jquery&&(d.cssHooks.transformOrigin={get:function(a){return a.style[e.transformOrigin]},set:function(a,b){a.style[e.transformOrigin]=b}},d.cssHooks.transition={get:function(a){return a.style[e.transition]},set:function(a,b){a.style[e.transition]=b}});f("scale");
f("translate");f("rotate");f("rotateX");f("rotateY");f("rotate3d");f("perspective");f("skewX");f("skewY");f("x",!0);f("y",!0);l.prototype={setFromString:function(a,b){var c="string"===typeof b?b.split(","):b.constructor===Array?b:[b];c.unshift(a);l.prototype.set.apply(this,c)},set:function(a){var b=Array.prototype.slice.apply(arguments,[1]);this.setter[a]?this.setter[a].apply(this,b):this[a]=b.join(",")},get:function(a){return this.getter[a]?this.getter[a].apply(this):this[a]||0},setter:{rotate:function(a){this.rotate=
g(a,"deg")},rotateX:function(a){this.rotateX=g(a,"deg")},rotateY:function(a){this.rotateY=g(a,"deg")},scale:function(a,b){void 0===b&&(b=a);this.scale=a+","+b},skewX:function(a){this.skewX=g(a,"deg")},skewY:function(a){this.skewY=g(a,"deg")},perspective:function(a){this.perspective=g(a,"px")},x:function(a){this.set("translate",a,null)},y:function(a){this.set("translate",null,a)},translate:function(a,b){void 0===this._translateX&&(this._translateX=0);void 0===this._translateY&&(this._translateY=0);
null!==a&&void 0!==a&&(this._translateX=g(a,"px"));null!==b&&void 0!==b&&(this._translateY=g(b,"px"));this.translate=this._translateX+","+this._translateY}},getter:{x:function(){return this._translateX||0},y:function(){return this._translateY||0},scale:function(){var a=(this.scale||"1,1").split(",");a[0]&&(a[0]=parseFloat(a[0]));a[1]&&(a[1]=parseFloat(a[1]));return a[0]===a[1]?a[0]:a},rotate3d:function(){for(var a=(this.rotate3d||"0,0,0,0deg").split(","),b=0;3>=b;++b)a[b]&&(a[b]=parseFloat(a[b]));
a[3]&&(a[3]=g(a[3],"deg"));return a}},parse:function(a){var b=this;a.replace(/([a-zA-Z0-9]+)\((.*?)\)/g,function(a,d,e){b.setFromString(d,e)})},toString:function(a){var b=[],c;for(c in this)if(this.hasOwnProperty(c)&&(e.transform3d||!("rotateX"===c||"rotateY"===c||"perspective"===c||"transformOrigin"===c)))"_"!==c[0]&&(a&&"scale"===c?b.push(c+"3d("+this[c]+",1)"):a&&"translate"===c?b.push(c+"3d("+this[c]+",0)"):b.push(c+"("+this[c]+")"));return b.join(" ")}};d.fn.transition=d.fn.transit=function(a,
b,c,f){var h=this,g=0,j=!0;"function"===typeof b&&(f=b,b=void 0);"function"===typeof c&&(f=c,c=void 0);"undefined"!==typeof a.easing&&(c=a.easing,delete a.easing);"undefined"!==typeof a.duration&&(b=a.duration,delete a.duration);"undefined"!==typeof a.complete&&(f=a.complete,delete a.complete);"undefined"!==typeof a.queue&&(j=a.queue,delete a.queue);"undefined"!==typeof a.delay&&(g=a.delay,delete a.delay);"undefined"===typeof b&&(b=d.fx.speeds._default);"undefined"===typeof c&&(c=d.cssEase._default);
b=n(b);var l=q(a,b,c,g),k=d.transit.enabled&&e.transition?parseInt(b,10)+parseInt(g,10):0;if(0===k)return b=j,c=function(b){h.css(a);f&&f.apply(h);b&&b()},!0===b?h.queue(c):b?h.queue(b,c):c(),h;var m={};b=j;c=function(b){this.offsetWidth;var c=!1,g=function(){c&&h.unbind(p,g);0<k&&h.each(function(){this.style[e.transition]=m[this]||null});"function"===typeof f&&f.apply(h);"function"===typeof b&&b()};0<k&&p&&d.transit.useTransitionEnd?(c=!0,h.bind(p,g)):window.setTimeout(g,k);h.each(function(){0<k&&
(this.style[e.transition]=l);d(this).css(a)})};!0===b?h.queue(c):b?h.queue(b,c):c();return this};d.transit.getTransitionValue=q})(jQuery);

/*! Copyright (c) 2011 Brandon Aaron (http://brandonaaron.net)
 * Licensed under the MIT License (LICENSE.txt).
 *
 * Thanks to: http://adomas.org/javascript-mouse-wheel/ for some pointers.
 * Thanks to: Mathias Bank(http://www.mathias-bank.de) for a scope bug fix.
 * Thanks to: Seamus Leahy for adding deltaX and deltaY
 *
 * Version: 3.0.6
 * 
 * Requires: 1.2.2+
 */
(function(a){function d(b){var c=b||window.event,d=[].slice.call(arguments,1),e=0,f=!0,g=0,h=0;return b=a.event.fix(c),b.type="mousewheel",c.wheelDelta&&(e=c.wheelDelta/120),c.detail&&(e=-c.detail/3),h=e,c.axis!==undefined&&c.axis===c.HORIZONTAL_AXIS&&(h=0,g=-1*e),c.wheelDeltaY!==undefined&&(h=c.wheelDeltaY/120),c.wheelDeltaX!==undefined&&(g=-1*c.wheelDeltaX/120),d.unshift(b,e,g,h),(a.event.dispatch||a.event.handle).apply(this,d)}var b=["DOMMouseScroll","mousewheel"];if(a.event.fixHooks)for(var c=b.length;c;)a.event.fixHooks[b[--c]]=a.event.mouseHooks;a.event.special.mousewheel={setup:function(){if(this.addEventListener)for(var a=b.length;a;)this.addEventListener(b[--a],d,!1);else this.onmousewheel=d},teardown:function(){if(this.removeEventListener)for(var a=b.length;a;)this.removeEventListener(b[--a],d,!1);else this.onmousewheel=null}},a.fn.extend({mousewheel:function(a){return a?this.bind("mousewheel",a):this.trigger("mousewheel")},unmousewheel:function(a){return this.unbind("mousewheel",a)}})})(jQuery);
if (typeof Object.create !== 'function') {
    Object.create = function(obj) {
        function F() {}
        F.prototype = obj;
        return new F();
    };
}

(function($, window, document, undefined) {
    $.fn.socialfeed = function(_options) {

        var feedsDS = new kendo.data.DataSource();

        var defaults = {
            plugin_folder: '', // a folder in which the plugin is located (with a slash in the end)
            template: 'template.html', // a path to the template file
            show_media: false, // show images of attachments if available
            media_min_width: 300,
            length: 500, // maximum length of post message shown
            date_format: 'll'
        };
        //---------------------------------------------------------------------------------
        var options = $.extend(defaults, _options),
            container = $(this),
            template,
            social_networks = ['facebook', 'instagram', 'vk', 'google', 'blogspot', 'twitter', 'pinterest', 'rss'],
            posts_to_load_count = 0,
            loaded_post_count = 0;
        // container.empty().css('display', 'block');
        //---------------------------------------------------------------------------------

        //---------------------------------------------------------------------------------
        // This function performs consequent data loading from all of the sources by calling corresponding functions
        function calculatePostsToLoadCount() {
            social_networks.forEach(function(network) {
                if (options[network]) {
                    if (options[network].accounts) {
                        posts_to_load_count += options[network].limit * options[network].accounts.length;
                    } else {
                        posts_to_load_count += options[network].limit;
                    }
                }
            });
        }

        calculatePostsToLoadCount();

        function fireCallback() {
            var fire = true;
            /*$.each(Object.keys(loaded), function() {
                if (loaded[this] > 0)
                    fire = false;
            });*/
            if (fire && options.callback) {
                options.callback();
            }
        }

        var Utility = {
            request: function(url, callback) {
                $.ajax({
                    url: url,
                    dataType: 'jsonp',
                    success: callback
                });
            },
            get_request: function(url, callback) {
                $.get(url, callback, 'json');
            },
            wrapLinks: function(string, social_network) {
                var exp = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
                if (social_network === 'google-plus') {
                    string = string.replace(/(@|#)([a-z0-9_]+['])/ig, Utility.wrapGoogleplusTagTemplate);
                } else {
                    string = string.replace(exp, Utility.wrapLinkTemplate);
                }
                return string;
            },
            wrapLinkTemplate: function(string) {
                return '<a target="_blank" href="' + string + '">' + string + '<\/a>';
            },
            wrapGoogleplusTagTemplate: function(string) {
                return '<a target="_blank" href="https://plus.google.com/s/' + string + '" >' + string + '<\/a>';
            },
            shorten: function(string) {
                string = $.trim(string);
                if (string.length > options.length) {
                    return jQuery.trim(string).substring(0, options.length).split(" ").slice(0, -1).join(" ") + "...";
                } else {
                    return string;
                }
            },
            stripHTML: function(string) {
                if (typeof string === "undefined" || string === null) {
                    return '';
                }
                return string.replace(/(<([^>]+)>)|nbsp;|\s{2,}|/ig, "");
            }
        };

        function SocialFeedPost(social_network, data) {
            this.content = data;
            this.content.social_network = social_network;
            this.content.attachment = (this.content.attachment === undefined) ? '' : this.content.attachment;
            this.content.time_ago = data.dt_create.fromNow();
            this.content.date = data.dt_create.format(options.date_format);
            this.content.dt_create = this.content.dt_create.valueOf();
            this.content.text = Utility.wrapLinks(Utility.shorten(data.message + ' ' + data.description), data.social_network);
            this.content.moderation_passed = (options.moderation) ? options.moderation(this.content) : true;

            Feed[social_network].posts.push(this);
        }

        SocialFeedPost.prototype = {
            render: function() {
                var rendered_html = Feed.template(this.content);
                var data = this.content;

                if ($(container).children('[social-feed-id=' + data.id + ']').length !== 0) {
                    return false;
                }
                if ($(container).children().length === 0) {
                    $(container).append(rendered_html);
                } else {
                    var i = 0,
                        insert_index = -1;
                    $.each($(container).children(), function() {
                        if ($(this).attr('dt-create') < data.dt_create) {
                            insert_index = i;
                            return false;
                        }
                        i++;
                    });
                    $(container).append(rendered_html);
                    if (insert_index >= 0) {
                        insert_index++;
                        var before = $(container).children('div:nth-child(' + insert_index + ')'),
                            current = $(container).children('div:last-child');
                        $(current).insertBefore(before);
                    }

                }
                if (options.media_min_width) {

                    var query = '[social-feed-id=' + data.id + '] img.attachment';
                    var image = $(query);

                    // preload the image
                    var height, width = '';
                    var img = new Image();
                    var imgSrc = image.attr("src");

                    $(img).load(function() {

                        if (img.width < options.media_min_width) {
                            image.hide();
                        }
                        // garbage collect img
                        delete img;

                    }).error(function() {
                        // image couldnt be loaded
                        image.hide();

                    }).attr({
                        src: imgSrc
                    });

                }

                loaded_post_count++;
                if (loaded_post_count == posts_to_load_count) {
                    fireCallback();
                }

            }

        };

        var Feed = {
            template: false,
            init: function() {
                Feed.getTemplate(function() {
                    social_networks.forEach(function(network) {
                        if (options[network]) {
                            if ( options[network].accounts ) {
                                //loaded[network] = 0;
                                options[network].accounts.forEach(function(account) {
                                    //loaded[network]++;
                                    Feed[network].getData(account);
                                });
                            } else if ( options[network].urls ) {
                                options[network].urls.forEach(function(url) {
                                    Feed[network].getData(url);
                                });
                            } else {
                                Feed[network].getData();
                            }
                        }
                    });
                });
            },
            getTemplate: function(callback) {
                if (Feed.template)
                    return callback();
                else {
                    if (options.template_html) {
                        Feed.template = doT.template(options.template_html);
                        return callback();
                    } else {
                        $.get(options.template, function(template_html) {
                            Feed.template = doT.template(template_html);
                            return callback();
                        });
                    }
                }
            },
            twitter: {
                posts: [],
                loaded: false,
                api: 'http://api.tweecool.com/',

                getData: function(account) {

                    var cb = new Codebird();
                    cb.setConsumerKey(options.twitter.consumer_key, options.twitter.consumer_secret);

                    // Allow setting your own proxy with Codebird
                    if (options.twitter.proxy !== undefined) {
                        cb.setProxy(options.twitter.proxy);
                    }

                    switch (account[0]) {
                        case '@':
                            var userid = account.substr(1);
                            cb.__call(
                                "statuses_userTimeline",
                                "id=" + userid + "&count=" + options.twitter.limit,
                                Feed.twitter.utility.getPosts,
                                true // this parameter required
                            );
                            break;
                        case '#':
                            var hashtag = account.substr(1);
                            cb.__call(
                                "search_tweets",
                                "q=" + hashtag + "&count=" + options.twitter.limit,
                                function(reply) {
                                    Feed.twitter.utility.getPosts(reply.statuses);
                                },
                                true // this parameter required
                            );
                            break;
                        default:
                    }
                },
                utility: {
                    getPosts: function(json) {
                        if (json) {
                            var counter = 0;  // Quick hack to enforce twitter post limit
                            $.each(json, function() {
                                if (counter++ >= options.twitter.limit) {
                                    return;
                                }
                                var element = this;
                                var post = new SocialFeedPost('twitter', Feed.twitter.utility.unifyPostData(element));
                                feedsDS.add(post);
                                post.render();
                            });
                        }
                    },

                    unifyPostData: function(element) {
                        var post = {};
                        if (element.id) {
                            post.id = element.id;
                            //prevent a moment.js console warning due to Twitter's poor date format.
                            post.dt_create = moment(new Date(element.created_at));
                            post.author_link = 'http://twitter.com/' + element.user.screen_name;
                            post.author_picture = element.user.profile_image_url;
                            post.post_url = post.author_link + '/status/' + element.id_str;
                            post.author_name = element.user.name;
                            post.message = element.text;
                            post.description = '';
                            post.link = 'http://twitter.com/' + element.user.screen_name + '/status/' + element.id_str;

                            if (options.show_media === true) {
                                if (element.entities.media && element.entities.media.length > 0) {
                                    var image_url = element.entities.media[0].media_url;
                                    if (image_url) {
                                        post.attachment = '<img class="attachment" src="' + image_url + '" />';
                                    }
                                }
                            }
                        }
                        return post;
                    }
                }
            },
            facebook: {
                posts: [],
                graph: 'https://graph.facebook.com/',
                loaded: false,
                getData: function(account) {
                    var proceed = function(request_url){
                        Utility.request(request_url, Feed.facebook.utility.getPosts);
                    };
                    var fields = '?fields=id,from,name,message,created_time,story,description,link';
                       fields += (options.show_media === true)?',picture,object_id':'';
                    var request_url, limit = '&limit=' + options.facebook.limit,
                        query_extention = '&access_token=' + options.facebook.access_token + '&callback=?';
                    switch (account[0]) {
                        case '@':
                            var username = account.substr(1);
                            Feed.facebook.utility.getUserId(username, function(userdata) {
                                if (userdata.id !== '') {
                                    request_url = Feed.facebook.graph + 'v2.4/' + userdata.id + '/posts'+ fields + limit + query_extention;
                                    proceed(request_url);
                                }
                            });
                            break;
                        case '!':
                            var page = account.substr(1);
                            request_url = Feed.facebook.graph + 'v2.4/' + page + '/feed'+ fields + limit + query_extention;
                            proceed(request_url);
                            break;
                        default:
                            proceed(request_url);
                    }
                },
                utility: {
                    getUserId: function(username, callback) {
                        var query_extention = '&access_token=' + options.facebook.access_token + '&callback=?';
                        var url = 'https://graph.facebook.com/' + username + '?' + query_extention;
                        var result = '';
                        $.get(url, callback, 'json');
                    },
                    prepareAttachment: function(element) {
                        var image_url = element.picture;
                        if (image_url.indexOf('_b.') !== -1) {
                            //do nothing it is already big
                        } else if (image_url.indexOf('safe_image.php') !== -1) {
                            image_url = Feed.facebook.utility.getExternalImageURL(image_url, 'url');

                        } else if (image_url.indexOf('app_full_proxy.php') !== -1) {
                            image_url = Feed.facebook.utility.getExternalImageURL(image_url, 'src');

                        } else if (element.object_id) {
                            image_url = Feed.facebook.graph + element.object_id + '/picture/?type=normal';
                        }
                        return '<img class="attachment" src="' + image_url + '" />';
                    },
                    getExternalImageURL: function(image_url, parameter) {
                        image_url = decodeURIComponent(image_url).split(parameter + '=')[1];
                        if (image_url.indexOf('fbcdn-sphotos') === -1) {
                            image_url = image_url.split('&')[0];

                            if(image_url.indexOf("fbstaging") !== -1) {
                                image_url = "https://external.xx.fbcdn.net/safe_image.php?url="+encodeURIComponent(image_url);
                            }

                            return image_url
                        } else {
                            return image_url;
                        }

                    },
                    getPosts: function(json) {
                        if (json['data']) {
                            json['data'].forEach(function(element) {
                                var post = new SocialFeedPost('facebook', Feed.facebook.utility.unifyPostData(element));
                                feedsDS.add(post);
                                post.render();
                            });
                        }
                    },
                    unifyPostData: function(element) {
                        var post = {},
                            text = (element.message) ? element.message : element.story;

                        post.id = element.id;
                        post.dt_create = moment(element.created_time);
                        post.author_link = 'http://facebook.com/' + element.from.id;
                        post.author_picture = Feed.facebook.graph + element.from.id + '/picture';
                        post.author_name = element.from.name;
                        post.name = element.name || "";
                        post.message = (text) ? text : '';
                        post.description = (element.description) ? element.description : '';
                        post.link = (element.link) ? element.link : 'http://facebook.com/' + element.from.id;

                        if (options.show_media === true) {
                            if (element.picture) {
                                var attachment = Feed.facebook.utility.prepareAttachment(element);
                                if (attachment) {
                                    post.attachment = attachment;
                                }
                            }
                        }
                        return post;
                    }
                }
            },
            google: {
                posts: [],
                loaded: false,
                api: 'https://www.googleapis.com/plus/v1/',
                getData: function(account) {
                    var request_url;
                    switch (account[0]) {
                        case '#':
                            var hashtag = account.substr(1);
                            request_url = Feed.google.api + 'activities?query=' + hashtag + '&key=' + options.google.access_token + '&maxResults=' + options.google.limit;
                            Utility.get_request(request_url, Feed.google.utility.getPosts);
                            break;
                        case '@':
                            var username = account.substr(1);
                            request_url = Feed.google.api + 'people/' + username + '/activities/public?key=' + options.google.access_token + '&maxResults=' + options.google.limit;
                            Utility.get_request(request_url, Feed.google.utility.getPosts);
                            break;
                        default:
                    }
                },
                utility: {
                    getPosts: function(json) {
                        if (json.items) {
                            $.each(json.items, function(i) {
                                var post = new SocialFeedPost('google', Feed.google.utility.unifyPostData(json.items[i]));
                                post.render();
                            });
                        }
                    },
                    unifyPostData: function(element) {
                        var post = {};

                        post.id = element.id;
                        post.attachment = '';
                        post.description = '';
                        post.dt_create = moment(element.published);
                        post.author_link = element.actor.url;
                        post.author_picture = element.actor.image.url;
                        post.author_name = element.actor.displayName;

                        if (options.show_media === true) {
                            if (element.object.attachments) {
                                $.each(element.object.attachments, function() {
                                    var image = '';
                                    if (this.fullImage) {
                                        image = this.fullImage.url;
                                    } else {
                                        if (this.objectType === 'album') {
                                            if (this.thumbnails && this.thumbnails.length > 0) {
                                                if (this.thumbnails[0].image) {
                                                    image = this.thumbnails[0].image.url;
                                                }
                                            }
                                        }
                                    }
                                    post.attachment = '<img class="attachment" src="' + image + '"/>';
                                });
                            }
                        }
                        post.message = element.title;
                        post.link = element.url;

                        return post;
                    }
                }
            },
            instagram: {
                posts: [],
                api: 'https://api.instagram.com/v1/',
                loaded: false,
                accessType: function() {
                    // If we have both the client_id and access_token set in options,
                    // use access_token for authentication. If client_id is not set
                    // then use access_token. If neither are set, log an error to console.
                    if (typeof options.instagram.access_token === 'undefined' && typeof options.instagram.client_id === 'undefined') {
                        console.log('You need to define a client_id or access_token to authenticate with Instagram\'s API.');
                        return undefined;
                    }
                    if (options.instagram.access_token) { options.instagram.client_id = undefined; }
                    options.instagram.access_type = (typeof options.instagram.client_id === 'undefined' ? 'access_token' : 'client_id');
                    return options.instagram.access_type;
                },
                getData: function(account) {
                    var url;

                    // API endpoint URL depends on which authentication type we're using.
                    if (this.accessType() !== 'undefined') {
                        var authTokenParams = options.instagram.access_type + '=' + options.instagram[options.instagram.access_type];
                    }

                    switch (account[0]) {
                        case '@':
                            var username = account.substr(1);
                            url = Feed.instagram.api + 'users/search/?q=' + username + '&' + authTokenParams + '&count=1' + '&callback=?';
                            Utility.request(url, Feed.instagram.utility.getUsers);
                            break;
                        case '#':
                            var hashtag = account.substr(1);
                            url = Feed.instagram.api + 'tags/' + hashtag + '/media/recent/?' + authTokenParams + '&' + 'count=' + options.instagram.limit + '&callback=?';
                            Utility.request(url, Feed.instagram.utility.getImages);
                            break;
                        case '&':
                            var id = account.substr(1);
                            url = Feed.instagram.api + 'users/' + id + '/?' + authTokenParams + '&' + 'count=' + options.instagram.limit + '&callback=?';
                            Utility.request(url, Feed.instagram.utility.getUsers);
                        default:
                    }
                },
                utility: {
                    getImages: function(json) {
                        if (json.data) {
                            json.data.forEach(function(element) {
                                var post = new SocialFeedPost('instagram', Feed.instagram.utility.unifyPostData(element));
                                post.render();
                            });
                        }
                    },
                    getUsers: function(json) {
                        // API endpoint URL depends on which authentication type we're using.
                        if (options.instagram.access_type !== 'undefined') {
                            var authTokenParams = options.instagram.access_type + '=' + options.instagram[options.instagram.access_type];
                        }

                        if (!jQuery.isArray(json.data)) json.data = [json.data]
                        json.data.forEach(function(user) {
                            var url = Feed.instagram.api + 'users/' + user.id + '/media/recent/?' + authTokenParams + '&' + 'count=' + options.instagram.limit + '&callback=?';
                            Utility.request(url, Feed.instagram.utility.getImages);
                        });
                    },
                    unifyPostData: function(element) {
                        var post = {};

                        post.id = element.id;
                        post.dt_create = moment(element.created_time * 1000);
                        post.author_link = 'http://instagram.com/' + element.user.username;
                        post.author_picture = element.user.profile_picture;
                        post.author_name = element.user.full_name || element.user.username;
                        post.message = (element.caption && element.caption) ? element.caption.text : '';
                        post.description = '';
                        post.link = element.link;
                        if (options.show_media) {
                            post.attachment = '<img class="attachment" src="' + element.images.standard_resolution.url + '' + '" />';
                        }
                        return post;
                    }
                }
            },
            vk: {
                posts: [],
                loaded: false,
                base: 'http://vk.com/',
                api: 'https://api.vk.com/method/',
                user_json_template: 'https://api.vk.com/method/' + 'users.get?fields=first_name,%20last_name,%20screen_name,%20photo&uid=',
                group_json_template: 'https://api.vk.com/method/' + 'groups.getById?fields=first_name,%20last_name,%20screen_name,%20photo&gid=',
                getData: function(account) {
                    var request_url;

                    switch (account[0]) {
                        case '@':
                            var username = account.substr(1);
                            request_url = Feed.vk.api + 'wall.get?owner_id=' + username + '&filter=' + options.vk.source + '&count=' + options.vk.limit + '&callback=?';
                            Utility.get_request(request_url, Feed.vk.utility.getPosts);
                            break;
                        case '#':
                            var hashtag = account.substr(1);
                            request_url = Feed.vk.api + 'newsfeed.search?q=' + hashtag + '&count=' + options.vk.limit + '&callback=?';
                            Utility.get_request(request_url, Feed.vk.utility.getPosts);
                            break;
                        default:
                    }
                },
                utility: {
                    getPosts: function(json) {
                        if (json.response) {
                            $.each(json.response, function() {
                                if (this != parseInt(this) && this.post_type === 'post') {
                                    var owner_id = (this.owner_id) ? this.owner_id : this.from_id,
                                        vk_wall_owner_url = (owner_id > 0) ? (Feed.vk.user_json_template + owner_id + '&callback=?') : (Feed.vk.group_json_template + (-1) * owner_id + '&callback=?'),
                                        element = this;
                                    Utility.get_request(vk_wall_owner_url, function(wall_owner) {
                                        Feed.vk.utility.unifyPostData(wall_owner, element, json);
                                    });
                                }
                            });
                        }
                    },
                    unifyPostData: function(wall_owner, element, json) {
                        var post = {};

                        post.id = element.id;
                        post.dt_create = moment.unix(element.date);
                        post.description = ' ';
                        post.message = Utility.stripHTML(element.text);
                        if (options.show_media) {
                            if (element.attachment) {
                                if (element.attachment.type === 'link')
                                    post.attachment = '<img class="attachment" src="' + element.attachment.link.image_src + '" />';
                                if (element.attachment.type === 'video')
                                    post.attachment = '<img class="attachment" src="' + element.attachment.video.image_big + '" />';
                                if (element.attachment.type === 'photo')
                                    post.attachment = '<img class="attachment" src="' + element.attachment.photo.src_big + '" />';
                            }
                        }

                        if (element.from_id > 0) {
                            var vk_user_json = Feed.vk.user_json_template + element.from_id + '&callback=?';
                            Utility.get_request(vk_user_json, function(user_json) {
                                var vk_post = new SocialFeedPost('vk', Feed.vk.utility.getUser(user_json, post, element, json));
                                vk_post.render();
                            });

                        } else {
                            var vk_group_json = Feed.vk.group_json_template + (-1) * element.from_id + '&callback=?';
                            Utility.get_request(vk_group_json, function(user_json) {
                                var vk_post = new SocialFeedPost('vk', Feed.vk.utility.getGroup(user_json, post, element, json));
                                vk_post.render();
                            });
                        }
                    },
                    getUser: function(user_json, post, element, json) {
                        post.author_name = user_json.response[0].first_name + ' ' + user_json.response[0].last_name;
                        post.author_picture = user_json.response[0].photo;
                        post.author_link = Feed.vk.base + user_json.response[0].screen_name;
                        post.link = Feed.vk.base + user_json.response[0].screen_name + '?w=wall' + element.from_id + '_' + element.id;

                        return post;
                    },
                    getGroup: function(user_json, post, element, json) {
                        post.author_name = user_json.response[0].name;
                        post.author_picture = user_json.response[0].photo;
                        post.author_link = Feed.vk.base + user_json.response[0].screen_name;
                        post.link = Feed.vk.base + user_json.response[0].screen_name + '?w=wall-' + user_json.response[0].gid + '_' + element.id;

                        return post;
                    }
                }
            },
            blogspot: {
                loaded: false,
                getData: function(account) {
                    var url;

                    switch (account[0]) {
                        case '@':
                            var username = account.substr(1);
                            url = 'http://' + username + '.blogspot.com/feeds/posts/default?alt=json-in-script&callback=?';
                            request(url, getPosts);
                            break;
                        default:
                    }
                },
                utility: {
                    getPosts: function(json) {
                        $.each(json.feed.entry, function() {
                            var post = {},
                                element = this;
                            post.id = element.id['$t'].replace(/[^a-z0-9]/gi, '');
                            post.dt_create = moment((element.published['$t']));
                            post.author_link = element.author[0]['uri']['$t'];
                            post.author_picture = 'http:' + element.author[0]['gd$image']['src'];
                            post.author_name = element.author[0]['name']['$t'];
                            post.message = element.title['$t'] + '</br></br>' + stripHTML(element.content['$t']);
                            post.description = '';
                            post.link = element.link.pop().href;

                            if (options.show_media) {
                                if (element['media$thumbnail']) {
                                    post.attachment = '<img class="attachment" src="' + element['media$thumbnail']['url'] + '" />';
                                }
                            }

                            post.render();

                        });
                    }
                }
            },
            pinterest: {
                posts: [],
                loaded: false,
                apiv1: 'https://api.pinterest.com/v1/',

                getData: function(account) {
                    var request_url,
                      limit = 'limit=' + options.pinterest.limit,
                      fields = 'fields=id,created_at,link,note,creator(url,first_name,last_name,image),image',
                      query_extention = fields + '&access_token=' + options.pinterest.access_token + '&' + limit + '&callback=?';
                    switch (account[0]) {
                        case '@':
                            var username = account.substr(1);
                            if (username === 'me') {
                                request_url = Feed.pinterest.apiv1 + 'me/pins/?' + query_extention;
                            } else {
                                request_url = Feed.pinterest.apiv1 + 'boards/' + username + '/pins?' + query_extention;
                            }
                            break;
                        default:
                    }
                    Utility.request(request_url, Feed.pinterest.utility.getPosts);
                },
                utility: {

                    getPosts: function(json) {
                        json.data.forEach(function(element) {
                            var post = new SocialFeedPost('pinterest', Feed.pinterest.utility.unifyPostData(element));
                            post.render();
                        });
                    },

                    unifyPostData: function(element){
                        var post = {};

                        post.id = element.id;
                        post.dt_create= moment(element.created_at);
                        post.author_link = element.creator.url;
                        post.author_picture = element.creator.image['60x60' ].url;
                        post.author_name =  element.creator.first_name + element.creator.last_name;
                        post.message = element.note;
                        post.description = '';
                        post.social_network = 'pinterest';
                        post.link = element.link ? element.link : 'https://www.pinterest.com/pin/' + element.id;
                        if (options.show_media) {
                            post.attachment = '<img class="attachment" src="' + element.image['original'].url + '" />';
                        }
                        return post;
                    }
                }
            },
            rss : {
                posts: [],
                loaded: false,
                api : 'https://ajax.googleapis.com/ajax/services/feed/load?v=1.0',

                getData: function(url) {
                    var limit = '&num='+ options.rss.limit,
                      request_url = Feed.rss.api + limit + '&q=' + encodeURIComponent(url);

                    Utility.request(request_url, Feed.rss.utility.getPosts);
                },
                utility: {

                    getPosts: function(json) {
                        $.each(json.responseData.feed.entries, function(index, element) {
                            var post = new SocialFeedPost('rss', Feed.rss.utility.unifyPostData(index, element));
                            post.render();
                        });
                    },

                    unifyPostData: function(index, element){
                        var post = {};

                        post.id = index;
                        post.dt_create= moment(element.publishedDate, 'ddd, DD MMM YYYY HH:mm:ss ZZ', 'en');
                        post.author_link = '';
                        post.author_picture = '';
                        post.author_name = element.author;
                        post.message = Utility.stripHTML(element.title);
                        post.description = Utility.stripHTML(element.content);
                        post.social_network = 'rss';
                        post.link = element.link;
                        if (options.show_media && element.mediaGroups ) {
                            post.attachment = '<img class="attachment" src="' + element.mediaGroups[0].contents[0].url + '" />';
                        }
                        return post;
                    }
                }
            }
        };

        var getDataSource = function () {
            return (feedsDS);
        };

        //make the plugin chainable
        return this.each(function() {
            // Initialization
            Feed.init();
            if (options.update_period) {
                setInterval(function() {
                    return Feed.init();
                }, options.update_period);
            }
        })
    };

})(jQuery);

(function($) {

  // Matches trailing non-space characters.
  var chop = /(\s*\S+|\s)$/;

  // Matches the first word in the string.
  var start = /^(\S*)/;

  // Return a truncated html string.  Delegates to $.fn.truncate.
  $.truncate = function(html, options) {
    return $('<div></div>').append(html).truncate(options).html();
  };

  // Truncate the contents of an element in place.
  $.fn.truncate = function(options) {
    if ($.isNumeric(options)) options = {length: options};
    var o = $.extend({}, $.truncate.defaults, options);

    return this.each(function() {
      var self = $(this);

      if (o.noBreaks) self.find('br').replaceWith(' ');

      var text = self.text();
      var excess = text.length - o.length;

      if (o.stripTags) self.text(text);

      // Chop off any partial words if appropriate.
      if (o.words && excess > 0) {
        var truncated = text.slice(0, o.length).replace(chop, '').length;

        if (o.keepFirstWord && truncated === 0) {
          excess = text.length - start.exec(text)[0].length - 1;
        } else {
          excess = text.length - truncated - 1;
        }
      }

      if (excess < 0 || !excess && !o.truncated) return;

      // Iterate over each child node in reverse, removing excess text.
      $.each(self.contents().get().reverse(), function(i, el) {
        var $el = $(el);
        var text = $el.text();
        var length = text.length;

        // If the text is longer than the excess, remove the node and continue.
        if (length <= excess) {
          o.truncated = true;
          excess -= length;
          $el.remove();
          return;
        }

        // Remove the excess text and append the ellipsis.
        if (el.nodeType === 3) {
          $(el.splitText(length - excess - 1)).replaceWith(o.ellipsis);
          return false;
        }

        // Recursively truncate child nodes.
        $el.truncate($.extend(o, {length: length - excess}));
        return false;
      });
    });
  };

  $.truncate.defaults = {

    // Strip all html elements, leaving only plain text.
    stripTags: false,

    // Only truncate at word boundaries.
    words: false,

    // When 'words' is active, keeps the first word in the string
    // even if it's longer than a target length.
    keepFirstWord: false,

    // Replace instances of <br> with a single space.
    noBreaks: false,

    // The maximum length of the truncated html.
    length: Infinity,

    // The character to use as the ellipsis.  The word joiner (U+2060) can be
    // used to prevent a hanging ellipsis, but displays incorrectly in Chrome
    // on Windows 7.
    // http://code.google.com/p/chromium/issues/detail?id=68323
    ellipsis: '\u2026' // '\u2060\u2026'

  };

})(jQuery);

jQuery.fn.jSonSlider = function (options) {

    var defaults = {/*Default Options*/
        'loadallslides': true, /*Load all slides OR one by one*/
        'slideanimation': false, /*Animate slide*/
        'nextprev': true, /*Next previous arrow enable OR disable*/
        'nextclass': 'next', /*Next arrow class name*/
        'prevclass': 'prev', /*Previous arrow class name*/
        'pagi': true, /*Paginatin enable OR disable*/
        'pagiclass': 'pagi', /*Pagination class name*/
        'search': [false, '2'], /*Search option enable OR disable & set search minimum length*/
        'data': [{ /*Default Data*/
                tags: [{
                        name: 'h1',
                        content: "Can't found jSon Object"
                    }]
            }],
        'auto': [false, '10000'], /*Auto slide enable OR disable & set auto slide time*/
        'circular': true, /*Circular option enable OR disable*/
        'touch': true, /*Touch option enable OR disable*/
        'fullscreen': false /*Fullscreen option enable OR disable*/
    };

    var settings = $.extend({}, defaults, options); /*Overwrite default setting*/
    var obj_data = settings.data; /*Main data*/

    return this.each(function () {
        
        var _this = $(this);       

        $(window).resize(function() { /*On resize window*/
            if (settings.ori_data) {
                options.ori_data = settings.ori_data;
            } else {
                options.ori_data = settings.data;
            }
            options.data = settings.data;
            _this.html('');
            _this.jSonSlider(options);
        });
        
        var selector = '';
        if (this.id) {
            selector = '#' + this.id;
        } else if (this.className) {
            selector = '.' + this.className;
            if (selector.indexOf(' ') > -1) {
                selector = selector.split(" ");
                selector = selector[0];
            }
        }

        if (settings.loadallslides == true) { /*Load all slide*/
        } else { /*Load slide one by one*/
            _this.append('<div class="slide index0"></div>');
        }

        if (obj_data.length > 0) { /*Pagination, play & pause button & process html*/
            var pagi_html = '<div class="' + settings.pagiclass + '">';
            var active_slide = 0;
            for (slide in obj_data) {
                if (obj_data[slide].active == true) {
                    active_slide = parseInt(slide, 10);
                }
                pagi_html += '<a href="' + slide + '">';
                if (obj_data[slide].thumbhtml) {
                    pagi_html += obj_data[slide].thumbhtml;
                } else {
                    pagi_html += parseInt(slide, 10) + 1;
                }
                pagi_html += '</a>';
            }
            pagi_html += '</div>';
            _this.append(pagi_html);
            _this.find('.' + settings.pagiclass + ' a').eq(active_slide).addClass('active');
            if (settings.pagi == false || obj_data.length < 2) {
                _this.find('.' + settings.pagiclass + '').css('opacity', 0);
            }
            if (obj_data.length > 1) {
                var process_html = '<a href="#" class="playpause';
                if (settings.auto[0] == true) {
                    process_html += '';
                } else {
                    process_html += ' pause';
                }
                process_html += '"></a><div class="process"></div>';
                _this.append(process_html);
            }
        }

        if (obj_data.length > 1 && settings.nextprev) { /*Next previous arrow html*/
            _this.append('<div class="control"><a href="javascript:;" class="' + settings.prevclass + '"></a><a href="javascript:;" class="' + settings.nextclass + '"></a></div>');
        }

        if (obj_data.length > 1 && settings.search[0]) { /*Search functionality*/
            if($('.js_search').length < 1) {
                _this.after('<div class="js_search"><input placeholder="" type="text" class="searchfield" /></div>');                    
            }
            $('.js_search .searchfield').on('keyup', function () {
                _this.find('.' + settings.pagiclass + '').find('.find').removeClass('find');
                if ($(this).val().length >= settings.search[1]) {
                    var search_result_arr = [];
                    for (slide in obj_data) {
                        for (tag in obj_data[slide].tags) {
                            for (i in obj_data[slide].tags) {
                                if (typeof obj_data[slide].tags[i] == 'object') {
                                    for (j in obj_data[slide].tags[i]) {
                                        if(j == 'name' || j == 'content') {
                                            if (typeof obj_data[slide].tags[i][j] != 'object') {
                                                if (typeof (obj_data[slide].tags[i][j]) != 'boolean') {
                                                    if (obj_data[slide].tags[i][j].search(new RegExp($(this).val(), "i")) > -1) {
                                                        if (search_result_arr.indexOf(slide) == -1) {
                                                            if (obj_data[slide].tags[i].name != 'iframe') {
                                                                search_result_arr.push(slide);
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                } else {
                                    if (obj_data[slide].tags[i].indexOf($(this).val()) > -1) {
                                        if (search_result_arr.indexOf(slide) == -1) {
                                            search_result_arr.push(slide);
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                if ($('.js_search .searchresult').length == 0) {
                    $('.js_search').append('<div class="searchresult"></div>');
                }
                var searchresult = '';
                for (i in search_result_arr) {
                    searchresult += '<a href="' + search_result_arr[i] + '">' + (parseInt(search_result_arr[i], 10) + 1) + '</a>';
                }
                $('.js_search .searchresult').html(searchresult);
                $('.js_search .searchresult a').on("click", function (e) {
                    _this.find('.' + settings.pagiclass + '').children('a[href=' + $(this).attr("href") + ']').trigger('click');
                    e.preventDefault();
                });
                if (settings.pagi == false) {
                } else {
                    for (i in search_result_arr) {
                        if (_this.find('.' + settings.pagiclass + ' a').eq(search_result_arr[i]).hasClass('find') == false) {
                            _this.find('.' + settings.pagiclass + ' a').eq(search_result_arr[i]).addClass('find');
                        }
                    }
                }
            });
        }

        _this.find('.control').children('a').on("click", function (e) { /*On click next previous arrow*/
            if ($(this).attr('class') == settings.nextclass) {
                if (settings.circular) {
                    if (_this.find('.' + settings.pagiclass + '').find('.active').next().length > 0) {
                        _this.find('.' + settings.pagiclass + '').find('.active').next().trigger('click');
                    } else {
                        _this.find('.' + settings.pagiclass + ' a:first-child').trigger('click');
                    }
                } else {
                    _this.find('.' + settings.pagiclass + '').find('.active').next().trigger('click');
                }
            } else {
                if (settings.circular) {
                    if (_this.find('.' + settings.pagiclass + '').find('.active').prev().length > 0) {
                        _this.find('.' + settings.pagiclass + '').find('.active').prev().trigger('click');
                    } else {
                        _this.find('.' + settings.pagiclass + ' a:last-child').trigger('click');
                    }
                } else {
                    _this.find('.' + settings.pagiclass + '').find('.active').prev().trigger('click');
                }
            } 
            e.preventDefault();
        });

        if (settings.touch) { /*On touch*/
            _this.on('swiperight', function (e) {
                if (settings.circular) {
                    if (_this.find('.' + settings.pagiclass + '').find('.active').prev().length > 0) {
                        _this.find('.' + settings.pagiclass + '').find('.active').prev().trigger('click');
                    } else {
                        _this.find('.' + settings.pagiclass + ' a:last-child').trigger('click');
                    }
                } else {
                    _this.find('.' + settings.pagiclass + '').find('.active').prev().trigger('click');
                }
            });
            _this.on('swipeleft', function (e) {
                if (settings.circular) {
                    if (_this.find('.' + settings.pagiclass + '').find('.active').next().length > 0) {
                        _this.find('.' + settings.pagiclass + '').find('.active').next().trigger('click');
                    } else {
                        _this.find('.' + settings.pagiclass + ' a:first-child').trigger('click');
                    }
                } else {
                    _this.find('.' + settings.pagiclass + '').find('.active').next().trigger('click');
                }
            });
        }

        if (settings.auto[0]) { /*Auto slide*/
            var auto_slide = setInterval(function () {
                auto_slide_fun(_this);
            }, parseInt(settings.auto[1], 10));
        }

        _this.find('.playpause').on("click", function (e) { /*On click play pause button*/
            if (e.isTrigger == undefined) {
                if (settings.auto[0] == true) {
                    settings.auto[0] = false;
                } else {
                    settings.auto[0] = true;
                }
            }
            if ($(this).hasClass('pause')) {
                var processwid = _this.find('.process').attr('style').split(':');
                processwid = parseInt(processwid[1], 10);
                var speed = (parseInt(settings.auto[1], 10) * (100 - processwid)) / 100;
                auto_slide = setInterval(function () {
                    auto_slide_fun(_this);
                }, speed);
                _this.find('.process').animate({
                    width: '100%'
                }, speed, function () {
                    $(this).css('width', '0');
                });
                $(this).removeClass('pause');
            } else {
                if (typeof (auto_slide) != undefined) {
                    clearInterval(auto_slide);
                }
                _this.find('.process').stop();
                $(this).addClass('pause');
            }
            e.preventDefault();
        });

        $(document).on('click', '' + selector + ' .cover', function (e) { /*On click start stop video*/
            if (e.target.className == 'close') {
                _this.find('.playpause').show();
                $(this).removeClass('hide');
                $('' + selector + ' iframe')[0].contentWindow.postMessage('{"event":"command","func":"' + 'stopVideo' + '","args":""}', '*');
                if (settings.auto[0] == true) {
                    _this.find('.playpause.pause').trigger('click');
                }
            } else {
                _this.find('.playpause').hide();
                $(this).addClass('hide');
                $('' + selector + ' iframe')[0].contentWindow.postMessage('{"event":"command","func":"' + 'playVideo' + '","args":""}', '*');
                if (settings.auto[0] == true) {
                    _this.find('.playpause').trigger('click');
                }
            }

            e.preventDefault();
        });

        if (active_slide == 0 && settings.circular == false) { /*Hide previous arrow on first slide*/
            _this.find('.control').find(settings.prevclass).hide();
        }
        if (active_slide == (obj_data.length - 1) && settings.circular == false) { /*Hide next arrow on last slide*/
            _this.find('.control').find(settings.nextclass).hide();
        }

        if (settings.loadallslides == true) { /*Load all slides*/
            $(selector).addClass('loading');
            var save_html = [];
            var allslides = '';
            for(i in obj_data) {
                var saperateslide = '';
                allslides += '<div class="slide index'+(parseInt(i, 10) + 1)+'">'
                for (tag in obj_data[i].tags) {
                    var tag_html = '';
                    if (obj_data[i].tags[tag].name == 'iframe') {
                        if (obj_data[i].videoinbg) {

                        } else {
                            tag_html += '<div class="cover"><span class="play"></span><span class="close"></span></div>';
                        }
                        tag_html += '<' + obj_data[i].tags[tag].name + ' width="';
                        if (obj_data[i].tags[tag].width) {
                            tag_html += obj_data[i].tags[tag].width;
                        } else {
                            tag_html += $(selector).width();
                        }
                        tag_html += '" height="';
                        if (obj_data[i].tags[tag].height) {
                            tag_html += obj_data[i].tags[tag].height;
                        } else {
                            tag_html += $(selector).height();
                        }
                        tag_html += '" src="' + obj_data[i].tags[tag].src + '" frameborder="0" allowfullscreen ';
                        if (obj_data[i].videoinbg) {
                            tag_html += ' class="videoinbg" ';
                        }
                        tag_html += '></'+obj_data[i].tags[tag].name+'>';
                    } else if (obj_data[i].tags[tag].name == 'video') {
                        tag_html += '<' + obj_data[i].tags[tag].name + ' width="';
                        if (obj_data[i].tags[tag].width) {
                            tag_html += obj_data[i].tags[tag].width;
                        } else {
                            tag_html += $(selector).width();
                        }
                        tag_html += '" height="';
                        if (obj_data[i].tags[tag].height) {
                            tag_html += obj_data[i].tags[tag].height;
                        } else {
                            tag_html += $(selector).height();
                        }
                        if (obj_data[i].tags[tag].attr != undefined) {
                            for (atr in obj_data[i].tags[tag].attr) {
                                tag_html += ' ' + atr;
                                tag_html += '="';
                                tag_html += obj_data[i].tags[tag].attr[atr];
                                tag_html += '"';
                            }
                        }
                        tag_html += '" controls >';
                        if (obj_data[i].tags[tag].source != undefined) {
                            for (source in obj_data[i].tags[tag].source) {
                                tag_html += '<source src="' + obj_data[i].tags[tag].source[source] + '" type="video/' + source + '">';
                            }
                        }
                        tag_html += 'Your browser does not support the video tag.';
                        tag_html += '</' + obj_data[i].tags[tag].name + '>';
                    } else {
                        tag_html += '<' + obj_data[i].tags[tag].name;
                        if (obj_data[i].tags[tag].attr != undefined) {
                            for (atr in obj_data[i].tags[tag].attr) {
                                tag_html += ' ' + atr;
                                tag_html += '="';
                                tag_html += obj_data[i].tags[tag].attr[atr];
                                tag_html += '"';
                            }
                        }
                        if (obj_data[i].tags[tag].name != 'img') {
                            tag_html += '>';
                        }
                        if (obj_data[i].tags[tag].content) {
                            tag_html += obj_data[i].tags[tag].content;
                        }
                        if (obj_data[i].tags[tag].name == 'img') {
                            tag_html += ' />';
                        } else {
                            tag_html += '</' + obj_data[i].tags[tag].name + '>';
                        }
                    }
                    allslides += tag_html;
                    saperateslide += tag_html;
                }
                allslides += '</div>';
                save_html.push(saperateslide);
            }
            _this.append(allslides);
            _this.find('.' + settings.pagiclass + '').children('a').on("click", function (e) {
                if (settings.auto[0]) {
                    if (typeof (auto_slide) != undefined) {
                        clearInterval(auto_slide);
                    }
                    auto_slide = setInterval(function () {
                        auto_slide_fun(_this);
                    }, parseInt(settings.auto[1], 10));
                    _this.find('.process').stop();
                    _this.find('.process').css('width', '0px').animate({
                        width: '100%'
                    }, parseInt(settings.auto[1], 10), function () {
                        $(this).css('width', '0px');
                    });
                } else {
                    _this.find('.process').css('width', '0px');
                }
                if(_this.find('.slide.current').length) {
                    var get_class = _this.find('.slide.current').attr('class').split(' ');
                    var index = get_class.indexOf("current");
                    get_class.splice(index, 1);
                    var is_current = parseInt(get_class.pop().slice(-1), 10);
                } else {
                    var is_current = -1;
                }
                var obj_target = parseInt($(this).attr('href'), 10);
                if (settings.circular == false) {
                    if (obj_target == 0) {
                        _this.find('.control').find(settings.prevclass).hide();
                        _this.find('.control').find(settings.nextclass).show();
                    } else if (obj_target == (obj_data.length - 1)) {
                        _this.find('.control').find(settings.nextclass).hide();
                        _this.find('.control').find(settings.prevclass).show();
                    } else {
                        _this.find('.control').find(settings.nextclass).show();
                        _this.find('.control').find(settings.prevclass).show();
                    }
                }
                if (is_current != (obj_target + 1)) {
                    _this.find('.' + settings.pagiclass + ' .active').removeClass('active');
                    $(this).addClass('active');
                    if(save_html[(is_current-1)] && save_html[(is_current-1)] != undefined) {
                        _this.find('.slide.current').html(save_html[(is_current-1)]);
                    }
                    if(settings.slideanimation) {
                        var rand_no = Math.floor((Math.random() * 9) + 1);
                        var ani_class = 'rollOut';
                        if(rand_no == 1) {
                            ani_class = 'lightSpeedOut';
                        } else if(rand_no == 2) {
                            ani_class = 'zoomOutUp';
                        } else if(rand_no == 3) {
                           ani_class = 'zoomOutDown';
                        } else if(rand_no == 4) {
                           ani_class = 'zoomOutLeft';
                        } else if(rand_no == 5) {
                           ani_class = 'zoomOutRight';
                        } else if(rand_no == 6) {
                           ani_class = 'zoomOut';
                        } else if(rand_no == 7) {
                           ani_class = 'rotateOutDownLeft';
                        } else if(rand_no == 8) {
                           ani_class = 'rotateOutDownRight';
                        }
                        _this.find('.slide.current').removeClass('current').css('z-index',999).addClass('animated '+ani_class+'').one('webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend', function () {
                            $(this).removeClass('animate animated '+ani_class+'').css('z-index','');
                        });
                    } else {
                        _this.find('.slide.current').removeClass('current');
                    }
                    _this.find('.index' + (obj_target + 1)).addClass('current');
                    var target = $(selector + ' .' + settings.pagiclass + ' a.active').index();
                    
                    $(selector + ' > div.slide.index'+(obj_target+1)+' > *').not('iframe').each(function () {
                        var _current = $(this);
                        var index = _current.index();
                        if(settings.data[target].videoinbg) {
                            _this.find('.slide.current iframe').attr('src', _this.find('.slide.current iframe').attr('src') + '?autoplay=1&loop=1');
                        }
                        if (settings.data[target].tags[index].cssanimate) {
                            $(_current).addClass('animated ' + settings.data[target].tags[index].cssanimate + '').one('webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend', function () {
                                $(this).removeClass('animate animated ' + settings.data[target].tags[index].cssanimate + '');
                            });
                        }
                        if (settings.data[target].tags[index].aftercssanimate) {
                            if (settings.data[target].tags[index].aftercssanimate.type) {
                                var afterslide = setInterval(function () {
                                    $(_current).addClass('animated ' + settings.data[target].tags[index].aftercssanimate.type + '').one('webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend', function() {
                                        $(this).removeClass('animate animated ' + settings.data[target].tags[index].aftercssanimate.type + '');                                        
                                    });
                                    clearInterval(afterslide);
                                }, settings.data[target].tags[index].aftercssanimate.time);
                            }
                       }
                       if (settings.data[target].tags[index].jqueryanimate) {
                            var cssProperty = settings.data[target].tags[index].jqueryanimate[0];
                            var newStyle = {};
                            newStyle[cssProperty] = settings.data[target].tags[index].jqueryanimate[1];
                            var jqueryanimate = setInterval(function () {
                                $(_current).animate(newStyle, settings.data[target].tags[index].jqueryanimate[2]);
                                clearInterval(jqueryanimate);
                            }, settings.data[target].tags[index].jqueryanimate[3]);
                        }
                        if (settings.data[target].tags[index].afterjqueryanimate) {
                            var AcssProperty = settings.data[target].tags[index].afterjqueryanimate[0];
                            var AnewStyle = {};
                            AnewStyle[AcssProperty] = settings.data[target].tags[index].afterjqueryanimate[1];
                            var afterjqueryanimate = setInterval(function () {
                                $(_current).animate(AnewStyle, settings.data[target].tags[index].afterjqueryanimate[2]);
                                clearInterval(afterjqueryanimate);
                            }, settings.data[target].tags[index].afterjqueryanimate[3]);
                        }
                    });
                    if($(selector).hasClass('loading')) {
                        var img_length = $(selector + ' div.slide.index'+(obj_target + 1)+' img').length;
                        var incri = 0;
                        if(img_length > 0) {
                            $(selector + ' div.slide.index'+(obj_target + 1)+' img').load(function() {
                                if(this.complete) {
                                    incri++;
                                    if(incri == img_length) {
                                        $(selector).removeClass('loading');
                                    }
                                }
                            });
                        } else {
                            $(selector).removeClass('loading');
                        }
                    }
                    if (settings.fullscreen == false) { /*Background image animation*/
                        $(selector + ' > div.slide.index'+(obj_target + 1)).stop();
                        $(selector + ' > div.slide.index'+(obj_target + 1)).removeAttr('style');
                        if (obj_data[obj_target].backgroundamination != undefined) {
                            var ani_val = obj_data[obj_target].backgroundamination[0];
                            var ani_len = parseInt(obj_data[obj_target].backgroundamination[1], 10);
                            $(selector + ' > div.slide.index'+(obj_target + 1)).animate({
                                backgroundSize: ani_val
                            }, ani_len);
                        }
                    }
                }
                e.preventDefault();
            });
        } else { /*Load slide one by one*/
            _this.find('.' + settings.pagiclass + '').children('a').on("click", function (e) {
                if (settings.auto[0]) {
                    if (typeof (auto_slide) != undefined) {
                        clearInterval(auto_slide);
                    }
                    auto_slide = setInterval(function () {
                        auto_slide_fun(_this);
                    }, parseInt(settings.auto[1], 10));
                    _this.find('.process').stop();
                    _this.find('.process').css('width', '0px').animate({
                        width: '100%'
                    }, parseInt(settings.auto[1], 10), function () {
                        $(this).css('width', '0px');
                    });
                } else {
                    _this.find('.process').css('width', '0px');
                }
                var is_current = parseInt(_this.find('.slide').attr('class').split(' ').pop().slice(-1), 10);
                var obj_target = parseInt($(this).attr('href'), 10);
                if (settings.circular == false) {
                    if (obj_target == 0) {
                        _this.find('.control').find(settings.prevclass).hide();
                        _this.find('.control').find(settings.nextclass).show();
                    } else if (obj_target == (obj_data.length - 1)) {
                        _this.find('.control').find(settings.nextclass).hide();
                        _this.find('.control').find(settings.prevclass).show();
                    } else {
                        _this.find('.control').find(settings.nextclass).show();
                        _this.find('.control').find(settings.prevclass).show();
                    }
                }
                if (is_current != (obj_target + 1)) {
                    $(selector).addClass('loading');
                    $(selector + ' > div.slide > *').remove();
                    _this.find('.' + settings.pagiclass + '').find('.active').removeClass('active');
                    $(this).addClass('active');
                    var objtags = obj_data[obj_target].tags;
                    var ani_classes = '';                    
                    for (tag in objtags) {
                        var tag_html = '';
                        if (objtags[tag].name == 'iframe') {
                            if (obj_data[obj_target].videoinbg) {

                            } else {
                                tag_html += '<div class="cover"><span class="play"></span><span class="close"></span></div>';
                            }
                            tag_html += '<' + objtags[tag].name + ' width="';
                            if (objtags[tag].width) {
                                tag_html += objtags[tag].width;
                            } else {
                                tag_html += $(selector).width();
                            }
                            tag_html += '" height="';
                            if (objtags[tag].height) {
                                tag_html += objtags[tag].height;
                            } else {
                                tag_html += $(selector).height();
                            }
                            tag_html += '" src="' + objtags[tag].src + '" frameborder="0" allowfullscreen ';
                            if (obj_data[obj_target].videoinbg) {
                                tag_html += ' class="videoinbg" ';
                            }
                            tag_html += '></'+objtags[tag].name+'>';
                        } else if (objtags[tag].name == 'video') {
                            tag_html += '<' + objtags[tag].name + ' width="';
                            if (objtags[tag].width) {
                                tag_html += objtags[tag].width;
                            } else {
                                tag_html += $(selector).width();
                            }
                            tag_html += '" height="';
                            if (objtags[tag].height) {
                                tag_html += objtags[tag].height;
                            } else {
                                tag_html += $(selector).height();
                            }
                            if (objtags[tag].attr != undefined) {
                                for (atr in objtags[tag].attr) {
                                    tag_html += ' ' + atr;
                                    tag_html += '="';
                                    tag_html += objtags[tag].attr[atr];
                                    tag_html += '"';
                                }
                            }
                            tag_html += '" controls >';
                            if (objtags[tag].source != undefined) {
                                for (source in objtags[tag].source) {
                                    tag_html += '<source src="' + objtags[tag].source[source] + '" type="video/' + source + '">';
                                }
                            }
                            tag_html += 'Your browser does not support the video tag.';
                            tag_html += '</' + objtags[tag].name + '>';
                        } else {
                            tag_html += '<' + objtags[tag].name;
                            if (objtags[tag].attr != undefined) {
                                for (atr in objtags[tag].attr) {
                                    tag_html += ' ' + atr;
                                    tag_html += '="';
                                    tag_html += objtags[tag].attr[atr];
                                    tag_html += '"';
                                }
                            }
                            if (objtags[tag].name != 'img') {
                                tag_html += '>';
                            }
                            if (objtags[tag].content) {
                                tag_html += objtags[tag].content;
                            }
                            if (objtags[tag].name == 'img') {
                                tag_html += ' />';
                            } else {
                                tag_html += '</' + objtags[tag].name + '>';
                            }
                        }
                        $(selector + ' > div.slide').append(tag_html);
                        ani_classes += ' ' + objtags[tag].cssanimate;
                    }
                    var img_length = $(selector + ' > div.slide img').length;
                    var incri = 0;
                    if(img_length == 0) {
                        $(selector).removeClass('loading');
                        for (tag in objtags) {
                            if (objtags[tag].cssanimate) {
                                $(selector + ' > div.slide > *').eq(tag).addClass('animated ' + objtags[tag].cssanimate + '').one('webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend', function() {
                                    $(this).removeClass('animate animated ' + ani_classes + '');
                                });
                            }
                        }
                    } else {
                        $(selector + ' > div.slide img').load(function() {
                            if(this.complete) {
                                incri++;
                                if(incri == img_length) {
                                    $(selector).removeClass('loading');
                                    for (tag in objtags) {
                                        if (objtags[tag].cssanimate) {
                                            $(selector + ' > div.slide > *').eq(tag).addClass('animated ' + objtags[tag].cssanimate + '').one('webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend', function() {
                                                $(this).removeClass('animate animated ' + ani_classes + '');
                                            });
                                        }
                                    }
                                }
                            }
                        });
                    }
                    var prevclass = $(selector + ' > div.slide').attr('class').split(' ').pop();
                    $(selector + ' > div.slide').removeClass(prevclass).addClass('index' + (obj_target + 1));

                    if (settings.fullscreen == false) { /*Background image animation*/
                        $(selector + ' > div.slide').stop();
                        $(selector + ' > div.slide').removeAttr('style');
                        if (obj_data[obj_target].backgroundamination != undefined) {
                            var ani_val = obj_data[obj_target].backgroundamination[0];
                            var ani_len = parseInt(obj_data[obj_target].backgroundamination[1], 10);
                            $(selector + ' > div.slide').animate({
                                backgroundSize: ani_val
                            }, ani_len);
                        }
                    }
                }
                
                $(selector + ' > div.slide > *').not('iframe').each(function () {
                    var _current = $(this);
                    var target = $(selector + ' .' + settings.pagiclass + ' a.active').index();
                    var index = _current.index();
                    if (settings.data[target].tags[index].aftercssanimate) {
                        if (settings.data[target].tags[index].aftercssanimate.type) {
                            var afterslide = setInterval(function () {
                                $(_current).addClass('animated ' + settings.data[target].tags[index].aftercssanimate.type + '').one('webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend', function() {
                                    $(this).removeClass('animate animated ' + settings.data[target].tags[index].aftercssanimate.type + '');                                
                                });
                                clearInterval(afterslide);
                            }, settings.data[target].tags[index].aftercssanimate.time);
                        }
                    }
                    if (settings.data[target].tags[index].jqueryanimate) {
                        var cssProperty = settings.data[target].tags[index].jqueryanimate[0];
                        var newStyle = {};
                        newStyle[cssProperty] = settings.data[target].tags[index].jqueryanimate[1];
                        var jqueryanimate = setInterval(function () {
                            $(_current).animate(newStyle, settings.data[target].tags[index].jqueryanimate[2]);
                            clearInterval(jqueryanimate);
                        }, settings.data[target].tags[index].jqueryanimate[3]);
                    }
                    if (settings.data[target].tags[index].afterjqueryanimate) {
                        var AcssProperty = settings.data[target].tags[index].afterjqueryanimate[0];
                        var AnewStyle = {};
                        AnewStyle[AcssProperty] = settings.data[target].tags[index].afterjqueryanimate[1];
                        var afterjqueryanimate = setInterval(function () {
                            $(_current).animate(AnewStyle, settings.data[target].tags[index].afterjqueryanimate[2]);
                            clearInterval(afterjqueryanimate);
                        }, settings.data[target].tags[index].afterjqueryanimate[3]);
                    }
                });
                e.preventDefault();
            });
        }

        if (settings.fullscreen) { /*Auto set slider height as window height*/
            var fullscreen = jQuery(window).height();
            fullscreen = parseInt(fullscreen, 10);
            _this.find('.slide').height(fullscreen);
        }
        
        var get_active_slide = active_slide;
        if (window.location.search) { /*Change slide as per URL get parameter*/
            var get_param = window.location.search.replace("?", "");
            if (get_param.indexOf('&') > -1) {
                get_param = get_param.split("&");
                for (i in get_param) {
                    if (get_param[i].indexOf('slide') > -1) {
                        var get_no_param = get_param[i].split("=");
                        get_no_param.reverse();
                        get_no_param = get_no_param[0];
                    }
                }
            } else {
                var get_no_param = get_param.split("=");
                get_no_param.reverse();
                get_no_param = get_no_param[0];
            }
            get_no_param = get_no_param - 1;
            if (get_no_param < obj_data.length) {
                get_active_slide = get_no_param;
            }
        }
        _this.find('.' + settings.pagiclass + ' a[href=' + get_active_slide + ']').trigger('click');           
        
    });

    function auto_slide_fun(ele) { /*Auto slide function*/
        if (ele.find('.' + settings.pagiclass + '').find('.active').next().length > 0) {
            ele.find('.' + settings.pagiclass + '').find('.active').next().trigger('click');
        } else {
            ele.find('.' + settings.pagiclass + ' a:first-child').trigger('click');
        }
    }

};

/*Swipe left & right event*/
(function ($) {
    $.attrFn = $.attrFn || {};
    var agent = navigator.userAgent.toLowerCase(),
        isChromeDesktop = (agent.indexOf('chrome') > -1 && ((agent.indexOf('windows') > -1) || (agent.indexOf('macintosh') > -1) || (agent.indexOf('linux') > -1)) && agent.indexOf('mobile') < 0 && agent.indexOf('android') < 0),
        settings = {
            tap_pixel_range: 5,
            swipe_h_threshold: 50,
            swipe_v_threshold: 50,
            taphold_threshold: 750,
            doubletap_int: 500,
            touch_capable: ('ontouchstart' in window && !isChromeDesktop),
            orientation_support: ('orientation' in window && 'onorientationchange' in window),
            startevent:  (('ontouchstart' in window && !isChromeDesktop) ? 'touchstart' : 'mousedown'),
            endevent:    (('ontouchstart' in window && !isChromeDesktop) ? 'touchend' : 'mouseup'),
            moveevent:   (('ontouchstart' in window && !isChromeDesktop) ? 'touchmove' : 'mousemove'),
            tapevent:    ('ontouchstart' in window && !isChromeDesktop) ? 'tap' : 'click',
            scrollevent: ('ontouchstart' in window && !isChromeDesktop) ? 'touchmove' : 'scroll',
            hold_timer: null,
            tap_timer: null
        };
    $.each(['swipeup', 'swiperight', 'swipedown', 'swipeleft'], function (i, name) {
        $.fn[name] = function (fn) {
            return fn ? this.on(name, fn) : this.trigger(name);
        };

        $.attrFn[name] = true;
    });
    $.event.special.swipe = {
        setup: function () {
            var thisObject = this,
                $this = $(thisObject),
                started = false,
                hasSwiped = false,
                originalCoord = {
                    x: 0,
                    y: 0
                },
                finalCoord = {
                    x: 0,
                    y: 0
                },
                startEvnt;
            function touchStart(e) {
                $this = $(e.currentTarget);
                $this.data('callee1', touchStart);
                originalCoord.x = (e.originalEvent.targetTouches) ? e.originalEvent.targetTouches[0].pageX : e.pageX;
                originalCoord.y = (e.originalEvent.targetTouches) ? e.originalEvent.targetTouches[0].pageY : e.pageY;
                finalCoord.x = originalCoord.x;
                finalCoord.y = originalCoord.y;
                started = true;
                var origEvent = e.originalEvent;
                // Read event data into our startEvt:
                startEvnt = {
                    'position': {
                        'x': (settings.touch_capable) ? origEvent.touches[0].screenX : e.screenX,
                        'y': (settings.touch_capable) ? origEvent.touches[0].screenY : e.screenY
                    },
                    'offset': {
                        'x': (settings.touch_capable) ? Math.round(origEvent.changedTouches[0].pageX - $this.position().left) : Math.round(e.pageX - $this.position().left),
                        'y': (settings.touch_capable) ? Math.round(origEvent.changedTouches[0].pageY - $this.position().top) : Math.round(e.pageY - $this.position().top)
                    },
                    'time': Date.now(),
                    'target': e.target
                };
            }
            function touchMove(e) {
                $this = $(e.currentTarget);
                $this.data('callee2', touchMove);
                finalCoord.x = (e.originalEvent.targetTouches) ? e.originalEvent.targetTouches[0].pageX : e.pageX;
                finalCoord.y = (e.originalEvent.targetTouches) ? e.originalEvent.targetTouches[0].pageY : e.pageY;
                var swipedir;
                var ele_x_threshold = ($this.parent().data('xthreshold')) ? $this.parent().data('xthreshold') : $this.data('xthreshold'),
                    ele_y_threshold = ($this.parent().data('ythreshold')) ? $this.parent().data('ythreshold') : $this.data('ythreshold'),
                    h_threshold = (typeof ele_x_threshold !== 'undefined' && ele_x_threshold !== false && parseInt(ele_x_threshold)) ? parseInt(ele_x_threshold) : settings.swipe_h_threshold,
                    v_threshold = (typeof ele_y_threshold !== 'undefined' && ele_y_threshold !== false && parseInt(ele_y_threshold)) ? parseInt(ele_y_threshold) : settings.swipe_v_threshold; 
                if (originalCoord.y > finalCoord.y && (originalCoord.y - finalCoord.y > v_threshold)) {
                    swipedir = 'swipeup';
                }
                if (originalCoord.x < finalCoord.x && (finalCoord.x - originalCoord.x > h_threshold)) {
                    swipedir = 'swiperight';
                }
                if (originalCoord.y < finalCoord.y && (finalCoord.y - originalCoord.y > v_threshold)) {
                    swipedir = 'swipedown';
                }
                if (originalCoord.x > finalCoord.x && (originalCoord.x - finalCoord.x > h_threshold)) {
                    swipedir = 'swipeleft';
                }
                if (swipedir != undefined && started) {
                    originalCoord.x = 0;
                    originalCoord.y = 0;
                    finalCoord.x = 0;
                    finalCoord.y = 0;
                    started = false;
                    var origEvent = e.originalEvent;
                    var endEvnt = {
                        'position': {
                            'x': (settings.touch_capable) ? origEvent.touches[0].screenX : e.screenX,
                            'y': (settings.touch_capable) ? origEvent.touches[0].screenY : e.screenY
                        },
                        'offset': {
                            'x': (settings.touch_capable) ? Math.round(origEvent.changedTouches[0].pageX - $this.position().left) : Math.round(e.pageX - $this.position().left),
                            'y': (settings.touch_capable) ? Math.round(origEvent.changedTouches[0].pageY - $this.position().top) : Math.round(e.pageY - $this.position().top)
                        },
                        'time': Date.now(),
                        'target': e.target
                    };
                    var xAmount = Math.abs(startEvnt.position.x - endEvnt.position.x),
                        yAmount = Math.abs(startEvnt.position.y - endEvnt.position.y);
                    var touchData = {
                        'startEvnt': startEvnt,
                        'endEvnt': endEvnt,
                        'direction': swipedir.replace('swipe', ''),
                        'xAmount': xAmount,
                        'yAmount': yAmount,
                        'duration': endEvnt.time - startEvnt.time
                    };
                    hasSwiped = true;
                    $this.trigger('swipe', touchData).trigger(swipedir, touchData);
                }
            }
            function touchEnd(e) {
                $this = $(e.currentTarget);
                var swipedir = "";
                $this.data('callee3', touchEnd);
                if (hasSwiped) {
                    var ele_x_threshold = $this.data('xthreshold'),
                        ele_y_threshold = $this.data('ythreshold'),
                        h_threshold = (typeof ele_x_threshold !== 'undefined' && ele_x_threshold !== false && parseInt(ele_x_threshold)) ? parseInt(ele_x_threshold) : settings.swipe_h_threshold,
                        v_threshold = (typeof ele_y_threshold !== 'undefined' && ele_y_threshold !== false && parseInt(ele_y_threshold)) ? parseInt(ele_y_threshold) : settings.swipe_v_threshold;
                    var origEvent = e.originalEvent;
                    var endEvnt = {
                        'position': {
                            'x': (settings.touch_capable) ? origEvent.changedTouches[0].screenX : e.screenX,
                            'y': (settings.touch_capable) ? origEvent.changedTouches[0].screenY : e.screenY
                        },
                        'offset': {
                            'x': (settings.touch_capable) ? Math.round(origEvent.changedTouches[0].pageX - $this.position().left) : Math.round(e.pageX - $this.position().left),
                            'y': (settings.touch_capable) ? Math.round(origEvent.changedTouches[0].pageY - $this.position().top) : Math.round(e.pageY - $this.position().top)
                        },
                        'time': Date.now(),
                        'target': e.target
                    };
                    if (startEvnt.position.y > endEvnt.position.y && (startEvnt.position.y - endEvnt.position.y > v_threshold)) {
                        swipedir = 'swipeup';
                    }
                    if (startEvnt.position.x < endEvnt.position.x && (endEvnt.position.x - startEvnt.position.x > h_threshold)) {
                        swipedir = 'swiperight';
                    }
                    if (startEvnt.position.y < endEvnt.position.y && (endEvnt.position.y - startEvnt.position.y > v_threshold)) {
                        swipedir = 'swipedown';
                    }
                    if (startEvnt.position.x > endEvnt.position.x && (startEvnt.position.x - endEvnt.position.x > h_threshold)) {
                        swipedir = 'swipeleft';
                    }
                    var xAmount = Math.abs(startEvnt.position.x - endEvnt.position.x),
                        yAmount = Math.abs(startEvnt.position.y - endEvnt.position.y);
                    var touchData = {
                        'startEvnt': startEvnt,
                        'endEvnt': endEvnt,
                        'direction': swipedir.replace('swipe', ''),
                        'xAmount': xAmount,
                        'yAmount': yAmount,
                        'duration': endEvnt.time - startEvnt.time
                    };
                    $this.trigger('swipeend', touchData);
                }
                started = false;
                hasSwiped = false;
            }
            $this.on(settings.startevent, touchStart);
            $this.on(settings.moveevent, touchMove);
            $this.on(settings.endevent, touchEnd);
        },
        remove: function () {
            $(this).off(settings.startevent, $(this).data.callee1).off(settings.moveevent, $(this).data.callee2).off(settings.endevent, $(this).data.callee3);
        }
    };
    $.event.special.orientationchange = special_event = {
        setup: function () {
            if (settings.orientation_support) {
                return false;
            }
            last_orientation = get_orientation();
            window.on('throttledresize', handler);
            return true;
        },
        teardown: function () {
            if (settings.orientation_support) {
                return false;
            }
            window.off('throttledresize', handler);
            return true;
        },
        add: function (handleObj) {
            var old_handler = handleObj.handler;
            handleObj.handler = function (event) {
                event.orientation = get_orientation();
                return old_handler.apply(this, arguments);
            };
        }
    };
    function handler() {
        var orientation = get_orientation();
        if (orientation !== last_orientation) {
            last_orientation = orientation;
            window.trigger("orientationchange");
        }
    }
    $.event.special.orientationchange.orientation = get_orientation = function () {
        var isPortrait = true,
            elem = document.documentElement;
        if (settings.orientation_support) {
            isPortrait = portrait_map[window.orientation];
        } else {
            isPortrait = elem && elem.clientWidth / elem.clientHeight < 1.1;
        }
        return isPortrait ? 'portrait' : 'landscape';
    };
    $.event.special.throttledresize = {
        setup: function () {
            $(this).on('resize', throttle_handler);
        },
        teardown: function () {
            $(this).off('resize', throttle_handler);
        }
    };
    var throttle = 250,
        throttle_handler = function () {
            curr = Date.now();
            diff = curr - lastCall;
            if (diff >= throttle) {
                lastCall = curr;
                $(this).trigger('throttledresize');
            } else {
                if (heldCall) {
                    window.clearTimeout(heldCall);
                }
                heldCall = window.setTimeout(handler, throttle - diff);
            }
        },
        lastCall = 0,
        heldCall,
        curr,
        diff;
    function triggerCustomEvent(obj, eventType, event, touchData) {
        var originalType = event.type;
        event.type = eventType;

        $.event.dispatch.call(obj, event, touchData);
        event.type = originalType;
    }
    $.each({
        scrollend: 'scrollstart',
        swipeup: 'swipe',
        swiperight: 'swipe',
        swipedown: 'swipe',
        swipeleft: 'swipe',
        swipeend: 'swipe',
        tap2: 'tap'
    }, function (e, srcE) {
        $.event.special[e] = {
            setup: function () {
                $(this).on(srcE, $.noop);
            }
        };
    });
}(jQuery));
/* Modernizr 2.6.2 (Custom Build) | MIT & BSD
 * Build: http://modernizr.com/download/#-fontface-backgroundsize-borderimage-borderradius-boxshadow-flexbox-flexboxlegacy-hsla-multiplebgs-opacity-rgba-textshadow-cssanimations-csscolumns-generatedcontent-cssgradients-cssreflections-csstransforms-csstransforms3d-csstransitions-applicationcache-canvas-canvastext-draganddrop-hashchange-history-audio-video-indexeddb-input-inputtypes-localstorage-postmessage-sessionstorage-websockets-websqldatabase-webworkers-geolocation-inlinesvg-smil-svg-svgclippaths-touch-webgl-shiv-cssclasses-teststyles-testprop-testallprops-hasevent-prefixes-domprefixes-load
 */
;window.Modernizr=function(a,b,c){function C(a){j.cssText=a}function D(a,b){return C(n.join(a+";")+(b||""))}function E(a,b){return typeof a===b}function F(a,b){return!!~(""+a).indexOf(b)}function G(a,b){for(var d in a){var e=a[d];if(!F(e,"-")&&j[e]!==c)return b=="pfx"?e:!0}return!1}function H(a,b,d){for(var e in a){var f=b[a[e]];if(f!==c)return d===!1?a[e]:E(f,"function")?f.bind(d||b):f}return!1}function I(a,b,c){var d=a.charAt(0).toUpperCase()+a.slice(1),e=(a+" "+p.join(d+" ")+d).split(" ");return E(b,"string")||E(b,"undefined")?G(e,b):(e=(a+" "+q.join(d+" ")+d).split(" "),H(e,b,c))}function J(){e.input=function(c){for(var d=0,e=c.length;d<e;d++)u[c[d]]=c[d]in k;return u.list&&(u.list=!!b.createElement("datalist")&&!!a.HTMLDataListElement),u}("autocomplete autofocus list placeholder max min multiple pattern required step".split(" ")),e.inputtypes=function(a){for(var d=0,e,f,h,i=a.length;d<i;d++)k.setAttribute("type",f=a[d]),e=k.type!=="text",e&&(k.value=l,k.style.cssText="position:absolute;visibility:hidden;",/^range$/.test(f)&&k.style.WebkitAppearance!==c?(g.appendChild(k),h=b.defaultView,e=h.getComputedStyle&&h.getComputedStyle(k,null).WebkitAppearance!=="textfield"&&k.offsetHeight!==0,g.removeChild(k)):/^(search|tel)$/.test(f)||(/^(url|email)$/.test(f)?e=k.checkValidity&&k.checkValidity()===!1:e=k.value!=l)),t[a[d]]=!!e;return t}("search tel url email datetime date month week time datetime-local number range color".split(" "))}var d="2.6.2",e={},f=!0,g=b.documentElement,h="modernizr",i=b.createElement(h),j=i.style,k=b.createElement("input"),l=":)",m={}.toString,n=" -webkit- -moz- -o- -ms- ".split(" "),o="Webkit Moz O ms",p=o.split(" "),q=o.toLowerCase().split(" "),r={svg:"http://www.w3.org/2000/svg"},s={},t={},u={},v=[],w=v.slice,x,y=function(a,c,d,e){var f,i,j,k,l=b.createElement("div"),m=b.body,n=m||b.createElement("body");if(parseInt(d,10))while(d--)j=b.createElement("div"),j.id=e?e[d]:h+(d+1),l.appendChild(j);return f=["&#173;",'<style id="s',h,'">',a,"</style>"].join(""),l.id=h,(m?l:n).innerHTML+=f,n.appendChild(l),m||(n.style.background="",n.style.overflow="hidden",k=g.style.overflow,g.style.overflow="hidden",g.appendChild(n)),i=c(l,a),m?l.parentNode.removeChild(l):(n.parentNode.removeChild(n),g.style.overflow=k),!!i},z=function(){function d(d,e){e=e||b.createElement(a[d]||"div"),d="on"+d;var f=d in e;return f||(e.setAttribute||(e=b.createElement("div")),e.setAttribute&&e.removeAttribute&&(e.setAttribute(d,""),f=E(e[d],"function"),E(e[d],"undefined")||(e[d]=c),e.removeAttribute(d))),e=null,f}var a={select:"input",change:"input",submit:"form",reset:"form",error:"img",load:"img",abort:"img"};return d}(),A={}.hasOwnProperty,B;!E(A,"undefined")&&!E(A.call,"undefined")?B=function(a,b){return A.call(a,b)}:B=function(a,b){return b in a&&E(a.constructor.prototype[b],"undefined")},Function.prototype.bind||(Function.prototype.bind=function(b){var c=this;if(typeof c!="function")throw new TypeError;var d=w.call(arguments,1),e=function(){if(this instanceof e){var a=function(){};a.prototype=c.prototype;var f=new a,g=c.apply(f,d.concat(w.call(arguments)));return Object(g)===g?g:f}return c.apply(b,d.concat(w.call(arguments)))};return e}),s.flexbox=function(){return I("flexWrap")},s.flexboxlegacy=function(){return I("boxDirection")},s.canvas=function(){var a=b.createElement("canvas");return!!a.getContext&&!!a.getContext("2d")},s.canvastext=function(){return!!e.canvas&&!!E(b.createElement("canvas").getContext("2d").fillText,"function")},s.webgl=function(){return!!a.WebGLRenderingContext},s.touch=function(){var c;return"ontouchstart"in a||a.DocumentTouch&&b instanceof DocumentTouch?c=!0:y(["@media (",n.join("touch-enabled),("),h,")","{#modernizr{top:9px;position:absolute}}"].join(""),function(a){c=a.offsetTop===9}),c},s.geolocation=function(){return"geolocation"in navigator},s.postmessage=function(){return!!a.postMessage},s.websqldatabase=function(){return!!a.openDatabase},s.indexedDB=function(){return!!I("indexedDB",a)},s.hashchange=function(){return z("hashchange",a)&&(b.documentMode===c||b.documentMode>7)},s.history=function(){return!!a.history&&!!history.pushState},s.draganddrop=function(){var a=b.createElement("div");return"draggable"in a||"ondragstart"in a&&"ondrop"in a},s.websockets=function(){return"WebSocket"in a||"MozWebSocket"in a},s.rgba=function(){return C("background-color:rgba(150,255,150,.5)"),F(j.backgroundColor,"rgba")},s.hsla=function(){return C("background-color:hsla(120,40%,100%,.5)"),F(j.backgroundColor,"rgba")||F(j.backgroundColor,"hsla")},s.multiplebgs=function(){return C("background:url(https://),url(https://),red url(https://)"),/(url\s*\(.*?){3}/.test(j.background)},s.backgroundsize=function(){return I("backgroundSize")},s.borderimage=function(){return I("borderImage")},s.borderradius=function(){return I("borderRadius")},s.boxshadow=function(){return I("boxShadow")},s.textshadow=function(){return b.createElement("div").style.textShadow===""},s.opacity=function(){return D("opacity:.55"),/^0.55$/.test(j.opacity)},s.cssanimations=function(){return I("animationName")},s.csscolumns=function(){return I("columnCount")},s.cssgradients=function(){var a="background-image:",b="gradient(linear,left top,right bottom,from(#9f9),to(white));",c="linear-gradient(left top,#9f9, white);";return C((a+"-webkit- ".split(" ").join(b+a)+n.join(c+a)).slice(0,-a.length)),F(j.backgroundImage,"gradient")},s.cssreflections=function(){return I("boxReflect")},s.csstransforms=function(){return!!I("transform")},s.csstransforms3d=function(){var a=!!I("perspective");return a&&"webkitPerspective"in g.style&&y("@media (transform-3d),(-webkit-transform-3d){#modernizr{left:9px;position:absolute;height:3px;}}",function(b,c){a=b.offsetLeft===9&&b.offsetHeight===3}),a},s.csstransitions=function(){return I("transition")},s.fontface=function(){var a;return y('@font-face {font-family:"font";src:url("https://")}',function(c,d){var e=b.getElementById("smodernizr"),f=e.sheet||e.styleSheet,g=f?f.cssRules&&f.cssRules[0]?f.cssRules[0].cssText:f.cssText||"":"";a=/src/i.test(g)&&g.indexOf(d.split(" ")[0])===0}),a},s.generatedcontent=function(){var a;return y(["#",h,"{font:0/0 a}#",h,':after{content:"',l,'";visibility:hidden;font:3px/1 a}'].join(""),function(b){a=b.offsetHeight>=3}),a},s.video=function(){var a=b.createElement("video"),c=!1;try{if(c=!!a.canPlayType)c=new Boolean(c),c.ogg=a.canPlayType('video/ogg; codecs="theora"').replace(/^no$/,""),c.h264=a.canPlayType('video/mp4; codecs="avc1.42E01E"').replace(/^no$/,""),c.webm=a.canPlayType('video/webm; codecs="vp8, vorbis"').replace(/^no$/,"")}catch(d){}return c},s.audio=function(){var a=b.createElement("audio"),c=!1;try{if(c=!!a.canPlayType)c=new Boolean(c),c.ogg=a.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),c.mp3=a.canPlayType("audio/mpeg;").replace(/^no$/,""),c.wav=a.canPlayType('audio/wav; codecs="1"').replace(/^no$/,""),c.m4a=(a.canPlayType("audio/x-m4a;")||a.canPlayType("audio/aac;")).replace(/^no$/,"")}catch(d){}return c},s.localstorage=function(){try{return localStorage.setItem(h,h),localStorage.removeItem(h),!0}catch(a){return!1}},s.sessionstorage=function(){try{return sessionStorage.setItem(h,h),sessionStorage.removeItem(h),!0}catch(a){return!1}},s.webworkers=function(){return!!a.Worker},s.applicationcache=function(){return!!a.applicationCache},s.svg=function(){return!!b.createElementNS&&!!b.createElementNS(r.svg,"svg").createSVGRect},s.inlinesvg=function(){var a=b.createElement("div");return a.innerHTML="<svg/>",(a.firstChild&&a.firstChild.namespaceURI)==r.svg},s.smil=function(){return!!b.createElementNS&&/SVGAnimate/.test(m.call(b.createElementNS(r.svg,"animate")))},s.svgclippaths=function(){return!!b.createElementNS&&/SVGClipPath/.test(m.call(b.createElementNS(r.svg,"clipPath")))};for(var K in s)B(s,K)&&(x=K.toLowerCase(),e[x]=s[K](),v.push((e[x]?"":"no-")+x));return e.input||J(),e.addTest=function(a,b){if(typeof a=="object")for(var d in a)B(a,d)&&e.addTest(d,a[d]);else{a=a.toLowerCase();if(e[a]!==c)return e;b=typeof b=="function"?b():b,typeof f!="undefined"&&f&&(g.className+=" "+(b?"":"no-")+a),e[a]=b}return e},C(""),i=k=null,function(a,b){function k(a,b){var c=a.createElement("p"),d=a.getElementsByTagName("head")[0]||a.documentElement;return c.innerHTML="x<style>"+b+"</style>",d.insertBefore(c.lastChild,d.firstChild)}function l(){var a=r.elements;return typeof a=="string"?a.split(" "):a}function m(a){var b=i[a[g]];return b||(b={},h++,a[g]=h,i[h]=b),b}function n(a,c,f){c||(c=b);if(j)return c.createElement(a);f||(f=m(c));var g;return f.cache[a]?g=f.cache[a].cloneNode():e.test(a)?g=(f.cache[a]=f.createElem(a)).cloneNode():g=f.createElem(a),g.canHaveChildren&&!d.test(a)?f.frag.appendChild(g):g}function o(a,c){a||(a=b);if(j)return a.createDocumentFragment();c=c||m(a);var d=c.frag.cloneNode(),e=0,f=l(),g=f.length;for(;e<g;e++)d.createElement(f[e]);return d}function p(a,b){b.cache||(b.cache={},b.createElem=a.createElement,b.createFrag=a.createDocumentFragment,b.frag=b.createFrag()),a.createElement=function(c){return r.shivMethods?n(c,a,b):b.createElem(c)},a.createDocumentFragment=Function("h,f","return function(){var n=f.cloneNode(),c=n.createElement;h.shivMethods&&("+l().join().replace(/\w+/g,function(a){return b.createElem(a),b.frag.createElement(a),'c("'+a+'")'})+");return n}")(r,b.frag)}function q(a){a||(a=b);var c=m(a);return r.shivCSS&&!f&&!c.hasCSS&&(c.hasCSS=!!k(a,"article,aside,figcaption,figure,footer,header,hgroup,nav,section{display:block}mark{background:#FF0;color:#000}")),j||p(a,c),a}var c=a.html5||{},d=/^<|^(?:button|map|select|textarea|object|iframe|option|optgroup)$/i,e=/^(?:a|b|code|div|fieldset|h1|h2|h3|h4|h5|h6|i|label|li|ol|p|q|span|strong|style|table|tbody|td|th|tr|ul)$/i,f,g="_html5shiv",h=0,i={},j;(function(){try{var a=b.createElement("a");a.innerHTML="<xyz></xyz>",f="hidden"in a,j=a.childNodes.length==1||function(){b.createElement("a");var a=b.createDocumentFragment();return typeof a.cloneNode=="undefined"||typeof a.createDocumentFragment=="undefined"||typeof a.createElement=="undefined"}()}catch(c){f=!0,j=!0}})();var r={elements:c.elements||"abbr article aside audio bdi canvas data datalist details figcaption figure footer header hgroup mark meter nav output progress section summary time video",shivCSS:c.shivCSS!==!1,supportsUnknownElements:j,shivMethods:c.shivMethods!==!1,type:"default",shivDocument:q,createElement:n,createDocumentFragment:o};a.html5=r,q(b)}(this,b),e._version=d,e._prefixes=n,e._domPrefixes=q,e._cssomPrefixes=p,e.hasEvent=z,e.testProp=function(a){return G([a])},e.testAllProps=I,e.testStyles=y,g.className=g.className.replace(/(^|\s)no-js(\s|$)/,"$1$2")+(f?" js "+v.join(" "):""),e}(this,this.document),function(a,b,c){function d(a){return"[object Function]"==o.call(a)}function e(a){return"string"==typeof a}function f(){}function g(a){return!a||"loaded"==a||"complete"==a||"uninitialized"==a}function h(){var a=p.shift();q=1,a?a.t?m(function(){("c"==a.t?B.injectCss:B.injectJs)(a.s,0,a.a,a.x,a.e,1)},0):(a(),h()):q=0}function i(a,c,d,e,f,i,j){function k(b){if(!o&&g(l.readyState)&&(u.r=o=1,!q&&h(),l.onload=l.onreadystatechange=null,b)){"img"!=a&&m(function(){t.removeChild(l)},50);for(var d in y[c])y[c].hasOwnProperty(d)&&y[c][d].onload()}}var j=j||B.errorTimeout,l=b.createElement(a),o=0,r=0,u={t:d,s:c,e:f,a:i,x:j};1===y[c]&&(r=1,y[c]=[]),"object"==a?l.data=c:(l.src=c,l.type=a),l.width=l.height="0",l.onerror=l.onload=l.onreadystatechange=function(){k.call(this,r)},p.splice(e,0,u),"img"!=a&&(r||2===y[c]?(t.insertBefore(l,s?null:n),m(k,j)):y[c].push(l))}function j(a,b,c,d,f){return q=0,b=b||"j",e(a)?i("c"==b?v:u,a,b,this.i++,c,d,f):(p.splice(this.i++,0,a),1==p.length&&h()),this}function k(){var a=B;return a.loader={load:j,i:0},a}var l=b.documentElement,m=a.setTimeout,n=b.getElementsByTagName("script")[0],o={}.toString,p=[],q=0,r="MozAppearance"in l.style,s=r&&!!b.createRange().compareNode,t=s?l:n.parentNode,l=a.opera&&"[object Opera]"==o.call(a.opera),l=!!b.attachEvent&&!l,u=r?"object":l?"script":"img",v=l?"script":u,w=Array.isArray||function(a){return"[object Array]"==o.call(a)},x=[],y={},z={timeout:function(a,b){return b.length&&(a.timeout=b[0]),a}},A,B;B=function(a){function b(a){var a=a.split("!"),b=x.length,c=a.pop(),d=a.length,c={url:c,origUrl:c,prefixes:a},e,f,g;for(f=0;f<d;f++)g=a[f].split("="),(e=z[g.shift()])&&(c=e(c,g));for(f=0;f<b;f++)c=x[f](c);return c}function g(a,e,f,g,h){var i=b(a),j=i.autoCallback;i.url.split(".").pop().split("?").shift(),i.bypass||(e&&(e=d(e)?e:e[a]||e[g]||e[a.split("/").pop().split("?")[0]]),i.instead?i.instead(a,e,f,g,h):(y[i.url]?i.noexec=!0:y[i.url]=1,f.load(i.url,i.forceCSS||!i.forceJS&&"css"==i.url.split(".").pop().split("?").shift()?"c":c,i.noexec,i.attrs,i.timeout),(d(e)||d(j))&&f.load(function(){k(),e&&e(i.origUrl,h,g),j&&j(i.origUrl,h,g),y[i.url]=2})))}function h(a,b){function c(a,c){if(a){if(e(a))c||(j=function(){var a=[].slice.call(arguments);k.apply(this,a),l()}),g(a,j,b,0,h);else if(Object(a)===a)for(n in m=function(){var b=0,c;for(c in a)a.hasOwnProperty(c)&&b++;return b}(),a)a.hasOwnProperty(n)&&(!c&&!--m&&(d(j)?j=function(){var a=[].slice.call(arguments);k.apply(this,a),l()}:j[n]=function(a){return function(){var b=[].slice.call(arguments);a&&a.apply(this,b),l()}}(k[n])),g(a[n],j,b,n,h))}else!c&&l()}var h=!!a.test,i=a.load||a.both,j=a.callback||f,k=j,l=a.complete||f,m,n;c(h?a.yep:a.nope,!!i),i&&c(i)}var i,j,l=this.yepnope.loader;if(e(a))g(a,0,l,0);else if(w(a))for(i=0;i<a.length;i++)j=a[i],e(j)?g(j,0,l,0):w(j)?B(j):Object(j)===j&&h(j,l);else Object(a)===a&&h(a,l)},B.addPrefix=function(a,b){z[a]=b},B.addFilter=function(a){x.push(a)},B.errorTimeout=1e4,null==b.readyState&&b.addEventListener&&(b.readyState="loading",b.addEventListener("DOMContentLoaded",A=function(){b.removeEventListener("DOMContentLoaded",A,0),b.readyState="complete"},0)),a.yepnope=k(),a.yepnope.executeStack=h,a.yepnope.injectJs=function(a,c,d,e,i,j){var k=b.createElement("script"),l,o,e=e||B.errorTimeout;k.src=a;for(o in d)k.setAttribute(o,d[o]);c=j?h:c||f,k.onreadystatechange=k.onload=function(){!l&&g(k.readyState)&&(l=1,c(),k.onload=k.onreadystatechange=null)},m(function(){l||(l=1,c(1))},e),i?k.onload():n.parentNode.insertBefore(k,n)},a.yepnope.injectCss=function(a,c,d,e,g,i){var e=b.createElement("link"),j,c=i?h:c||f;e.href=a,e.rel="stylesheet",e.type="text/css";for(j in d)e.setAttribute(j,d[j]);g||(n.parentNode.insertBefore(e,n),m(c,0))}}(this,document),Modernizr.load=function(){yepnope.apply(window,[].slice.call(arguments,0))};
/*! HTML5 Notification - v3.0.0 - 2016-09-19

Copyright 2016 Tsvetan Tsvetkov

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/

/** @namespace window */
/** @namespace window.webkitNotifications */
/** @namespace window.external */
(function() {
    /*
     Safari native methods required for Notifications do NOT run in strict mode.
     */
    //'use strict';
    // local variables
    var PERMISSION_DEFAULT = "default";
    // The user decision is unknown; in this case the application will act as if permission was denied.
    var PERMISSION_GRANTED = "granted";
    // The user has explicitly granted permission for the current origin to display system notifications.
    var PERMISSION_DENIED = "denied";
    // The user has explicitly denied permission for the current origin to display system notifications.
    var PERMISSION_NOTSUPPORTED = "notsupported";
    // The Notification API is not supported on current environment
    // map for the old permission values
    var PERMISSIONS = [ PERMISSION_GRANTED, PERMISSION_DEFAULT, PERMISSION_DENIED, PERMISSION_NOTSUPPORTED ];
    var DIRESCTIONS = [ "auto", "ltr", "rtl" ];
    /*
        IE does not support Notifications in the same meaning as other modern browsers.
        On the other side, IE9+(except MS Edge) implement flashing pinned site taskbar buttons.
        Each time new IE Notification is create, previous flashing and icon overlay is cleared.
        So, we need to keep track of the notification that calls close method.
     */
    var IENotificationIndex = -1;
    var IECloseNotificationEvents = [ "click", "scroll", "focus" ];
    var getIco = function(icon) {
        var lastIndex = icon.lastIndexOf(".");
        return (lastIndex !== -1 ? icon.substr(0, lastIndex) : icon) + ".ico";
    };
    /*
     * Internal Notificaiton constructor. Keeps the original Notification
     * constructor if any or use empty function constructor for browsers
     * that do not support Notifications
     */
    var _Notification = window.Notification || /* Opera Mobile/Android Browser */
    window.webkitNotifications && WebKitNotification || /* IE9+ pinned site */
    "external" in window && "msIsSiteMode" in window.external && window.external.msIsSiteMode() !== undefined && IENotification || /* Notifications Not supported. Return dummy constructor */
    DummyNotification;
    /**
     * @constructor DummyNotification
     */
    function DummyNotification() {
        var dummyElement = document.createElement("div");
        this.addEventListener = function(eventName, callback) {
            dummyElement.addEventListener(eventName, callback.bind(this));
        };
        this.removeEventListener = function(eventName, callback) {
            dummyElement.removeEventListener(eventName, callback.bind(this));
        };
        this.dispatchEvent = function(eventName) {
            if (typeof eventName !== "string") {
                return;
            }
            try {
                dummyElement.dispatchEvent(new Event(eventName));
            } catch (e) {
                var event = document.createEvent("Event");
                event.initEvent(eventName, false, true);
                dummyElement.dispatchEvent(event);
            }
        };
    }
    Object.defineProperty(DummyNotification, "permission", {
        enumerable: true,
        get: function() {
            return PERMISSION_NOTSUPPORTED;
        }
    });
    Object.defineProperty(DummyNotification, "requestPermission", {
        enumerable: true,
        writable: true,
        value: function(callback) {
            callback(this.permission);
        }
    });
    /**
     * @constructor IENotification
     */
    function IENotification(title, options) {
        DummyNotification.call(this);
        var notificationIndex = IENotificationIndex;
        Object.defineProperties(this, {
            close: {
                value: function(event) {
                    if (notificationIndex === IENotificationIndex) {
                        window.external.msSiteModeClearIconOverlay();
                        // Remove close events
                        IECloseNotificationEvents.forEach(function(event) {
                            window.removeEventListener(event, this.close);
                        }.bind(this));
                        this.dispatchEvent("click");
                        this.dispatchEvent("close");
                        notificationIndex = null;
                    }
                }.bind(this)
            }
        });
        // Clear any previous icon overlay
        this.close();
        // Set icon
        if (this.icon) {
            window.external.msSiteModeSetIconOverlay(getIco(this.icon), this.description || this.title);
        }
        // Blink icon
        window.external.msSiteModeActivate();
        // Trigger show event
        this.dispatchEvent("show");
        // Attach close event to window
        IECloseNotificationEvents.forEach(function(event) {
            window.addEventListener(event, this.close);
        }.bind(this));
        // Increment notification index
        notificationIndex = ++IENotificationIndex;
    }
    Object.defineProperty(IENotification, "permission", {
        enumerable: true,
        get: function() {
            var isTabPinned = window.external.msIsSiteMode();
            return isTabPinned ? PERMISSION_GRANTED : PERMISSION_DENIED;
        }
    });
    Object.defineProperty(IENotification, "requestPermission", {
        enumerable: true,
        writable: true,
        value: function(callback) {
            return new Promise(function(resolve, reject) {
                if (this.permission === PERMISSION_DENIED) {
                    alert(this.PERMISSION_REQUEST_MESSAGE);
                }
                resolve(this.permission);
            }.bind(this));
        }
    });
    Object.defineProperty(IENotification, "PERMISSION_REQUEST_MESSAGE", {
        writable: true,
        value: "IE supports notifications in pinned mode only. Pin this page on your taskbar to receive notifications."
    });
    /**
     * @constructor WebKitNotification
     */
    function WebKitNotification() {}
    Object.defineProperty(WebKitNotification, "permission", {
        enumerable: true,
        get: function() {
            return PERMISSIONS[window.webkitNotifications.checkPermission()];
        }
    });
    Object.defineProperty(WebKitNotification, "requestPermission", {
        enumerable: true,
        writable: true,
        value: function(callback) {
            return new Promise(function(resolve, reject) {
                window.webkitNotifications.requestPermission(function(permission) {
                    resolve(permission);
                });
            });
        }
    });
    /*
        [Safari] Safari6 do not support Notification.permission.
        Instead, it support Notification.permissionLevel()
     */
    if (!_Notification.permission) {
        Object.defineProperty(_Notification, "permission", {
            enumerable: true,
            get: function() {
                return _Notification.permissionLevel && _Notification.permissionLevel();
            }
        });
    }
    /**
     * @constructor Notification
     */
    function Notification(title, options) {
        var dir;
        var notification;
        if (!arguments.length) {
            throw TypeError('Failed to construct "Notification": 1 argument required, but only 0 present.');
        }
        /*
            Chrome display notifications when title is empty screen, but
            Safari do NOT.

            Set title to non-display characted in order to display notifications
            in Safari as well when title is empty.
         */
        if (title === "") {
            title = "\b";
        }
        if (arguments.length > 1 && "object" !== typeof options) {
            throw TypeError('Failed to construct "Notification": parameter 2 ("options") is not an object.');
        }
        dir = Object(options).dir;
        if (dir !== undefined && DIRESCTIONS.indexOf(dir) === -1) {
            throw TypeError('Failed to construct "Notification": The provided value "' + dir + '" is not a valid enum value of type NotificationDirection.');
        }
        options = Object(options);
        notification = new _Notification(title, options);
        /* TODO: actions property */
        /* TODO: badge property */
        if (!notification.body) {
            Object.defineProperty(notification, "body", {
                value: String(options.body || "")
            });
        }
        if (!notification.data) {
            Object.defineProperty(notification, "data", {
                value: options.data || null
            });
        }
        if (!notification.dir) {
            Object.defineProperty(notification, "dir", {
                value: dir || DIRESCTIONS[0]
            });
        }
        if (!notification.icon) {
            Object.defineProperty(notification, "icon", {
                value: String(options.icon || "")
            });
        }
        if (!notification.lang) {
            Object.defineProperty(notification, "lang", {
                value: String(options.lang || "")
            });
        }
        /* TODO: noscreen property */
        /* TODO: renotify property */
        if (!notification.requireInteraction) {
            Object.defineProperty(notification, "requireInteraction", {
                value: Boolean(options.requireInteraction)
            });
        }
        /* TODO: sound property */
        if (!notification.silent) {
            Object.defineProperty(notification, "silent", {
                value: Boolean(options.silent)
            });
        }
        if (!notification.tag) {
            Object.defineProperty(notification, "tag", {
                value: String(options.tag || "")
            });
        }
        if (!notification.title) {
            Object.defineProperty(notification, "title", {
                value: String(title)
            });
        }
        if (!notification.timestamp) {
            Object.defineProperty(notification, "timestamp", {
                value: new Date().getTime()
            });
        }
        /* TODO: vibrate property */
        return notification;
    }
    Object.defineProperty(Notification, "permission", {
        enumerable: true,
        get: function() {
            return _Notification.permission;
        }
    });
    /*
        Notification.requestPermission should return a Promise(by spec).
        Keep the original method and replace it with a custom one that
        checks if the call of Notification.requestPermission returns a promise
        and if not, then return a custom object that simulates the Promise object.

        Specification:
        Notification.requestPermission().then(callback);

        Old Spec:
        Notification.requestPermission(callback);
     */
    Object.defineProperty(Notification, "requestPermission", {
        enumerable: true,
        value: function() {
            return new Promise(function(resolve, reject) {
                var promise = _Notification.requestPermission(function(permission) {
                    resolve(permission);
                });
                if (!(promise instanceof Promise)) {
                    return;
                }
                resolve(promise);
            });
        }
    });
    window.Notification = Notification;
})();
// based on PHP Name Parser by Josh Fraser (joshfraser.com)
// http://www.onlineaspect.com/2009/08/17/splitting-names/
// ported to JavaScript by Mark Pemburn (pemburnia.com)
// released under Apache 2.0 license

var NameParse = (function(){
	function NameParse() {
		return NameParse;
	}
	
		// split full names into the following parts:
		// - prefix / salutation  (Mr., Mrs., etc)
		// - given name / first name
		// - middle initials
		// - surname / last name 
		// - suffix (II, Phd, Jr, etc)
	NameParse.parse = function (fullastName) {
		fullastName = fullastName.trim();

		var nameParts = [];
		var lastName = "";
		var firstName = "";
		var initials = "";
		var word = null;
		var j = 0;
		var i = 0;

		// split into words
		// completely ignore any words in parentheses
		nameParts = fullastName.split(" ").filter(function(namePart){
			return (namePart.indexOf("(") === -1);
		});

		var numWords = nameParts.length;
		// is the first word a title? (Mr. Mrs, etc)
		var salutation = this.is_salutation(nameParts[0]);
		var suffix = this.is_suffix(nameParts[numWords - 1]);
		// set the range for the middle part of the name (trim prefixes & suffixes)
		var start = (salutation) ? 1 : 0;
		var end = (suffix) ? numWords - 1 : numWords;

		word = nameParts[start];
		// if we start off with an initial, we'll call it the first name
		if (this.is_initial(word)) {
			// if so, do a look-ahead to see if they go by their middle name 
			// for ex: "R. Jason Smith" => "Jason Smith" & "R." is stored as an initial
			// but "R. J. Smith" => "R. Smith" and "J." is stored as an initial
			if (this.is_initial(nameParts[start + 1])) {
				firstName += " " + word.toUpperCase();
			} else {
				initials += " " + word.toUpperCase();
			}
		} else {
			firstName += " " + this.fix_case(word);
		}

		// concat the first name
		for (i=start + 1; i<(end - 1); i++) {
			word = nameParts[i];
			// move on to parsing the last name if we find an indicator of a compound last name (Von, Van, etc)
			// we do not check earlier to allow for rare cases where an indicator is actually the first name (like "Von Fabella")
			if (this.is_compound_lastName(word)) {
			    if (!(this.is_initial(word) && word === word.toUpperCase())) {
			        //If it's one letter and capitalized, consider it a middle initial
			        break;
			    }
			}

			if (this.is_initial(word)) {
				initials += " " + word.toUpperCase(); 
			} else {
				firstName += " " + this.fix_case(word);
			}
		}
		
		// check that we have more than 1 word in our string
		if ((end - start) > 1) {
			// concat the last name
			for (j=i; j<end; j++) {
				lastName += " " + this.fix_case(nameParts[j]);
			}
		}
	
		// return the various parts in an array
		return {
			"salutation": salutation || "",
			"firstName": firstName.trim(),
			"initials": initials.trim(),
			"lastName": lastName.trim(),
			"suffix": suffix || ""
		};
	};

	NameParse.removeIgnoredChars = function (word) {
		//ignore periods
		return word.replace(".","");
	};

	// detect and format standard salutations 
	// I'm only considering english honorifics for now & not words like 
	NameParse.is_salutation = function (word) {
		word = this.removeIgnoredChars(word).toLowerCase();
		// returns normalized values
		if (word === "mr" || word === "master" || word === "mister") {
			return "Mr.";
		} else if (word === "mrs") {
			return "Mrs.";
		} else if (word === "miss" || word === "ms") {
			return "Ms.";
		} else if (word === "dr") {
			return "Dr.";
		} else if (word === "rev") {
			return "Rev.";
		} else if (word === "fr") {
			return "Fr.";
		} else {
			return false;
		}
	};

	//  detect and format common suffixes 
	NameParse.is_suffix = function (word) {
		word = this.removeIgnoredChars(word).toLowerCase();
		// these are some common suffixes - what am I missing?
		var suffixArray = [
			'I','II','III','IV','V','Senior','Junior','Jr','Sr','PhD','APR','RPh','PE','MD','MA','DMD','CME',
			"BVM","CFRE","CLU","CPA","CSC","CSJ","DC","DD","DDS","DO","DVM","EdD","Esq",
			"JD","LLD","OD","OSB","PC","Ret","RGS","RN","RNC","SHCJ","SJ","SNJM","SSMO",
			"USA","USAF","USAFR","USAR","USCG","USMC","USMCR","USN","USNR"
		];

		var suffixIndex = suffixArray.map(function(suffix){
			return suffix.toLowerCase();
		}).indexOf(word);

		if(suffixIndex >= 0) {
			return suffixArray[suffixIndex];
		} else {
			return false;
		}
	};

	// detect compound last names like "Von Fange"
	NameParse.is_compound_lastName = function (word) {
		word = word.toLowerCase();
		// these are some common prefixes that identify a compound last names - what am I missing?
		var words = ['vere','von','van','de','del','della','di','da','pietro','vanden','du','st.','st','la','lo','ter', 'o', "o'", 'mac', 'fitz'];
		return (words.indexOf(word) >= 0);
	};

	// single letter, possibly followed by a period
	NameParse.is_initial = function (word) {
		if (!word) { return false; }
		word = this.removeIgnoredChars(word);
		return (word.length === 1);
	};

	// detect mixed case words like "McDonald"
	// returns false if the string is all one case
	NameParse.is_camel_case = function (word) {
		var ucReg = /[A-Z]+/;
		var lcReg = /[a-z]+/;
		return (ucReg.exec(word) && lcReg.exec(word));
	};

	// ucfirst words split by dashes or periods
	// ucfirst all upper/lower strings, but leave camelcase words alone
	NameParse.fix_case = function (word) {
		// uppercase words split by dashes, like "Kimura-Fay"
		word = this.safe_ucfirst("-",word);
		// uppercase words split by periods, like "J.P."
		word = this.safe_ucfirst(".",word);
		return word;
	};

	// helper for this.fix_case
	// uppercase words split by the seperator (ex. dashes or periods)
	NameParse.safe_ucfirst = function (seperator, word) {
		return word.split(seperator).map(function(thisWord){
			if(this.is_camel_case(thisWord)) {
				return thisWord;
			} else {
				return thisWord.substr(0,1).toUpperCase() + thisWord.substr(1).toLowerCase();
			}
		}, this).join(seperator);
	};

	return NameParse;
})();


/*!
 * SlickQuiz jQuery Plugin
 * http://github.com/jewlofthelotus/SlickQuiz
 *
 * @updated October 25, 2014
 * @version 1.5.20
 *
 * @author Julie Cameron - http://www.juliecameron.com
 * @copyright (c) 2013 Quicken Loans - http://www.quickenloans.com
 * @license MIT
 */

(function($){
    $.slickQuiz = function(element, options) {
        var plugin   = this,
            $element = $(element),
            _element = '#' + $element.attr('id'),

            defaults = {
                checkAnswerText:  'Check My Answer!',
                nextQuestionText: 'Next &raquo;',
                backButtonText: '',
                completeQuizText: '',
                tryAgainText: '',
                questionCountText: 'Question %current of %total',
                preventUnansweredText: 'You must select at least one answer.',
                questionTemplateText:  '%count. %text',
                scoreTemplateText: '%score / %total',
                nameTemplateText:  '<span>Quiz: </span>%name',
                skipStartButton: false,
                instantScore : true,    // Score and report results immedidately
                numberOfQuestions: null,
                randomSortQuestions: false,
                randomSortAnswers: false,
                preventUnanswered: false,
                disableScore: false,
                disableRanking: false,
                scoreAsPercentage: false,
                perQuestionResponseMessaging: true,
                perQuestionResponseAnswers: false,
                completionResponseMessaging: false,
                timerEnabled : false,       // Are questions timed?
                timerValue : 0,            // Default time value
                displayQuestionCount: true,   // Deprecate?
                displayQuestionNumber: true,  // Deprecate?
                animationCallbacks: { // only for the methods that have jQuery animations offering callback
                    setupQuiz: function () {},
                    startQuiz: function () {},
                    resetQuiz: function () {},
                    checkAnswer: function () {},
                    nextQuestion: function () {},
                    backToQuestion: function () {},
                    completeQuiz: function () {}
                },
                events: {
                    onStartQuiz: function (options) {},
                    onCompleteQuiz: function (options) {}  // reserved: options.questionCount, options.score
                }
            },

            // Class Name Strings (Used for building quiz and for selectors)
            questionCountClass     = 'questionCount',
            questionGroupClass     = 'questions',
            questionClass          = 'question',
            answersClass           = 'answers',
            responsesClass         = 'responses',
            completeClass          = 'complete',
            correctClass           = 'correctResponse',
            incorrectClass         = 'incorrectResponse',
            correctResponseClass   = 'correct',
            incorrectResponseClass = 'incorrect',
            checkAnswerClass       = 'checkAnswer',
            nextQuestionClass      = 'nextQuestion',
            lastQuestionClass      = 'lastQuestion',
            backToQuestionClass    = 'backToQuestion',
            tryAgainClass          = 'tryAgain',

            // Sub-Quiz / Sub-Question Class Selectors
            _questionCount         = '.' + questionCountClass,
            _questions             = '.' + questionGroupClass,
            _question              = '.' + questionClass,
            _answers               = '.' + answersClass,
            _answer                = '.' + answersClass + ' li',
            _responses             = '.' + responsesClass,
            _response              = '.' + responsesClass + ' li',
            _correct               = '.' + correctClass,
            _correctResponse       = '.' + correctResponseClass,
            _incorrectResponse     = '.' + incorrectResponseClass,
            _checkAnswerBtn        = '.' + checkAnswerClass,
            _nextQuestionBtn       = '.' + nextQuestionClass,
            _prevQuestionBtn       = '.' + backToQuestionClass,
            _tryAgainBtn           = '.' + tryAgainClass,

            // Top Level Quiz Element Class Selectors
            _quizStarter           = _element + ' .startQuiz',
            _quizName              = _element + ' .quizName',
            _quizArea              = _element + ' .quizArea',
            _quizResults           = _element + ' .quizResults',
            _quizResultsCopy       = _element + ' .quizResultsCopy',
            _quizHeader            = _element + ' .quizHeader',
            _quizScore             = _element + ' .quizScore',
            _quizLevel             = _element + ' .quizLevel',

            // Top Level Quiz Element Objects
            $quizStarter           = $(_quizStarter),
            $quizName              = $(_quizName),
            $quizArea              = $(_quizArea),
            $quizResults           = $(_quizResults),
            $quizResultsCopy       = $(_quizResultsCopy),
            $quizHeader            = $(_quizHeader),
            $quizScore             = $(_quizScore),
            $quizLevel             = $(_quizLevel)
        ;


        // Reassign user-submitted deprecated options
        var depMsg = '';

        if (options && typeof options.disableNext != 'undefined') {
            if (typeof options.preventUnanswered == 'undefined') {
                options.preventUnanswered = options.disableNext;
            }
            depMsg += 'The \'disableNext\' option has been deprecated, please use \'preventUnanswered\' in it\'s place.\n\n';
        }

        if (options && typeof options.disableResponseMessaging != 'undefined') {
            if (typeof options.preventUnanswered == 'undefined') {
                options.perQuestionResponseMessaging = options.disableResponseMessaging;
            }
            depMsg += 'The \'disableResponseMessaging\' option has been deprecated, please use' +
                      ' \'perQuestionResponseMessaging\' and \'completionResponseMessaging\' in it\'s place.\n\n';
        }

        if (options && typeof options.randomSort != 'undefined') {
            if (typeof options.randomSortQuestions == 'undefined') {
                options.randomSortQuestions = options.randomSort;
            }
            if (typeof options.randomSortAnswers == 'undefined') {
                options.randomSortAnswers = options.randomSort;
            }
            depMsg += 'The \'randomSort\' option has been deprecated, please use' +
                      ' \'randomSortQuestions\' and \'randomSortAnswers\' in it\'s place.\n\n';
        }

        if (depMsg !== '') {
            if (typeof console != 'undefined') {
                console.warn(depMsg);
            } else {
                alert(depMsg);
            }
        }
        // End of deprecation reassignment


        plugin.config = $.extend(defaults, options);

        // Set via json option or quizJSON variable (see slickQuiz-config.js)
        var quizValues = (plugin.config.json ? plugin.config.json : typeof quizJSON != 'undefined' ? quizJSON : null);

        // Get questions, possibly sorted randomly
        var questions = plugin.config.randomSortQuestions ?
                        quizValues.questions.sort(function() { return (Math.round(Math.random())-0.5); }) :
                        quizValues.questions;

        // Count the number of questions
        var questionCount = questions.length;

        // Select X number of questions to load if options is set
        if (plugin.config.numberOfQuestions && questionCount >= plugin.config.numberOfQuestions) {
            questions = questions.slice(0, plugin.config.numberOfQuestions);
            questionCount = questions.length;
        }

        // some special private/internal methods
        var internal = {method: {
            // get a key whose notches are "resolved jQ deferred" objects; one per notch on the key
            // think of the key as a house key with notches on it
            getKey: function (notches) { // returns [], notches >= 1
                var key = [];
                for (i=0; i<notches; i++) key[i] = $.Deferred ();
                return key;
            },

            // put the key in the door, if all the notches pass then you can turn the key and "go"
            turnKeyAndGo: function (key, go) { // key = [], go = function ()
                // when all the notches of the key are accepted (resolved) then the key turns and the engine (callback/go) starts
                $.when.apply (null, key). then (function () {
                    go ();
                });
            },

            // get one jQ
            getKeyNotch: function (key, notch) { // notch >= 1, key = []
                // key has several notches, numbered as 1, 2, 3, ... (no zero notch)
                // we resolve and return the "jQ deferred" object at specified notch
                return function () {
                    key[notch-1].resolve (); // it is ASSUMED that you initiated the key with enough notches
                };
            }
        }};

        plugin.method = {
            // Sets up the questions and answers based on above array
            setupQuiz: function(options) { // use 'options' object to pass args
                var key, keyNotch, kN;
                key = internal.method.getKey (3); // how many notches == how many jQ animations you will run
                keyNotch = internal.method.getKeyNotch; // a function that returns a jQ animation callback function
                kN = keyNotch; // you specify the notch, you get a callback function for your animation

                $quizName.hide().html(plugin.config.nameTemplateText
                    .replace('%name', quizValues.info.name) ).fadeIn(1000, kN(key,1));
                $quizHeader.hide().prepend($('<div class="quizDescription">' + quizValues.info.main + '</div>')).fadeIn(1000, kN(key,2));
                $quizResultsCopy.append(quizValues.info.results);

                // add retry button to results view, if enabled
                if (plugin.config.tryAgainText && plugin.config.tryAgainText !== '') {
                    $quizResultsCopy.append('<p><a class="button ' + tryAgainClass + '" href="#">' + plugin.config.tryAgainText + '</a></p>');
                }

                // Setup questions
                var quiz  = $('<ol class="' + questionGroupClass + '"></ol>'),
                    count = 1;

                // Loop through questions object
                for (i in questions) {
                    if (questions.hasOwnProperty(i)) {
                        var question = questions[i];

                        var questionHTML = $('<li class="' + questionClass +'" id="question' + (count - 1) + '"></li>');

                        if (plugin.config.displayQuestionCount) {
                            questionHTML.append('<div class="' + questionCountClass + '">' +
                                plugin.config.questionCountText
                                    .replace('%current', '<span class="current">' + count + '</span>')
                                    .replace('%total', '<span class="total">' +
                                        questionCount + '</span>') + '</div>');
                        }

                        var formatQuestion = '';
                        if (plugin.config.displayQuestionNumber) {
                            formatQuestion = plugin.config.questionTemplateText
                                .replace('%count', count).replace('%text', question.q);
                        } else {
                            formatQuestion = question.q;
                        }
                        questionHTML.append('<h3>' + formatQuestion + '</h3>');

                        // Count the number of true values
                        var truths = 0;
                        for (i in question.a) {
                            if (question.a.hasOwnProperty(i)) {
                                answer = question.a[i];
                                if (answer.correct) {
                                    truths++;
                                }
                            }
                        }

                        // Now let's append the answers with checkboxes or radios depending on truth count
                        var answerHTML = $('<ul class="' + answersClass + '"></ul>');

                        // Get the answers
                        var answers = plugin.config.randomSortAnswers ?
                            question.a.sort(function() { return (Math.round(Math.random())-0.5); }) :
                            question.a;

                        // prepare a name for the answer inputs based on the question
                        var selectAny     = question.select_any ? question.select_any : false,
                            forceCheckbox = question.force_checkbox ? question.force_checkbox : false,
                            checkbox      = (truths > 1 && !selectAny) || forceCheckbox,
                            inputName     = $element.attr('id') + '_question' + (count - 1),
                            inputType     = checkbox ? 'checkbox' : 'radio';

                        if( count == quizValues.questions.length ) {
                            nextQuestionClass = nextQuestionClass + ' ' + lastQuestionClass;
                        }

                        for (i in answers) {
                            if (answers.hasOwnProperty(i)) {
                                answer   = answers[i],
                                optionId = inputName + '_' + i.toString();

                                // If question has >1 true answers and is not a select any, use checkboxes; otherwise, radios
                                var input = '<input id="' + optionId + '" name="' + inputName +
                                            '" type="' + inputType + '" /> ';

                                var optionLabel = '<label for="' + optionId + '">' + answer.option + '</label>';

                                var answerContent = $('<li></li>')
                                    .append(input)
                                    .append(optionLabel);
                                answerHTML.append(answerContent);
                            }
                        }

                        // Append answers to question
                        questionHTML.append(answerHTML);

                        // If response messaging is NOT disabled, add it
                        if (plugin.config.perQuestionResponseMessaging || plugin.config.completionResponseMessaging) {
                            // Now let's append the correct / incorrect response messages
                            var responseHTML = $('<ul class="' + responsesClass + '"></ul>');
                            responseHTML.append('<li class="' + correctResponseClass + '">' + question.correct + '</li>');
                            responseHTML.append('<li class="' + incorrectResponseClass + '">' + question.incorrect + '</li>');

                            // Append responses to question
                            questionHTML.append(responseHTML);
                        }

                        // Appends check answer / back / next question buttons
                        if (plugin.config.backButtonText && plugin.config.backButtonText !== '') {
                            questionHTML.append('<a href="#" class="button ' + backToQuestionClass + '">' + plugin.config.backButtonText + '</a>');
                        }

                        var nextText = plugin.config.nextQuestionText;
                        if (plugin.config.completeQuizText && count == questionCount) {
                            nextText = plugin.config.completeQuizText;
                        }

                        // If we're not showing responses per question, show next question button and make it check the answer too
                        if (!plugin.config.perQuestionResponseMessaging) {
                            questionHTML.append('<a href="#" class="button ' + nextQuestionClass + ' ' + checkAnswerClass + '">' + nextText + '</a>');
                        } else {
                            questionHTML.append('<a href="#" class="button ' + nextQuestionClass + '">' + nextText + '</a>');
                            questionHTML.append('<a href="#" class="button ' + checkAnswerClass + '">' + plugin.config.checkAnswerText + '</a>');
                        }

                        // Append question & answers to quiz
                        quiz.append(questionHTML);

                        count++;
                    }
                }

                // Add the quiz content to the page
                $quizArea.append(quiz);

                // Toggle the start button OR start the quiz if start button is disabled
                if (plugin.config.skipStartButton || $quizStarter.length == 0) {
                    $quizStarter.hide();
                    plugin.method.startQuiz.apply (this, [{callback: plugin.config.animationCallbacks.startQuiz}]); // TODO: determine why 'this' is being passed as arg to startQuiz method
                    kN(key,3).apply (null, []);
                } else {
                    $quizStarter.fadeIn(500, kN(key,3)); // 3d notch on key must be on both sides of if/else, otherwise key won't turn
                }

                internal.method.turnKeyAndGo (key, options && options.callback ? options.callback : function () {});
            },

            // Starts the quiz (hides start button and displays first question)
            startQuiz: function(options) {
                var key, keyNotch, kN;
                key = internal.method.getKey (1); // how many notches == how many jQ animations you will run
                keyNotch = internal.method.getKeyNotch; // a function that returns a jQ animation callback function
                kN = keyNotch; // you specify the notch, you get a callback function for your animation

                function start(options) {
                    var firstQuestion = $(_element + ' ' + _questions + ' li').first();
                    if (firstQuestion.length) {
                        firstQuestion.fadeIn(500, function () {
                            if (options && options.callback) options.callback ();
                        });
                    }
                }

                if (plugin.config.skipStartButton || $quizStarter.length == 0) {
                    start({callback: kN(key,1)});
                } else {
                    $quizStarter.fadeOut(300, function(){
                        start({callback: kN(key,1)}); // 1st notch on key must be on both sides of if/else, otherwise key won't turn
                    });
                }

                internal.method.turnKeyAndGo (key, options && options.callback ? options.callback : function () {});

                if (plugin.config.events &&
                        plugin.config.events.onStartQuiz) {
                    plugin.config.events.onStartQuiz.apply (null, []);
                }
            },

            // Resets (restarts) the quiz (hides results, resets inputs, and displays first question)
            resetQuiz: function(startButton, options) {
                var key, keyNotch, kN;
                key = internal.method.getKey (1); // how many notches == how many jQ animations you will run
                keyNotch = internal.method.getKeyNotch; // a function that returns a jQ animation callback function
                kN = keyNotch; // you specify the notch, you get a callback function for your animation

                $quizResults.fadeOut(300, function() {
                    $(_element + ' input').prop('checked', false).prop('disabled', false);

                    $quizLevel.attr('class', 'quizLevel');
                    $(_element + ' ' + _question).removeClass(correctClass).removeClass(incorrectClass).remove(completeClass);
                    $(_element + ' ' + _answer).removeClass(correctResponseClass).removeClass(incorrectResponseClass);

                    $(_element + ' ' + _question          + ',' +
                      _element + ' ' + _responses         + ',' +
                      _element + ' ' + _response          + ',' +
                      _element + ' ' + _nextQuestionBtn   + ',' +
                      _element + ' ' + _prevQuestionBtn
                    ).hide();

                    $(_element + ' ' + _questionCount + ',' +
                      _element + ' ' + _answers + ',' +
                      _element + ' ' + _checkAnswerBtn
                    ).show();

                    $quizArea.append($(_element + ' ' + _questions)).show();

                    kN(key,1).apply (null, []);

                    plugin.method.startQuiz({callback: plugin.config.animationCallbacks.startQuiz},$quizResults); // TODO: determine why $quizResults is being passed
                });

                internal.method.turnKeyAndGo (key, options && options.callback ? options.callback : function () {});
            },

            // Validates the response selection(s), displays explanations & next question button
            checkAnswer: function(checkButton, options) {
                var key, keyNotch, kN;
                key = internal.method.getKey (2); // how many notches == how many jQ animations you will run
                keyNotch = internal.method.getKeyNotch; // a function that returns a jQ animation callback function
                kN = keyNotch; // you specify the notch, you get a callback function for your animation

                var questionLI    = $($(checkButton).parents(_question)[0]),
                    answerLIs     = questionLI.find(_answers + ' li'),
                    answerSelects = answerLIs.find('input:checked'),
                    questionIndex = parseInt(questionLI.attr('id').replace(/(question)/, ''), 10),
                    answers       = questions[questionIndex].a,
                    selectAny     = questions[questionIndex].select_any ? questions[questionIndex].select_any : false;

                answerLIs.addClass(incorrectResponseClass);

                // Collect the true answers needed for a correct response
                var trueAnswers = [];
                for (i in answers) {
                    if (answers.hasOwnProperty(i)) {
                        var answer = answers[i],
                            index  = parseInt(i, 10);

                        if (answer.correct) {
                            trueAnswers.push(index);
                            answerLIs.eq(index).removeClass(incorrectResponseClass).addClass(correctResponseClass);
                        }
                    }
                }

                // TODO: Now that we're marking answer LIs as correct / incorrect, we might be able
                // to do all our answer checking at the same time

                // NOTE: Collecting answer index for comparison aims to ensure that HTML entities
                // and HTML elements that may be modified by the browser / other scrips match up

                // Collect the answers submitted
                var selectedAnswers = [];
                answerSelects.each( function() {
                    var id = $(this).attr('id');
                    selectedAnswers.push(parseInt(id.replace(/(.*\_question\d{1,}_)/, ''), 10));
                });

                if (plugin.config.preventUnanswered && selectedAnswers.length === 0) {
                    alert(plugin.config.preventUnansweredText);
                    return false;
                }

                // Verify all/any true answers (and no false ones) were submitted
                var correctResponse = plugin.method.compareAnswers(trueAnswers, selectedAnswers, selectAny);

                if (correctResponse) {
                    questionLI.addClass(correctClass);
                } else {
                    questionLI.addClass(incorrectClass);
                }

                // Toggle appropriate response (either for display now and / or on completion)
                questionLI.find(correctResponse ? _correctResponse : _incorrectResponse).show();

                // If perQuestionResponseMessaging is enabled, toggle response and navigation now
                if (plugin.config.perQuestionResponseMessaging) {
                    $(checkButton).hide();
                    if (!plugin.config.perQuestionResponseAnswers) {
                        // Make sure answers don't highlight for a split second before they hide
                        questionLI.find(_answers).hide({
                            duration: 0,
                            complete: function() {
                                questionLI.addClass(completeClass);
                            }
                        });
                    } else {
                        questionLI.addClass(completeClass);
                    }
                    questionLI.find('input').prop('disabled', true);
                    questionLI.find(_responses).show();
                    questionLI.find(_nextQuestionBtn).fadeIn(300, kN(key,1));
                    questionLI.find(_prevQuestionBtn).fadeIn(300, kN(key,2));
                    if (!questionLI.find(_prevQuestionBtn).length) kN(key,2).apply (null, []); // 2nd notch on key must be passed even if there's no "back" button
                } else {
                    kN(key,1).apply (null, []); // 1st notch on key must be on both sides of if/else, otherwise key won't turn
                    kN(key,2).apply (null, []); // 2nd notch on key must be on both sides of if/else, otherwise key won't turn
                }

                internal.method.turnKeyAndGo (key, options && options.callback ? options.callback : function () {});
            },

            // Moves to the next question OR completes the quiz if on last question
            nextQuestion: function(nextButton, options) {
                var key, keyNotch, kN;
                key = internal.method.getKey (1); // how many notches == how many jQ animations you will run
                keyNotch = internal.method.getKeyNotch; // a function that returns a jQ animation callback function
                kN = keyNotch; // you specify the notch, you get a callback function for your animation

                var currentQuestion = $($(nextButton).parents(_question)[0]),
                    nextQuestion    = currentQuestion.next(_question),
                    answerInputs    = currentQuestion.find('input:checked');

                // If response messaging has been disabled or moved to completion,
                // make sure we have an answer if we require it, let checkAnswer handle the alert messaging
                if (plugin.config.preventUnanswered && answerInputs.length === 0) {
                    return false;
                }

                if (nextQuestion.length) {
                    currentQuestion.fadeOut(300, function(){
                        nextQuestion.find(_prevQuestionBtn).show().end().fadeIn(500, kN(key,1));
                        if (!nextQuestion.find(_prevQuestionBtn).show().end().length) kN(key,1).apply (null, []); // 1st notch on key must be passed even if there's no "back" button
                    });
                } else {
                    kN(key,1).apply (null, []); // 1st notch on key must be on both sides of if/else, otherwise key won't turn
                    plugin.method.completeQuiz({callback: plugin.config.animationCallbacks.completeQuiz});
                }

                internal.method.turnKeyAndGo (key, options && options.callback ? options.callback : function () {});
            },

            // Go back to the last question
            backToQuestion: function(backButton, options) {
                var key, keyNotch, kN;
                key = internal.method.getKey (2); // how many notches == how many jQ animations you will run
                keyNotch = internal.method.getKeyNotch; // a function that returns a jQ animation callback function
                kN = keyNotch; // you specify the notch, you get a callback function for your animation

                var questionLI = $($(backButton).parents(_question)[0]),
                    responses  = questionLI.find(_responses);

                // Back to question from responses
                if (responses.css('display') === 'block' ) {
                    questionLI.find(_responses).fadeOut(300, function(){
                        questionLI.removeClass(correctClass).removeClass(incorrectClass).removeClass(completeClass);
                        questionLI.find(_responses + ', ' + _response).hide();
                        questionLI.find(_answers).show();
                        questionLI.find(_answer).removeClass(correctResponseClass).removeClass(incorrectResponseClass);
                        questionLI.find('input').prop('disabled', false);
                        questionLI.find(_answers).fadeIn(500, kN(key,1)); // 1st notch on key must be on both sides of if/else, otherwise key won't turn
                        questionLI.find(_checkAnswerBtn).fadeIn(500, kN(key,2));
                        questionLI.find(_nextQuestionBtn).hide();

                        // if question is first, don't show back button on question
                        if (questionLI.attr('id') != 'question0') {
                            questionLI.find(_prevQuestionBtn).show();
                        } else {
                            questionLI.find(_prevQuestionBtn).hide();
                        }
                    });

                // Back to previous question
                } else {
                    var prevQuestion = questionLI.prev(_question);

                    questionLI.fadeOut(300, function() {
                        prevQuestion.removeClass(correctClass).removeClass(incorrectClass).removeClass(completeClass);
                        prevQuestion.find(_responses + ', ' + _response).hide();
                        prevQuestion.find(_answers).show();
                        prevQuestion.find(_answer).removeClass(correctResponseClass).removeClass(incorrectResponseClass);
                        prevQuestion.find('input').prop('disabled', false);
                        prevQuestion.find(_nextQuestionBtn).hide();
                        prevQuestion.find(_checkAnswerBtn).show();

                        if (prevQuestion.attr('id') != 'question0') {
                            prevQuestion.find(_prevQuestionBtn).show();
                        } else {
                            prevQuestion.find(_prevQuestionBtn).hide();
                        }

                        prevQuestion.fadeIn(500, kN(key,1));
                        kN(key,2).apply (null, []); // 2nd notch on key must be on both sides of if/else, otherwise key won't turn
                    });
                }

                internal.method.turnKeyAndGo (key, options && options.callback ? options.callback : function () {});
            },

            // Hides all questions, displays the final score and some conclusive information
            completeQuiz: function(options) {
                var key, keyNotch, kN;
                key = internal.method.getKey (1); // how many notches == how many jQ animations you will run
                keyNotch = internal.method.getKeyNotch; // a function that returns a jQ animation callback function
                kN = keyNotch; // you specify the notch, you get a callback function for your animation

                var score        = $(_element + ' ' + _correct).length,
                    displayScore = score;
                if (plugin.config.scoreAsPercentage) {
                    displayScore = (score / questionCount).toFixed(2)*100 + "%";
                }

                if (plugin.config.disableScore) {
                    $(_quizScore).remove()
                } else {
                    $(_quizScore + ' span').html(plugin.config.scoreTemplateText
                        .replace('%score', displayScore).replace('%total', questionCount));
                }

                if (plugin.config.disableRanking) {
                    $(_quizLevel).remove()
                } else {
                    var levels    = [
                                        quizValues.info.level1, // 80-100%
                                        quizValues.info.level2, // 60-79%
                                        quizValues.info.level3, // 40-59%
                                        quizValues.info.level4, // 20-39%
                                        quizValues.info.level5  // 0-19%
                                    ],
                        levelRank = plugin.method.calculateLevel(score),
                        levelText = $.isNumeric(levelRank) ? levels[levelRank] : '';

                    $(_quizLevel + ' span').html(levelText);
                    $(_quizLevel).addClass('level' + levelRank);
                }

                $quizArea.fadeOut(300, function() {
                    // If response messaging is set to show upon quiz completion, show it now
                    if (plugin.config.completionResponseMessaging) {
                        $(_element + ' .button:not(' + _tryAgainBtn + '), ' + _element + ' ' + _questionCount).hide();
                        $(_element + ' ' + _question + ', ' + _element + ' ' + _answers + ', ' + _element + ' ' + _responses).show();
                        $quizResults.append($(_element + ' ' + _questions)).fadeIn(500, kN(key,1));
                    } else {
                        $quizResults.fadeIn(500, kN(key,1)); // 1st notch on key must be on both sides of if/else, otherwise key won't turn
                    }
                });

                internal.method.turnKeyAndGo (key, options && options.callback ? options.callback : function () {});

                if (plugin.config.events &&
                        plugin.config.events.onCompleteQuiz) {
                    plugin.config.events.onCompleteQuiz.apply (null, [{
                        questionCount: questionCount,
                        score: score
                    }]);
                }
            },

            // Compares selected responses with true answers, returns true if they match exactly
            compareAnswers: function(trueAnswers, selectedAnswers, selectAny) {
                if ( selectAny ) {
                    return $.inArray(selectedAnswers[0], trueAnswers) > -1;
                } else {
                    // crafty array comparison (http://stackoverflow.com/a/7726509)
                    return ($(trueAnswers).not(selectedAnswers).length === 0 && $(selectedAnswers).not(trueAnswers).length === 0);
                }
            },

            // Calculates knowledge level based on number of correct answers
            calculateLevel: function(correctAnswers) {
                var percent = (correctAnswers / questionCount).toFixed(2),
                    level   = null;

                if (plugin.method.inRange(0, 0.20, percent)) {
                    level = 4;
                } else if (plugin.method.inRange(0.21, 0.40, percent)) {
                    level = 3;
                } else if (plugin.method.inRange(0.41, 0.60, percent)) {
                    level = 2;
                } else if (plugin.method.inRange(0.61, 0.80, percent)) {
                    level = 1;
                } else if (plugin.method.inRange(0.81, 1.00, percent)) {
                    level = 0;
                }

                return level;
            },

            // Determines if percentage of correct values is within a level range
            inRange: function(start, end, value) {
                return (value >= start && value <= end);
            }
        };

        plugin.init = function() {
            // Setup quiz
            plugin.method.setupQuiz.apply (null, [{callback: plugin.config.animationCallbacks.setupQuiz}]);

            // Bind "start" button
            $quizStarter.on('click', function(e) {
                e.preventDefault();

                if (!this.disabled && !$(this).hasClass('disabled')) {
                    plugin.method.startQuiz.apply (null, [{callback: plugin.config.animationCallbacks.startQuiz}]);
                }
            });

            // Bind "try again" button
            $(_element + ' ' + _tryAgainBtn).on('click', function(e) {
                e.preventDefault();
                plugin.method.resetQuiz(this, {callback: plugin.config.animationCallbacks.resetQuiz});
            });

            // Bind "check answer" buttons
            $(_element + ' ' + _checkAnswerBtn).on('click', function(e) {
                e.preventDefault();
                plugin.method.checkAnswer(this, {callback: plugin.config.animationCallbacks.checkAnswer});
            });

            // Bind "back" buttons
            $(_element + ' ' + _prevQuestionBtn).on('click', function(e) {
                e.preventDefault();
                plugin.method.backToQuestion(this, {callback: plugin.config.animationCallbacks.backToQuestion});
            });

            // Bind "next" buttons
            $(_element + ' ' + _nextQuestionBtn).on('click', function(e) {
                e.preventDefault();
                plugin.method.nextQuestion(this, {callback: plugin.config.animationCallbacks.nextQuestion});
            });

            // Accessibility (WAI-ARIA).
            var _qnid = $element.attr('id') + '-name';
            $quizName.attr('id', _qnid);
            $element.attr({
              'aria-labelledby': _qnid,
              'aria-live': 'polite',
              'aria-relevant': 'additions',
              'role': 'form'
            });
            $(_quizStarter + ', [href = "#"]').attr('role', 'button');
        };

        plugin.init();
    };

    $.fn.slickQuiz = function(options) {
        return this.each(function() {
            if (undefined === $(this).data('slickQuiz')) {
                var plugin = new $.slickQuiz(this, options);
                $(this).data('slickQuiz', plugin);
            }
        });
    };
})(jQuery);

/*!
 * FitVids 1.0
 * Copyright 2011, Chris Coyier - http://css-tricks.com + Dave Rupert - http://daverupert.com
 * Credit to Thierry Koblentz - http://www.alistapart.com/articles/creating-intrinsic-ratios-for-video/
 * Released under the WTFPL license - http://sam.zoy.org/wtfpl/
 */
(function(a){a.fn.fitVids=function(b){var c={customSelector:null};var e=document.createElement("div"),d=document.getElementsByTagName("base")[0]||document.getElementsByTagName("script")[0];
e.className="fit-vids-style";e.innerHTML="&shy;<style>               .fluid-width-video-wrapper {                 width: 100%;                              position: relative;                       padding: 0;                            }                                                                                   .fluid-width-video-wrapper iframe,        .fluid-width-video-wrapper object,        .fluid-width-video-wrapper embed {           position: absolute;                       top: 0;                                   left: 0;                                  width: 100%;                              height: 100%;                          }                                       </style>";
d.parentNode.insertBefore(e,d);if(b){a.extend(c,b)}return this.each(function(){var f=["iframe[src*='player.vimeo.com']","iframe[src*='youtube.com']","iframe[src*='youtube-nocookie.com']","iframe[src*='kickstarter.com']","object","embed"];if(c.customSelector){f.push(c.customSelector)}var g=a(this).find(f.join(","));g.each(function(){var l=a(this);if(this.tagName.toLowerCase()==="embed"&&l.parent("object").length||l.parent(".fluid-width-video-wrapper").length){return}var h=(this.tagName.toLowerCase()==="object"||(l.attr("height")&&!isNaN(parseInt(l.attr("height"),10))))?parseInt(l.attr("height"),10):l.height(),i=!isNaN(parseInt(l.attr("width"),10))?parseInt(l.attr("width"),10):l.width(),j=h/i;
if(!l.attr("id")){var k="fitvid"+Math.floor(Math.random()*999999);l.attr("id",k)}l.wrap('<div class="fluid-width-video-wrapper"></div>').parent(".fluid-width-video-wrapper").css("padding-top",(j*100)+"%");l.removeAttr("height").removeAttr("width")})})}})(jQuery);
/*
 * jQuery Superfish Menu Plugin - v1.7.4
 * Copyright (c) 2013 Joel Birch
 *
 * Dual licensed under the MIT and GPL licenses:
 *	http://www.opensource.org/licenses/mit-license.php
 *	http://www.gnu.org/licenses/gpl.html
 */

;(function(e){"use strict";var s=function(){var s={bcClass:"sf-breadcrumb",menuClass:"sf-js-enabled",anchorClass:"sf-with-ul",menuArrowClass:"sf-arrows"},o=function(){var s=/iPhone|iPad|iPod/i.test(navigator.userAgent);return s&&e(window).load(function(){e("body").children().on("click",e.noop)}),s}(),n=function(){var e=document.documentElement.style;return"behavior"in e&&"fill"in e&&/iemobile/i.test(navigator.userAgent)}(),t=function(e,o){var n=s.menuClass;o.cssArrows&&(n+=" "+s.menuArrowClass),e.toggleClass(n)},i=function(o,n){return o.find("li."+n.pathClass).slice(0,n.pathLevels).addClass(n.hoverClass+" "+s.bcClass).filter(function(){return e(this).children(n.popUpSelector).hide().show().length}).removeClass(n.pathClass)},r=function(e){e.children("a").toggleClass(s.anchorClass)},a=function(e){var s=e.css("ms-touch-action");s="pan-y"===s?"auto":"pan-y",e.css("ms-touch-action",s)},l=function(s,t){var i="li:has("+t.popUpSelector+")";e.fn.hoverIntent&&!t.disableHI?s.hoverIntent(u,p,i):s.on("mouseenter.superfish",i,u).on("mouseleave.superfish",i,p);var r="MSPointerDown.superfish";o||(r+=" touchend.superfish"),n&&(r+=" mousedown.superfish"),s.on("focusin.superfish","li",u).on("focusout.superfish","li",p).on(r,"a",t,h)},h=function(s){var o=e(this),n=o.siblings(s.data.popUpSelector);n.length>0&&n.is(":hidden")&&(o.one("click.superfish",!1),"MSPointerDown"===s.type?o.trigger("focus"):e.proxy(u,o.parent("li"))())},u=function(){var s=e(this),o=d(s);clearTimeout(o.sfTimer),s.siblings().superfish("hide").end().superfish("show")},p=function(){var s=e(this),n=d(s);o?e.proxy(f,s,n)():(clearTimeout(n.sfTimer),n.sfTimer=setTimeout(e.proxy(f,s,n),n.delay))},f=function(s){s.retainPath=e.inArray(this[0],s.$path)>-1,this.superfish("hide"),this.parents("."+s.hoverClass).length||(s.onIdle.call(c(this)),s.$path.length&&e.proxy(u,s.$path)())},c=function(e){return e.closest("."+s.menuClass)},d=function(e){return c(e).data("sf-options")};return{hide:function(s){if(this.length){var o=this,n=d(o);if(!n)return this;var t=n.retainPath===!0?n.$path:"",i=o.find("li."+n.hoverClass).add(this).not(t).removeClass(n.hoverClass).children(n.popUpSelector),r=n.speedOut;s&&(i.show(),r=0),n.retainPath=!1,n.onBeforeHide.call(i),i.stop(!0,!0).animate(n.animationOut,r,function(){var s=e(this);n.onHide.call(s)})}return this},show:function(){var e=d(this);if(!e)return this;var s=this.addClass(e.hoverClass),o=s.children(e.popUpSelector);return e.onBeforeShow.call(o),o.stop(!0,!0).animate(e.animation,e.speed,function(){e.onShow.call(o)}),this},destroy:function(){return this.each(function(){var o,n=e(this),i=n.data("sf-options");return i?(o=n.find(i.popUpSelector).parent("li"),clearTimeout(i.sfTimer),t(n,i),r(o),a(n),n.off(".superfish").off(".hoverIntent"),o.children(i.popUpSelector).attr("style",function(e,s){return s.replace(/display[^;]+;?/g,"")}),i.$path.removeClass(i.hoverClass+" "+s.bcClass).addClass(i.pathClass),n.find("."+i.hoverClass).removeClass(i.hoverClass),i.onDestroy.call(n),n.removeData("sf-options"),void 0):!1})},init:function(o){return this.each(function(){var n=e(this);if(n.data("sf-options"))return!1;var h=e.extend({},e.fn.superfish.defaults,o),u=n.find(h.popUpSelector).parent("li");h.$path=i(n,h),n.data("sf-options",h),t(n,h),r(u),a(n),l(n,h),u.not("."+s.bcClass).superfish("hide",!0),h.onInit.call(this)})}}}();e.fn.superfish=function(o){return s[o]?s[o].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof o&&o?e.error("Method "+o+" does not exist on jQuery.fn.superfish"):s.init.apply(this,arguments)},e.fn.superfish.defaults={popUpSelector:"ul,.sf-mega",hoverClass:"sfHover",pathClass:"overrideThisToUse",pathLevels:1,delay:800,animation:{opacity:"show"},animationOut:{opacity:"hide"},speed:"normal",speedOut:"fast",cssArrows:!0,disableHI:!1,onInit:e.noop,onBeforeShow:e.noop,onShow:e.noop,onBeforeHide:e.noop,onHide:e.noop,onIdle:e.noop,onDestroy:e.noop},e.fn.extend({hideSuperfishUl:s.hide,showSuperfishUl:s.show})})(jQuery);

/**
 * jQuery ScrollTo
 * Copyright (c) 2007-2012 Ariel Flesler - aflesler(at)gmail(dot)com | http://flesler.blogspot.com
 * Dual licensed under MIT and GPL.
 * @author Ariel Flesler
 * @version 1.4.3
 */

;(function($){var h=$.scrollTo=function(a,b,c){$(window).scrollTo(a,b,c)};h.defaults={axis:'xy',duration:parseFloat($.fn.jquery)>=1.3?0:1,limit:true};h.window=function(a){return $(window)._scrollable()};$.fn._scrollable=function(){return this.map(function(){var a=this,isWin=!a.nodeName||$.inArray(a.nodeName.toLowerCase(),['iframe','#document','html','body'])!=-1;if(!isWin)return a;var b=(a.contentWindow||a).document||a.ownerDocument||a;return/webkit/i.test(navigator.userAgent)||b.compatMode=='BackCompat'?b.body:b.documentElement})};$.fn.scrollTo=function(e,f,g){if(typeof f=='object'){g=f;f=0}if(typeof g=='function')g={onAfter:g};if(e=='max')e=9e9;g=$.extend({},h.defaults,g);f=f||g.duration;g.queue=g.queue&&g.axis.length>1;if(g.queue)f/=2;g.offset=both(g.offset);g.over=both(g.over);return this._scrollable().each(function(){if(!e)return;var d=this,$elem=$(d),targ=e,toff,attr={},win=$elem.is('html,body');switch(typeof targ){case'number':case'string':if(/^([+-]=)?\d+(\.\d+)?(px|%)?$/.test(targ)){targ=both(targ);break}targ=$(targ,this);if(!targ.length)return;case'object':if(targ.is||targ.style)toff=(targ=$(targ)).offset()}$.each(g.axis.split(''),function(i,a){var b=a=='x'?'Left':'Top',pos=b.toLowerCase(),key='scroll'+b,old=d[key],max=h.max(d,a);if(toff){attr[key]=toff[pos]+(win?0:old-$elem.offset()[pos]);if(g.margin){attr[key]-=parseInt(targ.css('margin'+b))||0;attr[key]-=parseInt(targ.css('border'+b+'Width'))||0}attr[key]+=g.offset[pos]||0;if(g.over[pos])attr[key]+=targ[a=='x'?'width':'height']()*g.over[pos]}else{var c=targ[pos];attr[key]=c.slice&&c.slice(-1)=='%'?parseFloat(c)/100*max:c}if(g.limit&&/^\d+$/.test(attr[key]))attr[key]=attr[key]<=0?0:Math.min(attr[key],max);if(!i&&g.queue){if(old!=attr[key])animate(g.onAfterFirst);delete attr[key]}});animate(g.onAfter);function animate(a){$elem.animate(attr,f,g.easing,a&&function(){a.call(this,e,g)})}}).end()};h.max=function(a,b){var c=b=='x'?'Width':'Height',scroll='scroll'+c;if(!$(a).is('html,body'))return a[scroll]-$(a)[c.toLowerCase()]();var d='client'+c,html=a.ownerDocument.documentElement,body=a.ownerDocument.body;return Math.max(html[scroll],body[scroll])-Math.min(html[d],body[d])};function both(a){return typeof a=='object'?a:{top:a,left:a}}})(jQuery);
/*
Plugin Name: 	Count To
Written by: 	Matt Huggins - https://github.com/mhuggins/jquery-countTo

*/
(function ($) {
	$.fn.countTo = function (options) {
		options = options || {};

		return $(this).each(function () {
			// set options for current element
			var settings = $.extend({}, $.fn.countTo.defaults, {
				from:            $(this).data('from'),
				to:              $(this).data('to'),
				speed:           $(this).data('speed'),
				refreshInterval: $(this).data('refresh-interval'),
				decimals:        $(this).data('decimals')
			}, options);

			// how many times to update the value, and how much to increment the value on each update
			var loops = Math.ceil(settings.speed / settings.refreshInterval),
				increment = (settings.to - settings.from) / loops;

			// references & variables that will change with each update
			var self = this,
				$self = $(this),
				loopCount = 0,
				value = settings.from,
				data = $self.data('countTo') || {};

			$self.data('countTo', data);

			// if an existing interval can be found, clear it first
			if (data.interval) {
				clearInterval(data.interval);
			}
			data.interval = setInterval(updateTimer, settings.refreshInterval);

			// initialize the element with the starting value
			render(value);

			function updateTimer() {
				value += increment;
				loopCount++;

				render(value);

				if (typeof(settings.onUpdate) == 'function') {
					settings.onUpdate.call(self, value);
				}

				if (loopCount >= loops) {
					// remove the interval
					$self.removeData('countTo');
					clearInterval(data.interval);
					value = settings.to;

					if (typeof(settings.onComplete) == 'function') {
						settings.onComplete.call(self, value);
					}
				}
			}

			function render(value) {
				var formattedValue = settings.formatter.call(self, value, settings);
				$self.html(formattedValue);
			}
		});
	};

	$.fn.countTo.defaults = {
		from: 0,               // the number the element should start at
		to: 0,                 // the number the element should end at
		speed: 1000,           // how long it should take to count between the target numbers
		refreshInterval: 100,  // how often the element should be updated
		decimals: 0,           // the number of decimal places to show
		formatter: formatter,  // handler for formatting the value before rendering
		onUpdate: null,        // callback method for every time the element is updated
		onComplete: null       // callback method for when the element finishes updating
	};

	function formatter(value, settings) {
		return value.toFixed(settings.decimals);
	}
}(jQuery));

/*!
 * Bootstrap-select v1.6.0 (http://silviomoreto.github.io/bootstrap-select/)
 *
 * Copyright 2013-2014 bootstrap-select
 * Licensed under MIT (https://github.com/silviomoreto/bootstrap-select/blob/master/LICENSE)
 */
!function(a){"use strict";a.expr[":"].icontains=function(b,c,d){return a(b).text().toUpperCase().indexOf(d[3].toUpperCase())>=0};var b=function(c,d,e){e&&(e.stopPropagation(),e.preventDefault()),this.$element=a(c),this.$newElement=null,this.$button=null,this.$menu=null,this.$lis=null,this.options=d,null===this.options.title&&(this.options.title=this.$element.attr("title")),this.val=b.prototype.val,this.render=b.prototype.render,this.refresh=b.prototype.refresh,this.setStyle=b.prototype.setStyle,this.selectAll=b.prototype.selectAll,this.deselectAll=b.prototype.deselectAll,this.destroy=b.prototype.destroy,this.remove=b.prototype.destroy,this.show=b.prototype.show,this.hide=b.prototype.hide,this.init()};b.VERSION="1.6.0",b.DEFAULTS={style:"btn-default",size:"auto",title:null,selectedTextFormat:"values",noneSelectedText:"Nothing selected",noneResultsText:"No results match",countSelectedText:"{0} of {1} selected",maxOptionsText:["Limit reached ({n} {var} max)","Group limit reached ({n} {var} max)",["items","item"]],width:!1,container:!1,hideDisabled:!1,showSubtext:!1,showIcon:!0,showContent:!0,dropupAuto:!0,header:!1,liveSearch:!1,actionsBox:!1,multipleSeparator:", ",iconBase:"glyphicon",tickIcon:"glyphicon-ok",maxOptions:!1,mobile:!1},b.prototype={constructor:b,init:function(){var b=this,c=this.$element.attr("id");this.$element.hide(),this.multiple=this.$element.prop("multiple"),this.autofocus=this.$element.prop("autofocus"),this.$newElement=this.createView(),this.$element.after(this.$newElement),this.$menu=this.$newElement.find("> .dropdown-menu"),this.$button=this.$newElement.find("> button"),this.$searchbox=this.$newElement.find("input"),void 0!==c&&(this.$button.attr("data-id",c),a('label[for="'+c+'"]').click(function(a){a.preventDefault(),b.$button.focus()})),this.checkDisabled(),this.clickListener(),this.options.liveSearch&&this.liveSearchListener(),this.render(),this.liHeight(),this.setStyle(),this.setWidth(),this.options.container&&this.selectPosition(),this.$menu.data("this",this),this.$newElement.data("this",this),this.options.mobile&&this.mobile()},createDropdown:function(){var b=this.multiple?" show-tick":"",c=this.$element.parent().hasClass("input-group")?" input-group-btn":"",d=this.autofocus?" autofocus":"",e=this.options.header?'<div class="popover-title"><button type="button" class="close" aria-hidden="true">&times;</button>'+this.options.header+"</div>":"",f=this.options.liveSearch?'<div class="bootstrap-select-searchbox"><input type="text" class="input-block-level form-control" autocomplete="off" /></div>':"",g=this.options.actionsBox?'<div class="bs-actionsbox"><div class="btn-group btn-block"><button class="actions-btn bs-select-all btn btn-sm btn-default">Select All</button><button class="actions-btn bs-deselect-all btn btn-sm btn-default">Deselect All</button></div></div>':"",h='<div class="btn-group bootstrap-select'+b+c+'"><button type="button" class="btn dropdown-toggle selectpicker" data-toggle="dropdown"'+d+'><span class="filter-option pull-left"></span>&nbsp;<span class="caret"></span></button><div class="dropdown-menu open">'+e+f+g+'<ul class="dropdown-menu inner selectpicker" role="menu"></ul></div></div>';return a(h)},createView:function(){var a=this.createDropdown(),b=this.createLi();return a.find("ul").append(b),a},reloadLi:function(){this.destroyLi();var a=this.createLi();this.$menu.find("ul").append(a)},destroyLi:function(){this.$menu.find("li").remove()},createLi:function(){var b=this,c=[],d="",e=0;return this.$element.find("option").each(function(){var d=a(this),f=d.attr("class")||"",g=d.attr("style")||"",h=d.data("content")?d.data("content"):d.html(),i=void 0!==d.data("subtext")?'<small class="muted text-muted">'+d.data("subtext")+"</small>":"",j=void 0!==d.data("icon")?'<i class="'+b.options.iconBase+" "+d.data("icon")+'"></i> ':"";if(""!==j&&(d.is(":disabled")||d.parent().is(":disabled"))&&(j="<span>"+j+"</span>"),d.data("content")||(h=j+'<span class="text">'+h+i+"</span>"),b.options.hideDisabled&&(d.is(":disabled")||d.parent().is(":disabled")))c.push('<a style="min-height: 0; padding: 0"></a>');else if(d.parent().is("optgroup")&&d.data("divider")!==!0)if(0===d.index()){var k=d.parent().attr("label"),l=void 0!==d.parent().data("subtext")?'<small class="muted text-muted">'+d.parent().data("subtext")+"</small>":"",m=d.parent().data("icon")?'<i class="'+b.options.iconBase+" "+d.parent().data("icon")+'"></i> ':"";k=m+'<span class="text">'+k+l+"</span>",e+=1,c.push(0!==d[0].index?'<div class="div-contain"><div class="divider"></div></div><dt>'+k+"</dt>"+b.createA(h,"opt "+f,g,e):"<dt>"+k+"</dt>"+b.createA(h,"opt "+f,g,e))}else c.push(b.createA(h,"opt "+f,g,e));else c.push(d.data("divider")===!0?'<div class="div-contain"><div class="divider"></div></div>':a(this).data("hidden")===!0?"<a></a>":b.createA(h,f,g))}),a.each(c,function(a,b){var c="<a></a>"===b?'class="hide is-hidden"':"";d+='<li rel="'+a+'"'+c+">"+b+"</li>"}),this.multiple||0!==this.$element.find("option:selected").length||this.options.title||this.$element.find("option").eq(0).prop("selected",!0).attr("selected","selected"),a(d)},createA:function(a,b,c,d){return'<a tabindex="0" class="'+b+'" style="'+c+'"'+("undefined"!=typeof d?'data-optgroup="'+d+'"':"")+">"+a+'<i class="'+this.options.iconBase+" "+this.options.tickIcon+' icon-ok check-mark"></i></a>'},render:function(b){var c=this;b!==!1&&this.$element.find("option").each(function(b){c.setDisabled(b,a(this).is(":disabled")||a(this).parent().is(":disabled")),c.setSelected(b,a(this).is(":selected"))}),this.tabIndex();var d=this.$element.find("option:selected").map(function(){var b,d=a(this),e=d.data("icon")&&c.options.showIcon?'<i class="'+c.options.iconBase+" "+d.data("icon")+'"></i> ':"";return b=c.options.showSubtext&&d.attr("data-subtext")&&!c.multiple?' <small class="muted text-muted">'+d.data("subtext")+"</small>":"",d.data("content")&&c.options.showContent?d.data("content"):void 0!==d.attr("title")?d.attr("title"):e+d.html()+b}).toArray(),e=this.multiple?d.join(this.options.multipleSeparator):d[0];if(this.multiple&&this.options.selectedTextFormat.indexOf("count")>-1){var f=this.options.selectedTextFormat.split(">"),g=this.options.hideDisabled?":not([disabled])":"";(f.length>1&&d.length>f[1]||1==f.length&&d.length>=2)&&(e=this.options.countSelectedText.replace("{0}",d.length).replace("{1}",this.$element.find('option:not([data-divider="true"], [data-hidden="true"])'+g).length))}this.options.title=this.$element.attr("title"),"static"==this.options.selectedTextFormat&&(e=this.options.title),e||(e=void 0!==this.options.title?this.options.title:this.options.noneSelectedText),this.$button.attr("title",a.trim(a("<div/>").html(e).text()).replace(/\s\s+/g," ")),this.$newElement.find(".filter-option").html(e)},setStyle:function(a,b){this.$element.attr("class")&&this.$newElement.addClass(this.$element.attr("class").replace(/selectpicker|mobile-device|validate\[.*\]/gi,""));var c=a?a:this.options.style;"add"==b?this.$button.addClass(c):"remove"==b?this.$button.removeClass(c):(this.$button.removeClass(this.options.style),this.$button.addClass(c))},liHeight:function(){if(this.options.size!==!1){var a=this.$menu.parent().clone().find("> .dropdown-toggle").prop("autofocus",!1).end().appendTo("body"),b=a.addClass("open").find("> .dropdown-menu"),c=b.find("li > a").outerHeight(),d=this.options.header?b.find(".popover-title").outerHeight():0,e=this.options.liveSearch?b.find(".bootstrap-select-searchbox").outerHeight():0,f=this.options.actionsBox?b.find(".bs-actionsbox").outerHeight():0;a.remove(),this.$newElement.data("liHeight",c).data("headerHeight",d).data("searchHeight",e).data("actionsHeight",f)}},setSize:function(){var b,c,d,e=this,f=this.$menu,g=f.find(".inner"),h=this.$newElement.outerHeight(),i=this.$newElement.data("liHeight"),j=this.$newElement.data("headerHeight"),k=this.$newElement.data("searchHeight"),l=this.$newElement.data("actionsHeight"),m=f.find("li .divider").outerHeight(!0),n=parseInt(f.css("padding-top"))+parseInt(f.css("padding-bottom"))+parseInt(f.css("border-top-width"))+parseInt(f.css("border-bottom-width")),o=this.options.hideDisabled?":not(.disabled)":"",p=a(window),q=n+parseInt(f.css("margin-top"))+parseInt(f.css("margin-bottom"))+2,r=function(){c=e.$newElement.offset().top-p.scrollTop(),d=p.height()-c-h};if(r(),this.options.header&&f.css("padding-top",0),"auto"==this.options.size){var s=function(){var a,h=e.$lis.not(".hide");r(),b=d-q,e.options.dropupAuto&&e.$newElement.toggleClass("dropup",c>d&&b-q<f.height()),e.$newElement.hasClass("dropup")&&(b=c-q),a=h.length+h.find("dt").length>3?3*i+q-2:0,f.css({"max-height":b+"px",overflow:"hidden","min-height":a+j+k+l+"px"}),g.css({"max-height":b-j-k-l-n+"px","overflow-y":"auto","min-height":Math.max(a-n,0)+"px"})};s(),this.$searchbox.off("input.getSize propertychange.getSize").on("input.getSize propertychange.getSize",s),a(window).off("resize.getSize").on("resize.getSize",s),a(window).off("scroll.getSize").on("scroll.getSize",s)}else if(this.options.size&&"auto"!=this.options.size&&f.find("li"+o).length>this.options.size){var t=f.find("li"+o+" > *").not(".div-contain").slice(0,this.options.size).last().parent().index(),u=f.find("li").slice(0,t+1).find(".div-contain").length;b=i*this.options.size+u*m+n,e.options.dropupAuto&&this.$newElement.toggleClass("dropup",c>d&&b<f.height()),f.css({"max-height":b+j+k+l+"px",overflow:"hidden"}),g.css({"max-height":b-n+"px","overflow-y":"auto"})}},setWidth:function(){if("auto"==this.options.width){this.$menu.css("min-width","0");var a=this.$newElement.clone().appendTo("body"),b=a.find("> .dropdown-menu").css("width"),c=a.css("width","auto").find("> button").css("width");a.remove(),this.$newElement.css("width",Math.max(parseInt(b),parseInt(c))+"px")}else"fit"==this.options.width?(this.$menu.css("min-width",""),this.$newElement.css("width","").addClass("fit-width")):this.options.width?(this.$menu.css("min-width",""),this.$newElement.css("width",this.options.width)):(this.$menu.css("min-width",""),this.$newElement.css("width",""));this.$newElement.hasClass("fit-width")&&"fit"!==this.options.width&&this.$newElement.removeClass("fit-width")},selectPosition:function(){var b,c,d=this,e="<div />",f=a(e),g=function(a){f.addClass(a.attr("class").replace(/form-control/gi,"")).toggleClass("dropup",a.hasClass("dropup")),b=a.offset(),c=a.hasClass("dropup")?0:a[0].offsetHeight,f.css({top:b.top+c,left:b.left,width:a[0].offsetWidth,position:"absolute"})};this.$newElement.on("click",function(){d.isDisabled()||(g(a(this)),f.appendTo(d.options.container),f.toggleClass("open",!a(this).hasClass("open")),f.append(d.$menu))}),a(window).resize(function(){g(d.$newElement)}),a(window).on("scroll",function(){g(d.$newElement)}),a("html").on("click",function(b){a(b.target).closest(d.$newElement).length<1&&f.removeClass("open")})},mobile:function(){this.$element.addClass("mobile-device").appendTo(this.$newElement),this.options.container&&this.$menu.hide()},refresh:function(){this.$lis=null,this.reloadLi(),this.render(),this.setWidth(),this.setStyle(),this.checkDisabled(),this.liHeight()},update:function(){this.reloadLi(),this.setWidth(),this.setStyle(),this.checkDisabled(),this.liHeight()},setSelected:function(b,c){null==this.$lis&&(this.$lis=this.$menu.find("li")),a(this.$lis[b]).toggleClass("selected",c)},setDisabled:function(b,c){null==this.$lis&&(this.$lis=this.$menu.find("li")),c?a(this.$lis[b]).addClass("disabled").find("a").attr("href","#").attr("tabindex",-1):a(this.$lis[b]).removeClass("disabled").find("a").removeAttr("href").attr("tabindex",0)},isDisabled:function(){return this.$element.is(":disabled")},checkDisabled:function(){var a=this;this.isDisabled()?this.$button.addClass("disabled").attr("tabindex",-1):(this.$button.hasClass("disabled")&&this.$button.removeClass("disabled"),-1==this.$button.attr("tabindex")&&(this.$element.data("tabindex")||this.$button.removeAttr("tabindex"))),this.$button.click(function(){return!a.isDisabled()})},tabIndex:function(){this.$element.is("[tabindex]")&&(this.$element.data("tabindex",this.$element.attr("tabindex")),this.$button.attr("tabindex",this.$element.data("tabindex")))},clickListener:function(){var b=this;this.$newElement.on("touchstart.dropdown",".dropdown-menu",function(a){a.stopPropagation()}),this.$newElement.on("click",function(){b.setSize(),b.options.liveSearch||b.multiple||setTimeout(function(){b.$menu.find(".selected a").focus()},10)}),this.$menu.on("click","li a",function(c){var d=a(this).parent().index(),e=b.$element.val(),f=b.$element.prop("selectedIndex");if(b.multiple&&c.stopPropagation(),c.preventDefault(),!b.isDisabled()&&!a(this).parent().hasClass("disabled")){var g=b.$element.find("option"),h=g.eq(d),i=h.prop("selected"),j=h.parent("optgroup"),k=b.options.maxOptions,l=j.data("maxOptions")||!1;if(b.multiple){if(h.prop("selected",!i),b.setSelected(d,!i),a(this).blur(),k!==!1||l!==!1){var m=k<g.filter(":selected").length,n=l<j.find("option:selected").length,o=b.options.maxOptionsText,p=o[0].replace("{n}",k),q=o[1].replace("{n}",l),r=a('<div class="notify"></div>');if(k&&m||l&&n)if(k&&1==k)g.prop("selected",!1),h.prop("selected",!0),b.$menu.find(".selected").removeClass("selected"),b.setSelected(d,!0);else if(l&&1==l){j.find("option:selected").prop("selected",!1),h.prop("selected",!0);var s=a(this).data("optgroup");b.$menu.find(".selected").has('a[data-optgroup="'+s+'"]').removeClass("selected"),b.setSelected(d,!0)}else o[2]&&(p=p.replace("{var}",o[2][k>1?0:1]),q=q.replace("{var}",o[2][l>1?0:1])),h.prop("selected",!1),b.$menu.append(r),k&&m&&(r.append(a("<div>"+p+"</div>")),b.$element.trigger("maxReached.bs.select")),l&&n&&(r.append(a("<div>"+q+"</div>")),b.$element.trigger("maxReachedGrp.bs.select")),setTimeout(function(){b.setSelected(d,!1)},10),r.delay(750).fadeOut(300,function(){a(this).remove()})}}else g.prop("selected",!1),h.prop("selected",!0),b.$menu.find(".selected").removeClass("selected"),b.setSelected(d,!0);b.multiple?b.options.liveSearch&&b.$searchbox.focus():b.$button.focus(),(e!=b.$element.val()&&b.multiple||f!=b.$element.prop("selectedIndex")&&!b.multiple)&&b.$element.change()}}),this.$menu.on("click","li.disabled a, li dt, li .div-contain, .popover-title, .popover-title :not(.close)",function(a){a.target==this&&(a.preventDefault(),a.stopPropagation(),b.options.liveSearch?b.$searchbox.focus():b.$button.focus())}),this.$menu.on("click",".popover-title .close",function(){b.$button.focus()}),this.$searchbox.on("click",function(a){a.stopPropagation()}),this.$menu.on("click",".actions-btn",function(c){b.options.liveSearch?b.$searchbox.focus():b.$button.focus(),c.preventDefault(),c.stopPropagation(),a(this).is(".bs-select-all")?b.selectAll():b.deselectAll(),b.$element.change()}),this.$element.change(function(){b.render(!1)})},liveSearchListener:function(){var b=this,c=a('<li class="no-results"></li>');this.$newElement.on("click.dropdown.data-api",function(){b.$menu.find(".active").removeClass("active"),b.$searchbox.val()&&(b.$searchbox.val(""),b.$lis.not(".is-hidden").removeClass("hide"),c.parent().length&&c.remove()),b.multiple||b.$menu.find(".selected").addClass("active"),setTimeout(function(){b.$searchbox.focus()},10)}),this.$searchbox.on("input propertychange",function(){b.$searchbox.val()?(b.$lis.not(".is-hidden").removeClass("hide").find("a").not(":icontains("+b.$searchbox.val()+")").parent().addClass("hide"),b.$menu.find("li").filter(":visible:not(.no-results)").length?c.parent().length&&c.remove():(c.parent().length&&c.remove(),c.html(b.options.noneResultsText+' "'+b.$searchbox.val()+'"').show(),b.$menu.find("li").last().after(c))):(b.$lis.not(".is-hidden").removeClass("hide"),c.parent().length&&c.remove()),b.$menu.find("li.active").removeClass("active"),b.$menu.find("li").filter(":visible:not(.divider)").eq(0).addClass("active").find("a").focus(),a(this).focus()}),this.$menu.on("mouseenter","a",function(c){b.$menu.find(".active").removeClass("active"),a(c.currentTarget).parent().not(".disabled").addClass("active")}),this.$menu.on("mouseleave","a",function(){b.$menu.find(".active").removeClass("active")})},val:function(a){return void 0!==a?(this.$element.val(a),this.$element.change(),this.render(),this.$element):this.$element.val()},selectAll:function(){null==this.$lis&&(this.$lis=this.$menu.find("li")),this.$element.find("option:enabled").prop("selected",!0),a(this.$lis).not(".disabled").addClass("selected"),this.render(!1)},deselectAll:function(){null==this.$lis&&(this.$lis=this.$menu.find("li")),this.$element.find("option:enabled").prop("selected",!1),a(this.$lis).not(".disabled").removeClass("selected"),this.render(!1)},keydown:function(b){var c,d,e,f,g,h,i,j,k,l,m,n,o={32:" ",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",59:";",65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9"};if(c=a(this),e=c.parent(),c.is("input")&&(e=c.parent().parent()),l=e.data("this"),l.options.liveSearch&&(e=c.parent().parent()),l.options.container&&(e=l.$menu),d=a("[role=menu] li:not(.divider) a",e),n=l.$menu.parent().hasClass("open"),!n&&/([0-9]|[A-z])/.test(String.fromCharCode(b.keyCode))&&(l.options.container?l.$newElement.trigger("click"):(l.setSize(),l.$menu.parent().addClass("open"),n=!0),l.$searchbox.focus()),l.options.liveSearch&&(/(^9$|27)/.test(b.keyCode.toString(10))&&n&&0===l.$menu.find(".active").length&&(b.preventDefault(),l.$menu.parent().removeClass("open"),l.$button.focus()),d=a("[role=menu] li:not(.divider):visible",e),c.val()||/(38|40)/.test(b.keyCode.toString(10))||0===d.filter(".active").length&&(d=l.$newElement.find("li").filter(":icontains("+o[b.keyCode]+")"))),d.length){if(/(38|40)/.test(b.keyCode.toString(10)))f=d.index(d.filter(":focus")),h=d.parent(":not(.disabled):visible").first().index(),i=d.parent(":not(.disabled):visible").last().index(),g=d.eq(f).parent().nextAll(":not(.disabled):visible").eq(0).index(),j=d.eq(f).parent().prevAll(":not(.disabled):visible").eq(0).index(),k=d.eq(g).parent().prevAll(":not(.disabled):visible").eq(0).index(),l.options.liveSearch&&(d.each(function(b){a(this).is(":not(.disabled)")&&a(this).data("index",b)}),f=d.index(d.filter(".active")),h=d.filter(":not(.disabled):visible").first().data("index"),i=d.filter(":not(.disabled):visible").last().data("index"),g=d.eq(f).nextAll(":not(.disabled):visible").eq(0).data("index"),j=d.eq(f).prevAll(":not(.disabled):visible").eq(0).data("index"),k=d.eq(g).prevAll(":not(.disabled):visible").eq(0).data("index")),m=c.data("prevIndex"),38==b.keyCode&&(l.options.liveSearch&&(f-=1),f!=k&&f>j&&(f=j),h>f&&(f=h),f==m&&(f=i)),40==b.keyCode&&(l.options.liveSearch&&(f+=1),-1==f&&(f=0),f!=k&&g>f&&(f=g),f>i&&(f=i),f==m&&(f=h)),c.data("prevIndex",f),l.options.liveSearch?(b.preventDefault(),c.is(".dropdown-toggle")||(d.removeClass("active"),d.eq(f).addClass("active").find("a").focus(),c.focus())):d.eq(f).focus();else if(!c.is("input")){var p,q,r=[];d.each(function(){a(this).parent().is(":not(.disabled)")&&a.trim(a(this).text().toLowerCase()).substring(0,1)==o[b.keyCode]&&r.push(a(this).parent().index())}),p=a(document).data("keycount"),p++,a(document).data("keycount",p),q=a.trim(a(":focus").text().toLowerCase()).substring(0,1),q!=o[b.keyCode]?(p=1,a(document).data("keycount",p)):p>=r.length&&(a(document).data("keycount",0),p>r.length&&(p=1)),d.eq(r[p-1]).focus()}/(13|32)/.test(b.keyCode.toString(10))&&n&&(/(32)/.test(b.keyCode.toString(10))||b.preventDefault(),l.options.liveSearch?/(32)/.test(b.keyCode.toString(10))||(l.$menu.find(".active a").click(),c.focus()):a(":focus").click(),a(document).data("keycount",0)),(/(^9$|27)/.test(b.keyCode.toString(10))&&n&&(l.multiple||l.options.liveSearch)||/(27)/.test(b.keyCode.toString(10))&&!n)&&(l.$menu.parent().removeClass("open"),l.$button.focus())}},hide:function(){this.$newElement.hide()},show:function(){this.$newElement.show()},destroy:function(){this.$newElement.remove(),this.$element.remove()}},a.fn.selectpicker=function(c,d){var e,f=arguments,g=this.each(function(){if(a(this).is("select")){var g=a(this),h=g.data("selectpicker"),i="object"==typeof c&&c;if(h){if(i)for(var j in i)i.hasOwnProperty(j)&&(h.options[j]=i[j])}else g.data("selectpicker",h=new b(this,a.extend({},b.DEFAULTS,a.fn.selectpicker.defaults||{},g.data(),i),d));if("string"==typeof c){var k=c;h[k]instanceof Function?([].shift.apply(f),e=h[k].apply(h,f)):e=h.options[k]}}});return"undefined"!=typeof e?e:g},a.fn.selectpicker.Constructor=b,a(document).data("keycount",0).on("keydown",".bootstrap-select [data-toggle=dropdown], .bootstrap-select [role=menu], .bootstrap-select-searchbox input",b.prototype.keydown).on("focusin.modal",".bootstrap-select [data-toggle=dropdown], .bootstrap-select [role=menu], .bootstrap-select-searchbox input",function(a){a.stopPropagation()})}(jQuery);


// Bootstrap DatePicker
!function($){function UTCDate(){return new Date(Date.UTC.apply(Date,arguments))}function UTCToday(){var today=new Date();return UTCDate(today.getUTCFullYear(),today.getUTCMonth(),today.getUTCDate())}var Datepicker=function(element,options){var that=this;this.element=$(element);this.language=options.language||this.element.data('date-language')||"en";this.language=this.language in dates?this.language:"en";this.isRTL=dates[this.language].rtl||false;this.format=DPGlobal.parseFormat(options.format||this.element.data('date-format')||'mm/dd/yyyy');this.isInline=false;this.isInput=this.element.is('input');this.component=this.element.is('.date')?this.element.find('.add-on'):false;this.hasInput=this.component&&this.element.find('input').length;if(this.component&&this.component.length===0)this.component=false;this._attachEvents();this.forceParse=true;if('forceParse'in options){this.forceParse=options.forceParse}else if('dateForceParse'in this.element.data()){this.forceParse=this.element.data('date-force-parse')}this.picker=$(DPGlobal.template).appendTo(this.isInline?this.element:'body').on({click:$.proxy(this.click,this),mousedown:$.proxy(this.mousedown,this)});if(this.isInline){this.picker.addClass('datepicker-inline')}else{this.picker.addClass('datepicker-dropdown dropdown-menu')}if(this.isRTL){this.picker.addClass('datepicker-rtl');this.picker.find('.prev i, .next i').toggleClass('icon-arrow-left icon-arrow-right')}$(document).on('mousedown',function(e){if($(e.target).closest('.datepicker').length===0){that.hide()}});this.autoclose=false;if('autoclose'in options){this.autoclose=options.autoclose}else if('dateAutoclose'in this.element.data()){this.autoclose=this.element.data('date-autoclose')}this.keyboardNavigation=true;if('keyboardNavigation'in options){this.keyboardNavigation=options.keyboardNavigation}else if('dateKeyboardNavigation'in this.element.data()){this.keyboardNavigation=this.element.data('date-keyboard-navigation')}this.viewMode=this.startViewMode=0;switch(options.startView||this.element.data('date-start-view')){case 2:case'decade':this.viewMode=this.startViewMode=2;break;case 1:case'year':this.viewMode=this.startViewMode=1;break}this.todayBtn=(options.todayBtn||this.element.data('date-today-btn')||false);this.todayHighlight=(options.todayHighlight||this.element.data('date-today-highlight')||false);this.weekStart=((options.weekStart||this.element.data('date-weekstart')||dates[this.language].weekStart||0)%7);this.weekEnd=((this.weekStart+6)%7);this.startDate=-Infinity;this.endDate=Infinity;this.daysOfWeekDisabled=[];this.setStartDate(options.startDate||this.element.data('date-startdate'));this.setEndDate(options.endDate||this.element.data('date-enddate'));this.setDaysOfWeekDisabled(options.daysOfWeekDisabled||this.element.data('date-days-of-week-disabled'));this.fillDow();this.fillMonths();this.update();this.showMode();if(this.isInline){this.show()}};Datepicker.prototype={constructor:Datepicker,_events:[],_attachEvents:function(){this._detachEvents();if(this.isInput){this._events=[[this.element,{focus:$.proxy(this.show,this),keyup:$.proxy(this.update,this),keydown:$.proxy(this.keydown,this)}]]}else if(this.component&&this.hasInput){this._events=[[this.element.find('input'),{focus:$.proxy(this.show,this),keyup:$.proxy(this.update,this),keydown:$.proxy(this.keydown,this)}],[this.component,{click:$.proxy(this.show,this)}]]}else if(this.element.is('div')){this.isInline=true}else{this._events=[[this.element,{click:$.proxy(this.show,this)}]]}for(var i=0,el,ev;i<this._events.length;i++){el=this._events[i][0];ev=this._events[i][1];el.on(ev)}},_detachEvents:function(){for(var i=0,el,ev;i<this._events.length;i++){el=this._events[i][0];ev=this._events[i][1];el.off(ev)}this._events=[]},show:function(e){this.picker.show();this.height=this.component?this.component.outerHeight():this.element.outerHeight();this.update();this.place();$(window).on('resize',$.proxy(this.place,this));if(e){e.stopPropagation();e.preventDefault()}this.element.trigger({type:'show',date:this.date})},hide:function(e){if(this.isInline)return;this.picker.hide();$(window).off('resize',this.place);this.viewMode=this.startViewMode;this.showMode();if(!this.isInput){$(document).off('mousedown',this.hide)}if(this.forceParse&&(this.isInput&&this.element.val()||this.hasInput&&this.element.find('input').val()))this.setValue();this.element.trigger({type:'hide',date:this.date})},remove:function(){this._detachEvents();this.picker.remove();delete this.element.data().datepicker},getDate:function(){var d=this.getUTCDate();return new Date(d.getTime()+(d.getTimezoneOffset()*60000))},getUTCDate:function(){return this.date},setDate:function(d){this.setUTCDate(new Date(d.getTime()-(d.getTimezoneOffset()*60000)))},setUTCDate:function(d){this.date=d;this.setValue()},setValue:function(){var formatted=this.getFormattedDate();if(!this.isInput){if(this.component){this.element.find('input').val(formatted)}this.element.data('date',formatted)}else{this.element.val(formatted)}},getFormattedDate:function(format){if(format===undefined)format=this.format;return DPGlobal.formatDate(this.date,format,this.language)},setStartDate:function(startDate){this.startDate=startDate||-Infinity;if(this.startDate!==-Infinity){this.startDate=DPGlobal.parseDate(this.startDate,this.format,this.language)}this.update();this.updateNavArrows()},setEndDate:function(endDate){this.endDate=endDate||Infinity;if(this.endDate!==Infinity){this.endDate=DPGlobal.parseDate(this.endDate,this.format,this.language)}this.update();this.updateNavArrows()},setDaysOfWeekDisabled:function(daysOfWeekDisabled){this.daysOfWeekDisabled=daysOfWeekDisabled||[];if(!$.isArray(this.daysOfWeekDisabled)){this.daysOfWeekDisabled=this.daysOfWeekDisabled.split(/,\s*/)}this.daysOfWeekDisabled=$.map(this.daysOfWeekDisabled,function(d){return parseInt(d,10)});this.update();this.updateNavArrows()},place:function(){if(this.isInline)return;var zIndex=parseInt(this.element.parents().filter(function(){return $(this).css('z-index')!='auto'}).first().css('z-index'))+10;var offset=this.component?this.component.offset():this.element.offset();var height=this.component?this.component.outerHeight(true):this.element.outerHeight(true);this.picker.css({top:offset.top+height,left:offset.left,zIndex:zIndex})},update:function(){var date,fromArgs=false;if(arguments&&arguments.length&&(typeof arguments[0]==='string'||arguments[0]instanceof Date)){date=arguments[0];fromArgs=true}else{date=this.isInput?this.element.val():this.element.data('date')||this.element.find('input').val()}this.date=DPGlobal.parseDate(date,this.format,this.language);if(fromArgs)this.setValue();var oldViewDate=this.viewDate;if(this.date<this.startDate){this.viewDate=new Date(this.startDate)}else if(this.date>this.endDate){this.viewDate=new Date(this.endDate)}else{this.viewDate=new Date(this.date)}if(oldViewDate&&oldViewDate.getTime()!=this.viewDate.getTime()){this.element.trigger({type:'changeDate',date:this.viewDate})}this.fill()},fillDow:function(){var dowCnt=this.weekStart,html='<tr>';while(dowCnt<this.weekStart+7){html+='<th class="dow">'+dates[this.language].daysMin[(dowCnt++)%7]+'</th>'}html+='</tr>';this.picker.find('.datepicker-days thead').append(html)},fillMonths:function(){var html='',i=0;while(i<12){html+='<span class="month">'+dates[this.language].monthsShort[i++]+'</span>'}this.picker.find('.datepicker-months td').html(html)},fill:function(){var d=new Date(this.viewDate),year=d.getUTCFullYear(),month=d.getUTCMonth(),startYear=this.startDate!==-Infinity?this.startDate.getUTCFullYear():-Infinity,startMonth=this.startDate!==-Infinity?this.startDate.getUTCMonth():-Infinity,endYear=this.endDate!==Infinity?this.endDate.getUTCFullYear():Infinity,endMonth=this.endDate!==Infinity?this.endDate.getUTCMonth():Infinity,currentDate=this.date&&this.date.valueOf(),today=new Date();this.picker.find('.datepicker-days thead th:eq(1)').text(dates[this.language].months[month]+' '+year);this.picker.find('tfoot th.today').text(dates[this.language].today).toggle(this.todayBtn!==false);this.updateNavArrows();this.fillMonths();var prevMonth=UTCDate(year,month-1,28,0,0,0,0),day=DPGlobal.getDaysInMonth(prevMonth.getUTCFullYear(),prevMonth.getUTCMonth());prevMonth.setUTCDate(day);prevMonth.setUTCDate(day-(prevMonth.getUTCDay()-this.weekStart+7)%7);var nextMonth=new Date(prevMonth);nextMonth.setUTCDate(nextMonth.getUTCDate()+42);nextMonth=nextMonth.valueOf();var html=[];var clsName;while(prevMonth.valueOf()<nextMonth){if(prevMonth.getUTCDay()==this.weekStart){html.push('<tr>')}clsName='';if(prevMonth.getUTCFullYear()<year||(prevMonth.getUTCFullYear()==year&&prevMonth.getUTCMonth()<month)){clsName+=' old'}else if(prevMonth.getUTCFullYear()>year||(prevMonth.getUTCFullYear()==year&&prevMonth.getUTCMonth()>month)){clsName+=' new'}if(this.todayHighlight&&prevMonth.getUTCFullYear()==today.getFullYear()&&prevMonth.getUTCMonth()==today.getMonth()&&prevMonth.getUTCDate()==today.getDate()){clsName+=' today'}if(currentDate&&prevMonth.valueOf()==currentDate){clsName+=' active'}if(prevMonth.valueOf()<this.startDate||prevMonth.valueOf()>this.endDate||$.inArray(prevMonth.getUTCDay(),this.daysOfWeekDisabled)!==-1){clsName+=' disabled'}html.push('<td class="day'+clsName+'">'+prevMonth.getUTCDate()+'</td>');if(prevMonth.getUTCDay()==this.weekEnd){html.push('</tr>')}prevMonth.setUTCDate(prevMonth.getUTCDate()+1)}this.picker.find('.datepicker-days tbody').empty().append(html.join(''));var currentYear=this.date&&this.date.getUTCFullYear();var months=this.picker.find('.datepicker-months').find('th:eq(1)').text(year).end().find('span').removeClass('active');if(currentYear&&currentYear==year){months.eq(this.date.getUTCMonth()).addClass('active')}if(year<startYear||year>endYear){months.addClass('disabled')}if(year==startYear){months.slice(0,startMonth).addClass('disabled')}if(year==endYear){months.slice(endMonth+1).addClass('disabled')}html='';year=parseInt(year/10,10)*10;var yearCont=this.picker.find('.datepicker-years').find('th:eq(1)').text(year+'-'+(year+9)).end().find('td');year-=1;for(var i=-1;i<11;i++){html+='<span class="year'+(i==-1||i==10?' old':'')+(currentYear==year?' active':'')+(year<startYear||year>endYear?' disabled':'')+'">'+year+'</span>';year+=1}yearCont.html(html)},updateNavArrows:function(){var d=new Date(this.viewDate),year=d.getUTCFullYear(),month=d.getUTCMonth();switch(this.viewMode){case 0:if(this.startDate!==-Infinity&&year<=this.startDate.getUTCFullYear()&&month<=this.startDate.getUTCMonth()){this.picker.find('.prev').css({visibility:'hidden'})}else{this.picker.find('.prev').css({visibility:'visible'})}if(this.endDate!==Infinity&&year>=this.endDate.getUTCFullYear()&&month>=this.endDate.getUTCMonth()){this.picker.find('.next').css({visibility:'hidden'})}else{this.picker.find('.next').css({visibility:'visible'})}break;case 1:case 2:if(this.startDate!==-Infinity&&year<=this.startDate.getUTCFullYear()){this.picker.find('.prev').css({visibility:'hidden'})}else{this.picker.find('.prev').css({visibility:'visible'})}if(this.endDate!==Infinity&&year>=this.endDate.getUTCFullYear()){this.picker.find('.next').css({visibility:'hidden'})}else{this.picker.find('.next').css({visibility:'visible'})}break}},click:function(e){e.stopPropagation();e.preventDefault();var target=$(e.target).closest('span, td, th');if(target.length==1){switch(target[0].nodeName.toLowerCase()){case'th':switch(target[0].className){case'switch':this.showMode(1);break;case'prev':case'next':var dir=DPGlobal.modes[this.viewMode].navStep*(target[0].className=='prev'?-1:1);switch(this.viewMode){case 0:this.viewDate=this.moveMonth(this.viewDate,dir);break;case 1:case 2:this.viewDate=this.moveYear(this.viewDate,dir);break}this.fill();break;case'today':var date=new Date();date=UTCDate(date.getFullYear(),date.getMonth(),date.getDate(),0,0,0);this.showMode(-2);var which=this.todayBtn=='linked'?null:'view';this._setDate(date,which);break}break;case'span':if(!target.is('.disabled')){this.viewDate.setUTCDate(1);if(target.is('.month')){var month=target.parent().find('span').index(target);this.viewDate.setUTCMonth(month);this.element.trigger({type:'changeMonth',date:this.viewDate})}else{var year=parseInt(target.text(),10)||0;this.viewDate.setUTCFullYear(year);this.element.trigger({type:'changeYear',date:this.viewDate})}this.showMode(-1);this.fill()}break;case'td':if(target.is('.day')&&!target.is('.disabled')){var day=parseInt(target.text(),10)||1;var year=this.viewDate.getUTCFullYear(),month=this.viewDate.getUTCMonth();if(target.is('.old')){if(month===0){month=11;year-=1}else{month-=1}}else if(target.is('.new')){if(month==11){month=0;year+=1}else{month+=1}}this._setDate(UTCDate(year,month,day,0,0,0,0))}break}}},_setDate:function(date,which){if(!which||which=='date')this.date=date;if(!which||which=='view')this.viewDate=date;this.fill();this.setValue();this.element.trigger({type:'changeDate',date:this.date});var element;if(this.isInput){element=this.element}else if(this.component){element=this.element.find('input')}if(element){element.change();if(this.autoclose&&(!which||which=='date')){this.hide()}}},moveMonth:function(date,dir){if(!dir)return date;var new_date=new Date(date.valueOf()),day=new_date.getUTCDate(),month=new_date.getUTCMonth(),mag=Math.abs(dir),new_month,test;dir=dir>0?1:-1;if(mag==1){test=dir==-1?function(){return new_date.getUTCMonth()==month}:function(){return new_date.getUTCMonth()!=new_month};new_month=month+dir;new_date.setUTCMonth(new_month);if(new_month<0||new_month>11)new_month=(new_month+12)%12}else{for(var i=0;i<mag;i++)new_date=this.moveMonth(new_date,dir);new_month=new_date.getUTCMonth();new_date.setUTCDate(day);test=function(){return new_month!=new_date.getUTCMonth()}}while(test()){new_date.setUTCDate(--day);new_date.setUTCMonth(new_month)}return new_date},moveYear:function(date,dir){return this.moveMonth(date,dir*12)},dateWithinRange:function(date){return date>=this.startDate&&date<=this.endDate},keydown:function(e){if(this.picker.is(':not(:visible)')){if(e.keyCode==27)this.show();return}var dateChanged=false,dir,day,month,newDate,newViewDate;switch(e.keyCode){case 27:this.hide();e.preventDefault();break;case 37:case 39:if(!this.keyboardNavigation)break;dir=e.keyCode==37?-1:1;if(e.ctrlKey){newDate=this.moveYear(this.date,dir);newViewDate=this.moveYear(this.viewDate,dir)}else if(e.shiftKey){newDate=this.moveMonth(this.date,dir);newViewDate=this.moveMonth(this.viewDate,dir)}else{newDate=new Date(this.date);newDate.setUTCDate(this.date.getUTCDate()+dir);newViewDate=new Date(this.viewDate);newViewDate.setUTCDate(this.viewDate.getUTCDate()+dir)}if(this.dateWithinRange(newDate)){this.date=newDate;this.viewDate=newViewDate;this.setValue();this.update();e.preventDefault();dateChanged=true}break;case 38:case 40:if(!this.keyboardNavigation)break;dir=e.keyCode==38?-1:1;if(e.ctrlKey){newDate=this.moveYear(this.date,dir);newViewDate=this.moveYear(this.viewDate,dir)}else if(e.shiftKey){newDate=this.moveMonth(this.date,dir);newViewDate=this.moveMonth(this.viewDate,dir)}else{newDate=new Date(this.date);newDate.setUTCDate(this.date.getUTCDate()+dir*7);newViewDate=new Date(this.viewDate);newViewDate.setUTCDate(this.viewDate.getUTCDate()+dir*7)}if(this.dateWithinRange(newDate)){this.date=newDate;this.viewDate=newViewDate;this.setValue();this.update();e.preventDefault();dateChanged=true}break;case 13:this.hide();e.preventDefault();break;case 9:this.hide();break}if(dateChanged){this.element.trigger({type:'changeDate',date:this.date});var element;if(this.isInput){element=this.element}else if(this.component){element=this.element.find('input')}if(element){element.change()}}},showMode:function(dir){if(dir){this.viewMode=Math.max(0,Math.min(2,this.viewMode+dir))}this.picker.find('>div').hide().filter('.datepicker-'+DPGlobal.modes[this.viewMode].clsName).css('display','block');this.updateNavArrows()}};$.fn.datepicker=function(option){var args=Array.apply(null,arguments);args.shift();return this.each(function(){var $this=$(this),data=$this.data('datepicker'),options=typeof option=='object'&&option;if(!data){$this.data('datepicker',(data=new Datepicker(this,$.extend({},$.fn.datepicker.defaults,options))))}if(typeof option=='string'&&typeof data[option]=='function'){data[option].apply(data,args)}})};$.fn.datepicker.defaults={};$.fn.datepicker.Constructor=Datepicker;var dates=$.fn.datepicker.dates={en:{days:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],daysShort:["Sun","Mon","Tue","Wed","Thu","Fri","Sat","Sun"],daysMin:["Su","Mo","Tu","We","Th","Fr","Sa","Su"],months:["January","February","March","April","May","June","July","August","September","October","November","December"],monthsShort:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],today:"Today"}};var DPGlobal={modes:[{clsName:'days',navFnc:'Month',navStep:1},{clsName:'months',navFnc:'FullYear',navStep:1},{clsName:'years',navFnc:'FullYear',navStep:10}],isLeapYear:function(year){return(((year%4===0)&&(year%100!==0))||(year%400===0))},getDaysInMonth:function(year,month){return[31,(DPGlobal.isLeapYear(year)?29:28),31,30,31,30,31,31,30,31,30,31][month]},validParts:/dd?|DD?|mm?|MM?|yy(?:yy)?/g,nonpunctuation:/[^ -\/:-@\[\u3400-\u9fff-`{-~\t\n\r]+/g,parseFormat:function(format){var separators=format.replace(this.validParts,'\0').split('\0'),parts=format.match(this.validParts);if(!separators||!separators.length||!parts||parts.length===0){throw new Error("Invalid date format.");}return{separators:separators,parts:parts}},parseDate:function(date,format,language){if(date instanceof Date)return date;if(/^[\-+]\d+[dmwy]([\s,]+[\-+]\d+[dmwy])*$/.test(date)){var part_re=/([\-+]\d+)([dmwy])/,parts=date.match(/([\-+]\d+)([dmwy])/g),part,dir;date=new Date();for(var i=0;i<parts.length;i++){part=part_re.exec(parts[i]);dir=parseInt(part[1]);switch(part[2]){case'd':date.setUTCDate(date.getUTCDate()+dir);break;case'm':date=Datepicker.prototype.moveMonth.call(Datepicker.prototype,date,dir);break;case'w':date.setUTCDate(date.getUTCDate()+dir*7);break;case'y':date=Datepicker.prototype.moveYear.call(Datepicker.prototype,date,dir);break}}return UTCDate(date.getUTCFullYear(),date.getUTCMonth(),date.getUTCDate(),0,0,0)}var parts=date&&date.match(this.nonpunctuation)||[],date=new Date(),parsed={},setters_order=['yyyy','yy','M','MM','m','mm','d','dd'],setters_map={yyyy:function(d,v){return d.setUTCFullYear(v)},yy:function(d,v){return d.setUTCFullYear(2000+v)},m:function(d,v){v-=1;while(v<0)v+=12;v%=12;d.setUTCMonth(v);while(d.getUTCMonth()!=v)d.setUTCDate(d.getUTCDate()-1);return d},d:function(d,v){return d.setUTCDate(v)}},val,filtered,part;setters_map['M']=setters_map['MM']=setters_map['mm']=setters_map['m'];setters_map['dd']=setters_map['d'];date=UTCDate(date.getFullYear(),date.getMonth(),date.getDate(),0,0,0);var fparts=format.parts.slice();if(parts.length!=fparts.length){fparts=$(fparts).filter(function(i,p){return $.inArray(p,setters_order)!==-1}).toArray()}if(parts.length==fparts.length){for(var i=0,cnt=fparts.length;i<cnt;i++){val=parseInt(parts[i],10);part=fparts[i];if(isNaN(val)){switch(part){case'MM':filtered=$(dates[language].months).filter(function(){var m=this.slice(0,parts[i].length),p=parts[i].slice(0,m.length);return m==p});val=$.inArray(filtered[0],dates[language].months)+1;break;case'M':filtered=$(dates[language].monthsShort).filter(function(){var m=this.slice(0,parts[i].length),p=parts[i].slice(0,m.length);return m==p});val=$.inArray(filtered[0],dates[language].monthsShort)+1;break}}parsed[part]=val}for(var i=0,s;i<setters_order.length;i++){s=setters_order[i];if(s in parsed&&!isNaN(parsed[s]))setters_map[s](date,parsed[s])}}return date},formatDate:function(date,format,language){var val={d:date.getUTCDate(),D:dates[language].daysShort[date.getUTCDay()],DD:dates[language].days[date.getUTCDay()],m:date.getUTCMonth()+1,M:dates[language].monthsShort[date.getUTCMonth()],MM:dates[language].months[date.getUTCMonth()],yy:date.getUTCFullYear().toString().substring(2),yyyy:date.getUTCFullYear()};val.dd=(val.d<10?'0':'')+val.d;val.mm=(val.m<10?'0':'')+val.m;var date=[],seps=$.extend([],format.separators);for(var i=0,cnt=format.parts.length;i<cnt;i++){if(seps.length)date.push(seps.shift());date.push(val[format.parts[i]])}return date.join('')},headTemplate:'<thead>'+'<tr>'+'<th class="prev"><i class="icon-arrow-left"/></th>'+'<th colspan="5" class="switch"></th>'+'<th class="next"><i class="icon-arrow-right"/></th>'+'</tr>'+'</thead>',contTemplate:'<tbody><tr><td colspan="7"></td></tr></tbody>',footTemplate:'<tfoot><tr><th colspan="7" class="today"></th></tr></tfoot>'};DPGlobal.template='<div class="datepicker">'+'<div class="datepicker-days">'+'<table class=" table-condensed">'+DPGlobal.headTemplate+'<tbody></tbody>'+DPGlobal.footTemplate+'</table>'+'</div>'+'<div class="datepicker-months">'+'<table class="table-condensed">'+DPGlobal.headTemplate+DPGlobal.contTemplate+DPGlobal.footTemplate+'</table>'+'</div>'+'<div class="datepicker-years">'+'<table class="table-condensed">'+DPGlobal.headTemplate+DPGlobal.contTemplate+DPGlobal.footTemplate+'</table>'+'</div>'+'</div>';$.fn.datepicker.DPGlobal=DPGlobal}(window.jQuery);



// Jquery Equal height (http://brm.io/jquery-match-height-demo/) 
(function(e){var t=-1,n=-1;var r=function(t){var n=1,r=e(t),s=null,o=[];r.each(function(){var t=e(this),r=t.offset().top-i(t.css("margin-top")),u=o.length>0?o[o.length-1]:null;if(u===null){o.push(t)}else{if(Math.floor(Math.abs(s-r))<=n){o[o.length-1]=u.add(t)}else{o.push(t)}}s=r});return o};var i=function(e){return parseFloat(e)||0};var s=function(t){var n={byRow:true,remove:false,property:"height"};if(typeof t==="object"){return e.extend(n,t)}if(typeof t==="boolean"){n.byRow=t}else if(t==="remove"){n.remove=true}return n};var o=e.fn.matchHeight=function(t){var n=s(t);if(n.remove){var r=this;this.css(n.property,"");e.each(o._groups,function(e,t){t.elements=t.elements.not(r)});return this}if(this.length<=1)return this;o._groups.push({elements:this,options:n});o._apply(this,n);return this};o._groups=[];o._throttle=80;o._maintainScroll=false;o._beforeUpdate=null;o._afterUpdate=null;o._apply=function(t,n){var u=s(n),a=e(t),f=[a];var l=e(window).scrollTop(),c=e("html").outerHeight(true);var h=a.parents().filter(":hidden");h.each(function(){var t=e(this);t.data("style-cache",t.attr("style"))});h.css("display","block");if(u.byRow){a.each(function(){var t=e(this),n=t.css("display")==="inline-block"?"inline-block":"block";t.data("style-cache",t.attr("style"));t.css({display:n,"padding-top":"0","padding-bottom":"0","margin-top":"0","margin-bottom":"0","border-top-width":"0","border-bottom-width":"0",height:"100px"})});f=r(a);a.each(function(){var t=e(this);t.attr("style",t.data("style-cache")||"")})}e.each(f,function(t,n){var r=e(n),s=0;if(u.byRow&&r.length<=1){r.css(u.property,"");return}r.each(function(){var t=e(this),n=t.css("display")==="inline-block"?"inline-block":"block";var r={display:n};r[u.property]="";t.css(r);if(t.outerHeight(false)>s)s=t.outerHeight(false);t.css("display","")});r.each(function(){var t=e(this),n=0;if(t.css("box-sizing")!=="border-box"){n+=i(t.css("border-top-width"))+i(t.css("border-bottom-width"));n+=i(t.css("padding-top"))+i(t.css("padding-bottom"))}t.css(u.property,s-n)})});h.each(function(){var t=e(this);t.attr("style",t.data("style-cache")||null)});if(o._maintainScroll)e(window).scrollTop(l/c*e("html").outerHeight(true));return this};o._applyDataApi=function(){var t={};e("[data-match-height], [data-mh]").each(function(){var n=e(this),r=n.attr("data-match-height")||n.attr("data-mh");if(r in t){t[r]=t[r].add(n)}else{t[r]=n}});e.each(t,function(){this.matchHeight(true)})};var u=function(t){if(o._beforeUpdate)o._beforeUpdate(t,o._groups);e.each(o._groups,function(){o._apply(this.elements,this.options)});if(o._afterUpdate)o._afterUpdate(t,o._groups)};o._update=function(r,i){if(i&&i.type==="resize"){var s=e(window).width();if(s===t)return;t=s}if(!r){u(i)}else if(n===-1){n=setTimeout(function(){u(i);n=-1},o._throttle)}};e(o._applyDataApi);e(window).bind("load",function(e){o._update(false,e)});e(window).bind("resize orientationchange",function(e){o._update(true,e)})})(jQuery);

// Generated by CoffeeScript 1.4.0
/*
jQuery Waypoints - v2.0.2
Copyright (c) 2011-2013 Caleb Troughton
Dual licensed under the MIT license and GPL license.
https://github.com/imakewebthings/jquery-waypoints/blob/master/licenses.txt
*/
(function(){var t=[].indexOf||function(t){for(var e=0,n=this.length;e<n;e++){if(e in this&&this[e]===t)return e}return-1},e=[].slice;(function(t,e){if(typeof define==="function"&&define.amd){return define("waypoints",["jquery"],function(n){return e(n,t)})}else{return e(t.jQuery,t)}})(this,function(n,r){var i,o,l,s,f,u,a,c,h,d,p,y,v,w,g,m;i=n(r);c=t.call(r,"ontouchstart")>=0;s={horizontal:{},vertical:{}};f=1;a={};u="waypoints-context-id";p="resize.waypoints";y="scroll.waypoints";v=1;w="waypoints-waypoint-ids";g="waypoint";m="waypoints";o=function(){function t(t){var e=this;this.$element=t;this.element=t[0];this.didResize=false;this.didScroll=false;this.id="context"+f++;this.oldScroll={x:t.scrollLeft(),y:t.scrollTop()};this.waypoints={horizontal:{},vertical:{}};t.data(u,this.id);a[this.id]=this;t.bind(y,function(){var t;if(!(e.didScroll||c)){e.didScroll=true;t=function(){e.doScroll();return e.didScroll=false};return r.setTimeout(t,n[m].settings.scrollThrottle)}});t.bind(p,function(){var t;if(!e.didResize){e.didResize=true;t=function(){n[m]("refresh");return e.didResize=false};return r.setTimeout(t,n[m].settings.resizeThrottle)}})}t.prototype.doScroll=function(){var t,e=this;t={horizontal:{newScroll:this.$element.scrollLeft(),oldScroll:this.oldScroll.x,forward:"right",backward:"left"},vertical:{newScroll:this.$element.scrollTop(),oldScroll:this.oldScroll.y,forward:"down",backward:"up"}};if(c&&(!t.vertical.oldScroll||!t.vertical.newScroll)){n[m]("refresh")}n.each(t,function(t,r){var i,o,l;l=[];o=r.newScroll>r.oldScroll;i=o?r.forward:r.backward;n.each(e.waypoints[t],function(t,e){var n,i;if(r.oldScroll<(n=e.offset)&&n<=r.newScroll){return l.push(e)}else if(r.newScroll<(i=e.offset)&&i<=r.oldScroll){return l.push(e)}});l.sort(function(t,e){return t.offset-e.offset});if(!o){l.reverse()}return n.each(l,function(t,e){if(e.options.continuous||t===l.length-1){return e.trigger([i])}})});return this.oldScroll={x:t.horizontal.newScroll,y:t.vertical.newScroll}};t.prototype.refresh=function(){var t,e,r,i=this;r=n.isWindow(this.element);e=this.$element.offset();this.doScroll();t={horizontal:{contextOffset:r?0:e.left,contextScroll:r?0:this.oldScroll.x,contextDimension:this.$element.width(),oldScroll:this.oldScroll.x,forward:"right",backward:"left",offsetProp:"left"},vertical:{contextOffset:r?0:e.top,contextScroll:r?0:this.oldScroll.y,contextDimension:r?n[m]("viewportHeight"):this.$element.height(),oldScroll:this.oldScroll.y,forward:"down",backward:"up",offsetProp:"top"}};return n.each(t,function(t,e){return n.each(i.waypoints[t],function(t,r){var i,o,l,s,f;i=r.options.offset;l=r.offset;o=n.isWindow(r.element)?0:r.$element.offset()[e.offsetProp];if(n.isFunction(i)){i=i.apply(r.element)}else if(typeof i==="string"){i=parseFloat(i);if(r.options.offset.indexOf("%")>-1){i=Math.ceil(e.contextDimension*i/100)}}r.offset=o-e.contextOffset+e.contextScroll-i;if(r.options.onlyOnScroll&&l!=null||!r.enabled){return}if(l!==null&&l<(s=e.oldScroll)&&s<=r.offset){return r.trigger([e.backward])}else if(l!==null&&l>(f=e.oldScroll)&&f>=r.offset){return r.trigger([e.forward])}else if(l===null&&e.oldScroll>=r.offset){return r.trigger([e.forward])}})})};t.prototype.checkEmpty=function(){if(n.isEmptyObject(this.waypoints.horizontal)&&n.isEmptyObject(this.waypoints.vertical)){this.$element.unbind([p,y].join(" "));return delete a[this.id]}};return t}();l=function(){function t(t,e,r){var i,o;r=n.extend({},n.fn[g].defaults,r);if(r.offset==="bottom-in-view"){r.offset=function(){var t;t=n[m]("viewportHeight");if(!n.isWindow(e.element)){t=e.$element.height()}return t-n(this).outerHeight()}}this.$element=t;this.element=t[0];this.axis=r.horizontal?"horizontal":"vertical";this.callback=r.handler;this.context=e;this.enabled=r.enabled;this.id="waypoints"+v++;this.offset=null;this.options=r;e.waypoints[this.axis][this.id]=this;s[this.axis][this.id]=this;i=(o=t.data(w))!=null?o:[];i.push(this.id);t.data(w,i)}t.prototype.trigger=function(t){if(!this.enabled){return}if(this.callback!=null){this.callback.apply(this.element,t)}if(this.options.triggerOnce){return this.destroy()}};t.prototype.disable=function(){return this.enabled=false};t.prototype.enable=function(){this.context.refresh();return this.enabled=true};t.prototype.destroy=function(){delete s[this.axis][this.id];delete this.context.waypoints[this.axis][this.id];return this.context.checkEmpty()};t.getWaypointsByElement=function(t){var e,r;r=n(t).data(w);if(!r){return[]}e=n.extend({},s.horizontal,s.vertical);return n.map(r,function(t){return e[t]})};return t}();d={init:function(t,e){var r;if(e==null){e={}}if((r=e.handler)==null){e.handler=t}this.each(function(){var t,r,i,s;t=n(this);i=(s=e.context)!=null?s:n.fn[g].defaults.context;if(!n.isWindow(i)){i=t.closest(i)}i=n(i);r=a[i.data(u)];if(!r){r=new o(i)}return new l(t,r,e)});n[m]("refresh");return this},disable:function(){return d._invoke(this,"disable")},enable:function(){return d._invoke(this,"enable")},destroy:function(){return d._invoke(this,"destroy")},prev:function(t,e){return d._traverse.call(this,t,e,function(t,e,n){if(e>0){return t.push(n[e-1])}})},next:function(t,e){return d._traverse.call(this,t,e,function(t,e,n){if(e<n.length-1){return t.push(n[e+1])}})},_traverse:function(t,e,i){var o,l;if(t==null){t="vertical"}if(e==null){e=r}l=h.aggregate(e);o=[];this.each(function(){var e;e=n.inArray(this,l[t]);return i(o,e,l[t])});return this.pushStack(o)},_invoke:function(t,e){t.each(function(){var t;t=l.getWaypointsByElement(this);return n.each(t,function(t,n){n[e]();return true})});return this}};n.fn[g]=function(){var t,r;r=arguments[0],t=2<=arguments.length?e.call(arguments,1):[];if(d[r]){return d[r].apply(this,t)}else if(n.isFunction(r)){return d.init.apply(this,arguments)}else if(n.isPlainObject(r)){return d.init.apply(this,[null,r])}else if(!r){return n.error("jQuery Waypoints needs a callback function or handler option.")}else{return n.error("The "+r+" method does not exist in jQuery Waypoints.")}};n.fn[g].defaults={context:r,continuous:true,enabled:true,horizontal:false,offset:0,triggerOnce:false};h={refresh:function(){return n.each(a,function(t,e){return e.refresh()})},viewportHeight:function(){var t;return(t=r.innerHeight)!=null?t:i.height()},aggregate:function(t){var e,r,i;e=s;if(t){e=(i=a[n(t).data(u)])!=null?i.waypoints:void 0}if(!e){return[]}r={horizontal:[],vertical:[]};n.each(r,function(t,i){n.each(e[t],function(t,e){return i.push(e)});i.sort(function(t,e){return t.offset-e.offset});r[t]=n.map(i,function(t){return t.element});return r[t]=n.unique(r[t])});return r},above:function(t){if(t==null){t=r}return h._filter(t,"vertical",function(t,e){return e.offset<=t.oldScroll.y})},below:function(t){if(t==null){t=r}return h._filter(t,"vertical",function(t,e){return e.offset>t.oldScroll.y})},left:function(t){if(t==null){t=r}return h._filter(t,"horizontal",function(t,e){return e.offset<=t.oldScroll.x})},right:function(t){if(t==null){t=r}return h._filter(t,"horizontal",function(t,e){return e.offset>t.oldScroll.x})},enable:function(){return h._invoke("enable")},disable:function(){return h._invoke("disable")},destroy:function(){return h._invoke("destroy")},extendFn:function(t,e){return d[t]=e},_invoke:function(t){var e;e=n.extend({},s.vertical,s.horizontal);return n.each(e,function(e,n){n[t]();return true})},_filter:function(t,e,r){var i,o;i=a[n(t).data(u)];if(!i){return[]}o=[];n.each(i.waypoints[e],function(t,e){if(r(i,e)){return o.push(e)}});o.sort(function(t,e){return t.offset-e.offset});return n.map(o,function(t){return t.element})}};n[m]=function(){var t,n;n=arguments[0],t=2<=arguments.length?e.call(arguments,1):[];if(h[n]){return h[n].apply(null,t)}else{return h.aggregate.call(null,n)}};n[m].settings={resizeThrottle:100,scrollThrottle:30};return i.load(function(){return n[m]("refresh")})})}).call(this);